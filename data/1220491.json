{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "nfroyd@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2015-11-02T05:50:31Z", "type_id": 4, "creation_date": "2015-11-01T22:37:11Z", "id": 1284122, "setter": "gsquelart@mozilla.com"}], "content_type": "text/plain", "id": 8681719}], "classification": "Components", "creator": "nfroyd@mozilla.com", "mentors_detail": [], "depends_on": [], "cf_has_str": "---", "cf_user_story": "", "cf_backlog": "---", "cf_tracking_firefox_relnote": "---", "platform": "All", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "clarify ownership relationships for creators of AudioData", "cf_last_resolved": "2015-11-03T11:20:26Z", "votes": 0, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_status_firefox45": "fixed", "cf_has_regression_range": "---", "comment_count": 9, "comments": [{"text": "The way we pass in AudioDataValue arrays into AudioData is non-uniform:\nsometimes we have nsAutoArrayPtrs, sometimes we don't, and it's not\nimmediately obvious from the function signature of the constructor that\nwe're actually taking ownership of this array.  Let's fix that by using\nUniquePtr<AudioDataValue[]> smart pointers to hold the data prior to\ncreating AudioData values, and for passing in to AudioData's\nconstructor.  Using standard-er C++ things instead of our homegrown ones\nis a good thing.", "author": "nfroyd@mozilla.com", "id": 10892457, "time": "2015-11-01T22:36:21Z"}, {"text": "Created attachment 8681719\nclarify ownership relationships for creators of AudioData\n\nNot exactly sure who should review this, so trusting that Gerald either has the\nauthority to review, or that he has the good cheer to pass it off on somebody\nwho does have the authority.", "author": "nfroyd@mozilla.com", "id": 10892458, "time": "2015-11-01T22:37:11Z"}, {"text": "Comment on attachment 8681719\nclarify ownership relationships for creators of AudioData\n\nReview of attachment 8681719:\n-----------------------------------------------------------------\n\nI've checked with cpearce (module owner). He's happy with the changes in principle, and for me to do the in-depth review.\n\nr+ with bikeshedding bait.\n\n::: dom/media/MediaData.h\n@@ +123,5 @@\n>    AudioData(int64_t aOffset,\n>              int64_t aTime,\n>              int64_t aDuration,\n>              uint32_t aFrames,\n> +            UniquePtr<AudioDataValue[]> aData,\n\nI initially wrote: \"You should accept aData as r-value reference, to avoid an unnecessary creation of a local UniquePtr.\"\n\nBut then I read UniquePtr's documentation (imagine that!), which advises: \"To unconditionally transfer ownership of a UniquePtr into a method, use a |UniquePtr| argument.  To conditionally transfer ownership of a resource into a method, should the method want it, use a |UniquePtr&&| argument.\"\nSo I guess I should defer to the docs; but has this been discussed already? (Since the stdlib prefers unique_ptr&& everywhere.)\n\nAlso it's probably an insignificant cost compared to the rest of the audio processing.\nSo I'll leave the final decision to you.", "author": "gsquelart@mozilla.com", "id": 10893208, "time": "2015-11-02T05:50:31Z"}, {"text": "(In reply to Gerald Squelart [:gerald] from comment #2)\n> ::: dom/media/MediaData.h\n> @@ +123,5 @@\n> >    AudioData(int64_t aOffset,\n> >              int64_t aTime,\n> >              int64_t aDuration,\n> >              uint32_t aFrames,\n> > +            UniquePtr<AudioDataValue[]> aData,\n> \n> I initially wrote: \"You should accept aData as r-value reference, to avoid\n> an unnecessary creation of a local UniquePtr.\"\n> \n> But then I read UniquePtr's documentation (imagine that!), which advises:\n> \"To unconditionally transfer ownership of a UniquePtr into a method, use a\n> |UniquePtr| argument.  To conditionally transfer ownership of a resource\n> into a method, should the method want it, use a |UniquePtr&&| argument.\"\n> So I guess I should defer to the docs; but has this been discussed already?\n> (Since the stdlib prefers unique_ptr&& everywhere.)\n\nI don't know that we've had a discussion about this.  A quick grep suggests that |UniquePtr| has a small mindshare lead over UniquePtr&&.  The recently released C++ Core Guidelines suggest passing arguments using values:\n\nhttps://github.com/isocpp/CppCoreGuidelines/blob/master/CppCoreGuidelines.md#Rr-uniqueptrparam\n\nIt doesn't really explain why this would be preferable to rvalue reference-passing.  I think value arguments are slightly faster (since the callee doesn't have to look through the reference?), while rvalue arguments are more economical with codesize (since you aren't required to destruct the temporary value?), but I'd have to whip up some examples to verify that.", "author": "nfroyd@mozilla.com", "id": 10894806, "time": "2015-11-02T16:54:45Z"}, {"text": "IMO clarity of transfer of ownership trumps trivial construction/destruction costs, which I suspect probably close to even out with dereferencing and caller destruction costs, after optimization.  i.e. I'd agree with the docs.\n\nhttps://groups.google.com/forum/#!msg/mozilla.dev.platform/Ji3T5kipJzA/4GIk9BEtjsoJ", "author": "karlt@mozbugz.karlt.net", "id": 10895163, "time": "2015-11-02T18:26:38Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/11dd4cfb6563", "author": "pulsebot@bots.tld", "id": 10896002, "time": "2015-11-02T21:57:17Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/11dd4cfb6563", "author": "cbook@mozilla.com", "id": 10897676, "time": "2015-11-03T11:20:26Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-b2g44_v2_5/rev/11dd4cfb6563", "author": "cbook@mozilla.com", "id": 10902593, "time": "2015-11-04T15:11:32Z"}, {"text": "removing the b2g 2.5 flag since this commit has been reverted due to an incorrect merge, sorry for the confusion", "author": "cbook@mozilla.com", "id": 10907073, "time": "2015-11-05T16:50:56Z"}], "id": 1220491, "priority": "--", "cc": ["gsquelart@mozilla.com", "karlt@mozbugz.karlt.net"], "cf_crash_signature": "", "version": "unspecified", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_firefox59": "---", "last_change_time": "2015-11-05T16:50:56Z", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [], "qa_contact": "", "creation_time": "2015-11-01T22:36:21Z", "cf_status_firefox_esr52": "---", "component": "Audio/Video", "assigned_to_detail": {"email": "nfroyd@mozilla.com", "id": 417288, "name": "nfroyd@mozilla.com", "real_name": "Nathan Froyd [:froydnj]"}, "alias": null, "groups": [], "cf_status_firefox60": "---", "target_milestone": "mozilla45", "cf_status_firefox44": "---", "is_cc_accessible": true, "cf_rank": null, "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "nfroyd@mozilla.com", "id": 417288, "name": "nfroyd@mozilla.com", "real_name": "Nathan Froyd [:froydnj]"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "gsquelart@mozilla.com", "id": 515575, "name": "gsquelart@mozilla.com", "real_name": "Gerald Squelart [:gerald]"}, {"email": "karlt@mozbugz.karlt.net", "id": 274246, "name": "karlt@mozbugz.karlt.net", "real_name": "Karl Tomlinson (:karlt)"}], "cf_status_b2g_2_5": "---", "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "assigned_to": "nfroyd@mozilla.com", "is_open": false, "history": [{"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8681719, "added": "review?(gsquelart@mozilla.com)"}, {"removed": "", "field_name": "cc", "added": "gsquelart@mozilla.com"}], "who": "nfroyd@mozilla.com", "when": "2015-11-01T22:37:11Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(gsquelart@mozilla.com)", "attachment_id": 8681719, "added": "review+"}], "who": "gsquelart@mozilla.com", "when": "2015-11-02T05:50:31Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "karlt@mozbugz.karlt.net"}], "who": "karlt@mozbugz.karlt.net", "when": "2015-11-02T18:26:38Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla45"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2015-11-03 03:20:26"}, {"removed": "---", "field_name": "cf_status_firefox45", "added": "fixed"}], "who": "cbook@mozilla.com", "when": "2015-11-03T11:20:26Z"}, {"changes": [{"removed": "---", "field_name": "cf_status_b2g_2_5", "added": "fixed"}], "who": "cbook@mozilla.com", "when": "2015-11-04T15:11:32Z"}, {"changes": [{"removed": "fixed", "field_name": "cf_status_b2g_2_5", "added": "---"}], "who": "cbook@mozilla.com", "when": "2015-11-05T16:50:56Z"}], "resolution": "FIXED", "op_sys": "All", "cf_fx_points": "---", "cf_blocking_fennec": "---"}