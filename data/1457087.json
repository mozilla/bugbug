{"attachments": [{"creator": "jorgk@jorgk.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8971173}, {"creator": "jorgk@jorgk.com", "is_obsolete": 0, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8971201}, {"creator": "philipp@bugzilla.kewis.ch", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-05-06T11:21:36Z", "type_id": 4, "creation_date": "2018-05-04T11:48:16Z", "id": 1752680, "setter": "makemyday@gmx-topmail.de"}], "content_type": "text/plain", "id": 8973160}, {"creator": "jorgk@jorgk.com", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/plain", "id": 8973699}], "classification": "Client Software", "creator": "jorgk@jorgk.com", "mentors_detail": [], "depends_on": [], "creation_time": "2018-04-26T09:28:51Z", "cf_user_story": "", "is_open": true, "keywords": ["leave-open"], "summary": "Massive Calendar Xpcshell test failure 2018-04-26: all tests failing", "cf_last_resolved": null, "assigned_to_detail": {"email": "philipp@bugzilla.kewis.ch", "id": 253233, "name": "philipp@bugzilla.kewis.ch", "real_name": "Philipp Kewisch [:Fallen] "}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_crash_signature": "", "comments": [{"text": "comm/calendar/test/unit/test_bug494140.js\ncomm/calendar/test/unit/test_alarmutils.js \ncomm/calendar/test/unit/test_alarmservice.js\ncomm/calendar/test/unit/test_bug343792.js\ncomm/calendar/test/unit/test_bug356207.js\ncomm/calendar/test/unit/test_ics.js\ncomm/calendar/test/unit/test_bug759324.js\ncomm/calendar/test/unit/test_calmgr.js\ncomm/calendar/test/unit/test_datetime.js\ncomm/calendar/test/unit/test_providers.js", "author": "jorgk@jorgk.com", "id": 13234816, "time": "2018-04-26T09:28:51Z"}, {"text": "Created attachment 8971173\n1457087-switch-off-tests.patch", "author": "jorgk@jorgk.com", "id": 13234877, "time": "2018-04-26T09:58:21Z"}, {"text": "Pushed by mozilla@jorgk.com:\nhttps://hg.mozilla.org/comm-central/rev/3b668ee2e9b2\ntemporarily switch off failing calendar tests. rs=bustage-fix DONTBUILD", "author": "pulsebot@bots.tld", "id": 13234879, "time": "2018-04-26T09:59:42Z"}, {"text": "I've switched these tests off for now to allow for effective sheriffing.\n\nLet's try to find the cause:\nM-C last good: 7f6a582f00bfb5d0acb8d8bf7f8c79ca37\nM-C first bad: b62ad926cf2a2d5759222f4e9b40c9e3bd\n\nhttps://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=7f6a582f00bfb5d0acb8d8bf7f8c79ca37&tochange=b62ad926cf2a2d5759222f4e9b40c9e3bd\n\nCould be related to bug 1456677 (although that's about blocklists) or bug 1456035.\n\nThe log\nhttps://taskcluster-artifacts.net/T9UhV8PFQhajq-D8NZeoPw/0/public/logs/live_backing.log\nisn't really so conclusive:\nJavaScript strict warning: /Users/cltbld/tasks/task_1524727248/build/tests/xpcshell/tests/comm/calendar/test/unit/test_ics.js, line 107: ReferenceError: reference to undefined property \"startDate\"\nJavaScript strict warning: resource://calendar/modules/utils/calItemUtils.jsm, line 283: ReferenceError: reference to undefined property \"completedDate\"\nJavaScript strict warning: resource://gre/modules/XPCOMUtils.jsm, line 277: ReferenceError: reference to undefined property 1", "author": "jorgk@jorgk.com", "id": 13234892, "time": "2018-04-26T10:09:43Z"}, {"text": "(In reply to Jorg K (GMT+1) from bug 1456677 comment #10)\n> Gijs and Kris, do we need to port anything else here? In this merge we get\n> 10 Calendar Xpcshell failures, bug 1457087, but nothing that looks like\n> blocklist related.:gijs\n\nSo I'm a little bit at sea because you didn't link to the orange you meant, and there were a lot of pushes on the 23rd, and I don't understand how comm-central works with m-c tip. So take the following with appropriate amounts of salt etc.\n\nI could be wrong, but I think the calendar issues are related to other things in those pushes. Specifically, there is eslint orange on the push with the calendar failures:\n\nhttps://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=069aa51eefe67ae85a0768a9eaf570b840126b99&selectedJob=175674634\n\nTEST-UNEXPECTED-ERROR | /builds/worker/checkouts/gecko/comm/calendar/base/modules/utils/calACLUtils.jsm:8:1 | 'cal' is defined but never used. Allowed unused vars must match /EXPORTED_SYMBOLS/. (no-unused-vars)\nTEST-UNEXPECTED-ERROR | /builds/worker/checkouts/gecko/comm/calendar/base/modules/utils/calXMLUtils.jsm:7:1 | 'cal' is defined but never used. Allowed unused vars must match /EXPORTED_SYMBOLS/. (no-unused-vars)\n\nwhich just looks like one of the things there might have broken calendar, maybe the bug 1440587 stuff (which is a bit scary because it looks like that was uplifted to beta). Maybe :Fallen can take a look.\n\nThere's some X4 xpcshell orange on seemingly-related tests (telemetry environment etc.) but that seems to predate Kris' patches (ie I see it on pushes on April 13th). I don't know how old that is; if it's related to earlier blocklist changes please let me know.", "author": "gijskruitbosch+bugs@gmail.com", "id": 13234905, "time": "2018-04-26T10:14:03Z"}, {"text": "Thanks, Gijs. Yes, this is the push, and the oranges are here for example:\nhttps://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=069aa51eefe67ae85a0768a9eaf570b840126b99&selectedJob=175678705\n\nI don't think the eslint failures are significant, but I've already filed a bug from them this morning: Bug 1457064. I find it a little disconcerting that those have popped up since apart from making string changes, nothing changed in Calendar in that push. String changes:\nhttps://hg.mozilla.org/comm-central/rev/aaebcb45064cf4d54cad75594ee85cc8b4ede130\nBug 1440587 did a lot of stuff, but this was just a trivial follow-up.\n\nThe X4 failures are reported in bug 1448831, apparently some Windows locking issue that only happens on C-C and not M-C. No time to look at it further.\n\nI think the Calendar guys need to investigate here.", "author": "jorgk@jorgk.com", "id": 13234919, "time": "2018-04-26T10:22:09Z"}, {"text": "Tooru-san, you have a good eye for regressions, can you see anything in this range:\nhttps://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=7f6a582f00bfb5d0acb8d8bf7f8c79ca37&tochange=b62ad926cf2a2d5759222f4e9b40c9e3bd", "author": "jorgk@jorgk.com", "id": 13234956, "time": "2018-04-26T10:51:15Z"}, {"text": "(In reply to Jorg K (GMT+1) from comment #5)\n> I don't think the eslint failures are significant, but I've already filed a\n> bug from them this morning: Bug 1457064. I find it a little disconcerting\n> that those have popped up since apart from making string changes, nothing\n> changed in Calendar in that push. String changes:\n> https://hg.mozilla.org/comm-central/rev/\n> aaebcb45064cf4d54cad75594ee85cc8b4ede130\n\nMaybe there were eslint changes on m-c?", "author": "gijskruitbosch+bugs@gmail.com", "id": 13234958, "time": "2018-04-26T10:53:58Z"}, {"text": "Sadly, after this push\nhttps://hg.mozilla.org/comm-central/rev/3b668ee2e9b2\ntemporarily switch off failing calendar tests. rs=bustage-fix DONTBUILD\nthere are till may more test failures:\nTEST-UNEXPECTED-FAIL | xpcshell-icaljs.ini:comm/calendar/test/unit/test_timezone.js | xpcshell return code: 0\nTEST-UNEXPECTED-TIMEOUT | xpcshell-icaljs.ini:comm/calendar/test/unit/test_freebusy.js | Test timed out\nTEST-UNEXPECTED-TIMEOUT | xpcshell-icaljs.ini:comm/calendar/test/unit/test_freebusy_service.js | Test timed out\nTEST-UNEXPECTED-TIMEOUT | xpcshell-icaljs.ini:comm/calendar/test/unit/test_deleted_items.js | Test timed out\nTEST-UNEXPECTED-TIMEOUT | xpcshell-icaljs.ini:comm/calendar/test/unit/test_ltninvitationutils.js | Test timed out\nTEST-UNEXPECTED-TIMEOUT | xpcshell-icaljs.ini:comm/calendar/test/unit/test_datetimeformatter.js | Test timed out\nTEST-UNEXPECTED-TIMEOUT | xpcshell-icaljs.ini:comm/calendar/test/unit/test_items.js | Test timed out\nTEST-UNEXPECTED-TIMEOUT | xpcshell-icaljs.ini:comm/calendar/test/unit/test_ics_service.js | Test timed out\nTEST-UNEXPECTED-TIMEOUT | xpcshell-icaljs.ini:comm/calendar/test/unit/test_ics_parser.js | Test timed out\nTEST-UNEXPECTED-TIMEOUT | xpcshell-icaljs.ini:comm/calendar/test/unit/test_recur.js | Test timed out\nTEST-UNEXPECTED-TIMEOUT | xpcshell-icaljs.ini:comm/calendar/test/unit/test_rfc3339_parser.js | Test timed out\nTEST-UNEXPECTED-TIMEOUT | xpcshell-icaljs.ini:comm/calendar/test/unit/test_storage.js | Test timed out\nTEST-UNEXPECTED-TIMEOUT | xpcshell-icaljs.ini:comm/calendar/test/unit/test_timezone_definition.js | Test timed out\nTEST-UNEXPECTED-TIMEOUT | xpcshell-icaljs.ini:comm/calendar/test/unit/test_utils.js | Test timed out\n\nThose timeouts make the Xpcshell tests fail after 90 minutes, instead of normally taking 10 minutes. Not a good place to be.\n\nNoteworthy:\n\"CONSOLE_MESSAGE: (error) [JavaScript Error: \"TypeError: service[method] is not a function\" {file: \"resource://calendar/modules/calUtils.jsm -> file:///builds/worker/workspace/build/application/thunderbird/extensions/%7Be2fda1a4-762b-4020-b5ad-a41df1933103%7D/calendar-js/calStartupService.js\" line: 21}]\"", "author": "jorgk@jorgk.com", "id": 13235058, "time": "2018-04-26T12:29:22Z"}, {"text": "Or maybe all the tests will fail, it's just a matter of luck how many get run before the timeout hits. Different platforms show different failures, so that would confirm that.\n\nI will disable Calendar completely since a) it doesn't work b) Mozimill is disabled already c) the Xpcshell test failures don't allow efficient development, try run and sheriffing.", "author": "jorgk@jorgk.com", "id": 13235077, "time": "2018-04-26T12:36:46Z"}, {"text": "Created attachment 8971201\n1457087-disable-calendar.patch", "author": "jorgk@jorgk.com", "id": 13235083, "time": "2018-04-26T12:42:53Z"}, {"text": "Pushed by mozilla@jorgk.com:\nhttps://hg.mozilla.org/comm-central/rev/21722119d184\nBacked out changeset 3b668ee2e9b2 a=backout\nhttps://hg.mozilla.org/comm-central/rev/8744c2251b63\nDisable building Calendar/Lightning. rs=bustage-fix", "author": "pulsebot@bots.tld", "id": 13235085, "time": "2018-04-26T12:44:13Z"}, {"text": "Running a test locally, I see:\n\n 0:01.47 INFO \"CONSOLE_MESSAGE: (error) [JavaScript Error: \"TypeError: service[method] is not a function\" {file: \"resource://calendar/modules/calUtils.jsm -> file:///c:/mozilla-source/comm-central/obj-x86_64-pc-mingw32/dist/bin/extensions/%7Be2fda1a4-762b-4020-b5ad-a41df1933103%7D/calendar-js/calStartupService.js\" line: 21}]\"\n\nAnd it's hung there.", "author": "jorgk@jorgk.com", "id": 13235118, "time": "2018-04-26T13:02:06Z"}, {"text": "The push in comment #11 got us busted completely since calendar is referenced in\nhttps://dxr.mozilla.org/comm-central/rev/8d636ad5810b5586433294c16cb2376d826fcca8/mail/locales/Makefile.in#97\n\nHere's an attempt to fix this:\nhttps://treeherder.mozilla.org/#/jobs?repo=try-comm-central&revision=8b005a969404f8339f346e6c03190b0570a3495e\n\nAnd another one:\nhttps://treeherder.mozilla.org/#/jobs?repo=try-comm-central&revision=0c6154af9412de561610d6d25ac252d927b7c518", "author": "jorgk@jorgk.com", "id": 13235638, "time": "2018-04-26T15:11:29Z"}, {"text": "And another one:\nhttps://treeherder.mozilla.org/#/jobs?repo=try-comm-central&revision=376c61d4e6b1d8c9b0dcab7dc097bede6760d58c", "author": "jorgk@jorgk.com", "id": 13235679, "time": "2018-04-26T15:20:02Z"}, {"text": "The first failure-messages don't point in that direction, but with the Timeouts, I wonder if this can be related to Bug 1449487?", "author": "Mozilla@Adrario.de", "id": 13236039, "time": "2018-04-26T17:00:22Z"}, {"text": "Well, yes, Lightning as a non-bootstrapped add-on isn't working and we disabled Mozmill. Somehow Xpcshell tests still ran, and I was waiting for the day they would fail. This day has come apparently, but I'd still like to understand what caused the failure now in this M-C merge of this morning:\nhttps://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=7f6a582f00bfb5d0acb8d8bf7f8c79ca37&tochange=b62ad926cf2a2d5759222f4e9b40c9e3bd\n\nBTW, the build failure covered in the try runs was fixed as a follow-up in bug 1439469. So the tree is green again, but without Lightning.", "author": "jorgk@jorgk.com", "id": 13236232, "time": "2018-04-26T17:59:04Z"}, {"text": "Started four try runs against various M-C revisions to bisect this:\nhttps://treeherder.mozilla.org/#/jobs?repo=try-comm-central&revision=43b52aa924f27a76287271dce2abca2af20dff2e\nhttps://treeherder.mozilla.org/#/jobs?repo=try-comm-central&revision=a1e1237f96f15ffc8279a1f75567b9152d6d2a9b\nhttps://treeherder.mozilla.org/#/jobs?repo=try-comm-central&revision=aea78010c8fb1aaadbc3f1a4040ec8415b847ddf\nhttps://treeherder.mozilla.org/#/jobs?repo=try-comm-central&revision=00e0976b536107b83df3747aa32761a70aec4c86", "author": "jorgk@jorgk.com", "id": 13236953, "time": "2018-04-26T22:11:47Z"}, {"text": "All four try runs didn't show the failure. So this brings the regression range down to:\nLast Good: c6fea87acb49 - c6fea87acb491d99fdae69335dbb902c9b\nFirst Bad: b62ad926cf2a - b62ad926cf2a2d5759222f4e9b40c9e3bd\nhttps://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=c6fea87acb49&tochange=b62ad926cf2a\nhttps://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=c6fea87acb491d99fdae69335dbb902c9b&tochange=b62ad926cf2a2d5759222f4e9b40c9e3bd\nFor some reason, the above link don't work for some unknown reason :-( So I'm copying the range here:\n\nb62ad926cf2a\tAndreea Pavel \u2014 Merge mozilla-inbound to mozilla-central. a=merge\n822e81707327\tJeff Walden \u2014 Bug 1451248. r=jorendorff, r=bz\n3010f9088dc7\tJeff Walden \u2014 Bug 1456296 - Move IdentifierName parsing into a separate function from TSS::getTokenInternal to simplify some control flow. r=arai\n595101eb4739\tBrian Birtles \u2014 Bug 1454123 - Wait a moment after moving toolbox to a window before triggering its menu; r=bgrins\n3e771c2f48b0\tKris Maglione \u2014 Bug 1456035: Follow-up: Fix wrapper error in plain mochitest. r=bustage\n63241afeab20\tKris Maglione \u2014 Bug 1456035: Follow-up: Delete redundant test_extensionURL.html, which fails with wrapper errors. r=me f=aswan CLOSED TREE\nbd589df323a9\tShane Caraveo \u2014 Bug 1455755 Move browserSettings.proxyConfig to proxy.settings, r=aswan, mstrimer\n35fe51311264\tKris Maglione \u2014 Bug 1456677: Make the blocklist service a JSM, with an XPCOM service stub. r=Gijs\n2add2de30c22\tKris Maglione \u2014 Bug 1456035: Part 3.1 - Add temporary fallback XPCOMUtils.generateQI implementation for Android hostutils. r=me\naffc06c38acd\tKris Maglione \u2014 Bug 1456035: Part 3 - Replace XPCOMUtils.generateQI with a stub for ChromeUtils.generateQI. r=mccr8\n0102a61e38ae\tKris Maglione \u2014 Bug 1456035: Part 2 - Add fast path for XPCWrappedJS QueryInterface with native helper. r=mccr8\na442c0b9dbbe\tKris Maglione \u2014 Bug 1456035: Part 1 - Add helper to generate native QueryInterface callbacks. r=bz\nc6fea87acb49\tarthur.iakab \u2014 Merge mozilla-central to inbound on a CLOSED TREE\n\nKris, what has changed in that range so that our non-bootstrapped Calendar add-on, which was limping along since non-bootstrapped add-ons were (incompletely) disabled, now also doesn't work in Xpcshell tests any more?", "author": "jorgk@jorgk.com", "id": 13237511, "time": "2018-04-27T06:46:47Z"}, {"text": "I've done another (failed) try at 3e771c2f48b0, so that confirms bug 1456035.\n\nKris, this doesn't look like add-on work, so why would that affect the Xpshell tests of the (half-dead) non-bootstrapped Calendar add-on? The major issue seems to be comment #12. Or perhaps Boris or Andrew have an idea.", "author": "jorgk@jorgk.com", "id": 13237987, "time": "2018-04-27T12:15:09Z"}, {"text": "If I had to guess, I'd say it's because XPCOMUtils.generateQI no longer special cases nsIClassInfo to return this.classInfo (which is unused in m-c and more or less going away).\n\nNot sure what you mean by \"incompletely disabled\". The code for loading non-bootstrapped extensions is very much gone.", "author": "kmaglione+bmo@mozilla.com", "id": 13238978, "time": "2018-04-27T19:25:33Z"}, {"text": "Thanks for the guess :-)\n\n(In reply to Kris Maglione [:kmag] (long backlog; ping on IRC if you're blocked) from comment #20)\n> If I had to guess, I'd say it's because XPCOMUtils.generateQI no longer\n> special cases nsIClassInfo to return this.classInfo (which is unused in m-c\n> and more or less going away).\nThat doesn't mean anything to me, but I hope the JS experts from the Calendar team will understand what that's about.\n\n> Not sure what you mean by \"incompletely disabled\". The code for loading\n> non-bootstrapped extensions is very much gone.\nWell, no offence intended. I'll explain. Although non-bootstrapped add-ons are no longer supported since bug 1447831 and bug 1448221, we were still building and packaging the non-bootstrapped Lightning/Calendar add-on and were running Xpcshell tests with it until they all started to fail due to bug 1456035. Is it therefore completely unreasonable to call that \"incompletely disabled\".", "author": "jorgk@jorgk.com", "id": 13239008, "time": "2018-04-27T19:44:15Z"}, {"text": "(In reply to Kris Maglione [:kmag] (long backlog; ping on IRC if you're blocked) from comment #20)\n> If I had to guess, I'd say it's because XPCOMUtils.generateQI no longer\n> special cases nsIClassInfo to return this.classInfo (which is unused in m-c\n> and more or less going away).\nAre you saying nsIClassInfo is on its way out, or just the this.classInfo special case? I tried doing the conversion here, but I have a few methods that return calIBaseClass which can be a calIThingA or calIThingB. With correct class info I don't need to specifically QI the result to e.g. calIThingA, but can just use it and xpcom/xpconnect will do the right thing.", "author": "philipp@bugzilla.kewis.ch", "id": 13247111, "time": "2018-05-01T20:46:39Z"}, {"text": "Created attachment 8973160\nFix - v1\n\nThis fixes the issues by using a custom generateQI (almost) everywhere where more than one interface is supported. Long term we probably just want to get rid of all the xpcom classes in calendar, but that isn't exactly a small patch.\n\nKris, despite patch I'd still be interested to hear what the future of nsIClassInfo is. It seems there are some mechanics in the platform that use nsIClassInfo to give an xpcom wrapped object the classes it needs, and I'd like to avoid having to sprinkle .QueryInterface(Ci.calIObvious) everywhere.", "author": "philipp@bugzilla.kewis.ch", "id": 13254353, "time": "2018-05-04T11:48:16Z"}, {"text": "Did you run the tests locally? I can't see any try run.", "author": "jorgk@jorgk.com", "id": 13254493, "time": "2018-05-04T12:55:55Z"}, {"text": "Comment on attachment 8973160\nFix - v1\n\nReview of attachment 8973160:\n-----------------------------------------------------------------\n\nThanks for bringing the xpcshell tests back! r+ with the below comments considered.\n\nXpcshell test are running locally for me with this patch applied on top of the patch 1452120, but a try push wouldn't hurt.\n\n::: calendar/base/backend/icaljs/calRecurrenceRule.js\n@@ +12,5 @@\n>  }\n>  \n> +var calRecurrenceRuleInterfaces = [\n> +    Components.interfaces.calIRecurrenceRule,\n> +    Components.interfaces.calIRecurrenceItem\n\ncalIReccurrenceItem wasn't included before. Why is that needed now?\n\nApart from that, we should convert Components.interfaces to Ci at all places we touch it (you changed this at some places already). But since we have a separate bug for it, I spare further comments on that in this review.\n\n::: calendar/base/modules/calUtils.jsm\n@@ +189,5 @@\n> +        if (aInterfaces.length == 1) {\n> +            cal.WARN(\"When generating QI for one interface, please use ChromeUtils.generateQI\", cal.STACK(10));\n> +            return ChromeUtils.generateQI(aInterfaces);\n> +        } else {\n> +            /* Note that Ci[Ci.x] == Ci.x for all x */\n\nWhat's this comment for?\n\n@@ +192,5 @@\n> +        } else {\n> +            /* Note that Ci[Ci.x] == Ci.x for all x */\n> +            let names = [];\n> +            if (aInterfaces) {\n> +                for (let i = 0; i < aInterfaces.length; i++) {\n\nCan you switch to for (let iface of interfaces) here?", "author": "makemyday@gmx-topmail.de", "id": 13256934, "time": "2018-05-06T11:21:36Z"}, {"text": "https://hg.mozilla.org/try-comm-central/rev/e51b776a5618ccfdc63eb2e3f770b47e0ddc8fc5 (bug 1452120)\nhttps://hg.mozilla.org/try-comm-central/rev/bc5dc60d53bac7dd5ba0da38458376ebf949f3a8\nhttps://treeherder.mozilla.org/#/jobs?repo=try-comm-central&revision=f87978efb7b891b17c94310ed1305840767861f9", "author": "jorgk@jorgk.com", "id": 13256953, "time": "2018-05-06T12:56:06Z"}, {"text": "(In reply to Philipp Kewisch [:Fallen]  from comment #23)\n> Kris, despite patch I'd still be interested to hear what the future of\n> nsIClassInfo is. It seems there are some mechanics in the platform that use\n> nsIClassInfo to give an xpcom wrapped object the classes it needs, and I'd\n> like to avoid having to sprinkle .QueryInterface(Ci.calIObvious) everywhere.\n\nAt this point, you should probably consider nsIClassInfo deprecated, and likely to go away. Its main uses were meant to deal with exposing things to the web, which we now use WebIDL for. If JS objects are being used by JS, they shouldn't be using XPConnect bindings at all. If they're being used by C++, ClassInfo has no effect.", "author": "kmaglione+bmo@mozilla.com", "id": 13256965, "time": "2018-05-06T13:39:56Z"}, {"text": "(In reply to Jorg K (GMT+1) from comment #26)\n> https://treeherder.mozilla.org/#/jobs?repo=try-comm-\n> central&revision=f87978efb7b891b17c94310ed1305840767861f9\nNot successful. I'll do a try for bug 1452120 alone on the beta.", "author": "jorgk@jorgk.com", "id": 13257061, "time": "2018-05-06T17:15:18Z"}, {"text": "(In reply to [:MakeMyDay] from comment #25)\n> Comment on attachment 8973160\n> Fix - v1\n> \n> Review of attachment 8973160:\n> -----------------------------------------------------------------\n> \n> Thanks for bringing the xpcshell tests back! r+ with the below comments\n> considered.\n> \n> Xpcshell test are running locally for me with this patch applied on top of\n> the patch 1452120, but a try push wouldn't hurt.\n> \n> ::: calendar/base/backend/icaljs/calRecurrenceRule.js\n> @@ +12,5 @@\n> >  }\n> >  \n> > +var calRecurrenceRuleInterfaces = [\n> > +    Components.interfaces.calIRecurrenceRule,\n> > +    Components.interfaces.calIRecurrenceItem\n> \n> calIReccurrenceItem wasn't included before. Why is that needed now?\n\ncalIRecurrenceRule's idl interfaces extends calIRecurrenceItem. This is really just for completeness, because essentially the object supports both interfaces. It is not strictly necessary.\n\n\n> \n> Apart from that, we should convert Components.interfaces to Ci at all places\n> we touch it (you changed this at some places already). But since we have a\n> separate bug for it, I spare further comments on that in this review.\nYeah, let's run the script in that separate bug soon.\n\n\n> \n> ::: calendar/base/modules/calUtils.jsm\n> @@ +189,5 @@\n> > +        if (aInterfaces.length == 1) {\n> > +            cal.WARN(\"When generating QI for one interface, please use ChromeUtils.generateQI\", cal.STACK(10));\n> > +            return ChromeUtils.generateQI(aInterfaces);\n> > +        } else {\n> > +            /* Note that Ci[Ci.x] == Ci.x for all x */\n> \n> What's this comment for?\nThis is copy/paste from XPCOMUtils. I'm not really sure what relevance this has.\n\n\n> \n> @@ +192,5 @@\n> > +        } else {\n> > +            /* Note that Ci[Ci.x] == Ci.x for all x */\n> > +            let names = [];\n> > +            if (aInterfaces) {\n> > +                for (let i = 0; i < aInterfaces.length; i++) {\n> \n> Can you switch to for (let iface of interfaces) here?\nIn reading some m-c code, it seems it is advisable to use only js code that is as basic as possible here. This is hot code, and for..of requires the iterator protocol, while for(;;) can be optimized better.\n\nI'd suggest we leave the patch as is given above comments and push when any dependencies are ready.", "author": "philipp@bugzilla.kewis.ch", "id": 13257125, "time": "2018-05-06T20:47:12Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try-comm-central&revision=4e9482e4eac13e8d0a1441530ccae4eb7a02e2b2\nwith bug 1452120 landed as requested in bug 1452120 comment 42.\n\nBTW, replacing Components.interfaces is bug 1458367.", "author": "jorgk@jorgk.com", "id": 13258766, "time": "2018-05-07T07:31:12Z"}, {"text": "Still unsuccessful as before:\nTypeError: Components.classes[\"@mozilla.org/calendar/backend-loader;1\"] is undefined\nReferenceError: cal is not defined at [snip]/calendar/test/unit/test_duration.js:6\netc.", "author": "jorgk@jorgk.com", "id": 13259232, "time": "2018-05-07T10:43:45Z"}, {"text": "Hmm wfm locally. I'll try again with the other patches on my stack, maybe one of them has side-effects.", "author": "philipp@bugzilla.kewis.ch", "id": 13259421, "time": "2018-05-07T12:49:17Z"}, {"text": "Fails with my try run as well. Works locally with packaged tests. I'm not really sure what else could be the difference to automation. Wild guess the chrome manifest of Lightning is not properly loaded, but I am not sure.", "author": "philipp@bugzilla.kewis.ch", "id": 13259605, "time": "2018-05-07T14:16:47Z"}, {"text": "Created attachment 8973699\nalarm.txt\n\n(In reply to Philipp Kewisch [:Fallen]  from comment #33)\n> Works locally with packaged tests.\n\nmach xpcshell-test comm/calendar/test/unit/test_alarm.js\npasses locally for me but throws up heaps of errors, see enclosed:\n 0:01.22 pid:4584 Testing initial creation...JavaScript error: c:/mozilla-source/comm-central/obj-x86_64-pc-mingw32/_tests/xpcshell/comm/calendar/test/unit/test_alarm.js, line 33: uncaught exception: 3253927937\n\n 0:01.45 pid:4584 JavaScript error: c:/mozilla-source/comm-central/obj-x86_64-pc-mingw32/_tests/xpcshell/comm/calendar/test/unit/test_alarm.js, line 339: uncaught exception: 2147500037\n\n 0:07.34 pid:4584 JavaScript error: resource://calendar/modules/ical.js, line 5643: too much recursion\n\n 0:12.61 pid:4584 JavaScript error: c:/mozilla-source/comm-central/obj-x86_64-pc-mingw32/_tests/xpcshell/comm/calendar/test/unit/test_alarm.js, line 355: uncaught exception: 2147500037\n\n 0:12.64 pid:4584 JavaScript error: c:/mozilla-source/comm-central/obj-x86_64-pc-mingw32/_tests/xpcshell/comm/calendar/test/unit/test_alarm.js, line 409: uncaught exception: 2152071170\n\njust to list a few.", "author": "jorgk@jorgk.com", "id": 13259702, "time": "2018-05-07T15:03:37Z"}, {"text": "*** Bug 1464014 has been marked as a duplicate of this bug. ***", "author": "jorgk@jorgk.com", "id": 13359914, "time": "2018-05-24T18:33:48Z"}], "id": 1457087, "priority": "--", "platform": "Unspecified", "comment_count": 36, "version": "Trunk", "is_cc_accessible": true, "status": "ASSIGNED", "product": "Calendar", "blocks": [1442985, 1458370], "qa_contact": "", "see_also": [], "cf_fx_iteration": "---", "component": "General", "votes": 0, "groups": [], "target_milestone": "---", "cc": ["arai.unmht@gmail.com", "continuation@gmail.com", "gijskruitbosch+bugs@gmail.com", "kmaglione+bmo@mozilla.com", "makemyday@gmx-topmail.de", "mkmelin+mozilla@iki.fi", "Mozilla@Adrario.de", "philipp@bugzilla.kewis.ch", "tschweikle@gmail.com", "wls220spring@gmail.com"], "url": "", "creator_detail": {"email": "jorgk@jorgk.com", "id": 176914, "name": "jorgk@jorgk.com", "real_name": "Jorg K (GMT+2)"}, "whiteboard": " [Thunderbird-testfailure: X all][Thunderbird-disabled-test]", "mentors": [], "cc_detail": [{"email": "arai.unmht@gmail.com", "id": 310076, "name": "arai.unmht@gmail.com", "real_name": "Tooru Fujisawa [:arai]"}, {"email": "continuation@gmail.com", "id": 406194, "name": "continuation@gmail.com", "real_name": "Andrew McCreight [:mccr8]"}, {"email": "gijskruitbosch+bugs@gmail.com", "id": 159069, "name": "gijskruitbosch+bugs@gmail.com", "real_name": ":Gijs (he/him)"}, {"email": "kmaglione+bmo@mozilla.com", "id": 106098, "name": "kmaglione+bmo@mozilla.com", "real_name": "Kris Maglione [:kmag]"}, {"email": "makemyday@gmx-topmail.de", "id": 491185, "name": "makemyday@gmx-topmail.de", "real_name": "[:MakeMyDay]"}, {"email": "mkmelin+mozilla@iki.fi", "id": 101158, "name": "mkmelin+mozilla@iki.fi", "real_name": "Magnus Melin"}, {"email": "Mozilla@Adrario.de", "id": 264477, "name": "Mozilla@Adrario.de", "real_name": "Markus Adrario [:Taraman]"}, {"email": "philipp@bugzilla.kewis.ch", "id": 253233, "name": "philipp@bugzilla.kewis.ch", "real_name": "Philipp Kewisch [:Fallen] "}, {"email": "tschweikle@gmail.com", "id": 63074, "name": "tschweikle@gmail.com", "real_name": "tps@vr-web.de"}, {"email": "wls220spring@gmail.com", "id": 433224, "name": "wls220spring@gmail.com", "real_name": "WaltS48"}], "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-05-28T13:56:33Z", "assigned_to": "philipp@bugzilla.kewis.ch", "cf_qa_whiteboard": "", "resolution": "", "op_sys": "Unspecified", "cf_fx_points": "---", "history": [{"changes": [{"removed": "", "field_name": "keywords", "added": "leave-open"}], "who": "jorgk@jorgk.com", "when": "2018-04-26T09:58:01Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "gijskruitbosch+bugs@gmail.com, philipp@bugzilla.kewis.ch"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(philipp@bugzilla.kewis.ch)"}], "who": "gijskruitbosch+bugs@gmail.com", "when": "2018-04-26T10:14:03Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "makemyday@gmx-topmail.de, Mozilla@Adrario.de, mschroeder@mozilla.x-home.org"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(Mozilla@Adrario.de), needinfo?(makemyday@gmx-topmail.de), needinfo?(mschroeder@mozilla.x-home.org)"}], "who": "jorgk@jorgk.com", "when": "2018-04-26T10:22:09Z"}, {"changes": [{"removed": "", "field_name": "whiteboard", "added": " [Thunderbird-testfailure: X all][Thunderbird-disabled-test]"}], "who": "jorgk@jorgk.com", "when": "2018-04-26T10:28:58Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "arai.unmht@gmail.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(arai.unmht@gmail.com)"}], "who": "jorgk@jorgk.com", "when": "2018-04-26T10:51:15Z"}, {"changes": [{"removed": "Massive Calendar Xpcshell test failure 2018-04-26: 10 failing tests", "field_name": "summary", "added": "Massive Calendar Xpcshell test failure 2018-04-26: all tests failing"}], "who": "jorgk@jorgk.com", "when": "2018-04-26T12:41:38Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8971173, "added": "1"}], "who": "jorgk@jorgk.com", "when": "2018-04-26T12:42:53Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mkmelin+mozilla@iki.fi"}], "who": "mkmelin+mozilla@iki.fi", "when": "2018-04-26T13:35:03Z"}, {"changes": [{"removed": "needinfo?(Mozilla@Adrario.de)", "field_name": "flagtypes.name", "added": ""}], "who": "Mozilla@Adrario.de", "when": "2018-04-26T17:00:22Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "kmaglione+bmo@mozilla.com"}, {"removed": "needinfo?(mschroeder@mozilla.x-home.org)", "field_name": "flagtypes.name", "added": "needinfo?(kmaglione+bmo@mozilla.com)"}], "who": "jorgk@jorgk.com", "when": "2018-04-27T06:46:47Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "bzbarsky@mit.edu, continuation@gmail.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(bzbarsky@mit.edu), needinfo?(continuation@gmail.com)"}], "who": "jorgk@jorgk.com", "when": "2018-04-27T12:15:09Z"}, {"changes": [{"removed": "mschroeder@mozilla.x-home.org", "field_name": "cc", "added": ""}], "who": "mschroeder@mozilla.x-home.org", "when": "2018-04-27T19:14:00Z"}, {"changes": [{"removed": "needinfo?(kmaglione+bmo@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "kmaglione+bmo@mozilla.com", "when": "2018-04-27T19:25:33Z"}, {"changes": [{"removed": "needinfo?(arai.unmht@gmail.com), needinfo?(bzbarsky@mit.edu), needinfo?(continuation@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "jorgk@jorgk.com", "when": "2018-04-27T19:44:15Z"}, {"changes": [{"removed": "bzbarsky@mit.edu", "field_name": "cc", "added": ""}], "who": "bzbarsky@mit.edu", "when": "2018-04-30T20:42:11Z"}, {"changes": [{"removed": "needinfo?(philipp@bugzilla.kewis.ch), needinfo?(makemyday@gmx-topmail.de)", "field_name": "flagtypes.name", "added": "needinfo?(kmaglione+bmo@mozilla.com)"}], "who": "philipp@bugzilla.kewis.ch", "when": "2018-05-01T20:46:39Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "ASSIGNED"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "philipp@bugzilla.kewis.ch"}], "who": "philipp@bugzilla.kewis.ch", "when": "2018-05-01T20:46:59Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1458370"}], "who": "philipp@bugzilla.kewis.ch", "when": "2018-05-01T21:50:27Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8973160, "added": "review?(makemyday@gmx-topmail.de)"}], "who": "philipp@bugzilla.kewis.ch", "when": "2018-05-04T11:48:16Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(makemyday@gmx-topmail.de)", "attachment_id": 8973160, "added": "review+"}], "who": "makemyday@gmx-topmail.de", "when": "2018-05-06T11:21:36Z"}, {"changes": [{"removed": "needinfo?(kmaglione+bmo@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "kmaglione+bmo@mozilla.com", "when": "2018-05-06T13:39:56Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1442985"}], "who": "jorgk@jorgk.com", "when": "2018-05-08T07:31:41Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "tschweikle@gmail.com"}], "who": "jorgk@jorgk.com", "when": "2018-05-24T18:33:48Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "wls220spring@gmail.com"}], "who": "wls220spring@gmail.com", "when": "2018-05-28T13:56:33Z"}]}