{"status": "RESOLVED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "markh@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2016-05-31T18:23:11Z", "type_id": 748, "creation_date": "2016-05-30T23:28:44Z", "id": 1402908, "setter": "kit@mozilla.com"}], "content_type": "text/x-review-board-request", "id": 8758069}], "classification": "Client Software", "creator": "dcoates@mozilla.com", "cc": ["dcoates@mozilla.com", "kit@mozilla.com", "markh@mozilla.com", "rfkelly@mozilla.com", "whd@mozilla.com"], "depends_on": [], "creation_time": "2016-05-17T17:49:07Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "Add OS to Sync user agent string", "cf_last_resolved": "2016-06-06T09:59:48Z", "assigned_to_detail": {"email": "markh@mozilla.com", "id": 16943, "name": "markh@mozilla.com", "real_name": "Mark Hammond [:markh]"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "assigned_to": "markh@mozilla.com", "comment_count": 13, "comments": [{"text": "The current Sync UA string [1] doesn't include the OS. Maybe it should? It would help make our device metrics [2] better.\n\n\n\n[1] https://github.com/mozilla/gecko-dev/blob/233f30f2377f3df0f3388721901681f432b813fb/services/sync/modules/rest.js#L41\n[2] https://sql.telemetry.mozilla.org/queries/96#150", "author": "dcoates@mozilla.com", "id": 11415595, "time": "2016-05-17T17:49:07Z"}, {"text": "FTR, the user-agent string is built at https://dxr.mozilla.org/mozilla-central/source/services/sync/modules/rest.js#40.\n\nThe current string on my machine is \"Firefox/49.0a1 FxSync/1.51.0.20160516142357.desktop\" while the normal UA string is \"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:49.0) Gecko/20100101 Firefox/49.0\" - should we just append the \"(Windows NT 6.1; WOW64; rv:49.0)\" part to our string, parens and all?", "author": "markh@mozilla.com", "id": 11416673, "time": "2016-05-17T22:57:08Z"}, {"text": "Just a note to be aware, that our metrics pipeline contains special-case logic for parsing these user-agetn strings from sync, which may need to be updated if we add things to them.", "author": "rfkelly@mozilla.com", "id": 11416761, "time": "2016-05-17T23:24:43Z"}, {"text": "Adding :whd for awareness re: potential changes to this string", "author": "rfkelly@mozilla.com", "id": 11416796, "time": "2016-05-17T23:36:48Z"}, {"text": "If we made the string like this:\n\n\"Firefox/46.0 (Windows NT 6.1; WOW64; rv:46.0) FxSync/1.51.0.20160516142357.desktop\"\n\nThe current version of lua_sandbox/common_log_format.lua, Just Works\u2122.", "author": "dcoates@mozilla.com", "id": 11419880, "time": "2016-05-18T19:43:31Z"}, {"text": "Created attachment 8758069\nMozReview Request: Bug 1273587 - Change the User-Agent header sent to Sync to include OS information. r?kitcambridge\n\nThe custom UA string sent by Sync now includes the \"oscpu\" portion of the\ndefault UA string. Eg, with this patch my UA string looks like\n\"Firefox/49.0a1 (Windows NT 6.1; WOW64) FxSync/1.51.0.20160524173017.desktop\"\nwhere the value in parenthesis is added by this patch.\n\nReview commit: https://reviewboard.mozilla.org/r/56442/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/56442/", "author": "markh@mozilla.com", "id": 11449715, "time": "2016-05-30T23:28:44Z"}, {"text": "The attached patch makes the UA string for me look like \"Firefox/49.0a1 (Windows NT 6.1; WOW64) FxSync/1.51.0.20160524173017.desktop\". Wes and Danny, can you please formally note that as far as you know, it's fine for me to land this after it gets review and that if anything breaks on the back-end it isn't my fault? ;)", "author": "markh@mozilla.com", "id": 11449717, "time": "2016-05-30T23:32:13Z"}, {"text": "Comment on attachment 8758069\nMozReview Request: Bug 1273587 - Change the User-Agent header sent to Sync to include OS information. r?kitcambridge\n\nhttps://reviewboard.mozilla.org/r/56442/#review53256\n\n::: services/sync/modules/util.js:73\n(Diff revision 1)\n> +  _userAgent: null,\n> +  get userAgent() {\n> +    if (!this._userAgent) {\n> +      let hph = Cc[\"@mozilla.org/network/protocol;1?name=http\"].getService(Ci.nsIHttpProtocolHandler);\n> +      this._userAgent =\n> +        Services.appinfo.name + \"/\" + Services.appinfo.version +  // Product.\n\nDoes it make sense to include the channel, too, or is the version sufficient for that?\n\n::: services/sync/modules/util.js:78\n(Diff revision 1)\n> +        Services.appinfo.name + \"/\" + Services.appinfo.version +  // Product.\n> +        \" (\" + hph.oscpu + \")\" +                                  // (oscpu)\n> +        \" FxSync/\" + WEAVE_VERSION + \".\" +                        // Sync.\n> +        Services.appinfo.appBuildID + \".\";                        // Build.\n> +    }\n> +    return this._userAgent + Svc.Prefs.get(\"client.type\", \"desktop\");\n\nOut of curiosity, why do we use a custom UA string instead of the default Firefox one? Hysterical raisins? ;-)", "author": "kit@mozilla.com", "id": 11452016, "time": "2016-05-31T18:23:11Z"}, {"text": "Thanks Mark! Nothing I know of will break. The only way I could see this breaking something is if it depends on there *not* being an OS in the parsed string, which I don't think anything does.", "author": "dcoates@mozilla.com", "id": 11452048, "time": "2016-05-31T18:33:40Z"}, {"text": "(In reply to Kit Cambridge [:kitcambridge] from comment #7)\n\n> Does it make sense to include the channel, too, or is the version sufficient\n> for that?\n\nThe default UA doesn't include that - here I was just trying to bring the identical parenthesized version portion from the regular string. Not breaking the server-side parsing is also important.\n\n> Out of curiosity, why do we use a custom UA string instead of the default\n> Firefox one? Hysterical raisins? ;-)\n\nrnewman mentioned it was a decision taken long ago, yeah.\n\n(In reply to Danny Coates [:dcoates] from comment #8)\n> Thanks Mark! Nothing I know of will break. The only way I could see this\n> breaking something is if it depends on there *not* being an OS in the parsed\n> string, which I don't think anything does.\n\nThanks! I'll give :whd a few days to respond then land it.", "author": "markh@mozilla.com", "id": 11452830, "time": "2016-05-31T22:37:52Z"}, {"text": "As far as I know, it's fine for you to land this and if anything breaks on the back-end it isn't your fault ;)", "author": "whd@mozilla.com", "id": 11460614, "time": "2016-06-03T07:14:03Z"}, {"text": "Pushed by mhammond@skippinet.com.au:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/819915e031be\nChange the User-Agent header sent to Sync to include OS information. r=kitcambridge", "author": "pulsebot@bots.tld", "id": 11461714, "time": "2016-06-03T15:19:08Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/819915e031be", "author": "cbook@mozilla.com", "id": 11465470, "time": "2016-06-06T09:59:48Z"}], "id": 1273587, "priority": "P1", "mentors_detail": [], "cf_crash_signature": "", "version": "unspecified", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2016-06-06T09:59:48Z", "cf_platform_rel": "---", "product": "Firefox", "cf_status_firefox_esr52": "---", "blocks": [1241563], "qa_contact": "", "see_also": [], "cf_fx_iteration": "---", "component": "Sync", "votes": 0, "cf_status_firefox49": "fixed", "groups": [], "cf_status_firefox60": "---", "target_milestone": "Firefox 49", "is_cc_accessible": true, "url": "", "creator_detail": {"email": "dcoates@mozilla.com", "id": 468905, "name": "dcoates@mozilla.com", "real_name": "Danny Coates [:dcoates]"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "dcoates@mozilla.com", "id": 468905, "name": "dcoates@mozilla.com", "real_name": "Danny Coates [:dcoates]"}, {"email": "kit@mozilla.com", "id": 506322, "name": "kit@mozilla.com", "real_name": "Kit Cambridge (they/them) [:kitcambridge]"}, {"email": "markh@mozilla.com", "id": 16943, "name": "markh@mozilla.com", "real_name": "Mark Hammond [:markh]"}, {"email": "rfkelly@mozilla.com", "id": 424102, "name": "rfkelly@mozilla.com", "real_name": "Ryan Kelly [:rfkelly]"}, {"email": "whd@mozilla.com", "id": 415688, "name": "whd@mozilla.com", "real_name": "Wesley Dawson [:whd]"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [{"status": "+", "name": "firefox-backlog", "modification_date": "2016-05-17T22:57:08Z", "type_id": 846, "creation_date": "2016-05-17T22:57:08Z", "id": 1395680, "setter": "markh@mozilla.com"}], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "history": [{"changes": [{"removed": "--", "field_name": "priority", "added": "P1"}, {"removed": "", "field_name": "cc", "added": "markh@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "firefox-backlog+"}], "who": "markh@mozilla.com", "when": "2016-05-17T22:57:08Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "rfkelly@mozilla.com"}], "who": "rfkelly@mozilla.com", "when": "2016-05-17T23:24:43Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "whd@mozilla.com"}], "who": "rfkelly@mozilla.com", "when": "2016-05-17T23:36:48Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8758069, "added": "review?(kcambridge@mozilla.com)"}, {"removed": "", "field_name": "cc", "added": "kcambridge@mozilla.com"}], "who": "markh@mozilla.com", "when": "2016-05-30T23:28:44Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "dcoates@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(whd@mozilla.com), needinfo?(dcoates@mozilla.com)"}], "who": "markh@mozilla.com", "when": "2016-05-30T23:32:13Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "markh@mozilla.com"}], "who": "markh@mozilla.com", "when": "2016-05-30T23:32:25Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(kcambridge@mozilla.com)", "attachment_id": 8758069, "added": "review+"}], "who": "kit@mozilla.com", "when": "2016-05-31T18:23:11Z"}, {"changes": [{"removed": "needinfo?(dcoates@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "dcoates@mozilla.com", "when": "2016-05-31T18:33:40Z"}, {"changes": [{"removed": "needinfo?(whd@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "whd@mozilla.com", "when": "2016-06-03T07:14:03Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "Firefox 49"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2016-06-06 09:59:48"}, {"removed": "---", "field_name": "cf_status_firefox49", "added": "fixed"}], "who": "cbook@mozilla.com", "when": "2016-06-06T09:59:48Z"}]}