{"status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "classification": "Client Software", "creator": "intermittent-bug-filer@mozilla.bugs", "cc": ["andrei.br92@gmail.com", "edilee@mozilla.com", "kmaglione+bmo@mozilla.com", "usarracini@mozilla.com"], "depends_on": [1449223], "creation_time": "2018-04-22T08:50:32Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": ["intermittent-failure"], "summary": "Intermittent browser/extensions/activity-stream/test/functional/mochitest/browser_topsites_contextMenu_options.js | A promise chain failed to handle a rejection: cache is undefined - stack: maybeCacheScreenshot@resource://activity-stream/lib/Screenshots", "cf_last_resolved": "2018-04-27T18:50:54Z", "attachments": [{"creator": "pulgasaur@mozilla.bugs", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/x-github-pull-request", "id": 8970966}], "assigned_to_detail": {"email": "andrei.br92@gmail.com", "id": 476157, "name": "andrei.br92@gmail.com", "real_name": "Andrei Oprea [:andreio]"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 16, "comments": [{"text": "Filed by: nbeleuzu [at] mozilla.com\n\nhttps://treeherder.mozilla.org/logviewer.html#?job_id=174990516&repo=mozilla-inbound\n\nhttps://queue.taskcluster.net/v1/task/ER7w6s2xQVucfBOdhgKQ8A/runs/0/artifacts/public/logs/live_backing.log\n\nRelevant log info:\n\n23:37:59     INFO - TEST-INFO | started process screencapture\n23:37:59     INFO - TEST-INFO | screencapture: exit 0\n23:37:59     INFO - Buffered messages logged at 23:37:57\n23:37:59     INFO - Entering test bound defaultTopSites_menuOptions\n23:37:59     INFO - Buffered messages logged at 23:37:58\n23:37:59     INFO - Console message: [JavaScript Error: \"Problem getting stored prefs for TopSites\" {file: \"resource://activity-stream/lib/TopSitesFeed.jsm\" line: 182}]\n23:37:59     INFO - refresh@resource://activity-stream/lib/TopSitesFeed.jsm:182:7\n23:37:59     INFO - async*onAction@resource://activity-stream/lib/TopSitesFeed.jsm:398:9\n23:37:59     INFO - _middleware/</<@resource://activity-stream/lib/Store.jsm:51:11\n23:37:59     INFO - Store/this[method]@resource://activity-stream/lib/Store.jsm:29:55\n23:37:59     INFO - customDispatch/this.placesChangedTimer<@resource://activity-stream/lib/PlacesFeed.jsm:205:11\n23:37:59     INFO - \n23:37:59     INFO - Console message: [JavaScript Error: \"TypeError: cache is undefined\" {file: \"resource://activity-stream/lib/Screenshots.jsm\" line: 125}]\n23:37:59     INFO - Console message: [JavaScript Error: \"TypeError: cache is undefined\" {file: \"resource://activity-stream/lib/Screenshots.jsm\" line: 125}]\n23:37:59     INFO - Console message: [JavaScript Error: \"TypeError: cache is undefined\" {file: \"resource://activity-stream/lib/Screenshots.jsm\" line: 125}]\n23:37:59     INFO - Console message: [JavaScript Error: \"TypeError: cache is undefined\" {file: \"resource://activity-stream/lib/Screenshots.jsm\" line: 125}]\n23:37:59     INFO - Console message: [JavaScript Error: \"TypeError: cache is undefined\" {file: \"resource://activity-stream/lib/Screenshots.jsm\" line: 125}]\n23:37:59     INFO - Console message: [JavaScript Error: \"TypeError: cache is undefined\" {file: \"resource://activity-stream/lib/Screenshots.jsm\" line: 125}]\n23:37:59     INFO - TEST-PASS | browser/extensions/activity-stream/test/functional/mochitest/browser_topsites_contextMenu_options.js | Number of options is correct - 5 == 5 - \n23:37:59     INFO - TEST-PASS | browser/extensions/activity-stream/test/functional/mochitest/browser_topsites_contextMenu_options.js | Name option is correct - \"Pin\" == \"Pin\" - \n23:37:59     INFO - TEST-PASS | browser/extensions/activity-stream/test/functional/mochitest/browser_topsites_contextMenu_options.js | Name option is correct - \"Edit\" == \"Edit\" - \n23:37:59     INFO - TEST-PASS | browser/extensions/activity-stream/test/functional/mochitest/browser_topsites_contextMenu_options.js | Name option is correct - \"Open in a New Window\" == \"Open in a New Window\" - \n23:37:59     INFO - TEST-PASS | browser/extensions/activity-stream/test/functional/mochitest/browser_topsites_contextMenu_options.js | Name option is correct - \"Open in a New Private Window\" == \"Open in a New Private Window\" - \n23:37:59     INFO - TEST-PASS | browser/extensions/activity-stream/test/functional/mochitest/browser_topsites_contextMenu_options.js | Name option is correct - \"Dismiss\" == \"Dismiss\" - \n23:37:59     INFO - Buffered messages finished\n23:37:59     INFO - TEST-UNEXPECTED-FAIL | browser/extensions/activity-stream/test/functional/mochitest/browser_topsites_contextMenu_options.js | A promise chain failed to handle a rejection: cache is undefined - stack: maybeCacheScreenshot@resource://activity-stream/lib/Screenshots.jsm:125:1\n23:37:59     INFO - async*_fetchScreenshot@resource://activity-stream/lib/TopSitesFeed.jsm:226:11\n23:37:59     INFO - async*_fetchIcon@resource://activity-stream/lib/TopSitesFeed.jsm:214:11\n23:37:59     INFO - async*getLinksWithDefaults@resource://activity-stream/lib/TopSitesFeed.jsm:159:11\n23:37:59     INFO - async*refresh@resource://activity-stream/lib/TopSitesFeed.jsm:175:25\n23:37:59     INFO - async*onAction@resource://activity-stream/lib/TopSitesFeed.jsm:398:9\n23:37:59     INFO - _middleware/</<@resource://activity-stream/lib/Store.jsm:51:11\n23:37:59     INFO - Store/this[method]@resource://activity-stream/lib/Store.jsm:29:55\n23:37:59     INFO - customDispatch/this.placesChangedTimer<@resource://activity-stream/lib/PlacesFeed.jsm:205:11\n23:37:59     INFO - Rejection date: Sat Apr 21 2018 23:37:58 GMT-0700 (PDT) - false == true - JS frame :: resource://testing-common/PromiseTestUtils.jsm :: assertNoUncaughtRejections :: line 257\n23:37:59     INFO - Stack trace:\n23:37:59     INFO - resource://testing-common/PromiseTestUtils.jsm:assertNoUncaughtRejections:257\n23:37:59     INFO - chrome://mochikit/content/browser-test.js:Tester_execTest/<:1103\n23:37:59     INFO - Not taking screenshot here: see the one that was previously logged\n23:37:59     INFO - TEST-UNEXPECTED-FAIL | browser/extensions/activity-stream/test/functional/mochitest/browser_topsites_contextMenu_options.js | A promise chain failed to handle a rejection: cache is undefined - stack: maybeCacheScreenshot@resource://activity-stream/lib/Screenshots.jsm:125:1\n23:37:59     INFO - async*_fetchScreenshot@resource://activity-stream/lib/TopSitesFeed.jsm:226:11\n23:37:59     INFO - async*_fetchIcon@resource://activity-stream/lib/TopSitesFeed.jsm:214:11\n23:37:59     INFO - async*getLinksWithDefaults@resource://activity-stream/lib/TopSitesFeed.jsm:159:11\n23:37:59     INFO - async*refresh@resource://activity-stream/lib/TopSitesFeed.jsm:175:25\n23:37:59     INFO - async*onAction@resource://activity-stream/lib/TopSitesFeed.jsm:398:9\n23:37:59     INFO - _middleware/</<@resource://activity-stream/lib/Store.jsm:51:11\n23:37:59     INFO - Store/this[method]@resource://activity-stream/lib/Store.jsm:29:55\n23:37:59     INFO - customDispatch/this.placesChangedTimer<@resource://activity-stream/lib/PlacesFeed.jsm:205:11\n23:37:59     INFO - Rejection date: Sat Apr 21 2018 23:37:58 GMT-0700 (PDT) - false == true - JS frame :: resource://testing-common/PromiseTestUtils.jsm :: assertNoUncaughtRejections :: line 257\n23:37:59     INFO - Stack trace:\n23:37:59     INFO - resource://testing-common/PromiseTestUtils.jsm:assertNoUncaughtRejections:257\n23:37:59     INFO - chrome://mochikit/content/browser-test.js:Tester_execTest/<:1103\n23:37:59     INFO - Not taking screenshot here: see the one that was previously logged", "author": "intermittent-bug-filer@mozilla.bugs", "id": 13223945, "time": "2018-04-22T08:50:32Z"}, {"text": "5 failures in 782 pushes (0.006 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* mozilla-inbound: 2\n* autoland: 2\n* try: 1\n\nPlatform breakdown:\n* osx-10-10: 5\n\nFor more details, see:\nhttps://treeherder.mozilla.org/intermittent-failures.html#/bugdetails?bug=1455931&startday=2018-04-16&endday=2018-04-22&tree=trunk", "author": "orangefactor@bots.tld", "id": 13225604, "time": "2018-04-23T01:35:41Z"}, {"text": "Hi! I did some retriggers to find where this started and worked on this range: http://tinyurl.com/yb4s53lr\n\nIt seems the push that started this fail is this one http://tinyurl.com/ybpa7laf and has at least two follow-ups. It fails around 2 times from 20 jobs.\nKris, could you take a look at this? Thank you", "author": "csabou@mozilla.com", "id": 13231614, "time": "2018-04-25T02:45:51Z"}, {"text": "I can't see any reason those changes should affect activity stream. My best guess is that it's relying on callback timing that isn't guaranteed, but I don't know that code nearly well enough to say for sure.", "author": "kmaglione+bmo@mozilla.com", "id": 13231621, "time": "2018-04-25T02:55:20Z"}, {"text": "(In reply to Treeherder Bug Filer from comment #0)\n> 23:37:59     INFO - Console message: [JavaScript Error: \"Problem getting\n> stored prefs for TopSites\" {file:\n> \"resource://activity-stream/lib/TopSitesFeed.jsm\" line: 182}]\nThis first error is from the recently added indexeddb storage. andreio, any ideas?", "author": "edilee@mozilla.com", "id": 13231674, "time": "2018-04-25T04:25:32Z"}, {"text": "The indexedDB error should be irrelevant that's just a logging message (we expect it to fail sometimes) and it should continue to run anyway. The failure seems to be related to screenshots, although there are only default topsites (which already have icons) in the screenshot. I'll look into it.", "author": "andrei.br92@gmail.com", "id": 13232143, "time": "2018-04-25T10:27:30Z"}, {"text": "Running this locally I see a completely different stack trace which oddly enough contains the same variable name `cache`\n\n0:16.42 INFO Console message: [JavaScript Error: \"cache is null\" {file: \"resource://gre/modules/NewTabUtils.jsm\" line: 1673}]\n_adjustSiteMapAndNotify@resource://gre/modules/NewTabUtils.jsm:1673:1\nonLinkBlocked@resource://gre/modules/NewTabUtils.jsm:1685:5\n_callObservers@resource://gre/modules/NewTabUtils.jsm:515:27\nBlockedLinks_block@resource://gre/modules/NewTabUtils.jsm:461:5\nblockURL@resource://gre/modules/NewTabUtils.jsm:1262:5\nonAction@resource://activity-stream/lib/PlacesFeed.jsm:294:9\n_middleware/</<@resource://activity-stream/lib/Store.jsm:51:11\nStore/this[method]@resource://activity-stream/lib/Store.jsm:29:55\nonActionFromContent@resource://activity-stream/lib/ActivityStreamMessageChannel.jsm:87:5\nonMessage@resource://activity-stream/lib/ActivityStreamMessageChannel.jsm:275:5\ncallListeners@resource://gre/modules/RemotePageManager.jsm:33:9\nportMessageReceived@resource://gre/modules/RemotePageManager.jsm:123:5\ncallListeners@resource://gre/modules/RemotePageManager.jsm:33:9\nChromeMessagePort.prototype.message@resource://gre/modules/RemotePageManager.jsm:381:3\nMessageListener.receiveMessage*MessagePort@resource://gre/modules/RemotePageManager.jsm:235:3\nChromeMessagePort@resource://gre/modules/RemotePageManager.jsm:312:3\ninitPort@resource://gre/modules/RemotePageManager.jsm:527:16\nMessageListener.receiveMessage*init@resource://gre/modules/RemotePageManager.jsm:478:5\n@resource://gre/modules/RemotePageManager.jsm:533:3\n@chrome://global/content/process-content.js:10:1\nobserve@file:///mozilla-central/objdir-frontend/dist/Nightly.app/Contents/Resources/components/MainProcessSingleton.js:72:7", "author": "andrei.br92@gmail.com", "id": 13232170, "time": "2018-04-25T10:59:32Z"}, {"text": "That error, \"cache is null\" is from legacy NewTabUtils code and shouldn't be affecting activity stream stuff. It was a cache for the old tiles, not our cache. When we get rid of old NewTabUtils stuff for tiles, that error will go away. Unlikely that it's the cause of this failure (we even see that error while dismissing a top site in regular browser usage)", "author": "usarracini@mozilla.com", "id": 13232410, "time": "2018-04-25T13:31:23Z"}, {"text": "Triggered the failure on try with a little bit of logging. We're trying to take screenshots of default sites which are not LinkCache objects.\n\n06:52:31     INFO - GECKO(2033) | console.log: \"Getting screenshot for\" \"https://www.youtube.com/\"\n06:52:31     INFO - GECKO(2033) | console.log: \"Getting screenshot for\" \"https://www.facebook.com/\"\n06:52:31     INFO - GECKO(2033) | console.log: \"Getting screenshot for\" \"https://www.amazon.com/\"\n06:52:31     INFO - GECKO(2033) | console.log: \"Getting screenshot for\" \"https://www.reddit.com/\"\n06:52:31     INFO - GECKO(2033) | console.log: \"Getting screenshot for\" \"https://www.wikipedia.org/\"\n06:52:31     INFO - GECKO(2033) | console.log: \"Getting screenshot for\" \"https://twitter.com/\"\n06:52:31     INFO - GECKO(2033) | JavaScript error: resource://activity-stream/lib/Screenshots.jsm, line 126: TypeError: cache is undefined\n06:52:31     INFO - GECKO(2033) | JavaScript error: resource://activity-stream/lib/Screenshots.jsm, line 126: TypeError: cache is undefined\n06:52:31     INFO - GECKO(2033) | JavaScript error: resource://activity-stream/lib/Screenshots.jsm, line 126: TypeError: cache is undefined\n06:52:31     INFO - GECKO(2033) | JavaScript error: resource://activity-stream/lib/Screenshots.jsm, line 126: TypeError: cache is undefined\n06:52:31     INFO - GECKO(2033) | JavaScript error: resource://activity-stream/lib/Screenshots.jsm, line 126: TypeError: cache is undefined\n06:52:31     INFO - GECKO(2033) | JavaScript error: resource://activity-stream/lib/Screenshots.jsm, line 126: TypeError: cache is undefined\n\nhttps://treeherder.mozilla.org/logviewer.html#?job_id=175531672&repo=try&lineNumber=12019-12030", "author": "andrei.br92@gmail.com", "id": 13232701, "time": "2018-04-25T15:15:28Z"}, {"text": "I would guess that some action is triggering a top sites refresh before TippyTopProvider.jsm is done initializing. The stack seems to point to PLACES_LINKS_CHANGED.\n\nSo something in places is changing while activity stream is starting up?", "author": "edilee@mozilla.com", "id": 13232761, "time": "2018-04-25T15:29:51Z"}, {"text": "Sounds like this could have regressed with bug 1449223 no longer awaiting for tippy top to be initialized:\nhttps://github.com/mozilla/activity-stream/pull/4060/files#diff-3c9ab687b10408604222f1cb5b298d0eL168", "author": "edilee@mozilla.com", "id": 13232817, "time": "2018-04-25T15:42:47Z"}, {"text": "Created attachment 8970966\nLink to GitHub pull-request: https://github.com/mozilla/activity-stream/pull/4124", "author": "pulgasaur@mozilla.bugs", "id": 13233166, "time": "2018-04-25T17:42:23Z"}, {"text": "Commit pushed to master at https://github.com/mozilla/activity-stream\n\nhttps://github.com/mozilla/activity-stream/commit/9a5e4d28dfba6a603d5b0f2210097a03c2973481\nfix(topsites): Restore refresh waiting for tippytop provider to initialize (#4124)\n\nFix Bug 1455931 - Intermittent browser/extensions/activity-stream/test/functional/mochitest/browser_topsites_contextMenu_options.js | A promise chain failed to handle a rejection: cache is undefined - stack: maybeCacheScreenshot@resource://activity-stream/lib/Screenshots", "author": "mozilla+bugcloser@davedash.com", "id": 13235722, "time": "2018-04-26T15:33:04Z"}, {"text": "Keeping open until the fix lands in m-c, so it can still be starred", "author": "edilee@mozilla.com", "id": 13235734, "time": "2018-04-26T15:36:02Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/9edd64fc07d3", "author": "edilee@mozilla.com", "id": 13238911, "time": "2018-04-27T18:50:37Z"}, {"text": "33 failures in 780 pushes (0.042 failures/push) were associated with this bug in the last 7 days.   \n\n** This failure happened more than 30 times this week! Resolving this bug is a high priority. **\n\n** Try to resolve this bug as soon as possible. If unresolved for 2 weeks, the affected test(s) may be disabled. **  \n\nRepository breakdown:\n* mozilla-inbound: 16\n* autoland: 15\n* mozilla-central: 1\n* mozilla-beta: 1\n\nPlatform breakdown:\n* osx-10-10: 32\n* windows10-64: 1\n\nFor more details, see:\nhttps://treeherder.mozilla.org/intermittent-failures.html#/bugdetails?bug=1455931&startday=2018-04-23&endday=2018-04-29&tree=trunk", "author": "orangefactor@bots.tld", "id": 13241833, "time": "2018-04-30T01:36:42Z"}], "id": 1455931, "priority": "P5", "mentors_detail": [], "cf_crash_signature": "", "version": "unspecified", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox62": "---", "cf_platform_rel": "---", "product": "Firefox", "cf_status_firefox_esr52": "---", "blocks": [1457192], "qa_contact": "", "see_also": [], "cf_fx_iteration": "61.4 - May 7", "component": "Activity Streams: Newtab", "votes": 0, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "fixed", "cf_status_firefox60": "---", "target_milestone": "Firefox 61", "is_cc_accessible": true, "cf_rank": null, "groups": [], "url": "", "creator_detail": {"email": "intermittent-bug-filer@mozilla.bugs", "id": 573381, "name": "intermittent-bug-filer@mozilla.bugs", "real_name": "Treeherder Bug Filer"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "andrei.br92@gmail.com", "id": 476157, "name": "andrei.br92@gmail.com", "real_name": "Andrei Oprea [:andreio]"}, {"email": "edilee@mozilla.com", "id": 125983, "name": "edilee@mozilla.com", "real_name": "Ed Lee :Mardak"}, {"email": "kmaglione+bmo@mozilla.com", "id": 106098, "name": "kmaglione+bmo@mozilla.com", "real_name": "Kris Maglione [:kmag]"}, {"email": "usarracini@mozilla.com", "id": 539482, "name": "usarracini@mozilla.com", "real_name": "Ursula Sarracini (:ursula)"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-04-30T01:36:42Z", "cf_status_firefox_esr60": "---", "assigned_to": "andrei.br92@gmail.com", "is_open": false, "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "kmaglione+bmo@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(kmaglione+bmo@mozilla.com)"}], "who": "csabou@mozilla.com", "when": "2018-04-25T02:45:51Z"}, {"changes": [{"removed": "needinfo?(kmaglione+bmo@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "kmaglione+bmo@mozilla.com", "when": "2018-04-25T02:55:20Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "andrei.br92@gmail.com, edilee@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(andrei.br92@gmail.com)"}], "who": "edilee@mozilla.com", "when": "2018-04-25T04:25:32Z"}, {"changes": [{"removed": "needinfo?(andrei.br92@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "andrei.br92@gmail.com", "when": "2018-04-25T10:27:30Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "usarracini@mozilla.com"}], "who": "usarracini@mozilla.com", "when": "2018-04-25T13:31:23Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1449223"}], "who": "edilee@mozilla.com", "when": "2018-04-25T15:42:47Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-04-26 15:33:05"}], "who": "mozilla+bugcloser@davedash.com", "when": "2018-04-26T15:33:05Z"}, {"changes": [{"removed": "RESOLVED", "field_name": "status", "added": "REOPENED"}, {"removed": "FIXED", "field_name": "resolution", "added": ""}], "who": "edilee@mozilla.com", "when": "2018-04-26T15:36:02Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1457192"}], "who": "edilee@mozilla.com", "when": "2018-04-26T15:44:06Z"}, {"changes": [{"removed": "---", "field_name": "cf_fx_iteration", "added": "61.4 - May 7"}, {"removed": "---", "field_name": "target_milestone", "added": "Firefox 61"}, {"removed": "---", "field_name": "cf_status_firefox61", "added": "fixed"}], "who": "edilee@mozilla.com", "when": "2018-04-27T18:50:37Z"}, {"changes": [{"removed": "REOPENED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "2018-04-26 15:33:05", "field_name": "cf_last_resolved", "added": "2018-04-27 18:50:54"}], "who": "edilee@mozilla.com", "when": "2018-04-27T18:50:54Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "andrei.br92@gmail.com"}], "who": "edilee@mozilla.com", "when": "2018-04-27T18:51:19Z"}]}