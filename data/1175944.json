{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "ferjmoreno@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2015-07-03T15:15:53Z", "type_id": 4, "creation_date": "2015-07-03T12:48:55Z", "id": 1201669, "setter": "josh@joshmatthews.net"}], "content_type": "text/plain", "id": 8629345}], "classification": "Components", "creator": "aleh.zasypkin@gmail.com", "cc": ["angelesoteo@gmail.com", "bzbarsky@mit.edu", "ehsan@mozilla.com", "ferjmoreno@gmail.com", "hsivonen@hsivonen.fi", "josh@joshmatthews.net", "noemi.freiredecarlos@telefonica.com"], "depends_on": [1174078], "creation_time": "2015-06-18T15:33:56Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "Packaged app's (app://) JS files are not loaded and do not trigger \"onfetch\" handler", "id": 1175944, "assigned_to_detail": {"email": "ferjmoreno@gmail.com", "id": 427036, "name": "ferjmoreno@gmail.com", "real_name": "Fernando Jim\u00e9nez Moreno [:ferjm]"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "assigned_to": "ferjmoreno@gmail.com", "comment_count": 22, "comments": [{"text": "STR:\n\n1. Install [1] as preinstalled app (to workaround bug 1173539);\n2. Run it and make sure that service worker is registered;\n3. Kill app with Task Manager and run again;\n4. Observe log - there is no fetch requests for any of the app's JS files; CSS and HTML files triggered \"onfetch\" handler and loaded successfully.\n5. Side effect is that app's background is yellow, but should be green (color is changed by script that is not loaded).\n\nI don't see this issue if I run app in B2G browser via https [2];\n\nFlame PVT mc Engineering Build:\n\nBuild Identifier: 20150618010201\nGaia git commit Info: 2015-06-18 14:31:48, bd681cee\nGecko hg commit info: a3f280b6f8d5\n\n[1] https://github.com/azasypkin/sw-tests/tree/master/fxos-app\n[2] http://azasypkin.github.io/sw-tests/fxos-app/", "author": "aleh.zasypkin@gmail.com", "id": 10405050, "time": "2015-06-18T15:33:56Z"}, {"text": "I tried to debug this issue but I get to a point where I am pretty blocked.\n\nWhat I found out is that we are doing the interception of the index.html file and we are properly serving the content of this file from the service worker, but for some reason, the HTML5 parser doesn't load the app.js file.\n\nWhen we *do not* serve the index.html from the service worker, I can see that we do two calls to nsScriptElement::MaybeProcessScript [1]. The first time the mDoneAddingChildren flag is false, so we bail out at [2]. The second call, that flag is true, so we progress with the processing of the script.\n\nWhen we serve the index.thml from the service worker, we only make the first call to nsScriptElement::MaybeProcessScript while the mDoneAddingChildren flag is still false. For some reason, the parser doesn't retry to process the script.\n\nHenri, I am running out of ideas here. Can you think of any reason why we aren't able to process the JS file in this case?\n\nThanks in advance for any help!\n\n[1] https://mxr.mozilla.org/mozilla-central/source/dom/base/nsScriptElement.cpp#110\n[2] https://mxr.mozilla.org/mozilla-central/source/dom/base/nsScriptElement.cpp#120", "author": "ferjmoreno@gmail.com", "id": 10426525, "time": "2015-06-26T20:58:10Z"}, {"text": "Maybe Ehsan can also understand what's going on here. Thanks!", "author": "ferjmoreno@gmail.com", "id": 10427998, "time": "2015-06-27T16:45:40Z"}, {"text": "Unfortunately I'm not very familiar with our speculative parsing code.  Boris may know the script element side of things...", "author": "ehsan@mozilla.com", "id": 10428081, "time": "2015-06-27T19:42:22Z"}, {"text": "One thing you may want to check for is to see if loading each of the two scripts individually in a top-level browsing context works.  Also, if there is a way to test the app inside an \"app context\" but through http(s), it would be nice to know if the same issue happens there (to see if the nsJARChannel level interception code is at fault here.)\n\nFWIW, the scripts in https://dxr.mozilla.org/mozilla-central/source/dom/workers/test/serviceworkers/app-protocol/controlled.html load just fine.  I can't think of a fundamental difference between that test and comment 0 though.", "author": "ehsan@mozilla.com", "id": 10428082, "time": "2015-06-27T19:45:55Z"}, {"text": "(In reply to Ehsan Akhgari (not reviewing patches, not reading bugmail, needinfo? me!) from comment #4)\n> FWIW, the scripts in\n> https://dxr.mozilla.org/mozilla-central/source/dom/workers/test/\n> serviceworkers/app-protocol/controlled.html load just fine.  I can't think\n> of a fundamental difference between that test and comment 0 though.\n\nThank you Ehsan. The difference between that mochitest and the test case from comment 0 is that on the mochitest controller.html is served directly from the network while on the test case index.html is being served from a service worker initiated fetch [1].\n\n[1] https://github.com/azasypkin/sw-tests/blob/master/fxos-app/sw.js#L9", "author": "ferjmoreno@gmail.com", "id": 10428123, "time": "2015-06-27T21:33:46Z"}, {"text": "FWIW everything works removing this line https://github.com/azasypkin/sw-tests/blob/master/fxos-app/sw.js#L9", "author": "ferjmoreno@gmail.com", "id": 10428124, "time": "2015-06-27T21:34:26Z"}, {"text": "Is there a testcase that reproduces the bug in a desktop Firefox with service workers enabled?  That would make this a lot easier to debug...", "author": "bzbarsky@mit.edu", "id": 10433936, "time": "2015-06-30T04:18:32Z"}, {"text": "(In reply to Boris Zbarsky [:bz] from comment #7)\n> Is there a testcase that reproduces the bug in a desktop Firefox with\n> service workers enabled?  That would make this a lot easier to debug...\n\nI am afraid that that's not possible :( This can only be reproduced with packaged apps. Installing a packaged app on desktop will make it use the WebappRT.\n\nI can debug on b2g if you could give me any pointers about where should I be looking at.\n\nThanks!", "author": "ferjmoreno@gmail.com", "id": 10440649, "time": "2015-07-01T15:01:01Z"}, {"text": "OK.  Well, it sounds like you're getting the <script> inserted into the DOM (that first MaybeProcessScript call) but are never getting nsIScriptElement::AttemptToExecute called?\n\nIf that's correct, can you check whether you even end up in nsHtml5TreeOpExecutor::RunScript?  If not, we can start worrying about that...", "author": "bzbarsky@mit.edu", "id": 10440862, "time": "2015-07-01T15:48:42Z"}, {"text": "No, after serving the index.html file from the service worker we don't get to any of these function calls, nsIScriptElement::AttemptToExecute or nsHtml5TreeOpExecutor::RunScript", "author": "ferjmoreno@gmail.com", "id": 10447245, "time": "2015-07-02T18:54:06Z"}, {"text": "OK.  Do you land in nsHtml5TreeBuilder::elementPopped with aName == nsHtml5Atoms::script?  That is, the block at http://hg.mozilla.org/mozilla-central/file/0b901209064c/parser/html/nsHtml5TreeBuilderCppSupplement.h#l800\n\nIf you do, do you reach the InitScript call at the end of that block?  Or do you take one of the early returns?  If one of the early returns is taken, which one?", "author": "bzbarsky@mit.edu", "id": 10447378, "time": "2015-07-02T19:23:30Z"}, {"text": "Created attachment 8629345\nv1\n\nThank you Boris!\n\nWe were early returning at [1] because of [2]. We weren't setting the safe flag for synthesized JAR responses.\n\n[1] https://mxr.mozilla.org/mozilla-central/source/parser/html/nsHtml5TreeBuilderCppSupplement.h#811\n[2] https://mxr.mozilla.org/mozilla-central/source/dom/base/nsGlobalWindow.cpp#2691", "author": "ferjmoreno@gmail.com", "id": 10453678, "time": "2015-07-03T12:48:55Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/09e9d33f1186", "author": "pulsebot@bots.tld", "id": 10454399, "time": "2015-07-03T16:41:55Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/09e9d33f1186", "author": "philringnalda@gmail.com", "id": 10455410, "time": "2015-07-04T01:50:16Z"}, {"text": "Shouldn't we set mIsUnsafe to false only if aContentType is on our list of jar content types (or whatever the normal conditions for setting it to false are)?", "author": "bzbarsky@mit.edu", "id": 10455478, "time": "2015-07-04T02:44:43Z"}, {"text": "It's always marked as safe if the content comes from a local JAR file rather than a remote download, so I assumed that intercepting local content and replacing it with something else would treated the same.", "author": "josh@joshmatthews.net", "id": 10457178, "time": "2015-07-05T19:52:53Z"}, {"text": "OK.  And this intercept code is known to only run for local content?\n\nPut another way, this code could use a nice comment explaining why it's safe.", "author": "bzbarsky@mit.edu", "id": 10457701, "time": "2015-07-06T05:56:47Z"}, {"text": "Hi,\n\nchecked with today's (7/6) master build. Following the steps described in comment 0, there are currently fetch events received (side effect: the app's background is green). Please see below the corresponding traces:\n\nI/fxos-app( 4070): Content JS LOG: Fetch event received app://fxos-app.gaiamobile.org/index.html \nI/fxos-app( 4070):     at <anonymous> (app://fxos-app.gaiamobile.org/sw.js:7:3)\nI/fxos-app( 4070): Content JS LOG: Fetch event received app://fxos-app.gaiamobile.org/css/app.css \nI/fxos-app( 4070):     at <anonymous> (app://fxos-app.gaiamobile.org/sw.js:7:3)\nI/fxos-app( 4070): Content JS LOG: Fetch event received app://fxos-app.gaiamobile.org/js/one-more-js-file.js \nI/fxos-app( 4070):     at <anonymous> (app://fxos-app.gaiamobile.org/sw.js:7:3)\nI/fxos-app( 4070): Content JS LOG: Fetch event received app://fxos-app.gaiamobile.org/js/app.js \nI/fxos-app( 4070):     at <anonymous> (app://fxos-app.gaiamobile.org/sw.js:7:3)\nI/fxos-app( 4070): Content JS LOG: One-More-JS-File-Parsed \nI/fxos-app( 4070):     at <anonymous> (app://fxos-app.gaiamobile.org/js/one-more-js-file.js:1:1)\nI/fxos-app( 4070): Content JS LOG: Startup-File-Parsed \nI/fxos-app( 4070):     at <anonymous> (app://fxos-app.gaiamobile.org/js/app.js:1:1)\nI/fxos-app( 4070): Content JS LOG: Registration succeeded. Scope is app://fxos-app.gaiamobile.org/ \nI/fxos-app( 4070):     at initServiceWorker/< (app://fxos-app.gaiamobile.org/js/app.js:5:5)\n\n\nEnvironmental variables:\nFlame device\nBuild Id: 20150706080959\nGecko: 4d5dc30\nGaia: dc6c18c\nPlatform version: 42.0a1", "author": "noemi.freiredecarlos@telefonica.com", "id": 10458034, "time": "2015-07-06T08:16:43Z"}, {"text": "Jonas, can app URLs ever be used for content which must be downloaded from a remote source?", "author": "josh@joshmatthews.net", "id": 10458570, "time": "2015-07-06T12:14:10Z"}, {"text": "(In reply to Josh Matthews [:jdm] from comment #19)\n> Jonas, can app URLs ever be used for content which must be downloaded from a\n> remote source?\n\nAFAIK they can't.", "author": "ferjmoreno@gmail.com", "id": 10459589, "time": "2015-07-06T16:10:18Z"}, {"text": "No.\n\nI mean, the content was downloaded at some point. But then we saved it locally, so at the time that the app:// URL is loaded the content is either available locally or the load will fail.", "author": "jonas@sicking.cc", "id": 10524592, "time": "2015-07-22T15:23:06Z"}], "cf_last_resolved": "2015-07-04T01:50:16Z", "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "unspecified", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2015-07-22T15:23:06Z", "cf_platform_rel": "---", "product": "Core", "cf_status_firefox_esr52": "---", "blocks": [1131322, 1153312, 1172902], "qa_contact": "", "see_also": ["https://bugzilla.mozilla.org/show_bug.cgi?id=1175949"], "cf_fx_iteration": "---", "component": "DOM: Service Workers", "votes": 0, "groups": [], "cf_status_firefox60": "---", "cf_status_firefox42": "fixed", "target_milestone": "FxOS-S2 (10Jul)", "is_cc_accessible": true, "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "aleh.zasypkin@gmail.com", "id": 495401, "name": "aleh.zasypkin@gmail.com", "real_name": "Oleg Zasypkin [:azasypkin][\u23f0UTC+1]"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "angelesoteo@gmail.com", "id": 434278, "name": "angelesoteo@gmail.com", "real_name": "Maria Angeles Oteo (:oteo)"}, {"email": "bzbarsky@mit.edu", "id": 20209, "name": "bzbarsky@mit.edu", "real_name": "Boris Zbarsky [:bz] (no decent commit message means r-)"}, {"email": "ehsan@mozilla.com", "id": 251051, "name": "ehsan@mozilla.com", "real_name": ":Ehsan Akhgari"}, {"email": "ferjmoreno@gmail.com", "id": 427036, "name": "ferjmoreno@gmail.com", "real_name": "Fernando Jim\u00e9nez Moreno [:ferjm]"}, {"email": "hsivonen@hsivonen.fi", "id": 5490, "name": "hsivonen@hsivonen.fi", "real_name": "Henri Sivonen (:hsivonen)"}, {"email": "josh@joshmatthews.net", "id": 241497, "name": "josh@joshmatthews.net", "real_name": "Josh Matthews [:jdm]"}, {"email": "noemi.freiredecarlos@telefonica.com", "id": 469924, "name": "noemi.freiredecarlos@telefonica.com", "real_name": "Noem\u00ed Freire (:noemi)"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "noemi.freiredecarlos@telefonica.com"}], "who": "noemi.freiredecarlos@telefonica.com", "when": "2015-06-18T15:36:31Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1175949"}], "who": "aleh.zasypkin@gmail.com", "when": "2015-06-18T15:43:29Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1153312"}], "who": "noemi.freiredecarlos@telefonica.com", "when": "2015-06-18T15:56:40Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "oteo@tid.es"}], "who": "angelesoteo@gmail.com", "when": "2015-06-18T20:09:13Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1131322"}], "who": "noemi.freiredecarlos@telefonica.com", "when": "2015-06-18T20:45:18Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "hsivonen@hsivonen.fi"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(hsivonen@hsivonen.fi)"}], "who": "ferjmoreno@gmail.com", "when": "2015-06-26T20:58:10Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "ehsan@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(ehsan@mozilla.com)"}], "who": "ferjmoreno@gmail.com", "when": "2015-06-27T16:45:40Z"}, {"changes": [{"removed": "needinfo?(ehsan@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "ehsan@mozilla.com", "when": "2015-06-27T19:42:22Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "bzbarsky@mit.edu"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(bzbarsky@mit.edu)"}], "who": "ehsan@mozilla.com", "when": "2015-06-27T19:46:14Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "ferjmoreno@gmail.com"}, {"removed": "---", "field_name": "target_milestone", "added": "FxOS-S2 (10Jul)"}], "who": "ferjmoreno@gmail.com", "when": "2015-06-29T09:55:43Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "ASSIGNED"}], "who": "noemi.freiredecarlos@telefonica.com", "when": "2015-06-29T11:53:47Z"}, {"changes": [{"removed": "needinfo?(bzbarsky@mit.edu)", "field_name": "flagtypes.name", "added": ""}], "who": "bzbarsky@mit.edu", "when": "2015-06-30T04:18:32Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(bzbarsky@mit.edu)"}], "who": "ferjmoreno@gmail.com", "when": "2015-07-01T15:01:01Z"}, {"changes": [{"removed": "needinfo?(bzbarsky@mit.edu)", "field_name": "flagtypes.name", "added": ""}], "who": "bzbarsky@mit.edu", "when": "2015-07-01T15:48:42Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "josh@joshmatthews.net"}], "who": "josh@joshmatthews.net", "when": "2015-07-01T16:32:01Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(bzbarsky@mit.edu)"}], "who": "ferjmoreno@gmail.com", "when": "2015-07-02T18:54:06Z"}, {"changes": [{"removed": "needinfo?(bzbarsky@mit.edu)", "field_name": "flagtypes.name", "added": ""}], "who": "bzbarsky@mit.edu", "when": "2015-07-02T19:23:30Z"}, {"changes": [{"removed": "needinfo?(hsivonen@hsivonen.fi)", "field_name": "flagtypes.name", "added": ""}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8629345, "added": "review?(josh@joshmatthews.net)"}], "who": "ferjmoreno@gmail.com", "when": "2015-07-03T12:48:55Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(josh@joshmatthews.net)", "attachment_id": 8629345, "added": "review+"}], "who": "josh@joshmatthews.net", "when": "2015-07-03T15:15:53Z"}, {"changes": [{"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2015-07-03 18:50:16"}, {"removed": "---", "field_name": "cf_status_firefox42", "added": "fixed"}], "who": "philringnalda@gmail.com", "when": "2015-07-04T01:50:16Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "jonas@sicking.cc"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(jonas@sicking.cc)"}], "who": "josh@joshmatthews.net", "when": "2015-07-06T12:14:10Z"}, {"changes": [{"removed": "jonas@sicking.cc", "field_name": "cc", "added": ""}, {"removed": "needinfo?(jonas@sicking.cc)", "field_name": "flagtypes.name", "added": ""}], "who": "jonas@sicking.cc", "when": "2015-07-22T15:23:06Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}