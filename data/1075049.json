{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "tbsaunde+mozbugs@tbsaunde.org", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2014-10-02T15:31:34Z", "type_id": 4, "creation_date": "2014-10-01T14:39:43Z", "id": 992867, "setter": "mshal@mozilla.com"}, {"status": "+", "name": "review", "modification_date": "2014-10-10T00:48:29Z", "type_id": 4, "creation_date": "2014-10-09T18:51:15Z", "id": 1000630, "setter": "dholbert@mozilla.com"}], "content_type": "text/plain", "id": 8498183}], "classification": "Components", "creator": "dholbert@mozilla.com", "cc": ["dholbert@mozilla.com", "mshal@mozilla.com", "octoploid@yandex.com", "tbsaunde+mozbugs@tbsaunde.org"], "depends_on": [], "creation_time": "2014-09-30T18:07:06Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "All", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "Builds with \"ac_add_options --disable-accessibility\" are broken, with \"AttributeError: 'NoneType' object has no attribute 'filetype'\", due to PContent.ipdl including PDocAccessible", "id": 1075049, "assigned_to_detail": {"email": "tbsaunde+mozbugs@tbsaunde.org", "id": 401086, "name": "tbsaunde+mozbugs@tbsaunde.org", "real_name": "Trevor Saunders (:tbsaunde)"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "assigned_to": "tbsaunde+mozbugs@tbsaunde.org", "comment_count": 12, "comments": [{"text": "STR:\n Try to build with this in your .mozconfig:\nac_add_options --disable-accessibility\n\n\nACTUAL RESULTS:\n{\n 0:04.94   in file included from `/scratch/work/builds/mozilla-inbound/mozilla/content/media/gmp/PGMP.ipdl', line 8:\n 0:04.95   in file included from `/scratch/work/builds/mozilla-inbound/mozilla/dom/ipc/PCrashReporter.ipdl', line 7:\n 0:04.95 /scratch/work/builds/mozilla-inbound/mozilla/dom/ipc/PContent.ipdl:16: error: can't locate include file `PDocAccessible.ipdl'\n 0:05.25 Traceback (most recent call last):\n 0:05.25   File \"/scratch/work/builds/mozilla-inbound/mozilla/config/pythonpath.py\", line 56, in <module>\n 0:05.25     main(sys.argv[1:])\n 0:05.25   File \"/scratch/work/builds/mozilla-inbound/mozilla/config/pythonpath.py\", line 48, in main\n 0:05.25     execfile(script, frozenglobals)\n 0:05.25   File \"/scratch/work/builds/mozilla-inbound/mozilla/ipc/ipdl/ipdl.py\", line 132, in <module>\n 0:05.25     if not ipdl.typecheck(ast):\n 0:05.25   File \"/scratch/work/builds/mozilla-inbound/mozilla/ipc/ipdl/ipdl/__init__.py\", line 35, in typecheck\n 0:05.25     return TypeCheck().check(ast, errout)\n 0:05.25   File \"/scratch/work/builds/mozilla-inbound/mozilla/ipc/ipdl/ipdl/type.py\", line 600, in check\n 0:05.25     if not runpass(GatherDecls(builtinUsing, self.errors)):\n 0:05.25   File \"/scratch/work/builds/mozilla-inbound/mozilla/ipc/ipdl/ipdl/type.py\", line 592, in runpass\n 0:05.25     tu.accept(tcheckpass)\n 0:05.25   File \"/scratch/work/builds/mozilla-inbound/mozilla/ipc/ipdl/ipdl/ast.py\", line 135, in accept\n 0:05.25     return visit(self)\n 0:05.25   File \"/scratch/work/builds/mozilla-inbound/mozilla/ipc/ipdl/ipdl/type.py\", line 698, in visitTranslationUnit\n 0:05.25     pinc.accept(self)\n 0:05.25   File \"/scratch/work/builds/mozilla-inbound/mozilla/ipc/ipdl/ipdl/ast.py\", line 135, in accept\n 0:05.25     return visit(self)\n 0:05.25   File \"/scratch/work/builds/mozilla-inbound/mozilla/ipc/ipdl/ipdl/type.py\", line 762, in visitInclude\n 0:05.25     inc.tu.accept(self)\n 0:05.25   File \"/scratch/work/builds/mozilla-inbound/mozilla/ipc/ipdl/ipdl/ast.py\", line 135, in accept\n 0:05.25     return visit(self)\n 0:05.25   File \"/scratch/work/builds/mozilla-inbound/mozilla/ipc/ipdl/ipdl/type.py\", line 715, in visitTranslationUnit\n 0:05.25     if inc.tu.filetype == 'header':\n 0:05.25 AttributeError: 'NoneType' object has no attribute 'filetype'\n}\n\nhg bisect says this starts with mozilla-central changeset a11adf1705ec.", "author": "dholbert@mozilla.com", "id": 9382059, "time": "2014-09-30T18:07:06Z"}, {"text": "As discussed with tbsaunde & jdm in IRC: you can't have ifdefs in ipdl, so we can't just add ifdefs around the reference to PDocAccessible.ipdl.\n\nIt sounds like we have to unconditionally build PDocAccessible.ipdl (but with a stub implementation), or something like that.\n\n(I think tbsaunde is working on this, or will be soon, from the sound of his discussion w/ jdm earlier.)", "author": "dholbert@mozilla.com", "id": 9382948, "time": "2014-09-30T20:42:29Z"}, {"text": "Created attachment 8498183\nfix --disable-accessibility", "author": "tbsaunde+mozbugs@tbsaunde.org", "id": 9387064, "time": "2014-10-01T14:39:43Z"}, {"text": "*** Bug 1075348 has been marked as a duplicate of this bug. ***", "author": "octoploid@yandex.com", "id": 9392287, "time": "2014-10-02T06:55:32Z"}, {"text": "Comment on attachment 8498183\nfix --disable-accessibility\n\nThe build config changes look fine, but you'll probably want someone to review the dom code changes as well.\n\nWill this be changing at all since the backout from bug 1075387?", "author": "mshal@mozilla.com", "id": 9394375, "time": "2014-10-02T15:31:34Z"}, {"text": "(In reply to Michael Shal [:mshal] from comment #4)\n> Comment on attachment 8498183\n> fix --disable-accessibility\n> \n> The build config changes look fine, but you'll probably want someone to\n> review the dom code changes as well.\n\nyeah, I'll find someone with a rubber stamp.\n\n> \n> Will this be changing at all since the backout from bug 1075387?\n\nno, though I bet it'll change for glandium's tier stuff.", "author": "tbsaunde+mozbugs@tbsaunde.org", "id": 9414616, "time": "2014-10-07T17:48:47Z"}, {"text": "Comment on attachment 8498183\nfix --disable-accessibility\n\ndholbert would you mind doing the honors for the ifdefs in dom/ipc/Contnet*? it should be pretty obvious they're correct ;)", "author": "tbsaunde+mozbugs@tbsaunde.org", "id": 9427091, "time": "2014-10-09T18:51:15Z"}, {"text": "Comment on attachment 8498183\nfix --disable-accessibility\n\n[side note: bug 982842, which caused this build breakage, was backed out for causing another bug, and hasn't yet re-landed, so this patch doesn't currently apply on m-c.]\n\nIt looks like the dom/ipc ifdefs are just wrapping a11y-specific chunks that are added in attachment 8489635, which seems reasonable. \n\nOne question:\n>diff --git a/dom/ipc/ContentChild.cpp b/dom/ipc/ContentChild.cpp\n[...]\n> bool\n> ContentChild::DeallocPDocAccessibleChild(a11y::PDocAccessibleChild* aChild)\n> {\n>+#ifdef ACCESSIBILITY\n>   delete static_cast<mozilla::a11y::DocAccessibleChild*>(aChild);\n>+#endif\n>   return true;\n> }\n\nIn the unlikely event that we actually get a call to this method in a disable-a11y build, it looks like it'd leak.  That's probably bad.\n\nDo we not need to worry about that because this is never called in that case? If so, maybe we should have an #else clause with a NS_ERROR?", "author": "dholbert@mozilla.com", "id": 9428652, "time": "2014-10-10T00:24:39Z"}, {"text": "Comment on attachment 8498183\nfix --disable-accessibility\n\nI don't really know what this code does, but I'm happy to take your word for it that this just needs a rubber-stamp level of review (per comment 5), so I've verified that these #ifdefs are indeed being added around a11y-flavored code that's new in bug 982842 (attachment 8489635 specifically).  Seems sane.\n\nSo, rs=me, modulo my question in previous comment.\n\n(One other thought there -- maybe we really want to add something like...\n  #else\n    MOZ_ASSERT(!aParent, \"how did our caller get a PDocAccessibleParent in a non-a11y build?\")\n  #endif\n\n...if this function actually does get called in --disable-a11y builds, but with the nullptr provided from AllocPDocAccessibleParent?)", "author": "dholbert@mozilla.com", "id": 9428714, "time": "2014-10-10T00:48:29Z"}, {"text": "(In reply to Daniel Holbert [:dholbert] from comment #8)\n> (One other thought there -- maybe we really want to add something like...\n>   #else\n>     MOZ_ASSERT(!aParent, \"how did our caller get a PDocAccessibleParent in a non-a11y build?\")\n>   #endif\n\nEr, I meant \"PDocAccessibleChild\" -- though this applies both to DeallocPDocAccessibleChild *and* DeallocPDocAccessibleParent.)", "author": "dholbert@mozilla.com", "id": 9428719, "time": "2014-10-10T00:50:08Z"}, {"text": "(In reply to Daniel Holbert [:dholbert] from comment #7)\n> Comment on attachment 8498183\n> fix --disable-accessibility\n> \n> [side note: bug 982842, which caused this build breakage, was backed out for\n> causing another bug, and hasn't yet re-landed, so this patch doesn't\n> currently apply on m-c.]\n> \n> It looks like the dom/ipc ifdefs are just wrapping a11y-specific chunks that\n> are added in attachment 8489635, which seems\n> reasonable. \n> \n> One question:\n> >diff --git a/dom/ipc/ContentChild.cpp b/dom/ipc/ContentChild.cpp\n> [...]\n> > bool\n> > ContentChild::DeallocPDocAccessibleChild(a11y::PDocAccessibleChild* aChild)\n> > {\n> >+#ifdef ACCESSIBILITY\n> >   delete static_cast<mozilla::a11y::DocAccessibleChild*>(aChild);\n> >+#endif\n> >   return true;\n> > }\n> \n> In the unlikely event that we actually get a call to this method in a\n> disable-a11y build, it looks like it'd leak.  That's probably bad.\n\nWell, in that case there is no such type as DocAccessibleParent, and PDocAccessibleParent is abstract, so I'm not sure what type you'd have that we'd fail to free.\n\n> Do we not need to worry about that because this is never called in that\n> case? If so, maybe we should have an #else clause with a NS_ERROR?\n\nit really shouldn't be called, I guess asserts can't hurt.", "author": "tbsaunde+mozbugs@tbsaunde.org", "id": 9432173, "time": "2014-10-10T19:38:22Z"}, {"text": "I squashed this into the relanding of bug 982842", "author": "tbsaunde+mozbugs@tbsaunde.org", "id": 9486154, "time": "2014-10-22T18:20:40Z"}], "cf_last_resolved": "2014-10-22T18:20:40Z", "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "Trunk", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2017-05-03T15:42:23Z", "cf_platform_rel": "---", "product": "Core", "cf_status_firefox_esr52": "---", "blocks": [982842], "qa_contact": "", "see_also": [], "cf_fx_iteration": "---", "component": "Disability Access APIs", "votes": 0, "groups": [], "cf_status_firefox60": "---", "target_milestone": "---", "is_cc_accessible": true, "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "dholbert@mozilla.com", "id": 278074, "name": "dholbert@mozilla.com", "real_name": "Daniel Holbert [:dholbert]"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "dholbert@mozilla.com", "id": 278074, "name": "dholbert@mozilla.com", "real_name": "Daniel Holbert [:dholbert]"}, {"email": "mshal@mozilla.com", "id": 456035, "name": "mshal@mozilla.com", "real_name": "Michael Shal [:mshal] (out - 3/12)"}, {"email": "octoploid@yandex.com", "id": 300673, "name": "octoploid@yandex.com", "real_name": "Octoploid"}, {"email": "tbsaunde+mozbugs@tbsaunde.org", "id": 401086, "name": "tbsaunde+mozbugs@tbsaunde.org", "real_name": "Trevor Saunders (:tbsaunde)"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "history": [{"changes": [{"removed": "Builds with \"ac_add_options --disable-accessibility\" are broken, with \"AttributeError: 'NoneType' object has no attribute 'filetype'\"", "field_name": "summary", "added": "Builds with \"ac_add_options --disable-accessibility\" are broken, with \"AttributeError: 'NoneType' object has no attribute 'filetype'\", due to PContent.ipdl including PDocAccessible"}], "who": "dholbert@mozilla.com", "when": "2014-09-30T18:13:52Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(trev.saunders@gmail.com)"}], "who": "dholbert@mozilla.com", "when": "2014-09-30T20:42:29Z"}, {"changes": [{"removed": "x86_64", "field_name": "platform", "added": "All"}, {"removed": "Linux", "field_name": "op_sys", "added": "All"}], "who": "dholbert@mozilla.com", "when": "2014-09-30T20:42:47Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8498183, "added": "review?(mshal@mozilla.com)"}, {"removed": "", "field_name": "cc", "added": "mshal@mozilla.com"}], "who": "tbsaunde+mozbugs@tbsaunde.org", "when": "2014-10-01T14:39:43Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "octoploid@yandex.com"}], "who": "octoploid@yandex.com", "when": "2014-10-02T06:55:32Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(mshal@mozilla.com)", "attachment_id": 8498183, "added": "review+"}], "who": "mshal@mozilla.com", "when": "2014-10-02T15:31:34Z"}, {"changes": [{"removed": "needinfo?(tbsaunde+mozbugs@tbsaunde.org)", "field_name": "flagtypes.name", "added": ""}], "who": "tbsaunde+mozbugs@tbsaunde.org", "when": "2014-10-07T17:48:47Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8498183, "added": "review?(dholbert@mozilla.com)"}, {"removed": "", "field_name": "cc", "added": "dholbert@mozilla.com"}], "who": "tbsaunde+mozbugs@tbsaunde.org", "when": "2014-10-09T18:51:15Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(dholbert@mozilla.com)", "attachment_id": 8498183, "added": "review+"}], "who": "dholbert@mozilla.com", "when": "2014-10-10T00:48:29Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2014-10-22 11:20:40"}], "who": "tbsaunde+mozbugs@tbsaunde.org", "when": "2014-10-22T18:20:40Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "tbsaunde+mozbugs@tbsaunde.org"}], "who": "dbolter@mozilla.com", "when": "2017-05-03T15:42:23Z"}], "resolution": "FIXED", "op_sys": "All", "cf_fx_points": "---", "cf_blocking_fennec": "---"}