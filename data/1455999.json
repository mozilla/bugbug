{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "hikezoe@mozilla.com", "mentors_detail": [], "depends_on": [1456372, 1456679], "cf_status_firefox_esr60": "---", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": [], "cc_detail": [{"email": "apavel@mozilla.com", "id": 600553, "name": "apavel@mozilla.com", "real_name": "Andreea Pavel [:apavel]"}, {"email": "bbirtles@mozilla.com", "id": 165012, "name": "bbirtles@mozilla.com", "real_name": "Brian Birtles (:birtles)"}, {"email": "bugmail@mozilla.staktrace.com", "id": 426788, "name": "bugmail@mozilla.staktrace.com", "real_name": "Kartikaya Gupta (email:kats@mozilla.com)"}, {"email": "hikezoe@mozilla.com", "id": 131213, "name": "hikezoe@mozilla.com", "real_name": "Hiroyuki Ikezoe (:hiro)"}, {"email": "milaninbugzilla@gmail.com", "id": 456486, "name": "milaninbugzilla@gmail.com", "real_name": "Milan Sreckovic [:milan] (needinfo for best results)"}], "cf_last_resolved": "2018-04-25T13:35:51Z", "attachments": [{"creator": "hikezoe@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-24T04:59:17Z", "type_id": 4, "creation_date": "2018-04-24T03:24:24Z", "id": 1748038, "setter": "bbirtles@mozilla.com"}], "content_type": "text/x-review-board-request", "id": 8970404}, {"creator": "hikezoe@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-24T06:27:23Z", "type_id": 4, "creation_date": "2018-04-24T06:26:32Z", "id": 1748079, "setter": "bbirtles@mozilla.com"}], "content_type": "text/x-review-board-request", "id": 8970405}, {"creator": "hikezoe@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-24T12:17:40Z", "type_id": 4, "creation_date": "2018-04-24T03:24:24Z", "id": 1748040, "setter": "bugmail@mozilla.staktrace.com"}], "content_type": "text/x-review-board-request", "id": 8970406}], "votes": 0, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 21, "comments": [{"text": "There are still disabled test cases for animations on WebRender.  We should enabe them as far as possible.\n\nJust pushed a try run.  Let's see what happens.\n\nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=166cafc3810071802cf725687fa259ef838ed94e", "author": "hikezoe@mozilla.com", "id": 13224398, "time": "2018-04-22T23:34:47Z"}, {"text": "Though there are still failing tests, we should enable tests that pass on WebRender.\nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=1441cce8f0aab435fa30d62d2ef6b5155a5135b8", "author": "hikezoe@mozilla.com", "id": 13228456, "time": "2018-04-24T03:23:06Z"}, {"text": "Created attachment 8970404\nBug 1455999 - Drop isStyleByServo() in dom/animation/.\n\nWe have already dropped the old style sytem.\n\nReview commit: https://reviewboard.mozilla.org/r/239178/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/239178/", "author": "hikezoe@mozilla.com", "id": 13228460, "time": "2018-04-24T03:24:24Z"}, {"text": "Created attachment 8970405\nBug 1455999 - Skip the visibility hidden test case on WebRender.\n\nReview commit: https://reviewboard.mozilla.org/r/239180/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/239180/", "author": "hikezoe@mozilla.com", "id": 13228461, "time": "2018-04-24T03:24:24Z"}, {"text": "Created attachment 8970406\nBug 1455999 - Enable animation tests on WebRender.\n\nReview commit: https://reviewboard.mozilla.org/r/239182/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/239182/", "author": "hikezoe@mozilla.com", "id": 13228462, "time": "2018-04-24T03:24:24Z"}, {"text": "Comment on attachment 8970404\nBug 1455999 - Drop isStyleByServo() in dom/animation/.\n\nhttps://reviewboard.mozilla.org/r/239178/#review244874", "author": "bbirtles@mozilla.com", "id": 13228595, "time": "2018-04-24T04:59:17Z"}, {"text": "Comment on attachment 8970405\nBug 1455999 - Skip the visibility hidden test case on WebRender.\n\nhttps://reviewboard.mozilla.org/r/239180/#review244876\n\n::: dom/animation/test/mozilla/file_restyles.html:720\n(Diff revision 1)\n>  \n>      await animation.ready;\n> +    if (!isWebRender) {\n> -    ok(!SpecialPowers.wrap(animation).isRunningOnCompositor);\n> +      ok(!SpecialPowers.wrap(animation).isRunningOnCompositor);\n> +    } else {\n> +      // FIXME: Bug 1455999: Enable this check on WebRender too.\n\nThis seems like the wrong bug number? Shouldn't this point to the bug where we plan to fix this?", "author": "bbirtles@mozilla.com", "id": 13228603, "time": "2018-04-24T05:02:19Z"}, {"text": "(In reply to Brian Birtles (:birtles) from comment #6)\n> Comment on attachment 8970405\n> Bug 1455999 - Skip the visibility hidden test case on WebRender.\n> \n> https://reviewboard.mozilla.org/r/239180/#review244876\n> \n> ::: dom/animation/test/mozilla/file_restyles.html:720\n> (Diff revision 1)\n> >  \n> >      await animation.ready;\n> > +    if (!isWebRender) {\n> > -    ok(!SpecialPowers.wrap(animation).isRunningOnCompositor);\n> > +      ok(!SpecialPowers.wrap(animation).isRunningOnCompositor);\n> > +    } else {\n> > +      // FIXME: Bug 1455999: Enable this check on WebRender too.\n> \n> This seems like the wrong bug number? Shouldn't this point to the bug where\n> we plan to fix this?\n\nI plan to fix it in this bug at this moment, if it turns out that much more work will be needed for, I will re-number it and file a new bug when I close this bug.", "author": "hikezoe@mozilla.com", "id": 13228636, "time": "2018-04-24T05:22:11Z"}, {"text": "(In reply to Hiroyuki Ikezoe (:hiro) from comment #7)\n> (In reply to Brian Birtles (:birtles) from comment #6)\n> > This seems like the wrong bug number? Shouldn't this point to the bug where\n> > we plan to fix this?\n> \n> I plan to fix it in this bug at this moment, if it turns out that much more\n> work will be needed for, I will re-number it and file a new bug when I close\n> this bug.\n\nOk. I don't understand why this patch is up for review then. Either we're fixing it here and we don't need this patch, or we aren't and this patch needs to be changed to point to where it will be fixed, and to explain the issue.", "author": "bbirtles@mozilla.com", "id": 13228677, "time": "2018-04-24T05:58:53Z"}, {"text": "That's because I'd want to enable those tests as soon as possible.  I did make a regression recently (bug 1455841), and it should have caught in some test cases.", "author": "hikezoe@mozilla.com", "id": 13228683, "time": "2018-04-24T06:09:54Z"}, {"text": "Let's spin off a separate bug for fixing the tests still not enabled in this bug.", "author": "bbirtles@mozilla.com", "id": 13228686, "time": "2018-04-24T06:12:04Z"}, {"text": "Comment on attachment 8970405\nBug 1455999 - Skip the visibility hidden test case on WebRender.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/239180/diff/1-2/", "author": "hikezoe@mozilla.com", "id": 13228716, "time": "2018-04-24T06:26:32Z"}, {"text": "Comment on attachment 8970406\nBug 1455999 - Enable animation tests on WebRender.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/239182/diff/1-2/", "author": "hikezoe@mozilla.com", "id": 13228717, "time": "2018-04-24T06:26:32Z"}, {"text": "Comment on attachment 8970405\nBug 1455999 - Skip the visibility hidden test case on WebRender.\n\nhttps://reviewboard.mozilla.org/r/239180/#review244892", "author": "bbirtles@mozilla.com", "id": 13228719, "time": "2018-04-24T06:27:23Z"}, {"text": "Comment on attachment 8970406\nBug 1455999 - Enable animation tests on WebRender.\n\nhttps://reviewboard.mozilla.org/r/239182/#review244952\n\nThis is great, thank you!", "author": "bugmail@mozilla.staktrace.com", "id": 13229283, "time": "2018-04-24T12:17:40Z"}, {"text": "Pushed by hikezoe@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/19a70418a35e\nDrop isStyleByServo() in dom/animation/. r=birtles\nhttps://hg.mozilla.org/integration/autoland/rev/5d08e0ab65ce\nSkip the visibility hidden test case on WebRender. r=birtles\nhttps://hg.mozilla.org/integration/autoland/rev/83c1e6e742fd\nEnable animation tests on WebRender. r=kats", "author": "pulsebot@bots.tld", "id": 13230940, "time": "2018-04-24T21:21:39Z"}, {"text": "I'd catch kats on IRC, but I couldn't get up early enough. :)\nAnyway I am wondering why we call DiscardCompositorAnimations before BuildWebRenderCommands?[1] (the animations will be discarded are enqueued through BuildWebRenderCommands).  It seems to me that we can discard the dead animations in the same transaction.  Also note that with the current setup, some of test cases fail because there remains some dead animations which should have already discarded.  Actually moving the DiscardCompositorAnimations call after BuildWebRenderCommands make most of failures pass.\n\nHere is a try with the change.  There are still 6 failures in test_animations_omta.html, but I have already a patch for that and will open a new bug for it.\nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=80e1f2cb51ee17493f7da51e08b49ee3b1707593\n\n[1] https://searchfox.org/mozilla-central/rev/36dec78aecc40539ecc8d78e91612e38810f963c/gfx/layers/wr/WebRenderLayerManager.cpp#267-280", "author": "hikezoe@mozilla.com", "id": 13231444, "time": "2018-04-25T00:22:02Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/19a70418a35e\nhttps://hg.mozilla.org/mozilla-central/rev/5d08e0ab65ce\nhttps://hg.mozilla.org/mozilla-central/rev/83c1e6e742fd", "author": "rgurzau@mozilla.com", "id": 13232041, "time": "2018-04-25T09:42:18Z"}, {"text": "(In reply to Hiroyuki Ikezoe (:hiro) from comment #16)\n> Anyway I am wondering why we call DiscardCompositorAnimations before\n> BuildWebRenderCommands?[1] (the animations will be discarded are enqueued\n> through BuildWebRenderCommands).  It seems to me that we can discard the\n> dead animations in the same transaction.\n\nHm, I think part of the problem is that the transaction sends an updated display list to WR, but we may not render and composite that display list right away. We might still be showing the previous transaction and so we might need to have that animation info alive in the parent at the time. But I agree this is not clear and there's almost certainly a better way to do it. I need to revisit this behaviour anyway as part of bug 1453360 - my goal is to have each animation associated on the parent side with the transaction that deletes it. Then once that transaction is finally rendered, we will know that it is safe to delete those animations because the entire WR pipeline will be free of those animations. I'll look at that today.\n\n> Also note that with the current\n> setup, some of test cases fail because there remains some dead animations\n> which should have already discarded.  Actually moving the\n> DiscardCompositorAnimations call after BuildWebRenderCommands make most of\n> failures pass.\n> \n> Here is a try with the change.  There are still 6 failures in\n> test_animations_omta.html, but I have already a patch for that and will open\n> a new bug for it.\n> https://treeherder.mozilla.org/#/\n> jobs?repo=try&revision=80e1f2cb51ee17493f7da51e08b49ee3b1707593\n\nThat's interesting to see. If making this change doesn't break anything then it might be ok to do - it could be that my understanding of how this is supposed to work is wrong.\n\nAt any rate, I'm going to close this bug, we can spin this off into a new bug as well.", "author": "bugmail@mozilla.staktrace.com", "id": 13232422, "time": "2018-04-25T13:35:51Z"}, {"text": "This has been the source for https://bugzilla.mozilla.org/show_bug.cgi?id=1456372#c3\nThe above mentioned bug has 54 failures in the last 7 days, all on linux64-qr.\n\nRecent failure log: https://treeherder.mozilla.org/logviewer.html#?job_id=176157924&repo=autoland&lineNumber=4395\n\n[task 2018-04-28T18:48:52.223Z] 18:48:52     INFO - TEST-START | dom/animation/test/mozilla/test_transition_finish_on_compositor.html\n[task 2018-04-28T18:48:52.731Z] 18:48:52     INFO - TEST-INFO | started process screentopng\n[task 2018-04-28T18:48:53.507Z] 18:48:53     INFO - TEST-INFO | screentopng: exit 0\n[task 2018-04-28T18:48:53.509Z] 18:48:53     INFO - TEST-UNEXPECTED-FAIL | dom/animation/test/mozilla/test_transition_finish_on_compositor.html | Transition on the compositor keeps the final style while the main thread is busy even if the transition finished on the compositor - Transition on the compositor keeps the final style while the main thread is busy even if the transition finished on the compositor: assert_equals: The final transition style is still applied on the compositor expected \"matrix(1, 0, 0, 1, 100, 0)\" but got \"matrix(1, 0, 0, 1, 91.5861, 0)\"\n[task 2018-04-28T18:48:53.509Z] 18:48:53     INFO - TEST-PASS | dom/animation/test/mozilla/test_transition_finish_on_compositor.html |  - : Elided 1 passes or known failures.\n[task 2018-04-28T18:48:53.510Z] 18:48:53     INFO - GECKO(4088) | MEMORY STAT | vsize 1625MB | residentFast 141MB | heapAllocated 26MB\n[task 2018-04-28T18:48:53.511Z] 18:48:53     INFO - GECKO(4088) | [GFX1-]: Unknown pipeline used for iframe IframeDisplayItem { clip_id: Clip(4, PipelineId(1, 1)), pipeline_id: PipelineId(1, 8) }\n[task 2018-04-28T18:48:53.513Z] 18:48:53     INFO - GECKO(4088) | ERROR 2018-04-28T18:48:52Z: webrender::display_list_flattener: Unknown pipeline used for iframe IframeDisplayItem { clip_id: Clip(4, PipelineId(1, 1)), pipeline_id: PipelineId(1, 8) }\n[task 2018-04-28T18:48:53.514Z] 18:48:53     INFO - TEST-OK | dom/animation/test/mozilla/test_transition_finish_on_compositor.html | took 581ms\n\n:hiro can you take a look?", "author": "apavel@mozilla.com", "id": 13240192, "time": "2018-04-29T00:02:01Z"}, {"text": "The test case unfortunately didn't fail on some tries.  I will take care of the failure test in bug 1456372.", "author": "hikezoe@mozilla.com", "id": 13240599, "time": "2018-04-29T21:23:46Z"}], "id": 1455999, "priority": "P2", "cc": ["apavel@mozilla.com", "bbirtles@mozilla.com", "bugmail@mozilla.staktrace.com", "hikezoe@mozilla.com", "milaninbugzilla@gmail.com"], "cf_crash_signature": "", "version": "61 Branch", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_thunderbird_esr60": "---", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1386669, 1424752], "qa_contact": "", "creation_time": "2018-04-22T23:34:47Z", "cf_status_firefox_esr52": "---", "component": "Graphics: WebRender", "assigned_to_detail": {"email": "hikezoe@mozilla.com", "id": 131213, "name": "hikezoe@mozilla.com", "real_name": "Hiroyuki Ikezoe (:hiro)"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "---", "cf_status_firefox60": "---", "target_milestone": "mozilla61", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "hikezoe@mozilla.com", "id": 131213, "name": "hikezoe@mozilla.com", "real_name": "Hiroyuki Ikezoe (:hiro)"}, "whiteboard": "", "mentors": [], "summary": "Enable animation tests on WebRender", "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-04-29T21:23:46Z", "assigned_to": "hikezoe@mozilla.com", "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "hikezoe@mozilla.com"}], "who": "hikezoe@mozilla.com", "when": "2018-04-24T03:23:06Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8970404, "added": "review?(bbirtles@mozilla.com)"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8970405, "added": "review?(bbirtles@mozilla.com)"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8970406, "added": "review?(bugmail@mozilla.staktrace.com)"}, {"removed": "", "field_name": "cc", "added": "bbirtles@mozilla.com"}], "who": "hikezoe@mozilla.com", "when": "2018-04-24T03:24:24Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "leave-open"}], "who": "hikezoe@mozilla.com", "when": "2018-04-24T03:24:52Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bbirtles@mozilla.com)", "attachment_id": 8970404, "added": "review+"}], "who": "bbirtles@mozilla.com", "when": "2018-04-24T04:59:17Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bbirtles@mozilla.com)", "attachment_id": 8970405, "added": ""}], "who": "bbirtles@mozilla.com", "when": "2018-04-24T05:02:19Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8970405, "added": "review?(bbirtles@mozilla.com)"}], "who": "hikezoe@mozilla.com", "when": "2018-04-24T06:26:32Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bbirtles@mozilla.com)", "attachment_id": 8970405, "added": "review+"}], "who": "bbirtles@mozilla.com", "when": "2018-04-24T06:27:23Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bugmail@mozilla.staktrace.com)", "attachment_id": 8970406, "added": "review+"}], "who": "bugmail@mozilla.staktrace.com", "when": "2018-04-24T12:17:40Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P2"}, {"removed": "", "field_name": "cc", "added": "milan@mozilla.com"}, {"removed": "", "field_name": "blocks", "added": "1386669"}], "who": "milaninbugzilla@gmail.com", "when": "2018-04-24T16:53:56Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(bugmail@mozilla.staktrace.com)"}], "who": "hikezoe@mozilla.com", "when": "2018-04-25T00:22:02Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1456679"}], "who": "hikezoe@mozilla.com", "when": "2018-04-25T01:15:32Z"}, {"changes": [{"removed": "leave-open", "field_name": "keywords", "added": ""}, {"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "unspecified", "field_name": "version", "added": "61 Branch"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "hikezoe@mozilla.com"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla61"}, {"removed": "needinfo?(bugmail@mozilla.staktrace.com)", "field_name": "flagtypes.name", "added": ""}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-04-25 13:35:51"}], "who": "bugmail@mozilla.staktrace.com", "when": "2018-04-25T13:35:51Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1456372"}], "who": "dbaron@dbaron.org", "when": "2018-04-28T02:06:56Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "apavel@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(hikezoe@mozilla.com)"}], "who": "apavel@mozilla.com", "when": "2018-04-29T00:02:01Z"}, {"changes": [{"removed": "needinfo?(hikezoe@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "hikezoe@mozilla.com", "when": "2018-04-29T21:23:46Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}