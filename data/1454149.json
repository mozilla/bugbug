{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "+", "cf_tracking_firefox62": "+", "creator": "mayankleoboy1@gmail.com", "mentors_detail": [], "depends_on": [], "cf_status_firefox_esr60": "unaffected", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "cf_status_firefox59": "unaffected", "keywords": ["regression"], "cc_detail": [{"email": "aosmond@mozilla.com", "id": 505306, "name": "aosmond@mozilla.com", "real_name": "Andrew Osmond [:aosmond]"}, {"email": "catalin.sasca@softvision.ro", "id": 612754, "name": "catalin.sasca@softvision.ro", "real_name": "Sasca Catalin, QA [:csasca]"}, {"email": "mcastelluccio@mozilla.com", "id": 420453, "name": "mcastelluccio@mozilla.com", "real_name": "Marco Castelluccio [:marco]"}, {"email": "mdaly@mozilla.com", "id": 609492, "name": "mdaly@mozilla.com", "real_name": "Marion Daly [:mdaly]"}, {"email": "nissan4321@gmail.com", "id": 414417, "name": "nissan4321@gmail.com", "real_name": "Mikel"}, {"email": "ryanvm@gmail.com", "id": 75935, "name": "ryanvm@gmail.com", "real_name": "Ryan VanderMeulen [:RyanVM]"}, {"email": "tnikkel@gmail.com", "id": 255010, "name": "tnikkel@gmail.com", "real_name": "Timothy Nikkel (:tnikkel)"}], "cf_last_resolved": "2018-05-09T17:30:00Z", "attachments": [{"creator": "aosmond@mozilla.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8968293}, {"creator": "aosmond@mozilla.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8970294}, {"creator": "aosmond@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-05-03T08:25:54Z", "type_id": 4, "creation_date": "2018-04-24T18:57:25Z", "id": 1748443, "setter": "tnikkel@gmail.com"}], "content_type": "text/plain", "id": 8970660}], "votes": 2, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 18, "comments": [{"text": "go to  https://blog.github.com/2016-08-19-building-your-first-atom-plugin/\nLet the GIF load\nWatch the CPU usage\n\nuses 75-100% of my CPU\nhttps://perfht.ml/2ELbbFd", "author": "mayankleoboy1@gmail.com", "id": 13205644, "time": "2018-04-14T07:48:01Z"}, {"text": "Regression from bug 523950. Unfortunately unrelated to bug 1444537 from what I can tell (it would be nice to have an STR).\n\nCPU usage is high even in release, but at least drops off as the decoding completes, at the cost of using a few GB of RAM. However comparing to Chrome, I see that it doesn't even advance animated images which are not in view. I think that should be the solution.", "author": "aosmond@mozilla.com", "id": 13209672, "time": "2018-04-16T14:32:37Z"}, {"text": "Created attachment 8968293\n0001-Bug-1454149-Do-not-advance-animated-images-which-are.patch, v1\n\nI think this is the simplest change I can make which should fix the problem, in addition to making this more efficient in general for animated images outside the current view.\n\ntry: https://treeherder.mozilla.org/#/jobs?repo=try&revision=e1d87311384c4c433aac6f8427fdc9437cd045bf\n\nThis patch will make us ignore refresh ticks for an animated image if nothing is accessing its composited frame. This should work for all frame accessing paths for a RasterImage -- Draw, GetFrame, GetFrameAtSize, GetImageContainer, UpdateImageContainer. The image container case will still have a high CPU usage if the entity which requested the image container keeps it around, but doesn't otherwise use it (bad entity!); since animated images shouldn't be layerized, I don't think this is a big concern (correct me if I'm wrong -- we still need to solve this for WebRender as well!).\n\nI think it should be upliftable to beta, assuming the try is green, but I'll let my reviewer make that call. If it is too risky, we need to increase image.animated.decode-on-demand.threshold-kb to the highest value for beta to delay the feature to the next release.", "author": "aosmond@mozilla.com", "id": 13210547, "time": "2018-04-16T19:06:13Z"}, {"text": "Comment on attachment 8968293\n0001-Bug-1454149-Do-not-advance-animated-images-which-are.patch, v1\n\nDisable review for now. We discussed this on IRC, and it definitely needs more work.", "author": "aosmond@mozilla.com", "id": 13226487, "time": "2018-04-23T13:54:24Z"}, {"text": "Created attachment 8970294\n0001-Bug-1454149-Do-not-advance-animated-images-which-are.patch, v2\n\nThis should take care of discarded images, as well as adding a pref to disable this feature if it causes problems after making its way into a build.\n\ntry: https://treeherder.mozilla.org/#/jobs?repo=try&revision=f6703abeb8756257005433e07b3d421a0e2ed2e7\n\nI still need to dig into the bug history to find the reasons why we hesitated to change this behaviour in the past.", "author": "aosmond@mozilla.com", "id": 13227396, "time": "2018-04-23T18:52:03Z"}, {"text": "Created attachment 8970660\n0001-Bug-1454149-Do-not-advance-animated-images-which-are.patch, v3\n\nI can't find any bugs discussing the \"we should advance animated images when out of view\" issue. Maybe you can dig it up :).", "author": "aosmond@mozilla.com", "id": 13230546, "time": "2018-04-24T18:57:25Z"}, {"text": "The landing of bug 1454824 should have mitigated the problem on 60, so I'm marking it as unaffected. We'll still want a patch for 61 though.", "author": "aosmond@mozilla.com", "id": 13240111, "time": "2018-04-28T21:30:32Z"}, {"text": "Where are we on review?", "author": "mdaly@mozilla.com", "id": 13249248, "time": "2018-05-02T15:44:56Z"}, {"text": "(In reply to Marion Daly [:mdaly] from comment #7)\n> Where are we on review?\n\nI decided to disable the regressing feature, just landed the pref change so it should make it into 61 beta as normal. Once it is merged I'll mark 61 as unaffected here.", "author": "aosmond@mozilla.com", "id": 13250436, "time": "2018-05-02T20:33:46Z"}, {"text": "(In reply to Andrew Osmond [:aosmond] from comment #5)\n> I can't find any bugs discussing the \"we should advance animated images when\n> out of view\" issue. Maybe you can dig it up :).\n\nI did a quick look, didn't find anything.", "author": "tnikkel@gmail.com", "id": 13253265, "time": "2018-05-03T20:39:36Z"}, {"text": "This is technically \"fixed\" for all affected versions now since the disabling landed on m-c directly, but I'm assuming we want to leave this bug open for fixing the underlying problem (and re-enabling it for 62?).\n\nIn the mean time, requesting QA to at least give this a spot check on 61 betas to ensure that things are looking good there again.", "author": "ryanvm@gmail.com", "id": 13261297, "time": "2018-05-08T01:40:04Z"}, {"text": "Pushed by aosmond@gmail.com:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/ba377bd503e1\nDo not advance animated images which are not displayed. r=tnikkel", "author": "pulsebot@bots.tld", "id": 13265127, "time": "2018-05-09T12:04:39Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/ba377bd503e1", "author": "csabou@mozilla.com", "id": 13266061, "time": "2018-05-09T17:30:00Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/ba377bd503e1", "author": "csabou@mozilla.com", "id": 13266082, "time": "2018-05-09T17:30:49Z"}, {"text": "The issue is still reproducible for me on 61.0b3 and 62.0a1 (2018-05-09). From what I observed, the cpu usage is around 60% utilization when scrolling the page, and firefox's ram usage is jumping all around (as example one second is at 1.5gb usage, then jumps to 700mb, then back up to 2.0gb). If I stop scrolling, the usage stays still at around 700mb, but as soon as the scrolling starts, the memory jumps back to a higher value. (Windows 10 system - Amd FX8320, 16gb DDR3, Radeon Integrated HD3000). \nOn macOS 10.12 and 10.13, the cpu usage stays at 130-140%, but the memory usage is not touched.", "author": "catalin.sasca@softvision.ro", "id": 13268056, "time": "2018-05-10T13:27:51Z"}, {"text": "(In reply to Sasca Catalin, QA [:csasca] from comment #14)\n> The issue is still reproducible for me on 61.0b3 and 62.0a1 (2018-05-09).\n> From what I observed, the cpu usage is around 60% utilization when scrolling\n> the page, and firefox's ram usage is jumping all around (as example one\n> second is at 1.5gb usage, then jumps to 700mb, then back up to 2.0gb). If I\n> stop scrolling, the usage stays still at around 700mb, but as soon as the\n> scrolling starts, the memory jumps back to a higher value. (Windows 10\n> system - Amd FX8320, 16gb DDR3, Radeon Integrated HD3000). \n> On macOS 10.12 and 10.13, the cpu usage stays at 130-140%, but the memory\n> usage is not touched.\n\nIs the beta CPU usage high compared to 59? This was never a great page for us. Chrome should be similar as long as an animation is not in view. I expect memory usage to be very high on release/beta.\n\nToday's nightly should similarly to Chrome. The memory footprint should be lower than beta, and the CPU footprint somewhat higher (there is a tradeoff for the lower memory usage). Unfortunately we aren't quite as good as Chrome with respect to out of view animated images, but if you stop scrolling around \"Activation commands\", the CPU should also hit zero. This is because we appear to be prerendering more parts above and below the current view, and it captures the animated images more frequently.\n\nTo confirm, the expected preferences on nightly are:\n\nimage.animated.decode-on-demand.threshold-kb == 20480\nimage.animated.resume-from-last-displayed == true", "author": "aosmond@mozilla.com", "id": 13268204, "time": "2018-05-10T14:12:25Z"}, {"text": "Hi Andrew. On 59.0.3 and 61.0b3, the cpu gets to 50%, then it slowly stabilizes at around 20%. On 62.0a1 (2018-05-09) it stays at around 35-40% cpu usage. The ram is jumping all around on every firefox build and if the page is scrolled all the way down, firefox has a ram usage of around 4gb and is jumping to 2gb then to 3gb, again to 4gb and so on. Chrome tops it's cpu usage to 25-30% and the memory usage is nearly untouched (200-400mb).", "author": "catalin.sasca@softvision.ro", "id": 13269977, "time": "2018-05-11T05:54:41Z"}, {"text": "(In reply to Sasca Catalin, QA [:csasca] from comment #16)\n> Hi Andrew. On 59.0.3 and 61.0b3, the cpu gets to 50%, then it slowly\n> stabilizes at around 20%. On 62.0a1 (2018-05-09) it stays at around 35-40%\n> cpu usage. The ram is jumping all around on every firefox build and if the\n> page is scrolled all the way down, firefox has a ram usage of around 4gb and\n> is jumping to 2gb then to 3gb, again to 4gb and so on. Chrome tops it's cpu\n> usage to 25-30% and the memory usage is nearly untouched (200-400mb).\n\nI think bug 1382683 is going to help with the CPU usage. The memory is surprisingly, I'll need to think further on that.", "author": "aosmond@mozilla.com", "id": 13291428, "time": "2018-05-20T14:49:26Z"}], "id": 1454149, "priority": "P3", "cc": ["aosmond@mozilla.com", "catalin.sasca@softvision.ro", "mcastelluccio@mozilla.com", "mdaly@mozilla.com", "nissan4321@gmail.com", "ryanvm@gmail.com", "tnikkel@gmail.com"], "cf_crash_signature": "", "version": "Trunk", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": ["https://bugzilla.mozilla.org/show_bug.cgi?id=1454824", "https://bugzilla.mozilla.org/show_bug.cgi?id=1382683"], "cf_tracking_thunderbird_esr60": "---", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [523950], "qa_contact": "", "creation_time": "2018-04-14T07:48:01Z", "cf_status_firefox_esr52": "unaffected", "component": "ImageLib", "assigned_to_detail": {"email": "aosmond@mozilla.com", "id": 505306, "name": "aosmond@mozilla.com", "real_name": "Andrew Osmond [:aosmond]"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "fixed", "cf_status_firefox61": "fixed", "cf_status_firefox60": "unaffected", "target_milestone": "mozilla62", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "mayankleoboy1@gmail.com", "id": 440227, "name": "mayankleoboy1@gmail.com", "real_name": "Mayank Bansal"}, "whiteboard": "[gfx-noted]", "mentors": [], "summary": "https://blog.github.com/2016-08-19-building-your-first-atom-plugin/ uses 100% CPU due to GIF", "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [{"status": "+", "name": "qe-verify", "modification_date": "2018-05-08T01:40:04Z", "type_id": 864, "creation_date": "2018-05-08T01:40:04Z", "id": 1753810, "setter": "ryanvm@gmail.com"}], "last_change_time": "2018-05-20T14:49:26Z", "assigned_to": "aosmond@mozilla.com", "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "aosmond@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(aosmond@mozilla.com)"}], "who": "mayankleoboy1@gmail.com", "when": "2018-04-14T07:48:41Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "tnikkel@gmail.com"}], "who": "tnikkel@gmail.com", "when": "2018-04-14T07:57:23Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "523950"}], "who": "aosmond@mozilla.com", "when": "2018-04-16T14:32:37Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P3"}, {"removed": "UNCONFIRMED", "field_name": "status", "added": "NEW"}, {"removed": "0", "field_name": "is_confirmed", "added": "1"}, {"removed": "", "field_name": "whiteboard", "added": "[gfx-noted]"}, {"removed": "needinfo?(aosmond@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "aosmond@mozilla.com", "when": "2018-04-16T14:32:56Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "ASSIGNED"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "aosmond@mozilla.com"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8968293, "added": "review?(tnikkel@gmail.com)"}], "who": "aosmond@mozilla.com", "when": "2018-04-16T19:06:13Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1454824"}], "who": "aosmond@mozilla.com", "when": "2018-04-18T01:43:41Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "nissan4321@gmail.com"}], "who": "nissan4321@gmail.com", "when": "2018-04-20T10:52:26Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(tnikkel@gmail.com)", "attachment_id": 8968293, "added": ""}], "who": "aosmond@mozilla.com", "when": "2018-04-23T13:54:24Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8968293, "added": "1"}], "who": "aosmond@mozilla.com", "when": "2018-04-23T18:52:03Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8970294, "added": "1"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8970660, "added": "review?(tnikkel@gmail.com)"}], "who": "aosmond@mozilla.com", "when": "2018-04-24T18:57:25Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "regression"}, {"removed": "", "field_name": "cc", "added": "mcastelluccio@mozilla.com"}], "who": "mcastelluccio@mozilla.com", "when": "2018-04-25T23:57:30Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "ryanvm@gmail.com"}, {"removed": "", "field_name": "blocks", "added": "523950"}, {"removed": "523950", "field_name": "depends_on", "added": ""}, {"removed": "---", "field_name": "cf_status_firefox_esr52", "added": "unaffected"}, {"removed": "---", "field_name": "cf_status_firefox_esr60", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox59", "added": "unaffected"}, {"removed": "---", "field_name": "cf_status_firefox60", "added": "affected"}, {"removed": "---", "field_name": "cf_tracking_firefox61", "added": "+"}], "who": "ryanvm@gmail.com", "when": "2018-04-28T19:50:31Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox_esr60", "added": "unaffected"}, {"removed": "affected", "field_name": "cf_status_firefox60", "added": "unaffected"}], "who": "aosmond@mozilla.com", "when": "2018-04-28T21:30:32Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mdaly@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(aosmond@mozilla.com)"}], "who": "mdaly@mozilla.com", "when": "2018-05-02T15:44:56Z"}, {"changes": [{"removed": "needinfo?(aosmond@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "aosmond@mozilla.com", "when": "2018-05-02T20:33:46Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(tnikkel@gmail.com)", "attachment_id": 8970660, "added": "review+"}], "who": "tnikkel@gmail.com", "when": "2018-05-03T08:25:54Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "qe-verify+"}, {"removed": "affected", "field_name": "cf_status_firefox61", "added": "fixed"}, {"removed": "---", "field_name": "cf_tracking_firefox62", "added": "+"}, {"removed": "---", "field_name": "cf_status_firefox62", "added": "affected"}], "who": "ryanvm@gmail.com", "when": "2018-05-08T01:40:04Z"}, {"changes": [{"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla62"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-05-09 17:30:00"}, {"removed": "affected", "field_name": "cf_status_firefox62", "added": "fixed"}], "who": "csabou@mozilla.com", "when": "2018-05-09T17:30:00Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "catalin.sasca@softvision.ro"}], "who": "catalin.sasca@softvision.ro", "when": "2018-05-10T13:27:51Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1382683"}], "who": "aosmond@mozilla.com", "when": "2018-05-20T14:49:26Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}