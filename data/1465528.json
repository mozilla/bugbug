{"cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "classification": "Client Software", "creator": "ehsan@mozilla.com", "cc": ["ehsan@mozilla.com", "francois@mozilla.com", "lcrouch@mozilla.com", "lnorton@mozilla.com", "rbillings@mozilla.com", "senglehardt@mozilla.com"], "depends_on": [], "creation_time": "2018-05-30T16:31:31Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": ["regression"], "summary": "The strict tracking protection list is broken and equal to the basic one", "cf_last_resolved": null, "attachments": [{"creator": "francois@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/html", "id": 8982337}, {"creator": "francois@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/x-log", "id": 8982347}], "assigned_to_detail": {"email": "lcrouch@mozilla.com", "id": 403306, "name": "lcrouch@mozilla.com", "real_name": "Luke Crouch [:groovecoder] [on leave until July 16]"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_crash_signature": "", "comments": [{"text": "STR:\n\n1. Using Firefox 59.0.2, activate the strict TP list.\n2. Open a private window and navigate to https://senglehardt.com/test/random/tp_subresources.html.\n\nExpected results: no image should appear\n\nActual results: an image appears", "author": "ehsan@mozilla.com", "id": 13374973, "time": "2018-05-30T16:31:31Z"}, {"text": "I can reproduce in 52ESR and Beta 61, so perhaps this is a list creation/delivery issue?", "author": "senglehardt@mozilla.com", "id": 13375025, "time": "2018-05-30T16:47:48Z"}, {"text": "It certainly looks broken. Even our \"official\" test page is broken: https://mozilla.github.io/tracking-test/full.html\n\nThe list does contain entries though:\n\n- Reading sbstore: content-track-digest256\n[content-track-digest256] Magic 1231AF3B Version 3 NumAddChunk: 1 NumSubChunk: 0 NumAddPrefix: 0 NumSubPrefix: 0 NumAddComplete: 1797 NumSubComplete: 0\n[content-track-digest256] MD5: 3dd4d244cd2c5bff2172ec68f13acc55\n\nThat's using this script: https://github.com/fmarier/sbdbdump/blob/master/dump.py", "author": "francois@mozilla.com", "id": 13378802, "time": "2018-05-31T21:12:43Z"}, {"text": "Created attachment 8982337\ntp_subresources.html\n\nCopy of the test page from comment 0.", "author": "francois@mozilla.com", "id": 13378814, "time": "2018-05-31T21:17:01Z"}, {"text": "Here's the debug log of loading our \"official\" test page\nhttps://mozilla.github.io/tracking-test/full.html:\n\n[10761:Main Thread]: D/nsChannelClassifier nsChannelClassifier[0x7feb09fb1b20]: Enabling tracking protection checks on channel[0x7feb13584040] with uri https://www.gravatar.com/avatar/205e460b479e2e5b48aec07710c08d50 for toplevel window https://mozilla.github.io/\n[10761:Main Thread]: D/nsChannelClassifier nsChannelClassifier[0x7feb09fb1b20]:CheckIsTrackerWithLocalTable for uri=https://www.gravatar.com/avatar/205e460b479e2e5b48aec07710c08d50\n[10761:URL Classifier]: D/UrlClassifierDbService Checking fragment www.gravatar.com/avatar/\n[10761:URL Classifier]: D/UrlClassifierDbService Checking fragment www.gravatar.com/avatar/205e460b479e2e5b48aec07710c08d50\n[10761:URL Classifier]: D/UrlClassifierDbService Checking fragment www.gravatar.com/\n[10761:URL Classifier]: D/UrlClassifierDbService Checking fragment gravatar.com/avatar/\n[10761:URL Classifier]: D/UrlClassifierDbService Checking fragment gravatar.com/avatar/205e460b479e2e5b48aec07710c08d50\n[10761:URL Classifier]: D/UrlClassifierDbService Checking fragment gravatar.com/\n[10761:URL Classifier]: D/UrlClassifierDbService Checking table test-track-simple\n[10761:URL Classifier]: D/UrlClassifierDbService Checking table base-track-digest256\n[10761:URL Classifier]: D/UrlClassifierDbService Checking table content-track-digest256\n...\n[10761:URL Classifier]: D/UrlClassifierDbService Checking fragment www.gravatar.com/, hash 4AB59F761F2FBC122ABAD0BA70123E0E6E41131800D0518F9DFB1B1C4A0E02EE (769FB54A)\n[10761:URL Classifier]: D/UrlClassifierDbService Probe in test-track-simple: 769FB54A, has 0, confirmed 0\n[10761:URL Classifier]: D/UrlClassifierDbService Probe in base-track-digest256: 769FB54A, has 0, confirmed 0\n[10761:URL Classifier]: D/UrlClassifierDbService Probe in content-track-digest256: 769FB54A, has 0, confirmed 0\n...\n[10761:URL Classifier]: D/UrlClassifierDbService Checking fragment gravatar.com/, hash 2975933717E26C488DEEB246ADA6C24E3AD9999502A2236CD26C3839F8E2A5AE (37937529)\n[10761:URL Classifier]: D/UrlClassifierDbService Probe in test-track-simple: 37937529, has 0, confirmed 0\n[10761:URL Classifier]: D/UrlClassifierDbService Probe in base-track-digest256: 37937529, has 0, confirmed 0\n[10761:URL Classifier]: D/UrlClassifierDbService Probe in content-track-digest256: 37937529, has 0, confirmed 0\n[10761:URL Classifier]: D/UrlClassifierDbService Found 0 results.\n...\n[10761:Main Thread]: D/UrlClassifierDbService nsUrlClassifierLookupCallback::LookupComplete [0x7feb13f4cfc0] 0 pending completions\n[10761:Main Thread]: D/UrlClassifierDbService nsUrlClassifierLookupCallback::HandleResults [0x7feb13f4cfc0, 0 results]\n[10761:Main Thread]: D/nsChannelClassifier nsChannelClassifier[0x7feb02ed0190]:OnClassifyComplete NS_OK (suspended channel)\n[10761:Main Thread]: D/nsChannelClassifier nsChannelClassifier::MarkEntryClassified[NS_OK] https://mozilla.github.io/tracking-test/fox.png\n[10761:Main Thread]: D/nsChannelClassifier nsChannelClassifier[0x7feb02ed0190]: resuming channel 0x7feb134d1040 from OnClassifyComplete\n[10761:Main Thread]: D/nsChannelClassifier TrackingURICallback[0x7feb09fb1b20]::OnBlacklistResult aErrorCode=0x0\n\nThis is problematic:\n\n[10761:URL Classifier]: D/UrlClassifierDbService Checking fragment gravatar.com/, hash 2975933717E26C488DEEB246ADA6C24E3AD9999502A2236CD26C3839F8E2A5AE (37937529)\n[10761:URL Classifier]: D/UrlClassifierDbService Probe in test-track-simple: 37937529, has 0, confirmed 0\n[10761:URL Classifier]: D/UrlClassifierDbService Probe in base-track-digest256: 37937529, has 0, confirmed 0\n[10761:URL Classifier]: D/UrlClassifierDbService Probe in content-track-digest256: 37937529, has 0, confirmed 0\n[10761:URL Classifier]: D/UrlClassifierDbService Found 0 results.\n\nsince the resource is on the content list: https://github.com/mozilla-services/shavar-prod-lists/blob/f16248d7f33367bb3c48d72fb32fdb239dbe0c8e/disconnect-blacklist.json#L6455\n\nand so that suggests a problem with the list generation.", "author": "francois@mozilla.com", "id": 13378865, "time": "2018-05-31T21:36:42Z"}, {"text": "Ok, I think I know what the problem is:\n\n$ ls -l safebrowsing/*-track-digest256*\n-rw-r--r-- 1 francois francois    16 May 31 14:29 safebrowsing/base-track-digest256.pset\n-rw-r--r-- 1 francois francois 64888 May 31 14:29 safebrowsing/base-track-digest256.sbstore\n-rw-r--r-- 1 francois francois    16 May 31 14:29 safebrowsing/content-track-digest256.pset\n-rw-r--r-- 1 francois francois 64888 May 31 14:29 safebrowsing/content-track-digest256.sbstore\n\nLooking at the file sizes, the base and content list are the same.", "author": "francois@mozilla.com", "id": 13378878, "time": "2018-05-31T21:42:05Z"}, {"text": "Created attachment 8982347\nlist-creation-script.log\n\nFrom the log that ckolos gave me:\n\nTracking protection(tracking-protection-base): publishing 1797 items; file size 57526\nTracking protection(tracking-protection-baseeff): publishing 1 items; file size 51\nTracking protection(tracking-protection-basew3c): publishing 0 items; file size 18\nTracking protection(tracking-protection-content): publishing 1797 items; file size 57526\nTracking protection(tracking-protection-contenteff): publishing 1 items; file size 51\nTracking protection(tracking-protection-contentw3c): publishing 0 items; file size 18\nTracking protection(tracking-protection-ads): publishing 1459 items; file size 46710\nTracking protection(tracking-protection-analytics): publishing 255 items; file size 8181\nTracking protection(tracking-protection-social): publishing 43 items; file size 1397\nEntity whitelist(entity-whitelist): publishing 9051 items; file size 289655\nTracking protection(tracking-protection-standard): publishing 1797 items; file size 57526\nTracking protection(tracking-protection-full): publishing 1797 items; file size 57526\n\nI can see that both tracking-protection-full and tracking-protection-content are broken since they both have the same number of items as tracking-protection-base.\n\nI've attached the list of entries that are on the content-track-digest256 list. gravatar.com is not on there.", "author": "francois@mozilla.com", "id": 13378931, "time": "2018-05-31T21:55:06Z"}, {"text": "Luke, can you take a look at this? Maybe it broke when the new lists were added (bug 1425075)?", "author": "francois@mozilla.com", "id": 13378969, "time": "2018-05-31T21:58:32Z"}, {"text": "Should we have some sort of automated test to catch this the next time it happens?", "author": "ehsan@mozilla.com", "id": 13379037, "time": "2018-05-31T22:34:53Z"}, {"text": "(In reply to :Ehsan Akhgari from comment #8)\n> Should we have some sort of automated test to catch this the next time it\n> happens?\n\nYes, we really should. I filed bug 1466219.", "author": "francois@mozilla.com", "id": 13381263, "time": "2018-06-01T20:03:08Z"}, {"text": "Automated tests are in the works & will cover this regression scenario.", "author": "rbillings@mozilla.com", "id": 13381375, "time": "2018-06-01T20:49:00Z"}, {"text": "This should be the fix for stage lists:\n\nhttps://github.com/mozilla-services/shavar-list-creation-config/pull/28/\n\nOnce that's verified, we can make the same change to the prod.ini config file.", "author": "lcrouch@mozilla.com", "id": 13381526, "time": "2018-06-01T21:51:25Z"}, {"text": "More details ...\n\nIn https://github.com/mozilla-services/shavar-list-creation/commit/e031f7b695debf39c438f6b7fd510b77eee94da4 I set the default disconnect categories for lists to be: \"Advertising,Analytics,Social,Disconnect\"\n\nBut I didn't make corresponding updates to set disconnect_categories to include \"Content\" in the -content and -full shavar lists.\n\nhttps://github.com/mozilla-services/shavar-list-creation-config/pull/28/files sets disconnect_categories including \"Content\" with for the -content and -full shavar lists in the stage.ini.\n\nWhen that's merged and verified, :lnorton should be able to make the same change to the prod.ini config file too.", "author": "lcrouch@mozilla.com", "id": 13381609, "time": "2018-06-01T22:30:18Z"}], "id": 1465528, "priority": "P1", "mentors_detail": [], "comment_count": 13, "version": "unspecified", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox62": "---", "status": "ASSIGNED", "product": "Cloud Services", "cf_status_firefox_esr52": "---", "blocks": [1425075], "qa_contact": "", "see_also": ["https://bugzilla.mozilla.org/show_bug.cgi?id=1466219"], "cf_fx_iteration": "---", "component": "Server: Shavar", "votes": 0, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "---", "cf_status_firefox60": "---", "target_milestone": "---", "is_cc_accessible": true, "cf_rank": null, "groups": [], "url": "", "creator_detail": {"email": "ehsan@mozilla.com", "id": 251051, "name": "ehsan@mozilla.com", "real_name": ":Ehsan Akhgari"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "ehsan@mozilla.com", "id": 251051, "name": "ehsan@mozilla.com", "real_name": ":Ehsan Akhgari"}, {"email": "francois@mozilla.com", "id": 303427, "name": "francois@mozilla.com", "real_name": "Fran\u00e7ois Marier [:francois]"}, {"email": "lcrouch@mozilla.com", "id": 403306, "name": "lcrouch@mozilla.com", "real_name": "Luke Crouch [:groovecoder] [on leave until July 16]"}, {"email": "lnorton@mozilla.com", "id": 618576, "name": "lnorton@mozilla.com", "real_name": "Lesley Norton [:lnorton]"}, {"email": "rbillings@mozilla.com", "id": 382610, "name": "rbillings@mozilla.com", "real_name": "Rebecca Billings [:rbillings]"}, {"email": "senglehardt@mozilla.com", "id": 541587, "name": "senglehardt@mozilla.com", "real_name": "Steven Englehardt [:englehardt]"}], "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-06-01T22:30:18Z", "cf_status_firefox_esr60": "---", "assigned_to": "lcrouch@mozilla.com", "is_open": true, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "francois@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(francois@mozilla.com)"}], "who": "ehsan@mozilla.com", "when": "2018-05-30T16:31:31Z"}, {"changes": [{"removed": "needinfo?(francois@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "francois@mozilla.com", "when": "2018-05-31T21:12:43Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P1"}, {"removed": "NEW", "field_name": "status", "added": "ASSIGNED"}, {"removed": "", "field_name": "keywords", "added": "regression"}, {"removed": "Tracking Protection", "field_name": "component", "added": "Server: Shavar"}, {"removed": "", "field_name": "cc", "added": "lcrouch@mozilla.com"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "lcrouch@mozilla.com"}, {"removed": "", "field_name": "blocks", "added": "1425075"}, {"removed": "Firefox", "field_name": "product", "added": "Cloud Services"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(lcrouch@mozilla.com)"}], "who": "francois@mozilla.com", "when": "2018-05-31T21:58:32Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "ehsan@mozilla.com"}], "who": "ehsan@mozilla.com", "when": "2018-05-31T22:34:53Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "rbillings@mozilla.com"}], "who": "rbillings@mozilla.com", "when": "2018-06-01T15:28:40Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1466219"}, {"removed": "The strict tracking protection list seems to be broken", "field_name": "summary", "added": "The strict tracking protection list is broken and equal to the basic one"}], "who": "francois@mozilla.com", "when": "2018-06-01T20:03:08Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "lnorton@mozilla.com"}, {"removed": "needinfo?(lcrouch@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "lcrouch@mozilla.com", "when": "2018-06-01T21:21:15Z"}], "resolution": "", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}