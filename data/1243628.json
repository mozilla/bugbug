{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "dholbert@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/plain", "id": 8713002}, {"creator": "dholbert@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/plain", "id": 8713007}, {"creator": "tnikkel@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2016-01-28T06:03:53Z", "type_id": 4, "creation_date": "2016-01-28T05:01:43Z", "id": 1331827, "setter": "dholbert@mozilla.com"}], "content_type": "text/plain", "id": 8713029}], "classification": "Components", "creator": "dholbert@mozilla.com", "cc": ["bugs@pettay.fi", "dholbert@mozilla.com", "dveditz@mozilla.com", "tnikkel@gmail.com"], "depends_on": [], "creation_time": "2016-01-28T03:39:00Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "###!!! ASSERTION: Null pres shell: 'mShell', file ../../dist/include/nsPresContext.h, line 171", "id": 1243628, "assigned_to_detail": {"email": "tnikkel@gmail.com", "id": 255010, "name": "tnikkel@gmail.com", "real_name": "Timothy Nikkel (:tnikkel)"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "assigned_to": "tnikkel@gmail.com", "comment_count": 20, "comments": [{"text": "Created attachment 8712999\n(iframe for use in testcase)\n\nSTR:\n 1. Load attached testcase in a debug build.\n 2. Click the \"Click me\" div.\n\nACTUAL RESULTS:\n###!!! ASSERTION: Null pres shell: 'mShell', file ../../dist/include/nsPresContext.h, line 171\n\n(This is inside the \"PresShell()\" method, which promises to return non-null [based on the lack of \"Get\" in its name], and which is asserting because it's about to break that promise.)\n\nEXPECTED RESULTS:\nNo assertion.\n\n\n(I originally posted a version of this testcase on bug 1243583, but I'm spinning it off into its own bug since its backtrace looks sufficiently different.)", "author": "dholbert@mozilla.com", "id": 11115008, "time": "2016-01-28T03:39:00Z"}, {"text": "(In reply to Daniel Holbert [:dholbert] from comment #0)\n> (This is inside the \"PresShell()\" method, which promises to return non-null\n> [based on the lack of \"Get\" in its name], and which is asserting because\n> it's about to break that promise.)\n\nFortunately we don't actually dereference this null pointer & crash, because we null-check the result of PresShell in the caller for some reason (even though we shouldn't have to):\n> 935   if (aPresContext->PresShell()) {\n> 936     pt = pt.RemoveResolution(nsLayoutUtils::GetCurrentAPZResolutionScale(aPresContext->PresShell()));\n> 937   }\nhttp://mxr.mozilla.org/mozilla-central/source/dom/events/Event.cpp?rev=b9f5b9c3d5a1#935", "author": "dholbert@mozilla.com", "id": 11115019, "time": "2016-01-28T03:44:02Z"}, {"text": "Created attachment 8713002\nbacktrace of assertion-failure (with e10s)", "author": "dholbert@mozilla.com", "id": 11115023, "time": "2016-01-28T03:45:09Z"}, {"text": "Created attachment 8713007\nbacktrace of assertion-failure (with e10s disabled)\n\nAttaching backtraces with & without e10s, for an abundance of thoroughness.  (They're the same up until stack level 17 -- nsWindow::DispatchEvent vs PuppetWidget::DispatchEvent, just how we dispatch the click event.)\n\nBottom line, this reproduces regardless of whether e10s is enabled.", "author": "dholbert@mozilla.com", "id": 11115037, "time": "2016-01-28T03:51:06Z"}, {"text": "The nsPresContext in question (whcih we're calling PresShell on) is still alive, happily.  The Event keeps it alive;\n> 260   RefPtr<nsPresContext>     mPresContext;\nhttp://mxr.mozilla.org/mozilla-central/source/dom/events/Event.h?rev=85e218929a7a#260\n\nNonetheless, we've already called PresShell::Destroy() at this point (when the iframe gets removed from the document), which includes a call to mPresContext->SetShell(nullptr).  This is why our later nsPresContext::PresShell() call finds itself with a null pointer.", "author": "dholbert@mozilla.com", "id": 11115062, "time": "2016-01-28T04:02:37Z"}, {"text": "Seems likely that the most proximal cause of this assertion-failure is Bug 1224015, which added this call to PresShell() at stack-level 2 in the backtrace -- the call that asserts.\n\nBut it seems bad that our Event's mPresContext has been detached from its PresShell, before we've finished with it.  Seems like somewhere in the backtrace, we should have a kungfudeathgrip of some sort to keep any affected PresShells alive until after event-handling has been completed.  Or maybe the Event itself should have a refcounted pointer to the PresShell?", "author": "dholbert@mozilla.com", "id": 11115077, "time": "2016-01-28T04:11:17Z"}, {"text": "The presshell nulls out the prescontext's pointer to itself in PresShell::Destroy, which is called in various function in document viewer, which don't seem to be directly tied to ref count (I didn't dig too deep). So even if we hold a reference to the presshell that doesn't obviously stop someone from calling Destroy on the presshell.\n\nPerhaps we should just change the call to nsPresContext::GetPresShell (which doesn't assert) instead of nsPresContext::PresShell?", "author": "tnikkel@gmail.com", "id": 11115120, "time": "2016-01-28T04:52:51Z"}, {"text": "Created attachment 8713029\npatch\n\nThe rest of Event.cpp uses GetPresShell (vs PresShell), so seems like we are on the right track.", "author": "tnikkel@gmail.com", "id": 11115136, "time": "2016-01-28T05:01:43Z"}, {"text": "Comment on attachment 8713029\npatch\n\nAh, good point.\n\nAll these \"GetPresShell\" calls (notably not \"PresShell\") -- combined with the strong nsPresContext reference -- must mean this detached-from-shell situation is a normal-enough occurrence.  So, my concerns at the end of comment 6 (about needing to handle this more robustly) are probably unfounded.\n\nr=me", "author": "dholbert@mozilla.com", "id": 11115216, "time": "2016-01-28T06:03:53Z"}, {"text": "I think we should be OK to open this bug up and land its patch, since there's nothing that's really security-sensitive here, aside from connections to other bugs.\n\nSo, I'm going to mark a few comments & the testcase as 'private' to avoid giving away those connections & the makings of a testcase for one of the worse bugs.", "author": "dholbert@mozilla.com", "id": 11115220, "time": "2016-01-28T06:08:32Z"}, {"text": "dveditz (or anyone with privileges to do so), would you mind opening this bug up? I don't have privileges to remove the 'security-sensitive' flag.\n\nAlternately, if you think we should err on the side of keeping this hidden, I guess we can go through the normal security-approval landing process here (though I don't think it's worth bothering with backports).", "author": "dholbert@mozilla.com", "id": 11115232, "time": "2016-01-28T06:17:00Z"}, {"text": "Comment on attachment 8713029\npatch\n\nLooks like needinfo is taking awhile. We should just land this. Guess sec-approval it is.\n\n[Security approval request comment]\nHow easily could an exploit be constructed based on the patch?\nthe patch does not address a security issue\n\nDo comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?\nno sec problem\n\nWhich older supported branches are affected by this flaw?\naurora maybe beta? I didn't check\n\nIf not all supported branches, which bug introduced the flaw?\nit's mentioned in the comments here somewhere\n\nDo you have backports for the affected branches? If not, how different, hard to create, and risky will they be?\ntrivial\n\nHow likely is this patch to cause regressions; how much testing does it need?\nsafe patch", "author": "tnikkel@gmail.com", "id": 11120887, "time": "2016-01-29T19:09:57Z"}, {"text": "(In reply to Timothy Nikkel (:tnikkel) from comment #14)\n> [Security approval request comment]\n> Which older supported branches are affected by this flaw?\n> aurora maybe beta? I didn't check\n> \n> If not all supported branches, which bug introduced the flaw?\n> it's mentioned in the comments here somewhere\n\nYeah, comment 6 -- this was introduced in bug 1224015, which means versions 45 and newer are affected (but no need to backport; the patch doesn't change behavior in opt builds at all. This bug's patch is effectively just making us bypass an assertion that we can't & don't need to depend on.)", "author": "dholbert@mozilla.com", "id": 11120915, "time": "2016-01-29T19:17:06Z"}, {"text": "Comment on attachment 8713029\npatch\n\ntn, looks like you're good to land.", "author": "dholbert@mozilla.com", "id": 11121605, "time": "2016-01-29T22:21:26Z"}, {"text": "Comment on attachment 8713029\npatch\n\nNo sec-approval+ needed so clearing.", "author": "abillings@mozilla.com", "id": 11121606, "time": "2016-01-29T22:21:26Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/9cea9bfd3244", "author": "pulsebot@bots.tld", "id": 11124545, "time": "2016-02-01T08:24:42Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/9cea9bfd3244", "author": "cbook@mozilla.com", "id": 11125368, "time": "2016-02-01T14:46:32Z"}], "cf_last_resolved": "2016-02-01T14:46:32Z", "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "Trunk", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2016-02-02T20:01:24Z", "cf_platform_rel": "---", "product": "Core", "cf_status_firefox_esr52": "---", "blocks": [], "qa_contact": "", "see_also": [], "cf_fx_iteration": "---", "component": "DOM: Events", "votes": 0, "groups": [], "cf_status_firefox60": "---", "target_milestone": "mozilla47", "cf_status_firefox47": "fixed", "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "dholbert@mozilla.com", "id": 278074, "name": "dholbert@mozilla.com", "real_name": "Daniel Holbert [:dholbert]"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "bugs@pettay.fi", "id": 39966, "name": "bugs@pettay.fi", "real_name": "Olli Pettay [:smaug]"}, {"email": "dholbert@mozilla.com", "id": 278074, "name": "dholbert@mozilla.com", "real_name": "Daniel Holbert [:dholbert]"}, {"email": "dveditz@mozilla.com", "id": 1689, "name": "dveditz@mozilla.com", "real_name": "Daniel Veditz [:dveditz]"}, {"email": "tnikkel@gmail.com", "id": 255010, "name": "tnikkel@gmail.com", "real_name": "Timothy Nikkel (:tnikkel)"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "cf_qa_whiteboard": "", "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "bugs@pettay.fi, tnikkel@gmail.com"}], "who": "dholbert@mozilla.com", "when": "2016-01-28T03:39:26Z"}, {"changes": [{"field_name": "attachments.description", "removed": "backtrace of assertion-failure (in e10s build)", "attachment_id": 8713002, "added": "backtrace of assertion-failure (with e10s)"}], "who": "dholbert@mozilla.com", "when": "2016-01-28T03:45:50Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "dholbert@mozilla.com"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "tnikkel@gmail.com"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8713029, "added": "review?(dholbert@mozilla.com)"}], "who": "tnikkel@gmail.com", "when": "2016-01-28T05:01:43Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(dholbert@mozilla.com)", "attachment_id": 8713029, "added": "review+"}], "who": "dholbert@mozilla.com", "when": "2016-01-28T06:03:53Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "dveditz@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(dveditz@mozilla.com)"}], "who": "dholbert@mozilla.com", "when": "2016-01-28T06:17:00Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8713029, "added": "sec-approval?"}], "who": "tnikkel@gmail.com", "when": "2016-01-29T19:09:57Z"}, {"changes": [{"removed": "core-security", "field_name": "groups", "added": ""}, {"removed": "needinfo?(dveditz@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "dveditz@mozilla.com", "when": "2016-01-29T22:19:36Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(tnikkel@gmail.com)"}, {"field_name": "flagtypes.name", "removed": "sec-approval?", "attachment_id": 8713029, "added": ""}], "who": "dholbert@mozilla.com", "when": "2016-01-29T22:21:26Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "sec-approval?", "attachment_id": 8713029, "added": ""}], "who": "abillings@mozilla.com", "when": "2016-01-29T22:21:26Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "checkin-needed"}], "who": "tnikkel@gmail.com", "when": "2016-01-30T04:37:55Z"}, {"changes": [{"removed": "checkin-needed", "field_name": "keywords", "added": ""}], "who": "pulsebot@bots.tld", "when": "2016-02-01T08:24:42Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla47"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2016-02-01 06:46:32"}, {"removed": "affected", "field_name": "cf_status_firefox47", "added": "fixed"}], "who": "cbook@mozilla.com", "when": "2016-02-01T14:46:32Z"}, {"changes": [{"removed": "needinfo?(tnikkel@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "tnikkel@gmail.com", "when": "2016-02-02T20:01:24Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}