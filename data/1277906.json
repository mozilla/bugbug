{"status": "VERIFIED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "jdescottes@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2016-06-03T20:40:28Z", "type_id": 748, "creation_date": "2016-06-03T19:38:46Z", "id": 1405808, "setter": "bgrinstead@mozilla.com"}], "content_type": "text/x-review-board-request", "id": 8759799}, {"creator": "jdescottes@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2016-06-03T22:30:34Z", "type_id": 748, "creation_date": "2016-06-03T22:23:00Z", "id": 1405925, "setter": "bgrinstead@mozilla.com"}], "content_type": "text/x-review-board-request", "id": 8759800}], "classification": "Client Software", "creator": "jdescottes@mozilla.com", "cc": ["bgrinstead@mozilla.com", "mmucci@mozilla.com", "paul.silaghi@softvision.ro"], "depends_on": [], "creation_time": "2016-06-03T17:08:19Z", "cf_user_story": "", "assigned_to": "jdescottes@mozilla.com", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "HTML Tooltip keeps the focus after being hidden", "id": 1277906, "assigned_to_detail": {"email": "jdescottes@mozilla.com", "id": 559949, "name": "jdescottes@mozilla.com", "real_name": "Julian Descottes [:jdescottes][:julian]"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "qa_contact_detail": {"email": "adalucin@gmail.com", "id": 458187, "name": "adalucin@gmail.com", "real_name": "Ada [:adalucinet]"}, "comment_count": 18, "comments": [{"text": "Regression from Bug 1276876, which I landed on fx-team earlier today.\n\nSTRs:\n- open data:text/html,<div style=\"font-family: 'Comic Sans MS'\">Inspect me</div>\n- inspect the \"Inspect me\" element\n- select the rule-view if not already selected\n- focus an element (the \"Filter styles\" input for instance)\n- mouseover the font-family value to display the preview tooltip\n- mouseout the font-family value to hide the tooltip\n\nER: The focus should still be in the Filter styles input\nAR: Focus is gone. Also keyboard shortcuts no longer work.\n\nRight now the HTML Tooltip is using autofocus by default, but is not restoring focus after being hidden. This bug should be used to address two issues:\n- HTMLTooltip should use autofocus only if opt-in\n- if autofocus is on the previously focused element should be focused again when the tooltip is hidden", "author": "jdescottes@mozilla.com", "id": 11462042, "time": "2016-06-03T17:08:19Z"}, {"text": "Taking the bug.", "author": "jdescottes@mozilla.com", "id": 11462046, "time": "2016-06-03T17:09:11Z"}, {"text": "Created attachment 8759799\nBug 1277906 - part1: change HTMLTooltip default autofocus value to false;\n\nGiven the current usage of the HTMLTooltip, I think having the autofocus as\nan opt-in behavior makes more sense.\n\nReview commit: https://reviewboard.mozilla.org/r/57670/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/57670/", "author": "jdescottes@mozilla.com", "id": 11462563, "time": "2016-06-03T19:38:46Z"}, {"text": "Created attachment 8759800\nBug 1277906 - part2: focus previous active element when hiding HTML Tooltip;\n\nReview commit: https://reviewboard.mozilla.org/r/57672/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/57672/", "author": "jdescottes@mozilla.com", "id": 11462564, "time": "2016-06-03T19:38:46Z"}, {"text": "Brian: While working on this bug I realized I needed to update the \"autofocus\" test and logic for Bug 1266450.\nHowever I want to land this fix first, because the focus-stealing can become annoying pretty quickly.", "author": "jdescottes@mozilla.com", "id": 11462572, "time": "2016-06-03T19:42:50Z"}, {"text": "Comment on attachment 8759799\nBug 1277906 - part1: change HTMLTooltip default autofocus value to false;\n\nhttps://reviewboard.mozilla.org/r/57670/#review54526", "author": "bgrinstead@mozilla.com", "id": 11462729, "time": "2016-06-03T20:40:28Z"}, {"text": "Comment on attachment 8759800\nBug 1277906 - part2: focus previous active element when hiding HTML Tooltip;\n\nhttps://reviewboard.mozilla.org/r/57672/#review54524\n\nSee comments.  Feel free to land part 1 and break this out into another bug if you don't have time to address this before the merge day this weekend.\n\n::: devtools/client/shared/widgets/HTMLTooltip.js:194\n(Diff revision 1)\n>        }\n>  \n>        this.container.classList.add(\"tooltip-visible\");\n>  \n>        this.attachEventsTimer = this.doc.defaultView.setTimeout(() => {\n> +        this._focusedElement = this.doc.activeElement;\n\nSeems like should only get set if this.autofocus is true, otherwise there's a chance it'll be changing focus when the tooltip hides, when it hasn't been stolen\n\n::: devtools/client/shared/widgets/HTMLTooltip.js:216\n(Diff revision 1)\n>      if (this.isVisible()) {\n>        this.topWindow.removeEventListener(\"click\", this._onClick, true);\n>        this.container.classList.remove(\"tooltip-visible\");\n>        this.emit(\"hidden\");\n> +\n> +      if (this._focusedElement) {\n\nI think we should also check to see if the tooltip is currently focused before restoring.  LIke if Element A is focused, tooltip is shown, then Element B gets focused before the tooltip is hidden, then the tooltip is hidden, then focus would get restored to Element A.", "author": "bgrinstead@mozilla.com", "id": 11462738, "time": "2016-06-03T20:41:54Z"}, {"text": "Comment on attachment 8759800\nBug 1277906 - part2: focus previous active element when hiding HTML Tooltip;\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/57672/diff/1-2/", "author": "jdescottes@mozilla.com", "id": 11462991, "time": "2016-06-03T22:23:00Z"}, {"text": "https://reviewboard.mozilla.org/r/57672/#review54524\n\nThanks for the reviews! I will land part1 to be safe.\n\n> Seems like should only get set if this.autofocus is true, otherwise there's a chance it'll be changing focus when the tooltip hides, when it hasn't been stolen\n\nI think that with the second modification you suggested (restore focus only if active element is in tooltip), it's actually better to keep this outside of the if(autofocus).\n\nImagine you have a tooltip with autofocus:false ; you interact with the tooltip and focus an element inside it. When you close the tooltip, it would still be nice to have the focus back somewhere usable. What do you think?\n\n> I think we should also check to see if the tooltip is currently focused before restoring.  LIke if Element A is focused, tooltip is shown, then Element B gets focused before the tooltip is hidden, then the tooltip is hidden, then focus would get restored to Element A.\n\nGood point, I agree! I didn't think about this use case initially because the tooltips are supposed to close themselves on an outisde click, but it's true that a focus could still occur. Updated the test case to check this as well.", "author": "jdescottes@mozilla.com", "id": 11463000, "time": "2016-06-03T22:28:17Z"}, {"text": "Comment on attachment 8759800\nBug 1277906 - part2: focus previous active element when hiding HTML Tooltip;\n\nhttps://reviewboard.mozilla.org/r/57672/#review54570\n\n::: devtools/client/shared/test/browser_html_tooltip-03.js:93\n(Diff revision 2)\n> +  is(getFocusedDocument(doc), doc, \"Focus is back in the XUL document\");\n>  \n>    yield hideTooltip(tooltip);\n> +  is(getFocusedDocument(doc), doc, \"Focus is still in the XUL document\");\n> +\n> +  ok(isAncestor(doc.querySelector(\"#box3-input\"), doc.activeElement), \"test\");\n\nCan do doc.activeElement.closest(\"#box3-input\") instead of adding the helper function\n\nAlso, the assertion string needs updating", "author": "bgrinstead@mozilla.com", "id": 11463005, "time": "2016-06-03T22:30:34Z"}, {"text": "Comment on attachment 8759799\nBug 1277906 - part1: change HTMLTooltip default autofocus value to false;\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/57670/diff/1-2/", "author": "jdescottes@mozilla.com", "id": 11463042, "time": "2016-06-03T22:43:05Z"}, {"text": "Comment on attachment 8759800\nBug 1277906 - part2: focus previous active element when hiding HTML Tooltip;\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/57672/diff/2-3/", "author": "jdescottes@mozilla.com", "id": 11463043, "time": "2016-06-03T22:43:05Z"}, {"text": "https://reviewboard.mozilla.org/r/57672/#review54570\n\n> Can do doc.activeElement.closest(\"#box3-input\") instead of adding the helper function\n> \n> Also, the assertion string needs updating\n\nIndeed, I was trying to use contains() without success, but closest() works fine here, thanks a lot for the suggestion. And sorry about the temporary commit message :(", "author": "jdescottes@mozilla.com", "id": 11463051, "time": "2016-06-03T22:48:56Z"}, {"text": "Try is green (https://treeherder.mozilla.org/#/jobs?repo=try&revision=5428191e513b), landing.", "author": "jdescottes@mozilla.com", "id": 11463401, "time": "2016-06-04T06:57:21Z"}, {"text": "Pushed by jdescottes@mozilla.com:\nhttps://hg.mozilla.org/integration/fx-team/rev/a770e8c521f7\npart1: change HTMLTooltip default autofocus value to false;r=bgrins\nhttps://hg.mozilla.org/integration/fx-team/rev/c2778bbb1938\npart2: focus previous active element when hiding HTML Tooltip;r=bgrins", "author": "pulsebot@bots.tld", "id": 11463402, "time": "2016-06-04T06:58:49Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/a770e8c521f7\nhttps://hg.mozilla.org/mozilla-central/rev/c2778bbb1938", "author": "cbook@mozilla.com", "id": 11465531, "time": "2016-06-06T10:01:36Z"}, {"text": "Reproduced on fx-team 49.0a1 (2016-06-03) Win 7.\nVerified fixed Nightly 49.0a1 (2016-06-06).", "author": "paul.silaghi@softvision.ro", "id": 11468939, "time": "2016-06-07T12:44:05Z"}, {"text": "Also verified fixed on OS X 10.11, Ubuntu 14.04.", "author": "paul.silaghi@softvision.ro", "id": 11469083, "time": "2016-06-07T13:35:51Z"}], "cf_last_resolved": "2016-06-06T10:01:36Z", "priority": "P1", "mentors_detail": [], "cf_crash_signature": "", "version": "Trunk", "cf_qa_whiteboard": "[qe-dthtml]", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2016-06-07T13:48:41Z", "cf_platform_rel": "---", "product": "Firefox", "cf_status_firefox_esr52": "---", "blocks": [1259121, 1276876], "qa_contact": "adalucin@gmail.com", "see_also": [], "cf_fx_iteration": "49.3 - Jun 6", "component": "Developer Tools: Shared Components", "votes": 0, "cf_status_firefox49": "verified", "groups": [], "cf_status_firefox60": "---", "target_milestone": "Firefox 49", "is_cc_accessible": true, "url": "", "creator_detail": {"email": "jdescottes@mozilla.com", "id": 559949, "name": "jdescottes@mozilla.com", "real_name": "Julian Descottes [:jdescottes][:julian]"}, "whiteboard": "[devtools-html]", "mentors": [], "cc_detail": [{"email": "bgrinstead@mozilla.com", "id": 476442, "name": "bgrinstead@mozilla.com", "real_name": "Brian Grinstead [:bgrins]"}, {"email": "mmucci@mozilla.com", "id": 458208, "name": "mmucci@mozilla.com", "real_name": "Marco Mucci [:MarcoM]"}, {"email": "paul.silaghi@softvision.ro", "id": 428011, "name": "paul.silaghi@softvision.ro", "real_name": "Paul Silaghi, QA [:pauly]"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "history": [{"changes": [{"removed": "--", "field_name": "priority", "added": "P1"}, {"removed": "NEW", "field_name": "status", "added": "ASSIGNED"}, {"removed": "", "field_name": "blocks", "added": "1259121, 1276876"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "jdescottes@mozilla.com"}, {"removed": "", "field_name": "whiteboard", "added": "[devtools-html] [triage]"}], "who": "jdescottes@mozilla.com", "when": "2016-06-03T17:09:11Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mmucci@mozilla.com"}], "who": "mmucci@mozilla.com", "when": "2016-06-03T17:20:32Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8759799, "added": "review?(bgrinstead@mozilla.com)"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8759800, "added": "review?(bgrinstead@mozilla.com)"}, {"removed": "", "field_name": "cc", "added": "bgrinstead@mozilla.com"}], "who": "jdescottes@mozilla.com", "when": "2016-06-03T19:38:46Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bgrinstead@mozilla.com)", "attachment_id": 8759799, "added": "review+"}], "who": "bgrinstead@mozilla.com", "when": "2016-06-03T20:40:28Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bgrinstead@mozilla.com)", "attachment_id": 8759800, "added": ""}], "who": "bgrinstead@mozilla.com", "when": "2016-06-03T20:41:54Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8759800, "added": "review?(bgrinstead@mozilla.com)"}], "who": "jdescottes@mozilla.com", "when": "2016-06-03T22:23:00Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bgrinstead@mozilla.com)", "attachment_id": 8759800, "added": "review+"}], "who": "bgrinstead@mozilla.com", "when": "2016-06-03T22:30:34Z"}, {"changes": [{"removed": "---", "field_name": "cf_fx_iteration", "added": "49.3 - Jun 6"}, {"removed": "", "field_name": "qa_contact", "added": "alexandra.lucinet@softvision.ro"}, {"removed": "[devtools-html] [triage]", "field_name": "whiteboard", "added": "[devtools-html]"}, {"removed": "", "field_name": "flagtypes.name", "added": "qe-verify+"}], "who": "mmucci@mozilla.com", "when": "2016-06-04T18:41:37Z"}, {"changes": [{"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "Firefox 49"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2016-06-06 10:01:36"}, {"removed": "affected", "field_name": "cf_status_firefox49", "added": "fixed"}], "who": "cbook@mozilla.com", "when": "2016-06-06T10:01:36Z"}, {"changes": [{"removed": "RESOLVED", "field_name": "status", "added": "VERIFIED"}, {"removed": "", "field_name": "cc", "added": "paul.silaghi@softvision.ro"}, {"removed": "fixed", "field_name": "cf_status_firefox49", "added": "verified"}], "who": "paul.silaghi@softvision.ro", "when": "2016-06-07T12:44:05Z"}, {"changes": [{"removed": "[devtools-html]", "field_name": "whiteboard", "added": "[devtools-html], [qe-dthtml]"}], "who": "paul.silaghi@softvision.ro", "when": "2016-06-07T13:35:51Z"}, {"changes": [{"removed": "", "field_name": "cf_qa_whiteboard", "added": "[qe-dthtml]"}, {"removed": "[devtools-html], [qe-dthtml]", "field_name": "whiteboard", "added": "[devtools-html]"}, {"removed": "qe-verify+", "field_name": "flagtypes.name", "added": ""}], "who": "adalucin@gmail.com", "when": "2016-06-07T13:48:41Z"}]}