{"cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "classification": "Components", "creator": "gps@mozilla.com", "cc": ["bdahl@mozilla.com", "bgrinstead@mozilla.com", "coop@mozilla.com", "gbrown@mozilla.com", "hskupin@gmail.com", "jmaher@mozilla.com", "mcastelluccio@mozilla.com", "mrbkap@mozilla.com", "myk@mykzilla.org", "tanvi@mozilla.com", "ted@mielczarek.org"], "depends_on": [], "creation_time": "2018-01-10T20:57:16Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": [], "summary": "Investigate container tabs for running tests in parallel", "cf_last_resolved": null, "attachments": [], "assigned_to_detail": {"email": "nobody@mozilla.org", "id": 1, "name": "nobody@mozilla.org", "real_name": "Nobody; OK to take it and work on it"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_crash_signature": "", "comments": [{"text": "Had an interesting discussion at lunch today. I noticed that we are spending a lot of money running GPU-enabled EC2 instances. Mentioned that to bdahl since his work to enable headless Firefox could result in us significantly lowering our AWS bill by moving away from GPU-enabled instances. We were lamenting the general issue with only being able to run a single test within a process (even if we start aggressively executing tests in headless mode we'll likely still want to run them in graphics mode periodically as a sanity check). mrbkap made the (IMO fantastic) suggestion that we could leverage Firefox container tabs to enable concurrent test execution *within the same process*.\n\nEssentially, the test harness would spin up multiple tabs. Each tab would get its own content process and container tab. For all intents and purposes, they would behave like separate Firefox instances because of process separation, cookie separation, etc. The test harness (running as chrome-privileged code) could dispatch tests to containers/tabs when the tab is idle.\n\nThings to work out:\n\n* Tests requiring focus, clipboard, new windows, and other global state. (I think there are efforts to tag tests with this metadata and make tests fail if they aren't annotated. If not, this is a tractable problem.)\n* Enforcing separate processes per tab. mrbkap made it sound like there may need to be some kind of special API the test harness would need to use.\n* Stability/appropriateness of container tabs for this use case.\n* Dealing with the long tail of tests that have implicit run-time dependencies. I /think/ jmaher or someone once did a Try push where each test was executed in its own process and this teased out tests relying on state from a previous test. We would need to solve this class of test reliability problems before any concurrent execution could be used.\n* Relative priority against mass running tests in headless mode. Headless mode is probably easier to roll out. And headless mode supports tests that require focus. But if we go all-in on headless mode, we still need to run tests in a graphical environment. So it still makes sense to support parallel test execution in a graphical environment.\n\nI'm not sure if this bug is actionable. But it would probably be useful if mrbkap, tanvi, etc chimed in with technical feasibility expertise from the gecko layer.", "author": "gps@mozilla.com", "id": 12959416, "time": "2018-01-10T20:57:16Z"}, {"text": "Additional to that I wonder how the logging would work. We should not garble everything because each test logs the results in-between the others. Especially with Firefox default log output it could become not useful at all.", "author": "hskupin@gmail.com", "id": 12959434, "time": "2018-01-10T21:07:03Z"}, {"text": "We have Python code starting the Firefox process. We have privileged JS inside Firefox coordinating the tests. If the appropriate \"markers\" are inserted into the log stream during test execution, I would think/hope it would be possible to associate log events to tests based on the PID those messages came from. Events coming from main/shared PID or threads could be more difficult to tease out. A mitigation for that is to run failing tests in isolation so there is a \"clean\" log for that failure.", "author": "gps@mozilla.com", "id": 12959466, "time": "2018-01-10T21:14:20Z"}, {"text": "here is a summary of tests which cannot repeat themselves:\nhttps://docs.google.com/spreadsheets/d/1OZp9xgGJ5NYy8kDRZaUoJsoQrL7wf2xRBtZ_akIk5-c/edit#gid=0\n\nwe also have bug 1419135 on file for running mochitest in parallel", "author": "jmaher@mozilla.com", "id": 12959488, "time": "2018-01-10T21:21:55Z"}], "id": 1429583, "priority": "P3", "mentors_detail": [], "comment_count": 4, "version": "Version 3", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox62": "---", "status": "NEW", "product": "Testing", "cf_fx_iteration": "---", "blocks": [1271162], "qa_contact": "", "see_also": ["https://bugzilla.mozilla.org/show_bug.cgi?id=1419135"], "cf_status_firefox_esr52": "---", "component": "General", "votes": 0, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "---", "cf_status_firefox60": "---", "target_milestone": "---", "is_cc_accessible": true, "groups": [], "url": "", "creator_detail": {"email": "gps@mozilla.com", "id": 420446, "name": "gps@mozilla.com", "real_name": "Gregory Szorc [:gps]"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "bdahl@mozilla.com", "id": 425126, "name": "bdahl@mozilla.com", "real_name": "Brendan Dahl [:bdahl]"}, {"email": "bgrinstead@mozilla.com", "id": 476442, "name": "bgrinstead@mozilla.com", "real_name": "Brian Grinstead [:bgrins]"}, {"email": "coop@mozilla.com", "id": 30066, "name": "coop@mozilla.com", "real_name": "Chris Cooper [:coop]"}, {"email": "gbrown@mozilla.com", "id": 411471, "name": "gbrown@mozilla.com", "real_name": "Geoff Brown [:gbrown]"}, {"email": "hskupin@gmail.com", "id": 76551, "name": "hskupin@gmail.com", "real_name": "Henrik Skupin (:whimboo)"}, {"email": "jmaher@mozilla.com", "id": 324370, "name": "jmaher@mozilla.com", "real_name": "Joel Maher ( :jmaher ) (UTC-4)"}, {"email": "mcastelluccio@mozilla.com", "id": 420453, "name": "mcastelluccio@mozilla.com", "real_name": "Marco Castelluccio [:marco]"}, {"email": "mrbkap@mozilla.com", "id": 69426, "name": "mrbkap@mozilla.com", "real_name": "Blake Kaplan (:mrbkap)"}, {"email": "myk@mykzilla.org", "id": 27300, "name": "myk@mykzilla.org", "real_name": "Myk Melez [:myk] [@mykmelez]"}, {"email": "tanvi@mozilla.com", "id": 430652, "name": "tanvi@mozilla.com", "real_name": "Tanvi Vyas - ooo[:tanvi]"}, {"email": "ted@mielczarek.org", "id": 39022, "name": "ted@mielczarek.org", "real_name": "Ted Mielczarek [:ted.mielczarek]"}], "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-05-09T16:43:13Z", "cf_status_firefox_esr60": "---", "assigned_to": "nobody@mozilla.org", "is_open": true, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "mcastelluccio@mozilla.com"}], "who": "mcastelluccio@mozilla.com", "when": "2018-01-10T21:01:57Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "hskupin@gmail.com"}], "who": "hskupin@gmail.com", "when": "2018-01-10T21:07:03Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1419135"}], "who": "jmaher@mozilla.com", "when": "2018-01-10T22:35:18Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "bgrinstead@mozilla.com"}], "who": "bgrinstead@mozilla.com", "when": "2018-01-10T22:56:38Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "myk@mykzilla.org"}], "who": "myk@mykzilla.org", "when": "2018-01-11T21:10:43Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P3"}, {"removed": "", "field_name": "cc", "added": "gbrown@mozilla.com"}], "who": "gbrown@mozilla.com", "when": "2018-05-09T16:43:13Z"}], "resolution": "", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}