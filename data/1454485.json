{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "bugmail@mozilla.staktrace.com", "mentors_detail": [], "depends_on": [], "cf_status_firefox_esr60": "---", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": [], "cc_detail": [{"email": "botond@mozilla.com", "id": 474533, "name": "botond@mozilla.com", "real_name": "Botond Ballo [:botond]"}], "cf_last_resolved": "2018-04-18T11:00:13Z", "attachments": [{"creator": "bugmail@mozilla.staktrace.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-17T16:56:27Z", "type_id": 4, "creation_date": "2018-04-17T16:00:49Z", "id": 1745089, "setter": "botond@mozilla.com"}], "content_type": "text/x-review-board-request", "id": 8968579}, {"creator": "bugmail@mozilla.staktrace.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-17T17:08:43Z", "type_id": 4, "creation_date": "2018-04-17T16:00:49Z", "id": 1745090, "setter": "botond@mozilla.com"}], "content_type": "text/x-review-board-request", "id": 8968580}], "votes": 0, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 14, "comments": [{"text": "Follow-up from bug 1451469 comment 18, we should be able to turn ScrollThumbInfo::mTargetGuid into just a layers id and use the ViewId from the mThumbData.mTargetViewId.\n\nBut, this implies that the call at [1] is storing duplicate information into the HitTestingTreeNode itself, because the GetScrollbarTargetContainerId() call just reads the target scrollid from the layer's ScrollbarData field, which is the same thing passed as the third argument in [1]. i.e. we pass the whole ScrollbarData as well as the target scroll id, which is redundant. So that can be trimmed as well.\n\nBut then looking further, it looks like the WebRender codepath uses a different storage mechanism for scrollbar container layers and that's broken, because the ScrollbarData in WebRenderLayerScrollData is going to be empty (it's not updated at [2]). So that needs fixing too.\n\nThere might more things that need fixing, this bug is to audit all the code and make sure it's good.\n\n[1] https://searchfox.org/mozilla-central/rev/bd326a2a6b729dc62a5aee57354a97ceac4d1dc0/gfx/layers/apz/src/APZCTreeManager.cpp#866-868\n[2] https://searchfox.org/mozilla-central/rev/bd326a2a6b729dc62a5aee57354a97ceac4d1dc0/layout/painting/nsDisplayList.cpp#7058-7059", "author": "bugmail@mozilla.staktrace.com", "id": 13210766, "time": "2018-04-16T20:24:31Z"}, {"text": "The WR side of things might be a regression from bug 1420512. Implementing the change described at https://bugzilla.mozilla.org/show_bug.cgi?id=1453469#c6 will make the differences between WR and non-WR more obvious, and will make the fixing easier as well since we'll just need to make sure we populate the same ScrollbarData fields in both cases. We can then drop some of the redundant fields from WebRenderLayerScrollData.", "author": "bugmail@mozilla.staktrace.com", "id": 13210848, "time": "2018-04-16T20:53:16Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=486f70ea84cdd661cec8253c50f8dfb29769ed16 (the try push includes both patches even though only one is visible)", "author": "bugmail@mozilla.staktrace.com", "id": 13212843, "time": "2018-04-17T15:59:59Z"}, {"text": "Created attachment 8968579\nBug 1454485 - Remove redundant fields from WebRenderLayerScrollData and ensure the ScrollbarData is always correctly populated instead.\n\nReview commit: https://reviewboard.mozilla.org/r/237274/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/237274/", "author": "bugmail@mozilla.staktrace.com", "id": 13212844, "time": "2018-04-17T16:00:49Z"}, {"text": "Created attachment 8968580\nBug 1454485 - Stop passing around the scroll view and container direction since it's already in the scrollbar data.\n\nReview commit: https://reviewboard.mozilla.org/r/237276/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/237276/", "author": "bugmail@mozilla.staktrace.com", "id": 13212845, "time": "2018-04-17T16:00:49Z"}, {"text": "Comment on attachment 8968579\nBug 1454485 - Remove redundant fields from WebRenderLayerScrollData and ensure the ScrollbarData is always correctly populated instead.\n\nhttps://reviewboard.mozilla.org/r/237274/#review243088\n\nThanks! (I thought of this as a further simplification while reviewing bug 1453469, but failed to realize that the intermediate state was not actually correct.)", "author": "botond@mozilla.com", "id": 13213016, "time": "2018-04-17T16:56:27Z"}, {"text": "Comment on attachment 8968580\nBug 1454485 - Stop passing around the scroll view and container direction since it's already in the scrollbar data.\n\nhttps://reviewboard.mozilla.org/r/237276/#review243090\n\n::: gfx/layers/LayerAttributes.h:284\n(Diff revision 1)\n> -\n>    const ScrollbarData& GetScrollbarData() const {\n>      return mScrollbarData;\n>    }\n>  \n>    Maybe<ScrollDirection> GetScrollbarContainerDirection() const {\n\nConsider inlining this into Layer::IsScrollbarContainer(), which is the only remaining call site.\n\n::: gfx/layers/Layers.h\n(Diff revision 1)\n>    LayerPoint GetFixedPositionAnchor() { return mSimpleAttrs.GetFixedPositionAnchor(); }\n>    int32_t GetFixedPositionSides() { return mSimpleAttrs.GetFixedPositionSides(); }\n>    FrameMetrics::ViewID GetStickyScrollContainerId() { return mSimpleAttrs.GetStickyScrollContainerId(); }\n>    const LayerRectAbsolute& GetStickyScrollRangeOuter() { return mSimpleAttrs.GetStickyScrollRangeOuter(); }\n>    const LayerRectAbsolute& GetStickyScrollRangeInner() { return mSimpleAttrs.GetStickyScrollRangeInner(); }\n> -  FrameMetrics::ViewID GetScrollbarTargetViewId() { return mSimpleAttrs.GetScrollbarTargetViewId(); }\n\nAs your try build points out, this has a call site in Android-only code in AsyncCompositionManager.\n\n::: gfx/layers/Layers.cpp:1819\n(Diff revision 1)\n>      aStream << \" [is3DContextLeaf]\";\n>    }\n> -  if (GetScrollbarContainerDirection().isSome()) {\n> +  if (IsScrollbarContainer()) {\n>      aStream << \" [scrollbar]\";\n>    }\n>    if (Maybe<ScrollDirection> thumbDirection = GetScrollbarData().mDirection) {\n\nThere is actually another (minor) regression from bug 1420512 here, which we might as well fix while we're at it: we're only supposed to enter this branch and print [vscrollbar=]/[hscrollbar=] for thumb layers, but since bug 1420512 we now do for scrollbar container layers as well. The condition should be revised to check |GetScrollbarData().mScrollbarLayerType == ScrollbarLayerType::Thumb| as well. (Feel free to add a ScrollbarData::IsThumb() helper.)", "author": "botond@mozilla.com", "id": 13213042, "time": "2018-04-17T17:08:43Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=5be66f990aebaaa689cbd6cf09174ea87991917d has all the comments addressed and the android build fixed.", "author": "bugmail@mozilla.staktrace.com", "id": 13213349, "time": "2018-04-17T18:53:16Z"}, {"text": "Comment on attachment 8968579\nBug 1454485 - Remove redundant fields from WebRenderLayerScrollData and ensure the ScrollbarData is always correctly populated instead.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/237274/diff/1-2/", "author": "bugmail@mozilla.staktrace.com", "id": 13213353, "time": "2018-04-17T18:55:54Z"}, {"text": "Comment on attachment 8968580\nBug 1454485 - Stop passing around the scroll view and container direction since it's already in the scrollbar data.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/237276/diff/1-2/", "author": "bugmail@mozilla.staktrace.com", "id": 13213354, "time": "2018-04-17T18:55:54Z"}, {"text": "We're sorry, Autoland could not rebase your commits for you automatically. Please manually rebase your commits and try again.\n\nhg error in cmd: hg rebase -s e2b83f17ef35a581e9da4a398a6ce52cd9819317 -d 8f31c3153ea0: rebasing 458895:e2b83f17ef35 \"Bug 1454485 - Remove redundant fields from WebRenderLayerScrollData and ensure the ScrollbarData is always correctly populated instead. r=botond\"\nmerging layout/painting/nsDisplayList.cpp\nwarning: conflicts while merging layout/painting/nsDisplayList.cpp! (edit, then use 'hg resolve --mark')\nunresolved conflicts (see hg resolve, then hg rebase --continue)", "author": "autoland@mozilla.bugs", "id": 13213362, "time": "2018-04-17T18:58:50Z"}, {"text": "Oh, I had written the patches on top of inbound which is where bug 1453469 landed. So they need to land on inbound, or wait until bug 1453469 gets merged over to autoland.", "author": "bugmail@mozilla.staktrace.com", "id": 13213379, "time": "2018-04-17T19:04:00Z"}, {"text": "Pushed by kgupta@mozilla.com:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/945d0f8a4594\nRemove redundant fields from WebRenderLayerScrollData and ensure the ScrollbarData is always correctly populated instead. r=botond\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/7d1e0a7e3e13\nStop passing around the scroll view and container direction since it's already in the scrollbar data. r=botond", "author": "pulsebot@bots.tld", "id": 13213384, "time": "2018-04-17T19:05:04Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/945d0f8a4594\nhttps://hg.mozilla.org/mozilla-central/rev/7d1e0a7e3e13", "author": "ccoroiu@mozilla.com", "id": 13215037, "time": "2018-04-18T11:00:13Z"}], "id": 1454485, "priority": "--", "cc": ["botond@mozilla.com"], "cf_crash_signature": "", "version": "unspecified", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_thunderbird_esr60": "---", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1451469, 1455182], "qa_contact": "", "creation_time": "2018-04-16T20:24:31Z", "cf_status_firefox_esr52": "---", "component": "Panning and Zooming", "assigned_to_detail": {"email": "bugmail@mozilla.staktrace.com", "id": 426788, "name": "bugmail@mozilla.staktrace.com", "real_name": "Kartikaya Gupta (email:kats@mozilla.com)"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "fixed", "cf_status_firefox60": "---", "target_milestone": "mozilla61", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "bugmail@mozilla.staktrace.com", "id": 426788, "name": "bugmail@mozilla.staktrace.com", "real_name": "Kartikaya Gupta (email:kats@mozilla.com)"}, "whiteboard": "", "mentors": [], "summary": "Remove redundant storage of scrollbar target scroll id, ensure the right fields are propagated for scrollbar containers with WR", "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-04-19T02:01:26Z", "assigned_to": "bugmail@mozilla.staktrace.com", "is_open": false, "history": [{"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "bugmail@mozilla.staktrace.com"}], "who": "bugmail@mozilla.staktrace.com", "when": "2018-04-16T20:49:44Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1451469"}], "who": "bugmail@mozilla.staktrace.com", "when": "2018-04-17T15:54:40Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8968579, "added": "review?(botond@mozilla.com)"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8968580, "added": "review?(botond@mozilla.com)"}, {"removed": "", "field_name": "cc", "added": "botond@mozilla.com"}], "who": "bugmail@mozilla.staktrace.com", "when": "2018-04-17T16:00:49Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(botond@mozilla.com)", "attachment_id": 8968579, "added": "review+"}], "who": "botond@mozilla.com", "when": "2018-04-17T16:56:27Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(botond@mozilla.com)", "attachment_id": 8968580, "added": "review+"}], "who": "botond@mozilla.com", "when": "2018-04-17T17:08:43Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla61"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-04-18 11:00:13"}, {"removed": "---", "field_name": "cf_status_firefox61", "added": "fixed"}], "who": "ccoroiu@mozilla.com", "when": "2018-04-18T11:00:13Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1455182"}], "who": "botond@mozilla.com", "when": "2018-04-19T02:01:26Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}