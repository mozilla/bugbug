{"cf_tracking_thunderbird_esr52": "---", "cf_status_firefox39": "fixed", "cf_tracking_firefox60": "---", "attachments": [{"creator": "docfaraday@gmail.com", "is_obsolete": 1, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2015-03-27T21:13:43Z", "type_id": 4, "creation_date": "2015-03-26T00:25:39Z", "id": 1131656, "setter": "drno@ohlmeier.org"}], "content_type": "text/x-review-board-request", "id": 8582090}, {"creator": "docfaraday@gmail.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2015-06-10T15:46:41Z", "type_id": 4, "creation_date": "2015-06-10T15:46:41Z", "id": 1188126, "setter": "drno@ohlmeier.org"}], "content_type": "text/x-review-board-request", "id": 8619848}], "classification": "Components", "creator": "docfaraday@gmail.com", "mentors_detail": [], "depends_on": [1149298, 1150966], "cf_has_str": "---", "cf_user_story": "", "cf_backlog": "---", "cf_tracking_firefox_relnote": "---", "platform": "All", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "cc_detail": [{"email": "drno@ohlmeier.org", "id": 489581, "name": "drno@ohlmeier.org", "real_name": "Nils Ohlmeier [:drno]"}, {"email": "martin.thomson@gmail.com", "id": 438654, "name": "martin.thomson@gmail.com", "real_name": "Martin Thomson [:mt:]"}], "cf_last_resolved": "2015-03-29T03:38:35Z", "votes": 0, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 21, "comments": [{"text": "While working on bug 952145, I've discovered that ICE streams are not being properly torn down (or disabled) when an m-section is disabled by renegotiation. The danger is that if that m-section is ever re-used (and isn't bundled), we will try to re-use the ICE stream, which probably will not work. I may be able to decompose the work on 952145 to get a small fix for this.", "author": "docfaraday@gmail.com", "id": 10065533, "time": "2015-03-23T17:48:31Z"}, {"text": "Looks like this won't be a small fix, unfortunately.", "author": "docfaraday@gmail.com", "id": 10067789, "time": "2015-03-24T00:11:25Z"}, {"text": "Created attachment 8582090\nMozReview Request: bz://1146462/bwc\n\n/r/5917 - Bug 1146462: (WIP) Close ICE transports when m-sections are disabled.\n\nPull down this commit:\n\nhg pull review -r aca2f18722ad447428efab8ba9743c519ea33d8b", "author": "docfaraday@gmail.com", "id": 10067870, "time": "2015-03-24T00:25:38Z"}, {"text": "Comment on attachment 8582090\nMozReview Request: bz://1146462/bwc\n\n/r/5917 - Bug 1146462: Close ICE transports when m-sections are disabled.\n\nPull down this commit:\n\nhg pull review -r 14fd792469dcf650dcdfeb7cdf00b371746cfdf9", "author": "docfaraday@gmail.com", "id": 10073089, "time": "2015-03-24T23:12:25Z"}, {"text": "Comment on attachment 8582090\nMozReview Request: bz://1146462/bwc\n\n/r/5917 - Bug 1146462: Close ICE transports when m-sections are disabled.\n\nPull down this commit:\n\nhg pull review -r 02d992ab485cca844940e435383b1ee86550363b", "author": "docfaraday@gmail.com", "id": 10073388, "time": "2015-03-25T00:26:26Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=db7698cb1fc5", "author": "docfaraday@gmail.com", "id": 10073392, "time": "2015-03-25T00:27:25Z"}, {"text": "I hope that next week is OK.", "author": "martin.thomson@gmail.com", "id": 10073571, "time": "2015-03-25T01:04:41Z"}, {"text": "Comment on attachment 8582090\nMozReview Request: bz://1146462/bwc\n\nActually, on the way home I decided to simplify the behavior I was shooting for. I may ask drno once that change has been made.", "author": "docfaraday@gmail.com", "id": 10074100, "time": "2015-03-25T03:47:14Z"}, {"text": "Comment on attachment 8582090\nMozReview Request: bz://1146462/bwc\n\n/r/5917 - Bug 1146462: Close ICE transports when m-sections are disabled.\n\nPull down this commit:\n\nhg pull review -r cdb61f41d7b017384733f4cfd19bde81ab365703", "author": "docfaraday@gmail.com", "id": 10076735, "time": "2015-03-25T17:14:25Z"}, {"text": "Comment on attachment 8582090\nMozReview Request: bz://1146462/bwc\n\nThe tricky work in this patch was handling the case where the master bundle transport was disabled, and making sure that the appropriate candidate attributes were carried over into the reoffer. The new behavior when creating a reoffer is to give every m-section its own distinct transport/set of candidates (if the previous m-section was either a master bundle m-section, or unbundled, the old candidates/transport can safely be reused). This also means now we can handle m-sections being removed from the bundle, because everything has a dedicated transport just in case. The downside is we do a round of gathering on every reoffer where bundle is in use, but that's no too bad.\n\nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=06bc5469efe8", "author": "docfaraday@gmail.com", "id": 10076806, "time": "2015-03-25T17:25:01Z"}, {"text": "Comment on attachment 8582090\nMozReview Request: bz://1146462/bwc\n\n/r/5917 - Bug 1146462: Close ICE transports when m-sections are disabled.\n\nPull down this commit:\n\nhg pull review -r e1057a122e9edfcb88110e60ab07dc8879f0d7b2", "author": "docfaraday@gmail.com", "id": 10078468, "time": "2015-03-25T22:32:20Z"}, {"text": "Comment on attachment 8582090\nMozReview Request: bz://1146462/bwc\n\nHad to update transport_unittest\n\nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=1d49d6eea2f4", "author": "docfaraday@gmail.com", "id": 10078474, "time": "2015-03-25T22:33:24Z"}, {"text": "Comment on attachment 8582090\nMozReview Request: bz://1146462/bwc\n\n/r/5917 - Bug 1146462: Close ICE transports when m-sections are disabled.\n\nPull down this commit:\n\nhg pull review -r d2761686b0fe37b93c770739566428e203536e9f", "author": "docfaraday@gmail.com", "id": 10078965, "time": "2015-03-26T00:24:28Z"}, {"text": "Comment on attachment 8582090\nMozReview Request: bz://1146462/bwc\n\nRebase.", "author": "docfaraday@gmail.com", "id": 10078967, "time": "2015-03-26T00:25:39Z"}, {"text": "https://reviewboard.mozilla.org/r/5917/#review5171\n\n::: media/mtransport/nricectx.cpp\n(Diff revision 6)\n> +NrIceCtx::SetStream(size_t index, NrIceMediaStream* stream) {\n> +  if (index >= streams_.size()) {\n> +    streams_.resize(index + 1);\n> +  }\n>  \n> -  if (stream) {\n> -    streams_.push_back(stream);\n> +  if (streams_[index]) {\n> +    streams_[index]->Close();\n>    }\n>  \n> -  return stream;\n> +  streams_[index] = stream;\n\nDo we want an upper limit here, to prevent some faulty code creating 65000 streams?\n\n::: media/mtransport/third_party/nICEr/src/ice/ice_ctx.c\n(Diff revision 6)\n> +    while(pctx){\n> +      if(!nr_ice_peer_ctx_find_pstream(pctx, *streamp, &peer_stream)) {\n> +        if(r=nr_ice_peer_ctx_remove_pstream(pctx, &peer_stream)) {\n> +          ABORT(r);\n> +        }\n> +      }\n> +\n> +      pctx=STAILQ_NEXT(pctx,entry);\n> +    }\n\nWhy do we continue to iterate through the peer contexts after we removed the stream?\nCan the same stream be in multiple contexts? If that's the case we should probably continue through the contexts after encountering the first error.\n\n::: media/webrtc/signaling/src/jsep/JsepSessionImpl.cpp\n(Diff revision 6)\n> -  if (IsBundleSlave(*sdp, level)) {\n> +  if (mState == kJsepStateStable) {\n> +    const Sdp* answer(GetAnswer());\n> +    if (IsBundleSlave(*answer, level)) {\n> -    // We do not add candidate attributes to bundled m-sections unless they\n> +      // We do not add candidate attributes to bundled m-sections unless they\n> -    // are the \"master\" bundle m-section.\n> +      // are the \"master\" bundle m-section.\n> -    *skipped = true;\n> +      *skipped = true;\n> -    return NS_OK;\n> +      return NS_OK;\n> -  }\n> +    }\n> +  }\n>  \n>    *skipped = false;\n>  \n>    return AddCandidateToSdp(sdp, candidate, mid, level);\n\nSo if this gets called in haveRemoteOffer or haveLocalOffer we don't check for BundleSlave and just add to the SDP?\n\nBesides the comments/questions I think a test which goes through dis-abling/removing and re-adding the same might be helpful.", "author": "drno@ohlmeier.org", "id": 10084369, "time": "2015-03-26T22:28:00Z"}, {"text": "https://reviewboard.mozilla.org/r/5917/#review5187\n\n> Do we want an upper limit here, to prevent some faulty code creating 65000 streams?\n\nWell, the worst that will happen is we'll waste some memory on a really sparse array, and spend extra time when we have to iterate it. It seems like this should only happen if we have that many m-sections. Probably not worth having an arbitrary sanity check, since if we end up in that situation we're likely dealing with memory corruption or something.\n\n> Why do we continue to iterate through the peer contexts after we removed the stream?\n> Can the same stream be in multiple contexts? If that's the case we should probably continue through the contexts after encountering the first error.\n\nIt can be in multiple contexts, yes, but not in the way we use nICEr. This is a SIP forking thing, and just like everywhere else it touches, we end up with an error handling conundrum that you noticed here. The error handling in nICEr is generally to stop whatever you're doing when an error is encountered, and given that this is a \"should never happen\" error (nr_ice_media_stream_destroy doesn't fail), I'm not sure I'd want the code to keep trying.\n\n> So if this gets called in haveRemoteOffer or haveLocalOffer we don't check for BundleSlave and just add to the SDP?\n\nYeah, because we don't know for sure whether we're doing bundle or not this time.\n\nThere's a test in signaling_unittests. That should be enough I think.", "author": "docfaraday@gmail.com", "id": 10089229, "time": "2015-03-27T19:07:58Z"}, {"text": "Comment on attachment 8582090\nMozReview Request: bz://1146462/bwc\n\nhttps://reviewboard.mozilla.org/r/5915/#review5233\n\nShip It!", "author": "drno@ohlmeier.org", "id": 10089896, "time": "2015-03-27T21:13:43Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/6dd46eb4124a", "author": "docfaraday@gmail.com", "id": 10090541, "time": "2015-03-28T00:01:57Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/6dd46eb4124a", "author": "philringnalda@gmail.com", "id": 10092643, "time": "2015-03-29T03:38:35Z"}, {"text": "Comment on attachment 8582090\nMozReview Request: bz://1146462/bwc", "author": "docfaraday@gmail.com", "id": 10369117, "time": "2015-06-10T15:46:41Z"}, {"text": "Created attachment 8619848\nMozReview Request: Bug 1146462: Close ICE transports when m-sections are disabled.", "author": "docfaraday@gmail.com", "id": 10369118, "time": "2015-06-10T15:46:41Z"}], "id": 1146462, "priority": "--", "cc": ["drno@ohlmeier.org", "martin.thomson@gmail.com"], "cf_crash_signature": "", "version": "Trunk", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_firefox59": "---", "last_change_time": "2015-06-10T15:46:41Z", "status": "RESOLVED", "product": "Core", "cf_fx_iteration": "---", "blocks": [], "qa_contact": "", "creation_time": "2015-03-23T17:48:31Z", "cf_status_firefox_esr52": "---", "component": "WebRTC: Signaling", "assigned_to_detail": {"email": "docfaraday@gmail.com", "id": 478411, "name": "docfaraday@gmail.com", "real_name": "Byron Campen [:bwc]"}, "groups": [], "cf_status_firefox60": "---", "target_milestone": "mozilla39", "is_cc_accessible": true, "cf_rank": null, "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "docfaraday@gmail.com", "id": 478411, "name": "docfaraday@gmail.com", "real_name": "Byron Campen [:bwc]"}, "whiteboard": "", "mentors": [], "summary": "Disabling an m-section doesn't tear down the ICE stream", "cf_platform_rel": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "assigned_to": "docfaraday@gmail.com", "is_open": false, "history": [{"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "docfaraday@gmail.com"}], "who": "docfaraday@gmail.com", "when": "2015-03-23T17:49:11Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "martin.thomson@gmail.com"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8582090, "added": "review?(martin.thomson@gmail.com)"}], "who": "docfaraday@gmail.com", "when": "2015-03-25T00:28:03Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(martin.thomson@gmail.com)", "attachment_id": 8582090, "added": ""}], "who": "docfaraday@gmail.com", "when": "2015-03-25T03:47:14Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "drno@ohlmeier.org"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8582090, "added": "review?(drno@ohlmeier.org)"}], "who": "docfaraday@gmail.com", "when": "2015-03-25T17:25:01Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(drno@ohlmeier.org)", "attachment_id": 8582090, "added": ""}], "who": "docfaraday@gmail.com", "when": "2015-03-25T22:32:20Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8582090, "added": "review?(drno@ohlmeier.org)"}], "who": "docfaraday@gmail.com", "when": "2015-03-25T22:33:24Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(drno@ohlmeier.org)", "attachment_id": 8582090, "added": ""}], "who": "docfaraday@gmail.com", "when": "2015-03-26T00:24:28Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8582090, "added": "review?(drno@ohlmeier.org)"}], "who": "docfaraday@gmail.com", "when": "2015-03-26T00:25:39Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(drno@ohlmeier.org)", "attachment_id": 8582090, "added": "review+"}], "who": "drno@ohlmeier.org", "when": "2015-03-27T21:13:43Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla39"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2015-03-28 20:38:35"}, {"removed": "---", "field_name": "cf_status_firefox39", "added": "fixed"}], "who": "philringnalda@gmail.com", "when": "2015-03-29T03:38:35Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1150966"}], "who": "docfaraday@gmail.com", "when": "2015-04-03T18:08:21Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1149298"}], "who": "mreavy@mozilla.com", "when": "2015-04-16T21:09:20Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8582090, "added": "1"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8619848, "added": "review+"}], "who": "docfaraday@gmail.com", "when": "2015-06-10T15:46:41Z"}], "resolution": "FIXED", "op_sys": "All", "cf_fx_points": "---", "cf_blocking_fennec": "---"}