{"cf_tracking_thunderbird_esr52": "---", "cf_status_firefox39": "fixed", "cf_tracking_firefox60": "---", "attachments": [{"creator": "lhansen@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8572532}, {"creator": "lhansen@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2015-03-05T09:28:39Z", "type_id": 4, "creation_date": "2015-03-04T10:14:46Z", "id": 1113521, "setter": "hv1989@gmail.com"}], "content_type": "text/plain", "id": 8572533}, {"creator": "lhansen@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2015-03-05T09:29:08Z", "type_id": 4, "creation_date": "2015-03-04T10:15:34Z", "id": 1113523, "setter": "hv1989@gmail.com"}], "content_type": "text/plain", "id": 8572535}], "classification": "Components", "creator": "lhansen@mozilla.com", "cc": ["hv1989@gmail.com", "j_schulte@outlook.com", "kwierso@gmail.com", "lhansen@mozilla.com", "sunfish@mozilla.com"], "depends_on": [1141067], "creation_time": "2015-03-02T10:03:58Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "x86_64", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "Atomic byte operations on x86_64 need not pin any registers at all", "id": 1138348, "assigned_to_detail": {"email": "lhansen@mozilla.com", "id": 499633, "name": "lhansen@mozilla.com", "real_name": "Lars T Hansen [:lth]"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "assigned_to": "lhansen@mozilla.com", "comment_count": 17, "comments": [{"text": "On x86_64 we can generate byte-sized operations on any GPR using a REX prefix, and avoid pinning any register.", "author": "lhansen@mozilla.com", "id": 9972833, "time": "2015-03-02T10:03:58Z"}, {"text": "Not quite that easy: ESI, EDI, EBP cannot be used as byte registers with a REX prefix, so must be excluded from the allocation.", "author": "lhansen@mozilla.com", "id": 9972911, "time": "2015-03-02T10:36:52Z"}, {"text": "(In reply to Lars T Hansen [:lth] from comment #1)\n> Not quite that easy: ESI, EDI, EBP cannot be used as byte registers with a\n> REX prefix, so must be excluded from the allocation.\n\nI take that back, the manual does not state this clearly but in 64-bit mode with REX.B these do indeed have distinguished byte registers that do not overlap with RAX..RDX, ie, the forms do not reference AH, BH, CH, DH.  Table 3.1, Register Codes, in the Intel manual volume 2.", "author": "lhansen@mozilla.com", "id": 9972929, "time": "2015-03-02T10:45:29Z"}, {"text": "Created attachment 8572532\nBug fixes for the BaseAssembler\n\n8-byte operations should use code generation helpers that ensure the use of proper REX prefixes on x64.  These bugs were benign because the locked-instruction emitters were only used by the Atomics implementation, which pinned its registers to al/bl/cl/dl.", "author": "lhansen@mozilla.com", "id": 9983817, "time": "2015-03-04T10:12:46Z"}, {"text": "(In reply to Lars T Hansen [:lth] from comment #3)\n> Created attachment 8572532\n> Bug fixes for the BaseAssembler\n> \n> 8-byte operations ...\n\nSigh.  1-byte / 8-bit.", "author": "lhansen@mozilla.com", "id": 9983818, "time": "2015-03-04T10:13:07Z"}, {"text": "Created attachment 8572533\nSpecialize x64 code generation", "author": "lhansen@mozilla.com", "id": 9983829, "time": "2015-03-04T10:14:46Z"}, {"text": "Created attachment 8572535\nTest cases\n\nThese are for asm.js only - for plain JS there are already 8-bit tests in tests/atomics/basic-tests.js.", "author": "lhansen@mozilla.com", "id": 9983831, "time": "2015-03-04T10:15:34Z"}, {"text": "Comment on attachment 8572532\nBug fixes for the BaseAssembler\n\nReview of attachment 8572532:\n-----------------------------------------------------------------\n\nI'm gonna forward this to sunfish. He was busy with REX, so I want him to confirm this isn't breaking his efforts.", "author": "hv1989@gmail.com", "id": 9989617, "time": "2015-03-05T09:09:52Z"}, {"text": "Comment on attachment 8572533\nSpecialize x64 code generation\n\nReview of attachment 8572533:\n-----------------------------------------------------------------\n\n::: js/src/jit/x64/Lowering-x64.cpp\n@@ +133,5 @@\n>  \n>  void\n> +LIRGeneratorX64::visitCompareExchangeTypedArrayElement(MCompareExchangeTypedArrayElement *ins)\n> +{\n> +    lowerCompareExchangeTypedArrayElement(ins, false);\n\nlowerCompareExchangeTypedArrayElement(ins, /* useI386ByteRegisters = */ false);\n\n@@ +139,5 @@\n> +\n> +void\n> +LIRGeneratorX64::visitAtomicTypedArrayElementBinop(MAtomicTypedArrayElementBinop *ins)\n> +{\n> +    lowerAtomicTypedArrayElementBinop(ins, false);\n\nlowerAtomicTypedArrayElementBinop(ins, /* useI386ByteRegisters = */ false);\n\n::: js/src/jit/x86/Lowering-x86.cpp\n@@ +300,5 @@\n> +      case Scalar::Uint32:\n> +        break;\n> +      default:\n> +        MOZ_CRASH(\"Unexpected array type\");\n> +    }\n\nCan you change this in:\n\nbool byteArray = byteSize(ins->accessType()) == 1;\n\nor add a function in jsfriendapi.h::Scalar ?\nsizeIsByte(Scalar::Type)\n\n@@ +343,5 @@\n> +      case Scalar::Uint32:\n> +        break;\n> +      default:\n> +        MOZ_CRASH(\"Unexpected array type\");\n> +    }\n\nSame as above.", "author": "hv1989@gmail.com", "id": 9989711, "time": "2015-03-05T09:28:39Z"}, {"text": "Comment on attachment 8572535\nTest cases\n\nReview of attachment 8572535:\n-----------------------------------------------------------------\n\nAwesome!", "author": "hv1989@gmail.com", "id": 9989714, "time": "2015-03-05T09:29:08Z"}, {"text": "Comment on attachment 8572532\nBug fixes for the BaseAssembler\n\nThis patch has been moved to bug 1141067.", "author": "lhansen@mozilla.com", "id": 10003572, "time": "2015-03-09T13:44:54Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/5777a98e824f\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/9c405f41e3e7", "author": "lhansen@mozilla.com", "id": 10007789, "time": "2015-03-10T07:31:58Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/5777a98e824f\nhttps://hg.mozilla.org/mozilla-central/rev/9c405f41e3e7", "author": "cbook@mozilla.com", "id": 10008705, "time": "2015-03-10T13:00:26Z"}, {"text": "Both backed out for making windows ggc builds permafail:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/8e261a74f350\n\nhttps://treeherder.mozilla.org/logviewer.html#?job_id=7433213&repo=mozilla-inbound", "author": "kwierso@gmail.com", "id": 10013137, "time": "2015-03-11T02:52:50Z"}, {"text": "The bug is in the other patch, bug 1141067.", "author": "lhansen@mozilla.com", "id": 10013905, "time": "2015-03-11T08:25:47Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/d2747e260b68\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/fbe97de16996", "author": "lhansen@mozilla.com", "id": 10015182, "time": "2015-03-11T14:46:59Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/d2747e260b68\nhttps://hg.mozilla.org/mozilla-central/rev/fbe97de16996", "author": "cbook@mozilla.com", "id": 10019512, "time": "2015-03-12T08:18:18Z"}], "cf_last_resolved": "2015-03-12T08:18:18Z", "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "unspecified", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2015-03-12T08:18:18Z", "cf_platform_rel": "---", "product": "Core", "cf_status_firefox_esr52": "---", "blocks": [1054841, 1141121], "qa_contact": "", "see_also": ["https://bugzilla.mozilla.org/show_bug.cgi?id=1077036"], "cf_fx_iteration": "---", "component": "JavaScript Engine: JIT", "votes": 0, "groups": [], "cf_status_firefox60": "---", "target_milestone": "mozilla39", "is_cc_accessible": true, "status": "RESOLVED", "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "lhansen@mozilla.com", "id": 499633, "name": "lhansen@mozilla.com", "real_name": "Lars T Hansen [:lth]"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "hv1989@gmail.com", "id": 196399, "name": "hv1989@gmail.com", "real_name": "Hannes Verschore [:h4writer]"}, {"email": "j_schulte@outlook.com", "id": 496992, "name": "j_schulte@outlook.com", "real_name": "Johannes Schulte [:jschulte]"}, {"email": "kwierso@gmail.com", "id": 308534, "name": "kwierso@gmail.com", "real_name": "Wes Kocher (:KWierso)"}, {"email": "lhansen@mozilla.com", "id": 499633, "name": "lhansen@mozilla.com", "real_name": "Lars T Hansen [:lth]"}, {"email": "sunfish@mozilla.com", "id": 468136, "name": "sunfish@mozilla.com", "real_name": "Dan Gohman [:sunfish]"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "j_schulte@outlook.com"}], "who": "j_schulte@outlook.com", "when": "2015-03-02T20:26:56Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "ASSIGNED"}, {"removed": "", "field_name": "cc", "added": "hv1989@gmail.com"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "lhansen@mozilla.com"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8572532, "added": "review?(hv1989@gmail.com)"}], "who": "lhansen@mozilla.com", "when": "2015-03-04T10:12:46Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8572533, "added": "review?(hv1989@gmail.com)"}], "who": "lhansen@mozilla.com", "when": "2015-03-04T10:14:46Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8572535, "added": "review?(hv1989@gmail.com)"}], "who": "lhansen@mozilla.com", "when": "2015-03-04T10:15:34Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "sunfish@mozilla.com"}, {"field_name": "flagtypes.name", "removed": "review?(hv1989@gmail.com)", "attachment_id": 8572532, "added": "review?(sunfish@mozilla.com)"}], "who": "hv1989@gmail.com", "when": "2015-03-05T09:09:52Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(hv1989@gmail.com)", "attachment_id": 8572533, "added": "review+"}], "who": "hv1989@gmail.com", "when": "2015-03-05T09:28:39Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(hv1989@gmail.com)", "attachment_id": 8572535, "added": "review+"}], "who": "hv1989@gmail.com", "when": "2015-03-05T09:29:08Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1141067"}], "who": "lhansen@mozilla.com", "when": "2015-03-09T13:44:16Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(sunfish@mozilla.com)", "attachment_id": 8572532, "added": ""}], "who": "lhansen@mozilla.com", "when": "2015-03-09T13:44:54Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1141121"}], "who": "lhansen@mozilla.com", "when": "2015-03-09T15:28:17Z"}, {"changes": [{"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla39"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2015-03-10 06:00:26"}, {"removed": "---", "field_name": "cf_status_firefox39", "added": "fixed"}], "who": "cbook@mozilla.com", "when": "2015-03-10T13:00:26Z"}, {"changes": [{"removed": "RESOLVED", "field_name": "status", "added": "REOPENED"}, {"removed": "", "field_name": "cc", "added": "lhansen@mozilla.com, wkocher@mozilla.com"}, {"removed": "FIXED", "field_name": "resolution", "added": ""}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(lhansen@mozilla.com)"}], "who": "kwierso@gmail.com", "when": "2015-03-11T02:52:50Z"}, {"changes": [{"removed": "needinfo?(lhansen@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "lhansen@mozilla.com", "when": "2015-03-11T08:25:47Z"}, {"changes": [{"removed": "REOPENED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "2015-03-10 06:00:26", "field_name": "cf_last_resolved", "added": "2015-03-12 01:18:18"}], "who": "cbook@mozilla.com", "when": "2015-03-12T08:18:18Z"}], "resolution": "FIXED", "op_sys": "All", "cf_fx_points": "---", "cf_blocking_fennec": "---"}