{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "padenot@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2014-07-28T14:00:20Z", "type_id": 4, "creation_date": "2014-07-28T13:21:30Z", "id": 935739, "setter": "gpascutto@mozilla.com"}], "content_type": "text/plain", "id": 8463348}, {"creator": "padenot@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2014-07-29T03:41:34Z", "type_id": 4, "creation_date": "2014-07-28T13:21:52Z", "id": 935740, "setter": "kinetik@flim.org"}], "content_type": "text/plain", "id": 8463349}, {"creator": "padenot@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2014-07-28T14:10:21Z", "type_id": 4, "creation_date": "2014-07-28T13:22:28Z", "id": 935742, "setter": "gpascutto@mozilla.com"}], "content_type": "text/plain", "id": 8463351}], "classification": "Components", "creator": "padenot@mozilla.com", "cc": ["gpascutto@mozilla.com", "kinetik@flim.org"], "depends_on": [1015932], "creation_time": "2014-07-28T12:55:52Z", "cf_user_story": "", "cf_backlog": "---", "cf_tracking_firefox_relnote": "---", "platform": "x86_64", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "Add a way to set the kAudioHardwarePropertyRunLoop property  on OSX only once per process", "id": 1045018, "assigned_to_detail": {"email": "padenot@mozilla.com", "id": 404637, "name": "padenot@mozilla.com", "real_name": "Paul Adenot (:padenot)"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "assigned_to": "padenot@mozilla.com", "comment_count": 9, "comments": [{"text": "I got backed out in bug 1027713 because we are setting kAudioHardwarePropertyRunLoop to NULL in cubeb (that forces device plug/unplug notifications to run on their own thread instead of the main thread) and the webrtc.org code base sets it to NULL as well, and messing with an event loop while it's running is not a good idea.\n\nThe plan is as follow:\n- Use gcp's new content/media/systemservices directory to be able to share a single function between cubeb and webrtc.org code\n- implement a thread safe singleton that ensure the function is called only once\n- add a header to cubeb so we can have two implementation: a mozilla-central implementation (when Firefox is running), that uses the singleton, and cubeb's standalone implementation (for tests in m-c, or when building standalone)\n- #ifdef our way to victory in the webrtc.org codebase, using MOZILLA_INTERNAL_API", "author": "padenot@mozilla.com", "id": 9107845, "time": "2014-07-28T12:55:52Z"}, {"text": "Created attachment 8463348\nImplement a thread safe singleton to allow setting kAudioHardwarePropertyRunLoop property to NULL only once. r=", "author": "padenot@mozilla.com", "id": 9107972, "time": "2014-07-28T13:21:30Z"}, {"text": "Created attachment 8463349\nMake cubeb_audiounit.c use the new cubeb_set_coreaudio_notification_runloop function. r=", "author": "padenot@mozilla.com", "id": 9107973, "time": "2014-07-28T13:21:52Z"}, {"text": "Created attachment 8463351\nMake webrtc.org code use mozilla_set_coreaudio_notification_runloop.  r=", "author": "padenot@mozilla.com", "id": 9107978, "time": "2014-07-28T13:22:28Z"}, {"text": "This is all green on try.", "author": "padenot@mozilla.com", "id": 9108117, "time": "2014-07-28T13:43:24Z"}, {"text": "And also, this needs patches from bug 1015932.", "author": "padenot@mozilla.com", "id": 9108119, "time": "2014-07-28T13:43:58Z"}, {"text": "Comment on attachment 8463348\nImplement a thread safe singleton to allow setting kAudioHardwarePropertyRunLoop property to NULL only once. r=\n\nReview of attachment 8463348:\n-----------------------------------------------------------------\n\n::: content/media/systemservices/OSXRunLoopSingleton.cpp\n@@ +13,5 @@\n> +\n> +static bool gRunLoopSet = false;\n> +static mozilla::StaticMutex gMutex;\n> +\n> +void mozilla_set_coreaudio_notification_runloop_if_needed()\n\nnit: I could argue the _if_needed is an implementation detail the API naming doesn't need to expose.\n\n@@ +20,5 @@\n> +  if (gRunLoopSet) {\n> +    return;\n> +  }\n> +\n> +  OSStatus r;\n\nnit: Move this down to where it's used.\n\n@@ +30,5 @@\n> +    kAudioObjectPropertyScopeGlobal,\n> +    kAudioObjectPropertyElementMaster\n> +  };\n> +\n> +  CFRunLoopRef run_loop = NULL;\n\nnit: Maybe nullptr and #include <mozilla/NullPtr.h>\n\n::: content/media/systemservices/OSXRunLoopSingleton.h\n@@ +3,5 @@\n> + * License, v. 2.0. If a copy of the MPL was not distributed with this file,\n> + * You can obtain one at http://mozilla.org/MPL/2.0/. */\n> +\n> +#ifndef OSXRUNLOOPSINGLETON_H\n> +#define OSXRUNLOOPSINGLETON_H\n\nnit: We're inconsistent about the leading_, but all other code uses a trailing _, so BLAH_H_\n\n::: content/media/systemservices/moz.build\n@@ +33,3 @@\n>  include('/ipc/chromium/chromium-config.mozbuild')\n>  \n>  FINAL_LIBRARY = 'gklayout'\n\nNeeds updating now.", "author": "gpascutto@mozilla.com", "id": 9108191, "time": "2014-07-28T14:00:20Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/bf4ed2946c45\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/bd925dd0edbf\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/9c82fdf124df", "author": "padenot@mozilla.com", "id": 9114090, "time": "2014-07-29T16:46:21Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/9e7128b769a7\nhttps://hg.mozilla.org/mozilla-central/rev/fd4a70e6d514\nhttps://hg.mozilla.org/mozilla-central/rev/3e28cd6f2ab8", "author": "kwierso@gmail.com", "id": 9116217, "time": "2014-07-30T00:06:41Z"}], "cf_last_resolved": "2014-07-30T00:06:41Z", "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "unspecified", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2014-07-30T00:06:41Z", "cf_platform_rel": "---", "product": "Core", "cf_status_firefox_esr52": "---", "blocks": [1027713], "qa_contact": "", "see_also": [], "cf_fx_iteration": "---", "component": "Audio/Video", "votes": 0, "groups": [], "cf_status_firefox60": "---", "target_milestone": "mozilla34", "is_cc_accessible": true, "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "padenot@mozilla.com", "id": 404637, "name": "padenot@mozilla.com", "real_name": "Paul Adenot (:padenot)"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "gpascutto@mozilla.com", "id": 151147, "name": "gpascutto@mozilla.com", "real_name": "Gian-Carlo Pascutto [:gcp]"}, {"email": "kinetik@flim.org", "id": 274575, "name": "kinetik@flim.org", "real_name": "Matthew Gregan [:kinetik]"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "blocks", "added": "1027713"}, {"removed": "", "field_name": "depends_on", "added": "1015932"}], "who": "padenot@mozilla.com", "when": "2014-07-28T13:20:17Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8463348, "added": "review?(gpascutto@mozilla.com)"}, {"removed": "", "field_name": "cc", "added": "gpascutto@mozilla.com"}], "who": "padenot@mozilla.com", "when": "2014-07-28T13:21:30Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "paul@paul.cx"}], "who": "padenot@mozilla.com", "when": "2014-07-28T13:21:36Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8463349, "added": "review?(kinetik@flim.org)"}, {"removed": "", "field_name": "cc", "added": "kinetik@flim.org"}], "who": "padenot@mozilla.com", "when": "2014-07-28T13:21:52Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8463351, "added": "review?(gpascutto@mozilla.com)"}], "who": "padenot@mozilla.com", "when": "2014-07-28T13:22:28Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(gpascutto@mozilla.com)", "attachment_id": 8463348, "added": "review+"}], "who": "gpascutto@mozilla.com", "when": "2014-07-28T14:00:20Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(gpascutto@mozilla.com)", "attachment_id": 8463351, "added": "review+"}], "who": "gpascutto@mozilla.com", "when": "2014-07-28T14:10:21Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(kinetik@flim.org)", "attachment_id": 8463349, "added": "review+"}], "who": "kinetik@flim.org", "when": "2014-07-29T03:41:34Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla34"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2014-07-29 17:06:41"}], "who": "kwierso@gmail.com", "when": "2014-07-30T00:06:41Z"}], "resolution": "FIXED", "op_sys": "Mac OS X", "cf_fx_points": "---", "cf_blocking_fennec": "---"}