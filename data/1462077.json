{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "bkelly@mozilla.com", "mentors_detail": [], "depends_on": [], "cf_status_firefox_esr60": "disabled", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "x86", "keywords": ["crash", "regression"], "cc_detail": [{"email": "bugmail@asutherland.org", "id": 151407, "name": "bugmail@asutherland.org", "real_name": "Andrew Sutherland [:asuth]"}, {"email": "mdaly@mozilla.com", "id": 609492, "name": "mdaly@mozilla.com", "real_name": "Marion Daly [:mdaly]"}, {"email": "ryanvm@gmail.com", "id": 75935, "name": "ryanvm@gmail.com", "real_name": "Ryan VanderMeulen [:RyanVM]"}, {"email": "sledru@mozilla.com", "id": 495955, "name": "sledru@mozilla.com", "real_name": "Sylvestre Ledru [:sylvestre]"}], "cf_last_resolved": "2018-05-17T09:51:50Z", "attachments": [{"creator": "bkelly@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-05-16T19:39:04Z", "type_id": 4, "creation_date": "2018-05-16T19:31:40Z", "id": 1757744, "setter": "bugmail@asutherland.org"}, {"status": "+", "name": "approval-mozilla-beta", "modification_date": "2018-05-17T13:48:52Z", "type_id": 721, "creation_date": "2018-05-17T13:14:46Z", "id": 1758138, "setter": "ryanvm@gmail.com"}], "content_type": "text/plain", "id": 8976286}, {"creator": "bkelly@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-05-16T19:39:08Z", "type_id": 4, "creation_date": "2018-05-16T19:32:59Z", "id": 1757745, "setter": "bugmail@asutherland.org"}, {"status": "+", "name": "approval-mozilla-beta", "modification_date": "2018-05-17T13:48:56Z", "type_id": 721, "creation_date": "2018-05-17T13:15:05Z", "id": 1758140, "setter": "ryanvm@gmail.com"}], "content_type": "text/plain", "id": 8976287}], "votes": 0, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 14, "comments": [{"text": "It appears we are hitting our safety release assert in FF60 that prevents a cross-origin service worker controller.  Fortunately the assertion prevents this from being a security issue, but its a bad problem and we need to figure out how this is happening.\n\nThis bug was filed from the Socorro interface and is\nreport bp-09d62ec8-7bf4-4e50-b863-aa3bd0180516.\n=============================================================\n\nTop 10 frames of crashing thread:\n\n0 xul.dll mozilla::dom::ClientSource::SetController dom/clients/manager/ClientSource.cpp:383\n1 xul.dll mozilla::dom::ClientSource::Control dom/clients/manager/ClientSource.cpp:433\n2 xul.dll mozilla::dom::ClientSourceOpChild::DoSourceOp<RefPtr<mozilla::MozPromise<mozilla::dom::ClientOpResult, nsresult, 0> >  dom/clients/manager/ClientSourceOpChild.cpp:45\n3 xul.dll mozilla::dom::ClientSourceOpChild::Init dom/clients/manager/ClientSourceOpChild.cpp:79\n4 xul.dll mozilla::dom::ClientSourceChild::RecvPClientSourceOpConstructor dom/clients/manager/ClientSourceChild.cpp:49\n5 xul.dll mozilla::dom::PClientSourceChild::OnMessageReceived ipc/ipdl/PClientSourceChild.cpp:241\n6 xul.dll mozilla::ipc::PBackgroundChild::OnMessageReceived ipc/ipdl/PBackgroundChild.cpp:1968\n7 xul.dll mozilla::ipc::MessageChannel::DispatchAsyncMessage ipc/glue/MessageChannel.cpp:2133\n8 xul.dll mozilla::ipc::MessageChannel::DispatchMessageW ipc/glue/MessageChannel.cpp:2063\n9 xul.dll mozilla::ipc::MessageChannel::RunMessage ipc/glue/MessageChannel.cpp:1909\n\n=============================================================", "author": "bkelly@mozilla.com", "id": 13282326, "time": "2018-05-16T18:44:26Z"}, {"text": "I think I might see the problem.  We need to update the clientInfo stack variable when we do this:\n\nhttps://searchfox.org/mozilla-central/rev/00dd116638001772fe354b081353b73f1cad405d/dom/serviceworkers/ServiceWorkerManager.cpp#2207-2221\n\nThat code is creating a new reserved client, but it goes ahead and tries to mark the original client controlled via the SWM.  Its probably a race as to whether the necko-based control takes effect before the SWM-based control.", "author": "bkelly@mozilla.com", "id": 13282364, "time": "2018-05-16T18:55:18Z"}, {"text": "Ah, there must be an initial about:blank that gets destroyed when the load completes with the new reserved ClientSource.  If the SWM control operation completes before that happens then the crash will trigger.  I think, anyway.", "author": "bkelly@mozilla.com", "id": 13282382, "time": "2018-05-16T18:58:41Z"}, {"text": "Created attachment 8976286\nP1 Make ServiceWorkerManager::DispatchFetchEvent() use the new client if we he create one for an STS upgrade. r=asuth\n\nAndrew, this patch fixes a bug in DispatchFetchEvent() when we try to do an STS upgrade in e10s mode.  The code was already trying to force create a new ClientSource object, but it neglected to update clientInfo stack variable.  So the ServiceWorkerManager::StartControllingClient() method was being called on the wrong client.", "author": "bkelly@mozilla.com", "id": 13282481, "time": "2018-05-16T19:31:40Z"}, {"text": "Created attachment 8976287\nP2 Add a release assert in ClientHandle::Control() that enforces same-origin policy. r=asuth\n\nThis makes us apply the same release assertion currently in ClientSource::SetController() also in ClientHandle::Control().  This would have caught the problem in our existing automation tests.  It also might be more useful for some crash reports since we can see what is calling the async ClientHandle::Control() method.", "author": "bkelly@mozilla.com", "id": 13282483, "time": "2018-05-16T19:32:59Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=38eea8f13530ff2778801a2b84555e002eb5a506", "author": "bkelly@mozilla.com", "id": 13282485, "time": "2018-05-16T19:33:13Z"}, {"text": "Comment on attachment 8976286\nP1 Make ServiceWorkerManager::DispatchFetchEvent() use the new client if we he create one for an STS upgrade. r=asuth\n\nReview of attachment 8976286:\n-----------------------------------------------------------------\n\nThanks for the excellent characterization of the problem.", "author": "bugmail@asutherland.org", "id": 13282496, "time": "2018-05-16T19:39:04Z"}, {"text": "This was a mistake from when I implemented bug 1440705.", "author": "bkelly@mozilla.com", "id": 13282524, "time": "2018-05-16T19:49:05Z"}, {"text": "Pushed by bkelly@mozilla.com:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/2bd63f2afbb7\nP1 Make ServiceWorkerManager::DispatchFetchEvent() use the new client if we create one for an STS upgrade. r=asuth\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/e5fb8f83dbf0\nP2 Add a release assert in ClientHandle::Control() that enforces same-origin policy. r=asuth", "author": "pulsebot@bots.tld", "id": 13282814, "time": "2018-05-16T21:18:57Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/2bd63f2afbb7\nhttps://hg.mozilla.org/mozilla-central/rev/e5fb8f83dbf0", "author": "csabou@mozilla.com", "id": 13283943, "time": "2018-05-17T09:51:50Z"}, {"text": "Comment on attachment 8976286\nP1 Make ServiceWorkerManager::DispatchFetchEvent() use the new client if we he create one for an STS upgrade. r=asuth\n\nApproval Request Comment\n[Feature/Bug causing the regression]: Bug 1440705\n[User impact if declined]: A race condition during STS upgrade can trigger crashes if a race condition triggers.\n[Is this code covered by automated tests?]: Yes.  The P2 patch here adds an additional assertion that allows our current tests to catch this problem.\n[Has the fix been verified in Nightly?]: Its landed in nightly, but we never saw the race condition trigger in nightly.\n[Needs manual test from QE? If yes, steps to reproduce]: No\n[List of other uplifts needed for the feature/fix]: None\n[Is the change risky?]: Minimal\n[Why is the change risky/not risky?]: This patch adds a one line fix to populate a value that was clearly missed before.  The assertion is checking for the same condition we already assert on in other places.\n[String changes made/needed]: None", "author": "bkelly@mozilla.com", "id": 13284267, "time": "2018-05-17T13:14:46Z"}, {"text": "Comment on attachment 8976287\nP2 Add a release assert in ClientHandle::Control() that enforces same-origin policy. r=asuth\n\nSee comment 10.", "author": "bkelly@mozilla.com", "id": 13284270, "time": "2018-05-17T13:15:05Z"}, {"text": "Comment on attachment 8976286\nP1 Make ServiceWorkerManager::DispatchFetchEvent() use the new client if we he create one for an STS upgrade. r=asuth\n\nSimple fix for a Service Workers crash, and a bonus release assert to help catch it in the future. Approved for 61.0b6.", "author": "ryanvm@gmail.com", "id": 13284372, "time": "2018-05-17T13:48:52Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-beta/rev/d5c088330e6b\nhttps://hg.mozilla.org/releases/mozilla-beta/rev/39f739efe104", "author": "ryanvm@gmail.com", "id": 13284386, "time": "2018-05-17T13:53:06Z"}], "id": 1462077, "priority": "P1", "cc": ["bugmail@asutherland.org", "mdaly@mozilla.com", "ryanvm@gmail.com", "sledru@mozilla.com"], "cf_crash_signature": "[@ mozilla::dom::ClientSource::SetController]", "version": "unspecified", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_thunderbird_esr60": "---", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1328631, 1440705], "qa_contact": "", "creation_time": "2018-05-16T18:44:26Z", "cf_status_firefox_esr52": "unaffected", "component": "DOM: Service Workers", "assigned_to_detail": {"email": "bkelly@mozilla.com", "id": 465500, "name": "bkelly@mozilla.com", "real_name": "Ben Kelly [:bkelly]"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "fixed", "cf_status_firefox61": "fixed", "cf_status_firefox60": "wontfix", "target_milestone": "mozilla62", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "critical", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "bkelly@mozilla.com", "id": 465500, "name": "bkelly@mozilla.com", "real_name": "Ben Kelly [:bkelly]"}, "whiteboard": "", "mentors": [], "summary": "Crash in mozilla::dom::ClientSource::SetController", "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-05-23T19:50:31Z", "assigned_to": "bkelly@mozilla.com", "is_open": false, "history": [{"changes": [{"removed": "--", "field_name": "priority", "added": "P1"}, {"removed": "", "field_name": "cc", "added": "mdaly@mozilla.com"}], "who": "mdaly@mozilla.com", "when": "2018-05-16T18:56:43Z"}, {"changes": [{"removed": "---", "field_name": "cf_status_firefox_esr60", "added": "disabled"}, {"removed": "---", "field_name": "cf_status_firefox60", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox61", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox62", "added": "affected"}], "who": "bkelly@mozilla.com", "when": "2018-05-16T19:23:52Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "bugmail@asutherland.org"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8976286, "added": "review?(bugmail@asutherland.org)"}], "who": "bkelly@mozilla.com", "when": "2018-05-16T19:31:40Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8976287, "added": "review?(bugmail@asutherland.org)"}], "who": "bkelly@mozilla.com", "when": "2018-05-16T19:32:59Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bugmail@asutherland.org)", "attachment_id": 8976286, "added": "review+"}], "who": "bugmail@asutherland.org", "when": "2018-05-16T19:39:04Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bugmail@asutherland.org)", "attachment_id": 8976287, "added": "review+"}], "who": "bugmail@asutherland.org", "when": "2018-05-16T19:39:08Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1440705"}], "who": "bkelly@mozilla.com", "when": "2018-05-16T19:49:05Z"}, {"changes": [{"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla62"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-05-17 09:51:50"}, {"removed": "affected", "field_name": "cf_status_firefox62", "added": "fixed"}], "who": "csabou@mozilla.com", "when": "2018-05-17T09:51:50Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8976286, "added": "approval-mozilla-beta?"}], "who": "bkelly@mozilla.com", "when": "2018-05-17T13:14:46Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8976287, "added": "approval-mozilla-beta?"}], "who": "bkelly@mozilla.com", "when": "2018-05-17T13:15:05Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "ryanvm@gmail.com"}, {"removed": "---", "field_name": "cf_status_firefox_esr52", "added": "unaffected"}], "who": "ryanvm@gmail.com", "when": "2018-05-17T13:25:57Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "approval-mozilla-beta?", "attachment_id": 8976286, "added": "approval-mozilla-beta+"}], "who": "ryanvm@gmail.com", "when": "2018-05-17T13:48:52Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "approval-mozilla-beta?", "attachment_id": 8976287, "added": "approval-mozilla-beta+"}], "who": "ryanvm@gmail.com", "when": "2018-05-17T13:48:56Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox61", "added": "fixed"}], "who": "ryanvm@gmail.com", "when": "2018-05-17T13:53:06Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "regression"}, {"removed": "", "field_name": "cc", "added": "sledru@mozilla.com"}], "who": "sledru@mozilla.com", "when": "2018-05-18T12:13:58Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox60", "added": "wontfix"}], "who": "ryanvm@gmail.com", "when": "2018-05-23T19:50:31Z"}], "resolution": "FIXED", "op_sys": "Windows 10", "cf_fx_points": "---", "cf_blocking_fennec": "---"}