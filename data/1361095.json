{"status": "NEW", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "classification": "Client Software", "creator": "florian@queze.net", "cc": ["adw@mozilla.com", "ehsan@mozilla.com", "gijskruitbosch+bugs@gmail.com", "mak77@bonardo.net", "mcastelluccio@mozilla.com", "mconley@mozilla.com", "nihsanullah@invalid.bugs"], "depends_on": [886907, 887889], "creation_time": "2017-05-01T17:31:12Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": ["meta", "perf"], "summary": "Can nsContentPrefService avoid main thread IO before the first window is shown?", "cf_last_resolved": null, "attachments": [], "assigned_to_detail": {"email": "nobody@mozilla.org", "id": 1, "name": "nobody@mozilla.org", "real_name": "Nobody; OK to take it and work on it"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 11, "comments": [{"text": "See this profile captured during startup on the quantum reference hardware: https://perfht.ml/2p1EDjb\n\n51ms of startup is waiting for a CreateFileW system call from mozilla::storage::Service::OpenDatabase / ContentPrefService__dbInit.", "author": "florian@queze.net", "id": 12279394, "time": "2017-05-01T17:31:12Z"}, {"text": "Related is bug 886907.  Can we just rm -rf this code?", "author": "ehsan@mozilla.com", "id": 12284741, "time": "2017-05-02T19:41:51Z"}, {"text": "ni? to adw for comment 1.", "author": "mconley@mozilla.com", "id": 12293896, "time": "2017-05-04T21:35:21Z"}, {"text": "(In reply to :Ehsan Akhgari (super long backlog, slow to respond) from comment #1)\n> Related is bug 886907.  Can we just rm -rf this code?\n\nThat bug removes synchronous usage of this db connection, but the connection will stay there to serve asynchronous usage.\nWhat we really want (in addition to bug 886907) is bug 887889, that would make all the I/O async.\nAnd then we should check if it's possible to delay the initialization of the service itself.", "author": "mak77@bonardo.net", "id": 12294972, "time": "2017-05-05T07:54:58Z"}, {"text": "(In reply to :Ehsan Akhgari (super long backlog, slow to respond) from comment #1)\n> Related is bug 886907.  Can we just rm -rf this code?\n\nSure.", "author": "adw@mozilla.com", "id": 12306011, "time": "2017-05-10T00:14:59Z"}, {"text": "Here is a first-startup profile where this takes 958ms on the main thread: https://perfht.ml/2sfM8Yt", "author": "florian@queze.net", "id": 12379374, "time": "2017-06-07T14:44:45Z"}, {"text": "I'm not surprised, the service seems to use a transaction to migrate the schema, but not one to create it, see _dbCreate()! And moreover it sets \"PRAGMA synchronous = OFF\" AFTER doing all these expensive operations...\n\nIf we fix bug 886907 then all the APIs are async and should be portable to Sqlite.jsm.\n\nIn the meanwhile, a dumb workaround could consist in either setting PRAGMA synchronous = OFF before creating the schema and use the schema version to differentiate an existing file, or just wrap the schema creation in a transaction.", "author": "mak77@bonardo.net", "id": 12379439, "time": "2017-06-07T15:04:52Z"}, {"text": "Here is another startup profile where this blocks us for 1617ms: https://perfht.ml/2uCYbfB", "author": "florian@queze.net", "id": 12547006, "time": "2017-08-08T16:02:39Z"}, {"text": "(In reply to Marco Bonardo [::mak] from comment #6)\n> I'm not surprised, the service seems to use a transaction to migrate the\n> schema, but not one to create it, see _dbCreate()! And moreover it sets\n> \"PRAGMA synchronous = OFF\" AFTER doing all these expensive operations...\n> \n> If we fix bug 886907 then all the APIs are async and should be portable to\n> Sqlite.jsm.\n\nHey look, this bug got fixed! How hard would it be to port the APIs to Sqlite.jsm and fix this bug, Marco?\n\n\nFlorian, how bad is this problem in your recent startup profiles? Did this get fixed elsewhere?\n\n(Waiting with setting a priority based on this...)", "author": "gijskruitbosch+bugs@gmail.com", "id": 13073741, "time": "2018-02-27T21:40:53Z"}, {"text": "This is pretty much waiting for bug 887889, that has some recent activity. Maybe after bug 887889 there's still some small optimizations we can do here.", "author": "mak77@bonardo.net", "id": 13073914, "time": "2018-02-27T22:29:47Z"}, {"text": "(In reply to :Gijs from comment #8)\n\n> Florian, how bad is this problem in your recent startup profiles? Did this\n> get fixed elsewhere?\n\nRecent startup profiles show this database opened by ContentPrefService2 during FullZoom_init (from browser-fullZoom.js), started during _delayedStartup: https://perfht.ml/2BXYf15\n\nThis is after first paint and the current bug summary says \"main thread IO before the first window is shown\", so I would be OK with closing this bug as WFM.\n\nBut it seems Marco has ideas to make this async, which would be much better, so we can morph the bug to that.", "author": "florian@queze.net", "id": 13075858, "time": "2018-02-28T16:22:33Z"}], "id": 1361095, "priority": "P3", "mentors_detail": [], "cf_crash_signature": "", "version": "unspecified", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox62": "---", "cf_platform_rel": "---", "product": "Firefox", "cf_status_firefox_esr52": "---", "blocks": [1355956], "qa_contact": "", "see_also": ["https://bugzilla.mozilla.org/show_bug.cgi?id=886907"], "cf_fx_iteration": "---", "component": "General", "votes": 2, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "---", "cf_status_firefox60": "---", "target_milestone": "---", "is_cc_accessible": true, "cf_rank": null, "groups": [], "url": "", "creator_detail": {"email": "florian@queze.net", "id": 149052, "name": "florian@queze.net", "real_name": "Florian Qu\u00e8ze [:florian]"}, "whiteboard": "[qf:meta] [fxperf]", "mentors": [], "cc_detail": [{"email": "adw@mozilla.com", "id": 334927, "name": "adw@mozilla.com", "real_name": "Drew Willcoxon :adw"}, {"email": "ehsan@mozilla.com", "id": 251051, "name": "ehsan@mozilla.com", "real_name": ":Ehsan Akhgari"}, {"email": "gijskruitbosch+bugs@gmail.com", "id": 159069, "name": "gijskruitbosch+bugs@gmail.com", "real_name": ":Gijs (he/him)"}, {"email": "mak77@bonardo.net", "id": 240353, "name": "mak77@bonardo.net", "real_name": "Marco Bonardo [::mak]"}, {"email": "mcastelluccio@mozilla.com", "id": 420453, "name": "mcastelluccio@mozilla.com", "real_name": "Marco Castelluccio [:marco]"}, {"email": "mconley@mozilla.com", "id": 403756, "name": "mconley@mozilla.com", "real_name": "Mike Conley (:mconley) (:\u2699\ufe0f) (Catching up on needinfos / reviews)"}, {"email": "nihsanullah@invalid.bugs", "id": 441971, "name": "nihsanullah@invalid.bugs", "real_name": "Naveed Ihsanullah [:naveed]"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-04-10T15:49:56Z", "cf_status_firefox_esr60": "---", "assigned_to": "nobody@mozilla.org", "is_open": true, "resolution": "", "op_sys": "Unspecified", "cf_fx_points": "---", "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "ehsan@mozilla.com"}], "who": "ehsan@mozilla.com", "when": "2017-05-02T19:40:57Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=886907"}], "who": "ehsan@mozilla.com", "when": "2017-05-02T19:42:01Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "gijskruitbosch+bugs@gmail.com"}], "who": "gijskruitbosch+bugs@gmail.com", "when": "2017-05-02T21:35:29Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "adw@mozilla.com, mconley@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(adw@mozilla.com)"}], "who": "mconley@mozilla.com", "when": "2017-05-04T21:35:21Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mak77@bonardo.net"}, {"removed": "", "field_name": "depends_on", "added": "887889"}], "who": "mak77@bonardo.net", "when": "2017-05-05T07:54:58Z"}, {"changes": [{"removed": "needinfo?(adw@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "adw@mozilla.com", "when": "2017-05-10T00:14:59Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "nihsanullah@mozilla.com"}, {"removed": "[qf]", "field_name": "whiteboard", "added": "[qf-]"}], "who": "nihsanullah@invalid.bugs", "when": "2017-05-11T16:47:07Z"}, {"changes": [{"removed": "[qf-]", "field_name": "whiteboard", "added": "[qf:meta]"}], "who": "nihsanullah@invalid.bugs", "when": "2017-05-11T16:47:21Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "886907"}], "who": "nihsanullah@invalid.bugs", "when": "2017-05-11T16:47:50Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "perf"}], "who": "bug-husbandry-bot@mozilla.bugs", "when": "2017-10-07T00:04:04Z"}, {"changes": [{"removed": "[qf:meta]", "field_name": "whiteboard", "added": "[qf:meta] [fxperf]"}], "who": "bug-husbandry-bot@mozilla.bugs", "when": "2018-02-10T00:07:19Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P3"}], "who": "florian@queze.net", "when": "2018-02-16T18:05:48Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(florian@queze.net), needinfo?(mak77@bonardo.net)"}], "who": "gijskruitbosch+bugs@gmail.com", "when": "2018-02-27T21:40:53Z"}, {"changes": [{"removed": "needinfo?(mak77@bonardo.net)", "field_name": "flagtypes.name", "added": ""}], "who": "mak77@bonardo.net", "when": "2018-02-27T22:29:47Z"}, {"changes": [{"removed": "needinfo?(florian@queze.net)", "field_name": "flagtypes.name", "added": ""}], "who": "florian@queze.net", "when": "2018-02-28T16:22:33Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "meta"}], "who": "florian@queze.net", "when": "2018-03-06T13:07:17Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mcastelluccio@mozilla.com"}], "who": "mcastelluccio@mozilla.com", "when": "2018-04-10T15:49:56Z"}]}