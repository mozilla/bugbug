{"cf_tracking_thunderbird_esr52": "---", "cf_tracking_firefox60": "---", "attachments": [{"creator": "gojko@gojko.com", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "image/png", "id": 8934001}, {"creator": "tomica@gmail.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-03T15:57:06Z", "type_id": 4, "creation_date": "2018-03-31T14:08:20Z", "id": 1737640, "setter": "aswan@mozilla.com"}], "content_type": "text/x-review-board-request", "id": 8964119}, {"creator": "marius.santa@softvision.ro", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "image/gif", "id": 8971216}], "cf_tracking_firefox62": "---", "creator": "gojko@gojko.com", "mentors_detail": [], "depends_on": [1454627], "cf_status_firefox_esr60": "---", "cf_user_story": "", "history": [{"changes": [{"removed": "Untriaged", "field_name": "component", "added": "WebExtensions: Untriaged"}, {"removed": "Firefox", "field_name": "product", "added": "Toolkit"}], "who": "yfdyh000@gmail.com", "when": "2017-12-03T18:40:48Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(gojko@gojko.com)"}], "who": "aswan@mozilla.com", "when": "2017-12-07T17:09:19Z"}, {"changes": [{"removed": "needinfo?(gojko@gojko.com)", "field_name": "flagtypes.name", "added": ""}], "who": "gojko@gojko.com", "when": "2017-12-07T17:57:36Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "tomica@gmail.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(tomica@gmail.com)"}], "who": "aswan@mozilla.com", "when": "2017-12-14T22:33:56Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "aswan@mozilla.com"}, {"removed": "win.PopupNotifications is undefined when requesting optional permissions", "field_name": "summary", "added": "win.PopupNotifications is undefined when requesting optional permissions from context menu click"}], "who": "aswan@mozilla.com", "when": "2017-12-14T22:51:29Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "100@pokemori.jp"}], "who": "100@pokemori.jp", "when": "2017-12-16T01:08:00Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "moz-ian@perix.co.uk"}], "who": "moz-ian@perix.co.uk", "when": "2017-12-17T17:50:47Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1382953"}], "who": "moz-ian@perix.co.uk", "when": "2017-12-18T23:43:32Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "yuki@clear-code.com"}], "who": "yuki@clear-code.com", "when": "2017-12-19T01:08:04Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P3"}, {"removed": "", "field_name": "cc", "added": "amckay@mozilla.com"}], "who": "andy+bugzilla@mckay.pub", "when": "2017-12-20T17:23:55Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "tomica@gmail.com"}, {"removed": "needinfo?(tomica@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "tomica@gmail.com", "when": "2018-01-10T19:24:49Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1432083"}], "who": "moz-ian@perix.co.uk", "when": "2018-01-22T19:10:58Z"}, {"changes": [{"removed": "UNCONFIRMED", "field_name": "status", "added": "ASSIGNED"}, {"removed": "0", "field_name": "is_confirmed", "added": "1"}], "who": "tomica@gmail.com", "when": "2018-03-31T14:06:01Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8964119, "added": "review?(aswan@mozilla.com)"}], "who": "tomica@gmail.com", "when": "2018-03-31T14:08:20Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(aswan@mozilla.com)", "attachment_id": 8964119, "added": "review+"}], "who": "aswan@mozilla.com", "when": "2018-04-03T15:57:06Z"}, {"changes": [{"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla61"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-04-04 22:04:36"}, {"removed": "---", "field_name": "cf_status_firefox61", "added": "fixed"}], "who": "nbeleuzu@mozilla.com", "when": "2018-04-04T22:04:36Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "martin@humanoids.be"}], "who": "martin@humanoids.be", "when": "2018-04-10T19:34:05Z"}, {"changes": [{"removed": "martin@humanoids.be", "field_name": "cc", "added": ""}], "who": "martin@humanoids.be", "when": "2018-04-10T19:34:07Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(tomica@gmail.com)"}], "who": "moz-ian@perix.co.uk", "when": "2018-04-13T17:37:07Z"}, {"changes": [{"removed": "needinfo?(tomica@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "tomica@gmail.com", "when": "2018-04-13T18:42:20Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "eight04@gmail.com"}], "who": "aswan@mozilla.com", "when": "2018-04-20T21:17:17Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(tomica@gmail.com)"}], "who": "marius.santa@softvision.ro", "when": "2018-04-26T14:20:10Z"}, {"changes": [{"removed": "needinfo?(tomica@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "tomica@gmail.com", "when": "2018-05-03T21:30:08Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "marius.santa@softvision.ro"}, {"removed": "", "field_name": "depends_on", "added": "1454627"}], "who": "marius.santa@softvision.ro", "when": "2018-05-14T13:37:00Z"}], "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": [], "cc_detail": [{"email": "100@pokemori.jp", "id": 608361, "name": "100@pokemori.jp", "real_name": "100\u306e\u4eba"}, {"email": "andy+bugzilla@mckay.pub", "id": 397635, "name": "andy+bugzilla@mckay.pub", "real_name": "Andy McKay"}, {"email": "aswan@mozilla.com", "id": 561655, "name": "aswan@mozilla.com", "real_name": "Andrew Swan [:aswan] (on PTO until 6/25)"}, {"email": "eight04@gmail.com", "id": 570191, "name": "eight04@gmail.com", "real_name": ""}, {"email": "marius.santa@softvision.ro", "id": 594506, "name": "marius.santa@softvision.ro", "real_name": ""}, {"email": "moz-ian@perix.co.uk", "id": 237483, "name": "moz-ian@perix.co.uk", "real_name": "Ian Moody [:Kwan] (UTC+0)"}, {"email": "tomica@gmail.com", "id": 445095, "name": "tomica@gmail.com", "real_name": "Tomislav Jovanovic :zombie"}, {"email": "yuki@clear-code.com", "id": 61043, "name": "yuki@clear-code.com", "real_name": "YUKI \"Piro\" Hiroshi"}], "cf_last_resolved": "2018-04-04T22:04:36Z", "cf_tracking_firefox61": "---", "votes": 0, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 21, "comments": [{"text": "Created attachment 8934001\nScreen Shot 2017-12-03 at 19.11.33.png\n\nUser Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36\n\nSteps to reproduce:\n\n- Firefox 57.0.1 (64 bit) on MacOS 10.13.1. In an extension, requesting to access additional permissions from a context menu handler. \n\nbrowser.permissions.request({permissions:[\"clipboardRead\", \"clipboardWrite\"]}, function () {/*callback*/})\n\n\nActual results:\n\ncode throws an exception \n\nwin.PopupNotifications is undefined  ExtensionsUI.jsm:343\n\tshowPermissionsPrompt/< resource:///modules/ExtensionsUI.jsm:343:7\n\tshowPermissionsPrompt resource:///modules/ExtensionsUI.jsm:319:12\n\tobserve resource:///modules/ExtensionsUI.jsm:241:15\n\tgetAPI/request/allow< chrome://extensions/content/ext-permissions.js:55:15\n\trequest chrome://extensions/content/ext-permissions.js:45:31\n\tnext self-hosted:1188:9\n\trequest self-hosted:952:17\n\tcall/result< resource://gre/modules/ExtensionParent.jsm:739:57\n\twithPendingBrowser resource://gre/modules/ExtensionParent.jsm:407:26\n\tInterpretGeneratorResume self-hosted:1281:8\n\tnext self-hosted:1188:9\n\tcall resource://gre/modules/ExtensionParent.jsm:738:20\n\tInterpretGeneratorResume self-hosted:1281:8\n\tnext self-hosted:1188:9\nUnchecked lastError value: Error: An unexpected error occurred  ExtensionCommon.jsm:407\n\twithLastError resource://gre/modules/ExtensionCommon.jsm:407:9\n\twrapPromise/< resource://gre/modules/ExtensionCommon.jsm:460:11\n\n\nExpected results:\n\na dialog asking for permissions should show up, as per https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/permissions/request", "author": "gojko@gojko.com", "id": 12892259, "time": "2017-12-03T18:17:11Z"}, {"text": "Can you attach a complete extension that exhibits this problem?  Or alternatively, how did you create the context menu handler?", "author": "aswan@mozilla.com", "id": 12905711, "time": "2017-12-07T17:09:19Z"}, {"text": "Hi,\n\nthe whole extension is on Github (https://github.com/gojko/bugmagnet). The offending menu item is this one https://bugmagnet.org/assets/operational-mode.png\n\nI'm currently disabling the request for Firefox using this line (https://github.com/gojko/bugmagnet/blob/446d985e0b0e96ceff9644b82a504dbebc739ad7/src/main/extension.js#L13). To enable it for firefox, remove !isFireFox and run `npm run pack-extension` to package it into the `pack` dir. The error will show then.\n\nThe context menu item gets created using `chrome.contextMenus.create`, and the handler is added using `chrome.contextMenus.onClicked.addListener((info, tab) => {})`. the onclick parameter to `chrome.contextMenus.create` was not recognised as a user interaction in firefox so it was throwing an error that it cannot ask for additional permissions (chrome actually allows this, and I think FF should too, but this is a separate issue).\n\nIf this is too complicated, let me know and I will create a minimal extension example with just this item.", "author": "gojko@gojko.com", "id": 12905858, "time": "2017-12-07T17:57:36Z"}, {"text": "There's a typo in the previous comment, not sure how to edit it, sorry. Instead of just removing `!isFirefox`, set it to `true` for the menu item to show up.", "author": "gojko@gojko.com", "id": 12905877, "time": "2017-12-07T18:01:54Z"}, {"text": "Huh, I'm not sure if this is a regression or if it never worked.  In browser_ext_user_events.js we test that we properly check for isHandlingUserInput, but not that we actually have a valid browser.\nThe problem is around here:\nhttps://searchfox.org/mozilla-central/rev/110706c3c09d457dc70293b213d7bccb4f6f5643/browser/components/extensions/ext-menus.js#695\n\nWe try to pull the browser from the tab object, but tab is not an actual <tab>, but the extension-facing converted object from:\nhttps://searchfox.org/mozilla-central/rev/110706c3c09d457dc70293b213d7bccb4f6f5643/browser/components/extensions/ext-menus.js#242\n\nThe obvious fix would be to defer all that conversion code from the native event listener until right before we fire the event.  zombie, you know the menus code better than I do, any reason not to do that?", "author": "aswan@mozilla.com", "id": 12919274, "time": "2017-12-14T22:33:56Z"}, {"text": "This error also occurs in an Option page integrated into the browser\u2019s add-ons manager. I saw it in Firefox 57.0.2 and Nightly 59.0a1 (2017-12-15)\n\nExample add-on: <https://github.com/esperecyan/firefox-bug1422605>\n\nThrown exceptions (Nightly):\n\nwin.PopupNotifications is undefined                       ExtensionsUI.jsm:343\n    showPermissionsPrompt/<         resource:///modules/ExtensionsUI.jsm:343:7\n    showPermissionsPrompt          resource:///modules/ExtensionsUI.jsm:319:12\n    observe                        resource:///modules/ExtensionsUI.jsm:241:15\n    getAPI/request/allow< chrome://extensions/content/ext-permissions.js:55:15\n    request               chrome://extensions/content/ext-permissions.js:45:31\n    next                                                    self-hosted:1184:9\n\nError: An unexpected error occurred Async*@moz-extension://c40ac611-35ab-40c6-9bb4-eb8f9ab1f758/options.es:6:21\n    EventListener.handleEvent*@moz-extension://c40ac611-35ab-40c6-9bb4-eb8f9ab1f758/options.es:4:1\n    @moz-extension://c40ac611-35ab-40c6-9bb4-eb8f9ab1f758/options.es:1:2", "author": "100@pokemori.jp", "id": 12921426, "time": "2017-12-16T06:35:48Z"}, {"text": "I also see it with regular mouse clicks and keyboard activation of <input>s in an options page.\nIn that case the problem seems like it might be\nhttps://searchfox.org/mozilla-central/rev/b1e0ae2573e88391a7ed92407568be77994c9317/toolkit/components/extensions/ext-permissions.js#44\nThe immediate cause is that context.xulBrowser is the inner options browser, not the main browser it needs to be to show a notification (pendingEventBrowser is null).  But maybe the actual intervention needs to happen earlier in the code (like in comment #4) so pendingEventBrowser isn't null (context.xulBrowser is the browser for the hidden background extension page in the context menu case).\n\nNot sure if that should be a separate bug or not, but as 100\u306e\u4eba pointed out it has the same error message (which is how I ended up here).", "author": "moz-ian@perix.co.uk", "id": 12924187, "time": "2017-12-18T11:36:52Z"}, {"text": "The issues in options pages are bug 1382953", "author": "aswan@mozilla.com", "id": 12924715, "time": "2017-12-18T17:46:35Z"}, {"text": "(In reply to Andrew Swan [:aswan] from comment #4)\n> Huh, I'm not sure if this is a regression or if it never worked.  In\n> browser_ext_user_events.js we test that we properly check for\n> isHandlingUserInput, but not that we actually have a valid browser.\n\nHmm, I can't find, do we even have a full integration test for the whole optional permission prompt flow?\n\n\n> The problem is around here:\n> https://searchfox.org/mozilla-central/rev/110706c3c09d457dc70293b213d7bccb4f6f5643/browser/components/extensions/ext-menus.js#695\n\nUh, not sure how I missed to notice this is not a NativeTab in bug 1409433, I sorta remember checking that. :\\\n\n\n> The obvious fix would be to defer all that conversion code from the native\n> event listener until right before we fire the event.  zombie, you know the\n> menus code better than I do, any reason not to do that?\n\nYeah, seems reasonable, I'll do that.", "author": "tomica@gmail.com", "id": 12959091, "time": "2018-01-10T19:24:49Z"}, {"text": "Created attachment 8964119\nBug 1422605 - Fix permissions.request() from menus.onClicked listeners\n\nReview commit: https://reviewboard.mozilla.org/r/232898/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/232898/", "author": "tomica@gmail.com", "id": 13170556, "time": "2018-03-31T14:05:38Z"}, {"text": "Comment on attachment 8964119\nBug 1422605 - Fix permissions.request() from menus.onClicked listeners\n\nhttps://reviewboard.mozilla.org/r/232898/#review238878\n\nNice, thank you!", "author": "aswan@mozilla.com", "id": 13176818, "time": "2018-04-03T15:57:06Z"}, {"text": "Comment on attachment 8964119\nBug 1422605 - Fix permissions.request() from menus.onClicked listeners\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/232898/diff/1-2/", "author": "tomica@gmail.com", "id": 13179881, "time": "2018-04-04T15:16:06Z"}, {"text": "Pushed by tomica@gmail.com:\nhttps://hg.mozilla.org/integration/autoland/rev/c1ef30cd61e9\nFix permissions.request() from menus.onClicked listeners r=aswan", "author": "pulsebot@bots.tld", "id": 13180365, "time": "2018-04-04T17:15:15Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/c1ef30cd61e9", "author": "nbeleuzu@mozilla.com", "id": 13181475, "time": "2018-04-04T22:04:36Z"}, {"text": "Hey Tomislav, would this be safe for uplift? Given 60 is an ESR it'd be nice to have I think.", "author": "moz-ian@perix.co.uk", "id": 13204549, "time": "2018-04-13T17:37:07Z"}, {"text": "I think this is safe enough to uplift, but I'm not sure that's reason enough to ask for uplift.  Then again, I don't claim to understand the criteria.", "author": "tomica@gmail.com", "id": 13204764, "time": "2018-04-13T18:42:20Z"}, {"text": "*** Bug 1454627 has been marked as a duplicate of this bug. ***", "author": "aswan@mozilla.com", "id": 13222594, "time": "2018-04-20T21:17:17Z"}, {"text": "Created attachment 8971216\nprmission error.gif\n\nI used the steps from https://bugzilla.mozilla.org/show_bug.cgi?id=1454627 to reproduce this issue and I still get the error on the latest FF build 61.0a1 (20180425220031). The second option \"Test 2\" does not display any error even on the build it was reported on. Please provide more steps or validation that this is the issue so that I can reopen this bug.", "author": "marius.santa@softvision.ro", "id": 13235373, "time": "2018-04-26T14:20:10Z"}, {"text": "I tested the repro on Firefox Dev 61.0b1. If the request is called from browser.menus.onClicked handler, it works. If the request is called from createProperties.onclick, it throws.", "author": "eight04@gmail.com", "id": 13253302, "time": "2018-05-03T21:01:42Z"}, {"text": "Thanks for the reports, I reopened bug 1454627 and will fix there.", "author": "tomica@gmail.com", "id": 13253365, "time": "2018-05-03T21:30:08Z"}, {"text": "Based on https://bugzilla.mozilla.org/show_bug.cgi?id=1422605#c18 and https://bugzilla.mozilla.org/show_bug.cgi?id=1422605#c19 this issue depends on https://bugzilla.mozilla.org/show_bug.cgi?id=1454627.", "author": "marius.santa@softvision.ro", "id": 13275658, "time": "2018-05-14T13:37:00Z"}], "id": 1422605, "priority": "P3", "cc": ["100@pokemori.jp", "andy+bugzilla@mckay.pub", "aswan@mozilla.com", "eight04@gmail.com", "marius.santa@softvision.ro", "moz-ian@perix.co.uk", "tomica@gmail.com", "yuki@clear-code.com"], "cf_crash_signature": "", "version": "57 Branch", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": ["https://bugzilla.mozilla.org/show_bug.cgi?id=1382953", "https://bugzilla.mozilla.org/show_bug.cgi?id=1432083"], "cf_tracking_thunderbird_esr60": "---", "status": "RESOLVED", "product": "Toolkit", "cf_fx_iteration": "---", "blocks": [], "qa_contact": "", "creation_time": "2017-12-03T18:17:11Z", "cf_status_firefox_esr52": "---", "component": "WebExtensions: Untriaged", "assigned_to_detail": {"email": "tomica@gmail.com", "id": 445095, "name": "tomica@gmail.com", "real_name": "Tomislav Jovanovic :zombie"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "fixed", "cf_status_firefox60": "---", "target_milestone": "mozilla61", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "gojko@gojko.com", "id": 607519, "name": "gojko@gojko.com", "real_name": ""}, "whiteboard": "", "mentors": [], "summary": "win.PopupNotifications is undefined when requesting optional permissions from context menu click", "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-05-14T13:37:00Z", "assigned_to": "tomica@gmail.com", "is_open": false, "cf_blocking_webextensions": "---", "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}