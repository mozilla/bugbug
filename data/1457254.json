{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "bugmail@mozilla.staktrace.com", "mentors_detail": [], "depends_on": [], "cf_status_firefox_esr60": "unaffected", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": ["regression"], "cc_detail": [{"email": "a.beingessner@gmail.com", "id": 452386, "name": "a.beingessner@gmail.com", "real_name": "Alexis Beingessner [:Gankro]"}, {"email": "brunno.pleffken@outlook.com", "id": 616706, "name": "brunno.pleffken@outlook.com", "real_name": "Brunno Pleffken"}, {"email": "irvin@mail.moztw.org", "id": 346438, "name": "irvin@mail.moztw.org", "real_name": "Irvin (MozTW)"}, {"email": "irving@cfrq.net", "id": 420324, "name": "irving@cfrq.net", "real_name": ":Irving Reid (No longer working on Firefox)"}, {"email": "jfkthame@gmail.com", "id": 329583, "name": "jfkthame@gmail.com", "real_name": "Jonathan Kew (:jfkthame)"}, {"email": "jhofmann@mozilla.com", "id": 522029, "name": "jhofmann@mozilla.com", "real_name": "Johann Hofmann [:johannh]"}, {"email": "lsalzman@mozilla.com", "id": 536714, "name": "lsalzman@mozilla.com", "real_name": "Lee Salzman [:lsalzman]"}, {"email": "mcastelluccio@mozilla.com", "id": 420453, "name": "mcastelluccio@mozilla.com", "real_name": "Marco Castelluccio [:marco]"}, {"email": "milaninbugzilla@gmail.com", "id": 456486, "name": "milaninbugzilla@gmail.com", "real_name": "Milan Sreckovic [:milan] (needinfo for best results)"}, {"email": "mozillamarcia.knous@gmail.com", "id": 8519, "name": "mozillamarcia.knous@gmail.com", "real_name": "Marcia Knous [:marcia - needinfo? me]"}, {"email": "pascalc@gmail.com", "id": 24572, "name": "pascalc@gmail.com", "real_name": "Pascal Chevrel:pascalc"}, {"email": "past@mozilla.com", "id": 363318, "name": "past@mozilla.com", "real_name": "Panos Astithas [:past] (please ni?)"}], "cf_last_resolved": "2018-05-04T08:38:22Z", "attachments": [{"creator": "lsalzman@mozilla.com", "is_obsolete": 1, "is_patch": 1, "flags": [{"status": "-", "name": "review", "modification_date": "2018-05-02T15:23:19Z", "type_id": 4, "creation_date": "2018-05-02T02:38:57Z", "id": 1751445, "setter": "jfkthame@gmail.com"}], "content_type": "text/plain", "id": 8972483}, {"creator": "jfkthame@gmail.com", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/html", "id": 8972845}, {"creator": "jfkthame@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-05-03T20:46:49Z", "type_id": 4, "creation_date": "2018-05-03T20:28:29Z", "id": 1752439, "setter": "lsalzman@mozilla.com"}], "content_type": "text/plain", "id": 8973018}], "votes": 0, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 21, "comments": [{"text": "On the Apr 26 nightly, mac OS, with gfx.webrender.all enabled. If I go to about:config and type \"webrender\" in the search bar, the entry for gfx.webrender.all (which is bold because of the non-default value) doesn't render at all. Bolded entries on about:config render fine with WR disabled.\n\nPresumably this is a WR-specific version of bug 1455494.", "author": "bugmail@mozilla.staktrace.com", "id": 13236400, "time": "2018-04-26T19:07:09Z"}, {"text": "I didn't confirm, but this is probably a regression from bug 1454598 specific to some WR codepath.", "author": "bugmail@mozilla.staktrace.com", "id": 13236404, "time": "2018-04-26T19:08:41Z"}, {"text": "I'm on macOS 10.13.4 (17E199). Lee asked me to check the font of the missing text using the devtools inspector, but the inspector doesn't let me expand the <treechildren> element which seems to contains all the visible rows (including the non-bolded ones). The computed font-family on the <treechildren> is \"-apple-system\".", "author": "bugmail@mozilla.staktrace.com", "id": 13236417, "time": "2018-04-26T19:14:42Z"}, {"text": "Jonathan, let me know if there's any info I can provide or anything I can to do help debug this. Per IRC discussion in #gfx [1], we take a fallback codepath in WR for about:config because it's XUL, so I believe we'll go down [2] and paint the display item using a BasicLayerManager and then render it as an image with WR.\n\n[1] https://mozilla.logbot.info/gfx/20180426#c14673807 onwards\n[2] https://searchfox.org/mozilla-central/rev/78dbe34925f04975f16cb9a5d4938be714d41897/gfx/layers/wr/WebRenderCommandBuilder.cpp#1292", "author": "bugmail@mozilla.staktrace.com", "id": 13236426, "time": "2018-04-26T19:18:44Z"}, {"text": "It appears that the bug is in using bold -apple-system *in blob images*. XUL (about:config) and -webkit-text-stroke are the two easiest ways to trigger this.\n\nThis example currently shows up as hollow red on macos: \n\ndata:text/html,<span style=\"font-family: -apple-system, sans-serif;font-weight: bold;-webkit-text-stroke: 1px red;\">velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident,</span>\n\nRemoving the -webkit-text-stroke has the bold font pop back in.", "author": "a.beingessner@gmail.com", "id": 13236435, "time": "2018-04-26T19:22:36Z"}, {"text": "The loading of these fonts will be happening around here: https://searchfox.org/mozilla-central/source/gfx/webrender_bindings/Moz2DImageRenderer.cpp#180", "author": "jmuizelaar@mozilla.com", "id": 13236439, "time": "2018-04-26T19:25:04Z"}, {"text": "This looks a lot like bug 1455569, presumably happening on a different code path.", "author": "jfkthame@gmail.com", "id": 13236665, "time": "2018-04-26T20:48:32Z"}, {"text": "*** Bug 1457554 has been marked as a duplicate of this bug. ***", "author": "mstange@themasta.com", "id": 13239022, "time": "2018-04-27T19:49:48Z"}, {"text": "It doesn't happen only in bold, I'm also experiencing missing texts in tab title (e.g. \"New tab\") only when the tab is visible. It can be seen here: https://imgur.com/a/Z1BTQeW", "author": "brunno.pleffken@outlook.com", "id": 13240085, "time": "2018-04-28T20:28:35Z"}, {"text": "Seems to somehow be due to some change in a WR update, though I am still tracking it down...\n\nhttps://bugzilla.mozilla.org/show_bug.cgi?id=1456114", "author": "lsalzman@mozilla.com", "id": 13245095, "time": "2018-04-30T23:54:50Z"}, {"text": "It appears that bug 1457974 is separate from this, and is rather caused by bug 1456114 wherein WR PR https://github.com/servo/webrender/pull/2677 is the guilty change.", "author": "lsalzman@mozilla.com", "id": 13245246, "time": "2018-05-01T01:54:13Z"}, {"text": "Created attachment 8972483\ncopy ScaledFontMac variations with CGFontCopyVariations\n\nAs fallout from bug 1454598, we can't apparently safely use CTFontCopyVariation anymore when we don't actually manually install the variation dict in the CTFont, or the results aren't sane. However, using CGFontCopyVariations instead on the CGFont seems to do the work regardless.", "author": "lsalzman@mozilla.com", "id": 13247604, "time": "2018-05-02T02:38:57Z"}, {"text": "Comment on attachment 8972483\ncopy ScaledFontMac variations with CGFontCopyVariations\n\nReview of attachment 8972483:\n-----------------------------------------------------------------\n\nNo, I'm afraid this doesn't appear to work :\\ ... at least according to my testing on a current mozilla-inbound tree. It does make the \"missing\" text (e.g. bold entries in about:config) reappear, but at the cost of not actually applying the expected variation settings. So the \"bold\" items render with the regular glyphs, just with slightly increased spacing (because layout was based on the metrics of the bold variant).\n\nMore obviously, testing on a site like https://v-fonts.com/, the fonts there no longer respond properly to variations. E.g. if you adjust the Weight slider for the first example (Foreday), the spacing changes as the text is shaped using the variation, but the actual glyphs don't change. Likewise for other example fonts there.", "author": "jfkthame@gmail.com", "id": 13249085, "time": "2018-05-02T15:23:19Z"}, {"text": "*** Bug 1458795 has been marked as a duplicate of this bug. ***", "author": "jhofmann@mozilla.com", "id": 13251615, "time": "2018-05-03T10:13:17Z"}, {"text": "Created attachment 8972845\ntestcase using font-variation-settings\n\nHere's a testcase that shows the same failure, and also fails on builds -before- bug 1454598 was landed. The correct rendering should show no red (as when webrender is disabled).\n\nThe issue here is an underlying failure to handle variation settings on system-installed fonts, and was just exposed more widely by bug 1454598 because that hooked up the font-weight/font-stretch properties to variation axes, so the bug no longer requires explicit use of font-variation-settings to show itself.\n\nI still don't understand why this fails only with text in blob images (per comment 4), while the variations work fine otherwise.", "author": "jfkthame@gmail.com", "id": 13251739, "time": "2018-05-03T11:35:27Z"}, {"text": "Created attachment 8973018\nDon't pass true for aIsDataFont when creating an UnscaledFontMac from AddNativeFontHandle, this is for installed fonts\n\nThis isn't a problem with the variations we retrieve in ScaledFontMac::GetWRFontInstanceOptions at all. That works fine. I think the real problem here is that we're incorrectly marking an UnscaledFontMac as being a data font when in fact it's a native installed font, and this leads to using the wrong code path in CreateCTFontFromCGFontWithVariations. With the flag fixed here, it seems to be working correctly, at least in all the cases I've tested so far.", "author": "jfkthame@gmail.com", "id": 13253229, "time": "2018-05-03T20:28:29Z"}, {"text": "Comment on attachment 8973018\nDon't pass true for aIsDataFont when creating an UnscaledFontMac from AddNativeFontHandle, this is for installed fonts\n\nThis appears to resolve the issue in my testing as well.", "author": "lsalzman@mozilla.com", "id": 13253284, "time": "2018-05-03T20:46:49Z"}, {"text": "Comment on attachment 8972483\ncopy ScaledFontMac variations with CGFontCopyVariations\n\n># HG changeset patch\n># User Lee Salzman <lsalzman@mozilla.com>\n># Date 1525226477 14400\n>#      Tue May 01 22:01:17 2018 -0400\n># Node ID 9f64e53674c59f89966c0d6b6a685f8452b2b7c2\n># Parent  258fa1eb49c9a559f0f75bd0a597d14398b01430\n>copy ScaledFontMac variations with CGFontCopyVariations\n>\n>MozReview-Commit-ID: DCsBAD0GekB\n>\n>diff --git a/gfx/2d/ScaledFontMac.cpp b/gfx/2d/ScaledFontMac.cpp\n>--- a/gfx/2d/ScaledFontMac.cpp\n>+++ b/gfx/2d/ScaledFontMac.cpp\n>@@ -399,53 +399,53 @@ CollectVariationsFromDictionary(const vo\n>     if (CFNumberGetValue(static_cast<CFNumberRef>(keyPtr), kCFNumberSInt64Type, &t) &&\n>         CFNumberGetValue(static_cast<CFNumberRef>(valuePtr), kCFNumberDoubleType, &v)) {\n>       outVariations->push_back(FontVariation{uint32_t(t), float(v)});\n>     }\n>   }\n> }\n> \n> static bool\n>-GetVariationsForCTFont(CTFontRef aCTFont, std::vector<FontVariation>* aOutVariations)\n>+GetVariationsForCGFont(CGFontRef aCGFont, std::vector<FontVariation>* aOutVariations)\n> {\n>   // Avoid calling potentially buggy variation APIs on pre-Sierra macOS\n>   // versions (see bug 1331683)\n>   if (!nsCocoaFeatures::OnSierraOrLater()) {\n>     return true;\n>   }\n>-  if (!aCTFont) {\n>+  if (!aCGFont) {\n>     return true;\n>   }\n>-  AutoRelease<CFDictionaryRef> dict(CTFontCopyVariation(aCTFont));\n>+  AutoRelease<CFDictionaryRef> dict(CGFontCopyVariations(aCGFont));\n>   CFIndex count = dict ? CFDictionaryGetCount(dict) : 0;\n>   if (count > 0) {\n>     aOutVariations->reserve(count);\n>     CFDictionaryApplyFunction(dict, CollectVariationsFromDictionary, aOutVariations);\n>   }\n>   return true;\n> }\n> \n> bool\n> ScaledFontMac::GetFontInstanceData(FontInstanceDataOutput aCb, void* aBaton)\n> {\n>   // Collect any variation settings that were incorporated into the CTFont.\n>   std::vector<FontVariation> variations;\n>-  if (!GetVariationsForCTFont(mCTFont, &variations)) {\n>+  if (!GetVariationsForCGFont(mFont, &variations)) {\n>     return false;\n>   }\n>   aCb(nullptr, 0, variations.data(), variations.size(), aBaton);\n>   return true;\n> }\n> \n> bool\n> ScaledFontMac::GetWRFontInstanceOptions(Maybe<wr::FontInstanceOptions>* aOutOptions,\n>                                         Maybe<wr::FontInstancePlatformOptions>* aOutPlatformOptions,\n>                                         std::vector<FontVariation>* aOutVariations)\n> {\n>-  GetVariationsForCTFont(mCTFont, aOutVariations);\n>+  GetVariationsForCGFont(mFont, aOutVariations);\n> \n>   wr::FontInstanceOptions options;\n>   options.render_mode = wr::FontRenderMode::Subpixel;\n>   options.subpx_dir = wr::SubpixelDirection::Horizontal;\n>   options.flags = 0;\n>   if (mUseFontSmoothing) {\n>     options.flags |= wr::FontInstanceFlags::FONT_SMOOTHING;\n>   }", "author": "lsalzman@mozilla.com", "id": 13253285, "time": "2018-05-03T20:47:19Z"}, {"text": "Pushed by jkew@mozilla.com:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/d66c6d818c89\nDon't pass true for aIsDataFont when creating an UnscaledFontMac from AddNativeFontHandle, this is for installed fonts. r=lsalzman", "author": "pulsebot@bots.tld", "id": 13253326, "time": "2018-05-03T21:17:27Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/d66c6d818c89", "author": "shindli@mozilla.com", "id": 13254096, "time": "2018-05-04T08:38:22Z"}, {"text": "*** Bug 1457555 has been marked as a duplicate of this bug. ***", "author": "ryanvm@gmail.com", "id": 13260217, "time": "2018-05-07T18:14:44Z"}], "id": 1457254, "priority": "P1", "cc": ["a.beingessner@gmail.com", "brunno.pleffken@outlook.com", "irvin@mail.moztw.org", "irving@cfrq.net", "jfkthame@gmail.com", "jhofmann@mozilla.com", "lsalzman@mozilla.com", "mcastelluccio@mozilla.com", "milaninbugzilla@gmail.com", "mozillamarcia.knous@gmail.com", "pascalc@gmail.com", "past@mozilla.com"], "cf_crash_signature": "", "version": "Other Branch", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": ["https://bugzilla.mozilla.org/show_bug.cgi?id=1457974"], "cf_tracking_thunderbird_esr60": "---", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1386674, 1454598], "qa_contact": "", "creation_time": "2018-04-26T19:07:09Z", "cf_status_firefox_esr52": "unaffected", "component": "Graphics: WebRender", "assigned_to_detail": {"email": "jfkthame@gmail.com", "id": 329583, "name": "jfkthame@gmail.com", "real_name": "Jonathan Kew (:jfkthame)"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "fixed", "cf_status_firefox60": "unaffected", "target_milestone": "mozilla61", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "bugmail@mozilla.staktrace.com", "id": 426788, "name": "bugmail@mozilla.staktrace.com", "real_name": "Kartikaya Gupta (email:kats@mozilla.com)"}, "whiteboard": "[gfx-noted]", "mentors": [], "summary": "Bold font not rendering on macOS with WR enabled", "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-05-07T18:33:17Z", "assigned_to": "jfkthame@gmail.com", "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "blocks", "added": "1454598"}], "who": "bugmail@mozilla.staktrace.com", "when": "2018-04-26T19:08:41Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "lsalzman@mozilla.com"}], "who": "lsalzman@mozilla.com", "when": "2018-04-26T19:11:27Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(jfkthame@gmail.com)"}], "who": "bugmail@mozilla.staktrace.com", "when": "2018-04-26T19:18:44Z"}, {"changes": [{"removed": "needinfo?(jfkthame@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "jfkthame@gmail.com", "when": "2018-04-26T20:48:32Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "regression"}, {"removed": "", "field_name": "cc", "added": "mcastelluccio@mozilla.com"}], "who": "mcastelluccio@mozilla.com", "when": "2018-04-27T13:32:30Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P1"}, {"removed": "", "field_name": "cc", "added": "milan@mozilla.com"}, {"removed": "", "field_name": "blocks", "added": "1386674"}], "who": "milaninbugzilla@gmail.com", "when": "2018-04-27T16:09:23Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "past@mozilla.com"}], "who": "mstange@themasta.com", "when": "2018-04-27T19:49:48Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "brunno.pleffken@outlook.com"}], "who": "brunno.pleffken@outlook.com", "when": "2018-04-28T20:28:35Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1457974"}], "who": "bugmail@mozilla.staktrace.com", "when": "2018-04-30T18:02:10Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1456114"}], "who": "lsalzman@mozilla.com", "when": "2018-04-30T23:54:50Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1457974"}, {"removed": "1457974, 1456114", "field_name": "blocks", "added": ""}], "who": "lsalzman@mozilla.com", "when": "2018-05-01T01:54:13Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mozillamarcia.knous@gmail.com"}], "who": "mozillamarcia.knous@gmail.com", "when": "2018-05-01T17:23:57Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "ASSIGNED"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "lsalzman@mozilla.com"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8972483, "added": "review?(jfkthame@gmail.com)"}], "who": "lsalzman@mozilla.com", "when": "2018-05-02T02:38:57Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "pascalc@gmail.com"}], "who": "pascalc@gmail.com", "when": "2018-05-02T12:37:05Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(jfkthame@gmail.com)", "attachment_id": 8972483, "added": "review-"}], "who": "jfkthame@gmail.com", "when": "2018-05-02T15:23:19Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "jhofmann@mozilla.com"}], "who": "jhofmann@mozilla.com", "when": "2018-05-02T18:38:32Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "irvin@mail.moztw.org"}], "who": "jhofmann@mozilla.com", "when": "2018-05-03T10:13:17Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "irving@cfrq.net"}], "who": "irvin@mail.moztw.org", "when": "2018-05-03T12:23:20Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8973018, "added": "review?(lsalzman@mozilla.com)"}], "who": "jfkthame@gmail.com", "when": "2018-05-03T20:28:29Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(lsalzman@mozilla.com)", "attachment_id": 8973018, "added": "review+"}], "who": "lsalzman@mozilla.com", "when": "2018-05-03T20:46:49Z"}, {"changes": [{"removed": "lsalzman@mozilla.com", "field_name": "assigned_to", "added": "jfkthame@gmail.com"}], "who": "lsalzman@mozilla.com", "when": "2018-05-03T20:47:03Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8972483, "added": "1"}], "who": "lsalzman@mozilla.com", "when": "2018-05-03T20:47:19Z"}, {"changes": [{"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla61"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-05-04 08:38:22"}, {"removed": "---", "field_name": "cf_status_firefox61", "added": "fixed"}], "who": "shindli@mozilla.com", "when": "2018-05-04T08:38:22Z"}, {"changes": [{"removed": "---", "field_name": "cf_status_firefox_esr52", "added": "unaffected"}, {"removed": "---", "field_name": "cf_status_firefox_esr60", "added": "unaffected"}, {"removed": "---", "field_name": "cf_status_firefox60", "added": "unaffected"}], "who": "ryanvm@gmail.com", "when": "2018-05-07T18:33:17Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}