{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "dminor@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2016-06-08T13:46:31Z", "type_id": 4, "creation_date": "2016-06-07T16:04:50Z", "id": 1407350, "setter": "rjesup@jesup.org"}], "content_type": "text/x-review-board-request", "id": 8760810}], "classification": "Components", "creator": "jon.peter.davies@gmail.com", "mentors_detail": [], "depends_on": [], "cf_has_str": "---", "cf_user_story": "", "cf_backlog": "webrtc/webaudio+", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "OpenH264 appears to send STAP-A aggregation packets in mode 0", "cf_last_resolved": "2016-06-12T09:30:19Z", "cf_status_firefox50": "fixed", "votes": 2, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 13, "comments": [{"text": "User Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/42.0.2311.152 Safari/537.36\n\nSteps to reproduce:\n\nWebRTC call with a desktop (non-browser) endpoint on Windows, using JsSIP and Kamailio SIP proxy. The endpoint offers this in its SDP:\n\nm=video <port> RTP/SAVPF 97\na=fmtp:97 profile-level-id=42801F\n\nFollowing discussions with Randell Jesup (at mozilla.dev.media), I managed to alter the SDP so that Firefox accepts the SDP by changing the profile-level-id to 42e01F (Constrained Baseline?). \n\n\nActual results:\n\nThe call succeeds, and we get 2-way video. Firefox is decoding the H264 video sent by the endpoint, but the endpoint is not able to decode the video sent by Firefox. \n\nThe call negotiated packetisation-mode 0 (which is what the endpoint expects) since this was not specified in the SDP offer/answer exchange and is the default. \n\nOn analysis on the remote endpoint by my colleague, the NALU header received is 0x78 indicating STAP-A. My colleague asserts that this NALU value should not have been sent.  \n\n\nExpected results:\n\nIf the negotiation was for mode 0, then Firefox should not send a STAP-A (reference discussion https://groups.google.com/forum/#!topic/mozilla.dev.media/z3HrVEfvlsU).", "author": "jon.peter.davies@gmail.com", "id": 10299621, "time": "2015-05-22T10:01:59Z"}, {"text": "possibly a regression in 38 due to the webrtc_40 update\n\nLikely we need to add the mode to the codecSpecific structure and use that in the h264 packetizer, and key off that to skip both FuA and STAP-A processing.  (FuA shouldn't get invoked as the max encoder NAL size should be < 1 RTP packet)", "author": "rjesup@jesup.org", "id": 10302487, "time": "2015-05-22T21:02:50Z"}, {"text": "When do you this might be resolved?", "author": "jon.peter.davies@gmail.com", "id": 10340870, "time": "2015-06-03T14:21:56Z"}, {"text": "This will be resolved in 42, and may uplift to 41 (likely the fix is simple)", "author": "rjesup@jesup.org", "id": 10431924, "time": "2015-06-29T18:56:17Z"}, {"text": "*** Bug 1157262 has been marked as a duplicate of this bug. ***", "author": "rjesup@jesup.org", "id": 10431932, "time": "2015-06-29T18:57:12Z"}, {"text": "I'm having the same issue. P slices, etc are packetized as Single NAL units as expected, but I'm seeing SPS/PPS, and the first I slice sent as STAP-A.\n\nMay be related to webrtc/modules/rtp_rtcp/source/rtp_format_h264.cc:80-86", "author": "tsteeves@gmail.com", "id": 10436677, "time": "2015-06-30T18:58:43Z"}, {"text": "(In reply to Timothy Steeves from comment #5)\n> I'm having the same issue. P slices, etc are packetized as Single NAL units\n> as expected, but I'm seeing SPS/PPS, and the first I slice sent as STAP-A.\n> \n> May be related to webrtc/modules/rtp_rtcp/source/rtp_format_h264.cc:80-86\n\nYes.  The issue is some work needs to be done to expose the negotiated mode to the level of code that packetizes.", "author": "rjesup@jesup.org", "id": 10447944, "time": "2015-07-02T21:27:54Z"}, {"text": "Bumping the rank up because we'd love to land this in Fx50 if we can.", "author": "mreavy@mozilla.com", "id": 11469602, "time": "2016-06-07T15:33:47Z"}, {"text": "Created attachment 8760810\nBug 1167544 - OpenH264 should not send STAP-A aggregation packets in mode 0;\n\nReview commit: https://reviewboard.mozilla.org/r/58254/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/58254/", "author": "dminor@mozilla.com", "id": 11469707, "time": "2016-06-07T16:04:50Z"}, {"text": "Comment on attachment 8760810\nBug 1167544 - OpenH264 should not send STAP-A aggregation packets in mode 0;\n\nhttps://reviewboard.mozilla.org/r/58254/#review55376\n\nThanks!\n\n::: media/webrtc/signaling/src/media-conduit/WebrtcGmpVideoCodec.cpp:646\n(Diff revision 1)\n> -      mCallback->Encoded(unit, nullptr, &fragmentation);\n> +      GMPCodecSpecificInfo info;\n> +      memcpy(&info, aCodecSpecificInfo.Elements(), sizeof(GMPCodecSpecificInfo));\n> +      webrtc::CodecSpecificInfo codecSpecificInfo;\n> +      codecSpecificInfo.codecType = webrtc::kVideoCodecH264;\n> +      // TODO: Currently the OpenH264 codec does not preserve any codec\n> +      //       specific info passed into it, so even if we were to add\n> +      //       packetization mode to the codec specific info, the value\n> +      //       passed in would not be returned to us. If this changes in the\n> +      //       future, it would be nice to get rid of mPacketizationMode.\n> +      codecSpecificInfo.codecSpecific.H264.packetizationMode = mPacketizationMode;\n> +      codecSpecificInfo.codecSpecific.H264.simulcastIdx = info.mCodecSpecific.mH264.mSimulcastIdx;\n> +      mCallback->Encoded(unit, &codecSpecificInfo, &fragmentation);\n\nthis data is basically static, is it not?  Can we just generate it once in mCodecSpecificInfo?  Perhaps assert the simulcast index doesn't change if we're paranoid\n\n::: media/webrtc/trunk/webrtc/modules/rtp_rtcp/source/rtp_format_h264.h:25\n(Diff revision 1)\n> -  RtpPacketizerH264(FrameType frame_type, size_t max_payload_len);\n> +  RtpPacketizerH264(FrameType frame_type,\n> +                    size_t max_payload_len,\n> +                    bool use_stap_a);\n\nWe should pass the packetization mode in (or rename the boolean as use_mode_1) - since we also want to disallow FU-A packets in mode 0, and if the encoder generates too-large payloads just make an oversize packet and hope (or just fail)\n\n::: media/webrtc/trunk/webrtc/video_engine/vie_encoder.cc:636\n(Diff revision 1)\n>    }\n>  #endif\n>    // XXX fix VP9 (bug 1138629)\n>  \n> +  // See Bug 1167544, we need to pass in the packetization mode to avoid\n> +  // sending STA-A packets in mode 0. Although VideoCodingModule has all\n\nSTAP-A", "author": "rjesup@jesup.org", "id": 11472358, "time": "2016-06-08T13:46:32Z"}, {"text": "Comment on attachment 8760810\nBug 1167544 - OpenH264 should not send STAP-A aggregation packets in mode 0;\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/58254/diff/1-2/", "author": "dminor@mozilla.com", "id": 11478134, "time": "2016-06-10T13:33:15Z"}, {"text": "Pushed by dminor@mozilla.com:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/3374f4fc0705\nOpenH264 should not send STAP-A aggregation packets in mode 0; r=jesup", "author": "pulsebot@bots.tld", "id": 11478151, "time": "2016-06-10T13:38:24Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/3374f4fc0705", "author": "cbook@mozilla.com", "id": 11480482, "time": "2016-06-12T09:30:19Z"}], "id": 1167544, "priority": "P1", "cc": ["ankur@techgentsia.com", "dminor@mozilla.com", "ethanhugg@gmail.com", "mreavy@mozilla.com", "mzanaty@cisco.com", "rjesup@jesup.org", "tsteeves@gmail.com"], "cf_crash_signature": "", "version": "38 Branch", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "see_also": ["https://bugzilla.mozilla.org/show_bug.cgi?id=1255408"], "cf_tracking_firefox59": "---", "last_change_time": "2016-08-08T22:07:51Z", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1293422], "qa_contact": "", "creation_time": "2015-05-22T10:01:59Z", "cf_status_firefox_esr52": "---", "component": "WebRTC: Networking", "assigned_to_detail": {"email": "dminor@mozilla.com", "id": 466787, "name": "dminor@mozilla.com", "real_name": "Dan Minor [:dminor]"}, "groups": [], "cf_status_firefox60": "---", "target_milestone": "mozilla50", "is_cc_accessible": true, "cf_rank": "15", "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "jon.peter.davies@gmail.com", "id": 539685, "name": "jon.peter.davies@gmail.com", "real_name": ""}, "whiteboard": "[h264]", "mentors": [], "cc_detail": [{"email": "ankur@techgentsia.com", "id": 537353, "name": "ankur@techgentsia.com", "real_name": "ankur"}, {"email": "dminor@mozilla.com", "id": 466787, "name": "dminor@mozilla.com", "real_name": "Dan Minor [:dminor]"}, {"email": "ethanhugg@gmail.com", "id": 436277, "name": "ethanhugg@gmail.com", "real_name": "Ethan Hugg [:ehugg]"}, {"email": "mreavy@mozilla.com", "id": 74434, "name": "mreavy@mozilla.com", "real_name": "Maire Reavy [:mreavy] Plz needinfo?"}, {"email": "mzanaty@cisco.com", "id": 512932, "name": "mzanaty@cisco.com", "real_name": ""}, {"email": "rjesup@jesup.org", "id": 11539, "name": "rjesup@jesup.org", "real_name": "Randell Jesup [:jesup]"}, {"email": "tsteeves@gmail.com", "id": 542672, "name": "tsteeves@gmail.com", "real_name": "Timothy Steeves"}], "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "assigned_to": "dminor@mozilla.com", "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "ethanhugg@gmail.com, mzanaty@cisco.com, rjesup@jesup.org"}, {"removed": "Untriaged", "field_name": "component", "added": "WebRTC: Networking"}, {"removed": "Firefox", "field_name": "product", "added": "Core"}, {"removed": "OpenH264 video can't be decoded by non-browser endpoint when mode 0 is negotiated", "field_name": "summary", "added": "OpenH264 appears to send STAP-A aggregation packets in mode 0"}], "who": "rjesup@jesup.org", "when": "2015-05-22T21:02:50Z"}, {"changes": [{"removed": "", "field_name": "cf_rank", "added": "23"}, {"removed": "--", "field_name": "priority", "added": "P2"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "rjesup@jesup.org"}, {"removed": "", "field_name": "whiteboard", "added": "[h264]"}, {"removed": "---", "field_name": "cf_backlog", "added": "webRTC+"}], "who": "sescalante@mozilla.com", "when": "2015-06-03T17:51:17Z"}, {"changes": [{"removed": "UNCONFIRMED", "field_name": "status", "added": "ASSIGNED"}, {"removed": "0", "field_name": "is_confirmed", "added": "1"}], "who": "rjesup@jesup.org", "when": "2015-06-29T18:56:17Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "ankur@techgentsia.com"}], "who": "rjesup@jesup.org", "when": "2015-06-29T18:57:12Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "tsteeves@gmail.com"}], "who": "tsteeves@gmail.com", "when": "2015-06-30T18:58:43Z"}, {"changes": [{"removed": "23", "field_name": "cf_rank", "added": "15"}, {"removed": "P2", "field_name": "priority", "added": "P1"}], "who": "rjesup@jesup.org", "when": "2015-07-02T21:27:54Z"}, {"changes": [{"removed": "15", "field_name": "cf_rank", "added": "17"}], "who": "rjesup@jesup.org", "when": "2016-01-05T18:56:01Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1255408"}], "who": "rjesup@jesup.org", "when": "2016-03-11T21:28:51Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "dminor@mozilla.com"}, {"removed": "rjesup@jesup.org", "field_name": "assigned_to", "added": "dminor@mozilla.com"}], "who": "dminor@mozilla.com", "when": "2016-06-01T14:48:59Z"}, {"changes": [{"removed": "17", "field_name": "cf_rank", "added": "15"}, {"removed": "", "field_name": "cc", "added": "mreavy@mozilla.com"}], "who": "mreavy@mozilla.com", "when": "2016-06-07T15:33:47Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8760810, "added": "review?(rjesup@jesup.org)"}], "who": "dminor@mozilla.com", "when": "2016-06-07T16:04:50Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(rjesup@jesup.org)", "attachment_id": 8760810, "added": "review+"}], "who": "rjesup@jesup.org", "when": "2016-06-08T13:46:31Z"}, {"changes": [{"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla50"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2016-06-12 09:30:19"}, {"removed": "---", "field_name": "cf_status_firefox50", "added": "fixed"}], "who": "cbook@mozilla.com", "when": "2016-06-12T09:30:19Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1293422"}], "who": "drno@ohlmeier.org", "when": "2016-08-08T22:07:51Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}