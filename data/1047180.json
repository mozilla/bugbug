{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "jyavenard@mozilla.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8469971}, {"creator": "jyavenard@mozilla.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8470577}, {"creator": "jyavenard@mozilla.com", "is_obsolete": 1, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2014-08-11T02:01:57Z", "type_id": 4, "creation_date": "2014-08-11T01:26:16Z", "id": 947005, "setter": "cpearce@mozilla.com"}], "content_type": "text/plain", "id": 8470578}, {"creator": "jyavenard@mozilla.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8470633}, {"creator": "jyavenard@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8472048}], "classification": "Components", "creator": "ajones@mozilla.com", "cc": ["blakewu0205@gmail.com", "cpearce@mozilla.com", "fb+mozdev@quantumedia.de", "jyavenard@mozilla.com", "mkhoo@mozilla.com"], "depends_on": [], "creation_time": "2014-08-01T02:11:53Z", "cf_user_story": "", "cf_backlog": "---", "cf_tracking_firefox_relnote": "---", "platform": "x86_64", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "Add HE-AAC support to MP4Reader", "id": 1047180, "assigned_to_detail": {"email": "jyavenard@mozilla.com", "id": 512198, "name": "jyavenard@mozilla.com", "real_name": "Jean-Yves Avenard [:jya]"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "assigned_to": "jyavenard@mozilla.com", "comment_count": 15, "comments": [{"text": "Steps to reproduce:\n\n* Enable MP4 reader prefs\n* Navigate to link\n* Press play\n\nExpected results:\n\nNormal playback\n\nActual results:\n\nHalf speed playback\n\nThe issue is that the MP4 container reports 24K sample rate but we need to get the sample rate from the decoder which knows the correct sample rate.", "author": "ajones@mozilla.com", "id": 9128398, "time": "2014-08-01T02:11:53Z"}, {"text": "Another testcase: http://www-tvline-com.vimg.net/streaming/tvline/MAA101-Medianet.mp4\n\nRalph tried this with his MacOSX backend, and it seemed to work there, so maybe the MacOSX backend is not using SBS/PS and so returning the lower quality output?", "author": "cpearce@mozilla.com", "id": 9151731, "time": "2014-08-07T03:34:30Z"}, {"text": "The basic fix here should be:\n\n* Add a rate and channels field to AudioData. There's a bit of work here to change the existing call sites of the AudioData constructor in all backends to pass in this new data.\n* In MP4Reader::ReadMetadata(), after we've setup the MediaDataDecoders, we should decode one audio sample and check the audio rate and number of channels. Report that in the MediaInfo of MP4Reader::ReadMetadata().\n\nWe prefer adding the rate and channels fields to AudioData over adding a callback to report stream changes because we already have this precedent set by video stream changes, and because we want to move towards having lightweight AudioStreams, where all audio sources playing pass in audio samples of arbitrary rates, and the AudioStream mixes them to the output rate. If we use callbacks, we would need to forward the callback all the way up the stack, and then keep track of which audio samples were before/after the rate change, so we'd need basically these fields anyway.", "author": "cpearce@mozilla.com", "id": 9151744, "time": "2014-08-07T03:41:13Z"}, {"text": "Note on why it works on OSX...\n\nOSX doesn't use the sampling rate provided by the demuxer.\nInstead it uses its own probe method AudioFileStreamParseBytes ; which actually also detects the audio as being 24kHz.\nFFmpeg decoder returns the raw PCM data, while OSX decoder outputs data in the format/rate requested here 22kHz and perform on the fly resampling if required.\nSo on mac it sounds good.\n\nI haven't figured out a way to determine the actual sampling rate using CoreAudio AudioConverter...\nit would probably allow for better audio quality as we wouldn't lose half the audio resolution", "author": "jyavenard@mozilla.com", "id": 9158286, "time": "2014-08-08T09:59:20Z"}, {"text": "Created attachment 8469971\nDecode a single audio frame in order to retrieve accurate channel count and sampling rate and propagate to MP4Reader\n\nBug 1047180 - Retrieve sampling rate from decoder", "author": "jyavenard@mozilla.com", "id": 9158472, "time": "2014-08-08T11:05:24Z"}, {"text": "Comment on attachment 8469971\nDecode a single audio frame in order to retrieve accurate channel count and sampling rate and propagate to MP4Reader\n\nReview of attachment 8469971:\n-----------------------------------------------------------------\n\n::: content/media/fmp4/MP4Reader.cpp\n@@ +348,5 @@\n>      NS_ENSURE_SUCCESS(rv, rv);\n> +\n> +    // Decode one audio sample to detect potentially incorrect channels count or\n> +    // sampling rate from demuxer.\n> +    nsAutoPtr<MP4Sample> audioSample(PopSample(kAudio));\n\nYou should probably just call Decode(kAudio) in a loop while AudioQueue() is empty and an error or EOS isn't hit.\n\n::: content/media/fmp4/wmf/WMFAudioMFTManager.cpp\n@@ +234,5 @@\n>                             timestamp,\n>                             duration,\n>                             numFrames,\n>                             audioData.forget(),\n> +                           mAudioChannels, mAudioRate);\n\nThe patch in bug 1050064 should handle the WMFAudioMFTManager.", "author": "cpearce@mozilla.com", "id": 9160598, "time": "2014-08-08T19:55:28Z"}, {"text": "Created attachment 8470577\nDecode a single audio frame in order to retrieve accurate channel count and sampling rate and propagate to MP4Reader\n\nBug 1047180: Fix AAC-HE playback", "author": "jyavenard@mozilla.com", "id": 9164452, "time": "2014-08-11T01:22:13Z"}, {"text": "Created attachment 8470578\nDecode a single audio frame in order to retrieve accurate channel count and sampling rate and propagate to MP4Reader\n\nBug 1047180: Fix AAC-HE playback", "author": "jyavenard@mozilla.com", "id": 9164454, "time": "2014-08-11T01:26:16Z"}, {"text": "Comment on attachment 8470578\nDecode a single audio frame in order to retrieve accurate channel count and sampling rate and propagate to MP4Reader\n\nReview of attachment 8470578:\n-----------------------------------------------------------------\n\nLooks good.\n\n::: content/media/fmp4/MP4Reader.cpp\n@@ +596,5 @@\n> +        LOG(\"MP4Reader::Output change of sampling rate:%d->%d\",\n> +            mInfo.mAudio.mRate, audioData->mRate);\n> +        mInfo.mAudio.mRate = audioData->mRate;\n> +        mInfo.mAudio.mChannels = audioData->mChannels;\n> +        // TODO What do we do when we have a format change?\n\nWe don't do anything now, we will let the MediaDecoderStateMachine handle it the change when it come to play this data.\n\nSo you can remove this comment.\n\nIf we encounter a stream change in anything other than the first sample, we should call mDecoder->QueueMetadata() (so that JS gets a \"loadedmetadata\" event dispatched to the media element), but until we find an example of a file that causes that, we should not do that yet.", "author": "cpearce@mozilla.com", "id": 9164480, "time": "2014-08-11T02:01:57Z"}, {"text": "Created attachment 8470633\nDecode a single audio frame in order to retrieve accurate channel count and sampling rate and propagate to MP4Reader\n\nBug 1047180: carrying r+", "author": "jyavenard@mozilla.com", "id": 9164809, "time": "2014-08-11T05:27:20Z"}, {"text": "https://tbpl.mozilla.org/?tree=Try&rev=acf2a451f0d8", "author": "jyavenard@mozilla.com", "id": 9169997, "time": "2014-08-12T01:54:56Z"}, {"text": "Created attachment 8472048\nDecode a single audio frame in order to retrieve accurate channel count and sampling rate and propagate to MP4Reader\n\nFix GonkAudio build on Android", "author": "jyavenard@mozilla.com", "id": 9176356, "time": "2014-08-13T03:02:59Z"}, {"text": "https://tbpl.mozilla.org/?tree=Try&rev=d75ff0f4bd6a", "author": "jyavenard@mozilla.com", "id": 9176718, "time": "2014-08-13T06:00:25Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/c869d969bc12", "author": "ryanvm@gmail.com", "id": 9178145, "time": "2014-08-13T13:42:02Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/c869d969bc12", "author": "ryanvm@gmail.com", "id": 9180043, "time": "2014-08-13T19:38:06Z"}], "cf_last_resolved": "2014-08-13T19:38:06Z", "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "Trunk", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2014-08-19T23:41:58Z", "cf_platform_rel": "---", "product": "Core", "cf_status_firefox_esr52": "---", "blocks": [1055841, 799318, 1022501, 1039149, 1050064, 1052383], "qa_contact": "", "see_also": [], "cf_fx_iteration": "---", "component": "Audio/Video", "votes": 0, "groups": [], "cf_status_firefox60": "---", "target_milestone": "mozilla34", "is_cc_accessible": true, "cf_status_thunderbird_esr52": "---", "url": "http://dash.edgesuite.net/dash264/TestCases/1a/netflix/ElephantsDream_AAC48K_064.mp4.dash", "creator_detail": {"email": "ajones@mozilla.com", "id": 443088, "name": "ajones@mozilla.com", "real_name": "Anthony Jones (:kentuckyfriedtakahe, :k17e)"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "blakewu0205@gmail.com", "id": 488943, "name": "blakewu0205@gmail.com", "real_name": "Blake Wu [:bwu][:blakewu]"}, {"email": "cpearce@mozilla.com", "id": 287422, "name": "cpearce@mozilla.com", "real_name": "Chris Pearce (:cpearce)"}, {"email": "fb+mozdev@quantumedia.de", "id": 413779, "name": "fb+mozdev@quantumedia.de", "real_name": "Florian Bender"}, {"email": "jyavenard@mozilla.com", "id": 512198, "name": "jyavenard@mozilla.com", "real_name": "Jean-Yves Avenard [:jya]"}, {"email": "mkhoo@mozilla.com", "id": 485272, "name": "mkhoo@mozilla.com", "real_name": "Marvin Khoo [:Marvin_Khoo]"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "fb+mozdev@quantumedia.de"}], "who": "fb+mozdev@quantumedia.de", "when": "2014-08-03T07:57:04Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "jyavenard@mozilla.com"}], "who": "ajones@mozilla.com", "when": "2014-08-06T05:00:55Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "cpearce@mozilla.com"}], "who": "cpearce@mozilla.com", "when": "2014-08-06T08:02:42Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1050064"}], "who": "cpearce@mozilla.com", "when": "2014-08-07T03:26:14Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mkhoo@mozilla.com"}], "who": "mkhoo@mozilla.com", "when": "2014-08-08T03:01:27Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "bwu@mozilla.com"}], "who": "blakewu0205@gmail.com", "when": "2014-08-08T10:02:10Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8470577, "added": "review?(cpearce@mozilla.com)"}], "who": "jyavenard@mozilla.com", "when": "2014-08-11T01:22:13Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8469971, "added": "1"}], "who": "jyavenard@mozilla.com", "when": "2014-08-11T01:22:15Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8470578, "added": "review?(cpearce@mozilla.com)"}], "who": "jyavenard@mozilla.com", "when": "2014-08-11T01:26:16Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8470577, "added": "1"}, {"field_name": "flagtypes.name", "removed": "review?(cpearce@mozilla.com)", "attachment_id": 8470577, "added": ""}], "who": "jyavenard@mozilla.com", "when": "2014-08-11T01:27:33Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(cpearce@mozilla.com)", "attachment_id": 8470578, "added": "review+"}], "who": "cpearce@mozilla.com", "when": "2014-08-11T02:01:57Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8470578, "added": "1"}], "who": "jyavenard@mozilla.com", "when": "2014-08-11T05:27:23Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1022501"}], "who": "jyavenard@mozilla.com", "when": "2014-08-11T05:30:28Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1050064"}, {"removed": "1050064", "field_name": "depends_on", "added": ""}], "who": "jyavenard@mozilla.com", "when": "2014-08-12T01:55:54Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1052383"}], "who": "jyavenard@mozilla.com", "when": "2014-08-12T11:45:47Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8470633, "added": "1"}], "who": "jyavenard@mozilla.com", "when": "2014-08-13T03:03:02Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "checkin-needed"}], "who": "jyavenard@mozilla.com", "when": "2014-08-13T07:04:05Z"}, {"changes": [{"removed": "checkin-needed", "field_name": "keywords", "added": ""}], "who": "ryanvm@gmail.com", "when": "2014-08-13T13:42:02Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla34"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2014-08-13 12:38:06"}], "who": "ryanvm@gmail.com", "when": "2014-08-13T19:38:06Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1055841"}], "who": "giles@thaumas.net", "when": "2014-08-19T23:41:58Z"}], "resolution": "FIXED", "op_sys": "Linux", "cf_fx_points": "---", "cf_blocking_fennec": "---"}