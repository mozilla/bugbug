{"status": "NEW", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "magicp.jp@gmail.com", "mentors_detail": [], "depends_on": [], "cf_has_str": "yes", "cf_user_story": "", "cf_status_firefox_esr45": "affected", "cf_tracking_firefox_relnote": "---", "keywords": ["regression"], "summary": "Console error when a download completes with history disabled: NS_ERROR_ILLEGAL_VALUE when calling setPageAnnotation", "cf_last_resolved": null, "cf_status_firefox50": "affected", "cf_status_firefox51": "affected", "votes": 1, "classification": "Client Software", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "yes", "comment_count": 11, "comments": [{"text": "User Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:51.0) Gecko/20100101 Firefox/51.0\nBuild ID: 20160825030226\n\nSteps to reproduce:\n\n1. Start Nightly\n2. Go to \"https://www.mozilla.org/en-US/firefox/channel/\"\n3. Open Browser Console (Ctrl+Shift+J)\n4. Start downloading \"Firefox Beta\" and save file in local\n5. Check error in Browser Console after downloading\n\n\nActual results:\n\nAfter downloading a file, the following error occurs.\n\n[Exception... \"Component returned failure code: 0x80070057 (NS_ERROR_ILLEGAL_VALUE) [nsIAnnotationService.setPageAnnotation]\"  nsresult: \"0x80070057 (NS_ERROR_ILLEGAL_VALUE)\"  location: \"JS frame :: resource://app/modules/DownloadsCommon.jsm :: onDownloadChanged :: line 801\"  data: no]\t(unknown)\n  onDownloadChangedresource://app/modules/DownloadsCommon.jsm:801:13\n  this.DownloadList.prototype._notifyAllViews\tresource://gre/modules/DownloadList.jsm:213:11\n  DL_change\tresource://gre/modules/DownloadList.jsm:134:5\n  bound DL_change\tself-hosted\n  D_notifyChange\tresource://gre/modules/DownloadCore.jsm:314:9\n  task_D_start\tresource://gre/modules/DownloadCore.jsm:560:11\n  next\tself-hosted\n  TaskImpl_run\tresource://gre/modules/Task.jsm:319:40\n  bound TaskImpl_run\tself-hosted\n  Handler.prototype.process\tresource://gre/modules/Promise.jsm%20-%3E%20resource://gre/modules/Promise-backend.js:937:23\n  this.PromiseWalker.walkerLoop\tresource://gre/modules/Promise.jsm%20-%3E%20resource://gre/modules/Promise-backend.js:816:7\n  bound\tself-hosted\n  bound bound\tself-hosted\n\n\n\n\nExpected results:\n\nFile downloading works without error.", "author": "magicp.jp@gmail.com", "id": 11658125, "time": "2016-08-26T11:37:36Z"}, {"text": "Works for me on Mac OS X. Do you have any add-ons installed? Can you try on a new profile?", "author": "paolo.mozmail@amadzone.org", "id": 11658164, "time": "2016-08-26T12:03:31Z"}, {"text": "(In reply to :Paolo Amadini from comment #1)\n> Works for me on Mac OS X. Do you have any add-ons installed? Can you try on\n> a new profile?\n\nI can reproduce no add-ons and new profile. But I set the following settings. Could you try below?\n\nBefore STR, please set the following settings at \"about:preferences#privacy\"\n  - History Firefox will: \"Use custom settings for history\"\n  - Check-off \"Remember my browsing and download history\"\n  - Check-on \"Clear history when Nightly closes\"", "author": "magicp.jp@gmail.com", "id": 11658241, "time": "2016-08-26T12:53:56Z"}, {"text": "Thanks, I confirm this happens if you disable \"Remember my browsing and download history\".", "author": "paolo.mozmail@amadzone.org", "id": 11658306, "time": "2016-08-26T13:24:09Z"}, {"text": "Regression range:\nhttp://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=56ff556e74d9&tochange=d8be4bc4fba8", "author": "magicp.jp@gmail.com", "id": 11659006, "time": "2016-08-26T16:07:20Z"}, {"text": "Product: Firefox, Component: Downloads Panel ?", "author": "magicp.jp@gmail.com", "id": 11659021, "time": "2016-08-26T16:18:29Z"}, {"text": "There's a lot of overlap, actually Downloads Panel is more correct indeed based on where the code lives.", "author": "paolo.mozmail@amadzone.org", "id": 11659283, "time": "2016-08-26T17:37:26Z"}, {"text": "FWIW, I'm also seeing the same exception in my browser console whenever a WebExtension background script completes a download using the downloads API:\n\n>[Exception... \"Component returned failure code: 0x80070057 (NS_ERROR_ILLEGAL_VALUE) >[nsIAnnotationService.setPageAnnotation]\"  nsresult: \"0x80070057 (NS_ERROR_ILLEGAL_VALUE)\"  location: \"JS frame :: >resource:///modules/DownloadsCommon.jsm :: onDownloadChanged :: line 807\"  data: no]  (unknown)\n>\tonDownloadChanged resource:///modules/DownloadsCommon.jsm:807:13\n>\t_notifyAllViews resource://gre/modules/DownloadList.jsm:208:11\n>\tDL_change resource://gre/modules/DownloadList.jsm:131:5\n>\tbound DL_change self-hosted:959:17\n>\tD_notifyChange resource://gre/modules/DownloadCore.jsm:310:9\n>\ttask_D_start resource://gre/modules/DownloadCore.jsm:553:11\n>\tInterpretGeneratorResume self-hosted:1216:8\n>\tnext self-hosted:1123:9\n>\tTaskImpl_run resource://gre/modules/Task.jsm:319:42\n>\tbound TaskImpl_run self-hosted:961:17\n>\tprocess resource://gre/modules/Promise-backend.js:922:23\n>\twalkerLoop resource://gre/modules/Promise-backend.js:806:7\n>\tbound walkerLoop self-hosted:917:17\n>\tbound bound walkerLoop self-hosted:917:17", "author": "wisniewskit@gmail.com", "id": 12134045, "time": "2017-03-10T15:18:22Z"}, {"text": "My steps to reproduce:\n\n1. Open browser console (with devtools.chrome.enabled=true)\n2. Enter this code:\n   saveURL(\"data:text/plain,hello\", \"index.txt\", null, false, false, null, document, undefined)\n3. Confirm the save\n\nSame regression range as comment 9.\n\nIn bug 1327784 I plan to use this kind of approach to download prettified JSON from the JSON Viewer.\nBut this error is produced.", "author": "oriol-bugzilla@hotmail.com", "id": 12301793, "time": "2017-05-08T20:33:58Z"}, {"text": "In Firefox 57 on Fedora 26, I see the same error:\n\nCode:\n\nlet url = URL.createObjectURL(new Blob([\"coucou\"], {\n    type: 'application/text'\n  })),\n  filename = \"test.txt\";\n\nbrowser.downloads.download({\n  url: url,\n  filename: filename,\n  saveAs: true\n});\n\nResults:\n[Exception... \"Component returned failure code: 0x80070057 (NS_ERROR_ILLEGAL_VALUE) [nsIAnnotationService.setPageAnnotation]\"  nsresult: \"0x80070057 (NS_ERROR_ILLEGAL_VALUE)\"  location: \"JS frame :: resource://gre/modules/DownloadHistory.jsm :: updateMetaData :: line 132\"  data: no]\n\nupdateMetaData resource://gre/modules/DownloadHistory.jsm:132:7\n\tonDownloadChanged resource:///modules/DownloadsCommon.jsm:762:9\n\t_notifyAllViews resource://gre/modules/DownloadList.jsm:191:28\n\tDL_change resource://gre/modules/DownloadList.jsm:107:5\n\tDL_change self-hosted:995:17\n\tD_notifyChange resource://gre/modules/DownloadCore.jsm:271:9\n\tD_start/< resource://gre/modules/DownloadCore.jsm:521:11\n\tInterpretGeneratorResume self-hosted:1283:8\n\tnext self-hosted:1190:9\n\nHowever, the file is well downloaded and visible in the download history.", "author": "rico.masseran@gmail.com", "id": 12883661, "time": "2017-11-29T16:26:13Z"}, {"text": "Able to reproduce this issue with files downloaded through File Sharing websites\n\n1. Have a file uploaded through \"Firefox Send\" or \"mega.nz\" websites.\n2. Copy and try downloading with download file link\n\nError seen in console due to failed setPageAnnotation of blob source URL\n\n[Exception... \"Component returned failure code: 0x80070057 (NS_ERROR_ILLEGAL_VALUE) [nsIAnnotationService.setPageAnnotation]\"  nsresult: \"0x80070057 (NS_ERROR_ILLEGAL_VALUE)\"  location: \"JS frame :: resource://gre/modules/DownloadHistory.jsm :: updateMetaData :: line 130\"  data: no]  (unknown)\n\tupdateMetaData resource://gre/modules/DownloadHistory.jsm:130:7\n\tonDownloadChanged resource:///modules/DownloadsCommon.jsm:755:9\n\t_notifyAllViews resource://gre/modules/DownloadList.jsm:189:28\n\tDL_change resource://gre/modules/DownloadList.jsm:105:5\n\tDL_change self-hosted:1017:17\n\tD_notifyChange resource://gre/modules/DownloadCore.jsm:269:9\n\tD_start/< resource://gre/modules/DownloadCore.jsm:519:11\n\tInterpretGeneratorResume self-hosted:1256:8\n\tnext self-hosted:1211:9\n\n\nOn restart of browser the downloaded file disappears from Download History, Tools -> Downloads", "author": "pdahiya@mozilla.com", "id": 13288255, "time": "2018-05-18T20:15:05Z"}], "id": 1298362, "priority": "P5", "platform": "All", "cf_crash_signature": "", "version": "unspecified", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_platform_rel": "---", "product": "Firefox", "cf_fx_iteration": "---", "blocks": [826991], "qa_contact": "", "creation_time": "2016-08-26T11:37:36Z", "cf_status_firefox_esr52": "---", "component": "Downloads Panel", "assigned_to_detail": {"email": "nobody@mozilla.org", "id": 1, "name": "nobody@mozilla.org", "real_name": "Nobody; OK to take it and work on it"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox49": "affected", "cf_status_firefox48": "affected", "cf_status_firefox62": "---", "cf_status_firefox61": "---", "cf_status_firefox60": "---", "target_milestone": "---", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_fx_points": "---", "url": "", "creator_detail": {"email": "magicp.jp@gmail.com", "id": 542578, "name": "magicp.jp@gmail.com", "real_name": "magicp"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "mcastelluccio@mozilla.com", "id": 420453, "name": "mcastelluccio@mozilla.com", "real_name": "Marco Castelluccio [:marco]"}, {"email": "oriol-bugzilla@hotmail.com", "id": 541576, "name": "oriol-bugzilla@hotmail.com", "real_name": "Oriol Brufau [:Oriol]"}, {"email": "paolo.mozmail@amadzone.org", "id": 332229, "name": "paolo.mozmail@amadzone.org", "real_name": ":Paolo Amadini"}, {"email": "pdahiya@mozilla.com", "id": 471708, "name": "pdahiya@mozilla.com", "real_name": "Punam Dahiya [:pdahiya]"}, {"email": "rico.masseran@gmail.com", "id": 604937, "name": "rico.masseran@gmail.com", "real_name": "Morikko"}, {"email": "wisniewskit@gmail.com", "id": 471096, "name": "wisniewskit@gmail.com", "real_name": "Thomas Wisniewski"}], "attachments": [], "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-05-22T05:50:55Z", "cf_status_firefox_esr60": "---", "assigned_to": "nobody@mozilla.org", "is_open": true, "resolution": "", "op_sys": "All", "cc": ["mcastelluccio@mozilla.com", "oriol-bugzilla@hotmail.com", "paolo.mozmail@amadzone.org", "pdahiya@mozilla.com", "rico.masseran@gmail.com", "wisniewskit@gmail.com"], "history": [{"changes": [{"removed": "Untriaged", "field_name": "component", "added": "Download Manager"}, {"removed": "Unspecified", "field_name": "platform", "added": "All"}, {"removed": "---", "field_name": "cf_has_str", "added": "yes"}, {"removed": "Firefox", "field_name": "product", "added": "Toolkit"}, {"removed": "Unspecified", "field_name": "op_sys", "added": "All"}, {"removed": "---", "field_name": "cf_status_firefox48", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox49", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox50", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox51", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox_esr45", "added": "affected"}], "who": "magicp.jp@gmail.com", "when": "2016-08-26T11:39:23Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "paolo.mozmail@amadzone.org"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(magicp.jp@gmail.com)"}], "who": "paolo.mozmail@amadzone.org", "when": "2016-08-26T12:03:31Z"}, {"changes": [{"removed": "needinfo?(magicp.jp@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "magicp.jp@gmail.com", "when": "2016-08-26T12:53:56Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P5"}, {"removed": "After downloading a file: [Exception... \"Component returned failure code: 0x80070057 (NS_ERROR_ILLEGAL_VALUE) [nsIAnnotationService.setPageAnnotation]\"  nsresult: \"0x80070057 (NS_ERROR_ILLEGAL_VALUE)\"", "field_name": "summary", "added": "Console error when a download completes with history disabled: NS_ERROR_ILLEGAL_VALUE when calling setPageAnnotation"}], "who": "paolo.mozmail@amadzone.org", "when": "2016-08-26T13:24:09Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "826991"}, {"removed": "---", "field_name": "cf_has_regression_range", "added": "yes"}], "who": "magicp.jp@gmail.com", "when": "2016-08-26T16:07:20Z"}, {"changes": [{"removed": "Download Manager", "field_name": "component", "added": "Downloads Panel"}, {"removed": "Toolkit", "field_name": "product", "added": "Firefox"}], "who": "paolo.mozmail@amadzone.org", "when": "2016-08-26T17:37:26Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "wisniewskit@gmail.com"}], "who": "wisniewskit@gmail.com", "when": "2017-03-10T15:18:22Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "oriol-bugzilla@hotmail.com"}], "who": "oriol-bugzilla@hotmail.com", "when": "2017-05-08T20:33:58Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "rico.masseran@gmail.com"}], "who": "rico.masseran@gmail.com", "when": "2017-11-29T16:26:13Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "pdahiya@mozilla.com"}], "who": "pdahiya@mozilla.com", "when": "2018-05-18T20:15:05Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "regression"}, {"removed": "", "field_name": "cc", "added": "mcastelluccio@mozilla.com"}], "who": "mcastelluccio@mozilla.com", "when": "2018-05-22T05:50:55Z"}]}