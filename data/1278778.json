{"status": "RESOLVED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "jsnajdr@gmail.com", "is_obsolete": 1, "is_patch": 1, "flags": [{"status": "-", "name": "feedback", "modification_date": "2016-06-08T15:35:59Z", "type_id": 607, "creation_date": "2016-06-08T11:51:30Z", "id": 1407848, "setter": "bkelly@mozilla.com"}], "content_type": "text/plain", "id": 8761159}, {"creator": "jsnajdr@gmail.com", "is_obsolete": 1, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2016-06-14T08:39:48Z", "type_id": 748, "creation_date": "2016-06-14T07:23:16Z", "id": 1409856, "setter": "bkelly@mozilla.com"}], "content_type": "text/plain", "id": 8762616}, {"creator": "jsnajdr@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2016-06-14T11:10:58Z", "type_id": 748, "creation_date": "2016-06-14T11:10:58Z", "id": 1409917, "setter": "jsnajdr@gmail.com"}], "content_type": "text/plain", "id": 8762652}], "classification": "Client Software", "creator": "jsnajdr@gmail.com", "cc": ["bkelly@mozilla.com", "odvarko@gmail.com"], "depends_on": [1206079], "creation_time": "2016-06-08T08:28:02Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "Show JS stack traces of Fetch requests in Netmonitor", "id": 1278778, "cf_status_firefox50": "fixed", "assigned_to_detail": {"email": "jsnajdr@gmail.com", "id": 538821, "name": "jsnajdr@gmail.com", "real_name": "Jarda Snajdr [:jsnajdr]"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "assigned_to": "jsnajdr@gmail.com", "comment_count": 13, "comments": [{"text": "This is a followup to bug 1134073. Netmonitor doesn't display stack traces of Fetch requests, because the nsIHttpChannel::asyncOpen2 is not called synchronously when there is still a JS stack, but rather scheduled to a next event loop tick at [1].\n\n[1] https://dxr.mozilla.org/mozilla-central/source/dom/fetch/FetchDriver.cpp#86", "author": "jsnajdr@gmail.com", "id": 11471638, "time": "2016-06-08T08:28:02Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=5130d07ad6da", "author": "jsnajdr@gmail.com", "id": 11471655, "time": "2016-06-08T08:37:01Z"}, {"text": "Created attachment 8761159\nShow JS stack traces of Fetch requests in Netmonitor\n\nFixed by merging FetchDriver::ContinueFetch into FetchDriver::Fetch and removing the async call. Also added a devtools mochitest for the JS stacktrace of a fetch request.\n\nJS stacktraces in devtools start working after this, but a lot of other tests is broken - see the try run. Fetch requests from workers, error handling... My approach seems to be too naive.\n\nBen, please, do you have any advice?", "author": "jsnajdr@gmail.com", "id": 11472089, "time": "2016-06-08T11:51:30Z"}, {"text": "Comment on attachment 8761159\nShow JS stack traces of Fetch requests in Netmonitor\n\nReview of attachment 8761159:\n-----------------------------------------------------------------\n\n::: dom/fetch/FetchDriver.cpp\n@@ -82,5 @@\n>  \n>    MOZ_RELEASE_ASSERT(!mRequest->IsSynchronous(),\n>                       \"Synchronous fetch not supported\");\n>  \n> -  return NS_DispatchToCurrentThread(NewRunnableMethod(this, &FetchDriver::ContinueFetch));\n\nSorry, its harder than this.  See this description of the problem:\n\nhttps://bugzilla.mozilla.org/show_bug.cgi?id=1206079#c8", "author": "bkelly@mozilla.com", "id": 11472740, "time": "2016-06-08T15:35:59Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=7c6dd291730a", "author": "jsnajdr@gmail.com", "id": 11481840, "time": "2016-06-13T14:10:50Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=63a78f71565c", "author": "jsnajdr@gmail.com", "id": 11482170, "time": "2016-06-13T20:19:48Z"}, {"text": "Created attachment 8762616\nShow JS stack traces of Fetch requests in Netmonitor\n\nAfter reading the instructions in bug 1206079 and getting familiar with the code, I figured out there should be no problem with calling FetchDriverObserver's callbacks synchronously - all they do, after all, is resolving the promise (either directly or through the worker proxy).\n\nThe only thing that needed fixing is correctly acquiring and releasing the PromiseWorkerProxy lock. To prevent deadlock, it needs to be already released when calling into FetchDriver::Fetch, because this method can call synchronously into WorkerFetchResolver, which wants to acquire the mutex, too.", "author": "jsnajdr@gmail.com", "id": 11482434, "time": "2016-06-14T07:23:16Z"}, {"text": "Comment on attachment 8762616\nShow JS stack traces of Fetch requests in Netmonitor\n\nReview of attachment 8762616:\n-----------------------------------------------------------------\n\nLooks reasonable.  r=me with comment addressed and assuming all tests continue to pass.\n\n::: dom/fetch/Fetch.cpp\n@@ +143,4 @@\n>      }\n> +\n> +    // ...but release it before calling Fetch, because mResolver's callback can\n> +    // be called synchronously and they want the mutex, too.\n\nPlease document that the FetchDriverObserver call backs can be called synchronously or asynchronously in FetchDriver.h.", "author": "bkelly@mozilla.com", "id": 11482493, "time": "2016-06-14T08:39:48Z"}, {"text": "Created attachment 8762652\nShow JS stack traces of Fetch requests in Netmonitor", "author": "jsnajdr@gmail.com", "id": 11482716, "time": "2016-06-14T11:08:19Z"}, {"text": "Comment on attachment 8762652\nShow JS stack traces of Fetch requests in Netmonitor\n\nAdded a comment about FetchDriverObserver callback sync/async\n\nI ran two try builds with all tests and they seem to be OK. Lots of intermittents, but nothing that looks related to this. I also checked other recent test results on try and they tend to display the same kind of failures - trouble with clipboard etc.", "author": "jsnajdr@gmail.com", "id": 11482719, "time": "2016-06-14T11:10:58Z"}, {"text": "Pushed by cbook@mozilla.com:\nhttps://hg.mozilla.org/integration/fx-team/rev/ae9a292741ef\nShow JS stack traces of Fetch requests in Netmonitor r=bkelly", "author": "pulsebot@bots.tld", "id": 11483834, "time": "2016-06-15T00:06:05Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/ae9a292741ef", "author": "cbook@mozilla.com", "id": 11483952, "time": "2016-06-15T05:28:12Z"}, {"text": "*** Bug 1206079 has been marked as a duplicate of this bug. ***", "author": "jsnajdr@gmail.com", "id": 11485641, "time": "2016-06-16T06:20:01Z"}], "cf_last_resolved": "2016-06-15T05:28:12Z", "priority": "P2", "mentors_detail": [], "cf_crash_signature": "", "version": "Trunk", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2016-06-16T06:20:01Z", "cf_platform_rel": "---", "product": "Firefox", "cf_status_firefox_esr52": "---", "blocks": [1134073], "qa_contact": "", "see_also": ["https://bugzilla.mozilla.org/show_bug.cgi?id=1269765"], "cf_fx_iteration": "---", "component": "Developer Tools: Netmonitor", "votes": 0, "groups": [], "cf_status_firefox60": "---", "target_milestone": "Firefox 50", "is_cc_accessible": true, "url": "", "creator_detail": {"email": "jsnajdr@gmail.com", "id": 538821, "name": "jsnajdr@gmail.com", "real_name": "Jarda Snajdr [:jsnajdr]"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "bkelly@mozilla.com", "id": 465500, "name": "bkelly@mozilla.com", "real_name": "Ben Kelly [PTO, back late March][:bkelly]"}, {"email": "odvarko@gmail.com", "id": 303767, "name": "odvarko@gmail.com", "real_name": "Jan Honza Odvarko [:Honza]"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "history": [{"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1269765"}], "who": "jsnajdr@gmail.com", "when": "2016-06-08T08:29:10Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1134073"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "jsnajdr@gmail.com"}], "who": "jsnajdr@gmail.com", "when": "2016-06-08T08:30:26Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8761159, "added": "feedback?(bkelly@mozilla.com)"}, {"removed": "", "field_name": "cc", "added": "bkelly@mozilla.com"}], "who": "jsnajdr@gmail.com", "when": "2016-06-08T11:51:30Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "feedback?(bkelly@mozilla.com)", "attachment_id": 8761159, "added": "feedback-"}], "who": "bkelly@mozilla.com", "when": "2016-06-08T15:35:59Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1206079"}], "who": "jsnajdr@gmail.com", "when": "2016-06-08T15:40:56Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P2"}, {"removed": "", "field_name": "cc", "added": "odvarko@gmail.com"}], "who": "odvarko@gmail.com", "when": "2016-06-09T07:19:16Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8762616, "added": "review?(bkelly@mozilla.com)"}], "who": "jsnajdr@gmail.com", "when": "2016-06-14T07:23:16Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8761159, "added": "1"}], "who": "jsnajdr@gmail.com", "when": "2016-06-14T07:23:18Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bkelly@mozilla.com)", "attachment_id": 8762616, "added": "review+"}], "who": "bkelly@mozilla.com", "when": "2016-06-14T08:39:48Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8762616, "added": "1"}], "who": "jsnajdr@gmail.com", "when": "2016-06-14T11:08:21Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8762652, "added": "review+"}], "who": "jsnajdr@gmail.com", "when": "2016-06-14T11:10:58Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "checkin-needed"}], "who": "jsnajdr@gmail.com", "when": "2016-06-14T11:13:29Z"}, {"changes": [{"removed": "checkin-needed", "field_name": "keywords", "added": ""}], "who": "pulsebot@bots.tld", "when": "2016-06-15T00:06:05Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "Firefox 50"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2016-06-15 05:28:12"}, {"removed": "affected", "field_name": "cf_status_firefox50", "added": "fixed"}], "who": "cbook@mozilla.com", "when": "2016-06-15T05:28:12Z"}]}