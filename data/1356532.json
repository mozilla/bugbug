{"status": "ASSIGNED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "mak77@bonardo.net", "mentors_detail": [], "depends_on": [1383367, 1434376], "cf_status_firefox_esr60": "---", "cf_user_story": "", "cf_status_firefox56": "wontfix", "cf_tracking_firefox_relnote": "---", "cf_status_firefox58": "affected", "keywords": [], "cf_status_firefox57": "wontfix", "cf_status_firefox55": "wontfix", "cf_last_resolved": null, "attachments": [{"creator": "kmaglione+bmo@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2017-08-30T15:38:54Z", "type_id": 748, "creation_date": "2017-08-26T22:20:13Z", "id": 1636333, "setter": "florian@queze.net"}], "content_type": "text/x-review-board-request", "id": 8889103}, {"creator": "kmaglione+bmo@mozilla.com", "is_obsolete": 1, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2017-07-24T15:21:19Z", "type_id": 748, "creation_date": "2017-07-22T23:08:18Z", "id": 1616212, "setter": "florian@queze.net"}], "content_type": "text/x-review-board-request", "id": 8889104}, {"creator": "kmaglione+bmo@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "-", "name": "review", "modification_date": "2017-08-31T11:19:35Z", "type_id": 748, "creation_date": "2017-07-22T23:08:18Z", "id": 1616213, "setter": "florian@queze.net"}], "content_type": "text/x-review-board-request", "id": 8889105}, {"creator": "kmaglione+bmo@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2017-07-24T15:50:56Z", "type_id": 748, "creation_date": "2017-07-22T23:08:18Z", "id": 1616214, "setter": "florian@queze.net"}], "content_type": "text/x-review-board-request", "id": 8889106}, {"creator": "kmaglione+bmo@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2017-08-30T15:39:49Z", "type_id": 748, "creation_date": "2017-08-26T22:20:13Z", "id": 1636331, "setter": "florian@queze.net"}], "content_type": "text/x-review-board-request", "id": 8901501}, {"creator": "kmaglione+bmo@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2017-08-30T15:41:04Z", "type_id": 748, "creation_date": "2017-08-26T22:20:13Z", "id": 1636332, "setter": "florian@queze.net"}], "content_type": "text/x-review-board-request", "id": 8901502}, {"creator": "florian@queze.net", "is_obsolete": 1, "is_patch": 0, "flags": [], "content_type": "image/png", "id": 8902730}, {"creator": "florian@queze.net", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "video/quicktime", "id": 8903114}], "cf_status_firefox61": "---", "votes": 2, "classification": "Client Software", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "qa_contact_detail": {"email": "adrian.florinescu@softvision.ro", "id": 556562, "name": "adrian.florinescu@softvision.ro", "real_name": "Adrian Florinescu [:adrian_sv]"}, "comment_count": 70, "comments": [{"text": "We should try using getBoundsWithoutFlushing() and see if it break things.", "author": "mak77@bonardo.net", "id": 12235549, "time": "2017-04-14T09:29:21Z"}, {"text": "*** Bug 1356764 has been marked as a duplicate of this bug. ***", "author": "florian@queze.net", "id": 12237931, "time": "2017-04-15T17:06:46Z"}, {"text": "(In reply to Marco Bonardo [::mak] from comment #0)\n> We should try using getBoundsWithoutFlushing() and see if it break things.\n\nThe answer is yes, it breaks things.\nReducing the window size to make it easier to have overflow, and search in the urlbar.\nThe right side of the text should get ellipsis and not touch the border of the panel, it doesn't without a flush.", "author": "mak77@bonardo.net", "id": 12254841, "time": "2017-04-21T15:13:22Z"}, {"text": "Is it helpful to post these stacks? If so, here is one that just popped up during testing:\n\n_handleOverflow@chrome://global/content/bindings/autocomplete.xml:2391:26\nhandleOverUnderflow@chrome://global/content/bindings/autocomplete.xml:2463:11\n_reuseAcItem@chrome://global/content/bindings/autocomplete.xml:2099:15\n_appendCurrentResult@chrome://global/content/bindings/autocomplete.xml:1365:28\n_invalidate@chrome://global/content/bindings/autocomplete.xml:1193:11\ninvalidate@chrome://global/content/bindings/autocomplete.xml:1162:11\nnotifyResults@resource://gre/components/UnifiedComplete.js:2114:5\nfinishSearch@resource://gre/components/UnifiedComplete.js:2287:5\nstartSearch/<@resource://gre/components/UnifiedComplete.js:2244:33\nprocess@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:922:23\nwalkerLoop@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:806:7\nPromise*scheduleWalkerLoop@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:739:11\nschedulePromise@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:770:7\ncompletePromise@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:707:7\nTaskImpl_run@resource://gre/modules/Task.jsm:324:15\npromise callback*TaskImpl_handleResultValue@resource://gre/modules/Task.jsm:396:7\nTaskImpl_run@resource://gre/modules/Task.jsm:327:15\nprocess@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:922:23\nwalkerLoop@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:806:7\nPromise*scheduleWalkerLoop@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:739:11\nschedulePromise@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:770:7\ncompletePromise@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:707:7\nTaskImpl_run@resource://gre/modules/Task.jsm:324:15\npromise callback*TaskImpl_handleResultValue@resource://gre/modules/Task.jsm:396:7\nTaskImpl_run@resource://gre/modules/Task.jsm:327:15\npromise callback*TaskImpl_handleResultValue@resource://gre/modules/Task.jsm:396:7\nTaskImpl_run@resource://gre/modules/Task.jsm:327:15\npromise callback*TaskImpl_handleResultValue@resource://gre/modules/Task.jsm:396:7\nTaskImpl_run@resource://gre/modules/Task.jsm:327:15\npromise callback*TaskImpl_handleResultValue@resource://gre/modules/Task.jsm:396:7\nTaskImpl_run@resource://gre/modules/Task.jsm:327:15\nprocess@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:922:23\nwalkerLoop@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:806:7\nPromise*scheduleWalkerLoop@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:739:11\nschedulePromise@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:770:7\nPromise.prototype.then@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:455:5\nTaskImpl_handleResultValue@resource://gre/modules/Task.jsm:396:7\nTaskImpl_run@resource://gre/modules/Task.jsm:327:15\npromise callback*TaskImpl_handleResultValue@resource://gre/modules/Task.jsm:396:7\nTaskImpl_run@resource://gre/modules/Task.jsm:327:15\nprocess@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:922:23\nwalkerLoop@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:806:7\nPromise*scheduleWalkerLoop@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:739:11\nschedulePromise@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:770:7\nPromise.prototype.then@resource://gre/modules/Promise.jsm -> resource://gre/modules/Promise-backend.js:455:5\nstartSearch@resource://gre/components/UnifiedComplete.js:2237:5\nonInput@chrome://browser/content/urlbarBindings.xml:1125:17\nonxblinput@chrome://global/content/bindings/autocomplete.xml:649:9", "author": "geeknik@protonmail.ch", "id": 12309016, "time": "2017-05-10T20:19:31Z"}, {"text": "Unsurprisingly, this is very visible in profiles of interacting with the awesomebar: https://perfht.ml/2t6DoAs", "author": "florian@queze.net", "id": 12460863, "time": "2017-07-10T18:38:08Z"}, {"text": "All of autocomplete.xml is a reflow nightmare... particularly when adjustHeight is called, and we go back and force between changing the DOM and querying layout multiple times, for every item...", "author": "kmaglione+bmo@mozilla.com", "id": 12496032, "time": "2017-07-22T05:52:07Z"}, {"text": "The thing we should try to preserve is animations and delayed shrinking, we really don't want to go back to the previous status where the panel was resizing up and down like crazy at every keypress. We should also avoid locking up into a world where we assume all the richlistitems are the same height, cause even if it's true now, it won't be for long.\nIt's true that some parts are a reflow nightmare, but it gives quite more perception of speed than the previous state.\nWe should try to use RAF and simplify the logic a bit and check where we are then.", "author": "mak77@bonardo.net", "id": 12496135, "time": "2017-07-22T08:30:04Z"}, {"text": "(In reply to Marco Bonardo [::mak] from comment #6)\n\n> It's true that some parts are a reflow nightmare, but it gives quite more\n> perception of speed than the previous state.\n\nWith flickering and long pauses (I saw 500+ms pauses while typing in the urlbar on my fast macbook, due to _handleOverflow reflows), it's difficult to agree on the second half of your sentence.\n\n> We should try to use RAF and simplify the logic a bit and check where we are\n> then.\n\nEventually we should get rid of all these sync reflows in primary UI. If this isn't achievable in the 57 time frame, we should at the very least ensure that things in the various items are done at the same time, to avoid the current situation where we reflow several times per item and repeat for each item.\n\nThe test added in bug 1356271 should be very helpful to track our progress.", "author": "florian@queze.net", "id": 12496303, "time": "2017-07-22T13:10:24Z"}, {"text": "Created attachment 8889103\nBug 1356532: Part 1 - Add BrowserUtils.promiseAnimationFrame helper.\n\nIt's important that requestAnimationFrame callbacks run synchronously, and\ncarefully control what code runs during them. At the same time, we often need\nto UI code that runs before and after the DOM mutations in an animation frame\ncallback.\n\nThis helper makes it possible to run DOM mutation code during an animation\nframe in the course of an async function, and then resume execution after the\nanimation frame callback has been executed, and without danger of blocking the\nframe from being painted.\n\n\nIt's also important to note that, at the moment, the promise microtask queue\nis not flushed at the end of the animation frame callback, which means we can\nsafely rely on promise resolution handlers automatically executing after frame\nhas been painted. After bug 1193394 is fixed, that will no longer be the case,\nand we'll need to resolve the promise from a task dispatched to the event\nloop.\n\nReview commit: https://reviewboard.mozilla.org/r/160128/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/160128/", "author": "kmaglione+bmo@mozilla.com", "id": 12496670, "time": "2017-07-22T23:08:18Z"}, {"text": "Created attachment 8889104\nBug 1356532: Part 2 - Avoid layout flushes during adjustSiteIconStart().\n\nReview commit: https://reviewboard.mozilla.org/r/160130/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/160130/", "author": "kmaglione+bmo@mozilla.com", "id": 12496671, "time": "2017-07-22T23:08:18Z"}, {"text": "Created attachment 8889105\nBug 1356532: Part 4 - Avoid layout flushes during adjustSiteIconStart() and _handleOverflow().\n\nReview commit: https://reviewboard.mozilla.org/r/160132/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/160132/", "author": "kmaglione+bmo@mozilla.com", "id": 12496672, "time": "2017-07-22T23:08:18Z"}, {"text": "Created attachment 8889106\nBug 1356532: Part 5 - Avoid layout flushes during adjustHeight().\n\nReview commit: https://reviewboard.mozilla.org/r/160134/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/160134/", "author": "kmaglione+bmo@mozilla.com", "id": 12496673, "time": "2017-07-22T23:08:18Z"}, {"text": "These patches seem to give smooth UI behavior without any uninterruptible overflows.", "author": "kmaglione+bmo@mozilla.com", "id": 12496674, "time": "2017-07-22T23:08:55Z"}, {"text": "*reflows (during overflow :) )", "author": "kmaglione+bmo@mozilla.com", "id": 12496677, "time": "2017-07-22T23:09:55Z"}, {"text": "Comment on attachment 8889104\nBug 1356532: Part 2 - Avoid layout flushes during adjustSiteIconStart().\n\nhttps://reviewboard.mozilla.org/r/160130/#review165486\n\n::: toolkit/content/widgets/autocomplete.xml:2391\n(Diff revision 1)\n>            let rect = utils.getBoundsWithoutFlushing(this._siteIcon);\n>  \n>            let dir = this.getAttribute(\"dir\");\n>            let delta = dir == \"rtl\" ? rect.right - newStart\n>                                     : newStart - rect.left;\n> +          (async () => {\n\nIsn't there a () missing at the end of this async function to call it?", "author": "florian@queze.net", "id": 12496686, "time": "2017-07-22T23:41:48Z"}, {"text": "Comment on attachment 8889104\nBug 1356532: Part 2 - Avoid layout flushes during adjustSiteIconStart().\n\nhttps://reviewboard.mozilla.org/r/160130/#review165486\n\n> Isn't there a () missing at the end of this async function to call it?\n\nHm. Yes, I fixed that locally after I tested, but somehow it didn't make it into the commit.", "author": "kmaglione+bmo@mozilla.com", "id": 12496689, "time": "2017-07-22T23:48:52Z"}, {"text": "Comment on attachment 8889103\nBug 1356532: Part 1 - Add BrowserUtils.promiseAnimationFrame helper.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/160128/diff/1-2/", "author": "kmaglione+bmo@mozilla.com", "id": 12496697, "time": "2017-07-23T00:25:56Z"}, {"text": "Comment on attachment 8889104\nBug 1356532: Part 2 - Avoid layout flushes during adjustSiteIconStart().\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/160130/diff/1-2/", "author": "kmaglione+bmo@mozilla.com", "id": 12496698, "time": "2017-07-23T00:25:56Z"}, {"text": "Comment on attachment 8889105\nBug 1356532: Part 4 - Avoid layout flushes during adjustSiteIconStart() and _handleOverflow().\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/160132/diff/1-2/", "author": "kmaglione+bmo@mozilla.com", "id": 12496699, "time": "2017-07-23T00:25:56Z"}, {"text": "Comment on attachment 8889106\nBug 1356532: Part 5 - Avoid layout flushes during adjustHeight().\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/160134/diff/1-2/", "author": "kmaglione+bmo@mozilla.com", "id": 12496700, "time": "2017-07-23T00:25:56Z"}, {"text": "Comment on attachment 8889103\nBug 1356532: Part 1 - Add BrowserUtils.promiseAnimationFrame helper.\n\nhttps://reviewboard.mozilla.org/r/160128/#review165636\n\n::: toolkit/modules/PromiseUtils.jsm:144\n(Diff revision 2)\n> +   *\n> +   * @param {Window} win\n> +   * @param {function} callback\n> +   * @returns {Promise}\n> +   */\n> +  animationFrame(win, callback) {\n\nDoesn't look like this has anything to do with Promises, and and such this looks like the wrong place to put this helper.\nI'd suggest BrowserUtils instead.", "author": "mak77@bonardo.net", "id": 12499606, "time": "2017-07-24T08:55:39Z"}, {"text": "Comment on attachment 8889103\nBug 1356532: Part 1 - Add BrowserUtils.promiseAnimationFrame helper.\n\nhttps://reviewboard.mozilla.org/r/160128/#review165676\n\nRemoving the review flag on this part for now. I'm not convinced we really need this helper, and if we do, it's probably not in the right file.\n\n::: commit-message-ff979:5\n(Diff revision 2)\n> +Bug 1356532: Part 1 - Add PromiseUtils.animationFrame helper. r?florian\n> +\n> +It's important that requestAnimationFrame callbacks run synchronously, and\n> +carefully control what code runs during them. At the same time, we often need\n> +to UI code that runs before and after the DOM mutations in an animation frame\n\nLooks like there's a missing word after 'to'.\n\n::: commit-message-ff979:17\n(Diff revision 2)\n> +\n> +\n> +It's also important to note that, at the moment, the promise microtask queue\n> +is not flushed at the end of the animation frame callback, which means we can\n> +safely rely on promise resolution handlers automatically executing after frame\n> +has been painted. After bug 1193394 is fixed, that will no longer be the case,\n\nShould we leave a note about this either in bug 1193394 or in a code comment here?", "author": "florian@queze.net", "id": 12500649, "time": "2017-07-24T15:12:56Z"}, {"text": "Comment on attachment 8889104\nBug 1356532: Part 2 - Avoid layout flushes during adjustSiteIconStart().\n\nhttps://reviewboard.mozilla.org/r/160130/#review165756\n\nLooks good to me, thanks!\n\nWhile testing the whole patchset, I noticed that whenever we open the awesomebar in a window for the first time, the icon positions are off for a split second. I see it very consistently now, probably because I'm paying more attention due to reviewing these patches. After unapplying the patches I can still reproduce, so it's not a new issue. I wonder if these patches could have made the time while the icon positions are off longer, eg. 2 frames instead of 1... or if it's just a side effect of me paying closer attention.\n\nIt looks like there's related code that still does sync reflows at http://searchfox.org/mozilla-central/rev/3a3af33f513071ea829debdfbc628caebcdf6996/browser/base/content/urlbarBindings.xml#1852 so it may be a good idea to fix these too before further investigating.\n\nThis should probably be a follow-up anyway, and you don't have to take it unless you want to :-).", "author": "florian@queze.net", "id": 12500665, "time": "2017-07-24T15:21:19Z"}, {"text": "Comment on attachment 8889105\nBug 1356532: Part 4 - Avoid layout flushes during adjustSiteIconStart() and _handleOverflow().\n\nhttps://reviewboard.mozilla.org/r/160132/#review165672\n\n::: toolkit/content/widgets/autocomplete.xml:2365\n(Diff revision 2)\n>        <!-- Sets the x-coordinate of the leading edge of the site icon (favicon)\n>             relative the the leading edge of the window.\n>             @param newStart The new x-coordinate, relative to the leading edge of\n>                    the window.  Pass undefined to reset the icon's position to\n>                    whatever is specified in CSS.\n>             @return True if the icon's position changed, false if not. -->\n\nPlease remove this last line of the comment.\n\n::: toolkit/content/widgets/autocomplete.xml:2381\n(Diff revision 2)\n>            }\n>  \n> -          let utils = window.QueryInterface(Ci.nsIInterfaceRequestor)\n> -                            .getInterface(Ci.nsIDOMWindowUtils);\n> -          let rect = utils.getBoundsWithoutFlushing(this._siteIcon);\n> +          (async () => {\n> +            let delta;\n> +            let px = this._typeIcon.style.marginInlineStart;\n> +            await PromiseUtils.layoutFlushed(document, \"layout\", () => {\n\nWhy is it better to wait for a layout flush in all cases instead of relying on getBoundsWithoutFlushing? Isn't there a risk of this causing one frame to appear with the icons in the wrong place?\n\n::: toolkit/content/widgets/autocomplete.xml:2415\n(Diff revision 2)\n>          <body><![CDATA[\n> -          let itemRect = this.parentNode.getBoundingClientRect();\n> -          let titleRect = this._titleText.getBoundingClientRect();\n> -          let tagsRect = this._tagsText.getBoundingClientRect();\n> -          let separatorRect = this._separator.getBoundingClientRect();\n> -          let urlRect = this._urlText.getBoundingClientRect();\n> +          if (this._overflowPromise) {\n> +            return;\n> +          }\n> +\n> +          this._overflowPromise = (async () => {\n\nIt looks like this._overflowPromise is used as a boolean and nothing is waiting for the result of this promise (or handling rejections).\n\nShould this just be:\n\nthis._handleOverflowPending = true;\n(async () => { ... })();\n\n?\n\n::: toolkit/content/widgets/autocomplete.xml:2460\n(Diff revision 2)\n> -            let titleTagsMaxWidth = Math.max(\n> +              let titleTagsMaxWidth = Math.max(\n> -              titleTagsAvailable,\n> +                titleTagsAvailable,\n> -              itemWidth * titleTagsPct\n> +                itemWidth * titleTagsPct\n> -            );\n> +              );\n> +\n> +              await PromiseUtils.animationFrame(window, () => {\n\nUnless something is actually using the promise, I don't see the need for PromiseUtils.animationFrame here. Would we lose something if we simplified to:\nrequestAnimationFrame(() => {\n?", "author": "florian@queze.net", "id": 12500675, "time": "2017-07-24T15:23:29Z"}, {"text": "Comment on attachment 8889106\nBug 1356532: Part 5 - Avoid layout flushes during adjustHeight().\n\nhttps://reviewboard.mozilla.org/r/160134/#review165766\n\nLooks good to me but I'm not very familiar with this awesomebar panel height code. I think ::mak would be a better reviewer for this part, but he currently seems a bit overloaded, so I'm going to r+ and needinfo him so that he can check if he would like to review this too.", "author": "florian@queze.net", "id": 12500778, "time": "2017-07-24T15:50:56Z"}, {"text": "(In reply to Florian Qu\u00e8ze [:florian] [:flo] from comment #24)\n> Comment on attachment 8889106\n> Bug 1356532: Part 4 - Avoid layout flushes during adjustHeight().\n> \n> https://reviewboard.mozilla.org/r/160134/#review165766\n> \n> Looks good to me but I'm not very familiar with this awesomebar panel height\n> code. I think ::mak would be a better reviewer for this part, but he\n> currently seems a bit overloaded, so I'm going to r+ and needinfo him so\n> that he can check if he would like to review this too.", "author": "florian@queze.net", "id": 12500783, "time": "2017-07-24T15:52:01Z"}, {"text": "Comment on attachment 8889103\nBug 1356532: Part 1 - Add BrowserUtils.promiseAnimationFrame helper.\n\nhttps://reviewboard.mozilla.org/r/160128/#review165636\n\n> Doesn't look like this has anything to do with Promises, and and such this looks like the wrong place to put this helper.\n> I'd suggest BrowserUtils instead.\n\nI've been thinking about adding other helpers to PromiseUtils, for things like observers and DOM events, that this seemed to fit well with.\n\nI'm not really opposed to using BrowserUtils, but PromiseUtils seems like a better place to group those kinds of helpers.", "author": "kmaglione+bmo@mozilla.com", "id": 12501853, "time": "2017-07-24T21:02:43Z"}, {"text": "I disagree, if everyone starts adding anything to PromiseUtils just because it returns a promise, it'll soon be unmanageable.\nPromiseUtils exists to keep utils that are strictly related to Promises (and also PromiseUtils.defer is sort-of moving towards deprecation so the whole module may go away).", "author": "mak77@bonardo.net", "id": 12501866, "time": "2017-07-24T21:08:04Z"}, {"text": "(In reply to Kris Maglione [:kmag] from comment #26)\n\n> I'm not really opposed to using BrowserUtils, but PromiseUtils seems like a\n> better place to group those kinds of helpers.\n\nThe way I see it, PromiseUtils is more for things related to promises that work in any JS context, and BrowserUtils is more for stuff that is meant to be used in a (browser) window context.", "author": "florian@queze.net", "id": 12501877, "time": "2017-07-24T21:11:12Z"}, {"text": "Also, looks like some other changeset in your queue is adding a layoutFlushed to PromiseUtils, that should also be moved elsewhere.", "author": "mak77@bonardo.net", "id": 12503704, "time": "2017-07-25T11:20:57Z"}, {"text": "(In reply to Marco Bonardo [::mak] from comment #29)\n> Also, looks like some other changeset in your queue is adding a\n> layoutFlushed to PromiseUtils, that should also be moved elsewhere.\n\nI already mentioned that in bug 1383367 comment 6.", "author": "florian@queze.net", "id": 12503778, "time": "2017-07-25T12:02:56Z"}, {"text": "(In reply to Florian Qu\u00e8ze [:florian] [:flo] (away until August 7th) from comment #22)\n> While testing the whole patchset, I noticed that whenever we open the\n> awesomebar in a window for the first time, the icon positions are off for a\n> split second. I see it very consistently now, probably because I'm paying\n> more attention due to reviewing these patches. After unapplying the patches\n> I can still reproduce, so it's not a new issue. I wonder if these patches\n> could have made the time while the icon positions are off longer, eg. 2\n> frames instead of 1...\n\nConsidering bug 1385729, that seems likely.", "author": "dao+bmo@mozilla.com", "id": 12525098, "time": "2017-08-01T09:54:25Z"}, {"text": "Hey kmag, anything left to do here, or are these ready to land?", "author": "mconley@mozilla.com", "id": 12546536, "time": "2017-08-08T14:08:17Z"}, {"text": "I didn't realize there was already a patch for this, but I think the alternative solution for Part 2 in bug 1358792 should be less prone to flickering. The later patches in this bug are still needed to fix everything.", "author": "paolo.mozmail@amadzone.org", "id": 12584357, "time": "2017-08-21T12:23:12Z"}, {"text": "Created attachment 8901501\nBug 1356532: Part 2 - Add helper for performing Promise microtask checkpoint from JS.\n\nReview commit: https://reviewboard.mozilla.org/r/172954/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/172954/", "author": "kmaglione+bmo@mozilla.com", "id": 12602287, "time": "2017-08-26T22:20:13Z"}, {"text": "Created attachment 8901502\nBug 1356532: Part 3 - Add layout query helper that forces a single reflow before paint.\n\nThis is mostly a stopgap until code that relies on synchronous layout flushes\ncan be rewriteen to rely on the layout engine instead. But it allows existing\ncode to be reworked so that only one synchronous layout flush is required per\nframe, and tries to perform them during idle slices when possible.\n\nReview commit: https://reviewboard.mozilla.org/r/172956/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/172956/", "author": "kmaglione+bmo@mozilla.com", "id": 12602288, "time": "2017-08-26T22:20:13Z"}, {"text": "Comment on attachment 8889103\nBug 1356532: Part 1 - Add BrowserUtils.promiseAnimationFrame helper.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/160128/diff/2-3/", "author": "kmaglione+bmo@mozilla.com", "id": 12602289, "time": "2017-08-26T22:20:13Z"}, {"text": "Comment on attachment 8889105\nBug 1356532: Part 4 - Avoid layout flushes during adjustSiteIconStart() and _handleOverflow().\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/160132/diff/2-3/", "author": "kmaglione+bmo@mozilla.com", "id": 12602290, "time": "2017-08-26T22:20:13Z"}, {"text": "Comment on attachment 8889106\nBug 1356532: Part 5 - Avoid layout flushes during adjustHeight().\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/160134/diff/2-3/", "author": "kmaglione+bmo@mozilla.com", "id": 12602291, "time": "2017-08-26T22:20:13Z"}, {"text": "Comment on attachment 8889105\nBug 1356532: Part 4 - Avoid layout flushes during adjustSiteIconStart() and _handleOverflow().\n\nThis could use another review. I rolled the handling of adjustSiteIconStart into _handleOverflow to avoid flakiness or the need to force additional reflows.", "author": "kmaglione+bmo@mozilla.com", "id": 12602293, "time": "2017-08-26T22:22:01Z"}, {"text": "didn't paolo already take care of adjustSiteIconStart in bug 1358792? what is this doing?", "author": "mak77@bonardo.net", "id": 12605422, "time": "2017-08-28T09:21:14Z"}, {"text": "(In reply to Marco Bonardo [::mak] from comment #40)\n> didn't paolo already take care of adjustSiteIconStart in bug 1358792? what\n> is this doing?\n\nSort of. That solution only worked because of the obscene number of forced reflows in the existing code. When I fixed those, the layout wound up blowing up after the patches in bug 1358792, because getBoundsWithoutFlushing returned a null rect, and adjustSiteIconStart computed the new width as a delta from the existing width, and adjustSiteIconStart wound up being called multiple times between flushes.", "author": "kmaglione+bmo@mozilla.com", "id": 12606249, "time": "2017-08-28T15:02:32Z"}, {"text": "Something interesting happened, the patch in bug 1388331 seems somehow to completely remove the most common _handleOverflow reflow :/\nI'm still not sure what's up, but could be interesting to do a check if that's true or the test is somehow bogus.", "author": "mak77@bonardo.net", "id": 12611119, "time": "2017-08-29T20:41:57Z"}, {"text": "Looks like it was just a reduction in the number. \"Unused expected reflow\" is a quite confusing failure message, unused looked like the reflow went away completely.", "author": "mak77@bonardo.net", "id": 12611166, "time": "2017-08-29T20:54:31Z"}, {"text": "Comment on attachment 8889103\nBug 1356532: Part 1 - Add BrowserUtils.promiseAnimationFrame helper.\n\nhttps://reviewboard.mozilla.org/r/160128/#review179510\n\n::: commit-message-ff979:5\n(Diff revision 3)\n> +Bug 1356532: Part 1 - Add BrowserUtils.promiseAnimationFrame helper. r?florian\n> +\n> +It's important that requestAnimationFrame callbacks run synchronously, and\n> +carefully control what code runs during them. At the same time, we often need\n> +to UI code that runs before and after the DOM mutations in an animation frame\n\nStill looks like there's a missing word after 'to'.", "author": "florian@queze.net", "id": 12613527, "time": "2017-08-30T15:38:54Z"}, {"text": "Comment on attachment 8901501\nBug 1356532: Part 2 - Add helper for performing Promise microtask checkpoint from JS.\n\nhttps://reviewboard.mozilla.org/r/172954/#review179512\n\nLooks good to me, but I'm not a reviewer for dom/\n\n::: dom/base/nsDOMWindowUtils.cpp:1888\n(Diff revision 1)\n>  }\n>  \n>  NS_IMETHODIMP\n> +nsDOMWindowUtils::PerformMicroTaskCheckpoint()\n> +{\n> +  Promise::PerformMicroTaskCheckpoint();\n\nPromise::PerformMicroTaskCheckpoint() returns a boolean, should we make performMicroTaskCheckpoint return this value, even if we don't need it for the current use case?", "author": "florian@queze.net", "id": 12613531, "time": "2017-08-30T15:39:49Z"}, {"text": "Comment on attachment 8901502\nBug 1356532: Part 3 - Add layout query helper that forces a single reflow before paint.\n\nhttps://reviewboard.mozilla.org/r/172956/#review179516\n\nThanks for the updated patch. It's unfortunate we have to force this reflow, but a huge improvement over the current situation :-)\n\n::: toolkit/modules/BrowserUtils.jsm:39\n(Diff revision 1)\n> +  this._idleRequest = null;\n> +  this._reflowRequested = false;\n>  }\n>  \n> -ReflowObserver.prototype = {\n> +ReflowScheduler.get = function(doc) {\n> +  let observer = reflowSchedulers.get(doc);\n\nIs the 'observer' variable name here a leftover from a previous version of the patch?\n\n::: toolkit/modules/BrowserUtils.jsm:141\n(Diff revision 1)\n> +  addSlowReflowCallback(callback) {\n> +    this.addReflowCallback(callback);\n> +\n> +    // Add both idle and animation frame callbacks. If the idle callback\n> +    // fires first, we force a reflow immediately, and do nothing\n> +    // special during the animation frame callback. If the callback is\n\n\"do nothing special during the animation frame callback\" seems to actually be \"cancel the animation frame callback\" in the implementation.\n\n::: toolkit/modules/BrowserUtils.jsm:837\n(Diff revision 1)\n> +   * pending promise handlers will likewise run before the paint. When\n> +   * combined with `promiseAnimationFrame, this allows multiple\n> +   * operations that depend on querying the layout state before paint to\n> +   * be grouped so that only a single extra layout flush is required.\n> +   *\n> +   * Please *USE THIS ONLY AS A LAST RESORT*. If you need to query they\n\nthey -> the\n\n::: toolkit/modules/BrowserUtils.jsm:878\n(Diff revision 1)\n> -   * The callback function may alter the DOM freely, but *must not query the document's style or\n> -   * layout state*.\n> +   * The callback function may alter the DOM freely, but *must not query\n> +   * the document's style or layout state*.\n> +   *\n> +   * When called due to a forced reflow from `promiseSlowLayoutFlush`\n> +   * that happens during an animation frame, this animation frame\n> +   * callback is guaranteed to run during the same animation frame.\n\nI had to read this comment 3 times to understand it, and I know what we are talking about... so I'm afraid this is a bit obscure.\nPossible tweaks to the wording:\n- simplify \"during the same animation frame\" to \"during the same frame\"\nor\n- replace \"during the same animation frame\" with \"before the frame is painted\".", "author": "florian@queze.net", "id": 12613535, "time": "2017-08-30T15:41:04Z"}, {"text": "Comment on attachment 8889105\nBug 1356532: Part 4 - Avoid layout flushes during adjustSiteIconStart() and _handleOverflow().\n\nhttps://reviewboard.mozilla.org/r/160132/#review179550\n\nr- because the positions are off. I'll attach a screenshot.\n\nPlease update the list of expected reflows in mconley's browser/base/content/test/performance/browser_urlbar_*_reflows.js tests.", "author": "florian@queze.net", "id": 12613541, "time": "2017-08-30T15:42:51Z"}, {"text": "Created attachment 8902730\nScreenshot", "author": "florian@queze.net", "id": 12613544, "time": "2017-08-30T15:43:45Z"}, {"text": "(In reply to Florian Qu\u00e8ze [:florian] [:flo] (away until August 28th) from comment #47)\n> r- because the positions are off. I'll attach a screenshot.\n\nHm. Interesting. I didn't have this issue when I first tested, but I do now.", "author": "kmaglione+bmo@mozilla.com", "id": 12613994, "time": "2017-08-30T17:35:14Z"}, {"text": "Comment on attachment 8901502\nBug 1356532: Part 3 - Add layout query helper that forces a single reflow before paint.\n\nhttps://reviewboard.mozilla.org/r/172956/#review179516\n\n> I had to read this comment 3 times to understand it, and I know what we are talking about... so I'm afraid this is a bit obscure.\n> Possible tweaks to the wording:\n> - simplify \"during the same animation frame\" to \"during the same frame\"\n> or\n> - replace \"during the same animation frame\" with \"before the frame is painted\".\n\nHeh... yeah, I struggled to find a sensible way to explain this and still came up short...\n\nUpdated to:\n\n    * This has an important difference from `window.requestAnimationFrame`\n    * when used alongside `promiseSlowLayoutFlush`:\n    *\n    * Sometimes `promiseSlowLayoutFlush` needs to force a layout flush\n    * from an animation frame callback before calling its callbacks. If\n    * those callbacks call `window.requestAnimationFrame` in that\n    * circumstance, those callbacks will run in the *next* animation\n    * frame, after the current frame is painted. `promiseAnimationFrame`\n    * callbacks, however, will run in the *same* animation frame, after\n    * all layout flush callbacks have been called and their pending\n    * promise microtasks processed.\n\n(with some additional copy-editing that I can't be bothered to copy back into the mozreview field and reformat...)", "author": "kmaglione+bmo@mozilla.com", "id": 12614240, "time": "2017-08-30T18:42:37Z"}, {"text": "Comment on attachment 8889103\nBug 1356532: Part 1 - Add BrowserUtils.promiseAnimationFrame helper.\n\nhttps://reviewboard.mozilla.org/r/160128/#review179510\n\n> Still looks like there's a missing word after 'to'.\n\nUpdating commit messages is always the last thing I do before I land :)", "author": "kmaglione+bmo@mozilla.com", "id": 12614305, "time": "2017-08-30T18:55:29Z"}, {"text": "Comment on attachment 8889103\nBug 1356532: Part 1 - Add BrowserUtils.promiseAnimationFrame helper.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/160128/diff/3-4/", "author": "kmaglione+bmo@mozilla.com", "id": 12614328, "time": "2017-08-30T19:02:15Z"}, {"text": "Comment on attachment 8901501\nBug 1356532: Part 2 - Add helper for performing Promise microtask checkpoint from JS.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/172954/diff/1-2/", "author": "kmaglione+bmo@mozilla.com", "id": 12614329, "time": "2017-08-30T19:02:15Z"}, {"text": "Comment on attachment 8901502\nBug 1356532: Part 3 - Add layout query helper that forces a single reflow before paint.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/172956/diff/1-2/", "author": "kmaglione+bmo@mozilla.com", "id": 12614330, "time": "2017-08-30T19:02:15Z"}, {"text": "Comment on attachment 8889105\nBug 1356532: Part 4 - Avoid layout flushes during adjustSiteIconStart() and _handleOverflow().\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/160132/diff/3-4/", "author": "kmaglione+bmo@mozilla.com", "id": 12614331, "time": "2017-08-30T19:02:15Z"}, {"text": "Comment on attachment 8889106\nBug 1356532: Part 5 - Avoid layout flushes during adjustHeight().\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/160134/diff/3-4/", "author": "kmaglione+bmo@mozilla.com", "id": 12614332, "time": "2017-08-30T19:02:15Z"}, {"text": "(In reply to Kris Maglione [:kmag] from comment #50)\n\n> Heh... yeah, I struggled to find a sensible way to explain this and still\n> came up short...\n> \n> Updated to:\n[...]\n\nMuch clearer, thanks! :-)", "author": "florian@queze.net", "id": 12616538, "time": "2017-08-31T10:35:50Z"}, {"text": "Comment on attachment 8889105\nBug 1356532: Part 4 - Avoid layout flushes during adjustSiteIconStart() and _handleOverflow().\n\nhttps://reviewboard.mozilla.org/r/160132/#review179948\n\nThe browser/base/content/test/performance/browser_urlbar_keyed_search_reflows.js test also needs to be updated.\n\nThe positions are still off for a few frames before getting fixed, I'll attach a screen cast.\n\n::: toolkit/content/widgets/autocomplete.xml:2390\n(Diff revisions 3 - 4)\n>            this._overflowPromise = (async () => {\n>              if (typeof this._siteIconStart != \"number\") {\n>                this.typeIconSpacer.style.removeProperty(\"width\");\n>              }\n>  \n> -            let [itemRect, iconSpacerRect, titleRect, tagsRect, separatorRect, urlRect, actionRect] =\n> +            let [itemRect, iconSpacerRect, siteIconRect, titleRect, tagsRect, separatorRect, urlRect, actionRect] =\n\nnit: This line is too long, please wrap it after \"tagsRect,\".\n\n::: browser/base/content/test/performance/browser_urlbar_search_reflows.js:41\n(Diff revision 4)\n> -    stack: [\n> -      \"adjustHeight@chrome://global/content/bindings/autocomplete.xml\",\n> -      \"_invalidate/this._adjustHeightTimeout<@chrome://global/content/bindings/autocomplete.xml\",\n>      ],\n>      times: 3, // This number should only ever go down - never up.\n> +    minTimes: 2,\n\nWhat's causing this non determinism? Is it because we sometimes have 3 frames and sometimes only 2 before we are done displaying the panel? (this could do with a comment here in the test)\n\nIs there anything we can do about it to have always the same number of reflows here?\n\nI almost wonder if BrowserUtils.forceReflow should be handled by head.js, with a verification that it happens at most once per requestAnimationFrame, and only a boolean in the test file to say that the code being tested is expected to use BrowserUtils.forceReflow. Maybe this is overkill though.\n\n::: browser/base/content/test/performance/browser_urlbar_search_reflows.js:95\n(Diff revision 4)\n> +  {\n> +    stack: [\n> +      \"forceReflow@resource://gre/modules/BrowserUtils.jsm\",\n> +    ],\n> +    times: 3, // This number should only ever go down - never up.\n> +    minTimes: 1,\n\nSame here.\n\n::: browser/base/content/test/performance/head.js:54\n(Diff revision 4)\n>   *              \"get_scrollPosition@chrome://global/content/bindings/scrollbox.xml\",\n>   *              \"_fillTrailingGap@chrome://browser/content/tabbrowser.xml\",\n>   *              \"_handleNewTab@chrome://browser/content/tabbrowser.xml\",\n>   *              \"onxbltransitionend@chrome://browser/content/tabbrowser.xml\",\n>   *            ],\n>   *          }\n\nIf we do want to have support for \"minTimes\", we should document it in this comment with an example.\n\n::: browser/base/content/test/performance/head.js:66\n(Diff revision 4)\n>   *        will cause an assertion failure. When this argument is not passed,\n>   *        it defaults to the empty Array, meaning no reflows are expected.\n>   * @param window (browser window, optional)\n>   *        The browser window to monitor. Defaults to the current window.\n>   */\n> +let times = {};\n\nThis doesn't seem to be used, please remove it. And if it was used, a global variable shared with all test files of the folder should have a longer name to avoid collisions.\n\n::: browser/base/content/test/performance/head.js:126\n(Diff revision 4)\n>        let index = expectedReflows.findIndex(reflow => path.startsWith(reflow.stack.join(\"|\")));\n>  \n>        if (index != -1) {\n>          Assert.ok(true, \"expected uninterruptible reflow: '\" +\n>                    JSON.stringify(pathWithLineNumbers, null, \"\\t\") + \"'\");\n> +        --expectedReflows[index].minTimes;\n\nWhile this works (and results in NaN), -- on something that's undefined makes me a bit uncomfortable.\n\n::: browser/base/content/test/performance/head.js:161\n(Diff revision 4)\n>    } finally {\n>      for (let remainder of expectedReflows) {\n> -      Assert.ok(false,\n> +      Assert.ok(remainder.minTimes <= 0,\n>                  `Unused expected reflow: ${JSON.stringify(remainder.stack, null, \"\\t\")}\\n` +\n> -                `This reflow was supposed to be hit ${remainder.times} more time(s).\\n` +\n> +                `This reflow was supposed to be hit ${remainder.minTimes || remainder.times} ` +\n> +                `more time(s).\\n` +\n\nThis line is not a template string and could use normal double quotes.\n\n::: toolkit/modules/BrowserUtils.jsm:50\n(Diff revision 4)\n>  }\n>  \n>  ReflowScheduler.prototype = {\n>    QueryInterface: XPCOMUtils.generateQI([\"nsIReflowObserver\", \"nsISupportsWeakReference\"]),\n>  \n> +  // This is overridden by mochitests to allow us skip dirtying the\n\nto allow us _to_ skip", "author": "florian@queze.net", "id": 12616618, "time": "2017-08-31T11:19:35Z"}, {"text": "Created attachment 8903114\nScreencast", "author": "florian@queze.net", "id": 12616621, "time": "2017-08-31T11:20:48Z"}, {"text": "When running the browser_urlbar_search_reflows.js test after applying the patches, I see lots of errors like this in the output:\n\n19 INFO Console message: [JavaScript Warning: \"Error in parsing value for \u2018max-width\u2019.  Declaration dropped.\" {file: \"chrome://browser/content/browser.xul\" line: 0 column: 0 source: \"-6.534000000000001px\"}]\n20 INFO Console message: [JavaScript Warning: \"Error in parsing value for \u2018max-width\u2019.  Declaration dropped.\" {file: \"chrome://browser/content/browser.xul\" line: 0 column: 0 source: \"-13.265999999999998px\"}]\n21 INFO Console message: [JavaScript Warning: \"Error in parsing value for \u2018max-width\u2019.  Declaration dropped.\" {file: \"chrome://browser/content/browser.xul\" line: 0 column: 0 source: \"-10.2px\"}]\n22 INFO Console message: [JavaScript Warning: \"Error in parsing value for \u2018max-width\u2019.  Declaration dropped.\" {file: \"chrome://browser/content/browser.xul\" line: 0 column: 0 source: \"-10.2px\"}]\n\nThese errors aren't here if I unapply the patches. This may give a hint about what's causing the flicker in my screencast.", "author": "florian@queze.net", "id": 12616640, "time": "2017-08-31T11:30:45Z"}, {"text": "Comment on attachment 8889105\nBug 1356532: Part 4 - Avoid layout flushes during adjustSiteIconStart() and _handleOverflow().\n\nhttps://reviewboard.mozilla.org/r/160132/#review179948\n\nHuh. Interesting. I had to single-step through the video to see this. I can only reproduce it locally the first time the drop-down opens, so it presumably has something to do with the initial offset value.\n\n> What's causing this non determinism? Is it because we sometimes have 3 frames and sometimes only 2 before we are done displaying the panel? (this could do with a comment here in the test)\n> \n> Is there anything we can do about it to have always the same number of reflows here?\n> \n> I almost wonder if BrowserUtils.forceReflow should be handled by head.js, with a verification that it happens at most once per requestAnimationFrame, and only a boolean in the test file to say that the code being tested is expected to use BrowserUtils.forceReflow. Maybe this is overkill though.\n\nIt's timing-related, and depends on how many times we're asked to update per-frame, and when exactly in the frame it happens. So, for example, either of the following sequences are possible when we update twice during a frame:\n\n1) - We're asked to add a new item to the list, and request a layout flush.\n   - There's enough time for an idle callback before the next animation frame, so we force a reflow during an idle slice and do layout calculations.\n   - A new result comes in, so we add it to the list and request a layout flush.\n   - There's not enough time for an idle callback, so we force a layout flush during the next animation frame.\n\n2) - We're asked to add a new frame to the list, and request a layout flush.\n   - A new result comes in, so we add it to the list, with a layout flush still pending.\n   - There's not enough time for an idle callback, so we force a layout flush during the next animation frame.\n\nIt's hard to make the above deterministic. We could remove the idle callback logic, which would reduce the number of reflows between frames, but at the expense of pushing back the next animation frame more often.\n\nEven if we did, the `_handleOverflow` function currently tries to avoid multiple operations within the same frame by storing the promise for an existing calculation. Which means that two updates within the same frame would still produce fewer flushes than two updates in consecutive frames, and I don't think we want to change that.\n\n> This doesn't seem to be used, please remove it. And if it was used, a global variable shared with all test files of the folder should have a longer name to avoid collisions.\n\nOops. I was using it to dump the existing flushes when I was updating the tests. I meant to remove it.\n\n> This line is not a template string and could use normal double quotes.\n\nI generally try to use the same string types when concatenating like this, even if not all of them use template interpolation. Partly for style reasons, partly because it's easy to add new template interpolation to one of the double quoted strings without noticing. But I don't have a super strong opinion on it.", "author": "kmaglione+bmo@mozilla.com", "id": 12618076, "time": "2017-08-31T18:53:59Z"}, {"text": "Is there any chance this could still ship with 57? Should we accept the initial flicker for 57 (as the current implementation flickers anyway) to get the improvements while typing/using the awesomebar?", "author": "florian@queze.net", "id": 12652075, "time": "2017-09-12T15:02:24Z"}, {"text": "I have a local patch that by avoiding completely the call to handleOverUnderflow in certain cases reduces its reflows in browser_urlbar_search_reflows by 654 and in browser_urlbar_keyed_search_reflows by 1284. I'll try to land that as part of bug 1391293, so this specific fix may be a bit less critical to have in 57 and could be delayed to 58, if we're scared about regressions or we want to address the remaining issues.", "author": "mak77@bonardo.net", "id": 12671922, "time": "2017-09-15T21:03:18Z"}, {"text": "*** Bug 1399007 has been marked as a duplicate of this bug. ***", "author": "florian@queze.net", "id": 12676654, "time": "2017-09-18T09:27:44Z"}, {"text": "Note: I'm also copying over the minTimes idea in bug 1391293.", "author": "mak77@bonardo.net", "id": 12680967, "time": "2017-09-19T12:08:35Z"}, {"text": "In bug 1414126 I disabled the browser_urlbar_search_reflows.js test on Windows/Linux debug because it intermittently timed out (and always took ages to run). We should consider re-enabling it once this bug is fixed.", "author": "florian@queze.net", "id": 12929134, "time": "2017-12-20T16:02:55Z"}, {"text": "This is sort-of blocked by Bug 1434376.", "author": "mak77@bonardo.net", "id": 13010808, "time": "2018-02-01T10:13:53Z"}, {"text": "Now that bug 1434376 is fixed, maybe we can get this moving again? It's the most painful performance bug related to the urlbar panel.", "author": "florian@queze.net", "id": 13083550, "time": "2018-03-02T17:20:30Z"}, {"text": "Stealing this per perf team discussions - Kris, I know you're busy and I don't see any activity here for the last few months, but let me know if you were about to revive this yourself! :-)", "author": "gijskruitbosch+bugs@gmail.com", "id": 13262433, "time": "2018-05-08T14:03:13Z"}], "id": 1356532, "priority": "P1", "platform": "Unspecified", "cf_crash_signature": "", "version": "Trunk", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": ["https://bugzilla.mozilla.org/show_bug.cgi?id=1414246", "https://bugzilla.mozilla.org/show_bug.cgi?id=1414126"], "summary": "Try avoiding layout flushes in autocomplete::_handleOverflow", "cf_platform_rel": "---", "product": "Firefox", "cf_fx_iteration": "---", "blocks": [1353725, 1363757, 1366787, 1381427, 1399007, 1402130], "qa_contact": "adrian.florinescu@softvision.ro", "creation_time": "2017-04-14T09:29:21Z", "cf_status_firefox_esr52": "---", "component": "Address Bar", "assigned_to_detail": {"email": "gijskruitbosch+bugs@gmail.com", "id": 159069, "name": "gijskruitbosch+bugs@gmail.com", "real_name": ":Gijs (he/him)"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "groups": [], "cf_status_firefox60": "---", "target_milestone": "---", "cf_qa_whiteboard": "", "severity": "normal", "cf_rank": null, "cf_fx_points": "---", "url": "", "creator_detail": {"email": "mak77@bonardo.net", "id": 240353, "name": "mak77@bonardo.net", "real_name": "Marco Bonardo [::mak]"}, "whiteboard": "[fxsearch][fxperf:p2]", "mentors": [], "cc_detail": [{"email": "dao+bmo@mozilla.com", "id": 219124, "name": "dao+bmo@mozilla.com", "real_name": "D\u00e3o Gottwald [::dao]"}, {"email": "florian@queze.net", "id": 149052, "name": "florian@queze.net", "real_name": "Florian Qu\u00e8ze [:florian]"}, {"email": "geeknik@protonmail.ch", "id": 31466, "name": "geeknik@protonmail.ch", "real_name": "Brian Carpenter [:geeknik]"}, {"email": "gijskruitbosch+bugs@gmail.com", "id": 159069, "name": "gijskruitbosch+bugs@gmail.com", "real_name": ":Gijs (he/him)"}, {"email": "kmaglione+bmo@mozilla.com", "id": 106098, "name": "kmaglione+bmo@mozilla.com", "real_name": "Kris Maglione [:kmag]"}, {"email": "mak77@bonardo.net", "id": 240353, "name": "mak77@bonardo.net", "real_name": "Marco Bonardo [::mak]"}, {"email": "mcastelluccio@mozilla.com", "id": 420453, "name": "mcastelluccio@mozilla.com", "real_name": "Marco Castelluccio [:marco]"}, {"email": "mconley@mozilla.com", "id": 403756, "name": "mconley@mozilla.com", "real_name": "Mike Conley (:mconley) (:\u2699\ufe0f) (Catching up on needinfos / reviews)"}, {"email": "nissan4321@gmail.com", "id": 414417, "name": "nissan4321@gmail.com", "real_name": "Mikel"}, {"email": "paolo.mozmail@amadzone.org", "id": 332229, "name": "paolo.mozmail@amadzone.org", "real_name": ":Paolo Amadini"}, {"email": "past@mozilla.com", "id": 363318, "name": "past@mozilla.com", "real_name": "Panos Astithas [:past] (please ni?)"}, {"email": "rjward0@gmail.com", "id": 470932, "name": "rjward0@gmail.com", "real_name": "Robbie Ward"}, {"email": "standard8@mozilla.com", "id": 112088, "name": "standard8@mozilla.com", "real_name": "Mark Banner (:standard8)"}, {"email": "yoasif@gmail.com", "id": 347239, "name": "yoasif@gmail.com", "real_name": "Asif Youssuff"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [{"status": "+", "name": "qe-verify", "modification_date": "2017-06-06T14:33:53Z", "type_id": 864, "creation_date": "2017-04-14T10:01:01Z", "id": 1564867, "setter": "mmucci@mozilla.com"}], "last_change_time": "2018-05-08T14:03:13Z", "assigned_to": "gijskruitbosch+bugs@gmail.com", "is_open": true, "resolution": "", "op_sys": "Unspecified", "cc": ["dao+bmo@mozilla.com", "florian@queze.net", "geeknik@protonmail.ch", "gijskruitbosch+bugs@gmail.com", "kmaglione+bmo@mozilla.com", "mak77@bonardo.net", "mcastelluccio@mozilla.com", "mconley@mozilla.com", "nissan4321@gmail.com", "paolo.mozmail@amadzone.org", "past@mozilla.com", "rjward0@gmail.com", "standard8@mozilla.com", "yoasif@gmail.com"], "history": [{"changes": [{"removed": "--", "field_name": "priority", "added": "P2"}, {"removed": "", "field_name": "cc", "added": "mmucci@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "qe-verify?"}], "who": "mmucci@mozilla.com", "when": "2017-04-14T10:01:01Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "florian@queze.net"}], "who": "florian@queze.net", "when": "2017-04-14T10:38:34Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "rjward0@gmail.com"}], "who": "florian@queze.net", "when": "2017-04-15T17:06:46Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "nissan4321@gmail.com"}], "who": "nissan4321@gmail.com", "when": "2017-04-16T16:02:40Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mak77@bonardo.net"}], "who": "mak77@bonardo.net", "when": "2017-04-21T15:13:22Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mcastelluccio@mozilla.com"}], "who": "mcastelluccio@mozilla.com", "when": "2017-04-24T18:18:20Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "geeknik@protonmail.ch"}], "who": "geeknik@protonmail.ch", "when": "2017-05-10T20:19:31Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1366787"}], "who": "mak77@bonardo.net", "when": "2017-05-22T20:37:04Z"}, {"changes": [{"removed": "P2", "field_name": "priority", "added": "P3"}, {"removed": "[fxsearch][photon-performance]", "field_name": "whiteboard", "added": "[fxsearch][reserve-photon-performance]"}], "who": "mmucci@mozilla.com", "when": "2017-05-23T15:04:32Z"}, {"changes": [{"removed": "", "field_name": "qa_contact", "added": "adrian.florinescu@softvision.ro"}, {"removed": "qe-verify?", "field_name": "flagtypes.name", "added": "qe-verify+"}], "who": "mmucci@mozilla.com", "when": "2017-06-06T14:33:53Z"}, {"changes": [{"removed": "P3", "field_name": "priority", "added": "P2"}, {"removed": "[fxsearch][reserve-photon-performance]", "field_name": "whiteboard", "added": "[fxsearch] [photon-performance]"}], "who": "mmucci@mozilla.com", "when": "2017-07-18T14:44:52Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "kmaglione+bmo@mozilla.com"}], "who": "kmaglione+bmo@mozilla.com", "when": "2017-07-22T05:52:07Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1383367"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "kmaglione+bmo@mozilla.com"}], "who": "kmaglione+bmo@mozilla.com", "when": "2017-07-22T22:40:26Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8889103, "added": "review?(florian@queze.net)"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8889104, "added": "review?(florian@queze.net)"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8889105, "added": "review?(florian@queze.net)"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8889106, "added": "review?(florian@queze.net)"}], "who": "kmaglione+bmo@mozilla.com", "when": "2017-07-22T23:08:18Z"}, {"changes": [{"removed": "P2", "field_name": "priority", "added": "P1"}, {"removed": "NEW", "field_name": "status", "added": "ASSIGNED"}], "who": "mmucci@mozilla.com", "when": "2017-07-23T15:24:53Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(florian@queze.net)", "attachment_id": 8889103, "added": ""}], "who": "florian@queze.net", "when": "2017-07-24T15:12:56Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(florian@queze.net)", "attachment_id": 8889104, "added": "review+"}], "who": "florian@queze.net", "when": "2017-07-24T15:21:19Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(florian@queze.net)", "attachment_id": 8889105, "added": "review+"}], "who": "florian@queze.net", "when": "2017-07-24T15:23:29Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(florian@queze.net)", "attachment_id": 8889106, "added": "review+"}], "who": "florian@queze.net", "when": "2017-07-24T15:50:56Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(mak77@bonardo.net)"}], "who": "florian@queze.net", "when": "2017-07-24T15:52:01Z"}, {"changes": [{"removed": "needinfo?(mak77@bonardo.net)", "field_name": "flagtypes.name", "added": ""}], "who": "mak77@bonardo.net", "when": "2017-07-24T21:08:04Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "dao+bmo@mozilla.com"}], "who": "dao+bmo@mozilla.com", "when": "2017-08-01T09:54:25Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mconley@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(kmaglione+bmo@mozilla.com)"}], "who": "mconley@mozilla.com", "when": "2017-08-08T14:08:17Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "paolo.mozmail@amadzone.org"}], "who": "paolo.mozmail@amadzone.org", "when": "2017-08-21T12:23:12Z"}, {"changes": [{"removed": "[fxsearch] [photon-performance]", "field_name": "whiteboard", "added": "[fxsearch] [reserve-photon-performance]"}], "who": "mmucci@mozilla.com", "when": "2017-08-25T17:56:00Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8901501, "added": "review?(florian@queze.net)"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8901502, "added": "review?(florian@queze.net)"}, {"field_name": "attachments.description", "removed": "Bug 1356532: Part 1 - Add PromiseUtils.animationFrame helper.", "attachment_id": 8889103, "added": "Bug 1356532: Part 1 - Add BrowserUtils.promiseAnimationFrame helper."}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8889103, "added": "review?(florian@queze.net)"}, {"field_name": "attachments.description", "removed": "Bug 1356532: Part 3 - Avoid layout flushes during _handleOverflow().", "attachment_id": 8889105, "added": "Bug 1356532: Part 4 - Avoid layout flushes during adjustSiteIconStart() and _handleOverflow()."}, {"field_name": "attachments.description", "removed": "Bug 1356532: Part 4 - Avoid layout flushes during adjustHeight().", "attachment_id": 8889106, "added": "Bug 1356532: Part 5 - Avoid layout flushes during adjustHeight()."}], "who": "kmaglione+bmo@mozilla.com", "when": "2017-08-26T22:20:13Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8889104, "added": "1"}], "who": "kmaglione+bmo@mozilla.com", "when": "2017-08-26T22:20:22Z"}, {"changes": [{"removed": "needinfo?(kmaglione+bmo@mozilla.com)", "field_name": "flagtypes.name", "added": ""}, {"field_name": "flagtypes.name", "removed": "review+", "attachment_id": 8889105, "added": "review?(florian@queze.net)"}], "who": "kmaglione+bmo@mozilla.com", "when": "2017-08-26T22:22:01Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1381427"}], "who": "paolo.mozmail@amadzone.org", "when": "2017-08-29T14:58:01Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(florian@queze.net)", "attachment_id": 8889103, "added": "review+"}], "who": "florian@queze.net", "when": "2017-08-30T15:38:54Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(florian@queze.net)", "attachment_id": 8901501, "added": "review+"}], "who": "florian@queze.net", "when": "2017-08-30T15:39:49Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(florian@queze.net)", "attachment_id": 8901502, "added": "review+"}], "who": "florian@queze.net", "when": "2017-08-30T15:41:04Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(florian@queze.net)", "attachment_id": 8889105, "added": "review-"}], "who": "florian@queze.net", "when": "2017-08-30T15:42:51Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review-", "attachment_id": 8889105, "added": "review?(florian@queze.net)"}], "who": "kmaglione+bmo@mozilla.com", "when": "2017-08-30T19:02:15Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "standard8@mozilla.com"}], "who": "standard8@mozilla.com", "when": "2017-08-31T09:24:15Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(florian@queze.net)", "attachment_id": 8889105, "added": "review-"}], "who": "florian@queze.net", "when": "2017-08-31T11:19:35Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8902730, "added": "1"}], "who": "florian@queze.net", "when": "2017-08-31T11:20:48Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(kmaglione+bmo@mozilla.com)"}], "who": "florian@queze.net", "when": "2017-09-12T15:02:24Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1399007"}], "who": "mak77@bonardo.net", "when": "2017-09-17T17:31:18Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "yoasif@gmail.com"}], "who": "florian@queze.net", "when": "2017-09-18T09:27:44Z"}, {"changes": [{"removed": "---", "field_name": "cf_status_firefox56", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox57", "added": "affected"}], "who": "yoasif@gmail.com", "when": "2017-09-19T14:36:06Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "past@mozilla.com"}, {"removed": "affected", "field_name": "cf_status_firefox55", "added": "wontfix"}, {"removed": "affected", "field_name": "cf_status_firefox56", "added": "wontfix"}, {"removed": "---", "field_name": "cf_status_firefox58", "added": "affected"}], "who": "past@mozilla.com", "when": "2017-09-25T12:55:40Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox57", "added": "wontfix"}], "who": "past@mozilla.com", "when": "2017-10-30T11:25:16Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1414246"}], "who": "florian@queze.net", "when": "2017-11-03T13:37:03Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1402130"}], "who": "mak77@bonardo.net", "when": "2017-11-09T11:18:44Z"}, {"changes": [{"removed": "mmucci@mozilla.com", "field_name": "cc", "added": ""}], "who": "mmucci@mozilla.com", "when": "2017-11-14T19:39:00Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1414126"}], "who": "florian@queze.net", "when": "2017-12-20T16:02:55Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1434376"}], "who": "mak77@bonardo.net", "when": "2018-02-01T10:13:53Z"}, {"changes": [{"removed": "[fxsearch] [reserve-photon-performance]", "field_name": "whiteboard", "added": "[fxsearch] [reserve-photon-performance] [fxperf]"}], "who": "bug-husbandry-bot@mozilla.bugs", "when": "2018-02-10T00:09:38Z"}, {"changes": [{"removed": "[fxsearch] [reserve-photon-performance] [fxperf]", "field_name": "whiteboard", "added": "[fxsearch] [reserve-photon-performance] [fxperf:p2]"}], "who": "florian@queze.net", "when": "2018-03-02T17:20:30Z"}, {"changes": [{"removed": "[fxsearch] [reserve-photon-performance] [fxperf:p2]", "field_name": "whiteboard", "added": "[fxsearch][fxperf:p2]"}], "who": "mconley@mozilla.com", "when": "2018-03-19T18:59:43Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1363757"}], "who": "mak77@bonardo.net", "when": "2018-03-20T13:47:46Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "gijskruitbosch+bugs@gmail.com"}, {"removed": "kmaglione+bmo@mozilla.com", "field_name": "assigned_to", "added": "gijskruitbosch+bugs@gmail.com"}, {"removed": "needinfo?(kmaglione+bmo@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "gijskruitbosch+bugs@gmail.com", "when": "2018-05-08T14:03:13Z"}]}