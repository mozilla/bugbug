{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "enndeakin@gmail.com", "mentors_detail": [], "depends_on": [1445912, 1457763, 1458025], "cf_status_firefox_esr60": "---", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": [], "cc_detail": [{"email": "bgrinstead@mozilla.com", "id": 476442, "name": "bgrinstead@mozilla.com", "real_name": "Brian Grinstead [:bgrins]"}, {"email": "bzbarsky@mit.edu", "id": 20209, "name": "bzbarsky@mit.edu", "real_name": "Boris Zbarsky [:bz] (Vacation Jun 16-24) (no decent commit message means r-)"}, {"email": "dao+bmo@mozilla.com", "id": 219124, "name": "dao+bmo@mozilla.com", "real_name": "D\u00e3o Gottwald [::dao]"}, {"email": "gijskruitbosch+bugs@gmail.com", "id": 159069, "name": "gijskruitbosch+bugs@gmail.com", "real_name": ":Gijs (he/him)"}, {"email": "mratcliffe@mozilla.com", "id": 313697, "name": "mratcliffe@mozilla.com", "real_name": "Mike Ratcliffe [:miker] [:mratcliffe] [:mikeratcliffe]"}, {"email": "paolo.mozmail@amadzone.org", "id": 332229, "name": "paolo.mozmail@amadzone.org", "real_name": ":Paolo Amadini"}, {"email": "philipp@bugzilla.kewis.ch", "id": 253233, "name": "philipp@bugzilla.kewis.ch", "real_name": "Philipp Kewisch [:Fallen] "}, {"email": "timdream@gmail.com", "id": 185001, "name": "timdream@gmail.com", "real_name": "Tim Guan-tin Chien [:timdream] (please needinfo)"}], "cf_last_resolved": "2018-04-28T17:33:26Z", "attachments": [{"creator": "enndeakin@gmail.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8960141}, {"creator": "enndeakin@gmail.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8960143}, {"creator": "enndeakin@gmail.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8960144}, {"creator": "enndeakin@gmail.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8960146}, {"creator": "enndeakin@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-05T16:08:22Z", "type_id": 4, "creation_date": "2018-04-04T18:01:49Z", "id": 1739257, "setter": "paolo.mozmail@amadzone.org"}], "content_type": "text/plain", "id": 8965007}, {"creator": "enndeakin@gmail.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8965013}, {"creator": "enndeakin@gmail.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8965014}, {"creator": "enndeakin@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-20T05:04:13Z", "type_id": 4, "creation_date": "2018-04-19T13:51:47Z", "id": 1746283, "setter": "bzbarsky@mit.edu"}], "content_type": "text/plain", "id": 8968867}, {"creator": "enndeakin@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-20T08:48:53Z", "type_id": 4, "creation_date": "2018-04-19T13:52:39Z", "id": 1746284, "setter": "paolo.mozmail@amadzone.org"}, {"status": "+", "name": "review", "modification_date": "2018-04-20T05:07:31Z", "type_id": 4, "creation_date": "2018-04-19T13:53:06Z", "id": 1746285, "setter": "bzbarsky@mit.edu"}], "content_type": "text/plain", "id": 8968868}, {"creator": "enndeakin@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-20T08:58:43Z", "type_id": 4, "creation_date": "2018-04-19T13:53:26Z", "id": 1746286, "setter": "paolo.mozmail@amadzone.org"}], "content_type": "text/plain", "id": 8968869}, {"creator": "enndeakin@gmail.com", "is_obsolete": 1, "is_patch": 1, "flags": [{"status": "-", "name": "review", "modification_date": "2018-04-20T05:16:07Z", "type_id": 4, "creation_date": "2018-04-19T13:54:13Z", "id": 1746287, "setter": "bzbarsky@mit.edu"}], "content_type": "text/plain", "id": 8968870}, {"creator": "enndeakin@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-20T22:30:49Z", "type_id": 4, "creation_date": "2018-04-19T13:54:48Z", "id": 1746288, "setter": "bzbarsky@mit.edu"}], "content_type": "text/plain", "id": 8968871}, {"creator": "enndeakin@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-20T22:26:11Z", "type_id": 4, "creation_date": "2018-04-19T13:56:53Z", "id": 1746293, "setter": "bzbarsky@mit.edu"}], "content_type": "text/plain", "id": 8968874}, {"creator": "enndeakin@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8968875}, {"creator": "enndeakin@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-25T22:56:01Z", "type_id": 4, "creation_date": "2018-04-25T10:58:39Z", "id": 1748747, "setter": "bzbarsky@mit.edu"}], "content_type": "text/plain", "id": 8970844}, {"creator": "enndeakin@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-26T16:52:06Z", "type_id": 4, "creation_date": "2018-04-26T14:47:29Z", "id": 1749440, "setter": "mratcliffe@mozilla.com"}], "content_type": "text/plain", "id": 8971220}], "votes": 0, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 49, "comments": [{"text": "This is an investigation into removing menupopup/panel boxobjects and replacing them with a subclass or some other mechanism. A subclass of XULElement for XULPopupElement is added. It mostly removes the need for the popup-base binding.\n\nThe patches work but some tests fail and there are a couple of remaining issues.", "author": "enndeakin@gmail.com", "id": 13139398, "time": "2018-03-19T13:22:46Z"}, {"text": "Created attachment 8960141\nPart 1 - replace obsolete usage of popup methods", "author": "enndeakin@gmail.com", "id": 13139401, "time": "2018-03-19T13:23:56Z"}, {"text": "Created attachment 8960143\nPart 2 - add a means to subclass nsXULElement\n\nSome of this code may be removed as I had hoped to put the tag check in the xul prototype node instead, yet that isn't available later when a real element is created. This would need to be rafactored or just allow the extra tagchecks per element.", "author": "enndeakin@gmail.com", "id": 13139405, "time": "2018-03-19T13:26:49Z"}, {"text": "Created attachment 8960144\nPart 3 - remove popupboxobject, implement nsXULPopupElement and remove most of popup-base binding", "author": "enndeakin@gmail.com", "id": 13139407, "time": "2018-03-19T13:28:21Z"}, {"text": "Created attachment 8960146\nPart 2/3B Alternate using wrapper\n\nFor reference, here is an alternate version of using a different object returned from WrapNode instead of subclassing nsXULElement.", "author": "enndeakin@gmail.com", "id": 13139421, "time": "2018-03-19T13:37:07Z"}, {"text": "Some simple performance testing shows no different with these patches, or a variation with a really big if block checking other tags.", "author": "enndeakin@gmail.com", "id": 13145730, "time": "2018-03-21T15:31:46Z"}, {"text": "Created attachment 8965007\nPart 1 - replace obsolete usage of popup methods", "author": "enndeakin@gmail.com", "id": 13180588, "time": "2018-04-04T18:01:49Z"}, {"text": "Created attachment 8965013\nPart 2 - add a means to subclass nsXULElement", "author": "enndeakin@gmail.com", "id": 13180617, "time": "2018-04-04T18:11:28Z"}, {"text": "Created attachment 8965014\nPart 3 - remove popupboxobject, implement nsXULPopupElement and remove most of popup-base binding\n\nThis version should pass all tests.", "author": "enndeakin@gmail.com", "id": 13180620, "time": "2018-04-04T18:12:03Z"}, {"text": "Comment on attachment 8965014\nPart 3 - remove popupboxobject, implement nsXULPopupElement and remove most of popup-base binding\n\nReview of attachment 8965014:\n-----------------------------------------------------------------\n\n::: toolkit/content/widgets/popup.xml\n@@ -120,5 @@\n> -          try {\n> -            popupBox = this.popupBoxObject;\n> -          } catch (e) {}\n> -          try {\n> -            menuBox = this.parentNode.boxObject;\n\nThis is checking the parent node for a MenuBoxObject, and using the openMenu method instead if this is found. I don't see this implemented after the conversion. Is this something we don't need anymore?", "author": "paolo.mozmail@amadzone.org", "id": 13180713, "time": "2018-04-04T18:37:20Z"}, {"text": "No, the menuboxobject ends up calling HidePopup with the same arguments, except now the cancel argument isn't ignored. Compare:\n\nhttps://searchfox.org/mozilla-central/source/layout/xul/MenuBoxObject.cpp#50\nhttps://searchfox.org/mozilla-central/source/layout/xul/PopupBoxObject.cpp#58", "author": "enndeakin@gmail.com", "id": 13180745, "time": "2018-04-04T18:46:58Z"}, {"text": "I may be misreading the current code, as it's quite convoluted, but it seems to me that, for the opening case, if the parent element has a MenuBoxObject then the opening process would end up in showMenu instead of showPopup, and the former method does some more things:\n\nhttps://searchfox.org/mozilla-central/rev/a0665934fa05158a5a943d4c8b277465910c029c/layout/xul/nsXULPopupManager.cpp#708\n\nDoes this ever happen in practice? Things like buttons of type=\"menu\" currently have a MenuBoxObject.\n\nI remember various instances where moving menus or panels away from a triggering element would cause subtle changes in behavior, so if we could simplify things that would definitely be welcome.", "author": "paolo.mozmail@amadzone.org", "id": 13180831, "time": "2018-04-04T19:15:01Z"}, {"text": "Comment on attachment 8965007\nPart 1 - replace obsolete usage of popup methods\n\nReview of attachment 8965007:\n-----------------------------------------------------------------\n\n::: layout/base/crashtests/372576.xul\n@@ +8,5 @@\n>  </script>\n>  <toolbox>\n>  \t\t<toolbar>\n>  \t\t\t<toolbarbutton type=\"menu\" class=\"toolbarbutton-1 firefly_files\" label=\"Crash\" tooltiptext=\"Crash\">\n> +        <menupopup ignorekeys=\"true\">\n\nThis is probably an example where the parent has a MenuBoxObject. Can you clarify why this test case had to be changed? Is it unrelated to comment 11?", "author": "paolo.mozmail@amadzone.org", "id": 13180861, "time": "2018-04-04T19:23:52Z"}, {"text": "(I see that enableKeyboardNavigator has been removed, wondering if it's just this.)", "author": "paolo.mozmail@amadzone.org", "id": 13180869, "time": "2018-04-04T19:27:28Z"}, {"text": "Comment on attachment 8965007\nPart 1 - replace obsolete usage of popup methods\n\nReview of attachment 8965007:\n-----------------------------------------------------------------\n\nThis looks good to me, I'll do a final pass tomorrow and I have just a few more minor questions in the meantime.\n\n::: toolkit/content/widgets/browser.xml\n@@ -1250,5 @@\n>              let popupY = Math.max(minY, Math.min(maxY, screenY));\n> -            this._autoScrollPopup.showPopup(document.documentElement,\n> -                                            popupX,\n> -                                            popupY,\n> -                                            \"popup\", null, null);\n\nIs dropping document.documentElement inconsequential here?\n\n::: toolkit/content/widgets/tree.xml\n@@ +1555,5 @@\n>          <![CDATA[\n>            if (event.originalTarget == this) {\n>              var popup = document.getAnonymousElementByAttribute(this, \"anonid\", \"popup\");\n>              this.buildPopup(popup);\n> +            popup.openPopup(this, \"after_end\");\n\nIs this changing any alignment?", "author": "paolo.mozmail@amadzone.org", "id": 13180888, "time": "2018-04-04T19:32:49Z"}, {"text": "> Does this ever happen in practice? Things like buttons of type=\"menu\"\n> currently have a MenuBoxObject.\n\nI'll add a special case in the part 3 patch for openPopup that calls into showMenu as needed.\n\n\n> This is probably an example where the parent has a MenuBoxObject. Can you\n> clarify why this test case had to be changed? Is it unrelated to comment 11?\n\nI removed enableKeyboardNavigator which just sets the attribute.\n\n\n> ::: toolkit/content/widgets/browser.xml\n> @@ -1250,5 @@\n> >              let popupY = Math.max(minY, Math.min(maxY, screenY));\n> > -            this._autoScrollPopup.showPopup(document.documentElement,\n> > -                                            popupX,\n> > -                                            popupY,\n> > -                                            \"popup\", null, null);\n> \n> Is dropping document.documentElement inconsequential here?\n\nShouldn't be. A null anchor means align to the the root nsIFrame.\n\n\n> ::: toolkit/content/widgets/tree.xml\n> @@ +1555,5 @@\n> >          <![CDATA[\n> >            if (event.originalTarget == this) {\n> >              var popup = document.getAnonymousElementByAttribute(this, \"anonid\", \"popup\");\n> >              this.buildPopup(popup);\n> > +            popup.openPopup(this, \"after_end\");\n> \n> Is this changing any alignment?\n\nNo, after_end corresponds to an anchor of \"bottomright\" and an alignment of \"topright\"", "author": "enndeakin@gmail.com", "id": 13183518, "time": "2018-04-05T15:47:50Z"}, {"text": "Comment on attachment 8965007\nPart 1 - replace obsolete usage of popup methods\n\nReview of attachment 8965007:\n-----------------------------------------------------------------\n\nThanks!", "author": "paolo.mozmail@amadzone.org", "id": 13183593, "time": "2018-04-05T16:08:22Z"}, {"text": "Gijs, given the bug 1437638 that you filed, do you think that the approach here (creating a subclass of nsXULElement) is sufficient and would be worth moving forward on?", "author": "enndeakin@gmail.com", "id": 13194769, "time": "2018-04-10T13:17:12Z"}, {"text": "(In reply to Neil Deakin from comment #17)\n> Gijs, given the bug 1437638 that you filed, do you think that the approach\n> here (creating a subclass of nsXULElement) is sufficient and would be worth\n> moving forward on?\n\nYep, this seems fine to me.", "author": "gijskruitbosch+bugs@gmail.com", "id": 13194881, "time": "2018-04-10T13:52:32Z"}, {"text": "Created attachment 8968867\nPart 2 - add a means to subclass nsXULElement", "author": "enndeakin@gmail.com", "id": 13215266, "time": "2018-04-18T13:02:20Z"}, {"text": "Created attachment 8968868\nPart 3 - remove deprecated showPopup method\n\nBug 1445912 removed some of the other unneeded methods.", "author": "enndeakin@gmail.com", "id": 13215267, "time": "2018-04-18T13:03:38Z"}, {"text": "Created attachment 8968869\nPart 4 - remove now unused methods now that showPopup has been removed", "author": "enndeakin@gmail.com", "id": 13215268, "time": "2018-04-18T13:04:23Z"}, {"text": "Created attachment 8968870\nPart 5 - add support for dictionary argument to openPopup as popup.xml#openPopup does", "author": "enndeakin@gmail.com", "id": 13215271, "time": "2018-04-18T13:05:13Z"}, {"text": "Created attachment 8968871\nPart 6 - support two special cases used in popup.xml", "author": "enndeakin@gmail.com", "id": 13215274, "time": "2018-04-18T13:06:29Z"}, {"text": "Created attachment 8968874\nPart 7 - remove PopupBoxObject and replace with a nsXULElement subclass\n\nNote that I'm not sure if the label and position attributes are necessary but left them in to be consistent with the existing popup binding API.", "author": "enndeakin@gmail.com", "id": 13215279, "time": "2018-04-18T13:08:46Z"}, {"text": "Created attachment 8968875\nPart 8 - test changes\n\nChanges needed for some tests.", "author": "enndeakin@gmail.com", "id": 13215286, "time": "2018-04-18T13:12:43Z"}, {"text": "Comment on attachment 8968868\nPart 3 - remove deprecated showPopup method\n\ndom/webidl changes", "author": "enndeakin@gmail.com", "id": 13218496, "time": "2018-04-19T13:53:06Z"}, {"text": "Comment on attachment 8968871\nPart 6 - support two special cases used in popup.xml\n\nPaolo, not sure if you would be able to review these", "author": "enndeakin@gmail.com", "id": 13218501, "time": "2018-04-19T13:54:48Z"}, {"text": "Comment on attachment 8968874\nPart 7 - remove PopupBoxObject and replace with a nsXULElement subclass\n\nPerhaps I should add the new interface to chrome-webidl instead?", "author": "enndeakin@gmail.com", "id": 13218513, "time": "2018-04-19T13:56:53Z"}, {"text": "Comment on attachment 8968867\nPart 2 - add a means to subclass nsXULElement\n\nWhy ConstructElement instead of just Construct?", "author": "bzbarsky@mit.edu", "id": 13220534, "time": "2018-04-20T05:04:13Z"}, {"text": "Comment on attachment 8968868\nPart 3 - remove deprecated showPopup method\n\ns/method's/methods'/ in the commit message.", "author": "bzbarsky@mit.edu", "id": 13220536, "time": "2018-04-20T05:07:31Z"}, {"text": "Comment on attachment 8968870\nPart 5 - add support for dictionary argument to openPopup as popup.xml#openPopup does\n\n>+  RefPtr<mozilla::dom::Event> triggerEvent = aTriggerEvent;\n\nDo you need the \"mozilla::dom::\" bit?\n\n>+  void openPopup(optional Element? anchorElement = null,\n>+                 optional StringOrOpenPopupOptions options,\n>                  long x,\n\nI don't believe this will let you call openPopup with 1 or 2 args...  Have you checked?\n\n>+      UNWRAP_OBJECT(Event, options.mTriggerEvent, triggerEvent);\n\nWhy isn't the triggerEvent in the dictionary just an \"Event? triggerEvent = null;\"?", "author": "bzbarsky@mit.edu", "id": 13220542, "time": "2018-04-20T05:16:07Z"}, {"text": "Comment on attachment 8968869\nPart 4 - remove now unused methods now that showPopup has been removed\n\nReview of attachment 8968869:\n-----------------------------------------------------------------\n\nThese look good to me. The code is in the XPToolkit module so you may want a rubberstamp from bz as well.", "author": "paolo.mozmail@amadzone.org", "id": 13220830, "time": "2018-04-20T08:58:43Z"}, {"text": "Comment on attachment 8968871\nPart 6 - support two special cases used in popup.xml\n\nReview of attachment 8968871:\n-----------------------------------------------------------------\n\n::: layout/xul/PopupBoxObject.cpp\n@@ +81,5 @@\n> +    // As a special case for popups that are menus when no anchor or position are\n> +    // specified, open the popup with ShowMenu instead of ShowPopup so that the\n> +    // popup is aligned with the menu.\n> +    if (!aAnchorElement && position.IsEmpty() && mContent && mContent->GetPrimaryFrame()) {\n> +      nsMenuFrame* menu = do_QueryFrame(mContent->GetPrimaryFrame()->GetParent());\n\nSo this is slightly different from the check in comment 11. Would this work when the parent is a button with type=\"menu\"? If this is the case or it actually doesn't matter, then this looks good to me. However, bz should probably take a look as well.\n\n@@ +92,2 @@\n>      nsCOMPtr<nsIContent> anchorContent(do_QueryInterface(aAnchorElement));\n>      pm->ShowPopup(mContent, anchorContent, position, aXPos, aYPos,\n\nSo mContent can be null here now?", "author": "paolo.mozmail@amadzone.org", "id": 13220856, "time": "2018-04-20T09:07:50Z"}, {"text": "Comment on attachment 8968874\nPart 7 - remove PopupBoxObject and replace with a nsXULElement subclass\n\nReview of attachment 8968874:\n-----------------------------------------------------------------\n\nr+ on the Toolkit code removal, but I have a comment on the class name checks.\n\n::: toolkit/modules/WindowDraggingUtils.jsm\n@@ +51,5 @@\n>      }\n>      return true;\n>    },\n>    isPanel() {\n> +    return ChromeUtils.getClassName(this._elem) == \"XULPopupElement\" &&\n\nCan we maybe check the element namespace instead?\n\nThere are other places that look for \"XULElement\", for example in devtools:\n\nhttps://dxr.mozilla.org/mozilla-central/rev/3cc613bf13443acc2fea4804872fb3ca56757181/devtools/server/actors/inspector/node.js#411\n\nAre we breaking these in some way for XUL panel elements now? This is interesting to know especially for when we start subclassing more elements.", "author": "paolo.mozmail@amadzone.org", "id": 13220884, "time": "2018-04-20T09:19:07Z"}, {"text": "Comment on attachment 8968875\nPart 8 - test changes\n\nReview of attachment 8968875:\n-----------------------------------------------------------------\n\nSome test changes may apply to code I've not reviewed. I'd actually move each test to the patch that requires it to be changed.", "author": "paolo.mozmail@amadzone.org", "id": 13220915, "time": "2018-04-20T09:24:10Z"}, {"text": "> Are we breaking these in some way for XUL panel elements now? \n\nYes.  You should switch them to checking namespace or using XULElement.isInstance().", "author": "bzbarsky@mit.edu", "id": 13221475, "time": "2018-04-20T14:27:01Z"}, {"text": "Comment on attachment 8968874\nPart 7 - remove PopupBoxObject and replace with a nsXULElement subclass\n\n>+++ b/dom/bindings/Bindings.conf\n>+    'nativeType': 'nsXULPopupElement',\n\nFor new things, please just give them the right name: mozilla::dom::XULPopupElement, defined in XULPopupElement.h, exported to mozilla/dom.  Then you wouldn't need to sprinkle \"mozilla::dom::\" all over the header, too.\n\n>+    'resultNotAddRefed': ['triggerNode', 'anchorNode'],\n\nThis is useless noise.  Looks like it landed in bug 979835 just a few days after bug 849567 made it useless noise...  Please just drop it.\n\nWhile you're here, want to remove the same annotation from BoxObject too?\n\n>+++ b/dom/webidl/XULPopupElement.webidl\n\nAh, now the args all become optional...  That should be in the previous patch.\n\n>+++ b/dom/xul/nsXULPopupElement.cpp\n\nThis should probably be called XULPopupElement.cpp given the suggested renaming of the header and class above.\n\n>+nsXULElement* NS_NewXULPopupElement(already_AddRefed<mozilla::dom::NodeInfo>&& aNodeInfo)\n\nLinebreak after return type, please.\n\n>+  nsCOMPtr<nsIContent> hold = this; // keep a reference\n\nPlease file a followup to annotate this MOZ_CAN_RUN_SCRIPT so we can remove this bit (because we'll know \"this\" is alive).  Also, this variable should be named kungFuDeathGrip, probably.\n\n>+  nsCOMPtr<nsIContent> anchorContent(do_QueryInterface(aAnchorElement));\n\nI know you just outdented existing code, but this QI (and the anchorContent thing in general) is not needed.  You can just pass aAnchorElement directly to MoveToAnchor.\n\n>+nsXULPopupElement::SizeTo(int32_t aWidth, int32_t aHeight)\n\nThe changes made here may not be safe.  What prevents the SetAttr calls from running script (via mutation events) and killing \"this\"?\n\nIt used to be OK because we held a stack strong ref to \"element\".  We should keep doing that with a kungFuDeathGrip for now, and annotate MOZ_CAN_RUN_SCRIPT in a followup.\n\n>+++ b/dom/xul/nsXULPopupElement.h\n>+nsXULElement* NS_NewXULPopupElement(already_AddRefed<mozilla::dom::NodeInfo>&& aNodeInfo);\n\nNewline after return type.\n\n>+  virtual JSObject* WrapNode(JSContext *aCx, JS::Handle<JSObject*> aGivenProto) override;\n\nPer code style, drop the \"virtual\".\n\nYou need to audit places that use the string \"XULElement\" in our code to see whether they should be testing for one of these two possible classes now.  This includes stuff using ChromeUtils.getClassName(), stuff using .class in devtools code, and things using ExtensionUtils.instanceOf.  Stuff using \"instanceof XULElement\" will keep working for now, I guess...\n\nr=me if the above issues are addressed.", "author": "bzbarsky@mit.edu", "id": 13222729, "time": "2018-04-20T22:26:11Z"}, {"text": "Comment on attachment 8968871\nPart 6 - support two special cases used in popup.xml\n\nr=me, though I have only middling confidence that I understand the popup/menu interactions here...", "author": "bzbarsky@mit.edu", "id": 13222737, "time": "2018-04-20T22:30:49Z"}, {"text": "> Why isn't the triggerEvent in the dictionary just an \"Event? triggerEvent =\n> null;\"?\n\nI tried that and got a error about OpenPopupOptions not being cycle collectable.", "author": "enndeakin@gmail.com", "id": 13226942, "time": "2018-04-23T16:29:28Z"}, {"text": "> I tried that and got a error about OpenPopupOptions not being cycle collectable.\n\nWhat was the exact error you got?  What was the stack to it?", "author": "bzbarsky@mit.edu", "id": 13226989, "time": "2018-04-23T16:39:50Z"}, {"text": "> What was the exact error you got?  What was the stack to it?\n\nThe error is at https://searchfox.org/mozilla-central/source/dom/bindings/Codegen.py#95\n\n 0:06.80   File \"/builds/working/dom/bindings/Codegen.py\", line 13783, in __init__\n 0:06.80     unlinkMethods, unionStructs) = UnionTypes(unionTypes, config)\n 0:06.80   File \"/builds/working/dom/bindings/Codegen.py\", line 1416, in UnionTypes\n 0:06.80     if idlTypeNeedsCycleCollection(t):\n 0:06.80   File \"/builds/working/dom/bindings/Codegen.py\", line 88, in idlTypeNeedsCycleCollection\n 0:06.80     return any(idlTypeNeedsCycleCollection(t) for t in type.flatMemberTypes)\n 0:06.80   File \"/builds/working/dom/bindings/Codegen.py\", line 88, in <genexpr>\n 0:06.80     return any(idlTypeNeedsCycleCollection(t) for t in type.flatMemberTypes)\n 0:06.80   File \"/builds/working/dom/bindings/Codegen.py\", line 95, in idlTypeNeedsCycleCollection\n 0:06.80     raise TypeError(\"Cycle collection for type %s is not supported\" % type)", "author": "enndeakin@gmail.com", "id": 13227025, "time": "2018-04-23T16:51:59Z"}, {"text": "Ah, because you're using the dictionary in a union, even though you never store the union anywhere that needs cycle collection...\n\nI filed bug 1456261 on making that work.  Patch should be up in a few minutes.", "author": "bzbarsky@mit.edu", "id": 13227748, "time": "2018-04-23T20:49:59Z"}, {"text": "Created attachment 8970844\nPart 5.2 - add support for dictionary argument to openPopup as popup.xml#openPopup does", "author": "enndeakin@gmail.com", "id": 13232169, "time": "2018-04-25T10:58:39Z"}, {"text": "Comment on attachment 8970844\nPart 5.2 - add support for dictionary argument to openPopup as popup.xml#openPopup does\n\nr=me.  Thank you!", "author": "bzbarsky@mit.edu", "id": 13234014, "time": "2018-04-25T22:56:01Z"}, {"text": "Created attachment 8971220\nFixes devtools cases\n\nThis is to get the devtools cases to work, although it is unclear when this check would be done.\n\nOther cases where XULElement is checked are never popups/panels.", "author": "enndeakin@gmail.com", "id": 13235482, "time": "2018-04-26T14:47:29Z"}, {"text": "Comment on attachment 8971220\nFixes devtools cases\n\nReview of attachment 8971220:\n-----------------------------------------------------------------\n\nUp to you whether you want to address the nits.\n\n::: devtools/server/actors/inspector/node.js\n@@ +407,5 @@\n>      let type = listener.type || \"\";\n>      let url = \"\";\n>  \n>      // If the listener is an object with a 'handleEvent' method, use that.\n> +    if (listenerDO.class === \"Object\" || listenerDO.class.match(/^XUL\\w*Element$/)) {\n\nNIT:\n\nif (listenerDO.class === \"Object\" || /^XUL\\w*Element$/.test(listenerDO.class)) {\n\nWould be slightly more performant.\n\n::: devtools/server/actors/thread.js\n@@ +1150,5 @@\n>          }\n>          // Get the Debugger.Object for the listener object.\n>          let listenerDO = this.globalDebugObject.makeDebuggeeValue(listener);\n>          // If the listener is an object with a 'handleEvent' method, use that.\n> +        if (listenerDO.class == \"Object\" || listenerDO.class.match(/^XUL\\wElement$/)) {\n\nNIT:\n \nif (listenerDO.class === \"Object\" || /^XUL\\w*Element$/.test(listenerDO.class)) {\n \nWould be slightly more performant.", "author": "mratcliffe@mozilla.com", "id": 13236016, "time": "2018-04-26T16:52:06Z"}, {"text": "Pushed by neil@mozilla.com:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/e872787876a5\nremove obsolete calls to showPopup and replace usages of the popup box object with the same methods defined on popups, r=paolo\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/5be83a2594fb\nrestructuring to allow nsXULElement to be subclassed. Rename nsXULElement::Create to make it clearer it creates from the prototype element, r=bz\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/5659ad69e145\nremove deprecated showPopup method of PopupBoxObject as well as unused GetPopupSetFrame method, and move some methods' positions to group related methods together better, r=paolo,bz\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/962c081b1314\nremove unused popup frame methods now that showPopup has been removed, r=paolo\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/46d7f3cc7102\nadd dictionary second argument directly to PopupBoxObject::OpenPopup as supported in popup.xml#openPopup, r=bz\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/12e768652a88\nadd two special cases in PopupBoxObject as supported in popup.xml, r=paolo,bz\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/19b49df2389f\nmove PopupBoxObject to XULPopupElement, a new subclass of XULElement. Remove popup.xml methods, r=paolo,bz", "author": "pulsebot@bots.tld", "id": 13238417, "time": "2018-04-27T15:18:03Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/e872787876a5\nhttps://hg.mozilla.org/mozilla-central/rev/5be83a2594fb\nhttps://hg.mozilla.org/mozilla-central/rev/5659ad69e145\nhttps://hg.mozilla.org/mozilla-central/rev/962c081b1314\nhttps://hg.mozilla.org/mozilla-central/rev/46d7f3cc7102\nhttps://hg.mozilla.org/mozilla-central/rev/12e768652a88\nhttps://hg.mozilla.org/mozilla-central/rev/19b49df2389f", "author": "apavel@mozilla.com", "id": 13239954, "time": "2018-04-28T17:33:26Z"}], "id": 1446961, "priority": "P5", "cc": ["bgrinstead@mozilla.com", "bzbarsky@mit.edu", "dao+bmo@mozilla.com", "gijskruitbosch+bugs@gmail.com", "mratcliffe@mozilla.com", "paolo.mozmail@amadzone.org", "philipp@bugzilla.kewis.ch", "timdream@gmail.com"], "cf_crash_signature": "", "version": "unspecified", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": ["https://bugzilla.mozilla.org/show_bug.cgi?id=1437638", "https://bugzilla.mozilla.org/show_bug.cgi?id=1430028"], "cf_tracking_thunderbird_esr60": "---", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1397874, 1397876], "qa_contact": "", "creation_time": "2018-03-19T13:22:46Z", "cf_status_firefox_esr52": "---", "component": "XUL", "assigned_to_detail": {"email": "enndeakin@gmail.com", "id": 6102, "name": "enndeakin@gmail.com", "real_name": "Neil Deakin"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "fixed", "cf_status_firefox60": "---", "target_milestone": "mozilla61", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "enndeakin@gmail.com", "id": 6102, "name": "enndeakin@gmail.com", "real_name": "Neil Deakin"}, "whiteboard": "", "mentors": [], "summary": "Replace popup boxobject properties with element methods", "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-05-15T18:35:25Z", "assigned_to": "enndeakin@gmail.com", "is_open": false, "history": [{"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "enndeakin@gmail.com"}], "who": "enndeakin@gmail.com", "when": "2018-03-19T13:23:56Z"}, {"changes": [{"removed": "Try replacing panel boxobject properties with element methods", "field_name": "summary", "added": "Try replacing popup boxobject properties with element methods"}], "who": "enndeakin@gmail.com", "when": "2018-03-19T17:23:16Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "bgrinstead@mozilla.com"}], "who": "bgrinstead@mozilla.com", "when": "2018-03-19T17:40:47Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1397874"}], "who": "bgrinstead@mozilla.com", "when": "2018-03-19T17:41:44Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1437638"}], "who": "bgrinstead@mozilla.com", "when": "2018-03-19T17:42:05Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "philipp@bugzilla.kewis.ch"}], "who": "philipp@bugzilla.kewis.ch", "when": "2018-03-19T18:55:57Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1397876"}], "who": "bgrinstead@mozilla.com", "when": "2018-03-19T20:03:31Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "gijskruitbosch+bugs@gmail.com"}], "who": "gijskruitbosch+bugs@gmail.com", "when": "2018-03-20T13:54:53Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8960141, "added": "1"}, {"removed": "", "field_name": "cc", "added": "paolo.mozmail@amadzone.org"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8965007, "added": "review?(paolo.mozmail@amadzone.org)"}], "who": "enndeakin@gmail.com", "when": "2018-04-04T18:01:49Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1430028"}], "who": "bgrinstead@mozilla.com", "when": "2018-04-04T18:10:16Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8960143, "added": "1"}, {"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8960144, "added": "1"}], "who": "enndeakin@gmail.com", "when": "2018-04-04T18:12:03Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(enndeakin@gmail.com)"}], "who": "paolo.mozmail@amadzone.org", "when": "2018-04-04T18:38:03Z"}, {"changes": [{"removed": "needinfo?(enndeakin@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "enndeakin@gmail.com", "when": "2018-04-04T18:46:58Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(enndeakin@gmail.com)"}], "who": "paolo.mozmail@amadzone.org", "when": "2018-04-04T19:15:01Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "dao+bmo@mozilla.com"}, {"removed": "", "field_name": "depends_on", "added": "1445912"}], "who": "dao+bmo@mozilla.com", "when": "2018-04-05T12:17:30Z"}, {"changes": [{"removed": "needinfo?(enndeakin@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "enndeakin@gmail.com", "when": "2018-04-05T15:47:50Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(paolo.mozmail@amadzone.org)", "attachment_id": 8965007, "added": "review+"}], "who": "paolo.mozmail@amadzone.org", "when": "2018-04-05T16:08:22Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(gijskruitbosch+bugs@gmail.com)"}], "who": "enndeakin@gmail.com", "when": "2018-04-10T13:17:12Z"}, {"changes": [{"removed": "needinfo?(gijskruitbosch+bugs@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "gijskruitbosch+bugs@gmail.com", "when": "2018-04-10T13:52:32Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8960146, "added": "1"}, {"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8965013, "added": "1"}, {"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8965014, "added": "1"}], "who": "enndeakin@gmail.com", "when": "2018-04-18T13:02:20Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "bzbarsky@mit.edu"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8968867, "added": "review?(bzbarsky@mit.edu)"}], "who": "enndeakin@gmail.com", "when": "2018-04-19T13:51:47Z"}, {"changes": [{"field_name": "attachments.ispatch", "removed": "0", "attachment_id": 8968868, "added": "1"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8968868, "added": "review?(paolo.mozmail@amadzone.org)"}], "who": "enndeakin@gmail.com", "when": "2018-04-19T13:52:39Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8968868, "added": "review?(bzbarsky@mit.edu)"}], "who": "enndeakin@gmail.com", "when": "2018-04-19T13:53:06Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8968869, "added": "review?(paolo.mozmail@amadzone.org)"}], "who": "enndeakin@gmail.com", "when": "2018-04-19T13:53:26Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8968870, "added": "review?(bzbarsky@mit.edu)"}], "who": "enndeakin@gmail.com", "when": "2018-04-19T13:54:13Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8968871, "added": "review?(paolo.mozmail@amadzone.org)"}], "who": "enndeakin@gmail.com", "when": "2018-04-19T13:54:48Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8968875, "added": "review?(paolo.mozmail@amadzone.org)"}], "who": "enndeakin@gmail.com", "when": "2018-04-19T13:55:05Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8968874, "added": "review?(paolo.mozmail@amadzone.org)"}], "who": "enndeakin@gmail.com", "when": "2018-04-19T13:56:00Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8968874, "added": "review?(bzbarsky@mit.edu)"}], "who": "enndeakin@gmail.com", "when": "2018-04-19T13:56:53Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P5"}], "who": "enndeakin@gmail.com", "when": "2018-04-19T14:40:54Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bzbarsky@mit.edu)", "attachment_id": 8968867, "added": "review+"}], "who": "bzbarsky@mit.edu", "when": "2018-04-20T05:04:13Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bzbarsky@mit.edu)", "attachment_id": 8968868, "added": "review+"}], "who": "bzbarsky@mit.edu", "when": "2018-04-20T05:07:31Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bzbarsky@mit.edu)", "attachment_id": 8968870, "added": "review-"}], "who": "bzbarsky@mit.edu", "when": "2018-04-20T05:16:07Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(paolo.mozmail@amadzone.org)", "attachment_id": 8968868, "added": "review+"}], "who": "paolo.mozmail@amadzone.org", "when": "2018-04-20T08:48:53Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(paolo.mozmail@amadzone.org)", "attachment_id": 8968869, "added": "review+"}], "who": "paolo.mozmail@amadzone.org", "when": "2018-04-20T08:58:43Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(paolo.mozmail@amadzone.org)", "attachment_id": 8968871, "added": "review?(bzbarsky@mit.edu)"}], "who": "paolo.mozmail@amadzone.org", "when": "2018-04-20T09:07:50Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(paolo.mozmail@amadzone.org)", "attachment_id": 8968874, "added": ""}], "who": "paolo.mozmail@amadzone.org", "when": "2018-04-20T09:19:07Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(paolo.mozmail@amadzone.org)", "attachment_id": 8968875, "added": ""}], "who": "paolo.mozmail@amadzone.org", "when": "2018-04-20T09:24:10Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bzbarsky@mit.edu)", "attachment_id": 8968874, "added": "review+"}], "who": "bzbarsky@mit.edu", "when": "2018-04-20T22:26:11Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bzbarsky@mit.edu)", "attachment_id": 8968871, "added": "review+"}], "who": "bzbarsky@mit.edu", "when": "2018-04-20T22:30:49Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(enndeakin@gmail.com)"}], "who": "bzbarsky@mit.edu", "when": "2018-04-23T16:39:50Z"}, {"changes": [{"removed": "needinfo?(enndeakin@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "enndeakin@gmail.com", "when": "2018-04-23T16:51:59Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8968870, "added": "1"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8970844, "added": "review?(bzbarsky@mit.edu)"}], "who": "enndeakin@gmail.com", "when": "2018-04-25T10:58:39Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bzbarsky@mit.edu)", "attachment_id": 8970844, "added": "review+"}], "who": "bzbarsky@mit.edu", "when": "2018-04-25T22:56:01Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mratcliffe@mozilla.com"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8971220, "added": "review?(mratcliffe@mozilla.com)"}], "who": "enndeakin@gmail.com", "when": "2018-04-26T14:47:29Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(mratcliffe@mozilla.com)", "attachment_id": 8971220, "added": "review+"}], "who": "mratcliffe@mozilla.com", "when": "2018-04-26T16:52:06Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla61"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-04-28 17:33:26"}, {"removed": "---", "field_name": "cf_status_firefox61", "added": "fixed"}], "who": "apavel@mozilla.com", "when": "2018-04-28T17:33:26Z"}, {"changes": [{"removed": "Try replacing popup boxobject properties with element methods", "field_name": "summary", "added": "Replace popup boxobject properties with element methods"}], "who": "dao+bmo@mozilla.com", "when": "2018-04-28T19:57:04Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1457763"}], "who": "jan@ikenmeyer.eu", "when": "2018-04-29T12:32:40Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1458025"}], "who": "aryx.bugmail@gmx-topmail.de", "when": "2018-05-01T21:30:45Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "timdream@gmail.com"}], "who": "timdream@gmail.com", "when": "2018-05-15T18:35:25Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}