{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "ted@mielczarek.org", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2016-04-05T09:36:43Z", "type_id": 4, "creation_date": "2016-03-30T12:05:22Z", "id": 1368673, "setter": "mh+mozilla@glandium.org"}], "content_type": "text/x-review-board-request", "id": 8731305}], "classification": "Components", "creator": "ted@mielczarek.org", "cc": ["arpad.borsos@googlemail.com", "ehsan@mozilla.com", "gandalf@aviary.pl", "gps@mozilla.com", "jmuizelaar@mozilla.com", "jwalden+bmo@mit.edu", "mh+mozilla@glandium.org", "Ms2ger@gmail.com", "mshal@mozilla.com", "nfroyd@mozilla.com", "spectre@floodgap.com", "srl@icu-project.org", "steve@ssinger.info", "xidorn+moz@upsuper.org"], "depends_on": [1264836, 1247396, 1257689, 1259753, 1262231, 1262385, 1262492, 1262636, 1262731, 1263325, 1269262, 1290336], "creation_time": "2016-01-12T21:03:11Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "Stop using ICU's autoconf build system", "cf_last_resolved": "2016-04-06T10:05:25Z", "assigned_to_detail": {"email": "ted@mielczarek.org", "id": 39022, "name": "ted@mielczarek.org", "real_name": "Ted Mielczarek [:ted.mielczarek]"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "comments": [{"text": "ICU's build system is terrible:\n* It's not parallel-safe, so we have to build with -j1.\n* For cross-compiles we build a host and a target version to build some tools for managing ICU data files.\n* Invoking extra configure files adds to our build time, especially on Windows.\n\nWe should replace it with something else. Chromium has GYP files:\nhttps://chromium.googlesource.com/chromium/deps/icu/+/42c58d4e49f2250039f0e98d43e0b76e8f5ca024/icu.gyp\n\n...but they're also transitioning to GN files, so the GYP files are likely to become unmaintained at some point:\nhttps://chromium.googlesource.com/chromium/deps/icu/+/42c58d4e49f2250039f0e98d43e0b76e8f5ca024/BUILD.gn\n\nI looked into the data file issue, and it turns out that if we are willing to commit the (~10MB, gzips to ~3MB) icudt.dat file to our tree we don't need the host build at all:\nhttp://userguide.icu-project.org/howtouseicu#TOC-C-With-Your-Own-Build-System\nhttp://userguide.icu-project.org/icudata\n\nThis would also let us fix bug 926980.", "author": "ted@mielczarek.org", "id": 11069972, "time": "2016-01-12T21:03:11Z"}, {"text": "glandium rightly suggested that a good first step would be to fix bug 926980.", "author": "ted@mielczarek.org", "id": 11072126, "time": "2016-01-13T12:30:22Z"}, {"text": "Daniel Bratell (from Opera) linked me to a patch set he wrote to do the data generation via gyp:\nhttps://codereview.chromium.org/1000163003/\n\nThis might be a viable path forward.", "author": "ted@mielczarek.org", "id": 11072438, "time": "2016-01-13T14:40:18Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=38c4a3fd7b3a", "author": "ted@mielczarek.org", "id": 11129267, "time": "2016-02-02T14:12:37Z"}, {"text": "That try push contains my WIP:\nhttps://hg.mozilla.org/try/rev/38c4a3fd7b3a\n\nIt doesn't handle generating the data file, instead I just have an extra commit that adds it to the srcdir for now:\nhttps://hg.mozilla.org/try/rev/4760038147e6\n\nThis built OK locally on Linux/Mac/Win.", "author": "ted@mielczarek.org", "id": 11129271, "time": "2016-02-02T14:14:04Z"}, {"text": "After talking with gps and Waldo on IRC I decided we're just going to commit the generated data file to the source tree. I'll change the update-icu script to do a local ICU build with configure+make to generate a new data file when updating to a new ICU.\n\nCurrently we're wasting developer CPU cycles rebuilding this data file for every clobber build when it only actually changes with every ICU update.", "author": "ted@mielczarek.org", "id": 11151528, "time": "2016-02-09T20:48:26Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=04250588854d", "author": "ted@mielczarek.org", "id": 11159029, "time": "2016-02-11T20:39:15Z"}, {"text": "Patch is getting closer to finished, I was able to remove the hacky bits in the JS shell from bug 926980.", "author": "ted@mielczarek.org", "id": 11159034, "time": "2016-02-11T20:40:07Z"}, {"text": "That try push burned most platforms because I forgot to include `ALLOW_COMPILER_WARNINGS = True`, and it broke Android because Android doesn't build ICU by default and I unconditionally included USE_LIBS for it.", "author": "ted@mielczarek.org", "id": 11160713, "time": "2016-02-12T11:53:46Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=dfa046d581d1", "author": "ted@mielczarek.org", "id": 11162573, "time": "2016-02-12T21:05:55Z"}, {"text": "Created attachment 8731305\nMozReview Request: bug 1239083 - use moz.build files to build ICU. r?glandium,waldo\n\nStop invoking ICU's autoconf build system. Instead, have hand-authored\nmoz.build files under config/external/icu to build what we need. In addition,\nwe'll commit a pre-built copy of the ICU data file (currently icudt56l.dat)\nunder config/external/icu/data to avoid having to build ICU host tools to\ngenerate it. config/external/icu/data also contains some assembly files\nwhich can generate an object file containing the ICU data file contents\nso that the JS shell (or standalone JS builds) can be linked directly to\nthe data without having to deal with the external data file. This requires\nyasm or GNU as.\n\nThe update-icu.sh script has been modified to read the list of C/C++ source\nfiles out of the ICU Makefiles and update `sources.mozbuild` files under\nconfig/external/icu, as well as build a local copy of ICU using its\nautoconf build system to generate the ICU data file to be committed in-tree.\n\nReview commit: https://reviewboard.mozilla.org/r/40483/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/40483/", "author": "ted@mielczarek.org", "id": 11252164, "time": "2016-03-16T16:24:07Z"}, {"text": "Waldo: this patch should address your concerns from bug 926980. It undoes all of the JS shell/jit-test code changes by using some assembly to link the ICU data directly into the JS shell and related programs, as well as libmozjs when doing a standalone JS build. I think these two patches are complicated enough to keep them separate, so consider the awfulness in the previous patch as merely a band-aid to ensure that that commit is usable by itself. I intend to land both commits together, so we shouldn't actually have that badness present in the tree at any time.\n\nglandium: this patch is ready for review, but not quite ready to land. The last known issue I have is that I made icu.m4 check for yasm or GNU as to ensure we can build the assembly files, but that gets invoked from the JS subconfigure, which doesn't have the yasm checks like the top-level configure. This builds on Linux currently because $GNU_AS is true, but it fails on Mac/Win. My plan is to put patches in my stack right before this one that move all the yasm checks into pyconfigure and also move all of icu.m4 to pyconfigure, and then share the yasm checks with js/src/configure (probably overkill to solve this specific problem, but it moves us closer to that goal as well).", "author": "ted@mielczarek.org", "id": 11252185, "time": "2016-03-16T16:30:02Z"}, {"text": "(In reply to Ted Mielczarek [:ted.mielczarek] from comment #11)\n> My plan is to put patches in my stack right before this\n> one that move all the yasm checks into pyconfigure and also move all of\n> icu.m4 to pyconfigure, and then share the yasm checks with js/src/configure\n> (probably overkill to solve this specific problem, but it moves us closer to\n> that goal as well).\n\nYou should avoid moving icu.m4 to pyconfigure before this here lands, because it's complex to get the subconfigure invocations right. You can however move the yasm check and make its result available to both old-configure and js/src/old-configure, that'd be way simpler.", "author": "mh+mozilla@glandium.org", "id": 11253892, "time": "2016-03-17T00:23:04Z"}, {"text": "Comment on attachment 8731305\nMozReview Request: bug 1239083 - use moz.build files to build ICU. r?glandium,waldo\n\nhttps://reviewboard.mozilla.org/r/40483/#review38421\n\nI'll need to do another pass. At this point, I'm not sure what you gain from having this separate from bug 926980\n\n::: build/autoconf/icu.m4:82\n(Diff revision 1)\n>      MOZ_ICU_VERSION=\"$version\"\n>  \n> -    AC_SUBST(MOZ_ICU_VERSION)\n> -\n> -    if test -z \"$MOZ_SYSTEM_ICU\"; then\n> -        case \"$OS_TARGET\" in\n> +    #TODO: the l is actually endian-dependent, but we don't currently\n> +    # have an endianness check in configure. If someone adds one,\n> +    # we could make this set as 'l' or 'b' for little or big, respectively.\n> +    ICU_DATA_FILE=\"icudt${version}l.dat\"\n\nI think we shouldn't have a version for the file in tree for two reasons:\n- it will allow version control to display a log of the file updates in a straightforward matter (not having to realize that you need to use the directory because the file is different every time it is updated)\n- it possibly allows version control to better store the data (I don't know if mercurial does binary diffs between revisions of binary files, but git certainly does)\n\n::: config/external/icu/common/moz.build:26\n(Diff revision 1)\n> +#FIXME: should probably stop including mozilla-config.h\n> +DEFINES['LOCALE_SNAME'] = 0x5c\n> +\n> +LOCAL_INCLUDES += CONFIG['MOZ_ICU_INCLUDES']\n> +\n> +include('/config/external/icu/defs.mozbuild')\n\n../defs.mozbuild\n\n::: config/external/icu/data/icudata_gas.S:9\n(Diff revision 1)\n> +\n> +.global ICU_DATA_SYMBOL\n> +.data\n> +.balign 16\n> +ICU_DATA_SYMBOL:\n> +        .incbin ICU_DATA_FILE\n\nYou need the GNU-stack thing in this file too. The syntax is different, though.\n\n::: config/external/icu/defs.mozbuild:8\n(Diff revision 1)\n> +    U_USING_ICU_NAMESPACE = 0,\n> +    U_NO_DEFAULT_INCLUDE_UTF_HEADERS = 1,\n> +    UCONFIG_NO_LEGACY_CONVERSION = True,\n> +    UCONFIG_NO_TRANSLITERATION = True,\n> +    UCONFIG_NO_REGULAR_EXPRESSIONS = True,\n> +    UCONFIG_NO_BREAK_ITERATION = True,\n> +    U_CHARSET_IS_UTF8 = True,\n\nCan you add the corresponding comments from icu.m4?\n\n::: config/external/icu/defs.mozbuild:23\n(Diff revision 1)\n> +\n> +# ICU requires RTTI\n> +if CONFIG['GNU_CXX']:\n> +    CXXFLAGS += ['-frtti']\n> +elif CONFIG['OS_TARGET'] == 'WINNT':\n> +    CXXFLAGS += ['-GR']\n\ndoes MSVC do the right thing when fed with both -GR- and -GR?\n\n::: intl/update-icu.sh:75\n(Diff revision 1)\n> -hg addremove ${icu_dir}\n> +\n> +hg addremove ${icu_dir} ${topsrcdir}/config/external/icu\n> +\n> +# Update our moz.build files in config/external/icu, and\n> +# build a new ICU data file.\n> +python `dirname $0`/icu_sources_data.py $topsrcdir\n\nYou want this before hg addremove", "author": "mh+mozilla@glandium.org", "id": 11270309, "time": "2016-03-23T09:48:07Z"}, {"text": "https://reviewboard.mozilla.org/r/40483/#review38421\n\nI wrote that patch first because I wanted to try to split the work up because they're both pretty involved, but you're right, it doesn't buy us much in terms of the implementation. Would you like me to just squash the two patches and see what the combined diff looks like? Alternately, I could break the patch from that bug down into just the bits that don't get reverted by this patch, which means it would not be buildable standalone, but might make both of them more easily reviewable, and I could squash them on landing.\n\n> I think we shouldn't have a version for the file in tree for two reasons:\n> - it will allow version control to display a log of the file updates in a straightforward matter (not having to realize that you need to use the directory because the file is different every time it is updated)\n> - it possibly allows version control to better store the data (I don't know if mercurial does binary diffs between revisions of binary files, but git certainly does)\n\nSo, if we want to use `u_setDataDirectory`, we need to have the version number in the filename, because that's how ICU looks for it. That means we'd either have to grow a moz.build capability to rename files in `FINAL_TARGET_FILES` to put the version number in there, or we'd have to switch to reading the whole .dat file on startup and using `udata_setCommonData` http://icu-project.org/apiref/icu4c/udata_8h.html#a467bda719595adb58f959dde735e1153 .\n\nThoughts? (I'm pretty sure gps has said that hg doesn't do binary diffs.)\n\n> does MSVC do the right thing when fed with both -GR- and -GR?\n\nI'm not entirely sure, but this does build on Windows. I will check.", "author": "ted@mielczarek.org", "id": 11270369, "time": "2016-03-23T10:04:28Z"}, {"text": "I think I'd rather try to review a squashed patch.", "author": "mh+mozilla@glandium.org", "id": 11270477, "time": "2016-03-23T10:58:42Z"}, {"text": "Comment on attachment 8731305\nMozReview Request: bug 1239083 - use moz.build files to build ICU. r?glandium,waldo\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/40483/diff/1-2/", "author": "ted@mielczarek.org", "id": 11271438, "time": "2016-03-23T16:36:18Z"}, {"text": "I squashed this patch with the one from bug 926980, and fixed all the review comments except for the version number in the .dat filename, and checking whether MSVC does the right thing with -GR- -GR.", "author": "ted@mielczarek.org", "id": 11271447, "time": "2016-03-23T16:37:11Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=99c1d6087a2c", "author": "ted@mielczarek.org", "id": 11272429, "time": "2016-03-23T20:09:38Z"}, {"text": "The try results are mostly OK, except cppunittests are busted on Mac/Windows, failing to JS_Init presumably because the icu data file isn't packaged with cppunittests.\n\nPart of this is because of course we have C++ unittests that init xpcom without using the test harness helpers:\nhttps://dxr.mozilla.org/mozilla-central/source/security/manager/ssl/tests/compiled/TestCertDB.cpp#15", "author": "ted@mielczarek.org", "id": 11274529, "time": "2016-03-24T13:48:04Z"}, {"text": "https://dxr.mozilla.org/mozilla-central/rev/6202ade0e6d688ffb67932398e56cfc6fa04ceb3/security/manager/ssl/tests/compiled/TestCertDB.cpp#15\nhttps://dxr.mozilla.org/mozilla-central/rev/6202ade0e6d688ffb67932398e56cfc6fa04ceb3/netwerk/test/TestCookie.cpp#189", "author": "ted@mielczarek.org", "id": 11274532, "time": "2016-03-24T13:49:40Z"}, {"text": "https://dxr.mozilla.org/mozilla-central/rev/6202ade0e6d688ffb67932398e56cfc6fa04ceb3/xpcom/tests/TestTArray.cpp#1197", "author": "ted@mielczarek.org", "id": 11274538, "time": "2016-03-24T13:50:42Z"}, {"text": "Pushed with another change to make those tests use ScopedXPCOM:\nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=6e9cd92bb1d4", "author": "ted@mielczarek.org", "id": 11277489, "time": "2016-03-25T14:06:57Z"}, {"text": "(Everything else on that Try push looked OK except the cppunittests.)", "author": "ted@mielczarek.org", "id": 11277490, "time": "2016-03-25T14:07:18Z"}, {"text": "Comment on attachment 8731305\nMozReview Request: bug 1239083 - use moz.build files to build ICU. r?glandium,waldo\n\nhttps://reviewboard.mozilla.org/r/40483/#review39025\n\nOne pass for the nits. I'll need one last pass.\n\n::: build/autoconf/icu.m4:85\n(Diff revision 2)\n> -\n> -    if test -z \"$MOZ_SYSTEM_ICU\"; then\n> -        case \"$OS_TARGET\" in\n> -            WINNT)\n> -                ICU_LIB_NAMES=\"icuin icuuc\"\n> -                ICU_DATA_LIB=icudt\n> +    # have an endianness check in configure. If someone adds one,\n> +    # we could make this set as 'l' or 'b' for little or big, respectively.\n> +    ICU_DATA_FILE=\"icudt${version}l.dat\"\n> +\n> +    dnl We won't build ICU data as a separate file when building\n> +    dnl JS standalone so that embeddors don't have to deal with it.\n\ntypo: embedders\n\n::: build/autoconf/icu.m4:87\n(Diff revision 2)\n> -        case \"$OS_TARGET\" in\n> -            WINNT)\n> -                ICU_LIB_NAMES=\"icuin icuuc\"\n> -                ICU_DATA_LIB=icudt\n> -                MOZ_ICU_DBG_SUFFIX=\n> -                if test -n \"$MOZ_DEBUG\" -a -z \"$MOZ_NO_DEBUG_RTL\"; then\n> +    ICU_DATA_FILE=\"icudt${version}l.dat\"\n> +\n> +    dnl We won't build ICU data as a separate file when building\n> +    dnl JS standalone so that embeddors don't have to deal with it.\n> +    if test -z \"$JS_STANDALONE\" -a -z \"$MOZ_SYSTEM_ICU\"; then\n> +        MOZ_ICU_DATA_ARCHIVE=1\n\nyou should explicitly set it to nothing in the other case\n\n::: config/external/icu/data/icudata.s:11\n(Diff revision 2)\n> +    %define DATA_SYMBOL _ %+ ICU_DATA_SYMBOL\n> +%else\n> +    %define DATA_SYMBOL ICU_DATA_SYMBOL\n> +%endif\n> +\n> +%define FORMAT_ELF 0\n\nI'd put that in a %else\n\n::: config/external/icu/data/moz.build:22\n(Diff revision 2)\n> +    '-DICU_DATA_FILE=\"' + CONFIG['ICU_DATA_FILE'] + '\"',\n> +    '-DICU_DATA_SYMBOL=icudt' + CONFIG['MOZ_ICU_VERSION'] + '_dat',\n\nUse %s\n\n::: intl/icu_sources_data.py:29\n(Diff revision 2)\n> +    base = os.path.splitext(filename)[0]\n> +    for ext in ('.cpp', '.c'):\n> +        f = os.path.join(dir, base + ext)\n> +        if os.path.isfile(f):\n> +            return f\n> +    raise Exception('Couldn\\'t find source file for: %s' % filename)\n\nYou might as well use double quotes to avoid the escaping.", "author": "mh+mozilla@glandium.org", "id": 11278865, "time": "2016-03-25T22:42:33Z"}, {"text": "https://reviewboard.mozilla.org/r/40483/#review39025\n\n> I'd put that in a %else\n\nI cargo-culted this all from some media code, but OK.\n\n> Use %s\n\nI definitely wish I could use DEFINES here, but I didn't want to open that can of worms. (I've got enough worms from this patch series already.)", "author": "ted@mielczarek.org", "id": 11287475, "time": "2016-03-30T10:42:40Z"}, {"text": "https://reviewboard.mozilla.org/r/40483/#review38421\n\n> So, if we want to use `u_setDataDirectory`, we need to have the version number in the filename, because that's how ICU looks for it. That means we'd either have to grow a moz.build capability to rename files in `FINAL_TARGET_FILES` to put the version number in there, or we'd have to switch to reading the whole .dat file on startup and using `udata_setCommonData` http://icu-project.org/apiref/icu4c/udata_8h.html#a467bda719595adb58f959dde735e1153 .\n> \n> Thoughts? (I'm pretty sure gps has said that hg doesn't do binary diffs.)\n\nStill looking for feedback on whether you really want this changed.", "author": "ted@mielczarek.org", "id": 11287486, "time": "2016-03-30T10:48:24Z"}, {"text": "Comment on attachment 8731305\nMozReview Request: bug 1239083 - use moz.build files to build ICU. r?glandium,waldo\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/40483/diff/2-3/", "author": "ted@mielczarek.org", "id": 11287625, "time": "2016-03-30T12:05:22Z"}, {"text": "Comment on attachment 8731305\nMozReview Request: bug 1239083 - use moz.build files to build ICU. r?glandium,waldo\n\nhttps://reviewboard.mozilla.org/r/40483/#review40883\n\nThis is an r+, assuming the comments don't expose some deep-seated issue.  But I dunno if autoland or something won't go to town on this if I mark \"Ship It\" or fail to \"Open an Issue\" for the little nitpicks in it.  Scumbag mozreview UI.  :-)\n\n::: build/autoconf/icu.m4:79\n(Diff revision 3)\n>      if test x\"$version\" = x; then\n>         AC_MSG_ERROR([cannot determine icu version number from uvernum.h header file $lineno])\n>      fi\n>      MOZ_ICU_VERSION=\"$version\"\n>  \n> -    AC_SUBST(MOZ_ICU_VERSION)\n> +    #TODO: the l is actually endian-dependent, but we don't currently\n\nSpace before TODO.\n\n::: config/external/icu/data/moz.build:12\n(Diff revision 3)\n> +if CONFIG['MOZ_ICU_DATA_ARCHIVE']:\n> +    # Copy the pre-built ICU data file to dist/bin.\n> +    FINAL_TARGET_FILES += [CONFIG['ICU_DATA_FILE']]\n> +\n> +# Build a library containing the ICU data for use in the JS shell, so that\n> +# JSAPI consumers don't have to deal with setting ICU's data path.\n\n\\o/\n\n::: config/external/icu/defs.mozbuild:9\n(Diff revision 3)\n> +# License, v. 2.0. If a copy of the MPL was not distributed with this\n> +# file, You can obtain one at http://mozilla.org/MPL/2.0/.\n> +\n> +DEFINES.update(\n> +    # Don't use icu namespace automatically in client code.\n> +    U_USING_ICU_NAMESPACE = 0,\n\nLet's add blank lines between the separate argument-blocks here -- so one after the ICU_NAMESPACE line, one after the UTF_HEADERS line, one after ITERATION.\n\n::: config/external/icu/i18n/sources.mozbuild:3\n(Diff revision 3)\n> +# -*- Mode: python; c-basic-offset: 4; indent-tabs-mode: nil; tab-width: 40 -*-\n> +# vim: set filetype=python:\n> +# THIS FILE IS GENERATED BY /intl/icusources.py DO NOT EDIT\n\nWe have intl/icu/source for imported stuffs, so I wonder if we should move some of this ICU-relevant stuff into intl/icu, out of intl/ or intl/icu-patches.  Maybe sometime.\n\n::: intl/icu_sources_data.py:51\n(Diff revision 3)\n> +    with open(mozbuild, 'wb') as f:\n> +        f.write(('# -*- Mode: python; c-basic-offset: 4; ' +\n> +                 'indent-tabs-mode: nil; tab-width: 40 -*-'))\n> +        f.write('''\n> +# vim: set filetype=python:\n> +# THIS FILE IS GENERATED BY /intl/icusources.py DO NOT EDIT\n\nThis file name is wrong.\n\n::: js/src/moz.build:622\n(Diff revision 3)\n>  \n>  if CONFIG['ENABLE_INTL_API']:\n> +    if not CONFIG['MOZ_ICU_DATA_ARCHIVE']:\n> -    USE_LIBS += [\n> +        USE_LIBS += [\n> -        'icu',\n> +            'icu',\n> -    ]\n> +        ]\n\nEr, are those >>>> really in the patch, or is this reviewboard being unhelpful/misleading?\n\n::: js/src/shell/moz.build:40\n(Diff revision 3)\n>  \n>  OS_LIBS += CONFIG['EDITLINE_LIBS']\n>  OS_LIBS += CONFIG['MOZ_ZLIB_LIBS']\n>  \n> +if CONFIG['ENABLE_INTL_API'] and CONFIG['MOZ_ICU_DATA_ARCHIVE']:\n> +    # The ICU libraries linked into libjs will not include the ICU data,\n\nIf memory serves, we don't ship libjs, we ship libmozjs -- s/libjs/libmozjs/g on all your changes, please.", "author": "jwalden+bmo@mit.edu", "id": 11300516, "time": "2016-04-05T01:18:50Z"}, {"text": "(In reply to Ted Mielczarek [:ted.mielczarek] from comment #26)\n> > So, if we want to use `u_setDataDirectory`, we need to have the version number\n> > in the filename, because that's how ICU looks for it.\n\nBah.  Okay, good enough for now.", "author": "jwalden+bmo@mit.edu", "id": 11300560, "time": "2016-04-05T01:53:23Z"}, {"text": "Comment on attachment 8731305\nMozReview Request: bug 1239083 - use moz.build files to build ICU. r?glandium,waldo\n\nhttps://reviewboard.mozilla.org/r/40483/#review40949\n\n::: build/autoconf/icu.m4:79\n(Diff revision 3)\n> -    AC_SUBST(MOZ_ICU_VERSION)\n> -\n> +    #TODO: the l is actually endian-dependent, but we don't currently\n> +    # have an endianness check in configure. If someone adds one,\n\nNote this is not true anymore. We *do* have endianness in configure (not exposed in old-configure, but it's a add_old_configure_assignment away).\n\n::: config/external/icu/data/moz.build:25\n(Diff revision 3)\n> +\n> +ASFLAGS += [\n> +    '-DICU_DATA_FILE=\"%s\"' % CONFIG['ICU_DATA_FILE'],\n> +    '-DICU_DATA_SYMBOL=icudt%s_dat' % CONFIG['MOZ_ICU_VERSION'],\n> +]\n> +LOCAL_INCLUDES += ['.']\n\nyou shouldn't need this, since srcdir and CURDIR are both in INCLUDES in config.mk\n\n::: intl/icu_sources_data.py:47\n(Diff revision 3)\n> +        f.write(('# -*- Mode: python; c-basic-offset: 4; ' +\n> +                 'indent-tabs-mode: nil; tab-width: 40 -*-'))\n> +        f.write('''\n> +# vim: set filetype=python:\n\nif the file is generated, why add emacs and vim mode lines?\n\n::: intl/icu_sources_data.py:96\n(Diff revision 3)\n> +        'CFLAGS': '-DU_STATIC_IMPLEMENTATION',\n> +        'CXXFLAGS': '-DU_STATIC_IMPLEMENTATION',\n> +        'CPPFLAGS': ('-DU_USING_ICU_NAMESPACE=0 ' +\n> +                     '-DU_NO_DEFAULT_INCLUDE_UTF_HEADERS=1 ' +\n> +                     '-DUCONFIG_NO_LEGACY_CONVERSION ' +\n> +                     '-DUCONFIG_NO_TRANSLITERATION ' +\n> +                     '-DUCONFIG_NO_REGULAR_EXPRESSIONS ' +\n> +                     '-DUCONFIG_NO_BREAK_ITERATION ' +\n> +                     '-DU_CHARSET_IS_UTF8')\n\nThis would feel better if it was somehow shared with moz.build. Followup?\n\n::: intl/icu_sources_data.py:96\n(Diff revision 3)\n> +        'CFLAGS': '-DU_STATIC_IMPLEMENTATION',\n> +        'CXXFLAGS': '-DU_STATIC_IMPLEMENTATION',\n\nPresumably, that's redundant with --enable-static.\n\n::: xpcom/build/XPCOMInit.cpp:695\n(Diff revision 3)\n>    // the pointer argument when a size of 0 is passed in, so we need\n>    // the special version of the counting realloc.\n>    nestegg_set_halloc_func(NesteggReporter::CountingFreeingRealloc);\n>  #endif\n>  \n> +#if EXPOSE_INTL_API && defined(MOZ_ICU_DATA_ARCHIVE)\n\nThe define is only used in this one place, let's not make it an AC_DEFINE just for that.\n\n::: xpcom/build/XPCOMInit.cpp:695\n(Diff revision 3)\n> +#if EXPOSE_INTL_API && defined(MOZ_ICU_DATA_ARCHIVE)\n> +  nsCOMPtr<nsIFile> greDir;\n> +  nsDirectoryService::gService->Get(NS_GRE_DIR,\n> +                                    NS_GET_IID(nsIFile),\n> +                                    getter_AddRefs(greDir));\n> +  MOZ_ASSERT(greDir);\n> +  nsAutoCString nativeGREPath;\n> +  greDir->GetNativePath(nativeGREPath);\n> +  u_setDataDirectory(nativeGREPath.get());\n> +#endif\n\nPlease file a followup bug for the android support, because the file won't be there, but in the apk.", "author": "mh+mozilla@glandium.org", "id": 11301054, "time": "2016-04-05T09:36:43Z"}, {"text": "https://reviewboard.mozilla.org/r/40483/#review40883\n\n> We have intl/icu/source for imported stuffs, so I wonder if we should move some of this ICU-relevant stuff into intl/icu, out of intl/ or intl/icu-patches.  Maybe sometime.\n\nNot a bad idea, I just stuck everything in config/external/icu because that's where the existing Makefile was. (I also did the same thing when I switched the NSPR build over, all those moz.build files are in config/external/nspr).\n\n> Er, are those >>>> really in the patch, or is this reviewboard being unhelpful/misleading?\n\nThat's just reviewboard's way of indicating that indentation has changed.", "author": "ted@mielczarek.org", "id": 11301463, "time": "2016-04-05T14:07:30Z"}, {"text": "https://reviewboard.mozilla.org/r/40483/#review40949\n\n> Note this is not true anymore. We *do* have endianness in configure (not exposed in old-configure, but it's a add_old_configure_assignment away).\n\nI'll remove that from the comment, but obviously I'm not going to fix that because a) I don't have a big-endian machine handy and b) I don't really think it's worth committing a big-endian ICU data file to the tree. I suppose we could use that and force big-endian builds to use `--with-system-icu` or `--without-intl-api`.\n\n> you shouldn't need this, since srcdir and CURDIR are both in INCLUDES in config.mk\n\nExcept for some reason the SOBJS build rule only uses `$(LOCAL_INCLUDES)` and not `$(INCLUDES)`:\nhttps://dxr.mozilla.org/mozilla-central/rev/9bd90088875399347b05d87c67d3709e31539dcd/config/rules.mk#913\n\n> if the file is generated, why add emacs and vim mode lines?\n\nI think I just copy/pasted a header from an existing moz.build file. Kinda silly.\n\n> This would feel better if it was somehow shared with moz.build. Followup?\n\nFiled bug 1262101.\n\n> Presumably, that's redundant with --enable-static.\n\nI don't actually think it is, but I also think it might be irrelevant, since this define only controls the visibility/linkage of the public API symbols, so it's only relevant for our code that calls ICU APIs. I'll just remove it.\n\n> The define is only used in this one place, let's not make it an AC_DEFINE just for that.\n\nI think that was leftover from my previous patch that was using that in various places in js/src.\n\n> Please file a followup bug for the android support, because the file won't be there, but in the apk.\n\ny'know, I spent a bunch of time making sure everything built for Android `--with-intl-api`, but I never actually tried running the resulting build. The simplest fix here would just be to link in the ICU data file we generate for the JS shell. Filed bug 1262102 on this.", "author": "ted@mielczarek.org", "id": 11301464, "time": "2016-04-05T14:07:35Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=31426cddddb5", "author": "ted@mielczarek.org", "id": 11301473, "time": "2016-04-05T14:12:47Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/b65d504944ef45c9dd33ae45b922f5f438c12867\nbug 1239083 - use moz.build files to build ICU. r=glandium,waldo", "author": "ted@mielczarek.org", "id": 11302227, "time": "2016-04-05T17:59:28Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/b65d504944ef", "author": "cbook@mozilla.com", "id": 11304049, "time": "2016-04-06T10:05:25Z"}, {"text": "(In reply to Ted Mielczarek [:ted.mielczarek] from comment #0)\n> ICU's build system is terrible:\n> * It's not parallel-safe, so we have to build with -j1.\n\nWait, what? I build parallel all the time\u2026 Do you have any more details on this?", "author": "srl@icu-project.org", "id": 12115712, "time": "2017-03-04T06:40:28Z"}, {"text": "also you shouldn't have to scrape the makefiles\u2026\u00a0I'd think icu/icu4c/source/test/depstest/dependencies.txt would be a better machine readable source for building.\n\nyou can also just build *.cpp - that's what I do for node, with certain files opted out.", "author": "srl@icu-project.org", "id": 12116363, "time": "2017-03-05T06:56:17Z"}, {"text": "Hi Steven, thanks for the info! Sorry if it sounds like I'm being harsh on the ICU build system, it's just that I hate all build systems. :)\n\n(In reply to Steven R. Loomis from comment #36)\n> (In reply to Ted Mielczarek [:ted.mielczarek] from comment #0)\n> > ICU's build system is terrible:\n> > * It's not parallel-safe, so we have to build with -j1.\n> \n> Wait, what? I build parallel all the time\u2026 Do you have any more details on\n> this?\n\nHuh! I had to dig into the details, and it looks like we added this in bug 869406. This is what the build invocation looked like before that patch:\nhttps://hg.mozilla.org/mozilla-central/annotate/a4f96de49668/js/src/Makefile.in#l260\n\nand after:\nhttps://hg.mozilla.org/mozilla-central/annotate/1a1968da61b3/js/src/Makefile.in#l208\n\nWe had been forcing -j1 on Windows due to known issues with parallel builds with the msys gmake we were using, but apparently we were still hitting issues on other platforms. Now granted, that was 4 years ago, so it's possible there were issues that have since been fixed.\n\n(In reply to Steven R. Loomis from comment #37)\n> also you shouldn't have to scrape the makefiles\u2026\u00a0I'd think\n> icu/icu4c/source/test/depstest/dependencies.txt would be a better machine\n> readable source for building.\n> \n> you can also just build *.cpp - that's what I do for node, with certain\n> files opted out.\n\nThanks, I just checked and the output of scraping the Makefiles does in fact produce the same output as just listing *.cpp and *.c from the {common,i18n} directories. I'll file a bug to change the update script to do that since it's much simpler.", "author": "ted@mielczarek.org", "id": 12311333, "time": "2017-05-11T14:54:09Z"}], "id": 1239083, "priority": "--", "mentors_detail": [], "comment_count": 39, "version": "Trunk", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2018-03-02T20:12:20Z", "cf_platform_rel": "---", "product": "Firefox Build System", "cf_fx_iteration": "---", "blocks": [1262101, 905271, 926980, 966038, 1120360, 1129924, 1137564, 1169682, 1189391, 1206193, 1225401, 1262102, 1264817], "qa_contact": "", "see_also": [], "cf_status_firefox_esr52": "---", "component": "General", "votes": 0, "cf_status_firefox48": "fixed", "groups": [], "cf_status_firefox60": "---", "target_milestone": "mozilla48", "is_cc_accessible": true, "cf_status_firefox46": "affected", "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "ted@mielczarek.org", "id": 39022, "name": "ted@mielczarek.org", "real_name": "Ted Mielczarek [:ted.mielczarek]"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "arpad.borsos@googlemail.com", "id": 140537, "name": "arpad.borsos@googlemail.com", "real_name": "Arpad Borsos [:Swatinem]"}, {"email": "ehsan@mozilla.com", "id": 251051, "name": "ehsan@mozilla.com", "real_name": ":Ehsan Akhgari"}, {"email": "gandalf@aviary.pl", "id": 41270, "name": "gandalf@aviary.pl", "real_name": "Zibi Braniecki [:gandalf][:zibi]"}, {"email": "gps@mozilla.com", "id": 420446, "name": "gps@mozilla.com", "real_name": "Gregory Szorc [:gps]"}, {"email": "jmuizelaar@mozilla.com", "id": 309398, "name": "jmuizelaar@mozilla.com", "real_name": "Jeff Muizelaar [:jrmuizel]"}, {"email": "jwalden+bmo@mit.edu", "id": 83595, "name": "jwalden+bmo@mit.edu", "real_name": "Jeff Walden [:Waldo]"}, {"email": "mh+mozilla@glandium.org", "id": 47192, "name": "mh+mozilla@glandium.org", "real_name": "Mike Hommey [:glandium]"}, {"email": "Ms2ger@gmail.com", "id": 302720, "name": "Ms2ger@gmail.com", "real_name": ":Ms2ger (\u231a UTC+1/+2)"}, {"email": "mshal@mozilla.com", "id": 456035, "name": "mshal@mozilla.com", "real_name": "Michael Shal [:mshal] (out - 3/12)"}, {"email": "nfroyd@mozilla.com", "id": 417288, "name": "nfroyd@mozilla.com", "real_name": "Nathan Froyd [:froydnj]"}, {"email": "spectre@floodgap.com", "id": 101070, "name": "spectre@floodgap.com", "real_name": "Cameron Kaiser [:spectre]"}, {"email": "srl@icu-project.org", "id": 484342, "name": "srl@icu-project.org", "real_name": "Steven R. Loomis"}, {"email": "steve@ssinger.info", "id": 454498, "name": "steve@ssinger.info", "real_name": "Steve Singer (:stevensn)"}, {"email": "xidorn+moz@upsuper.org", "id": 373403, "name": "xidorn+moz@upsuper.org", "real_name": "Xidorn Quan [:xidorn] UTC+10"}], "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "assigned_to": "ted@mielczarek.org", "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "depends_on", "added": "926980"}], "who": "ted@mielczarek.org", "when": "2016-01-13T12:30:22Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "ehsan@mozilla.com"}], "who": "ehsan@mozilla.com", "when": "2016-01-15T15:34:31Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "arpad.borsos@googlemail.com"}], "who": "arpad.borsos@googlemail.com", "when": "2016-01-27T09:38:49Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "jmuizelaar@mozilla.com"}], "who": "jmuizelaar@mozilla.com", "when": "2016-02-02T22:18:47Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "966038"}], "who": "ted@mielczarek.org", "when": "2016-02-09T20:47:02Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1189391"}], "who": "ted@mielczarek.org", "when": "2016-02-09T20:49:55Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1247396"}], "who": "ted@mielczarek.org", "when": "2016-02-10T20:51:27Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "spectre@floodgap.com"}], "who": "spectre@floodgap.com", "when": "2016-02-12T17:07:56Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "nfroyd@mozilla.com"}], "who": "nfroyd@mozilla.com", "when": "2016-03-02T16:49:41Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8731305, "added": "review?(jwalden+bmo@mit.edu), review?(mh+mozilla@glandium.org)"}], "who": "ted@mielczarek.org", "when": "2016-03-16T16:24:07Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1257689"}], "who": "ted@mielczarek.org", "when": "2016-03-17T23:14:39Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "Ms2ger@gmail.com"}], "who": "Ms2ger@gmail.com", "when": "2016-03-18T08:57:14Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(mh+mozilla@glandium.org)", "attachment_id": 8731305, "added": ""}], "who": "mh+mozilla@glandium.org", "when": "2016-03-23T09:48:06Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8731305, "added": "review?(mh+mozilla@glandium.org)"}], "who": "ted@mielczarek.org", "when": "2016-03-23T16:36:18Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "926980"}, {"removed": "926980", "field_name": "depends_on", "added": ""}], "who": "ted@mielczarek.org", "when": "2016-03-23T17:17:23Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1259753"}], "who": "ted@mielczarek.org", "when": "2016-03-25T14:15:09Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(mh+mozilla@glandium.org)", "attachment_id": 8731305, "added": ""}], "who": "mh+mozilla@glandium.org", "when": "2016-03-25T22:42:32Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8731305, "added": "review?(mh+mozilla@glandium.org)"}], "who": "ted@mielczarek.org", "when": "2016-03-30T12:05:22Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(jwalden+bmo@mit.edu)", "attachment_id": 8731305, "added": ""}], "who": "jwalden+bmo@mit.edu", "when": "2016-04-05T01:18:49Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(mh+mozilla@glandium.org)", "attachment_id": 8731305, "added": "review+"}], "who": "mh+mozilla@glandium.org", "when": "2016-04-05T09:36:43Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1262101"}], "who": "ted@mielczarek.org", "when": "2016-04-05T10:19:43Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1262102"}], "who": "ted@mielczarek.org", "when": "2016-04-05T10:29:16Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1225401"}], "who": "ted@mielczarek.org", "when": "2016-04-05T12:19:34Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1206193"}], "who": "ted@mielczarek.org", "when": "2016-04-05T12:20:00Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1169682"}], "who": "ted@mielczarek.org", "when": "2016-04-05T12:20:43Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1137564"}], "who": "ted@mielczarek.org", "when": "2016-04-05T12:57:13Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1120360"}], "who": "ted@mielczarek.org", "when": "2016-04-05T12:57:58Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "905271"}], "who": "ted@mielczarek.org", "when": "2016-04-05T13:03:22Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1262231"}], "who": "cmanchester@mozilla.com", "when": "2016-04-05T18:43:34Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla48"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2016-04-06 03:05:25"}, {"removed": "---", "field_name": "cf_status_firefox48", "added": "fixed"}], "who": "cbook@mozilla.com", "when": "2016-04-06T10:05:25Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1262385"}], "who": "anygregor@gmail.com", "when": "2016-04-06T10:16:22Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1262492"}], "who": "jmaher@mozilla.com", "when": "2016-04-06T15:39:16Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1262636"}], "who": "aleth@instantbird.org", "when": "2016-04-06T22:53:55Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "steve@ssinger.info"}], "who": "steve@ssinger.info", "when": "2016-04-07T16:15:44Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1263325"}], "who": "mh+mozilla@glandium.org", "when": "2016-04-08T23:33:31Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1262731"}], "who": "n.nethercote@gmail.com", "when": "2016-04-11T00:20:40Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1264817"}], "who": "cmanchester@mozilla.com", "when": "2016-04-15T00:20:49Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1264836"}], "who": "steve@ssinger.info", "when": "2016-04-15T02:27:17Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1269262"}], "who": "jbeich@FreeBSD.org", "when": "2016-05-02T07:05:30Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "bugzilla@upsuper.org"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "ted@mielczarek.org"}], "who": "xidorn+moz@upsuper.org", "when": "2016-06-15T21:37:40Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "gandalf@aviary.pl"}], "who": "gandalf@aviary.pl", "when": "2016-07-15T18:08:45Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1290336"}], "who": "jwalden+bmo@mit.edu", "when": "2016-07-29T02:48:36Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "srl@icu-project.org"}], "who": "srl@icu-project.org", "when": "2017-03-04T06:40:28Z"}, {"changes": [{"removed": "Core", "field_name": "product", "added": "Firefox Build System"}], "who": "automation@bmo.tld", "when": "2018-03-02T20:12:20Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}