{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "mstange@themasta.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8499989}, {"creator": "mstange@themasta.com", "is_obsolete": 1, "is_patch": 1, "flags": [{"status": "-", "name": "review", "modification_date": "2014-10-12T08:36:25Z", "type_id": 4, "creation_date": "2014-10-10T13:38:38Z", "id": 1001419, "setter": "bas@basschouten.com"}, {"status": "+", "name": "review", "modification_date": "2014-10-10T14:48:23Z", "type_id": 4, "creation_date": "2014-10-10T13:39:31Z", "id": 1001423, "setter": "jmuizelaar@mozilla.com"}], "content_type": "text/plain", "id": 8503136}, {"creator": "mstange@themasta.com", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/plain", "id": 8503137}, {"creator": "mstange@themasta.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8503244}, {"creator": "mstange@themasta.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2014-10-19T15:13:14Z", "type_id": 4, "creation_date": "2014-10-15T20:31:40Z", "id": 1005991, "setter": "bas@basschouten.com"}, {"status": "+", "name": "review", "modification_date": "2014-10-24T14:20:06Z", "type_id": 4, "creation_date": "2014-10-19T15:13:14Z", "id": 1008871, "setter": "jmuizelaar@mozilla.com"}], "content_type": "text/plain", "id": 8505725}], "classification": "Components", "creator": "mstange@themasta.com", "cc": ["bas@basschouten.com", "jmuizelaar@mozilla.com", "Nomis101@web.de", "tnikkel@gmail.com"], "depends_on": [], "creation_time": "2014-08-19T16:17:30Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "All", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "Add support for specifying the font smoothing background color to Moz2D", "id": 1055622, "assigned_to_detail": {"email": "mstange@themasta.com", "id": 293943, "name": "mstange@themasta.com", "real_name": "Markus Stange [:mstange]"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "assigned_to": "mstange@themasta.com", "comment_count": 12, "comments": [{"text": "CoreGraphics has a private API since 10.9 called CGContextSetFontSmoothingBackgroundColor which lets you have subpixel anti-aliased fonts on transparent backgrounds if you roughly know what the final background color is going to be.\n\nWe'll need to call this if we want to have nice text rendering on top of \"vibrant\" widgets on 10.10, like the browser sidebar and context menus. And the cleanest way to support this is probably to start by adding support for it to Moz2D.\n\nProposed API:\n\nclass DrawTarget {\n...\n  bool SupportsFontSmoothingBackgroundColor() const;\n  void SetFontSmoothingBackgroundColor(const Color& aColor);\n...\n}", "author": "mstange@themasta.com", "id": 9201402, "time": "2014-08-19T16:17:30Z"}, {"text": "Created attachment 8499989\nwip", "author": "mstange@themasta.com", "id": 9402743, "time": "2014-10-04T11:22:16Z"}, {"text": "Created attachment 8503136\nv1\n\nr?Bas on the 2d.h changes\n\nI'm not really thrilled to add another bit of state to DrawTarget, but putting the color into GlyphRenderingOptions looks quite tricky to me, especially from the Gecko side.", "author": "mstange@themasta.com", "id": 9430361, "time": "2014-10-10T13:38:38Z"}, {"text": "Comment on attachment 8503136\nv1\n\nr?jrmuizel on the DrawTargetCG changes, especially on the EnsureValidPremultipliedData ugliness", "author": "mstange@themasta.com", "id": 9430366, "time": "2014-10-10T13:39:31Z"}, {"text": "Created attachment 8503137\ntesting app with annotated debugging session\n\nThis sheds some light on what CG is doing.", "author": "mstange@themasta.com", "id": 9430370, "time": "2014-10-10T13:40:41Z"}, {"text": "Comment on attachment 8503136\nv1\n\nReview of attachment 8503136:\n-----------------------------------------------------------------\n\nThis should probably be added to the recording backends as well.\n\n::: gfx/2d/DrawTargetCG.cpp\n@@ +1505,5 @@\n> +    // context into a context that has a different color space throws up on\n> +    // invalid premultiplied data and creates completely wrong colors.\n> +    // Sanitizing the data means that we lose some of the fake component alpha\n> +    // behavior that font rendering tries to give us, but the result still\n> +    // looks good enough to prefer it over grayscale font anti-aliasing.\n\nWhen do we draw into a context with a different color space? We should probably not ever be doing that.\n\n@@ +1698,5 @@\n> +  if (!lookedUpFunc) {\n> +    void* coreGraphicsFramework = dlopen(COREGRAPHICS_FRAMEWORK_PATH, RTLD_LAZY | RTLD_LOCAL);\n> +    if (coreGraphicsFramework) {\n> +      func = (CGContextSetFontSmoothingBackgroundColorFunc)dlsym(\n> +        coreGraphicsFramework, \"CGContextSetFontSmoothingBackgroundColor\");\n\nI think you can just use RTLD_DEFAULT instead of coreGraphicsFramework here. That's what ScaledFontMac::ScaledFontMac does.\n\n@@ +1712,5 @@\n> +{\n> +  DrawTarget::SetFontSmoothingBackgroundColor(aColor);\n> +\n> +  CGContextSetFontSmoothingBackgroundColorFunc func =\n> +    GetCGContextSetFontSmoothingBackgroundColorFunc();\n\nUse a better name than func.\n\nDo you have some idea what this function is actually doing? If you do a description in a comment someplace would be great.", "author": "jmuizelaar@mozilla.com", "id": 9430687, "time": "2014-10-10T14:48:23Z"}, {"text": "(In reply to Jeff Muizelaar [:jrmuizel] from comment #5)\n> Comment on attachment 8503136\n> v1\n> \n> Review of attachment 8503136:\n> -----------------------------------------------------------------\n> \n> This should probably be added to the recording backends as well.\n\nright, thanks\n\n> ::: gfx/2d/DrawTargetCG.cpp\n> @@ +1505,5 @@\n> > +    // context into a context that has a different color space throws up on\n> > +    // invalid premultiplied data and creates completely wrong colors.\n> > +    // Sanitizing the data means that we lose some of the fake component alpha\n> > +    // behavior that font rendering tries to give us, but the result still\n> > +    // looks good enough to prefer it over grayscale font anti-aliasing.\n> \n> When do we draw into a context with a different color space? We should\n> probably not ever be doing that.\n\nWhen drawing into the context we get from drawRect, at least. I saw the bad colors in context menus, which don't use hardware acceleration.\nYou can also see it happening in the test app I attached.\n\n> @@ +1698,5 @@\n> > +  if (!lookedUpFunc) {\n> > +    void* coreGraphicsFramework = dlopen(COREGRAPHICS_FRAMEWORK_PATH, RTLD_LAZY | RTLD_LOCAL);\n> > +    if (coreGraphicsFramework) {\n> > +      func = (CGContextSetFontSmoothingBackgroundColorFunc)dlsym(\n> > +        coreGraphicsFramework, \"CGContextSetFontSmoothingBackgroundColor\");\n> \n> I think you can just use RTLD_DEFAULT instead of coreGraphicsFramework here.\n> That's what ScaledFontMac::ScaledFontMac does.\n\nOh good. \"man dlsym\" says about RTLD_DEFAULT \"This can be a costly search and should be avoided.\", but if we're already doing it then I'll just ignore that warning.\n\n> \n> @@ +1712,5 @@\n> > +{\n> > +  DrawTarget::SetFontSmoothingBackgroundColor(aColor);\n> > +\n> > +  CGContextSetFontSmoothingBackgroundColorFunc func =\n> > +    GetCGContextSetFontSmoothingBackgroundColorFunc();\n> \n> Use a better name than func.\n\nok\n\n> Do you have some idea what this function is actually doing?\n\nAs in, do I know the actual calculation? No, I don't know that. I only know what I wrote in the first paragraph of comment 0.\n\n> If you do a\n> description in a comment someplace would be great.\n\nok", "author": "mstange@themasta.com", "id": 9430727, "time": "2014-10-10T14:57:27Z"}, {"text": "Created attachment 8503244\npart 2: DrawTargetRecording support", "author": "mstange@themasta.com", "id": 9431128, "time": "2014-10-10T16:15:35Z"}, {"text": "Comment on attachment 8503136\nv1\n\nReview of attachment 8503136:\n-----------------------------------------------------------------\n\nThis is so very specific to a certain backend, I feel it should go into a GlyphRenderingOptions object rather than through its own API. These sort of things will really clutter the API.", "author": "bas@basschouten.com", "id": 9435696, "time": "2014-10-12T08:36:25Z"}, {"text": "Created attachment 8505725\nv2", "author": "mstange@themasta.com", "id": 9452562, "time": "2014-10-15T20:31:40Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/1d593636d86d", "author": "mstange@themasta.com", "id": 9497890, "time": "2014-10-24T16:35:07Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/1d593636d86d", "author": "kwierso@gmail.com", "id": 9500152, "time": "2014-10-25T01:31:37Z"}], "cf_last_resolved": "2014-10-25T01:31:37Z", "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "Trunk", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2016-03-22T16:43:30Z", "cf_platform_rel": "---", "product": "Core", "cf_status_firefox_esr52": "---", "blocks": [1055634], "qa_contact": "", "see_also": ["https://bugzilla.mozilla.org/show_bug.cgi?id=1258752"], "cf_fx_iteration": "---", "component": "Graphics", "votes": 0, "groups": [], "cf_status_firefox60": "---", "target_milestone": "mozilla36", "is_cc_accessible": true, "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "mstange@themasta.com", "id": 293943, "name": "mstange@themasta.com", "real_name": "Markus Stange [:mstange]"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "bas@basschouten.com", "id": 272464, "name": "bas@basschouten.com", "real_name": "Bas Schouten (:bas.schouten)"}, {"email": "jmuizelaar@mozilla.com", "id": 309398, "name": "jmuizelaar@mozilla.com", "real_name": "Jeff Muizelaar [:jrmuizel]"}, {"email": "Nomis101@web.de", "id": 299163, "name": "Nomis101@web.de", "real_name": "Nomis101"}, {"email": "tnikkel@gmail.com", "id": 255010, "name": "tnikkel@gmail.com", "real_name": "Timothy Nikkel (:tnikkel)"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "blocks", "added": "1055634"}], "who": "mstange@themasta.com", "when": "2014-08-19T16:33:20Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "tnikkel@gmail.com"}], "who": "tnikkel@gmail.com", "when": "2014-08-19T16:52:11Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "Nomis101@web.de"}], "who": "Nomis101@web.de", "when": "2014-08-19T17:05:34Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8499989, "added": "1"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8503136, "added": "review?(bas@basschouten.com)"}, {"removed": "NEW", "field_name": "status", "added": "ASSIGNED"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "mstange@themasta.com"}], "who": "mstange@themasta.com", "when": "2014-10-10T13:38:38Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8503136, "added": "review?(jmuizelaar@mozilla.com)"}], "who": "mstange@themasta.com", "when": "2014-10-10T13:39:31Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(jmuizelaar@mozilla.com)", "attachment_id": 8503136, "added": "review+"}], "who": "jmuizelaar@mozilla.com", "when": "2014-10-10T14:48:23Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8503244, "added": "review?(bas@basschouten.com)"}], "who": "mstange@themasta.com", "when": "2014-10-10T16:15:35Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bas@basschouten.com)", "attachment_id": 8503136, "added": "review-"}], "who": "bas@basschouten.com", "when": "2014-10-12T08:36:25Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bas@basschouten.com)", "attachment_id": 8503244, "added": ""}], "who": "mstange@themasta.com", "when": "2014-10-12T12:59:30Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8503136, "added": "1"}, {"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8503244, "added": "1"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8505725, "added": "review?(bas@basschouten.com)"}], "who": "mstange@themasta.com", "when": "2014-10-15T20:31:40Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bas@basschouten.com)", "attachment_id": 8505725, "added": "review+, review?(jmuizelaar@mozilla.com)"}], "who": "bas@basschouten.com", "when": "2014-10-19T15:13:14Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(jmuizelaar@mozilla.com)", "attachment_id": 8505725, "added": "review+"}], "who": "jmuizelaar@mozilla.com", "when": "2014-10-24T14:20:06Z"}, {"changes": [{"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla36"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2014-10-24 18:31:37"}], "who": "kwierso@gmail.com", "when": "2014-10-25T01:31:37Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1258752"}], "who": "mchang@mozilla.com", "when": "2016-03-22T16:43:30Z"}], "resolution": "FIXED", "op_sys": "Mac OS X", "cf_fx_points": "---", "cf_blocking_fennec": "---"}