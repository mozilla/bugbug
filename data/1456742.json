{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "dkeeler@mozilla.com", "mentors_detail": [], "depends_on": [], "cf_status_firefox_esr60": "wontfix", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": ["regression"], "cc_detail": [{"email": "amarchesini@mozilla.com", "id": 446257, "name": "amarchesini@mozilla.com", "real_name": "Andrea Marchesini [:baku]"}, {"email": "bkelly@mozilla.com", "id": 465500, "name": "bkelly@mozilla.com", "real_name": "Ben Kelly [:bkelly]"}, {"email": "ckerschb@christophkerschbaumer.com", "id": 363267, "name": "ckerschb@christophkerschbaumer.com", "real_name": "Christoph Kerschbaumer [:ckerschb]"}, {"email": "daniel@haxx.se", "id": 16743, "name": "daniel@haxx.se", "real_name": "Daniel Stenberg [:bagder]"}, {"email": "honzab.moz@firemni.cz", "id": 269762, "name": "honzab.moz@firemni.cz", "real_name": "Honza Bambas (:mayhemer)"}, {"email": "josh@joshmatthews.net", "id": 241497, "name": "josh@joshmatthews.net", "real_name": "Josh Matthews [:jdm]"}, {"email": "mcastelluccio@mozilla.com", "id": 420453, "name": "mcastelluccio@mozilla.com", "real_name": "Marco Castelluccio [:marco]"}, {"email": "michal.novotny@gmail.com", "id": 268625, "name": "michal.novotny@gmail.com", "real_name": "Michal Novotny (:michal)"}, {"email": "ryanvm@gmail.com", "id": 75935, "name": "ryanvm@gmail.com", "real_name": "Ryan VanderMeulen [:RyanVM]"}], "cf_last_resolved": "2018-05-29T21:47:39Z", "attachments": [{"creator": "honzab.moz@firemni.cz", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-05-29T14:53:17Z", "type_id": 4, "creation_date": "2018-05-11T13:11:39Z", "id": 1755712, "setter": "josh@joshmatthews.net"}], "content_type": "text/plain", "id": 8974977}], "votes": 0, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 9, "comments": [{"text": "This may just be a misunderstanding about the API, but it doesn't seem like the intended behavior. It appears that if a channel doesn't have its own load group set, any origin attributes that are set on the channel's load info aren't honored. See for example the OCSP request code:\n\nhttps://searchfox.org/mozilla-central/rev/8f06c1b9a080b84435a2906e420fe102e1ed780b/security/manager/ssl/nsNSSCallbacks.cpp#129\n\n  if (mRequestSession->mOriginAttributes != OriginAttributes()) {\n    OriginAttributes attrs;\n    attrs.mFirstPartyDomain =\n      mRequestSession->mOriginAttributes.mFirstPartyDomain;\n    attrs.mPrivateBrowsingId =\n      mRequestSession->mOriginAttributes.mPrivateBrowsingId;\n\n    nsCOMPtr<nsILoadInfo> loadInfo = chan->GetLoadInfo();\n    if (loadInfo) {\n      rv = loadInfo->SetOriginAttributes(attrs);\n      NS_ENSURE_SUCCESS(rv, rv);\n    }\n  }\n\n  // Create a loadgroup for this new channel.  This way if the channel\n  // is redirected, we'll have a way to cancel the resulting channel.\n  nsCOMPtr<nsILoadGroup> lg = do_CreateInstance(NS_LOADGROUP_CONTRACTID);\n  chan->SetLoadGroup(lg);\n\nIf the given origin attributes aren't the default, we set some custom origin attributes on the channel's load info. We then set a load group. If the load group isn't set (basically, comment out references to 'lg' or 'mLoadGroup' in that file), the test xpcshell test security/manager/ssl/tests/unit/test_ocsp_private_caching.js will fail because we make an OCSP request in a private context that gets cached as non-private.\n\nObviously the workaround is clear (just set a load group), but it's less clear that this is the intended behavior. It also seems like a pitfall for any new code that relies on separating requests by origin attributes.", "author": "dkeeler@mozilla.com", "id": 13231886, "time": "2018-04-25T08:14:24Z"}, {"text": "Honza, can you have a look at this?", "author": "michal.novotny@gmail.com", "id": 13239651, "time": "2018-04-28T06:57:47Z"}, {"text": "(giving it a prio 1, feel free to change)", "author": "daniel@haxx.se", "id": 13245027, "time": "2018-04-30T22:53:01Z"}, {"text": "Seems like a regressions (or a feature? :)) of bug 1199841.  \n\nThe problem is that UpdatePrivateBrowsing() is not called by the channel on itself.  We only call it when notification callbacks or a load group is set on the channel (as it affects the is-private state).  \n\nThe UpdatePrivateBrowsing() method is responsible for updating PrivateBrowsingChannel->mPrivateBrowsing member that is used to _sync_ PB state on the channel's origin attributes when we want to be used by external consumers.\n\nSo, I think one way to fix this is to call UpdatePrivateBrowsing() from inside AsyncOpen or some later point when the channel has no load group and also doesn't have notification callbacks.  That's a good fix.\n\nI don't understand why there is this weird mechanism in the first place.  When we want to tell the cache which jar to use the privacy state is determined here:\n\txul.dll!mozilla::net::PrivateBrowsingChannel<mozilla::net::HttpBaseChannel>::GetIsChannelPrivate(0x0000000a415f2760) Line 51\tC++\n \txul.dll!NS_GetOriginAttributes(0x000001e3dc199050, {...}) Line 2038\tC++\n \txul.dll!mozilla::net::GetLoadContextInfo(0x000001e3dc199050) Line 131\tC++\n \txul.dll!mozilla::net::nsHttpChannel::OpenCacheEntryInternal(true, 0x0000000000000000, true) Line 3723\tC++\n\ninstead of just directly returning the OAs of the channel.", "author": "honzab.moz@firemni.cz", "id": 13270559, "time": "2018-05-11T12:21:04Z"}, {"text": "Created attachment 8974977\nv1\n\nI think the patch is enough self-explanatory.  Locally tested for an ocsp request made for a load in a PB window.\n\nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=9c1af49396dfa97f03ac57c4fb58f81b971e8162", "author": "honzab.moz@firemni.cz", "id": 13270655, "time": "2018-05-11T13:11:39Z"}, {"text": "Pushed by ryanvm@gmail.com:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/73d26c2c475f\nMake sure to call UpdatePrivateBrowsing() in http channel to properly set private browsing state of the channel when no load group or callbacks have been set on it before AsyncOpen. r=jdm", "author": "pulsebot@bots.tld", "id": 13371742, "time": "2018-05-29T16:49:58Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/73d26c2c475f", "author": "nerli@mozilla.com", "id": 13372591, "time": "2018-05-29T21:47:39Z"}, {"text": "What's the severity of this issue? Given how old it is, can the fix just ride the trains or should we consider backport?", "author": "ryanvm@gmail.com", "id": 13373221, "time": "2018-05-30T02:27:58Z"}, {"text": "(In reply to Ryan VanderMeulen [:RyanVM] from comment #7)\n> What's the severity of this issue? Given how old it is, can the fix just\n> ride the trains or should we consider backport?\n\nI think the only affected consumer is now PSM and they have a workaround.  Hence, I think this can (should) ride.\n\nThanks.", "author": "honzab.moz@firemni.cz", "id": 13373503, "time": "2018-05-30T06:57:09Z"}], "id": 1456742, "priority": "P1", "cc": ["amarchesini@mozilla.com", "bkelly@mozilla.com", "ckerschb@christophkerschbaumer.com", "daniel@haxx.se", "honzab.moz@firemni.cz", "josh@joshmatthews.net", "mcastelluccio@mozilla.com", "michal.novotny@gmail.com", "ryanvm@gmail.com"], "cf_crash_signature": "", "version": "unspecified", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_thunderbird_esr60": "---", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1199841, 1465258], "qa_contact": "", "creation_time": "2018-04-25T08:14:24Z", "cf_status_firefox_esr52": "wontfix", "component": "Networking", "assigned_to_detail": {"email": "honzab.moz@firemni.cz", "id": 269762, "name": "honzab.moz@firemni.cz", "real_name": "Honza Bambas (:mayhemer)"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "fixed", "cf_status_firefox61": "wontfix", "cf_status_firefox60": "wontfix", "target_milestone": "mozilla62", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "dkeeler@mozilla.com", "id": 349244, "name": "dkeeler@mozilla.com", "real_name": "[:keeler] (use needinfo)"}, "whiteboard": "[necko-triaged]", "mentors": [], "summary": "if a channel doesn't have a load group, its origin attributes aren't honored", "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-05-30T12:23:57Z", "assigned_to": "honzab.moz@firemni.cz", "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "honzab.moz@firemni.cz"}], "who": "honzab.moz@firemni.cz", "when": "2018-04-25T12:37:06Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "amarchesini@mozilla.com, bkelly@mozilla.com, ckerschb@christophkerschbaumer.com"}], "who": "bkelly@mozilla.com", "when": "2018-04-25T14:37:18Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "michal.novotny@gmail.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(honzab.moz@firemni.cz)"}], "who": "michal.novotny@gmail.com", "when": "2018-04-28T06:57:47Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "honzab.moz@firemni.cz"}, {"removed": "needinfo?(honzab.moz@firemni.cz)", "field_name": "flagtypes.name", "added": ""}], "who": "honzab.moz@firemni.cz", "when": "2018-04-30T15:36:20Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "josh@joshmatthews.net"}], "who": "josh@joshmatthews.net", "when": "2018-04-30T16:08:21Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P1"}, {"removed": "", "field_name": "cc", "added": "daniel@haxx.se"}, {"removed": "", "field_name": "whiteboard", "added": "[necko-triaged]"}], "who": "daniel@haxx.se", "when": "2018-04-30T22:53:01Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "ASSIGNED"}, {"removed": "", "field_name": "blocks", "added": "1199841"}], "who": "honzab.moz@firemni.cz", "when": "2018-05-11T12:21:04Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8974977, "added": "review?(josh@joshmatthews.net)"}], "who": "honzab.moz@firemni.cz", "when": "2018-05-11T13:11:39Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "regression"}, {"removed": "", "field_name": "cc", "added": "mcastelluccio@mozilla.com"}], "who": "mcastelluccio@mozilla.com", "when": "2018-05-14T13:41:24Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(josh@joshmatthews.net)", "attachment_id": 8974977, "added": "review+"}], "who": "josh@joshmatthews.net", "when": "2018-05-29T14:53:17Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "checkin-needed"}], "who": "honzab.moz@firemni.cz", "when": "2018-05-29T16:41:22Z"}, {"changes": [{"removed": "checkin-needed", "field_name": "keywords", "added": ""}], "who": "pulsebot@bots.tld", "when": "2018-05-29T16:49:58Z"}, {"changes": [{"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla62"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-05-29 21:47:39"}, {"removed": "---", "field_name": "cf_status_firefox62", "added": "fixed"}], "who": "nerli@mozilla.com", "when": "2018-05-29T21:47:39Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1465258"}], "who": "dkeeler@mozilla.com", "when": "2018-05-29T22:45:37Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "ryanvm@gmail.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(honzab.moz@firemni.cz)"}, {"removed": "---", "field_name": "cf_status_firefox_esr52", "added": "wontfix"}, {"removed": "---", "field_name": "cf_status_firefox_esr60", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox60", "added": "wontfix"}, {"removed": "---", "field_name": "cf_status_firefox61", "added": "affected"}], "who": "ryanvm@gmail.com", "when": "2018-05-30T02:27:58Z"}, {"changes": [{"removed": "needinfo?(honzab.moz@firemni.cz)", "field_name": "flagtypes.name", "added": ""}], "who": "honzab.moz@firemni.cz", "when": "2018-05-30T06:57:09Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox_esr60", "added": "wontfix"}, {"removed": "affected", "field_name": "cf_status_firefox61", "added": "wontfix"}], "who": "ryanvm@gmail.com", "when": "2018-05-30T12:23:57Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}