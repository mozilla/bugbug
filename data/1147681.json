{"cf_tracking_thunderbird_esr52": "---", "cf_status_firefox39": "fixed", "cf_tracking_firefox60": "---", "attachments": [{"creator": "dvander@alliedmods.net", "is_obsolete": 1, "is_patch": 1, "flags": [{"status": "-", "name": "review", "modification_date": "2015-03-26T17:47:09Z", "type_id": 4, "creation_date": "2015-03-26T00:18:27Z", "id": 1131654, "setter": "bugmail@mozilla.staktrace.com"}], "content_type": "text/plain", "id": 8583494}, {"creator": "dvander@alliedmods.net", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2015-03-26T20:54:18Z", "type_id": 4, "creation_date": "2015-03-26T20:33:46Z", "id": 1132623, "setter": "bugmail@mozilla.staktrace.com"}], "content_type": "text/plain", "id": 8584047}, {"creator": "dvander@alliedmods.net", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2015-03-26T21:06:58Z", "type_id": 4, "creation_date": "2015-03-26T20:35:27Z", "id": 1132626, "setter": "bugmail@mozilla.staktrace.com"}], "content_type": "text/plain", "id": 8584049}], "classification": "Components", "creator": "dvander@alliedmods.net", "cc": ["bugmail@mozilla.staktrace.com"], "depends_on": [1159398], "creation_time": "2015-03-26T00:17:27Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "All", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "APZCs can be leaked when a compositor shuts down", "id": 1147681, "assigned_to_detail": {"email": "dvander@alliedmods.net", "id": 309316, "name": "dvander@alliedmods.net", "real_name": "David Anderson [:dvander] - inactive, e-mail if emergency"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "assigned_to": "dvander@alliedmods.net", "comment_count": 9, "comments": [{"text": "We don't clear the input queue during APZCTM::ClearTree(), so if there's a wheel transaction or something lying around, it'll leak memory via a cycle from mTargetApzc -> mInputQueue.", "author": "dvander@alliedmods.net", "id": 10078938, "time": "2015-03-26T00:17:27Z"}, {"text": "Created attachment 8583494\nfix", "author": "dvander@alliedmods.net", "id": 10078942, "time": "2015-03-26T00:18:27Z"}, {"text": "Comment on attachment 8583494\nfix\n\nReview of attachment 8583494:\n-----------------------------------------------------------------\n\n::: gfx/layers/apz/src/APZCTreeManager.cpp\n@@ +1061,5 @@\n>  APZCTreeManager::ClearTree()\n>  {\n>    MonitorAutoLock lock(mTreeLock);\n>  \n> +  mInputQueue->Clear();\n\nWe should only be calling mInputQueue->Clear() on the controller thread, to avoid race conditions. I don't think APZCTM::ClearTree is guaranteed to be called on the controller thread on all platforms. Best to wrap it in a call to APZThreadUtils::RunOnControllerThread.\n\nNote also that we shouldn't be holding the mTreeLock when calling mInputQueue->Clear(). Probably no harm in doing it, but it's not needed either.\n\n::: gfx/layers/apz/src/InputQueue.cpp\n@@ +462,5 @@\n>  \n> +void\n> +InputQueue::Clear()\n> +{\n> +  mInputBlockQueue.Clear();\n\nAdd a APZThreadUtils::AssertOnControllerThread here.\n\n::: gfx/layers/apz/src/InputQueue.h\n@@ +101,5 @@\n>     */\n>    WheelBlockState* GetCurrentWheelTransaction() const;\n> +  /**\n> +   * Clear the input queue. APZCTreeManager invokes this to ensure no\n> +   * references to APZCs are alive after ClearTree().\n\nJust something like \"Remove all input blocks from the input queue.\" is fine here. The second sentence of this comment should move to the call site.", "author": "bugmail@mozilla.staktrace.com", "id": 10082504, "time": "2015-03-26T17:47:09Z"}, {"text": "Created attachment 8584047\npart 1, refactor RunOnControllerThread\n\nThis requires widgets to explicitly set the MessageLoop of the controller thread, which makes asserting the right thread a little easier and lets us dispatch to the controller thread from any other thread.", "author": "dvander@alliedmods.net", "id": 10083486, "time": "2015-03-26T20:33:46Z"}, {"text": "Created attachment 8584049\npart 2, fix leak", "author": "dvander@alliedmods.net", "id": 10083495, "time": "2015-03-26T20:35:27Z"}, {"text": "Comment on attachment 8584047\npart 1, refactor RunOnControllerThread\n\nReview of attachment 8584047:\n-----------------------------------------------------------------\n\nI remember now that Fennec won't have a MessageLoop on its controller thread, but I think we can deal with with some #ifdef'ing local to APZThreadUtils.cpp so I'm not too worried about it. This looks good, thanks!", "author": "bugmail@mozilla.staktrace.com", "id": 10083636, "time": "2015-03-26T20:54:18Z"}, {"text": "Comment on attachment 8584049\npart 2, fix leak\n\nReview of attachment 8584049:\n-----------------------------------------------------------------\n\nr+ with the RunnableMethodTraits struct removed, as it's not needed", "author": "bugmail@mozilla.staktrace.com", "id": 10083749, "time": "2015-03-26T21:06:58Z"}, {"text": "remote:   https://hg.mozilla.org/integration/mozilla-inbound/rev/c2179c027c28\nremote:   https://hg.mozilla.org/integration/mozilla-inbound/rev/6f42f8ee8246\n\nw/ comment #6 addressed", "author": "dvander@alliedmods.net", "id": 10083869, "time": "2015-03-26T21:25:54Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/c2179c027c28\nhttps://hg.mozilla.org/mozilla-central/rev/6f42f8ee8246", "author": "ryanvm@gmail.com", "id": 10088237, "time": "2015-03-27T16:28:50Z"}], "cf_last_resolved": "2015-03-27T16:28:50Z", "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "unspecified", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2015-04-28T18:41:08Z", "cf_platform_rel": "---", "product": "Core", "cf_status_firefox_esr52": "---", "blocks": [1086162], "qa_contact": "", "see_also": [], "cf_fx_iteration": "---", "component": "Panning and Zooming", "votes": 0, "groups": [], "cf_status_firefox60": "---", "target_milestone": "mozilla39", "is_cc_accessible": true, "status": "RESOLVED", "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "dvander@alliedmods.net", "id": 309316, "name": "dvander@alliedmods.net", "real_name": "David Anderson [:dvander] - inactive, e-mail if emergency"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "bugmail@mozilla.staktrace.com", "id": 426788, "name": "bugmail@mozilla.staktrace.com", "real_name": "Kartikaya Gupta (email:kats@mozilla.com)"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "bugmail.mozilla@staktrace.com"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8583494, "added": "review?(bugmail.mozilla@staktrace.com)"}], "who": "dvander@alliedmods.net", "when": "2015-03-26T00:18:27Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bugmail.mozilla@staktrace.com)", "attachment_id": 8583494, "added": "review-"}], "who": "bugmail@mozilla.staktrace.com", "when": "2015-03-26T17:47:09Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8583494, "added": "1"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8584047, "added": "review?(bugmail.mozilla@staktrace.com)"}], "who": "dvander@alliedmods.net", "when": "2015-03-26T20:33:46Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8584049, "added": "review?(bugmail.mozilla@staktrace.com)"}], "who": "dvander@alliedmods.net", "when": "2015-03-26T20:35:27Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bugmail.mozilla@staktrace.com)", "attachment_id": 8584047, "added": "review+"}], "who": "bugmail@mozilla.staktrace.com", "when": "2015-03-26T20:54:18Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bugmail.mozilla@staktrace.com)", "attachment_id": 8584049, "added": "review+"}], "who": "bugmail@mozilla.staktrace.com", "when": "2015-03-26T21:06:58Z"}, {"changes": [{"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla39"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2015-03-27 09:28:50"}, {"removed": "---", "field_name": "cf_status_firefox39", "added": "fixed"}], "who": "ryanvm@gmail.com", "when": "2015-03-27T16:28:50Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1159398"}], "who": "bugmail@mozilla.staktrace.com", "when": "2015-04-28T18:41:08Z"}], "resolution": "FIXED", "op_sys": "All", "cf_fx_points": "---", "cf_blocking_fennec": "---"}