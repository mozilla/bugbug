{"cf_tracking_thunderbird_esr52": "---", "status": "NEW", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "kwierso@gmail.com", "mentors_detail": [], "depends_on": [], "cf_has_str": "---", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": ["intermittent-failure"], "summary": "Intermittent failure to receive sandbox broker responses (SandboxBrokerTest.MultiThreadOpen, SandboxBrokerTest.MultiThreadStat, or \u201cSandbox: Unexpected EOF\u201d by itself near non-shutdown crashes)", "cf_last_resolved": null, "cf_status_firefox50": "wontfix", "cf_status_firefox51": "wontfix", "votes": 1, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 56, "comments": [{"text": "https://treeherder.mozilla.org/logviewer.html#?job_id=20472319&repo=mozilla-inbound", "author": "kwierso@gmail.com", "id": 11109900, "time": "2016-01-26T20:05:31Z"}, {"text": "-5 means this:\n\n> #define EIO              5      /* I/O error */\n\nBut that's not from the actual open(); this is also in the test log:\n\n> Sandbox: Unexpected EOF, op 0 flags 00 path /dev/zero\n\nThat's from the broker client.  The parent is supposed to write a SandboxBrokerCommon::Response and attach a file descriptor; the child got EOF instead.  I need to look at this a little more closely.", "author": "jld@mozilla.com", "id": 11114218, "time": "2016-01-27T22:41:23Z"}, {"text": "To clarify: for the gtests this is in multiple threads in the same process; the \u201cchild\u201d\u00a0role is taken by the main thread and the \u201cparent\u201d is the broker thread.\n\nI've heard about implementations of AF_UNIX sockets having bugs when a socket is closed and there's outstanding data not yet read by the peer, but I think that was specific to OS X.  Linux seems to handle that fine in the general case; I tried adding some nanosleep() calls to adjust the timing but they didn't reproduce this.\n\nThis code isn't being used for real on desktop yet, but it (or something equivalent) will be needed eventually; it is used on B2G, but B2G is now Tier 3.  So this test could be disabled if the failures become too common and there's no solution in sight, but that would invite bit rot.\n\nThis particular test invokes the broker client in a tight loop on multiple threads concurrently, to try to catch thread-unsafety in the client or broker bugs that would mix up different requests' respnses somehow.  It's almost but not quite entirely implausible that there's an uncommon race condition in the Linux kernel this is being run on (still a heavily patched 3.2.x, I think?), which went undetected because normal workloads don't stress the SCM_RIGHTS code like that.", "author": "jld@mozilla.com", "id": 11117680, "time": "2016-01-28T20:03:54Z"}, {"text": "*** Bug 1246436 has been marked as a duplicate of this bug. ***", "author": "jld@mozilla.com", "id": 11147488, "time": "2016-02-08T18:47:28Z"}, {"text": "6 automation job failures were associated with this bug in the last 7 days.\n\nRepository breakdown:\n* mozilla-inbound: 5\n* fx-team: 1\n\nPlatform breakdown:\n* linux64: 6\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2016-06-20&endday=2016-06-26&tree=all", "author": "orangefactor@bots.tld", "id": 11503025, "time": "2016-06-27T01:03:15Z"}, {"text": "5 automation job failures were associated with this bug in the last 7 days.\n\nRepository breakdown:\n* mozilla-inbound: 2\n* mozilla-central: 2\n* mozilla-beta: 1\n\nPlatform breakdown:\n* linux64: 5\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2016-08-01&endday=2016-08-07&tree=all", "author": "orangefactor@bots.tld", "id": 11605727, "time": "2016-08-08T01:10:58Z"}, {"text": "*** Bug 1295421 has been marked as a duplicate of this bug. ***", "author": "jld@mozilla.com", "id": 11629574, "time": "2016-08-16T17:27:27Z"}, {"text": "*** Bug 1296200 has been marked as a duplicate of this bug. ***", "author": "jld@mozilla.com", "id": 11636379, "time": "2016-08-18T15:38:01Z"}, {"text": "Bulk assigning P3 to all open intermittent bugs without a priority set in Firefox components per bug 1298978.", "author": "automation@bmo.tld", "id": 11677658, "time": "2016-09-01T18:57:58Z"}, {"text": "11 automation job failures were associated with this bug in the last 7 days.\n\nRepository breakdown:\n* autoland: 5\n* mozilla-inbound: 2\n* fx-team: 2\n* mozilla-central: 1\n* mozilla-aurora: 1\n\nPlatform breakdown:\n* linux64: 11\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2016-08-29&endday=2016-09-04&tree=all", "author": "orangefactor@bots.tld", "id": 11685396, "time": "2016-09-05T01:11:49Z"}, {"text": "8 automation job failures were associated with this bug in the last 7 days.\n\nRepository breakdown:\n* autoland: 5\n* mozilla-inbound: 2\n* fx-team: 1\n\nPlatform breakdown:\n* linux64: 8\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2016-09-05&endday=2016-09-11&tree=all", "author": "orangefactor@bots.tld", "id": 11701826, "time": "2016-09-12T01:08:42Z"}, {"text": "10 automation job failures were associated with this bug in the last 7 days.\n\nRepository breakdown:\n* mozilla-inbound: 4\n* autoland: 4\n* try: 1\n* fx-team: 1\n\nPlatform breakdown:\n* linux64: 10\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2016-09-12&endday=2016-09-18&tree=all", "author": "orangefactor@bots.tld", "id": 11718332, "time": "2016-09-19T01:08:44Z"}, {"text": "6 automation job failures were associated with this bug in the last 7 days.\n\nRepository breakdown:\n* mozilla-inbound: 4\n* mozilla-aurora: 1\n* autoland: 1\n\nPlatform breakdown:\n* linux64: 6\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2016-09-19&endday=2016-09-25&tree=all", "author": "orangefactor@bots.tld", "id": 11735891, "time": "2016-09-26T01:02:09Z"}, {"text": "(In reply to Jed Davis [:jld] {\u23f0UTC-7} from comment #2)\n> This code isn't being used for real on desktop yet, but it (or something\n> equivalent) will be needed eventually\n\n\u201cEventually\u201d\u00a0is now: we've been using this code on Nightly since bug 1289718 landed.\n\nIt would really help if this bug could be reproduced under rr.  I tried running the tests locally under rr chaos mode, but no luck.", "author": "jld@mozilla.com", "id": 11858699, "time": "2016-11-14T19:55:29Z"}, {"text": "*** Bug 1317084 has been marked as a duplicate of this bug. ***", "author": "jld@mozilla.com", "id": 11868762, "time": "2016-11-17T19:52:22Z"}, {"text": "1 failures in 822 pushes (0.001 failures/push) were associated with this bug in the last 7 days.   \n\nRepository breakdown:\n* autoland: 1\n\nPlatform breakdown:\n* linux32: 1\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2017-07-17&endday=2017-07-23&tree=all", "author": "orangefactor@bots.tld", "id": 12498754, "time": "2017-07-24T01:30:53Z"}, {"text": "1 failures in 888 pushes (0.001 failures/push) were associated with this bug in the last 7 days.   \n\nRepository breakdown:\n* autoland: 1\n\nPlatform breakdown:\n* linux64: 1\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2017-07-31&endday=2017-08-06&tree=all", "author": "orangefactor@bots.tld", "id": 12541788, "time": "2017-08-07T01:29:42Z"}, {"text": "1 failures in 939 pushes (0.001 failures/push) were associated with this bug in the last 7 days.   \n\nRepository breakdown:\n* autoland: 1\n\nPlatform breakdown:\n* linux32: 1\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2017-08-28&endday=2017-09-03&tree=all", "author": "orangefactor@bots.tld", "id": 12625787, "time": "2017-09-04T02:03:14Z"}, {"text": "1 failures in 1032 pushes (0.001 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* try: 1\n\nPlatform breakdown:\n* linux64: 1\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2017-09-11&endday=2017-09-17&tree=all", "author": "orangefactor@bots.tld", "id": 12675789, "time": "2017-09-18T01:52:00Z"}, {"text": "1 failures in 792 pushes (0.001 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* mozilla-inbound: 1\n\nPlatform breakdown:\n* linux64: 1\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2017-11-27&endday=2017-12-03&tree=all", "author": "orangefactor@bots.tld", "id": 12893703, "time": "2017-12-04T01:44:43Z"}, {"text": "2 failures in 590 pushes (0.003 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* try: 2\n\nPlatform breakdown:\n* linux64-qr: 1\n* linux64: 1\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2017-12-18&endday=2017-12-24&tree=all", "author": "orangefactor@bots.tld", "id": 12935390, "time": "2017-12-25T01:16:57Z"}, {"text": "1 failures in 147 pushes (0.007 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* autoland: 1\n\nPlatform breakdown:\n* linux64: 1\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2017-12-25&endday=2017-12-31&tree=all", "author": "orangefactor@bots.tld", "id": 12939214, "time": "2018-01-01T01:08:59Z"}, {"text": "This seems to be turning up \u201cfor real\u201d now that we're using the broker on desktop: see bug 1420475 and bug 1421201.  I added a log message in bug 1422198 for the case where sendmsg() fails, but it's not happening.  So the message is sent but never arrives.\n\nI believe we're using much newer kernels for CI now (new enough to include unprivileged user namespaces and seccomp thread sync, at least), so the last part of comment #2 is probably not it.\n\nI suppose it could be a kernel \u201cfeature\u201d, like if it's not guaranteed that the sendmsg->close->recvmsg ordering won't drop the message but in practice that happens only in some odd edge case, but I don't know how much sense that makes.  (That *is* a problem with TCP, if the data is buffered locally but not transmitted yet \u2014 see http://blog.csdn.net/CPP_CHEN/article/details/29864509 \u2014 but there's no reason that would apply to AF_UNIX.  In any case, Chromium is doing the same thing we are, although they may not be using this kind of brokering as much as we do.)\n\nIn another bug I was speculating about a double-close or use-after-close bug somewhere, but I'm having trouble coming up with a plausible scenario where we wouldn't at least sometimes see actual errors, not just the message disappearing.\n\nIf the \u201cmissing\u201d message was getting written to the wrong request's response socket, *after* the correct response was sent (these tests, if I recall correctly from when I wrote them years ago, try to check for concurrent requests getting their responses swapped), then that would show up like this.  But I don't have a plausible mechanism for how a bug would get us into that state without sometimes causing other failures instead.  This at least would be relatively easy to test: do a second recvmsg in the client and assert that it gets EOF.\n\nI'm really just guessing at this point.", "author": "jld@mozilla.com", "id": 12948618, "time": "2018-01-06T00:18:33Z"}, {"text": "One thing I notice, in the 4 instances we still have logs for, are the loop counters:\n\nLoop 10000/10000 @ /builds/worker/workspace/build/src/security/sandbox/linux/gtest/TestBroker.cpp:419\nLoop 674/10000 @ /home/worker/workspace/build/src/security/sandbox/linux/gtest/TestBroker.cpp:408\nLoop 9397/10000 @ /builds/worker/workspace/build/src/security/sandbox/linux/gtest/TestBroker.cpp:420\nLoop 42/10000 @ /builds/worker/workspace/build/src/security/sandbox/linux/gtest/TestBroker.cpp:419\n\nThey're all near the beginning or end of the loop (so maybe when other threads are starting/exiting?), and one of them is the last of 10k iterations which is kind of suspect just by itself.\n\n\n(Also, the canonical version of that article about TCP seems to be https://blog.netherlabs.nl/articles/2009/01/18/the-ultimate-so_linger-page-or-why-is-my-tcp-not-reliable )", "author": "jld@mozilla.com", "id": 12948651, "time": "2018-01-06T00:42:27Z"}, {"text": "2 failures in 462 pushes (0.004 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* mozilla-central: 1\n* autoland: 1\n\nPlatform breakdown:\n* linux64-qr: 1\n* linux64: 1\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2018-01-01&endday=2018-01-07&tree=all", "author": "orangefactor@bots.tld", "id": 12950356, "time": "2018-01-08T01:15:52Z"}, {"text": "Something that's worth trying: burn a few CPU-hours trying to reproduce this locally under rr.  If it replays, then I can try to see what's going on with the file descriptors.  Or, if the replay diverges, that would suggest a kernel bug.", "author": "jld@mozilla.com", "id": 12962542, "time": "2018-01-11T21:12:46Z"}, {"text": "2 failures in 788 pushes (0.003 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* try: 1\n* mozilla-inbound: 1\n\nPlatform breakdown:\n* linux64: 2\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2018-01-08&endday=2018-01-14&tree=all", "author": "orangefactor@bots.tld", "id": 12968936, "time": "2018-01-15T01:47:20Z"}, {"text": "*** Bug 1433135 has been marked as a duplicate of this bug. ***", "author": "jld@mozilla.com", "id": 12994909, "time": "2018-01-25T16:48:46Z"}, {"text": "I did run this a few dozen times in rr (with and without chaos mode), but it turns out to be essentially a worst case for recording overhead because it's almost all context switches and nontrivial syscalls; see https://github.com/mozilla/rr/issues/2159\n\nAnd I haven't reproduced it yet, but it's possible that letting it run for longer might help\u2026.", "author": "jld@mozilla.com", "id": 12995155, "time": "2018-01-25T17:54:58Z"}, {"text": "I've run this about 1,000 times under rr now, and the bug hasn't happened.  I also tried running it 1,000 times locally *not* under rr, and\u2026 the bug also didn't reproduce.  So this may not be a useful approach.", "author": "jld@mozilla.com", "id": 13003369, "time": "2018-01-29T20:53:10Z"}, {"text": "1 failures in 735 pushes (0.001 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* mozilla-inbound: 1\n\nPlatform breakdown:\n* linux32: 1\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2018-01-29&endday=2018-02-04&tree=all", "author": "orangefactor@bots.tld", "id": 13017332, "time": "2018-02-05T01:16:39Z"}, {"text": "2 failures in 702 pushes (0.003 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* try: 1\n* mozilla-inbound: 1\n\nPlatform breakdown:\n* linux64-qr: 1\n* linux32: 1\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2018-02-05&endday=2018-02-11&tree=all", "author": "orangefactor@bots.tld", "id": 13034271, "time": "2018-02-12T01:15:30Z"}, {"text": "1 failures in 685 pushes (0.001 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* mozilla-inbound: 1\n\nPlatform breakdown:\n* linux64: 1\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2018-02-12&endday=2018-02-18&tree=all", "author": "orangefactor@bots.tld", "id": 13051151, "time": "2018-02-19T01:15:50Z"}, {"text": "1 failures in 831 pushes (0.001 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* mozilla-central: 1\n\nPlatform breakdown:\n* linux64-qr: 1\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2018-02-26&endday=2018-03-04&tree=all", "author": "orangefactor@bots.tld", "id": 13102023, "time": "2018-03-05T01:20:05Z"}, {"text": "1 failures in 747 pushes (0.001 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* mozilla-central: 1\n\nPlatform breakdown:\n* linux64: 1\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2018-03-05&endday=2018-03-11&tree=all", "author": "orangefactor@bots.tld", "id": 13120398, "time": "2018-03-12T01:20:36Z"}, {"text": "2 failures in 814 pushes (0.002 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* mozilla-inbound: 2\n\nPlatform breakdown:\n* linux64: 2\n\nFor more details, see:\nhttps://brasstacks.mozilla.com/orangefactor/?display=Bug&bugid=1243108&startday=2018-03-12&endday=2018-03-18&tree=all", "author": "orangefactor@bots.tld", "id": 13138035, "time": "2018-03-19T01:52:01Z"}, {"text": "1 failures in 822 pushes (0.001 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* autoland: 1\n\nPlatform breakdown:\n* linux64: 1\n\nFor more details, see:\nhttps://treeherder.mozilla.org/intermittent-failures.html#/bugdetails?bug=1243108&startday=2018-03-20&endday=2018-03-26&tree=trunk", "author": "orangefactor@bots.tld", "id": 13159850, "time": "2018-03-27T17:23:18Z"}, {"text": "1 failures in 792 pushes (0.001 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* mozilla-inbound: 1\n\nPlatform breakdown:\n* linux32: 1\n\nFor more details, see:\nhttps://treeherder.mozilla.org/intermittent-failures.html#/bugdetails?bug=1243108&startday=2018-04-09&endday=2018-04-15&tree=trunk", "author": "orangefactor@bots.tld", "id": 13207461, "time": "2018-04-16T01:14:41Z"}, {"text": "2 failures in 782 pushes (0.003 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* autoland: 2\n\nPlatform breakdown:\n* linux32: 2\n\nFor more details, see:\nhttps://treeherder.mozilla.org/intermittent-failures.html#/bugdetails?bug=1243108&startday=2018-04-16&endday=2018-04-22&tree=trunk", "author": "orangefactor@bots.tld", "id": 13224913, "time": "2018-04-23T01:14:59Z"}, {"text": "Unfortunately, this doesn't seem to have been a double-close caused by bug 1278361, because we're still seeing it.  (This isn't a big surprise \u2014 see earlier comments that the observables here don't make sense for that kind of bug \u2014 but it sure would have been convenient if it had mysteriously been fixed.  Sigh.)\n\nAlso, bug 1456022 seems to be another manifestation of this.", "author": "jld@mozilla.com", "id": 13227543, "time": "2018-04-23T19:39:44Z"}, {"text": "I can reproduce this locally, given an hour or two: I increased the loop count in the tests by 10x (to amortize startup/shtudown/scripting overhead) and ran mach gtest in a shell loop, with an opt build, and got 1 hit in ~400 runs; a debug build also worked but took a lot longer (1 in ~1800).  Note that this roughly corresponds to 4,000 opt runs of the normal test.\n\nSo, things that can be done:\n\n* Send one or more fake responses with a fictitious error code (or otherwise marked) after the real response, so the client can detect the case where the response was lost.  This assumes that whatever is happening is a more-or-less independent chance per message, not some property of the response socket itself.\n\n* Send the real response multiple times, to work around lost responses if that's what's going on.  (I hope we won't have to do that.)\n\n* If I can be sufficiently sure that an unexpected EOF means the request was never received (see above), add a retry loop in the client.  (Retrying operations that may or may not have already happened is\u2026 delicate, and I don't want to go there if I don't have to; see also NFS.)\n\n* Add a variant of the multithread test where the clients alternate opening a per-thread temp file with O_CREAT | O_EXCL and unlinking it \u2014 either a dropped request or a duplicated one will cause an error.  (mkdir + rmdir would also work.)", "author": "jld@mozilla.com", "id": 13233660, "time": "2018-04-25T20:38:54Z"}, {"text": "(In reply to Jed Davis [:jld] (\u23f0UTC-6) from comment #40)\n> * Send one or more fake responses with a fictitious error code (or otherwise\n> marked) after the real response, so the client can detect the case where the\n> response was lost.\n\nI did this and ran it overnight: 4 hits in ~1600 runs, all of them apparently a lost request rather than a lost response.\n\n> * Add a variant of the multithread test where the clients alternate opening\n> a per-thread temp file with O_CREAT | O_EXCL and unlinking it \u2014 either a\n> dropped request or a duplicated one will cause an error.  (mkdir + rmdir\n> would also work.)\n\nI did this (both creat+unlink and mkdir+rmdir) and ran it all afternoon and evening, and I got one error after 1388 runs (~2.78e9 broker calls) \u2014 a lost rmdir that succeeded when reissued.  Changing the operations seems to affect the error rate; this may be significant.\n\nBut that test closed the file before the unlink.  I modified it to close the file last (so that it's the broker client thread and not the server that causes the inode to be freed), and it's failed twice in only 160 iterations (80e6 calls): one a lost unlink that succeeded on retry, and one a lost open that did *not* \u2014 it failed with EEXIST.  And that's *with* the change to add a second response.  So now this is making even less sense than it did before.\n\n\nAnother possibility here is writing a self-contained C program that does the same socket operations as the broker test and run *that* for a few hours, to try to rule out everything else in Gecko and maybe point toward a kernel bug.", "author": "jld@mozilla.com", "id": 13237429, "time": "2018-04-27T04:53:22Z"}, {"text": "(In reply to Jed Davis [:jld] (\u23f0UTC-6) from comment #41)\n> So now this is making even less sense than it did before.\n\nIt turns out I messed up the retry logic a little.  The open was retried, but the unlink (and rmdir from the earlier test) weren't.  So this means the requests *are* being received, but the responses are lost, even when multiple responses are sent.  This suggests that something is happening to the socket that's passed to the parent (but not to the non-socket fds passed back for the open test).\n\nThe creat+unlink+close test continues to be much more effective than the creat+close+unlink or mkdir+rmdir: 11 failures in 3041 runs (one per ~2.76e8 calls, or ~10x the rate).  4 were failed opens that failed with EEXIST when retried, and 7 were failed unlinks that did observably unlink.", "author": "jld@mozilla.com", "id": 13238653, "time": "2018-04-27T16:45:22Z"}, {"text": "1 failures in 780 pushes (0.001 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* mozilla-beta: 1\n\nPlatform breakdown:\n* linux64: 1\n\nFor more details, see:\nhttps://treeherder.mozilla.org/intermittent-failures.html#/bugdetails?bug=1243108&startday=2018-04-23&endday=2018-04-29&tree=trunk", "author": "orangefactor@bots.tld", "id": 13241140, "time": "2018-04-30T01:15:08Z"}, {"text": "New findings:\n\n* Extra assertions (for short reads/writes, close() failing) don't fire, but do seem to reduce the repro rate, even though it's a handful of arithmetic ops and a predicatable branch or two in a path that includes a nontrivial syscall, so it shouldn't be throwing off timing all that much.  Needs more data.\n\n* Setting the response socket nonblocking and spamming extra responses until there's an error doesn't help; none of them are received.  This probably wasn't too surprising given previous results.\n\n* The response socket's inode number in the server after it sends the reply is the same as what the client sees immediately after the socketpair() call.  (I modified the broker requests to include the inode number.)  I haven't yet tested the client end of the socket the same way; I could, but I'm doubtful.\n\n* It doesn't appear to be a soundness bug in the Linux kernel's socket GC.  (Because sockets can be held in queued SCM_RIGHTS messages in sockets, there can be reference cycles; the kernel has a cycle collector that breaks cycles by, if I understand correctly, removing and destroying the socket buffer.)  This was tested by using ftrace to log calls to kfree_skb; a call from unix_gc can be seen when running a test program that creates a one-socket cycle, but not when the gtests fail.  (kfree_skb doesn't appear to be called for the normal socket destruction caused by the broker, so the log is low-traffic enough to read manually \u2014 about 19 calls per test run \u2014 and doesn't appear to have lost messages due to buffer overrun).\n\n* I also tried doing a second recvmsg on both sides and asserting that they got EOF, to try to detect messages possibly being sent to the wrong socket somehow.  To make that not deadlock, I also added shutdown(fd, SHUT_WR) calls.  With that build, the bug hasn't reproduced once in 6.0e9 broker calls.\n\nIf that last result holds up, and if I can troubleshoot it down to a smaller part of the change\u2026 I don't *like* making changes without understanding why, but I could.", "author": "jld@mozilla.com", "id": 13243941, "time": "2018-04-30T18:26:50Z"}, {"text": "*** Bug 1456022 has been marked as a duplicate of this bug. ***", "author": "jld@mozilla.com", "id": 13245161, "time": "2018-05-01T00:40:11Z"}, {"text": "Created attachment 8972766\nSimplified standalone test case\n\nI wrote a small C program to try to reproduce this without the overhead of Gecko.  It works *very* well \u2014 it takes about 60 runs (60 million RPCs) per failure on average, but with a lot of variance (which is expected for an exponential distribution).  This is partially due to giving each client a separate dup() of the client fd; if I don't do that, it took 448 runs before the first failure.  That may be due to lock contention on the fd vs. just on the underlying socket changing the timing.\n\nIt doesn't seem to reproduce at all (not observed in 3000 runs) if confined to a single core.  It also didn't reproduce in 136 runs under rr chaos mode (where it's 60x slower).\n\nAdding a SHUT_WR on the response socket after sending and before closing reduces but doesn't eliminate it: the first failure was after 300 runs.\n\nSo I added a sched_yield in that spot, and it lasted 1171 runs.  This suggests experimenting with ensuring that the last close on the sending end of the response socket happens-after the receive \u2014 sending a dup of it back to the client in a second message, or doing a blocking read on it (expecting EOF) before closing.", "author": "jld@mozilla.com", "id": 13251203, "time": "2018-05-03T04:57:51Z"}, {"text": "I tested with a change to make the server wait for EOF from the client, and that seems to avoid the bug (no failures in 4 billion RPCs).  It also doubles the wall time, although it might not affect latency in practice if we're not getting multithreaded back-to-back requests.\n\nThe approach of sending the socket back to the client (in a message that will either be dropped on client close, or fail to be sent if the client closes first) also holds up: it ran for 14.4 billion RPCs without failing.  That change actually *decreases* wall time slightly for some reason, although total CPU time increased somewhat.\n\nFor comparison, I also tried running the unmodified test case on FreeBSD; it ran for 13.8 billion RPCs with no failures.", "author": "jld@mozilla.com", "id": 13255980, "time": "2018-05-04T22:48:50Z"}, {"text": "As for *why* this is happening, I think I finally have an explanation:\n\n1. (server) recvmsg calls __skb_try_recv_datagram, sees no pending data, and prepares to sleep\n2. (client) sendmsg calls skb_queue_tail to append the packet to the peer's receive queue\n3. (client) close \u2192 fput \u2192 unix_release_sock sets the peer's sk_shutdown field to the equivalent of SHUT_RDWR\n4. (server) recvmsg calls __skb_wait_for_more_packets, which reads sk_shutdown and indicates EOF\n\nCorresponding source lines:\n\n[1] https://github.com/torvalds/linux/blob/06dd3dfeea60e2a6457a6aedf97afc8e6d2ba497/net/unix/af_unix.c#L2098\n[2] https://github.com/torvalds/linux/blob/06dd3dfeea60e2a6457a6aedf97afc8e6d2ba497/net/unix/af_unix.c#L1797\n[3] https://github.com/torvalds/linux/blob/06dd3dfeea60e2a6457a6aedf97afc8e6d2ba497/net/unix/af_unix.c#L540\n[4] https://github.com/torvalds/linux/blob/06dd3dfeea60e2a6457a6aedf97afc8e6d2ba497/net/core/datagram.c#L102", "author": "jld@mozilla.com", "id": 13256000, "time": "2018-05-04T23:15:46Z"}, {"text": "*** Bug 1421201 has been marked as a duplicate of this bug. ***", "author": "jld@mozilla.com", "id": 13259910, "time": "2018-05-07T16:34:03Z"}, {"text": "*** Bug 1420475 has been marked as a duplicate of this bug. ***", "author": "jld@mozilla.com", "id": 13259912, "time": "2018-05-07T16:34:42Z"}, {"text": "*** Bug 1442989 has been marked as a duplicate of this bug. ***", "author": "jld@mozilla.com", "id": 13259914, "time": "2018-05-07T16:35:05Z"}, {"text": "*** Bug 1439140 has been marked as a duplicate of this bug. ***", "author": "jld@mozilla.com", "id": 13259917, "time": "2018-05-07T16:35:36Z"}, {"text": "*** Bug 1459553 has been marked as a duplicate of this bug. ***", "author": "jld@mozilla.com", "id": 13259921, "time": "2018-05-07T16:36:04Z"}, {"text": "1 failures in 660 pushes (0.002 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* mozilla-inbound: 1\n\nPlatform breakdown:\n* linux64: 1\n\nFor more details, see:\nhttps://treeherder.mozilla.org/intermittent-failures.html#/bugdetails?bug=1243108&startday=2018-05-07&endday=2018-05-13&tree=trunk", "author": "orangefactor@bots.tld", "id": 13273741, "time": "2018-05-14T01:14:01Z"}, {"text": "1 failures in 639 pushes (0.002 failures/push) were associated with this bug in the last 7 days.    \n\nRepository breakdown:\n* mozilla-release: 1\n\nPlatform breakdown:\n* linux32: 1\n\nFor more details, see:\nhttps://treeherder.mozilla.org/intermittent-failures.html#/bugdetails?bug=1243108&startday=2018-05-14&endday=2018-05-20&tree=trunk", "author": "orangefactor@bots.tld", "id": 13292220, "time": "2018-05-21T01:15:47Z"}], "id": 1243108, "priority": "P1", "cc": ["gpascutto@mozilla.com", "hikezoe@mozilla.com", "hskupin@gmail.com", "intermittent-bug-filer@mozilla.bugs", "jld@mozilla.com", "jmathies@mozilla.com", "kilik.kuo@gmail.com"], "cf_crash_signature": "", "version": "43 Branch", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_thunderbird_esr60": "---", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1257239], "qa_contact": "", "creation_time": "2016-01-26T20:05:31Z", "cf_status_firefox_esr52": "---", "component": "Security: Process Sandboxing", "assigned_to_detail": {"email": "jld@mozilla.com", "id": 462836, "name": "jld@mozilla.com", "real_name": "Jed Davis [:jld] (\u23f0UTC-6)"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox49": "wontfix", "cf_status_firefox48": "wontfix", "cf_status_firefox62": "---", "cf_status_firefox61": "---", "cf_status_firefox60": "---", "target_milestone": "---", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "kwierso@gmail.com", "id": 308534, "name": "kwierso@gmail.com", "real_name": "Wes Kocher (:KWierso)"}, "whiteboard": "sb+", "mentors": [], "cc_detail": [{"email": "gpascutto@mozilla.com", "id": 151147, "name": "gpascutto@mozilla.com", "real_name": "Gian-Carlo Pascutto [:gcp]"}, {"email": "hikezoe@mozilla.com", "id": 131213, "name": "hikezoe@mozilla.com", "real_name": "Hiroyuki Ikezoe (:hiro)"}, {"email": "hskupin@gmail.com", "id": 76551, "name": "hskupin@gmail.com", "real_name": "Henrik Skupin (:whimboo)"}, {"email": "intermittent-bug-filer@mozilla.bugs", "id": 573381, "name": "intermittent-bug-filer@mozilla.bugs", "real_name": "Treeherder Bug Filer"}, {"email": "jld@mozilla.com", "id": 462836, "name": "jld@mozilla.com", "real_name": "Jed Davis [:jld] (\u23f0UTC-6)"}, {"email": "jmathies@mozilla.com", "id": 279663, "name": "jmathies@mozilla.com", "real_name": "Jim Mathies [:jimm]"}, {"email": "kilik.kuo@gmail.com", "id": 505627, "name": "kilik.kuo@gmail.com", "real_name": "Kilik Kuo [:kikuo] (inactive)"}], "attachments": [{"creator": "jld@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/plain", "id": 8972766}], "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-05-21T01:15:47Z", "cf_status_firefox_esr60": "---", "assigned_to": "jld@mozilla.com", "is_open": true, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "jld@mozilla.com"}], "who": "jld@mozilla.com", "when": "2016-01-27T22:00:07Z"}, {"changes": [{"removed": "Security", "field_name": "component", "added": "Security: Process Sandboxing"}], "who": "jld@mozilla.com", "when": "2016-01-27T22:41:23Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "hiikezoe@mozilla-japan.org"}], "who": "jld@mozilla.com", "when": "2016-02-08T18:47:28Z"}, {"changes": [{"removed": "Intermittent SandboxBrokerTest.MultiThreadOpen | Expected: (zerofd) >= (0), actual: -5 vs 0 | test completed (time: 1198ms)", "field_name": "summary", "added": "Intermittent SandboxBrokerTest.MultiThreadOpen or SandboxBrokerTest.MultiThreadStat | Expected: (zerofd) >= (0), actual: -5 vs 0 | test completed (time: 1198ms)"}], "who": "jld@mozilla.com", "when": "2016-02-08T18:47:47Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "jmathies@mozilla.com"}, {"removed": "", "field_name": "blocks", "added": "1257239"}, {"removed": "", "field_name": "whiteboard", "added": "sb+"}], "who": "jmathies@mozilla.com", "when": "2016-03-23T16:00:39Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "intermittent-bug-filer@mozilla.bugs"}], "who": "jld@mozilla.com", "when": "2016-08-16T17:27:27Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P3"}], "who": "automation@bmo.tld", "when": "2016-09-01T18:57:58Z"}, {"changes": [{"removed": "---", "field_name": "cf_status_firefox48", "added": "wontfix"}, {"removed": "---", "field_name": "cf_status_firefox49", "added": "wontfix"}, {"removed": "---", "field_name": "cf_status_firefox50", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox51", "added": "affected"}], "who": "ryanvm@gmail.com", "when": "2016-09-19T02:29:37Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1317084"}], "who": "aryx.bugmail@gmx-topmail.de", "when": "2016-11-12T20:36:58Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1317084"}], "who": "jmathies@mozilla.com", "when": "2016-11-17T16:29:55Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "gpascutto@mozilla.com"}], "who": "gpascutto@mozilla.com", "when": "2016-11-17T16:30:50Z"}, {"changes": [{"removed": "Intermittent SandboxBrokerTest.MultiThreadOpen or SandboxBrokerTest.MultiThreadStat | Expected: (zerofd) >= (0), actual: -5 vs 0 | test completed (time: 1198ms)", "field_name": "summary", "added": "Intermittent SandboxBrokerTest.MultiThreadOpen or SandboxBrokerTest.MultiThreadStat | Expected: (zerofd) >= (0) or (nullfd) >= (0), actual: -5 vs 0 | test completed (time: 1198ms)"}], "who": "jld@mozilla.com", "when": "2016-11-17T19:51:24Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "aryx.bugmail@gmx-topmail.de"}], "who": "jld@mozilla.com", "when": "2016-11-17T19:52:22Z"}, {"changes": [{"removed": "aryx.bugmail@gmx-topmail.de", "field_name": "cc", "added": ""}], "who": "aryx.bugmail@gmx-topmail.de", "when": "2016-11-17T20:19:16Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1421201"}], "who": "jld@mozilla.com", "when": "2018-01-05T23:51:21Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1420475"}, {"removed": "sb+", "field_name": "whiteboard", "added": "sb?"}], "who": "jld@mozilla.com", "when": "2018-01-06T00:18:33Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(jld@mozilla.com)"}], "who": "jld@mozilla.com", "when": "2018-01-11T21:12:46Z"}, {"changes": [{"removed": "needinfo?(jld@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "jld@mozilla.com", "when": "2018-01-29T20:53:10Z"}, {"changes": [{"removed": "sb?", "field_name": "whiteboard", "added": "sb+"}], "who": "jmathies@mozilla.com", "when": "2018-02-01T16:42:42Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1442989"}], "who": "jld@mozilla.com", "when": "2018-04-10T16:34:03Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1439140"}], "who": "jld@mozilla.com", "when": "2018-04-10T16:42:26Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1456022"}], "who": "jld@mozilla.com", "when": "2018-04-23T19:39:57Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "hskupin@gmail.com"}], "who": "hskupin@gmail.com", "when": "2018-04-23T21:04:51Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "jld@mozilla.com"}], "who": "jld@mozilla.com", "when": "2018-05-03T04:57:51Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1459553"}], "who": "jld@mozilla.com", "when": "2018-05-07T16:21:47Z"}, {"changes": [{"removed": "P3", "field_name": "priority", "added": "P1"}, {"removed": "Intermittent SandboxBrokerTest.MultiThreadOpen or SandboxBrokerTest.MultiThreadStat | Expected: (zerofd) >= (0) or (nullfd) >= (0), actual: -5 vs 0 | test completed (time: 1198ms)", "field_name": "summary", "added": "Intermittent failure to receive sandbox broker responses (SandboxBrokerTest.MultiThreadOpen, SandboxBrokerTest.MultiThreadStat, or \u201cSandbox: Unexpected EOF\u201d by itself near non-shutdown crashes)"}], "who": "jld@mozilla.com", "when": "2018-05-07T16:33:06Z"}, {"changes": [{"removed": "https://bugzilla.mozilla.org/show_bug.cgi?id=1421201", "field_name": "see_also", "added": ""}, {"removed": "", "field_name": "cc", "added": "kilik.kuo@gmail.com"}], "who": "jld@mozilla.com", "when": "2018-05-07T16:34:03Z"}, {"changes": [{"removed": "https://bugzilla.mozilla.org/show_bug.cgi?id=1420475", "field_name": "see_also", "added": ""}], "who": "jld@mozilla.com", "when": "2018-05-07T16:34:42Z"}, {"changes": [{"removed": "https://bugzilla.mozilla.org/show_bug.cgi?id=1442989", "field_name": "see_also", "added": ""}], "who": "jld@mozilla.com", "when": "2018-05-07T16:35:04Z"}, {"changes": [{"removed": "https://bugzilla.mozilla.org/show_bug.cgi?id=1439140", "field_name": "see_also", "added": ""}], "who": "jld@mozilla.com", "when": "2018-05-07T16:35:36Z"}, {"changes": [{"removed": "https://bugzilla.mozilla.org/show_bug.cgi?id=1459553", "field_name": "see_also", "added": ""}], "who": "jld@mozilla.com", "when": "2018-05-07T16:36:04Z"}, {"changes": [{"removed": "https://bugzilla.mozilla.org/show_bug.cgi?id=1317084, https://bugzilla.mozilla.org/show_bug.cgi?id=1456022", "field_name": "see_also", "added": ""}, {"removed": "affected", "field_name": "cf_status_firefox50", "added": "wontfix"}, {"removed": "affected", "field_name": "cf_status_firefox51", "added": "wontfix"}], "who": "jld@mozilla.com", "when": "2018-05-07T16:37:16Z"}, {"changes": [{"removed": "1317084", "field_name": "blocks", "added": ""}], "who": "jld@mozilla.com", "when": "2018-05-07T16:37:30Z"}], "resolution": "", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}