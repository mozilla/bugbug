{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "classification": "Components", "creator": "kmaglione+bmo@mozilla.com", "cc": ["continuation@gmail.com", "gijskruitbosch+bugs@gmail.com"], "depends_on": [1456035], "creation_time": "2018-05-08T23:21:06Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": [], "summary": "Add ESLint rule to prevent new usage of XPCOMUtils.generateQI and JS-implemented QueryInterface methods", "cf_last_resolved": "2018-05-10T16:49:00Z", "attachments": [{"creator": "kmaglione+bmo@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2018-05-09T07:42:46Z", "type_id": 4, "creation_date": "2018-05-09T01:42:15Z", "id": 1754375, "setter": "gijskruitbosch+bugs@gmail.com"}], "content_type": "text/x-review-board-request", "id": 8974231}], "assigned_to_detail": {"email": "kmaglione+bmo@mozilla.com", "id": 106098, "name": "kmaglione+bmo@mozilla.com", "real_name": "Kris Maglione [:kmag]"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "comments": [{"text": "Bug 1456035 added a ChromeUtils.generateQI helper, which is much more efficient than JS-implemented QueryInterface methods. XPCOMUtils.generateQI is currently an alias for that method, and should be removed in the near future.\n\nIn the mean time, we should add an ESLint rule to prevent people from manually implementing QueryInterface functions, or using XPCOMUtils.generateQI.", "author": "kmaglione+bmo@mozilla.com", "id": 13264029, "time": "2018-05-08T23:21:06Z"}, {"text": "Created attachment 8974231\nBug 1460092: Add ESLint rule to enforce use of ChromeUtils.generateQI.\n\nAlso fixes existing code which fails the rule.\n\nReview commit: https://reviewboard.mozilla.org/r/242532/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/242532/", "author": "kmaglione+bmo@mozilla.com", "id": 13264235, "time": "2018-05-09T01:42:15Z"}, {"text": "Comment on attachment 8974231\nBug 1460092: Add ESLint rule to enforce use of ChromeUtils.generateQI.\n\nhttps://reviewboard.mozilla.org/r/242532/#review248434\n\nThanks!\n\n::: devtools/server/actors/csscoverage.js:106\n(Diff revision 1)\n>      this._running = true;\n>      this._tooManyUnused = false;\n>  \n>      this._progressListener = {\n> -      QueryInterface: XPCOMUtils.generateQI([ Ci.nsIWebProgressListener,\n> +      QueryInterface: ChromeUtils.generateQI([ Ci.nsIWebProgressListener,\n>                                                Ci.nsISupportsWeakReference ]),\n\nNit: alignment.\n\n::: toolkit/components/passwordmgr/test/mochitest/test_prompt_promptAuth_proxy.html:83\n(Diff revision 1)\n>  var resolveCallback = SpecialPowers.wrapCallbackObject({\n>    QueryInterface(iid) {\n\nGiven that this doesn't work with SpecialPowers, I wonder if it makes sense to disable the rule for all mochitest-plain tests. I believe this is possible by adding it at the bottom of https://dxr.mozilla.org/mozilla-central/source/tools/lint/eslint/eslint-plugin-mozilla/lib/configs/mochitest-test.js ? That might save a number of `// eslint-disable` statements, and/or confusion for future consumers. I don't much care either way, but figured I'd flag this up.\n\n::: toolkit/content/widgets/editor.xml:28\n(Diff revision 1)\n>        </constructor>\n>        <destructor/>\n>  \n>        <field name=\"_editorContentListener\">\n>          <![CDATA[\n> +          /* eslint-disable mozilla/use-chromeutils-generateqi */\n\nFor the XBL binding, are we not able to rely on ChromeUtils being present, or something? Seems a bit odd... we should only be using these in privileged scopes, so it should be available, right?\n\n::: tools/lint/eslint/eslint-plugin-mozilla/lib/rules/use-chromeutils-generateqi.js:59\n(Diff revision 1)\n> +        if (node.callee.type !== \"MemberExpression\") {\n> +          return;\n> +        }\n\nI think you don't need this given you're calling `isMemberExpression` afterwards, and that does the same check.", "author": "gijskruitbosch+bugs@gmail.com", "id": 13264596, "time": "2018-05-09T07:42:46Z"}, {"text": "Comment on attachment 8974231\nBug 1460092: Add ESLint rule to enforce use of ChromeUtils.generateQI.\n\nhttps://reviewboard.mozilla.org/r/242532/#review248434\n\n> Given that this doesn't work with SpecialPowers, I wonder if it makes sense to disable the rule for all mochitest-plain tests. I believe this is possible by adding it at the bottom of https://dxr.mozilla.org/mozilla-central/source/tools/lint/eslint/eslint-plugin-mozilla/lib/configs/mochitest-test.js ? That might save a number of `// eslint-disable` statements, and/or confusion for future consumers. I don't much care either way, but figured I'd flag this up.\n\nI thought about it, but honestly, I hate that we do things like this in mochitests at all, so I decided to stick with the approach that adds more friction to it.\n\n> For the XBL binding, are we not able to rely on ChromeUtils being present, or something? Seems a bit odd... we should only be using these in privileged scopes, so it should be available, right?\n\nNo, it should work in XBL bindings. But `eslint --fix` does not work in XBL files, and XBL is going away anyway, so I decided o just stick with the simpler approach for now.", "author": "kmaglione+bmo@mozilla.com", "id": 13265758, "time": "2018-05-09T15:56:56Z"}, {"text": "Comment on attachment 8974231\nBug 1460092: Add ESLint rule to enforce use of ChromeUtils.generateQI.\n\nhttps://reviewboard.mozilla.org/r/242532/#review248434\n\n> No, it should work in XBL bindings. But `eslint --fix` does not work in XBL files, and XBL is going away anyway, so I decided o just stick with the simpler approach for now.\n\nI went ahead and manually converted these, anyway. It's been nagging at me that I didn't do it in the first place...", "author": "kmaglione+bmo@mozilla.com", "id": 13265979, "time": "2018-05-09T16:58:07Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/4dae882935055cd75a80139b0e17e232072b763c\nBug 1460092: Add ESLint rule to enforce use of ChromeUtils.generateQI. r=Gijs", "author": "kmaglione+bmo@mozilla.com", "id": 13266216, "time": "2018-05-09T18:19:05Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/5c5c9cc183a0a4cd14a4a16aab4ec228adbffb16\nBug 1460092: Follow-up: Fix eslint test failure caused by added comment. r=bustage CLOSED TREE", "author": "kmaglione+bmo@mozilla.com", "id": 13266286, "time": "2018-05-09T18:47:09Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/4dae88293505\nhttps://hg.mozilla.org/mozilla-central/rev/5c5c9cc183a0", "author": "ncsoregi@mozilla.com", "id": 13268735, "time": "2018-05-10T16:49:00Z"}], "id": 1460092, "priority": "--", "mentors_detail": [], "comment_count": 8, "cf_status_thunderbird_esr52": "---", "cf_qa_whiteboard": "", "version": "Version 3", "cf_tracking_firefox62": "---", "cf_platform_rel": "---", "product": "Firefox Build System", "cf_fx_iteration": "---", "blocks": [], "qa_contact": "", "see_also": [], "cf_status_firefox_esr52": "---", "component": "Lint and Formatting", "votes": 0, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "fixed", "cf_status_firefox61": "---", "cf_status_firefox60": "---", "target_milestone": "mozilla62", "is_cc_accessible": true, "cf_tracking_thunderbird_esr60": "---", "groups": [], "cf_tracking_firefox_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "kmaglione+bmo@mozilla.com", "id": 106098, "name": "kmaglione+bmo@mozilla.com", "real_name": "Kris Maglione [:kmag]"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "continuation@gmail.com", "id": 406194, "name": "continuation@gmail.com", "real_name": "Andrew McCreight [:mccr8]"}, {"email": "gijskruitbosch+bugs@gmail.com", "id": 159069, "name": "gijskruitbosch+bugs@gmail.com", "real_name": ":Gijs (he/him)"}], "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-05-10T16:49:00Z", "cf_status_firefox_esr60": "---", "assigned_to": "kmaglione+bmo@mozilla.com", "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "continuation@gmail.com"}], "who": "continuation@gmail.com", "when": "2018-05-08T23:54:11Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8974231, "added": "review?(gijskruitbosch+bugs@gmail.com)"}], "who": "kmaglione+bmo@mozilla.com", "when": "2018-05-09T01:42:15Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(gijskruitbosch+bugs@gmail.com)", "attachment_id": 8974231, "added": "review+"}], "who": "gijskruitbosch+bugs@gmail.com", "when": "2018-05-09T07:42:46Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla62"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-05-10 16:49:00"}, {"removed": "---", "field_name": "cf_status_firefox62", "added": "fixed"}], "who": "ncsoregi@mozilla.com", "when": "2018-05-10T16:49:00Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}