{"status": "RESOLVED", "cf_tracking_firefox60": "+", "cf_tracking_firefox61": "+", "classification": "Client Software", "creator": "snorp@snorp.net", "cc": ["abovens@mozilla.com", "bogdan.surd@softvision.ro", "cdenizet@mozilla.com", "dbolter@mozilla.com", "gsvelto@mozilla.com", "hskupin@gmail.com", "ioana.chiorean@softvision.ro", "jcristau@mozilla.com", "kbrosnan@mozilla.com", "lhenry@mozilla.com", "mcastelluccio@mozilla.com", "mh+mozilla@glandium.org", "michael.l.comella@gmail.com", "mozillamarcia.knous@gmail.com", "nalexander@mozilla.com", "nchen@mozilla.com", "nojun.park@gmail.com", "rtanglao@mozilla.com", "ryanvm@gmail.com", "sledru@mozilla.com", "snorp@snorp.net", "ted@mielczarek.org", "tgrabowski@mozilla.com"], "depends_on": [1450793], "creation_time": "2018-04-20T15:57:44Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "cf_status_firefox59": "wontfix", "keywords": [], "summary": "mprotect() failure in linker causing crashes on S8", "id": 1455662, "attachments": [{"creator": "snorp@snorp.net", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-25T17:36:27Z", "type_id": 4, "creation_date": "2018-04-20T15:59:53Z", "id": 1747005, "setter": "nchen@mozilla.com"}, {"status": "+", "name": "approval-mozilla-beta", "modification_date": "2018-04-30T15:09:41Z", "type_id": 721, "creation_date": "2018-04-30T15:07:57Z", "id": 1750662, "setter": "jcristau@mozilla.com"}, {"status": "+", "name": "approval-mozilla-release", "modification_date": "2018-04-30T15:09:41Z", "type_id": 737, "creation_date": "2018-04-30T15:09:41Z", "id": 1750663, "setter": "jcristau@mozilla.com"}], "content_type": "text/x-review-board-request", "id": 8969694}], "assigned_to_detail": {"email": "snorp@snorp.net", "id": 227322, "name": "snorp@snorp.net", "real_name": "James Willcox (:snorp) (jwillcox@mozilla.com)"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 16, "comments": [{"text": "+++ This bug was initially created as a clone of Bug #1450793 +++\n\nThis crash is showing up in high volume on the Play Store crash records but not on crash-stats, for Android 8.0 and up, on several different Galaxy S8 devices:\n\n\nsignal 11 (SIGSEGV), code 2 (SEGV_ACCERR)\nin libmozglue.so\n\n*** *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** pid: 0, tid: 0 >>> org.mozilla.firefox <<< backtrace:\n\n#00 pc 0000000000043d66 /data/app/org.mozilla.firefox-cEa3LWSWhqBfUNxUk_l7Jw==/lib/arm/libmozglue.so\n\nThese are the affected devices, \n\ndreamqlteue\ndream2qlteue\nSCV36\ndreamqltecan\ndream2qltecan\nAnd the Note8 (greatqlte) as well.", "author": "snorp@snorp.net", "id": 13221754, "time": "2018-04-20T15:57:44Z"}, {"text": "Created attachment 8969694\nBug 1455662 - Guard against mprotect() failure when manipulating link map\n\nReview commit: https://reviewboard.mozilla.org/r/238492/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/238492/", "author": "snorp@snorp.net", "id": 13221763, "time": "2018-04-20T15:59:53Z"}, {"text": "The patch from 1450793 has apparently not fixed things, so we need some other mitigation here. This patch should avoid the crash and will print the cause of the error. I think crash dumps may not be very useful from phones affected by this, but hopefully we'll get the logcat with the mprotect() error. This may allow us to figure out why it's failing.", "author": "snorp@snorp.net", "id": 13221778, "time": "2018-04-20T16:02:26Z"}, {"text": "Tracking since this is a potential mitigation for the spike in Fennec crashes for the 8.0 update to popular Samsung devices.", "author": "lhenry@mozilla.com", "id": 13221784, "time": "2018-04-20T16:06:20Z"}, {"text": "Comment on attachment 8969694\nBug 1455662 - Guard against mprotect() failure when manipulating link map\n\nhttps://reviewboard.mozilla.org/r/238492/#review244706\n\n::: mozglue/linker/ElfLoader.cpp:907\n(Diff revision 1)\n>  \n>      prot = getProt(start, &end);\n>      if (prot == -1 || (start + length) > end)\n>        MOZ_CRASH();\n>  \n>      if (prot & PROT_WRITE)\n\n`success` should be true in this case\n\n::: mozglue/linker/ElfLoader.cpp:908\n(Diff revision 1)\n>      prot = getProt(start, &end);\n>      if (prot == -1 || (start + length) > end)\n>        MOZ_CRASH();\n>  \n>      if (prot & PROT_WRITE)\n>        return;\n\n`success` will be uninitialized here\n\n::: mozglue/linker/ElfLoader.cpp:920\n(Diff revision 1)\n> +            page, length, prot | PROT_WRITE, ret,\n> +            errno, strerror(errno));\n> +    }\n> +  }\n> +\n> +  bool IsWritable() {\n\nconst\n\n::: mozglue/linker/ElfLoader.cpp:920\n(Diff revision 1)\n> +            page, length, prot | PROT_WRITE, ret,\n> +            errno, strerror(errno));\n> +    }\n> +  }\n> +\n> +  bool IsWritable() {\n\nconst\n\n::: mozglue/linker/ElfLoader.cpp:1000\n(Diff revision 1)\n>      firstAdded = map;\n>      /* When adding a library for the first time, r_map points to data\n>       * handled by the system linker, and that data may be read-only */\n>      EnsureWritable w(&dbg->r_map->l_prev);\n> +    if (!w.IsWritable()) {\n> +      return;\n\nWe will have corrupted state here if we return early.\n\n::: mozglue/linker/ElfLoader.cpp:1029\n(Diff revision 1)\n>      firstAdded = map->l_prev;\n>      /* When removing the first added library, its l_next is going to be\n>       * data handled by the system linker, and that data may be read-only */\n>      EnsureWritable w(&map->l_next->l_prev);\n> +    if (!w.IsWritable()) {\n> +      return;\n\nSame here", "author": "nchen@mozilla.com", "id": 13227386, "time": "2018-04-23T18:49:49Z"}, {"text": "Comment on attachment 8969694\nBug 1455662 - Guard against mprotect() failure when manipulating link map\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/238492/diff/1-2/", "author": "snorp@snorp.net", "id": 13230231, "time": "2018-04-24T17:24:26Z"}, {"text": "Comment on attachment 8969694\nBug 1455662 - Guard against mprotect() failure when manipulating link map\n\nhttps://reviewboard.mozilla.org/r/238492/#review245178\n\n::: mozglue/linker/ElfLoader.cpp:916\n(Diff revision 2)\n>  \n>      page = firstPage;\n> -    mprotect(page, length, prot | PROT_WRITE);\n> +    int ret = mprotect(page, length, prot | PROT_WRITE);\n> +    success = ret == 0;\n> +    if (!success) {\n> +      ERROR(\"mprotect(%p, %zu, %d) = %d %d %s\",\n\nnit: \"mprotect(%p, %zu, %o) = %d (errno=%d; %s)\"\n\n::: mozglue/linker/ElfLoader.cpp:1006\n(Diff revision 2)\n> +  dbg->r_state = r_debug::RT_ADD;\n> +  dbg->r_brk();\n\nThis actually needs to happen *before* touching dbg->r_map->l_prev.\n\n::: mozglue/linker/ElfLoader.cpp:1036\n(Diff revision 2)\n> +  dbg->r_state = r_debug::RT_DELETE;\n> +  dbg->r_brk();\n\nLikewise, this needs to happen before touching map->l_next->l_prev.", "author": "mh+mozilla@glandium.org", "id": 13231233, "time": "2018-04-24T22:38:15Z"}, {"text": "Comment on attachment 8969694\nBug 1455662 - Guard against mprotect() failure when manipulating link map\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/238492/diff/2-3/", "author": "snorp@snorp.net", "id": 13233020, "time": "2018-04-25T16:43:36Z"}, {"text": "Comment on attachment 8969694\nBug 1455662 - Guard against mprotect() failure when manipulating link map\n\nhttps://reviewboard.mozilla.org/r/238492/#review245396", "author": "nchen@mozilla.com", "id": 13233150, "time": "2018-04-25T17:36:27Z"}, {"text": "Pushed by jwillcox@mozilla.com:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/3c15a3b3c85a\nGuard against mprotect() failure when manipulating link map r=jchen", "author": "pulsebot@bots.tld", "id": 13233590, "time": "2018-04-25T20:07:12Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/3c15a3b3c85a", "author": "apavel@mozilla.com", "id": 13234469, "time": "2018-04-26T06:14:54Z"}, {"text": "Too late for 59, but we still want this on 60 as soon as we have verification that it helps with the crashes.", "author": "ryanvm@gmail.com", "id": 13239892, "time": "2018-04-28T16:28:30Z"}, {"text": "Looking at the play console, volume of SIGSEGV/SEGV_ACCERR in mozglue on nightly seems to have gone down the last few days, so it looks like this helped.  Please request uplift to m-r so we can get this in for 60.0.", "author": "jcristau@mozilla.com", "id": 13240120, "time": "2018-04-28T21:44:02Z"}, {"text": "Comment on attachment 8969694\nBug 1455662 - Guard against mprotect() failure when manipulating link map\n\nApproval Request Comment\n[Feature/Bug causing the regression]: Unknown\n[User impact if declined]: Startup crashes in some circumstances\n[Is this code covered by automated tests?]: Yes\n[Has the fix been verified in Nightly?]: No, we have no STR\n[Needs manual test from QE? If yes, steps to reproduce]:  No\n[List of other uplifts needed for the feature/fix]: None\n[Is the change risky?]: No\n[Why is the change risky/not risky?]: Only improves error handling\n[String changes made/needed]: None", "author": "snorp@snorp.net", "id": 13243353, "time": "2018-04-30T15:07:57Z"}, {"text": "Comment on attachment 8969694\nBug 1455662 - Guard against mprotect() failure when manipulating link map\n\nfennec startup crash fix, approved for 60rc and 60.0b17", "author": "jcristau@mozilla.com", "id": 13243359, "time": "2018-04-30T15:09:41Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-release/rev/dede96ad1e4f\nhttps://hg.mozilla.org/releases/mozilla-beta/rev/b28d01fdafa5e2c0d39dc389574bd7d6e4a0ffac (FIREFOX_60b_RELBRANCH)", "author": "aryx.bugmail@gmx-topmail.de", "id": 13243736, "time": "2018-04-30T17:13:58Z"}], "cf_last_resolved": "2018-04-26T06:14:54Z", "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "Firefox 59", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "+", "cf_tracking_firefox62": "---", "cf_platform_rel": "---", "product": "Firefox for Android", "cf_status_firefox_esr52": "---", "blocks": [], "qa_contact": "", "see_also": [], "cf_fx_iteration": "---", "component": "General", "votes": 0, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "fixed", "cf_status_firefox60": "fixed", "target_milestone": "Firefox 61", "is_cc_accessible": true, "cf_rank": null, "groups": [], "url": "", "creator_detail": {"email": "snorp@snorp.net", "id": 227322, "name": "snorp@snorp.net", "real_name": "James Willcox (:snorp) (jwillcox@mozilla.com)"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "abovens@mozilla.com", "id": 590636, "name": "abovens@mozilla.com", "real_name": "Andreas Bovens [:abovens]"}, {"email": "bogdan.surd@softvision.ro", "id": 563218, "name": "bogdan.surd@softvision.ro", "real_name": "Bogdan Surd, QA [:BogdanS, NI]"}, {"email": "cdenizet@mozilla.com", "id": 560431, "name": "cdenizet@mozilla.com", "real_name": "Calixte Denizet (:calixte)"}, {"email": "dbolter@mozilla.com", "id": 152868, "name": "dbolter@mozilla.com", "real_name": "David Bolter [:davidb] (NeedInfo me for attention)"}, {"email": "gsvelto@mozilla.com", "id": 448747, "name": "gsvelto@mozilla.com", "real_name": "Gabriele Svelto [:gsvelto]"}, {"email": "hskupin@gmail.com", "id": 76551, "name": "hskupin@gmail.com", "real_name": "Henrik Skupin (:whimboo)"}, {"email": "ioana.chiorean@softvision.ro", "id": 391404, "name": "ioana.chiorean@softvision.ro", "real_name": "Ioana Chiorean"}, {"email": "jcristau@mozilla.com", "id": 580382, "name": "jcristau@mozilla.com", "real_name": "Julien Cristau [:jcristau]"}, {"email": "kbrosnan@mozilla.com", "id": 406670, "name": "kbrosnan@mozilla.com", "real_name": "Kevin Brosnan [:kbrosnan]"}, {"email": "lhenry@mozilla.com", "id": 451704, "name": "lhenry@mozilla.com", "real_name": "Liz Henry (:lizzard) (needinfo? me)"}, {"email": "mcastelluccio@mozilla.com", "id": 420453, "name": "mcastelluccio@mozilla.com", "real_name": "Marco Castelluccio [:marco]"}, {"email": "mh+mozilla@glandium.org", "id": 47192, "name": "mh+mozilla@glandium.org", "real_name": "Mike Hommey [:glandium]"}, {"email": "michael.l.comella@gmail.com", "id": 441872, "name": "michael.l.comella@gmail.com", "real_name": "Michael Comella (:mcomella) [needinfo or I won't see it]"}, {"email": "mozillamarcia.knous@gmail.com", "id": 8519, "name": "mozillamarcia.knous@gmail.com", "real_name": "Marcia Knous [:marcia - needinfo? me]"}, {"email": "nalexander@mozilla.com", "id": 432887, "name": "nalexander@mozilla.com", "real_name": "Nick Alexander :nalexander"}, {"email": "nchen@mozilla.com", "id": 281508, "name": "nchen@mozilla.com", "real_name": "Jim Chen [:jchen] [:darchons]"}, {"email": "nojun.park@gmail.com", "id": 495885, "name": "nojun.park@gmail.com", "real_name": "N Park"}, {"email": "rtanglao@mozilla.com", "id": 352356, "name": "rtanglao@mozilla.com", "real_name": "Roland Tanglao needinfo please :rolandtanglao, :mohnkuchen, :adobo, :sinigang, :roland"}, {"email": "ryanvm@gmail.com", "id": 75935, "name": "ryanvm@gmail.com", "real_name": "Ryan VanderMeulen [:RyanVM]"}, {"email": "sledru@mozilla.com", "id": 495955, "name": "sledru@mozilla.com", "real_name": "Sylvestre Ledru [:sylvestre]"}, {"email": "snorp@snorp.net", "id": 227322, "name": "snorp@snorp.net", "real_name": "James Willcox (:snorp) (jwillcox@mozilla.com)"}, {"email": "ted@mielczarek.org", "id": 39022, "name": "ted@mielczarek.org", "real_name": "Ted Mielczarek [:ted.mielczarek]"}, {"email": "tgrabowski@mozilla.com", "id": 600289, "name": "tgrabowski@mozilla.com", "real_name": "Tom Grabowski [:TomGrab]"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-04-30T17:13:58Z", "cf_status_firefox_esr60": "---", "assigned_to": "snorp@snorp.net", "is_open": false, "history": [{"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8969694, "added": "review?(mh+mozilla@glandium.org)"}], "who": "snorp@snorp.net", "when": "2018-04-20T15:59:53Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "snorp@snorp.net"}], "who": "snorp@snorp.net", "when": "2018-04-20T16:00:27Z"}, {"changes": [{"removed": "---", "field_name": "cf_tracking_firefox59", "added": "+"}, {"removed": "---", "field_name": "cf_status_firefox59", "added": "affected"}, {"removed": "---", "field_name": "cf_tracking_firefox60", "added": "+"}, {"removed": "---", "field_name": "cf_status_firefox60", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox61", "added": "?"}], "who": "lhenry@mozilla.com", "when": "2018-04-20T16:06:20Z"}, {"changes": [{"removed": "---", "field_name": "cf_tracking_firefox61", "added": "+"}, {"removed": "?", "field_name": "cf_status_firefox61", "added": "affected"}], "who": "ryanvm@gmail.com", "when": "2018-04-20T18:14:09Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(mh+mozilla@glandium.org)", "attachment_id": 8969694, "added": "review?(nchen@mozilla.com)"}], "who": "snorp@snorp.net", "when": "2018-04-23T17:36:02Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(nchen@mozilla.com)", "attachment_id": 8969694, "added": "review-"}], "who": "nchen@mozilla.com", "when": "2018-04-23T18:49:49Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review-", "attachment_id": 8969694, "added": "review?(nchen@mozilla.com)"}], "who": "snorp@snorp.net", "when": "2018-04-24T17:24:26Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(nchen@mozilla.com)", "attachment_id": 8969694, "added": "review+"}], "who": "nchen@mozilla.com", "when": "2018-04-25T17:36:27Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "Firefox 61"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-04-26 06:14:54"}, {"removed": "affected", "field_name": "cf_status_firefox61", "added": "fixed"}], "who": "apavel@mozilla.com", "when": "2018-04-26T06:14:54Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox59", "added": "wontfix"}], "who": "ryanvm@gmail.com", "when": "2018-04-28T16:28:30Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(snorp@snorp.net)"}], "who": "jcristau@mozilla.com", "when": "2018-04-28T21:44:02Z"}, {"changes": [{"removed": "needinfo?(snorp@snorp.net)", "field_name": "flagtypes.name", "added": ""}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8969694, "added": "approval-mozilla-beta?"}], "who": "snorp@snorp.net", "when": "2018-04-30T15:07:57Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "approval-mozilla-beta?", "attachment_id": 8969694, "added": "approval-mozilla-beta+, approval-mozilla-release+"}], "who": "jcristau@mozilla.com", "when": "2018-04-30T15:09:41Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox60", "added": "fixed"}], "who": "aryx.bugmail@gmx-topmail.de", "when": "2018-04-30T17:13:58Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}