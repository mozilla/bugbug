{"cf_tracking_thunderbird_esr52": "---", "status": "NEW", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "nfroyd@mozilla.com", "mentors_detail": [], "depends_on": [], "cf_status_firefox_esr60": "---", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "All", "keywords": [], "cc_detail": [{"email": "cpeterson@mozilla.com", "id": 430528, "name": "cpeterson@mozilla.com", "real_name": "Chris Peterson [:cpeterson]"}, {"email": "erahm@mozilla.com", "id": 496127, "name": "erahm@mozilla.com", "real_name": "Eric Rahm [:erahm] (please no mozreview requests)"}, {"email": "jcoppeard@mozilla.com", "id": 443194, "name": "jcoppeard@mozilla.com", "real_name": "Jon Coppeard (:jonco)"}, {"email": "jdemooij@mozilla.com", "id": 375297, "name": "jdemooij@mozilla.com", "real_name": "Jan de Mooij [:jandem]"}, {"email": "mcastelluccio@mozilla.com", "id": 420453, "name": "mcastelluccio@mozilla.com", "real_name": "Marco Castelluccio [:marco]"}, {"email": "mh+mozilla@glandium.org", "id": 47192, "name": "mh+mozilla@glandium.org", "real_name": "Mike Hommey [:glandium]"}], "cf_last_resolved": null, "attachments": [{"creator": "nfroyd@mozilla.com", "is_obsolete": 1, "is_patch": 1, "flags": [{"status": "+", "name": "feedback", "modification_date": "2017-04-05T17:08:53Z", "type_id": 607, "creation_date": "2017-04-05T17:08:53Z", "id": 1559000, "setter": "erahm@mozilla.com"}], "content_type": "text/plain", "id": 8854955}, {"creator": "nfroyd@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2017-04-07T19:32:29Z", "type_id": 4, "creation_date": "2017-04-07T19:05:03Z", "id": 1560754, "setter": "erahm@mozilla.com"}], "content_type": "text/plain", "id": 8855907}], "votes": 1, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 13, "comments": [{"text": "Changing the fairness policy makes OS X mutexes roughly an order of\nmagnitude faster in the contended case.", "author": "nfroyd@mozilla.com", "id": 12208832, "time": "2017-04-05T16:39:30Z"}, {"text": "Created attachment 8854955\nuse first-fit mutexes on OS X", "author": "nfroyd@mozilla.com", "id": 12208833, "time": "2017-04-05T16:39:38Z"}, {"text": "Comment on attachment 8854955\nuse first-fit mutexes on OS X\n\nReview of attachment 8854955:\n-----------------------------------------------------------------\n\nLooks good, we should probably do some talos runs before landing to make sure the microbenchmarks hold up.\n\n::: mozglue/misc/Mutex_posix.cpp\n@@ +31,5 @@\n>  #endif\n>  \n>  #if defined(DEBUG)\n>  #define ATTR_REQUIRED\n> +#define ATTR_SETTYPE\n\nWe still probably want ATTR_SETPOLICY for the OSX case. Our debug builds are slow enough :(\n\n@@ +36,3 @@\n>  #define MUTEX_KIND PTHREAD_MUTEX_ERRORCHECK\n>  #elif defined(ADAPTIVE_MUTEX_SUPPORTED)\n>  #define ATTR_REQUIRED\n\nThis is getting a bit unruly, I wonder if we could ditch ATTR_REQUIRED and change the check below to:\n\n> #if defined(ATTR_SETTYPE) || defined(ATTR_SETPOLICY)\n\nAlso we could simplify a bit and:\n\n> #define ATTR_SETTYPE PTHREAD_MUTEX_ADAPTIVE_NP\n> ...\n> #define ATTR_SETPOLICY _PTHREAD_MUTEX_POLICY_FIRSTFIT\n\n@@ +42,5 @@\n> +// OS X's mutexes are fair by default, which means they can be rather\n> +// slow in the contended case.  OS X 10.7 and above provides an OS\n> +// X-only function to set the mutex fairness policy, which makes mutexes\n> +// non-fair (i.e. like every other platform we support) and increases\n> +// performance in the contended case by an order of magnitude or so.\n\nNice comment.\n\n@@ +63,3 @@\n>    TRY_CALL_PTHREADS(pthread_mutexattr_settype(&attr, MUTEX_KIND),\n>                      \"mozilla::detail::MutexImpl::MutexImpl: pthread_mutexattr_settype failed\");\n> +#elif defined(ATTR_SETPOLICY)\n\n... and these could be separate if defined's\n\n@@ +65,5 @@\n> +#elif defined(ATTR_SETPOLICY)\n> +  TRY_CALL_PTHREADS(pthread_mutexattr_setpolicy_np(&attr, _PTHREAD_MUTEX_POLICY_FIRSTFIT),\n> +                    \"mozilla::detail::MutexImpl::MutexImpl: pthread_mutex_setpolicy_np failed\");\n> +#else\n> +#error mutex attribute required, but nothing to do\n\n... and then this check wouldn't be necessary", "author": "erahm@mozilla.com", "id": 12208944, "time": "2017-04-05T17:08:53Z"}, {"text": "Created attachment 8855907\nuse first-fit mutexes on OS X\n\nRevised patch.", "author": "nfroyd@mozilla.com", "id": 12216952, "time": "2017-04-07T19:05:03Z"}, {"text": "Comment on attachment 8855907\nuse first-fit mutexes on OS X\n\nReview of attachment 8855907:\n-----------------------------------------------------------------\n\nThanks, looks good. Did you end up doing any talos runs?", "author": "erahm@mozilla.com", "id": 12217013, "time": "2017-04-07T19:32:29Z"}, {"text": "Pushed by nfroyd@mozilla.com:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/e824f50f5ca6\nuse first-fit mutexes on OS X; r=erahm", "author": "pulsebot@bots.tld", "id": 12217048, "time": "2017-04-07T19:42:45Z"}, {"text": "Backout by nfroyd@mozilla.com:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/5ca1b0650836\nBackout e824f50f5ca6 for massive OS X test bustage on a CLOSED TREE", "author": "pulsebot@bots.tld", "id": 12217297, "time": "2017-04-07T20:46:21Z"}, {"text": "(In reply to Pulsebot from comment #6)\n> Backout by nfroyd@mozilla.com:\n> https://hg.mozilla.org/integration/mozilla-inbound/rev/5ca1b0650836\n> Backout e824f50f5ca6 for massive OS X test bustage on a CLOSED TREE\n\nI haven't debugged this on a mac, but from the treeherder failures, it looks like these kinds of mutexes cannot be used (reliably?) with condition variables.  Boo!\n\nSo, we have two options:\n\n1) Abandon this whole idea.\n2) Introduce a new mutex type, WaitableMutex or somesuch, which would be used in the implementation of Monitor and available for people who *really* needed to use CondVar on its own.  All other Mutexes would unusable with CondVar and would use this style of mutex under the hood.\n\nI'm disinclined to do the second, because it would add quite some complexity to things.  It would be an obvious win for contended mutexes, but I don't really know how many contended mutexes we have in Gecko, so the payoff is not obvious.", "author": "nfroyd@mozilla.com", "id": 12225853, "time": "2017-04-11T17:09:24Z"}, {"text": "I've been doing some benchmarking for parallel JS parsing and found that performance with a heavily contented mutex on OS X is really bad.  With a pathalogical testcase intended to produce lock contention the total time taken increases by over four times when adding more threads on OSX, whereas on linux it decreases by ~20%.", "author": "jcoppeard@mozilla.com", "id": 13237751, "time": "2018-04-27T09:59:17Z"}, {"text": "(In reply to Nathan Froyd [:froydnj] (out until April 30) from comment #7)\n> I haven't debugged this on a mac, but from the treeherder failures, it looks\n> like these kinds of mutexes cannot be used (reliably?) with condition\n> variables.  Boo!\n\nI tried using this for a single mutex in the JS engine that isn't used with condition variables, and I still saw hangs waiting on the mutex, e.g.:\n\nhttps://treeherder.mozilla.org/logviewer.html#?job_id=175782219&repo=try&lineNumber=5454", "author": "jcoppeard@mozilla.com", "id": 13238536, "time": "2018-04-27T15:59:12Z"}, {"text": "(In reply to Jon Coppeard (:jonco) from comment #9)\nI couldn't figure out how to make this API work so I spilt off bug 1457882 to try a different approach.", "author": "jcoppeard@mozilla.com", "id": 13243121, "time": "2018-04-30T14:01:41Z"}, {"text": "Somebody mentioned that this API is only available on newer OS X versions, and our Mac machines on treeherder do not support the newer API?  Perhaps we might be able to do some sort of runtime test, if this is true?", "author": "nfroyd@mozilla.com", "id": 13403682, "time": "2018-06-13T16:29:19Z"}, {"text": "Somebody was me, but I was talking about os_unfair_lock, which is 10.12+.", "author": "mh+mozilla@glandium.org", "id": 13403733, "time": "2018-06-13T16:58:10Z"}], "id": 1353787, "priority": "--", "cc": ["cpeterson@mozilla.com", "erahm@mozilla.com", "jcoppeard@mozilla.com", "jdemooij@mozilla.com", "mcastelluccio@mozilla.com", "mh+mozilla@glandium.org"], "cf_crash_signature": "", "version": "unspecified", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_thunderbird_esr60": "---", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1289864], "qa_contact": "", "creation_time": "2017-04-05T16:39:30Z", "cf_status_firefox_esr52": "---", "component": "mozglue", "assigned_to_detail": {"email": "nfroyd@mozilla.com", "id": 417288, "name": "nfroyd@mozilla.com", "real_name": "Nathan Froyd [:froydnj]"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "---", "cf_status_firefox60": "---", "target_milestone": "---", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "nfroyd@mozilla.com", "id": 417288, "name": "nfroyd@mozilla.com", "real_name": "Nathan Froyd [:froydnj]"}, "whiteboard": "[stylo]", "mentors": [], "summary": "use first-fit mutexes on OS X", "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-06-13T16:58:10Z", "assigned_to": "nfroyd@mozilla.com", "is_open": true, "history": [{"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8854955, "added": "review?(erahm@mozilla.com)"}, {"removed": "", "field_name": "cc", "added": "erahm@mozilla.com"}], "who": "nfroyd@mozilla.com", "when": "2017-04-05T16:39:38Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(erahm@mozilla.com)", "attachment_id": 8854955, "added": "feedback+"}], "who": "erahm@mozilla.com", "when": "2017-04-05T17:08:53Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8855907, "added": "review?(erahm@mozilla.com)"}], "who": "nfroyd@mozilla.com", "when": "2017-04-07T19:05:03Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8854955, "added": "1"}], "who": "nfroyd@mozilla.com", "when": "2017-04-07T19:05:05Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(erahm@mozilla.com)", "attachment_id": 8855907, "added": "review+"}], "who": "erahm@mozilla.com", "when": "2017-04-07T19:32:29Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "cpeterson@mozilla.com"}, {"removed": "", "field_name": "blocks", "added": "1289864"}], "who": "cpeterson@mozilla.com", "when": "2017-04-09T08:46:35Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mcastelluccio@mozilla.com"}], "who": "mcastelluccio@mozilla.com", "when": "2017-04-09T10:31:37Z"}, {"changes": [{"removed": "", "field_name": "whiteboard", "added": "[stylo]"}], "who": "cpeterson@mozilla.com", "when": "2017-04-12T20:35:23Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "jcoppeard@mozilla.com"}], "who": "jcoppeard@mozilla.com", "when": "2018-04-27T09:35:10Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "jdemooij@mozilla.com"}], "who": "jdemooij@mozilla.com", "when": "2018-04-29T16:55:42Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mh+mozilla@glandium.org"}], "who": "mh+mozilla@glandium.org", "when": "2018-06-13T16:58:10Z"}], "resolution": "", "op_sys": "All", "cf_fx_points": "---", "cf_blocking_fennec": "---"}