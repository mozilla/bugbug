{"cf_tracking_thunderbird_esr52": "---", "status": "VERIFIED", "cf_tracking_firefox60": "---", "attachments": [], "classification": "Components", "creator": "cpearce@mozilla.com", "mentors_detail": [], "depends_on": [1230026, 1230272], "cf_has_str": "---", "cf_user_story": "", "cf_backlog": "---", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "[EME] Shaka player ClearKey demo doesn't work in Firefox", "cf_last_resolved": "2015-12-07T07:03:08Z", "votes": 0, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_status_firefox45": "verified", "cf_has_regression_range": "---", "comment_count": 8, "comments": [{"text": "If you load the Shaka demo player, and run the clearkey \"Car/CENC\" example, it doesn't work.\n\nSTR:\n1. Load http://shaka-player-demo.appspot.com/ in Firefox Nightly.\n2. Press \"Load Stream\" (without changing any of the \"Stream Setup\" options).\n\nExpected result:\n* video plays.\n\nObserved result:\n* Video fails to play.\n\nNSPR logs:\n\n17136[106f7b80]: GMPService::mozilla::gmp::GeckoMediaPluginServiceParent::AddOnGMPThread: C:\\Users\\cpearce\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\681ziqb7.nightly_x86\\gmp-gmpopenh264\\1.5.1\n0[1719140]: GMPParent[1067d800|childPid=0] GMPParent ctor\n17136[106f7b80]: GMPParent[1067d800|childPid=0] mozilla::gmp::GMPParent::Init: for gmp-gmpopenh264\n17136[106f7b80]: GMPService::mozilla::gmp::GeckoMediaPluginServiceParent::AddOnGMPThread: C:\\Users\\cpearce\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\681ziqb7.nightly_x86\\gmp-eme-adobe\\15\n0[1719140]: GMPParent[f9eac00|childPid=0] GMPParent ctor\n17136[106f7b80]: GMPParent[f9eac00|childPid=0] mozilla::gmp::GMPParent::Init: for gmp-eme-adobe\n17136[106f7b80]: GMPService::mozilla::gmp::GeckoMediaPluginServiceParent::AddOnGMPThread: C:\\Program Files (x86)\\Nightly\\gmp-clearkey\\0.1\n0[1719140]: GMPParent[17bfe000|childPid=0] GMPParent ctor\n17136[106f7b80]: GMPParent[17bfe000|childPid=0] mozilla::gmp::GMPParent::Init: for gmp-clearkey\n0[1719140]: MediaSource(21d44380)::mozilla::dom::MediaSource::MediaSource: MediaSource(aWindow=20143c10) mSourceBuffers=1eeb9b20 mActiveSourceBuffers=1eeb9bb0\n0[1719140]: MediaSource(0)::mozilla::dom::MediaSource::IsTypeSupported: IsTypeSupported(aType=video/mp4; codecs=\"avc1.640028\")OK \n0[1719140]: MediaSource(0)::mozilla::dom::MediaSource::IsTypeSupported: IsTypeSupported(aType=video/mp4; codecs=\"avc1.4d401f\")OK \n0[1719140]: MediaSource(0)::mozilla::dom::MediaSource::IsTypeSupported: IsTypeSupported(aType=video/mp4; codecs=\"avc1.4d401e\")OK \n0[1719140]: MediaSource(0)::mozilla::dom::MediaSource::IsTypeSupported: IsTypeSupported(aType=video/mp4; codecs=\"avc1.4d401e\")OK \n0[1719140]: MediaSource(0)::mozilla::dom::MediaSource::IsTypeSupported: IsTypeSupported(aType=video/mp4; codecs=\"avc1.4d4015\")OK \n0[1719140]: MediaSource(0)::mozilla::dom::MediaSource::IsTypeSupported: IsTypeSupported(aType=audio/mp4; codecs=\"mp4a.40.2\")OK \n0[1719140]: MediaSource(0)::mozilla::dom::MediaSource::IsTypeSupported: IsTypeSupported(aType=audio/mp4; codecs=\"mp4a.40.2\")OK \n0[1719140]: MediaSource(0)::mozilla::dom::MediaSource::IsTypeSupported: IsTypeSupported(aType=audio/mp4; codecs=\"mp4a.40.2\")OK \n0[1719140]: Navigator::RequestMediaKeySystemAccess(keySystem='org.w3.clearkey' options=[{label='', audioCapabilities=[{contentType='audio/mp4; codecs=\"mp4a.40.2\"'}], videoCapabilities=[{contentType='video/mp4; codecs=\"avc1.4d4015\"'}]}])\n0[1719140]: MediaKeySystemAccessManager::Request org.w3.clearkey\n0[1719140]: navigator.requestMediaKeySystemAccess promise resolved\n0[1719140]: navigator.requestMediaKeySystemAccess succcess latency 0ms reported via telemetry\n0[1719140]: HTMLMediaElement.setMediaKeys promise resolved\n0[1719140]: MediaSource(21d44380)::mozilla::dom::MediaSource::~MediaSource: \n\n\n\nBrowser console:\n\nCould not read chrome manifest 'file:///C:/Program%20Files%20(x86)/Nightly/chrome.manifest'.\n1448400856684\tToolkit.GMP\tTRACE\tGMPProvider.startup - enabled=true, gmpPath=C:\\Users\\cpearce\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\681ziqb7.nightly_x86\\gmp-gmpopenh264\\1.5.1\n1448400856685\tToolkit.GMP\tINFO\tGMPProvider.startup - adding gmp directory C:\\Users\\cpearce\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\681ziqb7.nightly_x86\\gmp-gmpopenh264\\1.5.1\n1448400856686\tToolkit.GMP\tTRACE\tGMPProvider.startup - enabled=true, gmpPath=C:\\Users\\cpearce\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\681ziqb7.nightly_x86\\gmp-eme-adobe\\15\n1448400856686\tToolkit.GMP\tINFO\tGMPProvider.startup - adding gmp directory C:\\Users\\cpearce\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\681ziqb7.nightly_x86\\gmp-eme-adobe\\15\n1448400856687\tToolkit.GMP\tINFO\tGMPProvider.startup - adding clearkey CDM directory C:\\Program Files (x86)\\Nightly\\gmp-clearkey\\0.1\nUsing native Promises. promise.js:85:5\nUsing native EME as-is. mediakeys.js:48:5\nUsing native Promises. promise.js:85:5\nUsing native EME as-is. mediakeys.js:48:5\nKey event not available on some keyboard layouts: key=\"c\" modifiers=\"accel,alt\" browser.xul\nKey event not available on some keyboard layouts: key=\"i\" modifiers=\"accel,alt,shift\" browser.xul\nmutating the [[Prototype]] of an object will cause your code to run very slowly; instead create the object with the correct initial [[Prototype]] value using Object.create repair:8:3078\n+ video/mp4; codecs=\"avc1.640028\" is supported player.js:191:3\n+ video/mp4; codecs=\"avc1.4d401f\" is supported player.js:191:3\n+ video/mp4; codecs=\"avc1.4d401e\" is supported player.js:191:3\n+ video/mp4; codecs=\"avc1.4d4015\" is supported player.js:191:3\n+ audio/mp4; codecs=\"mp4a.40.2\" is supported player.js:191:3\nMKSC Object { audioCapabilities: Array[1], videoCapabilities: Array[1], initDataTypes: undefined, distinctiveIdentifier: \"optional\", persistentState: \"optional\", sessionTypes: Array[1] } eme_manager.js:292:5\nMKSC Object { audioCapabilities: Array[1], videoCapabilities: Array[1], initDataTypes: undefined, distinctiveIdentifier: \"optional\", persistentState: \"optional\", sessionTypes: Array[1] } eme_manager.js:292:5\nMediaKeySystemAccess::GetKeySystemStatus(org.w3.clearkey, minVer=-1) result=available version='1' msg=''\n eme_manager.js:428:5\nshaka.media.EmeManager.prototype.chooseEncrypted_() eme_manager.js:428\n(Async: promise callback) shaka.media.EmeManager.prototype.initialize() eme_manager.js:168\n(Async: promise callback) shaka.player.Player.prototype.load() player.js:322\napp.load_() app.js:764\napp.loadDashStream() app.js:727\napp.loadStream() app.js:685\nonclick() shaka-player-demo.appspot.com:1\n\nPlayer error error { target: null, isTrusted: false, detail: TypeError, eventPhase: 0, bubbles: true, cancelable: false, defaultPrevented: false, timeStamp: 5917.794139675971, NONE: 0, CAPTURING_PHASE: 1, AT_TARGET: 2 } app.js:884:3\napp.onPlayerError_() app.js:884\nshaka.util.FakeEventTarget.prototype.recursiveDispatch_() fake_event_target.js:167\nshaka.util.FakeEventTarget.prototype.dispatchEvent() fake_event_target.js:145\nshaka.player.Player.prototype.load/<() player.js:353\n(Async: promise callback) shaka.player.Player.prototype.load() player.js:322\napp.load_() app.js:764\napp.loadDashStream() app.js:727\napp.loadStream() app.js:685\nonclick() shaka-player-demo.appspot.com:1\n\nInvalid URI. Load of media resource  failed. shaka-player-demo.appspot.com\n1448400917561\tToolkit.GMP\tINFO\tGMPInstallManager.simpleCheckAndInstall A version change occurred. Ignoring media.gmp-manager.lastCheck to check immediately for new or updated GMPs.\n1448400917561\tToolkit.GMP\tINFO\tGMPInstallManager.simpleCheckAndInstall Version change, resetting media.gmp-gmpopenh264.trial-create\n1448400917561\tToolkit.GMP\tINFO\tGMPInstallManager.simpleCheckAndInstall Version change, resetting media.gmp-eme-adobe.trial-create\n1448400917561\tToolkit.GMP\tINFO\tGMPInstallManager.simpleCheckAndInstall Version change, resetting media.gmp-eme-clearkey.trial-create\n1448400917561\tToolkit.GMP\tINFO\tGMPInstallManager._getURL Using url: https://aus5.mozilla.org/update/3/GMP/%VERSION%/%BUILD_ID%/%BUILD_TARGET%/%LOCALE%/%CHANNEL%/%OS_VERSION%/%DISTRIBUTION%/%DISTRIBUTION_VERSION%/update.xml\n1448400917562\tToolkit.GMP\tINFO\tGMPInstallManager._getURL Using url (with replacement): https://aus5.mozilla.org/update/3/GMP/45.0a1/20151124030553/WINNT_x86-msvc-x64/en-US/nightly/Windows_NT%2010.0.0.0%20(x64)/default/default/update.xml\n1448400917786\tToolkit.GMP\tINFO\tGMPInstallManager.simpleCheckAndInstall Last check was: 61360 seconds ago, minimum seconds: 86400\n1448400917786\tToolkit.GMP\tINFO\tGMPInstallManager.simpleCheckAndInstall Will not check for updates.\n1448400918553\tToolkit.GMP\tINFO\tGMPAddon.constructor Created new addon: gmp-eme-adobe (isValid: true, isInstalled: true, hashFunction: sha512, hashValue: d0077885971419a5db8e8ab9f0cb2cac236be98497aa9b6f86ff3b528788fc01a755a8dd401f391f364ff6e586204a766e61afe20cf5e597ceeb92dee9ed1ebc, size: 3696996)\n1448400918553\tToolkit.GMP\tINFO\tGMPAddon.constructor Created new addon: gmp-gmpopenh264 (isValid: true, isInstalled: true, hashFunction: sha512, hashValue: 26a9a0a56b4342cab4e84275b89027f1053c579c346a39545465534ea72aafd0749f38a2aa738a5c0b693433656920bcc44fb0b8fb6436a8b1f1264ebad848b3, size: 333716)\n1448400918554\tToolkit.GMP\tINFO\tGMPInstallManager.simpleCheckAndInstall Found 2 addons advertised.\n1448400918554\tToolkit.GMP\tINFO\tGMPInstallManager.simpleCheckAndInstall Found addon: gmp-eme-adobe (isValid: true, isInstalled: true, hashFunction: sha512, hashValue: d0077885971419a5db8e8ab9f0cb2cac236be98497aa9b6f86ff3b528788fc01a755a8dd401f391f364ff6e586204a766e61afe20cf5e597ceeb92dee9ed1ebc, size: 3696996)\n1448400918554\tToolkit.GMP\tINFO\tGMPInstallManager.simpleCheckAndInstall Addon |gmp-eme-adobe| already installed.\n1448400918554\tToolkit.GMP\tINFO\tGMPInstallManager.simpleCheckAndInstall Found addon: gmp-gmpopenh264 (isValid: true, isInstalled: true, hashFunction: sha512, hashValue: 26a9a0a56b4342cab4e84275b89027f1053c579c346a39545465534ea72aafd0749f38a2aa738a5c0b693433656920bcc44fb0b8fb6436a8b1f1264ebad848b3, size: 333716)\n1448400918554\tToolkit.GMP\tINFO\tGMPInstallManager.simpleCheckAndInstall Addon |gmp-gmpopenh264| already installed.\n1448400918554\tToolkit.GMP\tINFO\tGMPInstallManager.simpleCheckAndInstall No new addons to install, returning\n\nLooks like EME is starting, but the player isn't creating the CDM.\n\nThe non-encrypted case works fine.", "author": "cpearce@mozilla.com", "id": 10961707, "time": "2015-11-24T21:40:07Z"}, {"text": "*** Bug 1226934 has been marked as a duplicate of this bug. ***", "author": "cpeterson@mozilla.com", "id": 10961733, "time": "2015-11-24T21:46:28Z"}, {"text": "P2 because EME compatibility is important, but we don't know of real world content that uses ClearKey or the Shaka Player.", "author": "cpeterson@mozilla.com", "id": 10974829, "time": "2015-11-30T19:49:58Z"}, {"text": "The first problem is that Firefox reports the CDM version number in the MediaKeySystemAccess.keySystem attribute (i.e. org.w3.clearkey.1 for v1), and shaka.media.EmeManager.prototype.chooseEncrypted_ is doing a verbatim string comparison on the keysystem for \"org.w3.clearkey\", which we're failing.\n\nThe second problem is that our clearkey CDM doesn't support the \"webm\" initData format, and that's what they're passing to their MediaKeySession.generateRequest() call, even though this particular example is an MP4 test case.", "author": "cpearce@mozilla.com", "id": 10983895, "time": "2015-12-03T02:57:38Z"}, {"text": "(In reply to Chris Pearce (:cpearce) from comment #3)\n> The first problem is that Firefox reports the CDM version number in the\n> MediaKeySystemAccess.keySystem attribute (i.e. org.w3.clearkey.1 for v1),\n> and shaka.media.EmeManager.prototype.chooseEncrypted_ is doing a verbatim\n> string comparison on the keysystem for \"org.w3.clearkey\", which we're\n> failing.\n\nIs this a Firefox bug or a Shaka bug? The EME spec says \"subsystems may be defined as determined by the key system provider\". Is the W3C the key system provider of Clear Key? Or is Mozilla the provider of our implementation?\n\nhttps://w3c.github.io/encrypted-media/#key-system", "author": "cpeterson@mozilla.com", "id": 10984296, "time": "2015-12-03T08:01:20Z"}, {"text": "The EME spec says that the keySystem string should be \"org.w3.clearkey\", so our behaviour of changing the reported keySystem string to be something other than that is in violation of the spec.\n\nIt's not what Chrome implements and clearly it is not what is expected by webdevs.\n\nWe could disable this behaviour for ClearKey only, and keep it for Adobe Primetime (where it's useful to Netflix), but I expect other webdevs will make the same mistake for Primetime too.\n\nI've filed https://github.com/w3c/encrypted-media/issues/133 to begin the process of standardizing this functionality.\n\nWe could work towards getting shaka-player changed, but then we'll have to play whack-a-mole with every other player that makes the same assumption.\n\nI think the only thing we can do is remove this behaviour from Firefox, and try to get something standardized.", "author": "cpearce@mozilla.com", "id": 10984405, "time": "2015-12-03T08:59:46Z"}, {"text": "The \"Car/CENC\" (YT DASH EME test) - MP4, ClearKey\" stream now plays successfully in Nightly 45.", "author": "cpeterson@mozilla.com", "id": 10992701, "time": "2015-12-07T07:03:08Z"}, {"text": "Verified fixed in Nightly 45.0a1 build 2015-12-06.", "author": "cpeterson@mozilla.com", "id": 10992703, "time": "2015-12-07T07:03:45Z"}], "id": 1227720, "priority": "P2", "cc": ["cpearce@mozilla.com", "cpeterson@mozilla.com", "nick@mozilla.com"], "cf_crash_signature": "", "version": "unspecified", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_firefox59": "---", "last_change_time": "2015-12-07T07:03:45Z", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1015800], "qa_contact": "", "creation_time": "2015-11-24T21:40:07Z", "cf_status_firefox_esr52": "---", "component": "Audio/Video: Playback", "assigned_to_detail": {"email": "nobody@mozilla.org", "id": 1, "name": "nobody@mozilla.org", "real_name": "Nobody; OK to take it and work on it"}, "groups": [], "cf_status_firefox60": "---", "target_milestone": "mozilla45", "cf_status_firefox44": "affected", "is_cc_accessible": true, "cf_rank": null, "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "cpearce@mozilla.com", "id": 287422, "name": "cpearce@mozilla.com", "real_name": "Chris Pearce (:cpearce)"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "cpearce@mozilla.com", "id": 287422, "name": "cpearce@mozilla.com", "real_name": "Chris Pearce (:cpearce)"}, {"email": "cpeterson@mozilla.com", "id": 430528, "name": "cpeterson@mozilla.com", "real_name": "Chris Peterson [:cpeterson]"}, {"email": "nick@mozilla.com", "id": 443618, "name": "nick@mozilla.com", "real_name": "(not reading bugmail) Nick Desaulniers [:\\n]"}], "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "assigned_to": "nobody@mozilla.org", "is_open": false, "history": [{"changes": [{"removed": "[EME] Shaka player doesn't work in Firefox", "field_name": "summary", "added": "[EME] Shaka player ClearKey demo doesn't work in Firefox"}], "who": "cpearce@mozilla.com", "when": "2015-11-24T21:40:22Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P2"}], "who": "cpeterson@mozilla.com", "when": "2015-11-30T19:49:58Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1230026"}], "who": "cpearce@mozilla.com", "when": "2015-12-03T04:11:46Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(cpearce@mozilla.com)"}], "who": "cpeterson@mozilla.com", "when": "2015-12-03T08:01:20Z"}, {"changes": [{"removed": "needinfo?(cpearce@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "cpearce@mozilla.com", "when": "2015-12-03T08:59:46Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1230272"}], "who": "cpeterson@mozilla.com", "when": "2015-12-03T19:18:53Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla45"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2015-12-06 23:03:08"}, {"removed": "---", "field_name": "cf_status_firefox44", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox45", "added": "fixed"}], "who": "cpeterson@mozilla.com", "when": "2015-12-07T07:03:08Z"}, {"changes": [{"removed": "RESOLVED", "field_name": "status", "added": "VERIFIED"}, {"removed": "fixed", "field_name": "cf_status_firefox45", "added": "verified"}], "who": "cpeterson@mozilla.com", "when": "2015-12-07T07:03:45Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}