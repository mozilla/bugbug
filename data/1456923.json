{"cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "classification": "Components", "creator": "mfroman@nostrum.com", "cc": ["drno@ohlmeier.org", "hkirschner@mozilla.com", "lgreco@mozilla.com", "mcastelluccio@mozilla.com", "mratcliffe@mozilla.com", "pbrosset@mozilla.com"], "depends_on": [], "creation_time": "2018-04-25T17:25:15Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "cf_status_firefox59": "unaffected", "keywords": ["regression"], "summary": "can't switch to dev-tools add-on that is loaded temporarily", "cf_last_resolved": "2018-05-02T15:02:20Z", "attachments": [{"creator": "mratcliffe@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2018-05-02T08:00:27Z", "type_id": 748, "creation_date": "2018-04-30T15:00:49Z", "id": 1750656, "setter": "pbrosset@mozilla.com"}], "content_type": "text/x-review-board-request", "id": 8971999}], "assigned_to_detail": {"email": "mratcliffe@mozilla.com", "id": 313697, "name": "mratcliffe@mozilla.com", "real_name": "Mike Ratcliffe [:miker] [:mratcliffe] [:mikeratcliffe]"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "comments": [{"text": "Nightly 61.0a1 (2018-04-25) (64-bit) seems to break switching to dev-tools panels that are loaded temporarily.  Mozregression leads me to Bug 1441070 from the following results:\n26:07.02 INFO: Last good revision: be5ba8b6dea2d025e0e1f7268336e1d1f0c32399\n26:07.02 INFO: First bad revision: 3577a6b9b1a13a0dfd93073f4ef9209c08764eb4\n\nSteps to reproduce:\n- Download https://github.com/karolien/media-devtools-panel-react\n- Navigate to about:debugging\n- Click load temporary add-on, navigate to {location-of-download}/media-devtools-panel-react/extension/ and select any file to load the add-on.\n- Open the Developer Tools, and attempt to show the \"Media\" tab.\n\nExpected results:\n- See the media panel\n\nActual results:\n- Does not switch away from current panel\n\nThis worked as of 4/24, but stopped working this morning, 4/25.", "author": "mfroman@nostrum.com", "id": 13233121, "time": "2018-04-25T17:25:15Z"}, {"text": "After trying the steps above in Nightly 4/25 (build 20180425100122), I can confirm that it doesn't switch to away from the current panel.", "author": "na-g@nostrum.com", "id": 13233156, "time": "2018-04-25T17:39:05Z"}, {"text": "I can also confirm that after loading the media-tools extension temporarily on todays Nightly (61.0a1 (2018-04-25)) only results in the tab being shown, but I can't switch to the tab.\n\nBut when I removed the temporary loaded extension and instead re-enable the last released version of the \"Media Panel\" add-on it still works.", "author": "drno@ohlmeier.org", "id": 13233191, "time": "2018-04-25T17:53:15Z"}, {"text": "In the browser console I get this error when trying to switch to the temporary loaded add-on:\n\nError: The property \"next_panel\" was added to a telemetry event with the signature devtools.main,exit,webconsole,null but it's value \"webext-devtools-panel-45545ec3cbb7c85b7fa0b74e33259502e2dbdbff_temporary-addon-6119-0\" is longer than the maximum allowed length of 80 characters", "author": "drno@ohlmeier.org", "id": 13233218, "time": "2018-04-25T17:59:32Z"}, {"text": "Mike, are we already cleaning up the panel names for extensions; or is this one not matching the expression?", "author": "hkirschner@mozilla.com", "id": 13233568, "time": "2018-04-25T20:02:46Z"}, {"text": "Moving to M1 for splitting off M2 work.", "author": "hkirschner@mozilla.com", "id": 13233577, "time": "2018-04-25T20:03:49Z"}, {"text": "Hi Mike,\nI've briefly looked into this (especially about why none of the existent tests have been failed because of this issue).\n\nThe code that prepares these telemetry probes is cleaning up the panel names and the extension devtools panel ids get matched as expected and the cleaned panel name returned is definitely \"other\" (I'm wondering if it would make sense to return something like \"none\" if the id is undefined, but that is totally unrelated to this issue).\n\nThe reason why this issue is being triggered is that the telemetry probes currently contain the original panel id in other fields, e.g. in the \"panel selection\" telemetry probe I have found the following two:\n\n- `\"panel_name\": id` (which I guess it could/should use the cleaned up `panelName` instead), from https://searchfox.org/mozilla-central/rev/78dbe34925f04975f16cb9a5d4938be714d41897/devtools/client/framework/toolbox.js#1890\n\n- `\"next_panel\": id` (which seems that it could/should also be set to `panelName`), from https://searchfox.org/mozilla-central/rev/78dbe34925f04975f16cb9a5d4938be714d41897/devtools/client/framework/toolbox.js#1901\n\nBesides fixing the above two, there is also another one related to when the toolbox is being destroyed:\n\n- `\"panel_name\": this.currentToolId` (which it seems to be that it could/should be set to `prevPanelName`, from https://searchfox.org/mozilla-central/rev/78dbe34925f04975f16cb9a5d4938be714d41897/devtools/client/framework/toolbox.js#2839\n\nAbout the reasons why it doesn't fails on the existent tests and with the extensions installed from AMO but it does fail when the extension is installed temporarily by a user:\n\n- the existent tests are installing the test extension temporarily (similarly to how the issue is being triggered in the comment 0 from this issue), but the extension id is specified in the test extension's manifest.json (to make it easier to retrieve the panel from the opened toolbox for testing it), on the contrary when an extension is installed temporarily and it doesn't have an extension id in its manifest.json (like for the media panel extension mentioned in this issue), one is assigned automatically by the XPIProvider:\n\n- https://searchfox.org/mozilla-central/rev/78dbe34925f04975f16cb9a5d4938be714d41897/toolkit/mozapps/extensions/internal/XPIInstall.jsm#884\n\nand that makes the resulting devtools panel id longer than 80 chars.\n\nTo be fair, an extension (even one installed from AMO) may specify its preferred extension id in the manifest (usually because the extension has been migrated from an existent Firefox legacy extension and it needed to be able to keep its previous id to update automatically its own users to the WebExtensions version), and so technically this issue can be triggered not only by temporarily installed extension, but from any extension that has an extension id long enough to make its generated panel id longer then 80 chars.\n\nWe could tweak the existent devtools panel tests a bit so that we can be sure that we cover this scenario from at least one of the existent test cases, e.g. I've applied the following change locally to make it fail and check that changing the telemetry probes mentioned above makes it pass again:\n\n```\ndiff --git a/browser/components/extensions/test/browser/browser_ext_devtools_panel.js b/browser/components/extensions/test/browser/browser_ext_devtools_panel.js\n--- a/browser/components/extensions/test/browser/browser_ext_devtools_panel.js\n+++ b/browser/components/extensions/test/browser/browser_ext_devtools_panel.js\n@@ -237,17 +237,18 @@ add_task(async function test_devtools_pa\n     // and accessible from the devtools_page when the panel.onShown\n     // event has been received.\n     window.TEST_PANEL_GLOBAL = \"test_panel_global\";\n \n     browser.test.sendMessage(\"devtools_panel_inspectedWindow_tabId\",\n                              browser.devtools.inspectedWindow.tabId);\n   }\n \n-  const EXTENSION_ID = \"@create-devtools-panel.test\";\n+  const longPrefix = (new Array(80)).fill('x').join('');\n+  const EXTENSION_ID = `${longPrefix}@create-devtools-panel.test`;\n \n   let extension = ExtensionTestUtils.loadExtension({\n     useAddonManager: \"temporary\",\n     manifest: {\n       devtools_page: \"devtools_page.html\",\n       applications: {\n         gecko: {id: EXTENSION_ID},\n       },\n```\n\nI'm about to refactor the above test file in Bug 1442604, but if we want to apply this small change to the test in the meantime (so that we are sure that we land the fix for this issue with a test that would fail if the issue is still there),\nI'm 100% ok with it, I'll rebase my patches on top of it and solve the conflicting changes myself, otherwise I will make sure to apply this change to Bug 1442604 (so that we can prevent it from regressing without being noticed).", "author": "lgreco@mozilla.com", "id": 13235234, "time": "2018-04-26T13:50:05Z"}, {"text": "@Luca I have added your test change to create a long extension ID.\n\nApart from that we now log only for the main panels and \"other\", which was the original idea behind this telemetry event.", "author": "mratcliffe@mozilla.com", "id": 13243338, "time": "2018-04-30T14:59:45Z"}, {"text": "Created attachment 8971999\nBug 1456923 - can't switch to dev-tools add-on that is loaded temporarily\n\nReview commit: https://reviewboard.mozilla.org/r/240738/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/240738/", "author": "mratcliffe@mozilla.com", "id": 13243344, "time": "2018-04-30T15:00:49Z"}, {"text": "Comment on attachment 8971999\nBug 1456923 - can't switch to dev-tools add-on that is loaded temporarily\n\nhttps://reviewboard.mozilla.org/r/240738/#review246888\n\nChanges look fine to me. Can you please also ask for a review from Luca on browser/components/extensions/test/browser/browser_ext_devtools_panel.js. This is outside of the DevTools module and might require a rubber stamp from another peer than myself.", "author": "pbrosset@mozilla.com", "id": 13247965, "time": "2018-05-02T08:00:27Z"}, {"text": "Pushed by mratcliffe@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/e6f674c99538\ncan't switch to dev-tools add-on that is loaded temporarily r=pbro", "author": "pulsebot@bots.tld", "id": 13248024, "time": "2018-05-02T08:30:05Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/e6f674c99538", "author": "csabou@mozilla.com", "id": 13248899, "time": "2018-05-02T15:02:20Z"}], "id": 1456923, "priority": "P1", "mentors_detail": [], "comment_count": 12, "version": "57 Branch", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox62": "---", "status": "RESOLVED", "product": "DevTools", "cf_fx_iteration": "---", "blocks": [1456979, 1441070], "qa_contact": "", "see_also": [], "cf_status_firefox_esr52": "unaffected", "component": "General", "votes": 0, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "fixed", "cf_status_firefox60": "unaffected", "target_milestone": "Firefox 61", "is_cc_accessible": true, "groups": [], "url": "", "creator_detail": {"email": "mfroman@nostrum.com", "id": 546718, "name": "mfroman@nostrum.com", "real_name": "Michael Froman [:mjf]"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "drno@ohlmeier.org", "id": 489581, "name": "drno@ohlmeier.org", "real_name": "Nils Ohlmeier [:drno]"}, {"email": "hkirschner@mozilla.com", "id": 427798, "name": "hkirschner@mozilla.com", "real_name": ":Harald Kirschner :digitarald"}, {"email": "lgreco@mozilla.com", "id": 339062, "name": "lgreco@mozilla.com", "real_name": "Luca Greco [:rpl]"}, {"email": "mcastelluccio@mozilla.com", "id": 420453, "name": "mcastelluccio@mozilla.com", "real_name": "Marco Castelluccio [:marco]"}, {"email": "mratcliffe@mozilla.com", "id": 313697, "name": "mratcliffe@mozilla.com", "real_name": "Mike Ratcliffe [:miker] [:mratcliffe] [:mikeratcliffe]"}, {"email": "pbrosset@mozilla.com", "id": 478661, "name": "pbrosset@mozilla.com", "real_name": "Patrick Brosset <:pbro>"}], "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-06-13T17:21:13Z", "cf_status_firefox_esr60": "unaffected", "assigned_to": "mratcliffe@mozilla.com", "is_open": false, "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "history": [{"changes": [{"removed": "", "field_name": "blocks", "added": "1441070"}], "who": "mfroman@nostrum.com", "when": "2018-04-25T17:50:10Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "drno@ohlmeier.org"}], "who": "drno@ohlmeier.org", "when": "2018-04-25T17:59:32Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "hkirschner@mozilla.com, mratcliffe@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(mratcliffe@mozilla.com)"}], "who": "hkirschner@mozilla.com", "when": "2018-04-25T20:02:46Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1456979"}], "who": "hkirschner@mozilla.com", "when": "2018-04-25T20:03:49Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "lgreco@mozilla.com"}], "who": "lgreco@mozilla.com", "when": "2018-04-26T13:50:05Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "regression"}, {"removed": "", "field_name": "cc", "added": "mcastelluccio@mozilla.com"}], "who": "mcastelluccio@mozilla.com", "when": "2018-04-27T08:52:48Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P1"}, {"removed": "", "field_name": "cc", "added": "pbrosset@mozilla.com"}], "who": "pbrosset@mozilla.com", "when": "2018-04-30T13:50:28Z"}, {"changes": [{"removed": "needinfo?(mratcliffe@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "mratcliffe@mozilla.com", "when": "2018-04-30T14:59:45Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8971999, "added": "review?(pbrosset@mozilla.com)"}], "who": "mratcliffe@mozilla.com", "when": "2018-04-30T15:00:49Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "ASSIGNED"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "mratcliffe@mozilla.com"}], "who": "mratcliffe@mozilla.com", "when": "2018-04-30T15:01:11Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(pbrosset@mozilla.com)", "attachment_id": 8971999, "added": "review+"}], "who": "pbrosset@mozilla.com", "when": "2018-05-02T08:00:27Z"}, {"changes": [{"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "Firefox 61"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-05-02 15:02:20"}, {"removed": "---", "field_name": "cf_status_firefox61", "added": "fixed"}], "who": "csabou@mozilla.com", "when": "2018-05-02T15:02:20Z"}, {"changes": [{"removed": "---", "field_name": "cf_status_firefox_esr52", "added": "unaffected"}, {"removed": "---", "field_name": "cf_status_firefox_esr60", "added": "unaffected"}, {"removed": "---", "field_name": "cf_status_firefox59", "added": "unaffected"}, {"removed": "---", "field_name": "cf_status_firefox60", "added": "unaffected"}], "who": "ryanvm@gmail.com", "when": "2018-05-03T12:42:11Z"}, {"changes": [{"removed": "Firefox", "field_name": "product", "added": "DevTools"}], "who": "automation@bmo.tld", "when": "2018-06-13T17:21:13Z"}]}