{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "jwatt@jwatt.org", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/plain", "id": 8752473}, {"creator": "jwatt@jwatt.org", "is_obsolete": 1, "is_patch": 1, "flags": [{"status": "-", "name": "review", "modification_date": "2016-05-17T09:11:57Z", "type_id": 4, "creation_date": "2016-05-16T22:36:57Z", "id": 1394863, "setter": "bugs@pettay.fi"}], "content_type": "text/plain", "id": 8753087}, {"creator": "jwatt@jwatt.org", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2016-05-17T20:03:26Z", "type_id": 4, "creation_date": "2016-05-17T19:16:18Z", "id": 1395531, "setter": "bugs@pettay.fi"}], "content_type": "text/plain", "id": 8753470}, {"creator": "jwatt@jwatt.org", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2016-05-17T20:04:24Z", "type_id": 4, "creation_date": "2016-05-17T19:17:40Z", "id": 1395534, "setter": "bugs@pettay.fi"}], "content_type": "text/plain", "id": 8753472}], "classification": "Components", "creator": "jwatt@jwatt.org", "cc": ["bugs@pettay.fi"], "depends_on": [], "creation_time": "2016-04-08T01:30:01Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "Avoid WARNING: NS_ENSURE_SUCCESS(rv, rv) failed with result 0x80040111 in dom/base/nsFrameLoader.cpp during startup", "id": 1263060, "assigned_to_detail": {"email": "jwatt@jwatt.org", "id": 32767, "name": "jwatt@jwatt.org", "real_name": "Jonathan Watt [:jwatt] (needinfo? me)"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "assigned_to": "jwatt@jwatt.org", "comment_count": 17, "comments": [{"text": "In debug builds I get the following:\n\n[87236] WARNING: NS_ENSURE_SUCCESS(rv, rv) failed with result 0x80040111: file /Users/jonathan/moz/trees/i/dom/base/nsFrameLoader.cpp, line 272\n[87236] WARNING: NS_ENSURE_SUCCESS(rv, rv) failed with result 0x80040111: file /Users/jonathan/moz/trees/i/dom/base/nsFrameLoader.cpp, line 272\n\nThe first failure occurs under:\n\n  nsFrameLoader::MaybeCreateDocShell\n  nsFrameLoader::CheckForRecursiveLoad\n  nsFrameLoader::CheckURILoad\n  nsFrameLoader::LoadURI\n\nwhen loading chrome://browser/content/tabbrowser.xml because in MaybeCreateDocShell the |!doc->IsActive()| check evaluates to true here:\n\nhttps://mxr.mozilla.org/mozilla-central/source/dom/base/nsFrameLoader.cpp?rev=577472ad5c38&mark=1864-1868#1864\n\nThat causes us to return NS_ERROR_NOT_AVAILABLE up to LoadURI where the NS_ENSURE_SUCCESS fails and issues the warning.\n\nThe second failure occurs in the same way loading chrome://browser/content/socialchat.xml\n\nThe doc->IsActive() check came from http://hg.mozilla.org/mozilla-central/rev/cee083078957 (bug 610571) FWIW.", "author": "jwatt@jwatt.org", "id": 11309931, "time": "2016-04-08T01:30:01Z"}, {"text": "Do you think a newish contributor could take this, Olli?", "author": "overholt@mozilla.com", "id": 11349370, "time": "2016-04-22T20:02:06Z"}, {"text": "Hmm, well, the warning is useful for debugging, so I'd prefer to not remove it. \nAnd the warning seems to hint about some real bug in, I guess in XUL, where we try to start loading too early. So hard to say...someone would need to debug this a bit that where and why we're trying start loading.", "author": "bugs@pettay.fi", "id": 11349411, "time": "2016-04-22T20:19:02Z"}, {"text": "And that possible bug in XUL (or XBL) is possibly more like an having extra call to the method, where we should just call it once later when docshell is active, so nothing critical.", "author": "bugs@pettay.fi", "id": 11349413, "time": "2016-04-22T20:20:06Z"}, {"text": "Created attachment 8752473\nstack\n\nThis happens when we create the frame tree for chrome://browser/content/browser.xul and start attaching bindings XBL bindings to that document. I'm not sure what we could reasonably do to change the ordering of when things load.", "author": "jwatt@jwatt.org", "id": 11409154, "time": "2016-05-14T11:30:02Z"}, {"text": "Created attachment 8753087\npatch\n\nHow about we add the check in MaybeCreateDocShell to LoadFrame too. In the instance of this bug that would mean that we return earlier. In this patch I've also fixed up the check in TryRemoteBrowser to be the same as the check in LoadFrame for consistency.", "author": "jwatt@jwatt.org", "id": 11412793, "time": "2016-05-16T22:36:57Z"}, {"text": "Comment on attachment 8753087\npatch\n\nThe change to nsFrameLoader::TryRemoteBrowser() looks good, but not sure about \nnsFrameLoader::LoadFrame(). That certainly changes behavior since we won't be firing error event anymore. Because of that, r-", "author": "bugs@pettay.fi", "id": 11413808, "time": "2016-05-17T09:11:57Z"}, {"text": "Created attachment 8753470\npart 1 - Replace redundant nsIDocument::IsResourceDoc() checks in nsFrameLoader with asserts", "author": "jwatt@jwatt.org", "id": 11415907, "time": "2016-05-17T19:16:18Z"}, {"text": "Created attachment 8753472\npart 2 - Prevent nsFrameLoader from loading sub-documents is XBL bindings documents", "author": "jwatt@jwatt.org", "id": 11415916, "time": "2016-05-17T19:17:40Z"}, {"text": "Comment on attachment 8753470\npart 1 - Replace redundant nsIDocument::IsResourceDoc() checks in nsFrameLoader with asserts\n\n\n> nsFrameLoader::Create(Element* aOwner, bool aNetworkCreated)\n> {\n>   NS_ENSURE_TRUE(aOwner, nullptr);\n>   nsIDocument* doc = aOwner->OwnerDoc();\n>+\n>+  // XXXjwatt: We really need an explanitory comment here.  The following check\n>+  // prevents us from creating nsFrameLoaders for elements that belong to a\n>+  // data document or that are not \"in a shadow-including document\", _unless_\n>+  // they belong to a static document.  Why do static documents need\n>+  // out-of-composed-tree elements to have nsFrameLoaders, and why do static\n>+  // documents that are data documents need elements to have nsFrameLoaders?\n>+  // Is it even possible for a document to be both a static and data document?\n>+  // If so, how?\nThis isn't really useful comment. Static documents are static, and it is trivial to see\nin nsGenericHTMLFrameElement::CopyInnerTo why frameloader creation is different.\nSo, please don't add the comment, at least not in its current form.\n\nr+ for the rest.", "author": "bugs@pettay.fi", "id": 11416074, "time": "2016-05-17T20:03:26Z"}, {"text": "(In reply to Olli Pettay [:smaug] from comment #9)\n> This isn't really useful comment.\n\nMy source comment doesn't answer questions, but it poses questions that would be very useful to have answered there to make some sense of code that otherwise seems to make no sense at all. The hope would be that someone would figure out the answers and document them at some point (helping others who are trying to understand this code) or else realize the code is wrong and fix it.\n\n> Static documents are static, and it is\n> trivial to see\n> in nsGenericHTMLFrameElement::CopyInnerTo why frameloader creation is\n> different.\n\nYes, frameloader creation is different for static documents, but the code in nsGenericHTMLFrameElement::CopyInnerTo doesn't answer either of the questions I posed in that comment. Specifically:\n\n 1) Why do static documents need *out-of-composed-tree* elements to have\n    nsFrameLoaders?\n\n 2) Why do static documents that are data documents need elements to have\n    nsFrameLoaders?\n\nThe only way we create static documents seems to be via the nsIDocument::CreateStaticClone call in nsPrintObject::Init. It seems therefore that the answer to #1 is likely \"static documents are only created by cloning another document, so they can't contain out-of-composited-tree elements - this code is broken\". And it seems like the answer to #2 is \"static documents can't be data documents since data documents cannot be printed - this code is broken\".\n\nIf these answers are wrong and this code is not broken and needs to be this way, it would be very useful to have a comment explaining why. I've spent a fair bit of time trying to figure out the answers, every reader of this code shouldn't be having to do that.\n\nAnyway, sure, I'll drop the comment before checkin.", "author": "jwatt@jwatt.org", "id": 11416443, "time": "2016-05-17T21:19:42Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/b83624df78b3\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/bb06914d6e8b", "author": "pulsebot@bots.tld", "id": 11416472, "time": "2016-05-17T21:26:41Z"}, {"text": "(In reply to Jonathan Watt [:jwatt] from comment #10)\n\n> The only way we create static documents seems to be via the\n> nsIDocument::CreateStaticClone call in nsPrintObject::Init. It seems\n> therefore that the answer to #1 is likely \"static documents are only created\n> by cloning another document, so they can't contain out-of-composited-tree\n> elements - this code is broken\". \nDon't know what you mean with \"this code is broken\"\n\n> And it seems like the answer to #2 is\n> \"static documents can't be data documents since data documents cannot be\n> printed - this code is broken\".\nstatic documents are static. Used for printing and print preview, and data since they are supposed to not load anything etc.", "author": "bugs@pettay.fi", "id": 11416513, "time": "2016-05-17T21:37:41Z"}, {"text": "(In reply to Olli Pettay [:smaug] from comment #12)\n> static documents are [snip] data\n\nAh-hah! The meaning of the various \"document is this\"/\"document is that\" methods on nsIDocument may be obvious to you as someone who has written and worked in this code for years, but IsLoadedAsData, IsLoadedAsInteractiveData, and others are completely undocumented, and IsStaticDocument's documentation doesn't mention this. It may seem like I might have guessed that, but it's what I guessed for IsLoadedAsData and IsLoadedAsInteractiveData where it would seem even _more_ obvious, but as it happens that was a _bad_ guess (see bug 1273544).\n\nAnyway, this answers one of the questions I posed. I've spun off bug 1273850 for the other one.", "author": "jwatt@jwatt.org", "id": 11418295, "time": "2016-05-18T12:22:20Z"}, {"text": "I'd say IsLoadedAsInteractiveData() is rather odd case, but data and static less so.\nI wonder if IsLoadedAsInteractiveData should be just renamed to IsLoadedAsXBL() or some such.", "author": "bugs@pettay.fi", "id": 11418310, "time": "2016-05-18T12:29:36Z"}, {"text": "I think that would be a less confusing name. I'd like to also document its invariants and effects at the same time, but I'd need to figure those out. Anyway, IsLoadedAsInteractiveData specific discussion should happen in bug 1273544.", "author": "jwatt@jwatt.org", "id": 11418316, "time": "2016-05-18T12:36:02Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/b83624df78b3\nhttps://hg.mozilla.org/mozilla-central/rev/bb06914d6e8b", "author": "ryanvm@gmail.com", "id": 11418997, "time": "2016-05-18T16:18:16Z"}], "cf_last_resolved": "2016-05-18T16:18:16Z", "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "unspecified", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2016-05-18T16:18:16Z", "cf_platform_rel": "---", "product": "Core", "cf_status_firefox_esr52": "---", "blocks": [], "qa_contact": "", "see_also": [], "cf_fx_iteration": "---", "component": "DOM", "votes": 0, "cf_status_firefox49": "fixed", "groups": [], "cf_status_firefox60": "---", "target_milestone": "mozilla49", "is_cc_accessible": true, "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "jwatt@jwatt.org", "id": 32767, "name": "jwatt@jwatt.org", "real_name": "Jonathan Watt [:jwatt] (needinfo? me)"}, "whiteboard": "btpp-backlog", "mentors": [], "cc_detail": [{"email": "bugs@pettay.fi", "id": 39966, "name": "bugs@pettay.fi", "real_name": "Olli Pettay [:smaug]"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "whiteboard", "added": "btpp-backlog"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(bugs@pettay.fi)"}], "who": "overholt@mozilla.com", "when": "2016-04-22T20:02:06Z"}, {"changes": [{"removed": "needinfo?(bugs@pettay.fi)", "field_name": "flagtypes.name", "added": ""}], "who": "bugs@pettay.fi", "when": "2016-04-22T20:19:02Z"}, {"changes": [{"removed": "Avoid nsFrameLoader warning noise during startup", "field_name": "summary", "added": "Avoid WARNING: NS_ENSURE_SUCCESS(rv, rv) failed with result 0x80040111 in dom/base/nsFrameLoader.cpp during startup"}], "who": "jwatt@jwatt.org", "when": "2016-05-14T11:12:16Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "jwatt@jwatt.org"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8753087, "added": "review?(bugs@pettay.fi)"}], "who": "jwatt@jwatt.org", "when": "2016-05-16T22:36:57Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bugs@pettay.fi)", "attachment_id": 8753087, "added": "review-"}], "who": "bugs@pettay.fi", "when": "2016-05-17T09:11:57Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8753087, "added": "1"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8753470, "added": "review?(bugs@pettay.fi)"}], "who": "jwatt@jwatt.org", "when": "2016-05-17T19:16:18Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8753472, "added": "review?(bugs@pettay.fi)"}], "who": "jwatt@jwatt.org", "when": "2016-05-17T19:17:40Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bugs@pettay.fi)", "attachment_id": 8753470, "added": "review+"}], "who": "bugs@pettay.fi", "when": "2016-05-17T20:03:26Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(bugs@pettay.fi)", "attachment_id": 8753472, "added": "review+"}], "who": "bugs@pettay.fi", "when": "2016-05-17T20:04:24Z"}, {"changes": [{"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla49"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2016-05-18 16:18:16"}, {"removed": "---", "field_name": "cf_status_firefox49", "added": "fixed"}, {"removed": "NEW", "field_name": "status", "added": "RESOLVED"}], "who": "ryanvm@gmail.com", "when": "2016-05-18T16:18:16Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}