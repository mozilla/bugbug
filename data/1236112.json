{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "Steve.hack@gmail.com", "mentors_detail": [], "depends_on": [], "cf_status_firefox_esr60": "---", "cf_user_story": "", "cf_backlog": "---", "cf_tracking_firefox_relnote": "---", "platform": "x86", "keywords": [], "cc_detail": [{"email": "ajones@mozilla.com", "id": 443088, "name": "ajones@mozilla.com", "real_name": "Anthony Jones (:kentuckyfriedtakahe, :k17e)"}, {"email": "bobowencode@gmail.com", "id": 458623, "name": "bobowencode@gmail.com", "real_name": "Bob Owen (:bobowen)"}, {"email": "cpearce@mozilla.com", "id": 287422, "name": "cpearce@mozilla.com", "real_name": "Chris Pearce (:cpearce)"}, {"email": "giles@thaumas.net", "id": 170965, "name": "giles@thaumas.net", "real_name": "Ralph Giles (:rillian) | needinfo me"}, {"email": "joseph.k.olivas@intel.com", "id": 419880, "name": "joseph.k.olivas@intel.com", "real_name": "Joe Olivas"}, {"email": "jyavenard@mozilla.com", "id": 512198, "name": "jyavenard@mozilla.com", "real_name": "Jean-Yves Avenard [:jya]"}, {"email": "kg@luminance.org", "id": 339458, "name": "kg@luminance.org", "real_name": "K. Gadd (:kael)"}, {"email": "kostadin.markov@gmail.com", "id": 561897, "name": "kostadin.markov@gmail.com", "real_name": ""}, {"email": "kwierso@gmail.com", "id": 308534, "name": "kwierso@gmail.com", "real_name": "Wes Kocher (:KWierso)"}, {"email": "matt.woodrow@gmail.com", "id": 380838, "name": "matt.woodrow@gmail.com", "real_name": "Matt Woodrow (:mattwoodrow)"}, {"email": "nagym3824@gmail.com", "id": 564115, "name": "nagym3824@gmail.com", "real_name": "Nagy  M\u00e1ria"}, {"email": "ryanvm@gmail.com", "id": 75935, "name": "ryanvm@gmail.com", "real_name": "Ryan VanderMeulen [:RyanVM]"}, {"email": "sledru@mozilla.com", "id": 495955, "name": "sledru@mozilla.com", "real_name": "Sylvestre Ledru [:sylvestre]"}, {"email": "stephen.donner@gmail.com", "id": 79002, "name": "stephen.donner@gmail.com", "real_name": "Stephen Donner [:stephend]"}, {"email": "Steve.hack@gmail.com", "id": 559631, "name": "Steve.hack@gmail.com", "real_name": ""}, {"email": "Virtual@teknik.io", "id": 342842, "name": "Virtual@teknik.io", "real_name": "Virtual_ManPL [:Virtual] - (please needinfo? me - so I will see your comment/reply/question/etc.)"}, {"email": "yfdyh000@gmail.com", "id": 398515, "name": "yfdyh000@gmail.com", "real_name": "YF (Yang)"}], "cf_last_resolved": "2016-03-16T00:27:29Z", "attachments": [{"creator": "matt.woodrow@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2016-03-06T22:22:44Z", "type_id": 4, "creation_date": "2016-03-04T21:22:49Z", "id": 1354346, "setter": "cpearce@mozilla.com"}], "content_type": "text/plain", "id": 8726922}], "votes": 1, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 59, "comments": [{"text": "User Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:43.0) Gecko/20100101 Firefox/43.0\nBuild ID: 20151208100201\n\nSteps to reproduce:\n\nGo fullscreen in any 60fps video on Youtube.\n\n\nActual results:\n\nConstant screen shake.\n\nSee: https://youtu.be/2ejiiSTHwV8\n\n\nExpected results:\n\nSmooth video playback. In comparison Microsoft Edge works flawlessly.", "author": "Steve.hack@gmail.com", "id": 11039978, "time": "2016-01-01T00:40:57Z"}, {"text": "Sent from my PC but the device shown in the video is a Lenovo Yoga 2 10\" Windows 10 tablet.", "author": "Steve.hack@gmail.com", "id": 11039980, "time": "2016-01-01T00:41:48Z"}, {"text": "I should also mention this does not happen on my gaming PC, but that has an i5 3570k @ 4.3GHz / GTX 970 so it merely brute forces the issue, the tablet isn't so lucky but as I said, it can run 1080p/60fps without issue in Edge, just not Firefox nor Chrome.", "author": "Steve.hack@gmail.com", "id": 11039982, "time": "2016-01-01T00:43:43Z"}, {"text": "It's not just Youtube, it's any site that offers HTML5 60fps videos, Gamersyde.com for example. Once again Edge runs them perfectly.", "author": "Steve.hack@gmail.com", "id": 11040107, "time": "2016-01-01T07:34:45Z"}, {"text": "I don't understand the differences with them.", "author": "yfdyh000@gmail.com", "id": 11040126, "time": "2016-01-01T09:23:58Z"}, {"text": "(In reply to YF (Yang) from comment #4)\n> I don't understand the differences with them.\n\nThe screen shake only happens in full screen (or more accurately whenever I make the video player larger than default) wheras the high CPU usage happens no matter the window size. Basically I'm having lots of issues with HTML5 and 60fps content unless I use Edge. Also I downloaded a very high quality trailer at 1080p/60fps and it ran perfectly offline in media player classic so the tablet has the spec to run it, but not inFirefox for some reason.", "author": "Steve.hack@gmail.com", "id": 11040185, "time": "2016-01-01T12:38:42Z"}, {"text": "Can you please paste in the graphics section of about:support?", "author": "ajones@mozilla.com", "id": 11078271, "time": "2016-01-15T00:54:49Z"}, {"text": "[Tracking Requested - why for this release]: We appear to be displaying frames out of order under some circumstances on Windows. This needs further investigation", "author": "ajones@mozilla.com", "id": 11118413, "time": "2016-01-29T00:22:00Z"}, {"text": "*** Bug 1233815 has been marked as a duplicate of this bug. ***", "author": "ajones@mozilla.com", "id": 11118432, "time": "2016-01-29T00:31:32Z"}, {"text": "Tracking as it could be an important issue.\n\nJean-Yves, does it ring a bell? Thanks", "author": "sledru@mozilla.com", "id": 11153411, "time": "2016-02-10T11:34:29Z"}, {"text": "Unfortunately, no..\n\nThis appears to be a windows only issue.\n\nWe believe to be a race in the gfx code.", "author": "jyavenard@mozilla.com", "id": 11153427, "time": "2016-02-10T11:41:05Z"}, {"text": "Do you think it is actionable in the 45 timeframe? Thanks", "author": "sledru@mozilla.com", "id": 11153428, "time": "2016-02-10T11:42:10Z"}, {"text": "Hard to say..\n\nIt will depend if we can reproduce it or not.\nThe reported hasn't responded to our request for information. We do not know what graphic cards his uses or much details about his configuration", "author": "jyavenard@mozilla.com", "id": 11153434, "time": "2016-02-10T11:45:45Z"}, {"text": "(In reply to Jean-Yves Avenard [:jya] from comment #12)\n> Hard to say..\n> \n> It will depend if we can reproduce it or not.\n> The reported hasn't responded to our request for information. We do not know\n> what graphic cards his uses or much details about his configuration\n\nThe reporter listed their two machines, a Yoga 2 and a desktop with a GTX 970. I no longer own it but I previously owned a Yoga 2 which had onboard Intel graphics.\n\nI have this problem with my current desktop (Windows 10 x64, GTX 980ti) and my previous desktop configuration (Windows 10 x64, GTX 970 - separate install, not upgrade). See bug #1233815 if you need more on my configuration but it's basically the same problem - albeit much, much harder to reproduce for me than it seems to be for the reporter of this bug.\n\nFWIW, for me it applies to all html5 videos, fullscreen or not. It's easier to notice in fullscreen though and isn't 100% reproducible for me. It comes and goes.", "author": "kg@luminance.org", "id": 11153570, "time": "2016-02-10T12:52:26Z"}, {"text": "you mentioned that it was something new.\n\nAny chance you could use the mozregression tool to find out which commit introduced the problem?\n\nit shouldn't take too long hopefully. So long as you now approximately when a problem started.\n\nhttp://mozilla.github.io/mozregression/install.html", "author": "jyavenard@mozilla.com", "id": 11153591, "time": "2016-02-10T12:58:25Z"}, {"text": "It takes days for me to reproduce, so mozregression isn't going to be any use. It seems like for Steve.hack it's very easy to reproduce, though, so maybe they could use mozregression on it?", "author": "kg@luminance.org", "id": 11154901, "time": "2016-02-10T18:55:00Z"}, {"text": "https://www.youtube.com/watch?v=xvOAZ0TWWgg reproduces this for me (for the record, having a link to an actual video instead of saying \"any video that...\" would have saved me a bit of time hunting around in the beginning). I can also reproduce this getting worse between Fx42 and Fx43.", "author": "ryanvm@gmail.com", "id": 11162711, "time": "2016-02-12T21:41:15Z"}, {"text": "Note that the controls need to be visible for it to reproduce AFAICT.", "author": "ryanvm@gmail.com", "id": 11162724, "time": "2016-02-12T21:47:47Z"}, {"text": "Moving the mouse around makes it easier to hit too. Mozregression is pointing at bug 1217185 for me. So I guess now I need to try to re-bisect this with e10s disabled to find what broke this on non-e10s builds.", "author": "ryanvm@gmail.com", "id": 11162772, "time": "2016-02-12T22:07:08Z"}, {"text": "With e10s disabled, I get the following regression range: https://hg.mozilla.org/integration/mozilla-inbound/pushloghtml?fromchange=c48f8f05e6d9eea2af3f20ac8c49eb8aa653d0f8&tochange=e26240900b5aa9432c69bcbe39f64dafac60be86\n\nI'm guessing this is from bug 1198202? At least the regression range fits this breaking in 43.", "author": "ryanvm@gmail.com", "id": 11162877, "time": "2016-02-12T22:46:37Z"}, {"text": "On Mac; with 44; sometimes having the playback cursor displayed; hovering over it with the mouse causes flickering but only if the overlay. Not the whole image. Not sure if this is related.", "author": "jyavenard@mozilla.com", "id": 11163031, "time": "2016-02-12T23:36:42Z"}, {"text": "Both of those regression ranges point to when DXVA was enabled for that specific configuration.\n\nI strongly suspect that we're racing on access the D3D9 textures.\n\nThe H264 MF Transform maintains a pool of D3D9 textures to decode into, and I suspect that it's reusing one before we've managed to copy the pixels we need out of it.\n\nUnfortunately we don't have the source code for the MF Transform (it's provided as part of Windows), but this MSDN article [1] describes how to write our own one and I assume matches the behaviour fairly closely.\n\nParts that stands out is \"Call IMFTrackedSample::SetAllocator and provide a pointer to the IMFAsyncCallback interface, implemented by the decoder. When the video renderer releases the sample, the decoder's callback will be invoked.\" and \"Use the callback from the SetAllocator method (step 3) to keep track of which samples are currently available and which are in use.\"\n\nMy understanding of this, is that when the last reference to the IMFSample is released by our code, a callback fires within the MF Transform that marks the surface as being available for use again.\n\nOur code for copying data out of the IMFSamples is asynchronous, but we don't hold on to a pointer to the IMFSample while we wait, only the D3D9 texture.\n\nIt's believable that these things could be racy, since our copy/colour conversion uses the standard GPU paths, and decoding uses specialized silicon. I doubt D3D9 provides synchronization between these.\n\nA simple solution would be to hold a reference to the IMFSample in the D3D9SurfaceImage, and release it when the query completes. I'm not sure what happens if the decoder thread runs out of available samples though, especially if for some reason the MDSM isn't flushing the existing ones. Little worried out deadlock in that case.\n\nA better fix might be to keep the output within the decoder thread, and only pass them back through the Output() callback once we've finished resolving them and we know the IMFSample can be released. That's a bigger refactoring though.\n\nIt's also possible that bug 1079533 could fix this, since the colour conversion should instead happen on dedicated silicon, and this might enforce ordering with the decoder.\n\nExperimenting with the MF_SA_MINIMUM_OUTPUT_SAMPLE_COUNT attribute might make this problem easier/harder to reproduce. I don't think that's a good long term fix.\n\nI won't have time to look into this more over the next few weeks, Chris or Jean-Yves, do either of you have time to play with with?\n\n\n\n[1] https://msdn.microsoft.com/en-us/library/windows/desktop/aa965266%28v=vs.85%29.aspx", "author": "matt.woodrow@gmail.com", "id": 11163203, "time": "2016-02-13T01:14:40Z"}, {"text": "Joe, do you know if VideoProcessBlt would have defined ordering with DXVA video decoding, or would we still need to synchronize ourselves?\n\nI realize that the answer to that might be driver/hardware/architecture specific.\n\nThanks!", "author": "matt.woodrow@gmail.com", "id": 11163225, "time": "2016-02-13T01:27:14Z"}, {"text": "I remember when we had that issue on Mac, all we had to do is set a pointer somewhere and the IOsurface wouldn't get recycled until it had been composited...\n\nIsn't the same done with D3D surface??\n\nWhy would it be any different on Windows than on Mac? The Mac decoder too uses its own pool of frames.", "author": "jyavenard@mozilla.com", "id": 11163272, "time": "2016-02-13T02:26:47Z"}, {"text": "Could someone please test with the pref 'media.windows-media-foundation.allow-d3d11-dxva' set to true (on Windows 8 or higher) and see if that helps at all?", "author": "matt.woodrow@gmail.com", "id": 11167174, "time": "2016-02-16T03:13:48Z"}, {"text": "Works flawlessly. No dropped frames either (and video is noticeably smoother!).", "author": "ryanvm@gmail.com", "id": 11167181, "time": "2016-02-16T03:23:42Z"}, {"text": "Awesome, thanks Ryan!\n\nThe D3D11 DXVA version of the code uses the 'CLSID_VideoProcessorMFT' MFTransform for doing colour conversion, which I suspect is similar to VideoProcessBlt (and possibly uses that internally).\n\nI checked what Chromium is doing, and they indeed hold a reference to the IMFSample for the duration of the colour conversion copy, but only when using d3d9.\n\nI think it's worth trying to get the VideoProcessBlt code working for d3d9 (since it should be faster, and fixes our colour-space problem), and it may very well fix this bug for Windows 7 users.\n\n\nBug 1079533 was filed for the potential perf wins of VideoProcessBlt, and bug 1161349 is for the colour-space problems. The latter has a patch, but unfortunately it works everywhere except NVIDIA cards.\n\nWas anyone able to reproduce this bug on an intel or AMD GPU?\n\nI've opened bug 1248496 to get D3D11 DXVA enabled by default, that'll make life better for Windows 8+ users.", "author": "matt.woodrow@gmail.com", "id": 11167197, "time": "2016-02-16T03:48:34Z"}, {"text": "Steve, what GPU do you have in the Yoga 2?\n\nCan you please paste in the graphics section of about:support?\n\nThanks!", "author": "matt.woodrow@gmail.com", "id": 11167201, "time": "2016-02-16T03:50:58Z"}, {"text": "To clarify, VideoProcessBlt is part of the d3d9 interface to DXVA, the D3D11 MFTransform almost certainly uses the d3d11 equivalent: ID3D11VideoContext/ID3D11VideoProcessor.\n\nI think it's reasonable to believe that the d3d9 one would fix this bug in the same way though :)", "author": "matt.woodrow@gmail.com", "id": 11167205, "time": "2016-02-16T04:00:05Z"}, {"text": "(In reply to Matt Woodrow (:mattwoodrow) from comment #24)\n> Could someone please test with the pref\n> 'media.windows-media-foundation.allow-d3d11-dxva' set to true (on Windows 8\n> or higher) and see if that helps at all?\n\nWhich builds have this pref? I don't see it with a default value of false (or otherwise) in Developer Edition. I'll set it anyway and see what happens, but I'm guessing maybe I need Nightly?", "author": "kg@luminance.org", "id": 11167257, "time": "2016-02-16T04:59:34Z"}, {"text": "(In reply to K. Gadd (:kael) from comment #29)\n> \n> Which builds have this pref? I don't see it with a default value of false\n> (or otherwise) in Developer Edition. I'll set it anyway and see what\n> happens, but I'm guessing maybe I need Nightly?\n\nAll of them up to release. It's just not in about:config by default, adding it yourself should work.", "author": "matt.woodrow@gmail.com", "id": 11167420, "time": "2016-02-16T08:10:13Z"}, {"text": "I was able to reproduce this on Intel HW on this video: https://www.youtube.com/watch?v=79ImZE0K7xc \n\nAfter going into fullscreen, at about 10 seconds in (when the guy in the blue helmet gets near the camera), the video gets shaky and goes to hell :)\n\nSetting media.windows-media-foundation.allow-d3d11-dxva to true seems to fix this.\n\nAs for the enforced ordering for VideoProcessBlt, I need to check. I'll leave needinfo open.\n\nHere's my adapter info.\n\nAdapter Description\tIntel(R) HD Graphics 4600\nAdapter Drivers\tigdumdim64 igd10iumd64 igd10iumd64 igd12umd64 igdumdim32 igd10iumd32 igd10iumd32 igd12umd32\nAdapter RAM\tUnknown\nAsynchronous Pan/Zoom\tnone\nDevice ID\t0x0416\nDirect2D Enabled\ttrue\nDirectWrite Enabled\ttrue (10.0.10586.0)\nDriver Date\t11-18-2015\nDriver Version\t20.19.15.4331\nGPU #2 Active\tfalse\nGPU Accelerated Windows\t1/1 Direct3D 11 (OMTC)\nSubsys ID\t22128086\nSupports Hardware H264 Decoding\tYes\nVendor ID\t0x8086\nWebGL Renderer\tGoogle Inc. -- ANGLE (Intel(R) HD Graphics 4600 Direct3D11 vs_5_0 ps_5_0)\nwindowLayerManagerRemote\ttrue\nAzureCanvasBackend\tdirect2d 1.1\nAzureContentBackend\tdirect2d 1.1\nAzureFallbackCanvasBackend\tcairo\nAzureSkiaAccelerated\t0", "author": "joseph.k.olivas@intel.com", "id": 11168443, "time": "2016-02-16T16:26:21Z"}, {"text": "Answer I got on VideoProcessBlt is that it's a MSFT question :) Sorry I couldn't provide more on it.", "author": "joseph.k.olivas@intel.com", "id": 11170344, "time": "2016-02-16T23:55:21Z"}, {"text": "(In reply to Joe Olivas from comment #32)\n> Answer I got on VideoProcessBlt is that it's a MSFT question :) Sorry I\n> couldn't provide more on it.\n\nNo worries, it was worth a shot. Will just have to test it instead!\n\nI've done a build with VideoProcessBlt for d3d9:\n\nhttp://archive.mozilla.org/pub/firefox/try-builds/mwoodrow@mozilla.com-f5c90693d91e885f78fe9ec01d65642efda22f66/try-win32/\n\nCould you (or anyone else that can reproduce this) test this please? It will need media.windows-media-foundation.allow-d3d11-dxva to be set to false again to be useful.\n\nThanks!\n\n\nI wasn't able to reproduce on my HD 3000, and the patch still doesn't work for NVIDIA :(", "author": "matt.woodrow@gmail.com", "id": 11170458, "time": "2016-02-17T00:33:00Z"}, {"text": "Ryan, any chance you could check this one too please? (With the d3d11 pref set to false)\n\nThanks!", "author": "matt.woodrow@gmail.com", "id": 11170860, "time": "2016-02-17T03:48:52Z"}, {"text": "(In reply to Matt Woodrow (:mattwoodrow) from comment #33)\n> Could you (or anyone else that can reproduce this) test this please? It will\n> need media.windows-media-foundation.allow-d3d11-dxva to be set to false\n> again to be useful.\n\nI tried the build this morning and the video plays about 5x slower, but no jerkiness :)\n\nI'll take a look at it again this afternoon and see if I can find anything obvious.", "author": "joseph.k.olivas@intel.com", "id": 11172447, "time": "2016-02-17T16:32:13Z"}, {"text": "Is there an updated/rebased patch for VideoProcessBlt that I can apply locally?", "author": "joseph.k.olivas@intel.com", "id": 11172798, "time": "2016-02-17T17:58:22Z"}, {"text": "(In reply to Joe Olivas from comment #36)\n> Is there an updated/rebased patch for VideoProcessBlt that I can apply\n> locally?\n\nhttps://hg.mozilla.org/try/raw-rev/686371be9d4a\n\nIt's re-creating the video processor each frame, that could be related to the slowness.", "author": "matt.woodrow@gmail.com", "id": 11173362, "time": "2016-02-17T20:30:31Z"}, {"text": "I'm seeing 50% of clocks in igdumdim32.dll stemming from CVideoProcessorDevice::VideoProcessBlt, and only 2.9% in cVideoAccelerationService::CreateVideoProcessor.\n\n19% of our clocks are in xul.dll, but nothing significant; everything is under 0.5%.\n\nHottest stack to the VideoProcessBlt makes sense with the new patch:\n\nigdumdim32.dll ! func@0x10138450 - [unknown source file]\nigdumdim32.dll ! func@0x10158920 + 0x19 - [unknown source file]\nigdumdim32.dll ! func@0x1025b870 + 0x82 - [unknown source file]\nigdumdim32.dll ! func@0x1032eb50 + 0x2d7 - [unknown source file]\nigdumdim32.dll ! func@0x10261a80 + 0xd4 - [unknown source file]\nigdumdim32.dll ! func@0x1025b48f + 0x1cc - [unknown source file]\nigdumdim32.dll ! func@0x101b69d0 + 0x14a - [unknown source file]\nigdumdim32.dll ! func@0x101b7250 + 0xd3 - [unknown source file]\nigdumdim32.dll ! func@0x101b7610 + 0xc6 - [unknown source file]\nigdumdim32.dll ! func@0x101b79f0 + 0x65f - [unknown source file]\nigdumdim32.dll ! func@0x101b8535 + 0x18 - [unknown source file]\nigdumdim32.dll ! func@0x101798ef + 0x1fb - [unknown source file]\nigdumdim32.dll ! func@0x1016222f + 0xbd - [unknown source file]\nd3d9.dll ! VideoProcessBltLH + 0x160 - [unknown source file]\nd3d9.dll ! CVideoProcessDevice::VideoProcessBlt + 0xf0 - [unknown source file]\ndxva2.dll ! CVideoProcessorDevice::VideoProcessBlt + 0x3b0 - [unknown source file]\nxul.dll ! mozilla::layers::D3D9SurfaceImage::AllocateAndCopy + 0x39f - d3d9surfaceimage.cpp:140\nxul.dll ! mozilla::D3D9DXVA2Manager::CopyToImage + 0x88 - dxva2manager.cpp:427\nxul.dll ! mozilla::WMFVideoMFTManager::CreateD3DVideoFrame + 0x6d - wmfvideomftmanager.cpp:536\nxul.dll ! mozilla::WMFVideoMFTManager::Output + 0x139 - wmfvideomftmanager.cpp:622\nxul.dll ! mozilla::WMFMediaDataDecoder::ProcessOutput + 0x33 - wmfmediadatadecoder.cpp:152\nxul.dll ! mozilla::WMFMediaDataDecoder::ProcessDecode + 0x6b - wmfmediadatadecoder.cpp:144\nxul.dll ! nsRunnableMethodImpl<void ( mozilla::dom::workers::ServiceWorkerJobBase::*)(enum nsresult),1,enum nsresult>::Run + 0x10 - nsthreadutils.h:870\nxul.dll ! mozilla::TaskQueue::Runner::Run + 0x84 - taskqueue.cpp:170\nxul.dll ! nsThreadPool::Run + 0x2f2 - nsthreadpool.cpp:227\nxul.dll ! nsThread::ProcessNextEvent + 0x3f3 - nsthread.cpp:1018\nxul.dll ! NS_ProcessNextEvent + 0x25 - nsthreadutils.cpp:297\nxul.dll ! mozilla::ipc::MessagePumpForNonMainThreads::Run + 0xdd - messagepump.cpp:355\nxul.dll ! MessageLoop::RunHandler + 0x52 - message_loop.cc:227\nxul.dll ! MessageLoop::Run + 0x18 - message_loop.cc:201\nxul.dll ! nsThread::ThreadFunc + 0xb2 - nsthread.cpp:411\nnss3.dll ! PR_NativeRunThread + 0xc0 - pruthr.c:397\nnss3.dll ! pr_root + 0xa - w95thred.c:95\nucrtbase.dll ! func@0x10086230 + 0x73 - [unknown source file]\nkernel32.dll ! BaseThreadInitThunk + 0x23 - [unknown source file]\nntdll.dll ! _RtlUserThreadStart + 0x2e - [unknown source file]\nntdll.dll ! _RtlUserThreadStart + 0x1a - [unknown source file]", "author": "joseph.k.olivas@intel.com", "id": 11173822, "time": "2016-02-17T22:43:57Z"}, {"text": "*** Bug 1243619 has been marked as a duplicate of this bug. ***", "author": "kostadin.markov@gmail.com", "id": 11191728, "time": "2016-02-24T16:36:41Z"}, {"text": "(In reply to Matt Woodrow (:mattwoodrow) from comment #24)\n> Could someone please test with the pref\n> 'media.windows-media-foundation.allow-d3d11-dxva' set to true (on Windows 8\n> or higher) and see if that helps at all?\n\nFTR, I've had this set for a few days now and it seems to mitigate it for me. Is there a reason why I should prefer to try VideoProcessBlt instead if it's way slower?", "author": "kg@luminance.org", "id": 11192417, "time": "2016-02-24T19:27:02Z"}, {"text": "Tracking for 46+. Matt, are you working on this one? \nIt seems late to get in a fix for 45 as we're going to build for the 45 RC on Monday.", "author": "lhenry@mozilla.com", "id": 11199741, "time": "2016-02-26T20:30:27Z"}, {"text": "(In reply to K. Gadd (:kael) from comment #40)\n> (In reply to Matt Woodrow (:mattwoodrow) from comment #24)\n> > Could someone please test with the pref\n> > 'media.windows-media-foundation.allow-d3d11-dxva' set to true (on Windows 8\n> > or higher) and see if that helps at all?\n> \n> FTR, I've had this set for a few days now and it seems to mitigate it for\n> me. Is there a reason why I should prefer to try VideoProcessBlt instead if\n> it's way slower?\n\nI seem to have spoken too soon. While the dxva pref seems to dramatically reduce the severity of the bug (I haven't ever seen *multiple* back-to-back frame glitches with it on, while I saw that very frequently before), the bug isn't gone. I saw at least 5 out-of-order frames during the first 5 minutes of watching https://www.youtube.com/watch?v=m8Sa5dUAXgw in fullscreen, and I'm seeing it intermittently in other html5 videos (gifs on twitter, etc). It's possible what I'm seeing is Bug 1206526 applied to video, though, and not the video processor problem, since 1206526 is still a near-constant menace for me.", "author": "kg@luminance.org", "id": 11207405, "time": "2016-03-01T15:45:11Z"}, {"text": "jean-yves, any chance you can work on this or the related bug? \nWontfix for 45 and 46; since no one is assigned it seems unlikely we will get a fix before 47.", "author": "lhenry@mozilla.com", "id": 11207548, "time": "2016-03-01T16:36:49Z"}, {"text": "I'm afraid not.. This is a gfx / D3D bug, well outside my area of expertise.. \nMatt would be able to answer this question hopefully", "author": "jyavenard@mozilla.com", "id": 11214261, "time": "2016-03-03T09:14:23Z"}, {"text": "Created attachment 8726922\nflush-d3d9-video-sync\n\nSo, according to the docs, we need to hold a ref to the IMFSample object for as long as we are using the texture.\n\nThe decoder transform uses gets a callback when the IMFSample refcount drops to 1, and uses this to decide when to reuse the texture.\n\nWe could store a reference to the IMFSample in the D3D9SurfaceImage, but we'd risk deadlocking the decoder if it ran out of samples, so we'd need to make sure we're frequently checking for the query completion and dropping the ref.\n\nJust synchronously blocking the decoder thread until the copy completes is a lot simpler and safer, but it's possible that it might reduce the concurrency between decoding and copying. That really depends on how the decoder MFT works.\n\nThe other option is to change the code a bit so that the WMF Output function can return results asynchronously. That way we'd be able to post the query wait back to our own thread, and maybe queue up some more frames in the mean time. This is a lot more complicated change though.\n\nChris, would you be able to test this on some of the low power devices that you used when writing this initially? I'll try spend a day in the Auckland office next week to help too.", "author": "matt.woodrow@gmail.com", "id": 11220216, "time": "2016-03-04T21:22:49Z"}, {"text": "(In reply to Matt Woodrow (:mattwoodrow) from comment #45)\n> Chris, would you be able to test this on some of the low power devices that\n> you used when writing this initially? I'll try spend a day in the Auckland\n> office next week to help too.\n\nI am unable to observe any performance difference with this patch applied on the low end devices that I have.", "author": "cpearce@mozilla.com", "id": 11222644, "time": "2016-03-07T01:52:17Z"}, {"text": "Matt - can we assign this bug to you?", "author": "ajones@mozilla.com", "id": 11222688, "time": "2016-03-07T02:20:06Z"}, {"text": "(In reply to Anthony Jones (:kentuckyfriedtakahe, :k17e) from comment #47)\n> Matt - can we assign this bug to you?\n\nYes.\n\n(In reply to Chris Pearce (:cpearce) from comment #46) \n> I am unable to observe any performance difference with this patch applied on\n> the low end devices that I have.\n\nAwesome, thanks for testing this.", "author": "matt.woodrow@gmail.com", "id": 11225656, "time": "2016-03-07T22:20:04Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/6358a64e4f15", "author": "pulsebot@bots.tld", "id": 11229391, "time": "2016-03-08T21:36:16Z"}, {"text": "This appears to have caused a few web platform tests to permafail on windows:\nhttps://treeherder.mozilla.org/logviewer.html#?job_id=23289015&repo=mozilla-inbound\nhttps://treeherder.mozilla.org/logviewer.html#?job_id=23284417&repo=mozilla-inbound\n\nBacked out in https://hg.mozilla.org/integration/mozilla-inbound/rev/4547c228e988", "author": "kwierso@gmail.com", "id": 11230124, "time": "2016-03-09T00:23:15Z"}, {"text": "This seems to have broken a mochitest, too: https://treeherder.mozilla.org/logviewer.html#?job_id=23283008&repo=mozilla-inbound", "author": "kwierso@gmail.com", "id": 11230184, "time": "2016-03-09T00:50:57Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/6d8001b49fea", "author": "pulsebot@bots.tld", "id": 11246917, "time": "2016-03-15T09:17:44Z"}, {"text": "(In reply to K. Gadd (:kael) from comment #42)\n> I seem to have spoken too soon. While the dxva pref seems to dramatically\n> reduce the severity of the bug (I haven't ever seen *multiple* back-to-back\n> frame glitches with it on, while I saw that very frequently before), the bug\n> isn't gone. I saw at least 5 out-of-order frames during the first 5 minutes\n> of watching https://www.youtube.com/watch?v=m8Sa5dUAXgw in fullscreen, and\n> I'm seeing it intermittently in other html5 videos (gifs on twitter, etc).\n> It's possible what I'm seeing is Bug 1206526 applied to video, though, and\n> not the video processor problem, since 1206526 is still a near-constant\n> menace for me.\n\nI think I understand why this is now. I've filed bug 1257013 to fix it.", "author": "matt.woodrow@gmail.com", "id": 11249917, "time": "2016-03-15T23:36:40Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/6d8001b49fea", "author": "kwierso@gmail.com", "id": 11250036, "time": "2016-03-16T00:27:29Z"}, {"text": "Comment on attachment 8726922\nflush-d3d9-video-sync\n\nThis patch is entirely superceeded by the patches in bug 1257013, and all the code that moves with this patch is deleted.\n\nIt's just quite painful to rebase bug 1257013 around this, so we should just uplift this as well and make life easier.", "author": "matt.woodrow@gmail.com", "id": 11325738, "time": "2016-04-14T10:29:04Z"}, {"text": "Comment on attachment 8726922\nflush-d3d9-video-sync\n\nThis is needed to uplift the patches from bug 1257013.", "author": "rkothari@mozilla.com", "id": 11327978, "time": "2016-04-14T21:44:17Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-aurora/rev/c7b83c2dddd3", "author": "cbook@mozilla.com", "id": 11329782, "time": "2016-04-15T13:37:19Z"}, {"text": "*** Bug 1236107 has been marked as a duplicate of this bug. ***", "author": "Virtual@teknik.io", "id": 11335593, "time": "2016-04-18T21:23:32Z"}], "id": 1236112, "priority": "P1", "cc": ["ajones@mozilla.com", "bobowencode@gmail.com", "cpearce@mozilla.com", "giles@thaumas.net", "joseph.k.olivas@intel.com", "jyavenard@mozilla.com", "kg@luminance.org", "kostadin.markov@gmail.com", "kwierso@gmail.com", "matt.woodrow@gmail.com", "nagym3824@gmail.com", "ryanvm@gmail.com", "sledru@mozilla.com", "stephen.donner@gmail.com", "Steve.hack@gmail.com", "Virtual@teknik.io", "yfdyh000@gmail.com"], "cf_crash_signature": "", "version": "43 Branch", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_thunderbird_esr60": "---", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1217185, 1246724, 1257013], "qa_contact": "", "creation_time": "2016-01-01T00:40:57Z", "cf_status_firefox_esr52": "---", "component": "Audio/Video: Playback", "assigned_to_detail": {"email": "matt.woodrow@gmail.com", "id": 380838, "name": "matt.woodrow@gmail.com", "real_name": "Matt Woodrow (:mattwoodrow)"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "---", "cf_status_firefox60": "---", "target_milestone": "mozilla48", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "Steve.hack@gmail.com", "id": 559631, "name": "Steve.hack@gmail.com", "real_name": ""}, "whiteboard": "", "mentors": [], "summary": "Full screen 60fps videos cause constant screen shake", "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [{"requestee": "Steve.hack@gmail.com", "status": "?", "name": "needinfo", "modification_date": "2016-02-16T03:50:58Z", "type_id": 800, "creation_date": "2016-02-16T03:50:58Z", "id": 1342885, "setter": "matt.woodrow@gmail.com"}], "last_change_time": "2016-04-18T21:24:05Z", "assigned_to": "matt.woodrow@gmail.com", "is_open": false, "history": [{"changes": [{"removed": "Unspecified", "field_name": "platform", "added": "x86"}, {"removed": "Unspecified", "field_name": "op_sys", "added": "Windows 10"}], "who": "Steve.hack@gmail.com", "when": "2016-01-01T00:41:19Z"}, {"changes": [{"removed": "Fullscreen on Youtube causes constant screen shake at 60fps", "field_name": "summary", "added": "Full screen 60fps videos cause constant screen shake"}], "who": "Steve.hack@gmail.com", "when": "2016-01-01T07:32:43Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "yfdyh000@gmail.com"}, {"removed": "Untriaged", "field_name": "component", "added": "Audio/Video: Playback"}, {"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1236107"}, {"removed": "Firefox", "field_name": "product", "added": "Core"}], "who": "yfdyh000@gmail.com", "when": "2016-01-01T09:23:58Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P1"}, {"removed": "", "field_name": "cc", "added": "giles@thaumas.net"}], "who": "giles@thaumas.net", "when": "2016-01-15T00:52:57Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "ajones@mozilla.com"}], "who": "ajones@mozilla.com", "when": "2016-01-15T00:54:49Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "bernesb@gmail.com, Steve.hack@gmail.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(Steve.hack@gmail.com)"}], "who": "Virtual@teknik.io", "when": "2016-01-28T12:23:44Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "jyavenard@mozilla.com"}], "who": "jyavenard@mozilla.com", "when": "2016-01-29T00:20:33Z"}, {"changes": [{"removed": "---", "field_name": "cf_tracking_firefox45", "added": "?"}], "who": "ajones@mozilla.com", "when": "2016-01-29T00:22:00Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "kg@luminance.org"}], "who": "ajones@mozilla.com", "when": "2016-01-29T00:31:32Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1243619"}], "who": "cpeterson@mozilla.com", "when": "2016-02-01T20:36:01Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "sledru@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(jyavenard@mozilla.com)"}, {"removed": "?", "field_name": "cf_tracking_firefox45", "added": "+"}, {"removed": "---", "field_name": "cf_status_firefox45", "added": "affected"}], "who": "sledru@mozilla.com", "when": "2016-02-10T11:34:29Z"}, {"changes": [{"removed": "needinfo?(jyavenard@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "jyavenard@mozilla.com", "when": "2016-02-10T11:41:05Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "ryanvm@gmail.com"}], "who": "ryanvm@gmail.com", "when": "2016-02-12T21:41:15Z"}, {"changes": [{"removed": "UNCONFIRMED", "field_name": "status", "added": "NEW"}, {"removed": "", "field_name": "cc", "added": "bobowen.code@gmail.com"}, {"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1243619"}, {"removed": "1243619", "field_name": "blocks", "added": "1217185"}, {"removed": "0", "field_name": "is_confirmed", "added": "1"}, {"removed": "needinfo?(Steve.hack@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "ryanvm@gmail.com", "when": "2016-02-12T22:07:08Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "matt.woodrow@gmail.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(matt.woodrow@gmail.com)"}, {"removed": "---", "field_name": "cf_status_firefox44", "added": "wontfix"}, {"removed": "---", "field_name": "cf_tracking_firefox46", "added": "?"}, {"removed": "---", "field_name": "cf_status_firefox46", "added": "affected"}, {"removed": "---", "field_name": "cf_tracking_firefox47", "added": "?"}, {"removed": "---", "field_name": "cf_status_firefox47", "added": "affected"}], "who": "ryanvm@gmail.com", "when": "2016-02-12T22:46:37Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "cpearce@mozilla.com"}, {"removed": "needinfo?(matt.woodrow@gmail.com)", "field_name": "flagtypes.name", "added": "needinfo?(cpearce@mozilla.com)"}], "who": "matt.woodrow@gmail.com", "when": "2016-02-13T01:14:55Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "joseph.k.olivas@intel.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(joseph.k.olivas@intel.com)"}], "who": "matt.woodrow@gmail.com", "when": "2016-02-13T01:27:14Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "stephen.donner@gmail.com"}], "who": "stephen.donner@gmail.com", "when": "2016-02-13T04:40:49Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(ryanvm@gmail.com)"}], "who": "matt.woodrow@gmail.com", "when": "2016-02-16T03:15:49Z"}, {"changes": [{"removed": "needinfo?(ryanvm@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "ryanvm@gmail.com", "when": "2016-02-16T03:23:42Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(Steve.hack@gmail.com)"}], "who": "matt.woodrow@gmail.com", "when": "2016-02-16T03:50:58Z"}, {"changes": [{"removed": "needinfo?(joseph.k.olivas@intel.com)", "field_name": "flagtypes.name", "added": ""}], "who": "joseph.k.olivas@intel.com", "when": "2016-02-16T23:55:21Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(joseph.k.olivas@intel.com)"}], "who": "matt.woodrow@gmail.com", "when": "2016-02-17T00:33:00Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(ryanvm@gmail.com)"}], "who": "matt.woodrow@gmail.com", "when": "2016-02-17T03:48:52Z"}, {"changes": [{"removed": "needinfo?(joseph.k.olivas@intel.com)", "field_name": "flagtypes.name", "added": ""}], "who": "joseph.k.olivas@intel.com", "when": "2016-02-17T16:32:13Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(matt.woodrow@gmail.com)"}], "who": "joseph.k.olivas@intel.com", "when": "2016-02-17T17:58:22Z"}, {"changes": [{"removed": "needinfo?(matt.woodrow@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "matt.woodrow@gmail.com", "when": "2016-02-17T20:30:31Z"}, {"changes": [{"removed": "needinfo?(ryanvm@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "ryanvm@gmail.com", "when": "2016-02-18T21:10:21Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "nagym3824@gmail.com"}], "who": "nagym3824@gmail.com", "when": "2016-02-21T18:16:30Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "kostadin.markov@gmail.com"}], "who": "kostadin.markov@gmail.com", "when": "2016-02-24T16:36:41Z"}, {"changes": [{"removed": "?", "field_name": "cf_tracking_firefox46", "added": "+"}, {"removed": "?", "field_name": "cf_tracking_firefox47", "added": "+"}], "who": "lhenry@mozilla.com", "when": "2016-02-26T20:30:27Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(jyavenard@mozilla.com)"}, {"removed": "affected", "field_name": "cf_status_firefox45", "added": "wontfix"}, {"removed": "affected", "field_name": "cf_status_firefox46", "added": "wontfix"}], "who": "lhenry@mozilla.com", "when": "2016-03-01T16:36:49Z"}, {"changes": [{"removed": "needinfo?(jyavenard@mozilla.com)", "field_name": "flagtypes.name", "added": "needinfo?(matt.woodrow@gmail.com)"}], "who": "jyavenard@mozilla.com", "when": "2016-03-03T09:14:23Z"}, {"changes": [{"removed": "needinfo?(matt.woodrow@gmail.com)", "field_name": "flagtypes.name", "added": ""}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8726922, "added": "review?(cpearce@mozilla.com)"}], "who": "matt.woodrow@gmail.com", "when": "2016-03-04T21:22:49Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(cpearce@mozilla.com)", "attachment_id": 8726922, "added": "review+"}], "who": "cpearce@mozilla.com", "when": "2016-03-06T22:22:44Z"}, {"changes": [{"removed": "needinfo?(cpearce@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "cpearce@mozilla.com", "when": "2016-03-06T22:31:25Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(matt.woodrow@gmail.com)"}], "who": "ajones@mozilla.com", "when": "2016-03-07T02:20:06Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "matt.woodrow@gmail.com"}, {"removed": "needinfo?(matt.woodrow@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "matt.woodrow@gmail.com", "when": "2016-03-07T22:20:04Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "wkocher@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(matt.woodrow@gmail.com)"}], "who": "kwierso@gmail.com", "when": "2016-03-09T00:23:15Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1246724"}], "who": "suro001@gmail.com", "when": "2016-03-14T12:23:46Z"}, {"changes": [{"removed": "needinfo?(matt.woodrow@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "matt.woodrow@gmail.com", "when": "2016-03-15T23:36:40Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla48"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2016-03-15 17:27:29"}, {"removed": "---", "field_name": "cf_status_firefox48", "added": "fixed"}], "who": "kwierso@gmail.com", "when": "2016-03-16T00:27:29Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1257013"}], "who": "matt.woodrow@gmail.com", "when": "2016-04-14T10:27:05Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8726922, "added": "approval-mozilla-aurora?"}], "who": "matt.woodrow@gmail.com", "when": "2016-04-14T10:29:04Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "approval-mozilla-aurora?", "attachment_id": 8726922, "added": ""}], "who": "rkothari@mozilla.com", "when": "2016-04-14T21:44:17Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox47", "added": "fixed"}], "who": "cbook@mozilla.com", "when": "2016-04-15T13:37:19Z"}, {"changes": [{"removed": "https://bugzilla.mozilla.org/show_bug.cgi?id=1236107", "field_name": "see_also", "added": ""}], "who": "Virtual@teknik.io", "when": "2016-04-18T21:23:32Z"}, {"changes": [{"removed": "https://bugzilla.mozilla.org/show_bug.cgi?id=1243619", "field_name": "see_also", "added": ""}], "who": "Virtual@teknik.io", "when": "2016-04-18T21:24:05Z"}], "resolution": "FIXED", "op_sys": "Windows 10", "cf_fx_points": "---", "cf_blocking_fennec": "---"}