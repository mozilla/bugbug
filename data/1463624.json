{"status": "VERIFIED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "classification": "Client Software", "creator": "rfkelly@mozilla.com", "cc": ["apavel@mozilla.com", "eoger@fastmail.com", "markh@mozilla.com", "mcastelluccio@mozilla.com", "oana.botisan@softvision.ro", "ryanvm@gmail.com", "simion.basca@softvision.ro"], "depends_on": [], "creation_time": "2018-05-23T01:06:52Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": ["regression"], "summary": "Items created between the first sync after creating an account and the browser shutting down are not synced.", "cf_last_resolved": "2018-05-24T15:43:32Z", "attachments": [{"creator": "markh@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2018-05-23T13:28:47Z", "type_id": 748, "creation_date": "2018-05-23T07:49:50Z", "id": 1760379, "setter": "eoger@fastmail.com"}, {"status": "+", "name": "approval-mozilla-beta", "modification_date": "2018-05-25T15:59:30Z", "type_id": 721, "creation_date": "2018-05-25T00:22:52Z", "id": 1761435, "setter": "ryanvm@gmail.com"}, {"status": "+", "name": "approval-mozilla-esr60", "modification_date": "2018-05-29T14:40:27Z", "type_id": 929, "creation_date": "2018-05-25T00:22:52Z", "id": 1761436, "setter": "jcristau@mozilla.com"}], "content_type": "text/x-review-board-request", "id": 8979849}], "assigned_to_detail": {"email": "markh@mozilla.com", "id": 16943, "name": "markh@mozilla.com", "real_name": "Mark Hammond [:markh]"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 19, "comments": [{"text": "From https://github.com/mozilla/fxa-content-server/issues/6226\n\nSTR:\n\n1) Start a fresh profile in Nightly\n2) Go to preferences, and sign in to sync by creating a new Firefox Account\n3) When prompted, save the login for accounts.firefox.com\n4) Visit some other websites (e.g. reddit.com) and generate saved logins on those sites as well\n5) Connect another device to sync using the same Firefox Account\n\nExpected results:\n\nAll the saved logins from steps (3) and (4) are synced to the new device.\n\nActual results:\n\nOnly the login from (3) is synced, additional saved logins are not.\n\n-----\n\nFrom looking in about:sync-log and using the about:sync addon, it appears that Desktop does not upload the saved logins generated in step (4).  It does successfully upload the one saved in step (3), possibly because that gets saved moments before sync is enabled in the browser.\n\nIf I continue browsing after step (5) and add more saved logins on desktop, those too will not be uploaded.  If I quit and restart Firefox, then any new saved logins will be successfully synced, but the ones from (4) will not.\n\nIf I sign out on Desktop and sign back in, then it will successfully upload all of the saved logins.\n\nAll of which sounds like there's some issue with the logins change-tracker after signing in with a new account on Desktop.", "author": "rfkelly@mozilla.com", "id": 13298354, "time": "2018-05-23T01:06:52Z"}, {"text": "> 1) Start a fresh profile in Nightly\n\nI was also able to reproduce on v61.0b7.\n\nInterestingly, the problem did not seem to occur if I did not save the login for accounts.firefox.com in step (3).", "author": "rfkelly@mozilla.com", "id": 13298361, "time": "2018-05-23T01:15:47Z"}, {"text": "Ouch - this is a regression from a patch of mine :( And is on the release channel :( :(\n\nThe short story is that when an unverified user verifies, Sync isn't aware the login state has changed, so declines to setup *any* of the trackers. This means that new items created in that browser session aren't tracked and aren't synced. However, when that first sync runs, existing items *are* uploaded as that first sync uploads everything, not just stuff flagged by the tracker.\n\nEg, in Ryan's STR, the FxA password is saved before Sync starts, so Sync uploads it as part of the first sync. Items created after are not tracked, so not uploaded. It's also possible that comment 1 is explained by the same thing - if the test happened to create the new password before the password engine synced, it would have been uploaded.\n\nThe next time the browser starts everything works correctly, although the missed items will not be uploaded.\n\nNote also that an already verified user connecting their account works correctly as Sync \"main\" startup path finds a logged in user and continues normally.", "author": "markh@mozilla.com", "id": 13298484, "time": "2018-05-23T03:11:36Z"}, {"text": "Created attachment 8979849\nBug 1463624 - ensure sync knows there is a valid user on signin.\n\nReview commit: https://reviewboard.mozilla.org/r/246028/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/246028/", "author": "markh@mozilla.com", "id": 13298688, "time": "2018-05-23T07:49:50Z"}, {"text": "Comment on attachment 8979849\nBug 1463624 - ensure sync knows there is a valid user on signin.\n\nhttps://reviewboard.mozilla.org/r/246028/#review252050\n\n::: services/sync/modules/browserid_identity.js:251\n(Diff revision 1)\n>  \n>        // And actually sync. If we've never synced before, we force a full sync.\n>        // If we have, then we are probably just reauthenticating so it's a normal sync.\n> -      // We can use any pref that must be set if we've synced before.\n> -      let isFirstSync = !Svc.Prefs.get(\"client.syncID\", null);\n> +      // We can use any pref that must be set if we've synced before, and check\n> +      // the sync lock state because we might already be doing that first sync.\n> +      let isFirstSync = !Weave.Service.locked && !Svc.Prefs.get(\"client.syncID\", null);\n\nThis change (and the one below where we move the observer into this block) isn't strictly needed for this bug, although it does fix an unreported bug, which looks a little like:\n\n* An already verified user signs in, so we fall through to here and start a sync.\n* As part of the sync, FxAccounts does the key-fetch dance, obtains the keys, and then unconditionally sends an ONVERIFIED notification.\n* We end up back here and (a) do those first-sync steps and (b) previously sent the \"weave:service:setup-complete\" notification.\n* As part of handling this notification it initializes the Trackers a second time, meaning we added yet another places/logins/etc observer, meaning scores got incremented twice etc.\n\nBy checking the lock we know a sync is running, so there's no need to do any of that dance.", "author": "markh@mozilla.com", "id": 13298697, "time": "2018-05-23T07:55:29Z"}, {"text": "Comment on attachment 8979849\nBug 1463624 - ensure sync knows there is a valid user on signin.\n\nhttps://reviewboard.mozilla.org/r/246028/#review252190\n\nLGTM thanks!", "author": "eoger@fastmail.com", "id": 13299344, "time": "2018-05-23T13:28:47Z"}, {"text": "Pushed by mhammond@skippinet.com.au:\nhttps://hg.mozilla.org/integration/autoland/rev/240237473d9e\nensure sync knows there is a valid user on signin. r=eoger", "author": "pulsebot@bots.tld", "id": 13303567, "time": "2018-05-23T23:11:55Z"}, {"text": "Backed out for eslint failure at builds/worker/checkouts/gecko/services/sync/tests/unit/test_browserid_identity.js:279:9\n\nPush with failures: https://treeherder.mozilla.org/#/jobs?repo=autoland&revision=240237473d9e7c87000a10f8985f673fa409a615\n\nFailure log: https://treeherder.mozilla.org/logviewer.html#?job_id=179917150&repo=autoland&lineNumber=260\n\nBackout: https://hg.mozilla.org/integration/autoland/rev/b02b8c14d5b1fbf368e2580d75005f0753c1daed", "author": "apavel@mozilla.com", "id": 13306244, "time": "2018-05-24T00:05:52Z"}, {"text": "Comment on attachment 8979849\nBug 1463624 - ensure sync knows there is a valid user on signin.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/246028/diff/1-2/", "author": "markh@mozilla.com", "id": 13314680, "time": "2018-05-24T02:55:54Z"}, {"text": "Comment on attachment 8979849\nBug 1463624 - ensure sync knows there is a valid user on signin.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/246028/diff/2-3/", "author": "markh@mozilla.com", "id": 13316467, "time": "2018-05-24T03:31:57Z"}, {"text": "Pushed by mhammond@skippinet.com.au:\nhttps://hg.mozilla.org/integration/autoland/rev/a90972d69529\nensure sync knows there is a valid user on signin. r=eoger", "author": "pulsebot@bots.tld", "id": 13321162, "time": "2018-05-24T05:07:06Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/a90972d69529", "author": "nerli@mozilla.com", "id": 13352526, "time": "2018-05-24T15:43:32Z"}, {"text": "Comment on attachment 8979849\nBug 1463624 - ensure sync knows there is a valid user on signin.\n\nApproval Request Comment\n[Feature/Bug causing the regression]: Bug 1435929 \n[User impact if declined]: Users creating a new Firefox Account may not sync some of their data.\n[Is this code covered by automated tests?]: Yes\n[Has the fix been verified in Nightly?]: Yes\n[Needs manual test from QE? If yes, steps to reproduce]: No\n[List of other uplifts needed for the feature/fix]: None\n[Is the change risky?]: No\n[Why is the change risky/not risky?]: A small change limited to the Sync code.\n[String changes made/needed]: None", "author": "markh@mozilla.com", "id": 13362577, "time": "2018-05-25T00:22:52Z"}, {"text": "Comment on attachment 8979849\nBug 1463624 - ensure sync knows there is a valid user on signin.\n\nFix for possible Sync dataloss. Approved for 61.0b9.", "author": "ryanvm@gmail.com", "id": 13364210, "time": "2018-05-25T15:59:30Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-beta/rev/b9105675615d", "author": "ryanvm@gmail.com", "id": 13364333, "time": "2018-05-25T16:37:16Z"}, {"text": "Verifying as fix on Nightly 62.0a1. On a newly created FxA, saved logins from desktop are now also synced to mobile iOS.", "author": "simion.basca@softvision.ro", "id": 13370808, "time": "2018-05-29T12:06:04Z"}, {"text": "I managed to reproduce the issue using an older version of Nightly (2018-05-22) on Windows 10 x64.\nI retested everything on Latest Nightly 62.0a1 and beta 61.0b9 using Windows 10 x64, macOS 10.13 and Ubuntu 16.04 x64. The bug is not reproducing anymore.", "author": "oana.botisan@softvision.ro", "id": 13371231, "time": "2018-05-29T14:35:19Z"}, {"text": "Comment on attachment 8979849\nBug 1463624 - ensure sync knows there is a valid user on signin.\n\nfix a sync regression in 60, approved for 60.1esr", "author": "jcristau@mozilla.com", "id": 13371249, "time": "2018-05-29T14:40:27Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-esr60/rev/12bf945bd109", "author": "ryanvm@gmail.com", "id": 13372796, "time": "2018-05-29T22:34:32Z"}], "id": 1463624, "priority": "P1", "mentors_detail": [], "cf_crash_signature": "", "version": "unspecified", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox62": "---", "cf_platform_rel": "---", "product": "Firefox", "cf_status_firefox_esr52": "unaffected", "blocks": [1435929], "qa_contact": "", "see_also": [], "cf_fx_iteration": "---", "component": "Sync", "votes": 0, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "verified", "cf_status_firefox61": "verified", "cf_status_firefox60": "wontfix", "target_milestone": "Firefox 62", "is_cc_accessible": true, "cf_rank": null, "groups": [], "url": "", "creator_detail": {"email": "rfkelly@mozilla.com", "id": 424102, "name": "rfkelly@mozilla.com", "real_name": "Ryan Kelly [:rfkelly]"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "apavel@mozilla.com", "id": 600553, "name": "apavel@mozilla.com", "real_name": "Andreea Pavel [:apavel]"}, {"email": "eoger@fastmail.com", "id": 521718, "name": "eoger@fastmail.com", "real_name": "Edouard Oger [:eoger]"}, {"email": "markh@mozilla.com", "id": 16943, "name": "markh@mozilla.com", "real_name": "Mark Hammond [:markh]"}, {"email": "mcastelluccio@mozilla.com", "id": 420453, "name": "mcastelluccio@mozilla.com", "real_name": "Marco Castelluccio [:marco]"}, {"email": "oana.botisan@softvision.ro", "id": 599255, "name": "oana.botisan@softvision.ro", "real_name": "Oana Botisan"}, {"email": "ryanvm@gmail.com", "id": 75935, "name": "ryanvm@gmail.com", "real_name": "Ryan VanderMeulen [:RyanVM]"}, {"email": "simion.basca@softvision.ro", "id": 567579, "name": "simion.basca@softvision.ro", "real_name": "Simon Basca [:SimonB]"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [{"status": "+", "name": "in-testsuite", "modification_date": "2018-05-25T16:37:16Z", "type_id": 37, "creation_date": "2018-05-25T16:37:16Z", "id": 1761769, "setter": "ryanvm@gmail.com"}], "last_change_time": "2018-05-29T22:34:32Z", "cf_status_firefox_esr60": "fixed", "assigned_to": "markh@mozilla.com", "is_open": false, "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "history": [{"changes": [{"removed": "--", "field_name": "priority", "added": "P1"}, {"removed": "", "field_name": "cc", "added": "markh@mozilla.com"}, {"removed": "", "field_name": "blocks", "added": "1435929"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "markh@mozilla.com"}, {"removed": "Saved logins don't sync after signing in with a new account", "field_name": "summary", "added": "Items created between the first sync after creating an account and the browser shutting down are not synced."}, {"removed": "---", "field_name": "cf_status_firefox60", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox61", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox62", "added": "affected"}], "who": "markh@mozilla.com", "when": "2018-05-23T03:11:36Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8979849, "added": "review?(eoger@fastmail.com)"}, {"removed": "", "field_name": "cc", "added": "eoger@fastmail.com"}], "who": "markh@mozilla.com", "when": "2018-05-23T07:49:50Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(eoger@fastmail.com)", "attachment_id": 8979849, "added": "review+"}], "who": "eoger@fastmail.com", "when": "2018-05-23T13:28:47Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "apavel@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(markh@mozilla.com)"}], "who": "apavel@mozilla.com", "when": "2018-05-24T00:05:52Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "regression"}, {"removed": "", "field_name": "cc", "added": "mcastelluccio@mozilla.com"}], "who": "mcastelluccio@mozilla.com", "when": "2018-05-24T06:28:15Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "Firefox 62"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-05-24 15:43:32"}, {"removed": "affected", "field_name": "cf_status_firefox62", "added": "fixed"}], "who": "nerli@mozilla.com", "when": "2018-05-24T15:43:32Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "ryanvm@gmail.com"}, {"removed": "---", "field_name": "cf_status_firefox_esr52", "added": "unaffected"}, {"removed": "---", "field_name": "cf_status_firefox_esr60", "added": "affected"}, {"removed": "affected", "field_name": "cf_status_firefox60", "added": "wontfix"}], "who": "ryanvm@gmail.com", "when": "2018-05-24T17:02:02Z"}, {"changes": [{"removed": "needinfo?(markh@mozilla.com)", "field_name": "flagtypes.name", "added": ""}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8979849, "added": "approval-mozilla-beta?, approval-mozilla-esr60?"}], "who": "markh@mozilla.com", "when": "2018-05-25T00:22:52Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "qe-verify+"}], "who": "ryanvm@gmail.com", "when": "2018-05-25T15:59:25Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "approval-mozilla-beta?", "attachment_id": 8979849, "added": "approval-mozilla-beta+"}], "who": "ryanvm@gmail.com", "when": "2018-05-25T15:59:30Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "in-testsuite+"}, {"removed": "affected", "field_name": "cf_status_firefox61", "added": "fixed"}], "who": "ryanvm@gmail.com", "when": "2018-05-25T16:37:16Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "simion.basca@softvision.ro"}], "who": "simion.basca@softvision.ro", "when": "2018-05-29T12:06:04Z"}, {"changes": [{"removed": "RESOLVED", "field_name": "status", "added": "VERIFIED"}, {"removed": "", "field_name": "cc", "added": "oana.botisan@softvision.ro"}, {"removed": "qe-verify+", "field_name": "flagtypes.name", "added": ""}, {"removed": "fixed", "field_name": "cf_status_firefox61", "added": "verified"}, {"removed": "fixed", "field_name": "cf_status_firefox62", "added": "verified"}], "who": "oana.botisan@softvision.ro", "when": "2018-05-29T14:35:19Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "approval-mozilla-esr60?", "attachment_id": 8979849, "added": "approval-mozilla-esr60+"}], "who": "jcristau@mozilla.com", "when": "2018-05-29T14:40:27Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox_esr60", "added": "fixed"}], "who": "ryanvm@gmail.com", "when": "2018-05-29T22:34:32Z"}]}