{"status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "classification": "Client Software", "creator": "felipc@gmail.com", "cc": ["MattN+bmo@mozilla.com", "mcastelluccio@mozilla.com"], "depends_on": [1457988], "creation_time": "2018-05-14T05:08:37Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": [], "summary": "Only load FormSubmitObserver when an invalidformsubmit notification happens", "cf_last_resolved": "2018-05-26T04:12:32Z", "attachments": [{"creator": "felipc@gmail.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2018-05-18T04:44:08Z", "type_id": 748, "creation_date": "2018-05-14T05:10:42Z", "id": 1756229, "setter": "MattN+bmo@mozilla.com"}], "content_type": "text/x-review-board-request", "id": 8975390}, {"creator": "felipc@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8975688}, {"creator": "felipc@gmail.com", "is_obsolete": 0, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8975691}], "assigned_to_detail": {"email": "felipc@gmail.com", "id": 208747, "name": "felipc@gmail.com", "real_name": ":Felipe Gomes (needinfo me!)"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 13, "comments": [{"text": "An instance of the FormSubmitObserver object is created for every tab (in content.js) only to add its observer for the \"invalidformsubmit\" notification.\n\nWe can add this observer in content.js and only load the .jsm when that happens.\n\nThis patch makes use of the helper being added in bug 1457988", "author": "felipc@gmail.com", "id": 13274606, "time": "2018-05-14T05:08:37Z"}, {"text": "Created attachment 8975390\nBug 1461247 - Only load FormSubmitObserver.jsm when an invalidformsubmit notification happens.\n\nReview commit: https://reviewboard.mozilla.org/r/243694/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/243694/", "author": "felipc@gmail.com", "id": 13274607, "time": "2018-05-14T05:10:42Z"}, {"text": "Comment on attachment 8975390\nBug 1461247 - Only load FormSubmitObserver.jsm when an invalidformsubmit notification happens.\n\nhttps://reviewboard.mozilla.org/r/243694/#review249494\n\n::: browser/base/content/content.js:51\n(Diff revision 1)\n>  // Load the form validation popup handler\n> -var formSubmitObserver = new FormSubmitObserver(content, this);\n> +var formSubmitObserver = XPCOMUtils.defineLazyProxy(null, null, () => {\n> +  let tmp = {};\n> +  ChromeUtils.import(\"resource:///modules/FormSubmitObserver.jsm\", tmp);\n> +  return new tmp.FormSubmitObserver(content, this);\n> +}, { QueryInterface: XPCOMUtils.generateQI([Ci.nsIFormSubmitObserver, Ci.nsISupportsWeakReference])});\n\nNit: I think this should be ChromeUtils.generateQI?\n\n::: browser/modules/FormSubmitObserver.jsm:5\n(Diff revision 1)\n>  /*\n>   * Handles the validation callback from nsIFormFillController and\n>   * the display of the help panel on invalid elements.\n>   */\n>  \n>  \"use strict\";\n>  \n>  var EXPORTED_SYMBOLS = [ \"FormSubmitObserver\" ];\n>  \n>  ChromeUtils.import(\"resource://gre/modules/XPCOMUtils.jsm\");\n>  ChromeUtils.import(\"resource://gre/modules/Services.jsm\");\n>  ChromeUtils.import(\"resource://gre/modules/BrowserUtils.jsm\");\n>  \n>  function FormSubmitObserver(aWindow, aTabChildGlobal) {\n>    this.init(aWindow, aTabChildGlobal);\n>  }\n>  \n> +// nsIFormSubmitObserver callback about invalid forms. See HTMLFormElement\n> +// for details.\n\nMaybe this comment should be merged with the one at the top of the file?", "author": "MattN+bmo@mozilla.com", "id": 13277008, "time": "2018-05-14T20:33:56Z"}, {"text": "Comment on attachment 8975390\nBug 1461247 - Only load FormSubmitObserver.jsm when an invalidformsubmit notification happens.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/243694/diff/1-2/", "author": "felipc@gmail.com", "id": 13277540, "time": "2018-05-15T00:26:48Z"}, {"text": "Created attachment 8975688\nform-submit-alternate.diff\n\nI updated MozReview with the cleaner version that we talked about, and I'm attaching here the alternate approach that doesn't use defineLazyProxy for you to choose.", "author": "felipc@gmail.com", "id": 13277545, "time": "2018-05-15T00:32:56Z"}, {"text": "Created attachment 8975691\nallow-trapping-of-QueryInterface-setter.diff\n\nAnd this is another alternative to use defineLazyProxy but improve the readability a bit by allowing QueryInterface to be defined in the proxy.", "author": "felipc@gmail.com", "id": 13277554, "time": "2018-05-15T00:41:19Z"}, {"text": "Comment on attachment 8975390\nBug 1461247 - Only load FormSubmitObserver.jsm when an invalidformsubmit notification happens.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/243694/diff/2-3/", "author": "felipc@gmail.com", "id": 13285462, "time": "2018-05-17T19:41:27Z"}, {"text": "(cleaned up the main patch a bit.. organizing all the XPCOMUtils.defineLazyProxy stuff together makes it easier to read)", "author": "felipc@gmail.com", "id": 13285465, "time": "2018-05-17T19:42:00Z"}, {"text": "Comment on attachment 8975390\nBug 1461247 - Only load FormSubmitObserver.jsm when an invalidformsubmit notification happens.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/243694/diff/3-4/", "author": "felipc@gmail.com", "id": 13285485, "time": "2018-05-17T19:46:16Z"}, {"text": "Comment on attachment 8975390\nBug 1461247 - Only load FormSubmitObserver.jsm when an invalidformsubmit notification happens.\n\nhttps://reviewboard.mozilla.org/r/243694/#review250938\n\n::: browser/base/content/content.js:51\n(Diff revision 4)\n>    return new ContextMenu(global);\n>  });\n>  \n> +XPCOMUtils.defineLazyProxy(this, \"formSubmitObserver\", () => {\n> +  return new FormSubmitObserver(content, this);\n> +}, { QueryInterface: ChromeUtils.generateQI([Ci.nsIFormSubmitObserver, Ci.nsISupportsWeakReference])});\n\nNit: I think it would be easier to read with the property on its own line:\n```js\n\u2026\n}, {\n  QueryInterface: ChromeUtils.generateQI([Ci.nsIFormSubmitObserver, Ci.nsISupportsWeakReference])\n});\n```\n\n::: browser/base/content/content.js:56\n(Diff revision 4)\n> -// Load the form validation popup handler\n> +Services.obs.addObserver(formSubmitObserver, \"invalidformsubmit\", true);\n> -var formSubmitObserver = new FormSubmitObserver(content, this);\n\nI have no idea what the test coverage of this is like (and whether they are enabled) so please do a manual test and/or check that automated tests run in automation.", "author": "MattN+bmo@mozilla.com", "id": 13286324, "time": "2018-05-18T04:44:08Z"}, {"text": "(In reply to Matthew N. [:MattN] (PM if requests are blocking you) from comment #9)x\n> \u2026\n> }, {\n>   QueryInterface: ChromeUtils.generateQI([Ci.nsIFormSubmitObserver,\n> Ci.nsISupportsWeakReference])\n> });\n> ```\n> \n> ::: browser/base/content/content.js:56\n> (Diff revision 4)\n> > -// Load the form validation popup handler\n> > +Services.obs.addObserver(formSubmitObserver, \"invalidformsubmit\", true);\n> > -var formSubmitObserver = new FormSubmitObserver(content, this);\n> \n> I have no idea what the test coverage of this is like (and whether they are\n> enabled) so please do a manual test and/or check that automated tests run in\n> automation.\n\nThey are disabled due to being intermittent, but I ran them locally and they pass:\n  browser_form_validation.js, browser_validation_iframe.js, browser_validation_invisible.js\n\n(The first one has a testcase that was never fixed for e10s, so it fails with e10s, but it's unrelated to this change)", "author": "felipc@gmail.com", "id": 13287775, "time": "2018-05-18T16:51:50Z"}, {"text": "Pushed by felipc@gmail.com:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/0398ab28d537\nOnly load FormSubmitObserver.jsm when an invalidformsubmit notification happens. r=MattN", "author": "pulsebot@bots.tld", "id": 13364514, "time": "2018-05-25T17:23:15Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/0398ab28d537", "author": "dluca@mozilla.com", "id": 13365715, "time": "2018-05-26T04:12:32Z"}], "id": 1461247, "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "Trunk", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox62": "---", "cf_platform_rel": "---", "product": "Firefox", "cf_status_firefox_esr52": "---", "blocks": [1436250], "qa_contact": "", "see_also": [], "cf_fx_iteration": "---", "component": "General", "votes": 1, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "fixed", "cf_status_firefox61": "---", "cf_status_firefox60": "---", "target_milestone": "Firefox 62", "is_cc_accessible": true, "cf_rank": null, "groups": [], "url": "", "creator_detail": {"email": "felipc@gmail.com", "id": 208747, "name": "felipc@gmail.com", "real_name": ":Felipe Gomes (needinfo me!)"}, "whiteboard": "[fxperf:p1]", "mentors": [], "cc_detail": [{"email": "MattN+bmo@mozilla.com", "id": 305228, "name": "MattN+bmo@mozilla.com", "real_name": "Matthew N. [:MattN] (PM if requests are blocking you)"}, {"email": "mcastelluccio@mozilla.com", "id": 420453, "name": "mcastelluccio@mozilla.com", "real_name": "Marco Castelluccio [:marco]"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-06-09T07:03:35Z", "cf_status_firefox_esr60": "---", "assigned_to": "felipc@gmail.com", "is_open": false, "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "history": [{"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8975390, "added": "review?(MattN+bmo@mozilla.com)"}, {"removed": "", "field_name": "cc", "added": "MattN+bmo@mozilla.com"}], "who": "felipc@gmail.com", "when": "2018-05-14T05:10:42Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(MattN+bmo@mozilla.com)", "attachment_id": 8975390, "added": "review+"}], "who": "MattN+bmo@mozilla.com", "when": "2018-05-18T04:44:08Z"}, {"changes": [{"removed": "", "field_name": "cf_last_resolved", "added": "2018-05-26 04:12:32"}, {"removed": "affected", "field_name": "cf_status_firefox62", "added": "fixed"}, {"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "Firefox 62"}], "who": "dluca@mozilla.com", "when": "2018-05-26T04:12:32Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1436250"}], "who": "felipc@gmail.com", "when": "2018-05-29T16:32:25Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mcastelluccio@mozilla.com"}], "who": "mcastelluccio@mozilla.com", "when": "2018-06-09T07:03:35Z"}]}