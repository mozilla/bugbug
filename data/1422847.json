{"cf_tracking_thunderbird_esr52": "---", "status": "NEW", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "spamfaenger@gmx.de", "mentors_detail": [], "depends_on": [1339758], "cf_status_firefox_esr60": "---", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": [], "cc_detail": [{"email": "bugs@pettay.fi", "id": 39966, "name": "bugs@pettay.fi", "real_name": "Olli Pettay [:smaug]"}, {"email": "nchevobbe@mozilla.com", "id": 557153, "name": "nchevobbe@mozilla.com", "real_name": "Nicolas Chevobbe [:nchevobbe]"}, {"email": "robert.buchholz@goodpoint.de", "id": 457142, "name": "robert.buchholz@goodpoint.de", "real_name": "Robert Buchholz"}, {"email": "soqu71@gmail.com", "id": 434964, "name": "soqu71@gmail.com", "real_name": "Hsin-Yi Tsai [:hsinyi]"}], "cf_last_resolved": null, "attachments": [{"creator": "spamfaenger@gmx.de", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "image/png", "id": 8934187}, {"creator": "spamfaenger@gmx.de", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/plain", "id": 8935327}, {"creator": "spamfaenger@gmx.de", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/x-log", "id": 8969203}], "votes": 0, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "yes", "comment_count": 28, "comments": [{"text": "Created attachment 8934187\nafter event should have been invoked.png\n\nUser Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_1) AppleWebKit/604.3.5 (KHTML, like Gecko) Version/11.0.1 Safari/604.3.5\n\nSteps to reproduce:\n\nI have an element that gets a click event attached via jQuery, then gets rendered, and the gets the click event triggered (also via jQuery) on it.\n\nNow the strange behavior is, that since Firefox 55 this click event is not triggered anymore - unless I have a breakpoint before this invocation. (Firefox 54 and below work fine, as do of course WebKit / Chrome, the problem persists in the current beta and nightly build)\n\nI have absolutely no clue why this happens - and this also doesn't happen with other similar events - just this one.\n\nI haven't managed a reduction yet, but the code looks more or less like this:\n\n\t\t\t\t\tvar switcher = $(this.graph.legendElement).find('.group-toggle')\n\t\t\t\t\t// debugger\n\t\t\t\t\tswitcher.click()\n\t\t\t\t\texpect(this.series[0].disabled).toBe(true); // fails\n\t\t\t\t\texpect(this.series[2].disabled).toBe(true);\n\t\t\t\t\texpect(this.series[3].disabled).toBe(false); // fails\n\t\t\t\t\tdebugger\nif the first debugger statement is commented in, the code does what is expected, if it is commented out, the event handler fails and thus it's effect is not registered in the unit test. (Of course the input in question is attached to the DOM as firefox still has problems correctly triggering events on elements that are not attached to the dom).\n\nThe Event handler is attached with code like this:\n\t\t\t\tdebugger\n\t\t\t\tthis.$el.find('.group-toggle').click(function(ev){\n\t\t\t\t\tdebugger\n\t\t\t\t\ttoggleGroupBreakdown(ev);\n\t\t\t\t\tapplySettings();\n\t\t\t\t});\nthe debugger statement inside the event handler is _not_ reached if the first debugger statement in the first statement is not commented in.\n\nI've also attached a screenshot that documents at the second breakpoint in the first snippet, that firefox actually knows that there is a click event handler.\n\nNot sure how to proceed - minimizing this would be _quite_ time consuming, as I have no clue where to start, so I want to get some feedback from you guys first.\n\n\nActual results:\n\nThe click event handler is not triggered - unless I put a breakpoint before it.\n\n\nExpected results:\n\nThe click event handler should be triggered.", "author": "spamfaenger@gmx.de", "id": 12895264, "time": "2017-12-04T15:26:51Z"}, {"text": "If you want to view this test failing, go to https://actest.devc7.yeepa.de/testing/js/?spec=yeepa.index%20IndexGraph%20IndexGraphContentControls%3A%20per-topic%2Fgroup%20switching%20should%20activate%20series%20the%20user%20selected.\n\nIf you want to try the breakpoint behavior, try setting a breakpoint at yeepa-index-graph-spec.js:334\n\n(If you stop there, another error will show up, because somehow stopping in the debugger pollutes the global namespace - but that is another issue).", "author": "spamfaenger@gmx.de", "id": 12895374, "time": "2017-12-04T16:10:52Z"}, {"text": "I don't know why this was put in the console, but anyway, I looked at it.\nFor me, it looks like a race condition in your code.\nif you put a debugger between you click instruction and your assertion, it may give a little more time to complete what it should do (and make your tests pass).\n\nCould you transform you function into an async one, and use `await new Promise(res => setTimeout(res, 1000))` in place of your debugger statements ? This will make the code wait for 1 second.\nIf your tests pass, then it's because you have a race.", "author": "nchevobbe@mozilla.com", "id": 12895648, "time": "2017-12-04T17:26:03Z"}, {"text": "It seems that unit test does not trigger any XHR, uses no background workers and only interacts with the DOM. What kind of racy APIs do you have in mind the code could be using (it was running reliably in FF55, is running reliably in Chrome and breaks reliably in FF57)?", "author": "robert.buchholz@goodpoint.de", "id": 12899098, "time": "2017-12-05T17:17:19Z"}, {"text": "I'd like to add that I modified the code in question like this:\n\n```\n\t\t\t\t\tvar switcher = $(this.graph.legendElement).find('.group-toggle')\n\t\t\t\t\t// debugger\n\t\t\t\t\tconsole.log($._data(switcher[0], 'events').click)\n\t\t\t\t\tswitcher.click()\n\t\t\t\t\texpect(this.series[0].disabled).toBe(true); // fails\n\t\t\t\t\texpect(this.series[2].disabled).toBe(true);\n\t\t\t\t\texpect(this.series[3].disabled).toBe(false); // fails\n\t\t\t\t\tconsole.log($._data(switcher[0], 'events').click)\n\t\t\t\t\t// debugger\n```\n\nSo I can see that the click handler is attached successfully (as far as jQuery is concerned) before the click event is triggered. Still it does not fire. (Thinking about this: this makes no sense at all, as jQuery should not even go through the native event handling machinery of the browser, but invoke it's own handlers directly.\n\nAre there any asynchronous apis that I'm not aware of that Firefox has added since Release 54 that could change the behavior of APIs like JQuery to become asynchronous in such core parts of the DOM interaction?\n\nIndeed making the test asynchronous, in that it waits for a second before trying to click that button makes it pass (even when waiting just 0 milliseconds - but it still doesn't explain at all why that would be neccessary, us using just synchronous APIs (to the best of our knowledge).\n\nI have to admit, that this indeed looks quite like a race condition in the FF Dom implementation to me - still I know that this is quite unlikely.", "author": "spamfaenger@gmx.de", "id": 12899478, "time": "2017-12-05T19:14:57Z"}, {"text": "Out of curiosity: Wouldn't this better be classified in the JS engine or the dom engine?", "author": "spamfaenger@gmx.de", "id": 12901066, "time": "2017-12-06T07:44:37Z"}, {"text": "it should, but i want to narrow this down.\nwould you be able to put a contrived failing example somewhere (as an html file here, or on codpen or glitch), so we can really see what's going on.", "author": "nchevobbe@mozilla.com", "id": 12901305, "time": "2017-12-06T09:24:54Z"}, {"text": "i tried to hunt this but this is complex with jasmine doing its job.\ncould you provide an access to the app so i can run the same script you do in jasmine and see what's happening ?", "author": "nchevobbe@mozilla.com", "id": 12901473, "time": "2017-12-06T10:02:56Z"}, {"text": ":-/ Sorry, the app is not open source, so I cannot provide the full thing. The staging server is accessible, and of course you can set breakpoints / try stuff with the console. Which is not much I'm sad to say. I can of course provide you with an account - but I guess that is not what you meant.\n\nAs for a reduction: I may be able to try something tomorrow, but if this is indeed a race condition somewhere (and it looks that way) reducing this will be quite hard. Especially because the exact same code path works fine in adjacent tests.", "author": "spamfaenger@gmx.de", "id": 12901787, "time": "2017-12-06T12:29:42Z"}, {"text": "Just as a fun exercise, I tried mozregression to see if it comes up with something useful. What a fun tool! :-)\n\nHere's the revision it came up with as being the first bad one. Does that make any sense to you? At least it seems to be on topic as it does something with click handlers.\n\n```\n11:35.06 INFO: No more inbound revisions, bisection finished.\n11:35.06 INFO: Last good revision: 7dee6ff041fe99439e28aefa39c7ded8d3f530a3\n11:35.06 INFO: First bad revision: bec20d74d93a82d584804f5cce6019d23db57666\n11:35.06 INFO: Pushlog:\nhttps://hg.mozilla.org/integration/mozilla-inbound/pushloghtml?fromchange=7dee6ff041fe99439e28aefa39c7ded8d3f530a3&tochange=bec20d74d93a82d584804f5cce6019d23db57666\n```\n\nI have attached my full mozregression log.", "author": "spamfaenger@gmx.de", "id": 12904840, "time": "2017-12-07T11:51:48Z"}, {"text": "Created attachment 8935327\nFull mozregression log", "author": "spamfaenger@gmx.de", "id": 12904842, "time": "2017-12-07T11:52:20Z"}, {"text": "Thanks Martin for tracking the regression", "author": "nchevobbe@mozilla.com", "id": 12905002, "time": "2017-12-07T13:33:37Z"}, {"text": "Olli, any thougths about this regression?", "author": "soqu71@gmail.com", "id": 12913648, "time": "2017-12-11T07:20:12Z"}, {"text": "Late with this.\nReporter, could you perhaps provide a testcase here, attached to the bug?\nHopefully even without jquery. Or is this a bug in jquery perhaps, does it have some Gecko specific code here?\n\n\nAnd what is \"firefox still has problems correctly triggering events on elements that are not attached to the dom\" about? Event dispatch doesn't really care about whether element is in DOM or not, but perhaps you're talking about some specific case here?", "author": "bugs@pettay.fi", "id": 12966856, "time": "2018-01-13T13:06:13Z"}, {"text": "@Olli: The Testcase is still live (to the best of my knowledge) https://actest.devc7.yeepa.de/testing/js/?spec=yeepa.index%20IndexGraph%20IndexGraphContentControls%3A%20per-topic%2Fgroup%20switching%20should%20activate%20series%20the%20user%20selected\n\nI haven't been able to reduce this at all, since it seems to be highly timing sensitive, and I'm not sure why this happens. The Testcase however should be easy to follow.\n\nSadly I have no Idea if this happens in or because jQuery.\n\nAs for \"firefox still has problems correctly triggering events on elements that are not attached to the dom\", that is this issue: https://bugzilla.mozilla.org/show_bug.cgi?id=977034", "author": "spamfaenger@gmx.de", "id": 12969474, "time": "2018-01-15T08:10:36Z"}, {"text": "@Olli: Any other info I can give you? I already reduced this down to the exact change that triggers this behavior - should this not help greatly in figuring out why this happens?", "author": "spamfaenger@gmx.de", "id": 13107559, "time": "2018-03-06T10:43:15Z"}, {"text": "@Olli: ping? Any progress on this?", "author": "spamfaenger@gmx.de", "id": 13197242, "time": "2018-04-11T10:12:29Z"}, {"text": "Sorry, where is the minimal testcase? Could you attach a minimal testcase to this bug, pretty please.\n\nWhen I load https://actest.devc7.yeepa.de I just see a page loaded \nand it saying\n1 spec, 0 failures in 13.576s", "author": "bugs@pettay.fi", "id": 13197294, "time": "2018-04-11T10:38:34Z"}, {"text": "I can confirm the link from comment #14 does not show a test failure in Nightly 61, but I see it in the 59 release channel.", "author": "robert.buchholz@goodpoint.de", "id": 13197581, "time": "2018-04-11T12:38:38Z"}, {"text": "Also cannot reproduce anymore with Developer Edition 60.0b11 (64-Bit) - seems it got fixed. Congrats!\n\nDo you see any commits in the area affected by the commit I bisected this down to? Was there a duplicate of this bug raised somewhere?", "author": "spamfaenger@gmx.de", "id": 13197590, "time": "2018-04-11T12:40:45Z"}, {"text": "I'm not aware of anything related. Might be worth to look for un-regression-range.", "author": "bugs@pettay.fi", "id": 13198171, "time": "2018-04-11T15:06:29Z"}, {"text": "According to mozregression this commit fixed it: https://hg.mozilla.org/integration/autoland/pushloghtml?fromchange=977c4997720247488f97bc9a9e9111a5bb173685&tochange=03d139086ace13575d00863456134a010751ad97\n\n```\n10:42.63 INFO: Narrowed inbound regression window from [ac305af3, 03d13908] (3 builds) to [977c4997, 03d13908] (2 builds) (~1 steps left)\n10:42.63 INFO: No more inbound revisions, bisection finished.\n10:42.63 INFO: First good revision: 03d139086ace13575d00863456134a010751ad97\n10:42.63 INFO: Last bad revision: 977c4997720247488f97bc9a9e9111a5bb173685\n10:42.63 INFO: Pushlog:\nhttps://hg.mozilla.org/integration/autoland/pushloghtml?fromchange=977c4997720247488f97bc9a9e9111a5bb173685&tochange=03d139086ace13575d00863456134a010751ad97\n```\n\nDoes that make sense to you?", "author": "spamfaenger@gmx.de", "id": 13217872, "time": "2018-04-19T09:36:59Z"}, {"text": "Created attachment 8969203\nFull mozregression log for the un-regression\n\nHow I found the unregression", "author": "spamfaenger@gmx.de", "id": 13217874, "time": "2018-04-19T09:37:35Z"}, {"text": "Surprising regression range.", "author": "bugs@pettay.fi", "id": 13223439, "time": "2018-04-21T13:54:32Z"}, {"text": "Could you perhaps elaborate a bit? (Mozilla Source Code is still a big mystery to me)", "author": "spamfaenger@gmx.de", "id": 13225923, "time": "2018-04-23T07:24:11Z"}, {"text": "To be more clear: as far as I can figure out, the two commits don't seem to even work on the same code, i.e. maybe there is still a bug lurking that was triggered and hidden by these two commits?", "author": "spamfaenger@gmx.de", "id": 13225924, "time": "2018-04-23T07:25:38Z"}, {"text": "I mean, as you say, that un-regression range didn't change any relevant code, which is why the un-regression range is surprising.", "author": "bugs@pettay.fi", "id": 13226134, "time": "2018-04-23T10:05:33Z"}, {"text": "This sounds like you don't plan to investigate why this was caused and fixed by these commits. :-)\n\n(While I can understand that, it still seems like there is a bug somewhere, that is probably masked by other behavior.)", "author": "spamfaenger@gmx.de", "id": 13229430, "time": "2018-04-24T13:17:08Z"}], "id": 1422847, "priority": "P2", "cc": ["bugs@pettay.fi", "nchevobbe@mozilla.com", "robert.buchholz@goodpoint.de", "soqu71@gmail.com"], "cf_crash_signature": "", "version": "57 Branch", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_thunderbird_esr60": "---", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [], "qa_contact": "", "creation_time": "2017-12-04T15:26:51Z", "cf_status_firefox_esr52": "---", "component": "DOM", "assigned_to_detail": {"email": "nobody@mozilla.org", "id": 1, "name": "nobody@mozilla.org", "real_name": "Nobody; OK to take it and work on it"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "---", "cf_status_firefox60": "---", "target_milestone": "---", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "spamfaenger@gmx.de", "id": 358089, "name": "spamfaenger@gmx.de", "real_name": "Martin H\u00e4cker"}, "whiteboard": "", "mentors": [], "summary": "JS Event handler ignored if there is no breakpoint before it's first use", "cf_has_str": "yes", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-04-24T13:17:08Z", "assigned_to": "nobody@mozilla.org", "is_open": true, "history": [{"changes": [{"removed": "Untriaged", "field_name": "component", "added": "Developer Tools: Console"}], "who": "yfdyh000@gmail.com", "when": "2017-12-04T17:01:29Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "nchevobbe@mozilla.com"}], "who": "nchevobbe@mozilla.com", "when": "2017-12-04T17:26:03Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "robert.buchholz@goodpoint.de"}], "who": "robert.buchholz@goodpoint.de", "when": "2017-12-05T17:17:19Z"}, {"changes": [{"removed": "UNCONFIRMED", "field_name": "status", "added": "NEW"}, {"removed": "Developer Tools: Console", "field_name": "component", "added": "DOM"}, {"removed": "---", "field_name": "cf_has_str", "added": "yes"}, {"removed": "Trunk", "field_name": "version", "added": "57 Branch"}, {"removed": "", "field_name": "depends_on", "added": "1339758"}, {"removed": "Firefox", "field_name": "product", "added": "Core"}, {"removed": "0", "field_name": "is_confirmed", "added": "1"}, {"removed": "---", "field_name": "cf_has_regression_range", "added": "yes"}], "who": "nchevobbe@mozilla.com", "when": "2017-12-07T13:33:37Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P2"}, {"removed": "", "field_name": "cc", "added": "bugs@pettay.fi, htsai@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(bugs@pettay.fi)"}], "who": "soqu71@gmail.com", "when": "2017-12-11T07:20:12Z"}, {"changes": [{"removed": "needinfo?(bugs@pettay.fi)", "field_name": "flagtypes.name", "added": ""}], "who": "bugs@pettay.fi", "when": "2018-01-13T13:06:13Z"}], "resolution": "", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}