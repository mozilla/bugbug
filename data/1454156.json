{"status": "NEW", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "classification": "Client Software", "creator": "mcastelluccio@mozilla.com", "cc": ["emilio@crisal.io", "florian@queze.net", "gijskruitbosch+bugs@gmail.com", "gsvelto@mozilla.com", "mathieu.johnson@gmail.com", "mconley@mozilla.com", "mdeboer@mozilla.com", "ryanvm@gmail.com", "xidorn+moz@upsuper.org"], "depends_on": [], "creation_time": "2018-04-14T09:59:18Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "All", "cf_status_firefox59": "unaffected", "keywords": ["regression"], "summary": "Firefox window is maximized, quickly resized and then maximized again on startup if session restore is enabled", "id": 1454156, "attachments": [{"creator": "mcastelluccio@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "image/png", "id": 8971957}, {"creator": "mcastelluccio@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "video/x-flv", "id": 8972018}, {"creator": "mcastelluccio@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "image/jpeg", "id": 8972449}], "assigned_to_detail": {"email": "nobody@mozilla.org", "id": 1, "name": "nobody@mozilla.org", "real_name": "Nobody; OK to take it and work on it"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 25, "comments": [{"text": "When opening Firefox, I can distinctly see the Firefox window being opened maximized, then getting quickly resized to smaller size and then maximized again.\n\nThis only happens if session restore is enabled.", "author": "mcastelluccio@mozilla.com", "id": 13205721, "time": "2018-04-14T09:59:18Z"}, {"text": "This sounds like something we'd already have a dupe of... are you familiar with a previous bug like this, mikedeboer?", "author": "mconley@mozilla.com", "id": 13219712, "time": "2018-04-19T20:37:48Z"}, {"text": "Well, not really... there's bug 1376162, but it seems slightly different.\n\nMike, while you're here, why is it that the windows animate to their new sizes? Wasn't that supposed to be disabled, or is that only when you open a new window with fixed dimensions?\nIf so, would it be difficult to programmatically disable this resize animation whilst restoring window features?", "author": "mdeboer@mozilla.com", "id": 13242899, "time": "2018-04-30T11:33:06Z"}, {"text": "Marco, could you perhaps post a short video of this behavior? That way I can see which OS, window manager and other details right away.\nThanks in advance!!", "author": "mdeboer@mozilla.com", "id": 13242900, "time": "2018-04-30T11:34:06Z"}, {"text": "Created attachment 8971957\nSchermata da 2018-04-30 13-54-55.png\n\nThis is on Windows, with a more or less default configuration. I'll try to take a video later today (not sure if the machine is powerful enough to take it at a rate that would show the problem).\n\nOn Linux, I see a different (but maybe related?) bug (I'm attaching a screenshot). The window is maximized, then quickly resized, then maximized again (but the resulting window has visual artifacts). Note this is on a completely different machine and on a clean profile.", "author": "mcastelluccio@mozilla.com", "id": 13242914, "time": "2018-04-30T11:56:33Z"}, {"text": "(In reply to Mike de Boer [:mikedeboer] from comment #2)\n> Mike, while you're here, why is it that the windows animate to their new\n> sizes? Wasn't that supposed to be disabled, or is that only when you open a\n> new window with fixed dimensions?\n> If so, would it be difficult to programmatically disable this resize\n> animation whilst restoring window features?\n\nLooks like we try to suppress window animations here: https://searchfox.org/mozilla-central/rev/08df4e6e11284186d477d7e5b0ae48483ecc979c/browser/components/sessionstore/SessionStore.jsm#4177\n\nAm I correct in that this is the codepath we go through when restoring a window's features?", "author": "mconley@mozilla.com", "id": 13243155, "time": "2018-04-30T14:10:47Z"}, {"text": "Right, that is correct. It just doesn't seem like that's working for `resizeTo()`[1] on OSX.\n\n[1] https://searchfox.org/mozilla-central/rev/08df4e6e11284186d477d7e5b0ae48483ecc979c/browser/components/sessionstore/SessionStore.jsm#4189", "author": "mdeboer@mozilla.com", "id": 13243165, "time": "2018-04-30T14:14:13Z"}, {"text": "(In reply to Mike de Boer [:mikedeboer] from comment #6)\n> Right, that is correct. It just doesn't seem like that's working for\n> `resizeTo()`[1] on OSX.\n> \n> [1]\n> https://searchfox.org/mozilla-central/rev/\n> 08df4e6e11284186d477d7e5b0ae48483ecc979c/browser/components/sessionstore/\n> SessionStore.jsm#4189\n\nYeah, on reflection, that's pretty odd. When I open the Browser Console and manually call window.resizeTo, I get 0 transition every time. Same thing if the window has just been opened, using something like:\n\nlet w = OpenBrowserWindow();\nw.resizeTo(500, 500);\n\nSo there must be something kind of special about these windows that are transitioning during restore... or, at least, something special about our state.", "author": "mconley@mozilla.com", "id": 13243186, "time": "2018-04-30T14:22:24Z"}, {"text": "Created attachment 8972018\n2018-04-30 17-38-03.flv\n\nHere's the video. You can see the transition around ~3-4 seconds in.", "author": "mcastelluccio@mozilla.com", "id": 13243449, "time": "2018-04-30T15:41:58Z"}, {"text": "Ah, okay. That's two windows, right? That second window doesn't appear to be animating - but we do seem to open it, paint a frame, and then resize it.", "author": "mconley@mozilla.com", "id": 13243651, "time": "2018-04-30T16:46:45Z"}, {"text": "(In reply to Mike Conley (:mconley) (:\u2699\ufe0f) (Totally backlogged on reviews and needinfos) from comment #9)\n> Ah, okay. That's two windows, right? That second window doesn't appear to be\n> animating - but we do seem to open it, paint a frame, and then resize it.\n\nNo, it is a single window.", "author": "mcastelluccio@mozilla.com", "id": 13243655, "time": "2018-04-30T16:49:33Z"}, {"text": "If this hasn't happened to you before, it might just be a regression from bug 1034036.", "author": "mdeboer@mozilla.com", "id": 13243681, "time": "2018-04-30T16:58:05Z"}, {"text": "(In reply to Mike de Boer [:mikedeboer] from comment #11)\n> If this hasn't happened to you before, it might just be a regression from\n> bug 1034036.\n\nIt looks like it landed after I filed this bug.", "author": "mcastelluccio@mozilla.com", "id": 13243703, "time": "2018-04-30T17:04:06Z"}, {"text": "Marco, can you clarify a bit - I don't really see any issues myself on Windows or mac, and both the screenshot and the video look like they're from Linux, (though comment 4 says the screenshot is from Windows?) and at least to me look like graphics glitches (rather than the window size actually changing). Can you reproduce in safe mode? Clean profile? Or \"only\" on your regular profile? If it's a recent regression, can you try figuring out what regressed this using mozregression? That'd really help in narrowing down what's going on here given that it doesn't seem to be universally reproducible.", "author": "gijskruitbosch+bugs@gmail.com", "id": 13246463, "time": "2018-05-01T16:23:05Z"}, {"text": "I think it actually _is_ universally reproducible (Marco, please correct me if I'm wrong in the following):\n\nSTR:\n  1. Enable 'When Firefox starts (*) Show your windows and tabs from last time' in about:preferences,\n  2. Resize the window and put it someplace else,\n  3. Exit Firefox and restart.\n\nER:\n  Debatable, but the window should show up and be at its correct position and size immediately.\n\nAR:\n  The window shows up at the default position and its default size (OS determined, I think) and only corrects the position & size once session restore kicks in later. This results in a jump and flicker.", "author": "mdeboer@mozilla.com", "id": 13246472, "time": "2018-05-01T16:29:12Z"}, {"text": "I say 'debatable', because it's in fact a goal to show the first window as quickly as possible and not wait for sessionstore to initialize first, meaning that performance would definitely regress if we were to somehow make sessionstore initialize synchronously to get the window properties before showing anything.", "author": "mdeboer@mozilla.com", "id": 13246475, "time": "2018-05-01T16:31:35Z"}, {"text": "(In reply to :Gijs (he/him; out 3-8 May) from comment #13)\n> Marco, can you clarify a bit - I don't really see any issues myself on\n> Windows or mac, and both the screenshot and the video look like they're from\n> Linux, (though comment 4 says the screenshot is from Windows?)\n\nSorry, to clarify, the bug I filed here is about Windows, the screenshot is from Linux (where I see a problem that might or might not be related).\nThe video is from Windows.\n\n> and at least\n> to me look like graphics glitches (rather than the window size actually\n> changing).\n\nNo, it's the window size changing, you can see it if you play the video frame by frame. I'm attaching a frame of the video where this is clearly visible.\n\n> Can you reproduce in safe mode? Clean profile? Or \"only\" on your\n> regular profile? If it's a recent regression, can you try figuring out what\n> regressed this using mozregression? That'd really help in narrowing down\n> what's going on here given that it doesn't seem to be universally\n> reproducible.\n\nI'll try.\n\n(In reply to Mike de Boer [:mikedeboer] from comment #14)\n> I think it actually _is_ universally reproducible (Marco, please correct me\n> if I'm wrong in the following):\n> \n> STR:\n>   1. Enable 'When Firefox starts (*) Show your windows and tabs from last\n> time' in about:preferences,\n>   2. Resize the window and put it someplace else,\n>   3. Exit Firefox and restart.\n> \n> ER:\n>   Debatable, but the window should show up and be at its correct position\n> and size immediately.\n> \n> AR:\n>   The window shows up at the default position and its default size (OS\n> determined, I think) and only corrects the position & size once session\n> restore kicks in later. This results in a jump and flicker.\n\nI'm not resizing the window, the window is maximized when I close Firefox and is maximized at the end of startup. The bug is that the window starts as maximized, then gets resized to a smaller size, then gets maximized again.", "author": "mcastelluccio@mozilla.com", "id": 13247182, "time": "2018-05-01T21:22:06Z"}, {"text": "Created attachment 8972449\nframe.jpg", "author": "mcastelluccio@mozilla.com", "id": 13247184, "time": "2018-05-01T21:23:18Z"}, {"text": "(In reply to Marco Castelluccio [:marco] from comment #16)\n> > and at least\n> > to me look like graphics glitches (rather than the window size actually\n> > changing).\n> \n> No, it's the window size changing, you can see it if you play the video\n> frame by frame. I'm attaching a frame of the video where this is clearly\n> visible.\n\nFWIW, for me the fact that there's a sliver of the \"correct\" window contents (ie a bit of the middle of the URL bar) on the left-hand side of the \"shifted\" window frame, and that the remaining part of the screen is white (rather than desktop background or some other window that was behind the Firefox window), and that there is a small grey border at the top even next to the new \"edge\" of the window is what makes me think this is a graphics glitch, rather than the actual window size changing. Hard to be sure without being able to reproduce, though...\n\n> > Can you reproduce in safe mode? Clean profile? Or \"only\" on your\n> > regular profile? If it's a recent regression, can you try figuring out what\n> > regressed this using mozregression? That'd really help in narrowing down\n> > what's going on here given that it doesn't seem to be universally\n> > reproducible.\n> \n> I'll try.\n> \n> (In reply to Mike de Boer [:mikedeboer] from comment #14)\n> > I think it actually _is_ universally reproducible (Marco, please correct me\n> > if I'm wrong in the following):\n> > \n> > STR:\n> >   1. Enable 'When Firefox starts (*) Show your windows and tabs from last\n> > time' in about:preferences,\n> >   2. Resize the window and put it someplace else,\n> >   3. Exit Firefox and restart.\n> > \n> > ER:\n> >   Debatable, but the window should show up and be at its correct position\n> > and size immediately.\n> > \n> > AR:\n> >   The window shows up at the default position and its default size (OS\n> > determined, I think) and only corrects the position & size once session\n> > restore kicks in later. This results in a jump and flicker.\n\nThis is about restored windows, and I'd expect some issues there with multiple windows because we persist *1* sizemode (ie restored/maximized/fullscreen) and size/position separately from whatever sessionstore does.\n\nBut the steps from comment 0 and the one that follow in Marco's quoted comment below should work without issue, because the sizemode of the window stays the same - the XULStore value is a maximized window, so that's how we open the window, and then the sessionstore value is presumably also a maximized window, so presumably that should just no-op. And presumably, because comment #0 says \"the window\", there is only 1 window...\n\n> I'm not resizing the window, the window is maximized when I close Firefox\n> and is maximized at the end of startup. The bug is that the window starts as\n> maximized, then gets resized to a smaller size, then gets maximized again.\n\nYeah, I can't reproduce this, even after trying several variations (with/without profile manager, clean profile, used profile, etc.). :-(\n\nTo be really clear, I definitely agree that there's an issue in the screencast and in the frame and in the other, Linux screenshot. I'd just like to track down exactly what the issue is (or issues are) and how to reproduce it so we can get it fixed.", "author": "gijskruitbosch+bugs@gmail.com", "id": 13250310, "time": "2018-05-02T19:50:27Z"}, {"text": "(In reply to :Gijs (he/him; out 3-8 May) from comment #18)\n> (In reply to Marco Castelluccio [:marco] from comment #16)\n> > > and at least\n> > > to me look like graphics glitches (rather than the window size actually\n> > > changing).\n> > \n> > No, it's the window size changing, you can see it if you play the video\n> > frame by frame. I'm attaching a frame of the video where this is clearly\n> > visible.\n> \n> FWIW, for me the fact that there's a sliver of the \"correct\" window contents\n> (ie a bit of the middle of the URL bar) on the left-hand side of the\n> \"shifted\" window frame, and that the remaining part of the screen is white\n> (rather than desktop background or some other window that was behind the\n> Firefox window), and that there is a small grey border at the top even next\n> to the new \"edge\" of the window is what makes me think this is a graphics\n> glitch, rather than the actual window size changing. Hard to be sure without\n> being able to reproduce, though...\n\nThe video unfortunately doesn't show you, but in the area you see white I actually see the desktop content.", "author": "mcastelluccio@mozilla.com", "id": 13251473, "time": "2018-05-03T08:58:30Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/pushloghtml?fromchange=cad403cafed9b17d1b801837abcd039a0bce82d5&tochange=990a8eb972cd2a734da04ed8d787564752e8c9c7", "author": "mcastelluccio@mozilla.com", "id": 13251998, "time": "2018-05-03T13:40:47Z"}, {"text": "This is a regression from bug 1439875. Could you look into it?", "author": "mcastelluccio@mozilla.com", "id": 13270397, "time": "2018-05-11T10:46:17Z"}, {"text": "Which platform is this on? Windows I pressume?", "author": "emilio@crisal.io", "id": 13270402, "time": "2018-05-11T10:48:33Z"}, {"text": "Yes, Windows. There's a problem on Linux too, but it might or might not be the same problem, so I would consider Windows only.", "author": "mcastelluccio@mozilla.com", "id": 13270404, "time": "2018-05-11T10:49:42Z"}, {"text": "If it's any help, it happens to me regardless if I have session restore enabled or not. Also, sometimes the browser starts maximized then switch to a smaller window then maximized again and some other times it just start maximized then switch to a smaller window and gets stuck in this state until I maximize it again.\n\nDidn't found a pattern to always get the same result.", "author": "mathieu.johnson@gmail.com", "id": 13290927, "time": "2018-05-19T13:42:48Z"}], "cf_last_resolved": null, "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "Trunk", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox62": "---", "cf_platform_rel": "---", "product": "Firefox", "cf_status_firefox_esr52": "unaffected", "blocks": [1330633, 1439875], "qa_contact": "", "see_also": [], "cf_fx_iteration": "---", "component": "Session Restore", "votes": 4, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "affected", "cf_status_firefox61": "fix-optional", "cf_status_firefox60": "unaffected", "target_milestone": "---", "is_cc_accessible": true, "cf_rank": null, "groups": [], "url": "", "creator_detail": {"email": "mcastelluccio@mozilla.com", "id": 420453, "name": "mcastelluccio@mozilla.com", "real_name": "Marco Castelluccio [:marco]"}, "whiteboard": "[qf-][fxperf:p3]", "mentors": [], "cc_detail": [{"email": "emilio@crisal.io", "id": 546716, "name": "emilio@crisal.io", "real_name": "Emilio Cobos \u00c1lvarez [:emilio]"}, {"email": "florian@queze.net", "id": 149052, "name": "florian@queze.net", "real_name": "Florian Qu\u00e8ze [:florian]"}, {"email": "gijskruitbosch+bugs@gmail.com", "id": 159069, "name": "gijskruitbosch+bugs@gmail.com", "real_name": ":Gijs (he/him)"}, {"email": "gsvelto@mozilla.com", "id": 448747, "name": "gsvelto@mozilla.com", "real_name": "Gabriele Svelto [:gsvelto]"}, {"email": "mathieu.johnson@gmail.com", "id": 32304, "name": "mathieu.johnson@gmail.com", "real_name": "Mathieu Johnson"}, {"email": "mconley@mozilla.com", "id": 403756, "name": "mconley@mozilla.com", "real_name": "Mike Conley (:mconley) (:\u2699\ufe0f) (Catching up on needinfos / reviews)"}, {"email": "mdeboer@mozilla.com", "id": 463945, "name": "mdeboer@mozilla.com", "real_name": "Mike de Boer [:mikedeboer]"}, {"email": "ryanvm@gmail.com", "id": 75935, "name": "ryanvm@gmail.com", "real_name": "Ryan VanderMeulen [:RyanVM]"}, {"email": "xidorn+moz@upsuper.org", "id": 373403, "name": "xidorn+moz@upsuper.org", "real_name": "Xidorn Quan [:xidorn] UTC+10"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-06-04T13:31:59Z", "cf_status_firefox_esr60": "unaffected", "assigned_to": "nobody@mozilla.org", "is_open": true, "resolution": "", "op_sys": "All", "cf_fx_points": "---", "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "mconley@mozilla.com, mdeboer@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(mdeboer@mozilla.com)"}], "who": "mconley@mozilla.com", "when": "2018-04-19T20:37:48Z"}, {"changes": [{"removed": "needinfo?(mdeboer@mozilla.com)", "field_name": "flagtypes.name", "added": "needinfo?(mconley@mozilla.com)"}, {"removed": "", "field_name": "blocks", "added": "1330633"}], "who": "mdeboer@mozilla.com", "when": "2018-04-30T11:33:06Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(mcastelluccio@mozilla.com)"}], "who": "mdeboer@mozilla.com", "when": "2018-04-30T11:34:06Z"}, {"changes": [{"removed": "needinfo?(mconley@mozilla.com)", "field_name": "flagtypes.name", "added": "needinfo?(mdeboer@mozilla.com)"}], "who": "mconley@mozilla.com", "when": "2018-04-30T14:10:47Z"}, {"changes": [{"removed": "needinfo?(mdeboer@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "mdeboer@mozilla.com", "when": "2018-04-30T14:14:13Z"}, {"changes": [{"removed": "needinfo?(mcastelluccio@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "mcastelluccio@mozilla.com", "when": "2018-04-30T15:41:58Z"}, {"changes": [{"removed": "[qf]", "field_name": "whiteboard", "added": "[qf][fxperf]"}], "who": "mconley@mozilla.com", "when": "2018-04-30T16:30:49Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(mcastelluccio@mozilla.com)"}], "who": "mconley@mozilla.com", "when": "2018-04-30T16:46:51Z"}, {"changes": [{"removed": "needinfo?(mcastelluccio@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "mcastelluccio@mozilla.com", "when": "2018-04-30T16:49:33Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "gijskruitbosch+bugs@gmail.com"}, {"removed": "[qf][fxperf]", "field_name": "whiteboard", "added": "[qf][fxperf:p3]"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(mcastelluccio@mozilla.com)"}], "who": "gijskruitbosch+bugs@gmail.com", "when": "2018-05-01T16:23:05Z"}, {"changes": [{"removed": "[qf][fxperf:p3]", "field_name": "whiteboard", "added": "[qf-][fxperf:p3]"}], "who": "mconley@mozilla.com", "when": "2018-05-01T19:12:53Z"}, {"changes": [{"removed": "needinfo?(mcastelluccio@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "mcastelluccio@mozilla.com", "when": "2018-05-01T21:22:06Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1439875"}], "who": "mcastelluccio@mozilla.com", "when": "2018-05-03T13:40:47Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "regression"}], "who": "mcastelluccio@mozilla.com", "when": "2018-05-03T13:41:20Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "emilio@crisal.io"}], "who": "emilio@crisal.io", "when": "2018-05-03T13:45:04Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "xidorn+moz@upsuper.org"}], "who": "xidorn+moz@upsuper.org", "when": "2018-05-03T13:55:20Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "ryanvm@gmail.com"}, {"removed": "---", "field_name": "cf_status_firefox_esr52", "added": "unaffected"}, {"removed": "---", "field_name": "cf_status_firefox_esr60", "added": "unaffected"}, {"removed": "---", "field_name": "cf_status_firefox59", "added": "unaffected"}, {"removed": "---", "field_name": "cf_status_firefox60", "added": "unaffected"}], "who": "ryanvm@gmail.com", "when": "2018-05-03T16:47:08Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox61", "added": "fix-optional"}, {"removed": "---", "field_name": "cf_status_firefox62", "added": "affected"}], "who": "ryanvm@gmail.com", "when": "2018-05-08T01:35:35Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(emilio@crisal.io)"}], "who": "mcastelluccio@mozilla.com", "when": "2018-05-11T10:46:17Z"}, {"changes": [{"removed": "needinfo?(emilio@crisal.io)", "field_name": "flagtypes.name", "added": "needinfo?(mcastelluccio@mozilla.com)"}], "who": "emilio@crisal.io", "when": "2018-05-11T10:48:33Z"}, {"changes": [{"removed": "needinfo?(mcastelluccio@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "mcastelluccio@mozilla.com", "when": "2018-05-11T10:49:42Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mathieu.johnson@gmail.com"}], "who": "mathieu.johnson@gmail.com", "when": "2018-05-19T13:42:48Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "gsvelto@mozilla.com"}], "who": "gsvelto@mozilla.com", "when": "2018-05-22T15:15:42Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "florian@queze.net"}], "who": "florian@queze.net", "when": "2018-06-04T13:31:59Z"}]}