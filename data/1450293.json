{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "florian@queze.net", "mentors_detail": [], "depends_on": [1453782, 1454638, 1454908], "cf_status_firefox_esr60": "---", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": ["feature", "perf"], "cc_detail": [{"email": "jan@ikenmeyer.eu", "id": 580271, "name": "jan@ikenmeyer.eu", "real_name": "Jan Andre Ikenmeyer [:darkspirit]"}, {"email": "jmuizelaar@mozilla.com", "id": 309398, "name": "jmuizelaar@mozilla.com", "real_name": "Jeff Muizelaar [:jrmuizel] on parental leave until at least June 25"}, {"email": "jryans@gmail.com", "id": 282978, "name": "jryans@gmail.com", "real_name": "J. Ryan Stinnett [:jryans] (use ni?)"}, {"email": "karlt@mozbugz.karlt.net", "id": 274246, "name": "karlt@mozbugz.karlt.net", "real_name": "Karl Tomlinson (back June 19 :karlt)"}, {"email": "milaninbugzilla@gmail.com", "id": 456486, "name": "milaninbugzilla@gmail.com", "real_name": "Milan Sreckovic [:milan] (needinfo for best results)"}, {"email": "past@mozilla.com", "id": 363318, "name": "past@mozilla.com", "real_name": "Panos Astithas [:past] (please ni?)"}], "cf_last_resolved": "2018-04-17T09:57:38Z", "attachments": [{"creator": "florian@queze.net", "is_obsolete": 1, "is_patch": 1, "flags": [{"status": "-", "name": "review", "modification_date": "2018-04-12T17:58:11Z", "type_id": 4, "creation_date": "2018-04-09T19:48:55Z", "id": 1741374, "setter": "jmathies@mozilla.com"}], "content_type": "text/plain", "id": 8964988}, {"creator": "florian@queze.net", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-13T21:00:32Z", "type_id": 4, "creation_date": "2018-04-12T20:04:37Z", "id": 1743308, "setter": "jmathies@mozilla.com"}], "content_type": "text/plain", "id": 8967510}], "votes": 0, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 17, "comments": [{"text": "The general idea in bug 1336227 / bug 1447719 is to open an about:blank window at the right size and position as early as possible during startup, and to fill it later with a real browser.xul document. This gives us a nice 50+% win on the time to reach first paint, which matters a lot for perceived performance.\n\nI would like this initial blank window (loading only about:blank) to show before we start the GPU process.\n\nThere are 2 reasons for that:\n\n- creating the process is very expensive (at least on Windows, especially when an antivirus is installed). See https://perfht.ml/2pLpOCW for a dramatically slow example. Even without antivirus, starting the GPU process is often more than half of the remaining time to first paint.\n\n- Starting GPU-enabled stuff before we had a chance to run the SanityTest that's supposed to disable GPU usage when its driver is crashy sounds like a recipe for startup crashes on release users with odd driver versions.\n\nAny help to figure out how we can draw about:blank without GPU process and turn it on later will be greatly appreciated.", "author": "florian@queze.net", "id": 13169323, "time": "2018-03-30T16:41:41Z"}, {"text": "Created attachment 8964988\nPatch\n\nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=15758b0932337c9816f5ecc46f07453ea666f882\n\nLocally this creates the main process compositor thread before painting the blank window, but the GPU process is started after showing the blank window and after the startupCrashDetectionBegin profiler marker. This also gets rid of the black flash when layers.acceleration.disabled is true (ie. bug 1448146).", "author": "florian@queze.net", "id": 13180387, "time": "2018-04-04T17:23:28Z"}, {"text": "(In reply to Florian Qu\u00e8ze [:florian] from comment #1)\n\n> Locally this creates the main process compositor thread before painting the\n> blank window, but the GPU process is started after showing the blank window\n> and after the startupCrashDetectionBegin profiler marker.\n\nBut the SanityTest code runs after the compositor process is already started, I'm not sure if that's OK or not. I haven't been able to see in startup profiles what triggers the creation of the GPU process when this patch is applied.", "author": "florian@queze.net", "id": 13180396, "time": "2018-04-04T17:25:08Z"}, {"text": "(In reply to Florian Qu\u00e8ze [:florian] from comment #2)\n> (In reply to Florian Qu\u00e8ze [:florian] from comment #1)\n> \n> > Locally this creates the main process compositor thread before painting the\n> > blank window, but the GPU process is started after showing the blank window\n> > and after the startupCrashDetectionBegin profiler marker.\n> \n> But the SanityTest code runs after the compositor process is already\n> started, I'm not sure if that's OK or not. I haven't been able to see in\n> startup profiles what triggers the creation of the GPU process when this\n> patch is applied.\n\nCan you try making the SanityTest fail locally and make sure the right things still happen?", "author": "jmuizelaar@mozilla.com", "id": 13180491, "time": "2018-04-04T17:50:33Z"}, {"text": "Comment on attachment 8964988\nPatch\n\nReview of attachment 8964988:\n-----------------------------------------------------------------\n\n::: widget/windows/nsWindowGfx.cpp\n@@ +225,5 @@\n> +  // Avoid starting the GPU process for the initial navigator:blank window.\n> +  if (mIsEarlyBlankWindow) {\n> +    // Even though we are not really painting, record the time when the window\n> +    // gets on screen for the first time.\n> +    mozilla::StartupTimeline::RecordOnce(mozilla::StartupTimeline::FIRST_PAINT);\n\nIt seems like we should probably separate these metrics. It's still useful for us to record when the browser paints actual content. There should probably be FIRST_PAINT and FIRST_WINDOW.", "author": "jmuizelaar@mozilla.com", "id": 13180502, "time": "2018-04-04T17:52:37Z"}, {"text": "(In reply to Jeff Muizelaar [:jrmuizel] from comment #4)\n\n> ::: widget/windows/nsWindowGfx.cpp\n> @@ +225,5 @@\n> > +  // Avoid starting the GPU process for the initial navigator:blank window.\n> > +  if (mIsEarlyBlankWindow) {\n> > +    // Even though we are not really painting, record the time when the window\n> > +    // gets on screen for the first time.\n> > +    mozilla::StartupTimeline::RecordOnce(mozilla::StartupTimeline::FIRST_PAINT);\n> \n> It seems like we should probably separate these metrics. It's still useful\n> for us to record when the browser paints actual content. There should\n> probably be FIRST_PAINT and FIRST_WINDOW.\n\nSeems similar to the request in bug 1449305. SIMPLE_MEASURES_DELAYEDSTARTUPSTARTED covers the first MozAfterPaint event of a browser window, I think that's close enough.", "author": "florian@queze.net", "id": 13180577, "time": "2018-04-04T17:59:26Z"}, {"text": "(In reply to Jeff Muizelaar [:jrmuizel] from comment #3)\n> (In reply to Florian Qu\u00e8ze [:florian] from comment #2)\n> > (In reply to Florian Qu\u00e8ze [:florian] from comment #1)\n> > \n> > > Locally this creates the main process compositor thread before painting the\n> > > blank window, but the GPU process is started after showing the blank window\n> > > and after the startupCrashDetectionBegin profiler marker.\n> > \n> > But the SanityTest code runs after the compositor process is already\n> > started, I'm not sure if that's OK or not. I haven't been able to see in\n> > startup profiles what triggers the creation of the GPU process when this\n> > patch is applied.\n> \n> Can you try making the SanityTest fail locally and make sure the right\n> things still happen?\n\nI did some more testing around the SanityTest, and it's running more asynchronously than I thought. I tried setting browser.startup.blankWindow to false and profiled startup a couple times: the actual \"runSanityTest\" code runs at a time when we have already opened the actual browser window and already styled it. The fact that the SanityTest code currently starts the compositor seems to just be a side effect of it doing the very first openWindow call. So I don't think I'm significantly affecting the SanityTest behavior.", "author": "florian@queze.net", "id": 13183131, "time": "2018-04-05T13:56:41Z"}, {"text": "Comment on attachment 8964988\nPatch\n\nReview of attachment 8964988:\n-----------------------------------------------------------------\n\nI still think it's worth renaming the telemetry probe to reflect that we're not painting any more.\n\nCan you add some more documentation about what's happening here. Especially about the magic of using navigator:blank to change the behaviour of the window. Also, jimm is probably a more appropriate reviewer for this than me.", "author": "jmuizelaar@mozilla.com", "id": 13192194, "time": "2018-04-09T15:26:32Z"}, {"text": "(In reply to Jeff Muizelaar [:jrmuizel] from comment #7)\n\n> I still think it's worth renaming the telemetry probe to reflect that we're\n> not painting any more.\n\nWe are not running the painting code anymore, but from the user's point of view, something appears on screen, so it's still fair to say we reached first paint.\n\nIf we want to keep recording the time it takes us to paint something non-blank for the first time, and the delayed startup probe (which is right after the first MozAfterPaint event) isn't enough, then I would prefer adding another FIRST_UI_PAINT probe, and that could possibly be a follow-up.\n\nI would like to keep the existing probe name to use telemetry data to confirm the assumption that avoiding the GPU process startup is going to save time for cold startup.\n\n> Can you add some more documentation about what's happening here. Especially\n> about the magic of using navigator:blank to change the behaviour of the\n> window.\n\nDo you mean a comment in the nsWindow::SetWindowClass method?", "author": "florian@queze.net", "id": 13193077, "time": "2018-04-09T19:46:19Z"}, {"text": "Comment on attachment 8964988\nPatch\n\nJimm, it would be nice if you could confirm whether this fixes the black paint you were seeing in bug 1447549 comment 5 (there's a try push in comment 1).", "author": "florian@queze.net", "id": 13193082, "time": "2018-04-09T19:48:55Z"}, {"text": "Comment on attachment 8964988\nPatch\n\nReview of attachment 8964988:\n-----------------------------------------------------------------\n\nOther than the telemetry timing, this seems fine. The window class stuff is a bit new to me but I assume you know what you're doing there since it's front end.\n\n::: widget/windows/nsWindowGfx.cpp\n@@ +225,5 @@\n> +  // Avoid starting the GPU process for the initial navigator:blank window.\n> +  if (mIsEarlyBlankWindow) {\n> +    // Even though we are not really painting, record the time when the window\n> +    // gets on screen for the first time.\n> +    mozilla::StartupTimeline::RecordOnce(mozilla::StartupTimeline::FIRST_PAINT);\n\nr- on this, you're adding timing to a paint metric when we're not painting, throwing those values off. Lets nix this. If you want to know about the specific timing here, I like Jeff's suggestion of creating a new probe.", "author": "jmathies@mozilla.com", "id": 13201595, "time": "2018-04-12T17:58:11Z"}, {"text": "Created attachment 8967510\nPatch v2\n\nRemoved the telemetry stuff. I'll open another bug to add a probe, probably in front-end code, although that won't be able to capture exactly the same thing. I'll land the probe a day before landing this patch, so that we can see the impact of this patch on the nightly population.", "author": "florian@queze.net", "id": 13201995, "time": "2018-04-12T20:04:37Z"}, {"text": "Pushed by florian@queze.net:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/50091ebf4918\nAvoid starting the GPU process for the initial navigator:blank window, r=jimm.", "author": "pulsebot@bots.tld", "id": 13210918, "time": "2018-04-16T21:17:07Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/50091ebf4918", "author": "cbrindusan@mozilla.com", "id": 13211927, "time": "2018-04-17T09:57:38Z"}, {"text": "It seems like this may have caused:\n\nAlert for GPU_PROCESS_LAUNCH_TIME_MS_2 (Histogram Regression Detector) on 2018-04-17\n\nAlert details: http://alerts.telemetry.mozilla.org/index.html#/detectors/1/metrics/2095/alerts/?from=2018-04-17&to=2018-04-17\n\nChangeset for 20180417100054...20180417225505: https://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=0ceabd10aac2272e83850e278c7876f32dbae42e&tochange=789e30ff2e3d6e1fcfce1a373c1e5635488d24da\n\nand\n\n\nAlert for GPU_PROCESS_INITIALIZATION_TIME_MS (Histogram Regression Detector) on 2018-04-17\n\nAlert details: http://alerts.telemetry.mozilla.org/index.html#/detectors/1/metrics/2110/alerts/?from=2018-04-17&to=2018-04-17\n\nChangeset for 20180417100054...20180417225505: https://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=0ceabd10aac2272e83850e278c7876f32dbae42e&tochange=789e30ff2e3d6e1fcfce1a373c1e5635488d24da", "author": "jmuizelaar@mozilla.com", "id": 13223449, "time": "2018-04-21T14:10:25Z"}, {"text": "(In reply to Jeff Muizelaar [:jrmuizel] from comment #14)\n\nI think this means we create the GPUParent instance at the same time as we create the compositor thread on the parent process, rather than when we actually create the GPU process.", "author": "florian@queze.net", "id": 13224254, "time": "2018-04-22T20:30:20Z"}, {"text": "(In reply to Florian Qu\u00e8ze [:florian] from comment #15)\n\nMy guess in comment 15 was incorrect. I just investigated using the profiler (I put long PR_Sleep calls at the beginning and end of the measurements to see when we start and stop measuring) : https://perfht.ml/2FnfPJF\n\nWhat's happening here is that the GPU process starts right after we are done doing the no-op paint on the blank window. But it sits there idle for a while, and finishes its initialization only once the refresh driver starts ticking on the browser.xul window.\n\nSo the regression detected in comment 14 is 'real' in the sense that the GPU startup time is indeed longer. But there's no user-perceptible impact of this regression. This may even be an improvement for the cases where starting the GPU process takes a long time (I saw some profiles where starting the GPU process was taking several seconds, likely due to antivirus software scanning the new process), because we now start the process significantly before we first need it, so it can take a long time to initialize without blocking anything.\n\nSo this is probably a win, although it's unfortunate that it makes our existing measurements relatively irrelevant. In a follow-up we may want to think about changing these probes or adding new ones that measure something relevant to user perceptions.", "author": "florian@queze.net", "id": 13238180, "time": "2018-04-27T13:51:47Z"}], "id": 1450293, "priority": "P5", "cc": ["jan@ikenmeyer.eu", "jmuizelaar@mozilla.com", "jryans@gmail.com", "karlt@mozbugz.karlt.net", "milaninbugzilla@gmail.com", "past@mozilla.com"], "cf_crash_signature": "", "version": "unspecified", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_thunderbird_esr60": "---", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1447719, 1448146, 1454668], "qa_contact": "", "creation_time": "2018-03-30T16:41:41Z", "cf_status_firefox_esr52": "---", "component": "Graphics", "assigned_to_detail": {"email": "florian@queze.net", "id": 149052, "name": "florian@queze.net", "real_name": "Florian Qu\u00e8ze [:florian]"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "fixed", "cf_status_firefox60": "---", "target_milestone": "mozilla61", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "florian@queze.net", "id": 149052, "name": "florian@queze.net", "real_name": "Florian Qu\u00e8ze [:florian]"}, "whiteboard": "[gfx-noted]", "mentors": [], "summary": "Avoid starting the GPU process for the initial navigator:blank window", "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-05-12T13:41:00Z", "assigned_to": "florian@queze.net", "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "jryans@gmail.com"}], "who": "jryans@gmail.com", "when": "2018-03-30T16:49:32Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "feature, perf"}, {"removed": "--", "field_name": "priority", "added": "P5"}, {"removed": "", "field_name": "cc", "added": "milan@mozilla.com"}, {"removed": "", "field_name": "whiteboard", "added": "[gfx-noted]"}], "who": "lsalzman@mozilla.com", "when": "2018-04-01T23:50:44Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "jan@ikenmeyer.eu"}], "who": "jan@ikenmeyer.eu", "when": "2018-04-03T08:57:26Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "jmuizelaar@mozilla.com"}], "who": "jmuizelaar@mozilla.com", "when": "2018-04-03T15:07:29Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8964988, "added": "review?(jmuizelaar@mozilla.com)"}], "who": "florian@queze.net", "when": "2018-04-04T17:23:28Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "ASSIGNED"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "florian@queze.net"}], "who": "florian@queze.net", "when": "2018-04-04T17:23:30Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(florian@queze.net)"}], "who": "jmuizelaar@mozilla.com", "when": "2018-04-04T17:50:33Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "karlt@mozbugz.karlt.net"}], "who": "karlt@mozbugz.karlt.net", "when": "2018-04-04T21:51:39Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1448146"}], "who": "past@mozilla.com", "when": "2018-04-04T22:08:10Z"}, {"changes": [{"removed": "needinfo?(florian@queze.net)", "field_name": "flagtypes.name", "added": ""}], "who": "florian@queze.net", "when": "2018-04-05T13:56:41Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(jmuizelaar@mozilla.com)", "attachment_id": 8964988, "added": ""}], "who": "jmuizelaar@mozilla.com", "when": "2018-04-09T15:26:32Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8964988, "added": "review?(jmathies@mozilla.com)"}], "who": "florian@queze.net", "when": "2018-04-09T19:48:55Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(jmathies@mozilla.com)", "attachment_id": 8964988, "added": "review-"}], "who": "jmathies@mozilla.com", "when": "2018-04-12T17:58:11Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8967510, "added": "review?(jmathies@mozilla.com)"}], "who": "florian@queze.net", "when": "2018-04-12T20:04:37Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8964988, "added": "1"}], "who": "florian@queze.net", "when": "2018-04-12T20:04:38Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1453782"}], "who": "florian@queze.net", "when": "2018-04-12T20:11:49Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(jmathies@mozilla.com)", "attachment_id": 8967510, "added": "review+"}], "who": "jmathies@mozilla.com", "when": "2018-04-13T21:00:32Z"}, {"changes": [{"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla61"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-04-17 09:57:38"}, {"removed": "---", "field_name": "cf_status_firefox61", "added": "fixed"}], "who": "cbrindusan@mozilla.com", "when": "2018-04-17T09:57:38Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1454638"}], "who": "florian@queze.net", "when": "2018-04-17T22:58:14Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1454908"}], "who": "igoldan@mozilla.com", "when": "2018-04-18T10:45:20Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "past@mozilla.com"}], "who": "past@mozilla.com", "when": "2018-04-26T19:17:15Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1454668"}], "who": "ryanvm@gmail.com", "when": "2018-05-12T13:41:00Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}