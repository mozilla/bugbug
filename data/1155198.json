{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "jeromewagener@gmail.com", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "image/png", "id": 8706408}, {"creator": "nfroyd@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2016-01-15T09:50:24Z", "type_id": 4, "creation_date": "2016-01-14T16:24:19Z", "id": 1323666, "setter": "mh+mozilla@glandium.org"}], "content_type": "text/plain", "id": 8707911}], "classification": "Components", "creator": "jeromewagener@gmail.com", "cc": ["brindusa.tot@softvision.ro", "jeromewagener@gmail.com", "mh+mozilla@glandium.org", "nfroyd@mozilla.com", "sledru@mozilla.com"], "depends_on": [], "creation_time": "2015-04-16T14:31:34Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "x86_64", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "The NSS_CheckVersion function is not accessible in the NSS library that is installed alongside newer Firefox releases.", "cf_last_resolved": "2016-01-21T10:54:25Z", "assigned_to_detail": {"email": "nfroyd@mozilla.com", "id": 417288, "name": "nfroyd@mozilla.com", "real_name": "Nathan Froyd [:froydnj]"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_status_firefox45": "fixed", "comments": [{"text": "User Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0\nBuild ID: 20150415030206\n\nSteps to reproduce:\n\nWe are using the NSS library (nss.dll) that is installed alongside Firefox in order to facilitate the handling of P12 files for our clients. In fact, we use PKCS#11 in order to automatically import SSL and signing certificates into the Firefox-Keystore using a small Java applet. (See http://docs.oracle.com/javase/7/docs/technotes/guides/security/p11guide.html#NSS)\n\nThis worked perfectly in the past including the current Firefox ESR (31.2.0). \n\nHowever it does no longer work with any recent Firefox versions (i.e. 37.1.0 or Nightly)\n\n\nActual results:\n\nWith recent versions of Firefox, our applet started throwing a NullPointerException that states that the NSS_CheckVersion symbol couldn't be found. As you can see below, the stacktrace shows that this NSS function is called from within PKCS11, more specifically from within Secmod.java\n\nSEVERE: could not initialize applet\njava.lang.NullPointerException: Symbol not found: NSS_VersionCheck\n\tat sun.security.pkcs11.Secmod.nssVersionCheck(Native Method)\n\tat sun.security.pkcs11.Secmod.fetchVersions(Secmod.java:111)\n\tat sun.security.pkcs11.Secmod.initialize(Secmod.java:212)\n\tat sun.security.pkcs11.SunPKCS11.<init>(SunPKCS11.java:207)\n\tat sun.security.pkcs11.SunPKCS11.<init>(SunPKCS11.java:107)\n\nFrom what we gathered so far, we think that the following has happened:\n\n1) At some point during the \"recent\" Firefox developments (Mid 2014), it was decided to not build NSS for Firefox with all the available symbols as this is quite costly. In fact, it is mentioned in various Bugzilla tickets that some symbols were removed in the past. (E.g 1072045 and especially 1025998)\n\n2) As a result of this, a duplicate \"external\" nss.def file was created in August 2014 with the purpose of ignoring unused symbols. (https://hg.mozilla.org/mozilla-central/filelog/a35163f83d22/config/external/nss/nss.def)\n\n3) Some time later Firefox was then build using this new external \"nss.def\" file which doesn't include all symbols. In our particular case, it lacks at least \"NSS_VersionCheck\" which is directly referenced by the Java runtime.\n\n4) Our applet crashes since this new NSS version that is packaged with Firefox doesn't provide access to some of the functions required by Java's PKCS#11 anymore.\n\n\n\n\nExpected results:\n\nEven with new versions of Firefox, those functions that are used by the Java runtime environment should still be available in the NSS version that is packaged with Firefox. Otherwise applets that are using PKCS#11 will crash as described above.\n\nA possible fix might consist of simply putting the relevant symbols again into the nss.def file that is used by Firefox.", "author": "jeromewagener@gmail.com", "id": 10163554, "time": "2015-04-16T14:31:34Z"}, {"text": "Update the component to Core: Build config, perhaps there's someone with extensive knowledge on this area that might be able to help here.\nAlso add :froydnj to CC, perhaps can help us with this bug.", "author": "brindusa.tot@softvision.ro", "id": 11037232, "time": "2015-12-30T15:21:53Z"}, {"text": "Is there some way to see a complete list of all the symbols that Java wants to use from the NSS library?", "author": "nfroyd@mozilla.com", "id": 11042637, "time": "2016-01-04T12:22:15Z"}, {"text": "Hello Brindusa and Nathan,\n\nThank you very much for your reply. \n\nI dug a bit into the native C code of the JDK and I think that the only two symbols that are needed are:\n* NSS_VersionCheck\n* NSS_Initialize\n\nI attached a screenshot of a simple search on the JNI portion of the JDK which shows that these two symbols seem to be the only ones that are used to create function pointers. \n\nIn addition, after briefly analyzing the code, it seems that the NSS_Initialize function is capable of performing the required operations. This is also described by the MDN documentation which mentions that:\n\n\"NSS_Initialize initializes NSS. It is more flexible than NSS_Init, NSS_InitReadWrite, and NSS_NoDB_Init. If any of those simpler NSS initialization functions suffices for your needs, call that instead.\" \n\nSee (https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/Reference/NSS_Initialize)\n\nPlease let me know in case you need further information.\n\nKind regards,\nJ\u00e9r\u00f4me", "author": "jeromewagener@gmail.com", "id": 11064400, "time": "2016-01-11T16:10:05Z"}, {"text": "Created attachment 8706408\nA search for symbols and in the JDK. Only two symbols are used to create function pointers\n\nA search for symbols and in the JDK. Only two symbols are used to create function pointers. NSS_VersionCheck and NSS_Initialize", "author": "jeromewagener@gmail.com", "id": 11064412, "time": "2016-01-11T16:12:15Z"}, {"text": "(In reply to J\u00e9r\u00f4me from comment #3)\n> Thank you very much for your reply. \n\nThanks for the response on a really old bug!\n\n> I dug a bit into the native C code of the JDK and I think that the only two\n> symbols that are needed are:\n> * NSS_VersionCheck\n> * NSS_Initialize\n> \n> I attached a screenshot of a simple search on the JNI portion of the JDK\n> which shows that these two symbols seem to be the only ones that are used to\n> create function pointers.\n\nHm, looking at:\n\nhttp://mxr.mozilla.org/mozilla-central/source/config/external/nss/nss.symbols#1\n\nor even NSS's version:\n\nhttp://mxr.mozilla.org/mozilla-central/source/security/nss/lib/nss/nss.def#1\n\nI see many more prefixes (CERT, DER, HASH, PK11, PORT, and several variants of SEC*, among others).  I would think that you'd have to call more than NSS_Initialize and NSS_VersionCheck to be able to use the library.  Unless those are called directly, and not used to create function pointers?  (That seems like an odd setup, but I'm not familiar with the JDK.)\n\nCould you do a broader search using some of those prefixes as well?", "author": "nfroyd@mozilla.com", "id": 11065606, "time": "2016-01-11T20:29:27Z"}, {"text": "Hello again,\n\nTo clarify things a bit:\n- Your first link shows the external symbol file which is used during the build of Firefox\n- Your second link show the symbol file for the entire NSS library\n\nIn order to verify which symbols are missing from the \"Firefox-Symbol-List\", (but which are needed by the JDK), I wrote a small script which recursively goes through the JDK code looking for all symbols that are defined in the \"NSS-Symbol-List\". Once the script finishes, it outputs the number of occurrences for the symbols, while also checking which of these symbols are NOT in the \"Firefox-Symbol-List\".\n\nAs you can see by by comments on the output below, most occurrences are due to macros or comments and should be ignored. \n\nIn fact, the only symbol that is missing but which is REALLY NEEDED is >>>NSS_VersionCheck<<< as it is used to create a function pointer. NSS_Initialize as well as the other symbols that are used by the JDK seem to still be present in the \"Firefox-Symbol-List\" and should not cause problems. \n\nFor reference, please find below my script output: (I added some comments on my own which are prefixed by //)\n\n<SYMBOL-FOUND-IN-JDK>: <OCCURRENCES(NUMBER/FILES)> <MISSING?>(If missing, list files)\n-------------------------------------------------------------------------------------\n->> SECMOD_LoadModule: 2\n->> SECOID_FindOID: 2\n->> PORT_NewArena: 3\n->> NSS_VersionCheck: 3 --> MISSING\n     * C:\\Users\\ex605\\Downloads\\openjdk\\jdk\\src\\share\\native\\sun\\security\\pkcs11\\j2secmod.c \n        // !!! USED TO CREATE FUNCTION POINTER !!!\n     * C:\\Users\\ex605\\Downloads\\openjdk\\jdk\\src\\solaris\\native\\sun\\security\\pkcs11\\j2secmod_md.h \n        // ONLY COMMENT\n     * C:\\Users\\ex605\\Downloads\\openjdk\\jdk\\src\\windows\\native\\sun\\security\\pkcs11\\j2secmod_md.h \n        // ONLY COMMENT\n->> SECMOD_GetDBModuleList: 2 --> MISSING\n     * C:\\Users\\ex605\\Downloads\\openjdk\\jdk\\src\\solaris\\native\\sun\\security\\pkcs11\\j2secmod_md.h \n       // ONLY COMMENT\n     * C:\\Users\\ex605\\Downloads\\openjdk\\jdk\\src\\windows\\native\\sun\\security\\pkcs11\\j2secmod_md.h \n       // ONLY COMMENT\n->> SECITEM_FreeItem: 3\n->> SECOID_FindOIDTag: 2\n->> PORT_Free: 3\n->> SECITEM_AllocItem: 4\n->> NSS_Init: 3\n->> SECMOD_GetModuleSpecList: 2\n->> PORT_Alloc: 3\n->> PORT_ArenaAlloc: 3\n->> NSS_InitReadWrite: 1 --> MISSING \n     * C:\\Users\\ex605\\Downloads\\openjdk\\jdk\\src\\share\\native\\sun\\security\\pkcs11\\j2secmod.c \n       // JDK STRING WHICH MATCHES SYMBOL, USED TO IDENTIFY THE CALL OF NSS_INITIALIZE \n       // COMMENT TAKEN FROM JDK: --> \"If the NSS_InitReadWrite function is requested then \n       // call NSS_Initialize...\"\n->> SECOID_FindOIDTagDescription: 1 --> MISSING\n     * C:\\Users\\ex605\\Downloads\\openjdk\\jdk\\src\\share\\native\\sun\\security\\ec\\impl\\ecdecode.c \n       // USED IN MACRO\n->> PORT_ArenaRelease: 2 --> MISSING\n     * C:\\Users\\ex605\\Downloads\\openjdk\\jdk\\src\\share\\native\\sun\\security\\ec\\impl\\ecc_impl.h \n       // STRING USED TO DEFINE MACRO\n     * C:\\Users\\ex605\\Downloads\\openjdk\\jdk\\src\\share\\native\\sun\\security\\ec\\impl\\secitem.c \n       // MACRO CALL\n->> NSS_NoDB_Init: 1\n->> PORT_ZAlloc: 2\n->> PORT_FreeArena: 3\n->> PORT_SetError: 3\n->> PORT_ArenaUnmark: 2 --> MISSING\n     * C:\\Users\\ex605\\Downloads\\openjdk\\jdk\\src\\share\\native\\sun\\security\\ec\\impl\\ecc_impl.h \n       // STRING USED TO DEFINE MACRO\n     * C:\\Users\\ex605\\Downloads\\openjdk\\jdk\\src\\share\\native\\sun\\security\\ec\\impl\\secitem.c \n       // MACRO CALL\n->> SECITEM_CopyItem: 3\n->> PORT_ZFree: 1 --> MISSING\n     * C:\\Users\\ex605\\Downloads\\openjdk\\jdk\\src\\share\\native\\sun\\security\\ec\\impl\\ec.c \n       // STRING USED IN MACRO\n->> PORT_ArenaZAlloc: 4\n->> NSS_Initialize: 3\n->> SECMOD_GetDefaultModuleList: 1\n->> PORT_ArenaMark: 2 --> MISSING\n     * C:\\Users\\ex605\\Downloads\\openjdk\\jdk\\src\\share\\native\\sun\\security\\ec\\impl\\ecc_impl.h \n       // STRING USED TO DEFINE MACRO\n     * C:\\Users\\ex605\\Downloads\\openjdk\\jdk\\src\\share\\native\\sun\\security\\ec\\impl\\secitem.c \n       // MACRO CALL\n->> PORT_ArenaGrow: 1 --> MISSING\n     * C:\\Users\\ex605\\Downloads\\openjdk\\jdk\\src\\share\\native\\sun\\security\\ec\\impl\\ecc_impl.h \n       // STRING USED TO DEFINE MACRO\n\nIn case you would like to have a look at the JDK files yourself, you can download the source from http://download.java.net/openjdk/jdk8/\n\nPlease let me know in case you need further information or have questions regarding my investigation.\n\nKind regards,\nJ\u00e9r\u00f4me", "author": "jeromewagener@gmail.com", "id": 11067880, "time": "2016-01-12T11:22:12Z"}, {"text": "Created attachment 8707911\nexport symbols used by Java from Firefox-built NSS library\n\nBetter late than never.", "author": "nfroyd@mozilla.com", "id": 11076377, "time": "2016-01-14T16:24:19Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/a885fca1709a", "author": "pulsebot@bots.tld", "id": 11092839, "time": "2016-01-20T21:01:34Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/a885fca1709a", "author": "cbook@mozilla.com", "id": 11094603, "time": "2016-01-21T10:54:25Z"}, {"text": "[Tracking Requested - why for this release]: Some Java applets require this to work properly with Java security libraries.  It would have been nice to fix this for ESR38, but we can at least try to fix it for ESR45.", "author": "nfroyd@mozilla.com", "id": 11095319, "time": "2016-01-21T15:13:04Z"}, {"text": "Comment on attachment 8707911\nexport symbols used by Java from Firefox-built NSS library\n\nApproval Request Comment\n[Feature/regressing bug #]: bug 1025998\n[User impact if declined]: security-oriented Java programs won't work.\n[Describe test coverage new/current, TreeHerder]: we have no test coverage for this feature, or we probably wouldn't have broken it in the first place.\n[Risks and why]: Low risk.  Just reverting the visibility of some symbols in our NSS library.\n[String/UUID change made/needed]: None.", "author": "nfroyd@mozilla.com", "id": 11095324, "time": "2016-01-21T15:15:16Z"}, {"text": "Comment on attachment 8707911\nexport symbols used by Java from Firefox-built NSS library\n\nSure, in the context of 45 being an ESR, taking this uplift.", "author": "sledru@mozilla.com", "id": 11098557, "time": "2016-01-22T10:47:48Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-aurora/rev/68f60ab89084", "author": "cbook@mozilla.com", "id": 11099231, "time": "2016-01-22T15:21:17Z"}], "id": 1155198, "priority": "--", "mentors_detail": [], "comment_count": 14, "version": "37 Branch", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "cf_tracking_firefox45": "+", "last_change_time": "2018-03-02T20:12:20Z", "cf_platform_rel": "---", "product": "Firefox Build System", "cf_fx_iteration": "---", "blocks": [], "qa_contact": "", "see_also": [], "cf_status_firefox_esr52": "---", "component": "General", "votes": 0, "groups": [], "cf_status_firefox60": "---", "cf_status_firefox43": "wontfix", "target_milestone": "mozilla46", "cf_status_firefox44": "wontfix", "is_cc_accessible": true, "cf_status_firefox46": "fixed", "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "jeromewagener@gmail.com", "id": 536887, "name": "jeromewagener@gmail.com", "real_name": "J\u00e9r\u00f4me"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "brindusa.tot@softvision.ro", "id": 553429, "name": "brindusa.tot@softvision.ro", "real_name": "Brindusa Tot[:brindusat]"}, {"email": "jeromewagener@gmail.com", "id": 536887, "name": "jeromewagener@gmail.com", "real_name": "J\u00e9r\u00f4me"}, {"email": "mh+mozilla@glandium.org", "id": 47192, "name": "mh+mozilla@glandium.org", "real_name": "Mike Hommey [:glandium]"}, {"email": "nfroyd@mozilla.com", "id": 417288, "name": "nfroyd@mozilla.com", "real_name": "Nathan Froyd [:froydnj]"}, {"email": "sledru@mozilla.com", "id": 495955, "name": "sledru@mozilla.com", "real_name": "Sylvestre Ledru [:sylvestre]"}], "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "assigned_to": "nfroyd@mozilla.com", "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "brindusa.tot@softvision.ro, nfroyd@mozilla.com"}, {"removed": "Untriaged", "field_name": "component", "added": "Build Config"}, {"removed": "Firefox", "field_name": "product", "added": "Core"}], "who": "brindusa.tot@softvision.ro", "when": "2015-12-30T15:21:53Z"}, {"changes": [{"removed": "UNCONFIRMED", "field_name": "status", "added": "NEW"}, {"removed": "", "field_name": "cc", "added": "jeromewagener@gmail.com"}, {"removed": "0", "field_name": "is_confirmed", "added": "1"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(jeromewagener@gmail.com)"}], "who": "nfroyd@mozilla.com", "when": "2016-01-04T12:22:15Z"}, {"changes": [{"removed": "needinfo?(jeromewagener@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "jeromewagener@gmail.com", "when": "2016-01-11T16:10:05Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(jeromewagener@gmail.com)"}], "who": "nfroyd@mozilla.com", "when": "2016-01-11T20:29:27Z"}, {"changes": [{"removed": "needinfo?(jeromewagener@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "jeromewagener@gmail.com", "when": "2016-01-12T11:22:12Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8707911, "added": "review?(mh+mozilla@glandium.org)"}, {"removed": "", "field_name": "cc", "added": "mh+mozilla@glandium.org"}], "who": "nfroyd@mozilla.com", "when": "2016-01-14T16:24:19Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(mh+mozilla@glandium.org)", "attachment_id": 8707911, "added": "review+"}], "who": "mh+mozilla@glandium.org", "when": "2016-01-15T09:50:24Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla46"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2016-01-21 02:54:25"}, {"removed": "---", "field_name": "cf_status_firefox46", "added": "fixed"}], "who": "cbook@mozilla.com", "when": "2016-01-21T10:54:25Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "nfroyd@mozilla.com"}], "who": "nfroyd@mozilla.com", "when": "2016-01-21T15:11:36Z"}, {"changes": [{"removed": "---", "field_name": "cf_status_firefox43", "added": "wontfix"}, {"removed": "---", "field_name": "cf_status_firefox44", "added": "affected"}, {"removed": "---", "field_name": "cf_tracking_firefox45", "added": "?"}, {"removed": "---", "field_name": "cf_status_firefox45", "added": "affected"}], "who": "nfroyd@mozilla.com", "when": "2016-01-21T15:13:04Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8707911, "added": "approval-mozilla-aurora?"}], "who": "nfroyd@mozilla.com", "when": "2016-01-21T15:15:16Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "sledru@mozilla.com"}, {"removed": "affected", "field_name": "cf_status_firefox44", "added": "wontfix"}, {"removed": "?", "field_name": "cf_tracking_firefox45", "added": "+"}], "who": "sledru@mozilla.com", "when": "2016-01-22T10:46:37Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "approval-mozilla-aurora?", "attachment_id": 8707911, "added": "approval-mozilla-aurora+"}], "who": "sledru@mozilla.com", "when": "2016-01-22T10:47:48Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox45", "added": "fixed"}], "who": "cbook@mozilla.com", "when": "2016-01-22T15:21:17Z"}, {"changes": [{"removed": "Core", "field_name": "product", "added": "Firefox Build System"}], "who": "automation@bmo.tld", "when": "2018-03-02T20:12:20Z"}], "resolution": "FIXED", "op_sys": "Windows 7", "cf_fx_points": "---", "cf_blocking_fennec": "---"}