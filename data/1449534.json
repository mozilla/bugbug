{"cf_tracking_thunderbird_esr52": "---", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "florian@queze.net", "mentors_detail": [], "depends_on": [], "cf_status_firefox_esr60": "---", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "keywords": [], "cc_detail": [{"email": "alessio.placitelli@gmail.com", "id": 248036, "name": "alessio.placitelli@gmail.com", "real_name": "Alessio Placitelli [:Dexter]"}, {"email": "gfritzsche@mozilla.com", "id": 439671, "name": "gfritzsche@mozilla.com", "real_name": "Georg Fritzsche [:gfritzsche]"}, {"email": "mcastelluccio@mozilla.com", "id": 420453, "name": "mcastelluccio@mozilla.com", "real_name": "Marco Castelluccio [:marco]"}], "cf_last_resolved": "2018-05-26T04:12:20Z", "attachments": [{"creator": "mcastelluccio@mozilla.com", "is_obsolete": 1, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-10T08:04:49Z", "type_id": 4, "creation_date": "2018-04-09T22:59:40Z", "id": 1741465, "setter": "alessio.placitelli@gmail.com"}], "content_type": "text/plain", "id": 8966413}, {"creator": "mcastelluccio@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2018-05-25T15:11:05Z", "type_id": 4, "creation_date": "2018-04-30T16:48:10Z", "id": 1750736, "setter": "alessio.placitelli@gmail.com"}], "content_type": "text/plain", "id": 8972047}], "votes": 0, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 16, "comments": [{"text": "When quitting nightly (either from the \"Quit Nightly\" menu item or when pressing cmd+Q, I see this message printed in my terminal:\n\n*** UTM:SVC TimerManager:registerTimer called after profile-before-change notification. Ignoring timer registration for id: telemetry_modules_ping", "author": "florian@queze.net", "id": 13162930, "time": "2018-03-28T11:23:17Z"}, {"text": "Marco, could you take a look at this? Looks like it comes from the Modules ping code.", "author": "alessio.placitelli@gmail.com", "id": 13163222, "time": "2018-03-28T13:16:03Z"}, {"text": "The timer registration should be happening in the startup phase (https://dxr.mozilla.org/mozilla-central/source/toolkit/components/telemetry/TelemetryController.jsm#705).\nAre you closing Nightly very early after startup?", "author": "mcastelluccio@mozilla.com", "id": 13171443, "time": "2018-04-01T20:37:36Z"}, {"text": "(In reply to Marco Castelluccio [:marco] from comment #2)\n> The timer registration should be happening in the startup phase\n> (https://dxr.mozilla.org/mozilla-central/source/toolkit/components/telemetry/\n> TelemetryController.jsm#705).\n> Are you closing Nightly very early after startup?\n\nThis is initialized using a DeferredTask with a TELEMETRY_DELAY (60s) delay. It's quite possible that I kept Firefox running for less than a minute, yes, but I wouldn't call that \"very early\". I guess the error occurs when the DeferredTask gets finalized during shutdown, https://dxr.mozilla.org/mozilla-central/rev/c44f60c43432d468639b5fe078420e60c13fd3de/toolkit/components/telemetry/TelemetryController.jsm#811", "author": "florian@queze.net", "id": 13176265, "time": "2018-04-03T13:36:42Z"}, {"text": "Retrieving the list of loaded modules is expensive, so we want to run it as late as possible. So, I think the behavior here is OK.\n\nWe could avoid calling registerTimer after `profile-before-change`, but it would have exactly the same effect (the timer registration is not done).\nAdding an observer to TelemetryModules just for this might be adding unnecessary complexity. Is there another, more concise, way to tell if we are after the 'profile-before-change' phase?", "author": "mcastelluccio@mozilla.com", "id": 13176321, "time": "2018-04-03T13:51:37Z"}, {"text": "Unless I'm missing something, a fix could be as simple as adding a this._delayedInitTask.disarm(); line right before the line calling finalize(). I just tested this locally and can confirm that the error message is gone. I don't know this code enough to know if this will have undesired side effects.", "author": "florian@queze.net", "id": 13176358, "time": "2018-04-03T14:02:39Z"}, {"text": "(In reply to Florian Qu\u00e8ze [:florian] from comment #5)\n> Unless I'm missing something, a fix could be as simple as adding a\n> this._delayedInitTask.disarm(); line right before the line calling\n> finalize(). I just tested this locally and can confirm that the error\n> message is gone. I don't know this code enough to know if this will have\n> undesired side effects.\n\nIn the second case in shutdown() (\"2) _delayedInitTask was scheduled, but didn't run yet.\"), we are currently forcing the task to run. If that's actually what we want (:Dexter probably knows), then we can't disarm the task.", "author": "mcastelluccio@mozilla.com", "id": 13176397, "time": "2018-04-03T14:14:53Z"}, {"text": "Setting assignment per my understanding here, please change if needed.", "author": "gfritzsche@mozilla.com", "id": 13176458, "time": "2018-04-03T14:33:20Z"}, {"text": "(In reply to Marco Castelluccio [:marco] from comment #6)\n> (In reply to Florian Qu\u00e8ze [:florian] from comment #5)\n> > Unless I'm missing something, a fix could be as simple as adding a\n> > this._delayedInitTask.disarm(); line right before the line calling\n> > finalize(). I just tested this locally and can confirm that the error\n> > message is gone. I don't know this code enough to know if this will have\n> > undesired side effects.\n> \n> In the second case in shutdown() (\"2) _delayedInitTask was scheduled, but\n> didn't run yet.\"), we are currently forcing the task to run. If that's\n> actually what we want (:Dexter probably knows), then we can't disarm the\n> task.\n\nYes, that's intended to be like that and we should not disarm the task. However, you could consider checking for |this._shuttingDown| around https://dxr.mozilla.org/mozilla-central/rev/c44f60c43432d468639b5fe078420e60c13fd3de/toolkit/components/telemetry/TelemetryController.jsm#705 so that the registration doesn't happen while we're shutting down.", "author": "alessio.placitelli@gmail.com", "id": 13182550, "time": "2018-04-05T09:52:27Z"}, {"text": "Created attachment 8966413\nPatch\n\n(In reply to Alessio Placitelli [:Dexter] from comment #8)\n> (In reply to Marco Castelluccio [:marco] from comment #6)\n> > (In reply to Florian Qu\u00e8ze [:florian] from comment #5)\n> > > Unless I'm missing something, a fix could be as simple as adding a\n> > > this._delayedInitTask.disarm(); line right before the line calling\n> > > finalize(). I just tested this locally and can confirm that the error\n> > > message is gone. I don't know this code enough to know if this will have\n> > > undesired side effects.\n> > \n> > In the second case in shutdown() (\"2) _delayedInitTask was scheduled, but\n> > didn't run yet.\"), we are currently forcing the task to run. If that's\n> > actually what we want (:Dexter probably knows), then we can't disarm the\n> > task.\n> \n> Yes, that's intended to be like that and we should not disarm the task.\n> However, you could consider checking for |this._shuttingDown| around\n> https://dxr.mozilla.org/mozilla-central/rev/\n> c44f60c43432d468639b5fe078420e60c13fd3de/toolkit/components/telemetry/\n> TelemetryController.jsm#705 so that the registration doesn't happen while\n> we're shutting down.\n\nSounds good, patch attached.", "author": "mcastelluccio@mozilla.com", "id": 13193629, "time": "2018-04-09T22:59:40Z"}, {"text": "Comment on attachment 8966413\nPatch\n\nReview of attachment 8966413:\n-----------------------------------------------------------------\n\nLooks good to me with the comment added. Before landing this, let's check that this solves the problem and that TelemetryModules is correctly loaded in the other cases :)\n\n::: toolkit/components/telemetry/TelemetryController.jsm\n@@ +700,5 @@\n>          // the profile directory. This is a temporary measure that we should drop\n>          // in the future.\n>          TelemetryStorage.removeFHRDatabase();\n>  \n> +        if (!this._shuttingDown) {\n\nnit: let's add a comment mentioning why this is needed, e.g. \"the init sequence is forced to run on shutdown for short sessions and we don't want to start TelemetryModules as the timer registration will fail\".", "author": "alessio.placitelli@gmail.com", "id": 13194187, "time": "2018-04-10T08:04:49Z"}, {"text": "Marco, are you actively working on this?\nDo you have timeframe for landing this?", "author": "gfritzsche@mozilla.com", "id": 13238140, "time": "2018-04-27T13:26:59Z"}, {"text": "Created attachment 8972047\nPatch\n\nSorry for the delay. I've just tested it and it doesn't actually work.\nTelemetryController::shutdown calls _delayedInitTask.finalize(), which executes the DeferredTask before _cleanupOnShutdown sets `_shuttingDown` to true.\n\nI could set `_shuttingDown` to true earlier, at the beginning of TelemetryController::shutdown() and, as far as I can tell, it should be fine (the only other user of `_shuttingDown` is using it later than _cleanupOnShutdown anyways, so setting `_shuttingDown` to true earlier shouldn't affect it).", "author": "mcastelluccio@mozilla.com", "id": 13243653, "time": "2018-04-30T16:48:10Z"}, {"text": "Comment on attachment 8972047\nPatch\n\nReview of attachment 8972047:\n-----------------------------------------------------------------\n\nThis looks good to me, thanks Marco. Apologies for the delay in reviewing this.", "author": "alessio.placitelli@gmail.com", "id": 13364082, "time": "2018-05-25T15:11:05Z"}, {"text": "Pushed by mcastelluccio@mozilla.com:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/b7723854a295\nDon't start TelemetryModules timer on shutdown. r=Dexter", "author": "pulsebot@bots.tld", "id": 13364412, "time": "2018-05-25T16:54:57Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/b7723854a295", "author": "dluca@mozilla.com", "id": 13365703, "time": "2018-05-26T04:12:20Z"}], "id": 1449534, "priority": "P1", "cc": ["alessio.placitelli@gmail.com", "gfritzsche@mozilla.com", "mcastelluccio@mozilla.com"], "cf_crash_signature": "", "version": "Trunk", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_thunderbird_esr60": "---", "status": "RESOLVED", "product": "Toolkit", "cf_fx_iteration": "---", "blocks": [], "qa_contact": "", "creation_time": "2018-03-28T11:23:17Z", "cf_status_firefox_esr52": "---", "component": "Telemetry", "assigned_to_detail": {"email": "mcastelluccio@mozilla.com", "id": 420453, "name": "mcastelluccio@mozilla.com", "real_name": "Marco Castelluccio [:marco]"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "fixed", "cf_status_firefox61": "wontfix", "cf_status_firefox60": "---", "target_milestone": "mozilla62", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "florian@queze.net", "id": 149052, "name": "florian@queze.net", "real_name": "Florian Qu\u00e8ze [:florian]"}, "whiteboard": "", "mentors": [], "summary": "Telemetry attempts to register a timer during shutdown after profile-before-change", "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-05-29T00:19:14Z", "assigned_to": "mcastelluccio@mozilla.com", "is_open": false, "history": [{"changes": [{"removed": "--", "field_name": "priority", "added": "P2"}, {"removed": "", "field_name": "cc", "added": "alessio.placitelli@gmail.com, mcastelluccio@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(mcastelluccio@mozilla.com)"}], "who": "alessio.placitelli@gmail.com", "when": "2018-03-28T13:16:03Z"}, {"changes": [{"removed": "needinfo?(mcastelluccio@mozilla.com)", "field_name": "flagtypes.name", "added": "needinfo?(florian@queze.net)"}], "who": "mcastelluccio@mozilla.com", "when": "2018-04-01T20:37:36Z"}, {"changes": [{"removed": "needinfo?(florian@queze.net)", "field_name": "flagtypes.name", "added": ""}], "who": "florian@queze.net", "when": "2018-04-03T13:36:42Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "gfritzsche@mozilla.com"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "mcastelluccio@mozilla.com"}], "who": "gfritzsche@mozilla.com", "when": "2018-04-03T14:33:20Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(mcastelluccio@mozilla.com)"}], "who": "alessio.placitelli@gmail.com", "when": "2018-04-05T09:52:27Z"}, {"changes": [{"removed": "needinfo?(mcastelluccio@mozilla.com)", "field_name": "flagtypes.name", "added": ""}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8966413, "added": "review?(alessio.placitelli@gmail.com)"}], "who": "mcastelluccio@mozilla.com", "when": "2018-04-09T22:59:40Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(alessio.placitelli@gmail.com)", "attachment_id": 8966413, "added": "review+"}], "who": "alessio.placitelli@gmail.com", "when": "2018-04-10T08:04:49Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(mcastelluccio@mozilla.com)"}], "who": "gfritzsche@mozilla.com", "when": "2018-04-27T13:26:59Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8966413, "added": "1"}, {"removed": "needinfo?(mcastelluccio@mozilla.com)", "field_name": "flagtypes.name", "added": ""}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8972047, "added": "review?(alessio.placitelli@gmail.com)"}], "who": "mcastelluccio@mozilla.com", "when": "2018-04-30T16:48:10Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(alessio.placitelli@gmail.com)"}], "who": "gfritzsche@mozilla.com", "when": "2018-05-25T14:53:28Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(alessio.placitelli@gmail.com)", "attachment_id": 8972047, "added": "review+"}], "who": "alessio.placitelli@gmail.com", "when": "2018-05-25T15:11:05Z"}, {"changes": [{"removed": "needinfo?(alessio.placitelli@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "alessio.placitelli@gmail.com", "when": "2018-05-25T15:11:12Z"}, {"changes": [{"removed": "P2", "field_name": "priority", "added": "P1"}], "who": "alessio.placitelli@gmail.com", "when": "2018-05-25T15:11:21Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla62"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-05-26 04:12:20"}, {"removed": "---", "field_name": "cf_status_firefox62", "added": "fixed"}], "who": "dluca@mozilla.com", "when": "2018-05-26T04:12:20Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox61", "added": "wontfix"}], "who": "ryanvm@gmail.com", "when": "2018-05-29T00:19:14Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}