{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "atilag@gmail.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2015-01-06T18:17:55Z", "type_id": 4, "creation_date": "2015-01-02T23:32:05Z", "id": 1065028, "setter": "mwu.code@gmail.com"}], "content_type": "text/x-github-pull-request", "id": 8543431}, {"creator": "atilag@gmail.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2015-01-06T18:17:16Z", "type_id": 4, "creation_date": "2015-01-02T23:37:26Z", "id": 1065032, "setter": "mwu.code@gmail.com"}], "content_type": "text/x-github-pull-request", "id": 8543433}], "classification": "Components", "creator": "atilag@gmail.com", "cc": ["atilag@gmail.com", "botond@mozilla.com", "chenghuk@gmail.com", "ehsan@mozilla.com", "jld@mozilla.com", "jmuizelaar@mozilla.com", "jwalden+bmo@mit.edu", "kchang@mozilla.com", "mwu.code@gmail.com", "ted@mielczarek.org", "xwaynec@gmail.com"], "depends_on": [], "creation_time": "2014-12-06T12:10:50Z", "cf_user_story": "", "cf_backlog": "---", "cf_tracking_firefox_relnote": "---", "platform": "ARM", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "test_tone.cpp failed with new Bionic branch for ICS devices on B2G", "id": 1108228, "assigned_to_detail": {"email": "atilag@gmail.com", "id": 437176, "name": "atilag@gmail.com", "real_name": "Juan Gomez [:_AtilA_] (CET/CEST)"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "assigned_to": "atilag@gmail.com", "comment_count": 16, "comments": [{"text": "Bug 1056337 is about upgrading ICS toolchain to a newer gcc-4.8 based one, in order to upgrade it, we needed to apply some upstream patches to Bionic so we decided to branch the original one [1].\nNow test_tone.gcc unit test is failing because some kind of heap corruption (I guess):\n\nRemote debugging from host 127.0.0.1\n__dl__start () at bionic/linker/arch/arm/begin.S:35\n35\t\tmov\tr0, sp\n(gdb) c\nContinuing.\nstream started\nstream stopped\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x42bf4910 in ?? ()\n(gdb) bt\n#0  0x42bf4910 in ?? ()\n#1  0x4007cbf4 in __cxa_finalize (dso=0x0) at bionic/libc/stdlib/atexit.c:158\n#2  0x4007cf90 in exit (status=0) at bionic/libc/stdlib/exit.c:57\n#3  0x4007cf90 in exit (status=0) at bionic/libc/stdlib/exit.c:57\nBacktrace stopped: previous frame identical to this frame (corrupt stack?)\n(gdb) \n\nThis is the only test failing so far, and I'm using an ICS emulator build with some patches for the mainfest file to point to our Bionic ICS branch.\n\nI'm going to investigate how things are working in Fennec, because they must be using a similar enviornment.\n\n[1] https://github.com/mozilla-b2g/platform_bionic/tree/b2g-4.0.4_r2.1", "author": "atilag@gmail.com", "id": 9665987, "time": "2014-12-06T12:10:50Z"}, {"text": "Shawn, can anyone in your team help this?", "author": "kchang@mozilla.com", "id": 9707185, "time": "2014-12-18T01:22:13Z"}, {"text": "Hi Wayne:\n Please help check this problem first.\n\nThanks!!\nShawn", "author": "chenghuk@gmail.com", "id": 9707597, "time": "2014-12-18T03:12:51Z"}, {"text": "(In reply to Juan Gomez [:_AtilA_] from comment #0)\n> Program received signal SIGSEGV, Segmentation fault.\n> 0x42bf4910 in ?? ()\n> (gdb) bt\n> #0  0x42bf4910 in ?? ()\n> #1  0x4007cbf4 in __cxa_finalize (dso=0x0) at bionic/libc/stdlib/atexit.c:158\n> #2  0x4007cf90 in exit (status=0) at bionic/libc/stdlib/exit.c:57\n> #3  0x4007cf90 in exit (status=0) at bionic/libc/stdlib/exit.c:57\n\nCan you post the results of running 'info shared' in gdb when this crash happens?", "author": "jmuizelaar@mozilla.com", "id": 9707957, "time": "2014-12-18T05:28:44Z"}, {"text": "Ok, this is the link to the memory map when crash happens: http://pastebin.mozilla.org/8099004\nit always point to this memmory area.\nThe crash is always happening at the end of the program, when main() exits and all destructors and callbacks registered with the atexit() or __cxa_atexit() functions are being called. \nI checked that no one is calling atexit() (neither __cxa_atexit).\nTo call these destructors/callbacks, __cxa_finalize() iterate over an array of elements (structs) that have function pointers [1], in reverse order (from 260 to 0). It always crash in the second iteraction (array index 259) because the function pointer points to 0x42bf4910 which is not a valid memory region.\nExamining the array before it crashes, showed me that the next element (258) is invalid too, but the third one (257) is ok as well as the rest of the elements (256, 255, 254 ... at least a bunch of them).\n\n[1] https://github.com/mozilla-b2g/platform_bionic/blob/b2g-4.0.4_r2.1/libc/stdlib/atexit.c#L137", "author": "atilag@gmail.com", "id": 9720084, "time": "2014-12-21T17:37:44Z"}, {"text": "__cxa_finalize runs the static destructors, so this probably means that the module that registered the static destructor has somehow been unloaded before we exit from main.  Can you do an info shared at the beginning of main or even better after having called cubeb_init() to see if there is something there that disappears by the time we crashed?  And can you also please get a memory map listing at that time?", "author": "ehsan@mozilla.com", "id": 9725212, "time": "2014-12-23T00:05:26Z"}, {"text": "Let's just drop the dependency here, disable this test, and sort it out after-the-fact. I mentioned this in #developers, but I think what you want to do is:\nif not (CONFIG['MOZ_WIDGET_TOOLKIT'] == 'gonk' and CONFIG['ANDROID_VERSION'] == '15'):\n  GeckoCppUnitTests([\n    'test_tone'\n  ])", "author": "ted@mielczarek.org", "id": 9728681, "time": "2014-12-23T20:05:18Z"}, {"text": "Ok, found the problem.\nAs Eshan pointed out, libcubeb is dynamically loading libOpenSLES.so in cubeb_init() and unloading it in cubeb_destroy(). In fact, the pointer that causes the crash is pointing into the memory address range previously ocuppied by this library before it gets unloaded via cubeb_destroy() -> dlclose().\nThis is a Bionic bug, so I'm now investigating if this was already reported (it should) and how to bring a possible fix to our fork.", "author": "atilag@gmail.com", "id": 9734262, "time": "2014-12-26T17:31:39Z"}, {"text": "UPDATED: Fixed, and even found a valid commit in the AOSP repository, so we just need to cherry-pick.\n \nThe fix basically makes sure that __on_dlclose()[1] is inserted into the FINI_ARRAY so it gets called by dlclose(). There's only one file needed to patch: crtbegin_so.c. This file only exists in the two branches created for bug 1056337.\n\nI'll PR with the fixes in a few hours.\n\n[1] __on_dlclose() calls __cxa_finalize().", "author": "atilag@gmail.com", "id": 9746966, "time": "2015-01-02T17:40:16Z"}, {"text": "Created attachment 8543431\nPR: make sure __on_dlclose() actually gets called on dlclose()\n\nCherry-picked from AOSP: 5ed48a4d7fece002afbbd2bd981563aea6e52e24", "author": "atilag@gmail.com", "id": 9747828, "time": "2015-01-02T23:32:05Z"}, {"text": "Created attachment 8543433\nPR: make sure __on_dlclose() actually gets called on dlclose() (branch: b2g-4.0.4_r2.1)\n\nSame as above.", "author": "atilag@gmail.com", "id": 9747840, "time": "2015-01-02T23:37:26Z"}, {"text": "Ugh, typos!  Great find, Juan!", "author": "ehsan@mozilla.com", "id": 9752147, "time": "2015-01-05T15:08:56Z"}, {"text": "(In reply to Juan Gomez [:_AtilA_] from comment #8)\n> The fix basically makes sure that __on_dlclose()[1] is inserted into the\n> FINI_ARRAY so it gets called by dlclose(). There's only one file needed to\n> patch: crtbegin_so.c.\n\nIf this is part of the crtstuff that's linked into every shared library, doesn't that mean that all shared libraries that might be dlclosed need to be relinked?  And, if so, does that apply only to the dlclosed library itself, or would its dependencies (if not otherwise needed) also be implicitly dlclosed?  This wouldn't be a problem on the emulator, where we have source for everything, but physical devices typically have some closed-source libraries which could be affected.", "author": "jld@mozilla.com", "id": 9753596, "time": "2015-01-05T19:35:33Z"}, {"text": "Yes, all shared libraries should be relinked if they were wrong, but they are not, so we don't need to. Let me explain, we needed to fork from AOSP Bionic used in ICS because some other PIC-compatible problem showed up while compiling with gcc-4.8. We fixed this problem applying a patch from other cherry-pick (maybe a commit for JB releases, I didn't check it out) but it looks like this new patch has introduced another bug, the one we are trying to fix here. The master branch from Bionic is not affected by this bug so all the precompiled libreries are fine, because they were linked against this version.", "author": "atilag@gmail.com", "id": 9755299, "time": "2015-01-06T01:09:21Z"}, {"text": "Comment on attachment 8543433\nPR: make sure __on_dlclose() actually gets called on dlclose() (branch: b2g-4.0.4_r2.1)\n\nNice!", "author": "mwu.code@gmail.com", "id": 9758453, "time": "2015-01-06T18:17:16Z"}, {"text": "b2g_ics_strawberry: https://github.com/mozilla-b2g/platform_bionic/commit/1a2a32eda22ef2cd18f57f423a5e7b22a105a6f8\n\nb2g-4.0.4_r2.1: https://github.com/mozilla-b2g/platform_bionic/commit/e2b3733ba3fa5e3f404e983d2e4142b1f6b1b846", "author": "ryanvm@gmail.com", "id": 9759864, "time": "2015-01-06T21:27:41Z"}], "cf_last_resolved": "2015-01-06T21:27:41Z", "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "unspecified", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2015-01-06T21:27:41Z", "cf_platform_rel": "---", "product": "Core", "cf_status_firefox_esr52": "---", "blocks": [1056337], "qa_contact": "", "see_also": [], "cf_fx_iteration": "---", "component": "Audio/Video", "votes": 0, "groups": [], "cf_status_firefox60": "---", "target_milestone": "2.2 S3 (9jan)", "is_cc_accessible": true, "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "atilag@gmail.com", "id": 437176, "name": "atilag@gmail.com", "real_name": "Juan Gomez [:_AtilA_] (CET/CEST)"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "atilag@gmail.com", "id": 437176, "name": "atilag@gmail.com", "real_name": "Juan Gomez [:_AtilA_] (CET/CEST)"}, {"email": "botond@mozilla.com", "id": 474533, "name": "botond@mozilla.com", "real_name": "Botond Ballo [:botond]"}, {"email": "chenghuk@gmail.com", "id": 474068, "name": "chenghuk@gmail.com", "real_name": "shawn ku [:sku]"}, {"email": "ehsan@mozilla.com", "id": 251051, "name": "ehsan@mozilla.com", "real_name": ":Ehsan Akhgari"}, {"email": "jld@mozilla.com", "id": 462836, "name": "jld@mozilla.com", "real_name": "Jed Davis [:jld] (\u23f0UTC-7)"}, {"email": "jmuizelaar@mozilla.com", "id": 309398, "name": "jmuizelaar@mozilla.com", "real_name": "Jeff Muizelaar [:jrmuizel]"}, {"email": "jwalden+bmo@mit.edu", "id": 83595, "name": "jwalden+bmo@mit.edu", "real_name": "Jeff Walden [:Waldo]"}, {"email": "kchang@mozilla.com", "id": 453207, "name": "kchang@mozilla.com", "real_name": "Ken Chang[:kenkai]"}, {"email": "mwu.code@gmail.com", "id": 246518, "name": "mwu.code@gmail.com", "real_name": "Michael Wu [:mwu]"}, {"email": "ted@mielczarek.org", "id": 39022, "name": "ted@mielczarek.org", "real_name": "Ted Mielczarek [:ted.mielczarek]"}, {"email": "xwaynec@gmail.com", "id": 497430, "name": "xwaynec@gmail.com", "real_name": "Wayne Chen [:xwaynec]"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "blocks", "added": "1056337"}], "who": "atilag@gmail.com", "when": "2014-12-06T12:11:12Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "jld@mozilla.com"}], "who": "jld@mozilla.com", "when": "2014-12-11T01:34:35Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "kchang@mozilla.com, sku@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(sku@mozilla.com)"}], "who": "kchang@mozilla.com", "when": "2014-12-18T01:22:13Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "waychen@mozilla.com"}, {"removed": "needinfo?(sku@mozilla.com)", "field_name": "flagtypes.name", "added": "needinfo?(waychen@mozilla.com)"}], "who": "chenghuk@gmail.com", "when": "2014-12-18T03:12:51Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "atilag@gmail.com, jmuizelaar@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(atilag@gmail.com)"}], "who": "jmuizelaar@mozilla.com", "when": "2014-12-18T05:28:44Z"}, {"changes": [{"removed": "needinfo?(atilag@gmail.com)", "field_name": "flagtypes.name", "added": ""}], "who": "atilag@gmail.com", "when": "2014-12-21T17:37:44Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "botond@mozilla.com"}], "who": "botond@mozilla.com", "when": "2014-12-22T16:11:35Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "ehsan.akhgari@gmail.com"}], "who": "ehsan@mozilla.com", "when": "2014-12-23T00:05:26Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "ted@mielczarek.org"}], "who": "ted@mielczarek.org", "when": "2014-12-23T20:05:18Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "atilag@gmail.com"}], "who": "atilag@gmail.com", "when": "2015-01-02T23:26:45Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mwu@mozilla.com"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8543431, "added": "review?(mwu@mozilla.com)"}], "who": "atilag@gmail.com", "when": "2015-01-02T23:32:05Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8543433, "added": "review?(mwu@mozilla.com)"}], "who": "atilag@gmail.com", "when": "2015-01-02T23:37:26Z"}, {"changes": [{"removed": "needinfo?(waychen@mozilla.com)", "field_name": "flagtypes.name", "added": ""}], "who": "xwaynec@gmail.com", "when": "2015-01-05T02:01:32Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "jwalden+bmo@mit.edu"}], "who": "jwalden+bmo@mit.edu", "when": "2015-01-05T18:56:51Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(mwu@mozilla.com)", "attachment_id": 8543433, "added": "review+"}], "who": "mwu.code@gmail.com", "when": "2015-01-06T18:17:16Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(mwu@mozilla.com)", "attachment_id": 8543431, "added": "review+"}], "who": "mwu.code@gmail.com", "when": "2015-01-06T18:17:55Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "checkin-needed"}], "who": "atilag@gmail.com", "when": "2015-01-06T18:31:55Z"}, {"changes": [{"removed": "checkin-needed", "field_name": "keywords", "added": ""}, {"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "2.2 S3 (9jan)"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2015-01-06 13:27:41"}, {"removed": "---", "field_name": "cf_status_b2g_2_2", "added": "fixed"}], "who": "ryanvm@gmail.com", "when": "2015-01-06T21:27:41Z"}], "resolution": "FIXED", "op_sys": "Gonk (Firefox OS)", "cf_fx_points": "---", "cf_blocking_fennec": "---"}