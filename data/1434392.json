{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "me@rmushkin.ru", "mentors_detail": [], "depends_on": [], "cf_status_firefox_esr60": "---", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "All", "cf_status_firefox58": "wontfix", "cf_status_firefox59": "wontfix", "keywords": [], "summary": "Pulseaudio daemon fails to be auto-started by Firefox because of preloaded libmozsandbox.so", "cf_last_resolved": "2018-03-09T10:01:20Z", "attachments": [{"creator": "jld@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2018-03-08T13:48:30Z", "type_id": 4, "creation_date": "2018-03-08T03:51:02Z", "id": 1726663, "setter": "gpascutto@mozilla.com"}], "content_type": "text/x-review-board-request", "id": 8957049}], "votes": 0, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 23, "comments": [{"text": "User Agent: Mozilla/5.0 (X11; Linux i686; rv:59.0) Gecko/20100101 Firefox/59.0\nBuild ID: 20180128191456\n\nSteps to reproduce:\n\nI am using Firefox Quantum 59.0b5 (32-bit) with the following setup:\n\nDebian GNU/Linux 8.10 (jessie) 3.2.0-3-686-pae with dwm window manager,\npulseaudio 7.1-2~bpo8+1\n\nPulseaudio is started with \"pulseaudio --start\" in user's .xinitrc.\n\nI had started firefox by executing it's binary file and the browser worked perfectly with audio. I then shutdown firefox and restarted it after a while.\n\n\nActual results:\n\nFirefox started normally but failed to play any audio with 'to play audio you may need to install the required pulseaudio...' message issued.\n\nIt turned out that Pulseaudio didn't respawn as it normally should. Manual start of pulseaudio with both start-pusleaudio-x11 and pulseaudio --start immediately resores sound in Firefox, but shutting FF down again also kills pusleaudio, and starting FF doesn't cause it to start again.\n\n\nExpected results:\n\nFirefox should has been able to respawn (start) PulseAudio when the PulseAudio server was down and to play sound.", "author": "me@rmushkin.ru", "id": 13006072, "time": "2018-01-30T19:15:32Z"}, {"text": "I'm noticing the same issue with Firefox 58.0.1: PulseAduio is configured to start only when needed and to exit if not needed anymore but starting Firefox does not cause the pulseaudio process being started resulting in no sound/Firefox claiming about PulseAudio eventually not being installed. This worked in Firefox 57.0.1 and reverting back fixes this issue. Alternatively pulseaudio can be started manually from a terminal as a workaround.", "author": "sworddragon2@aol.com", "id": 13023752, "time": "2018-02-07T10:07:12Z"}, {"text": "Edit: This regression does appear for me on a x86_64 (amd64) architecture.", "author": "sworddragon2@aol.com", "id": 13023759, "time": "2018-02-07T10:09:56Z"}, {"text": "Dan, is there anything we should be doing here?", "author": "giles@thaumas.net", "id": 13031567, "time": "2018-02-09T19:50:41Z"}, {"text": "I defer to Matthew on this one.\n\nMatthew, do you know about `pulseaudio --start`?", "author": "dglastonbury@mozilla.com", "id": 13063258, "time": "2018-02-23T05:44:05Z"}, {"text": "Is this related to https://bugzilla.mozilla.org/show_bug.cgi?id=1422073 , since I get expected results with:\n\nMOZ_DISABLE_CONTENT_SANDBOX=1 firefox\n\nand it says fixed in 59", "author": "mikelieman@gmail.com", "id": 13066189, "time": "2018-02-24T11:39:59Z"}, {"text": "There's a period of time (58 until it was enabled in 59) where the sandbox restrictions were increased such that Firefox no longer had permissions to spawn the PulseAudio server... this is ultimately addressed by changes in 59, where the audio is remoted to the chrome process (without restricted privileges).  So that's related to bug 1422073.\n\nThe other part of this bug report needs further investigation - why is PulseAudio, started from the X session, terminating after being used by Firefox?  Can anyone who is seeing this issue please run PulseAudio with logging enabled (https://wiki.ubuntu.com/PulseAudio/Log), reproduce the situation where PA terminates after being used by Firefox, and then post the logs?", "author": "kinetik@flim.org", "id": 13106150, "time": "2018-03-05T20:44:08Z"}, {"text": "The content process hasn't been allowed to start the PulseAudio daemon while sandboxed since sandboxing was enabled \u2014 even if we allowed the fork and execve syscalls, the daemon would inherit the content process's seccomp-bpf policy and would break.  (Specifically, the first time ld.so tries to open or stat a file, it would raise SIGSYS and immediately die because Firefox's SIGSYS handler is no longer present.)\n\nAs a result, in bug 1259508 we initialized audio before starting the sandbox, to allow for starting the PulseAudio daemon (or anything else along those lines.  But that was removed in bug 1405877, and it wasn't conditional on the \"media.cubeb.sandbox\" pref, which is where bug 1434156 comes in.\n\nSo that would explain why it's broken in 59 (and will be fixed in 60) if the daemon isn't already running.  It might also explain problems if the daemon is set to auto-exit on idle and a sandboxed content process tries to restart it, but *that* should have started breaking in 54, not 58.  (Or maybe 57, if there were non-e10s-compatible extensions that were forcing single-process mode before they were desupported\u2026 but not 58.)", "author": "jld@mozilla.com", "id": 13107074, "time": "2018-03-06T04:24:14Z"}, {"text": "(In reply to Jed Davis [:jld] (\u23f0UTC-7) from comment #7)\n> It might also explain problems if the daemon\n> is set to auto-exit on idle and a sandboxed content process tries to restart\n> it, but *that* should have started breaking in 54, not 58.\n\nIf I'm not wrong the pulseaudio process never exited here while Firefox was running even if all tabs were being closed (on a test I see 2 firefox processes in that case - 1 without arguments and 1 -contentproc) - it was always required that Firefox was completely closed before the pulseaudio process was also able to exit.", "author": "sworddragon2@aol.com", "id": 13108058, "time": "2018-03-06T14:27:09Z"}, {"text": "(In reply to me from comment #0)\n> Debian GNU/Linux 8.10 (jessie) 3.2.0-3-686-pae\n\nTo make things more complicated: This kernel is too old for sandboxing; the \u201cSandbox\u201d section of about:support should confirm that.  There could be something else going on here, maybe a side-effect of inheriting LD_LIBRARY_PATH and/or LD_PRELOAD from the content process.\n\n(Note: Ubuntu's 3.2.0 kernels have seccomp-bpf because Chromium sandbox devs worked with them to backport it for their 12.04 release, but for Debian it's in 3.5, same as the mainline kernel.)\n\nAlso, I just tried to reproduce what I described in comment #7 on Debian unstable, and failed: the PulseAudio daemon was spawned by systemd instead of directly by the client.", "author": "jld@mozilla.com", "id": 13108551, "time": "2018-03-06T17:12:07Z"}, {"text": "With the help of a Debian 8 VM, I've figured out the other half of this bug, and the reason it's happening on 58: bug 1412464.\n\nThe PulseAudio daemon inherits the content process's environment, including LD_PRELOAD, so when we use the libmozsandbox.so preload to replace inotify_init (which we don't need) with a stub that always returns an error, that also applies to PulseAudio (which does need it).  Specifically, this causes an error in module-udev-detect initialization.\n\nSo we *do* try to pre-start pulseaudio, but it doesn't work, and then we try again after the sandbox is started and get a similar failure to bug 1443612, but for different reasons.\n\nAnd it turns out the right place to look for additional information here is /var/log/user.log:\n\nMar  7 12:44:17 debian8 pulseaudio[22081]: [pulseaudio] module-udev-detect.c: inotify_init1() failed: Function not implemented\nMar  7 12:44:17 debian8 pulseaudio[22081]: [pulseaudio] module.c: Failed to load module \"module-udev-detect\" (argument: \"\"): initialization failed.\nMar  7 12:44:17 debian8 pulseaudio[22081]: [pulseaudio] main.c: Module load failed.\nMar  7 12:44:17 debian8 pulseaudio[22081]: [pulseaudio] main.c: Failed to initialize daemon.\nMar  7 12:44:17 debian8 pulseaudio[22078]: [pulseaudio] main.c: Daemon startup failed.", "author": "jld@mozilla.com", "id": 13112045, "time": "2018-03-07T20:02:11Z"}, {"text": "*** Bug 1435523 has been marked as a duplicate of this bug. ***", "author": "jld@mozilla.com", "id": 13112052, "time": "2018-03-07T20:03:42Z"}, {"text": "Created attachment 8957049\nBug 1434392 - Don't preload libmozsandbox in grandchild processes, only the sandboxed children themselves.\n\nReview commit: https://reviewboard.mozilla.org/r/226010/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/226010/", "author": "jld@mozilla.com", "id": 13113156, "time": "2018-03-08T03:51:02Z"}, {"text": "Comment on attachment 8957049\nBug 1434392 - Don't preload libmozsandbox in grandchild processes, only the sandboxed children themselves.\n\nhttps://reviewboard.mozilla.org/r/226010/#review232006", "author": "gpascutto@mozilla.com", "id": 13113922, "time": "2018-03-08T13:48:30Z"}, {"text": "Pushed by jedavis@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/07b6161c7f60\nDon't preload libmozsandbox in grandchild processes, only the sandboxed children themselves. r=gcp", "author": "pulsebot@bots.tld", "id": 13115451, "time": "2018-03-08T22:34:31Z"}, {"text": "Only for future reference: for people who run into the issue of pulseaudio exiting and Firefox failing to restart it again, especially in fully automated test environments, it might help to set \"--exit-idle-time=-1\" in you pulseaudio config http://manpages.ubuntu.com/manpages/trusty/man5/pulse-daemon.conf.5.html", "author": "drno@ohlmeier.org", "id": 13115524, "time": "2018-03-08T23:03:05Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/07b6161c7f60", "author": "dluca@mozilla.com", "id": 13116341, "time": "2018-03-09T10:01:20Z"}, {"text": "Should we keep this on the radar as a possible dot release ride along, or is this enough of a corner case that it can ride with 60?", "author": "jcristau@mozilla.com", "id": 13117213, "time": "2018-03-09T16:53:40Z"}, {"text": "Is this actually a corner case? On Ubuntu the default value for exit-idle-time is 20 which would make me think that even on a default Ubuntu installation pulseaudio would always exit after 20 seconds being unused - but I have never tested it on an out of the box installation.", "author": "sworddragon2@aol.com", "id": 13117296, "time": "2018-03-09T17:19:37Z"}, {"text": "(In reply to sworddragon2 from comment #18)\n> Is this actually a corner case? On Ubuntu the default value for\n> exit-idle-time is 20 which would make me think that even on a default Ubuntu\n> installation pulseaudio would always exit after 20 seconds being unused -\n> but I have never tested it on an out of the box installation.\n\nThe default Ubuntu desktop environment appears to have 4-5 connections to PulseAudio at all times, which would make exit-idle-time irrelevant if I understand correctly.", "author": "jld@mozilla.com", "id": 13117467, "time": "2018-03-09T18:34:09Z"}, {"text": "(In reply to Julien Cristau [:jcristau] from comment #17)\n> Should we keep this on the radar as a possible dot release ride along, or is\n> this enough of a corner case that it can ride with 60?\n\nYes, I think we should consider it for 59.0.x, but see bug 1443612 comment #10: this patch won't uplift cleanly, and for 59 we can back out bug 1412464 and bug 1408497 instead, so I propose doing that as the lower-risk approach.\n\nShould I attach a patch for those backouts to this bug and flag it for release approval?", "author": "jld@mozilla.com", "id": 13117492, "time": "2018-03-09T18:42:20Z"}, {"text": "Bug 1443612 is now wontfix for 59, so there's no benefit to uplifting this half.", "author": "jld@mozilla.com", "id": 13117523, "time": "2018-03-09T18:52:37Z"}, {"text": "*** Bug 1458864 has been marked as a duplicate of this bug. ***", "author": "kinetik@flim.org", "id": 13272381, "time": "2018-05-12T09:04:54Z"}], "id": 1434392, "priority": "P1", "cc": ["drno@ohlmeier.org", "eriksgimsing@gmail.com", "gpascutto@mozilla.com", "hidenosuke@hidenosuke.org", "jcristau@mozilla.com", "jld@mozilla.com", "kinetik@flim.org", "Martijn.Ras@GMail.com", "mikelieman@gmail.com", "sworddragon2@aol.com"], "cf_crash_signature": "", "version": "58 Branch", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": ["https://bugzilla.mozilla.org/show_bug.cgi?id=1443612", "https://bugzilla.mozilla.org/show_bug.cgi?id=1434477"], "cf_tracking_thunderbird_esr60": "---", "last_change_time": "2018-05-12T09:04:54Z", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1412464], "qa_contact": "", "creation_time": "2018-01-30T19:15:32Z", "cf_status_firefox_esr52": "---", "component": "Security: Process Sandboxing", "assigned_to_detail": {"email": "jld@mozilla.com", "id": 462836, "name": "jld@mozilla.com", "real_name": "Jed Davis [:jld] (\u23f0UTC-6)"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "---", "cf_status_firefox60": "fixed", "target_milestone": "mozilla60", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "me@rmushkin.ru", "id": 611013, "name": "me@rmushkin.ru", "real_name": ""}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "drno@ohlmeier.org", "id": 489581, "name": "drno@ohlmeier.org", "real_name": "Nils Ohlmeier [:drno]"}, {"email": "eriksgimsing@gmail.com", "id": 611343, "name": "eriksgimsing@gmail.com", "real_name": "Natskyge"}, {"email": "gpascutto@mozilla.com", "id": 151147, "name": "gpascutto@mozilla.com", "real_name": "Gian-Carlo Pascutto [:gcp]"}, {"email": "hidenosuke@hidenosuke.org", "id": 31289, "name": "hidenosuke@hidenosuke.org", "real_name": "Hideo Oshima"}, {"email": "jcristau@mozilla.com", "id": 580382, "name": "jcristau@mozilla.com", "real_name": "Julien Cristau [:jcristau]"}, {"email": "jld@mozilla.com", "id": 462836, "name": "jld@mozilla.com", "real_name": "Jed Davis [:jld] (\u23f0UTC-6)"}, {"email": "kinetik@flim.org", "id": 274575, "name": "kinetik@flim.org", "real_name": "Matthew Gregan [:kinetik]"}, {"email": "Martijn.Ras@GMail.com", "id": 54558, "name": "Martijn.Ras@GMail.com", "real_name": "Martijn Ras"}, {"email": "mikelieman@gmail.com", "id": 612588, "name": "mikelieman@gmail.com", "real_name": "Mike Lieman"}, {"email": "sworddragon2@aol.com", "id": 311077, "name": "sworddragon2@aol.com", "real_name": ""}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "assigned_to": "jld@mozilla.com", "is_open": false, "history": [{"changes": [{"removed": "Untriaged", "field_name": "component", "added": "Audio/Video: Playback"}, {"removed": "Unspecified", "field_name": "platform", "added": "x86"}, {"removed": "Firefox", "field_name": "product", "added": "Core"}, {"removed": "Unspecified", "field_name": "op_sys", "added": "Linux"}], "who": "yfdyh000@gmail.com", "when": "2018-01-31T02:11:18Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "sworddragon2@aol.com"}], "who": "sworddragon2@aol.com", "when": "2018-02-07T10:07:12Z"}, {"changes": [{"removed": "--", "field_name": "priority", "added": "P3"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "dglastonbury@mozilla.com"}], "who": "giles@thaumas.net", "when": "2018-02-09T19:50:41Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "kinetik@flim.org"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(kinetik@flim.org)"}], "who": "dglastonbury@mozilla.com", "when": "2018-02-23T05:44:05Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mikelieman@gmail.com"}], "who": "mikelieman@gmail.com", "when": "2018-02-23T12:03:55Z"}, {"changes": [{"removed": "needinfo?(kinetik@flim.org)", "field_name": "flagtypes.name", "added": ""}], "who": "kinetik@flim.org", "when": "2018-03-05T20:44:08Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "jld@mozilla.com"}], "who": "jld@mozilla.com", "when": "2018-03-06T04:24:14Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1443612"}], "who": "jld@mozilla.com", "when": "2018-03-06T20:01:16Z"}, {"changes": [{"removed": "P3", "field_name": "priority", "added": "P1"}, {"removed": "UNCONFIRMED", "field_name": "status", "added": "NEW"}, {"removed": "59 Branch", "field_name": "version", "added": "58 Branch"}, {"removed": "x86", "field_name": "platform", "added": "All"}, {"removed": "Audio/Video: Playback", "field_name": "component", "added": "Security: Process Sandboxing"}, {"removed": "", "field_name": "blocks", "added": "1412464"}, {"removed": "dglastonbury@mozilla.com", "field_name": "assigned_to", "added": "jld@mozilla.com"}, {"removed": "0", "field_name": "is_confirmed", "added": "1"}, {"removed": "Pulseaudio: Firefox cannot connect the server after browser restart", "field_name": "summary", "added": "Pulseaudio daemon fails to be auto-started by Firefox because of preloaded libmozsandbox.so"}, {"removed": "---", "field_name": "cf_status_firefox58", "added": "wontfix"}, {"removed": "---", "field_name": "cf_status_firefox59", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox60", "added": "affected"}], "who": "jld@mozilla.com", "when": "2018-03-07T20:02:11Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "eriksgimsing@gmail.com"}], "who": "jld@mozilla.com", "when": "2018-03-07T20:03:42Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8957049, "added": "review?(gpascutto@mozilla.com)"}, {"removed": "", "field_name": "cc", "added": "gpascutto@mozilla.com"}], "who": "jld@mozilla.com", "when": "2018-03-08T03:51:02Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(gpascutto@mozilla.com)", "attachment_id": 8957049, "added": "review+"}], "who": "gpascutto@mozilla.com", "when": "2018-03-08T13:48:30Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "drno@ohlmeier.org"}], "who": "drno@ohlmeier.org", "when": "2018-03-08T23:03:05Z"}, {"changes": [{"removed": "", "field_name": "see_also", "added": "https://bugzilla.mozilla.org/show_bug.cgi?id=1434477"}], "who": "drno@ohlmeier.org", "when": "2018-03-08T23:04:27Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla60"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-03-09 10:01:20"}, {"removed": "affected", "field_name": "cf_status_firefox60", "added": "fixed"}], "who": "dluca@mozilla.com", "when": "2018-03-09T10:01:20Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "hidenosuke@hidenosuke.org"}], "who": "hidenosuke@hidenosuke.org", "when": "2018-03-09T13:44:54Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "jcristau@mozilla.com"}], "who": "jcristau@mozilla.com", "when": "2018-03-09T16:53:40Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(jcristau@mozilla.com)"}], "who": "jld@mozilla.com", "when": "2018-03-09T18:42:20Z"}, {"changes": [{"removed": "needinfo?(jcristau@mozilla.com)", "field_name": "flagtypes.name", "added": ""}, {"removed": "affected", "field_name": "cf_status_firefox59", "added": "wontfix"}], "who": "jld@mozilla.com", "when": "2018-03-09T18:52:37Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "Martijn.Ras@GMail.com"}], "who": "kinetik@flim.org", "when": "2018-05-12T09:04:54Z"}], "resolution": "FIXED", "op_sys": "Linux", "cf_fx_points": "---", "cf_blocking_fennec": "---"}