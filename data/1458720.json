{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "dkeeler@mozilla.com", "mentors_detail": [], "depends_on": [], "cf_status_firefox_esr60": "wontfix", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "cf_status_firefox59": "wontfix", "keywords": [], "cc_detail": [{"email": "ehsan@mozilla.com", "id": 251051, "name": "ehsan@mozilla.com", "real_name": ":Ehsan Akhgari"}, {"email": "jjones@mozilla.com", "id": 520206, "name": "jjones@mozilla.com", "real_name": "J.C. Jones [:jcj] (Leave between 24 Jun - 17 Aug)"}, {"email": "ryanvm@gmail.com", "id": 75935, "name": "ryanvm@gmail.com", "real_name": "Ryan VanderMeulen [:RyanVM]"}, {"email": "sledru@mozilla.com", "id": 495955, "name": "sledru@mozilla.com", "real_name": "Sylvestre Ledru [:sylvestre]"}], "cf_last_resolved": "2018-05-08T12:58:32Z", "attachments": [{"creator": "dkeeler@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2018-05-04T20:41:34Z", "type_id": 4, "creation_date": "2018-05-02T23:44:55Z", "id": 1751988, "setter": "ehsan@mozilla.com"}, {"status": "+", "name": "review", "modification_date": "2018-05-03T00:02:29Z", "type_id": 4, "creation_date": "2018-05-02T23:44:55Z", "id": 1751989, "setter": "jjones@mozilla.com"}, {"status": "+", "name": "approval-mozilla-beta", "modification_date": "2018-05-13T19:07:51Z", "type_id": 721, "creation_date": "2018-05-10T19:48:20Z", "id": 1755425, "setter": "ryanvm@gmail.com"}], "content_type": "text/x-review-board-request", "id": 8972737}], "votes": 0, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 14, "comments": [{"text": "(In reply to :Ehsan Akhgari from bug 1450630 comment #14)\n...\n> (In reply to David Keeler [:keeler] (use needinfo) from bug 1450630 comment #13)\n> > I'm confused - DataStorage was written with the intent that it be safe to\n> > access from multiple threads (the documentation even says so at the top of\n> > DataStorage.h). From what I can tell from the code, the static\n> > DataStorage::Get* meta-APIs that operate on the different types of\n> > DataStorage we have are main-thread-only, but are the Get/Set/Remove APIs\n> > that operate on actual data restricted as well? If so, we've strayed from\n> > the original design requirements (e.g. nsSiteSecurityService is\n> > fundamentally broken if we can't access its backing DataStorage off the main\n> > thread).\n> \n> Hmm...  I'm not sure what the API requirements here are, I'm basing my\n> judgement on what the code is actually doing.  All calls to\n> RunOnAllContentParents() require to be on the main thread (in general, our\n> IPC interfaces are not thread safe so if the caller requires thread safety\n> it is its own responsibility to take care of that at layers higher than IPC.)\n> \n> This code is currently called from Put(), Remove() and Clear() so per above\n> I think you're suggesting that this has all been broken since bug 1215723\n> (Firefox 45)?  If yes, then the right fix isn't to fix the Necko consumers,\n> but to rework the fix to bug 1215723 to make it not have a main-thread\n> dependency.  I think doing so is actually relatively easy, all that should\n> be required is to rewrite RunOnAllContentParents() to make it dispatch a\n> runnable to the main thread if we aren't there currently, and make sure its\n> callers capture their closure with a copy rather than by reference.", "author": "dkeeler@mozilla.com", "id": 13250776, "time": "2018-05-02T22:56:42Z"}, {"text": "Created attachment 8972737\nbug 1458720 - make RunOnAllContentParents runnable from any thread\n\nIn bug 1215723 RunOnAllContentParents was added to the DataStorage\nimplementation so we could make more security state information available in\nchild processes. It uses IPC APIs, which in general are not thread-safe. We need\nto make sure that these APIs are only accessed on the main thread, which means\nwe have to copy any necessary data, create a runnable, and send it to the main\nthread to do the actual work. Note that the IPC APIs are async, so this dispatch\ncan be async as well.\n\nReview commit: https://reviewboard.mozilla.org/r/241270/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/241270/", "author": "dkeeler@mozilla.com", "id": 13250881, "time": "2018-05-02T23:44:55Z"}, {"text": "Comment on attachment 8972737\nbug 1458720 - make RunOnAllContentParents runnable from any thread\n\nhttps://reviewboard.mozilla.org/r/241270/#review247146\n\nLooks fine to me. r+ w/ nits addressed.\n\n::: security/manager/ssl/DataStorage.cpp:717\n(Diff revision 1)\n>  template <class Functor>\n>  static\n>  void\n>  RunOnAllContentParents(Functor func)\n>  {\n>    if (!XRE_IsParentProcess()) {\n\nPerhaps we should assert `!NS_IsMainThread()` if possible?\n\n::: security/manager/ssl/DataStorage.cpp:730\n(Diff revision 1)\n> -  ContentParent::GetAll(parents);\n> +    ContentParent::GetAll(parents);\n> -  for (auto& parent: parents) {\n> +    for (auto& parent: parents) {\n> -    func(parent);\n> +      func(parent);\n> -  }\n> +    }\n> +  });\n> +  NS_DispatchToMainThread(r);\n\nProbably should wrap this with `MOZ_ALWAYS_SUCCEEDS(...)` since this is a void function.", "author": "jjones@mozilla.com", "id": 13250910, "time": "2018-05-03T00:02:29Z"}, {"text": "*** Bug 1459304 has been marked as a duplicate of this bug. ***", "author": "ehsan@mozilla.com", "id": 13255560, "time": "2018-05-04T19:29:28Z"}, {"text": "Comment on attachment 8972737\nbug 1458720 - make RunOnAllContentParents runnable from any thread\n\nhttps://reviewboard.mozilla.org/r/241270/#review247146\n\n> Perhaps we should assert `!NS_IsMainThread()` if possible?\n\nI don't think we can assert that here, since we can indeed be off main thread, right?", "author": "ehsan@mozilla.com", "id": 13255700, "time": "2018-05-04T20:38:58Z"}, {"text": "Comment on attachment 8972737\nbug 1458720 - make RunOnAllContentParents runnable from any thread\n\nhttps://reviewboard.mozilla.org/r/241270/#review247672\n\nThanks, looks great!", "author": "ehsan@mozilla.com", "id": 13255709, "time": "2018-05-04T20:41:34Z"}, {"text": "Comment on attachment 8972737\nbug 1458720 - make RunOnAllContentParents runnable from any thread\n\nhttps://reviewboard.mozilla.org/r/241270/#review247146\n\nThanks for the reviews!\n\n> I don't think we can assert that here, since we can indeed be off main thread, right?\n\nRight - we can be either on or off the main thread in these functions.\n\n> Probably should wrap this with `MOZ_ALWAYS_SUCCEEDS(...)` since this is a void function.\n\nOk - sounds good.", "author": "dkeeler@mozilla.com", "id": 13255814, "time": "2018-05-04T21:30:30Z"}, {"text": "Comment on attachment 8972737\nbug 1458720 - make RunOnAllContentParents runnable from any thread\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/241270/diff/1-2/", "author": "dkeeler@mozilla.com", "id": 13255815, "time": "2018-05-04T21:30:49Z"}, {"text": "Pushed by dkeeler@mozilla.com:\nhttps://hg.mozilla.org/integration/autoland/rev/38e60f49b316\nmake RunOnAllContentParents runnable from any thread r=Ehsan,jcj", "author": "pulsebot@bots.tld", "id": 13259925, "time": "2018-05-07T16:37:19Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/38e60f49b316", "author": "aiakab@mozilla.com", "id": 13262263, "time": "2018-05-08T12:58:32Z"}, {"text": "Please request Beta approval on this when you're comfortable doing so.", "author": "ryanvm@gmail.com", "id": 13268198, "time": "2018-05-10T14:10:20Z"}, {"text": "Comment on attachment 8972737\nbug 1458720 - make RunOnAllContentParents runnable from any thread\n\nApproval Request Comment\n[Feature/Bug causing the regression]: bug 1215723\n[User impact if declined]: potential source of crashes\n[Is this code covered by automated tests?]: yes\n[Has the fix been verified in Nightly?]: n/a\n[Needs manual test from QE? If yes, steps to reproduce]: no\n[List of other uplifts needed for the feature/fix]: none\n[Is the change risky?]: not very\n[Why is the change risky/not risky?]: localized, minimal changes, has tests\n[String changes made/needed]: none", "author": "dkeeler@mozilla.com", "id": 13269179, "time": "2018-05-10T19:48:20Z"}, {"text": "Comment on attachment 8972737\nbug 1458720 - make RunOnAllContentParents runnable from any thread\n\nAvoid some possible crashes, approved for 61.0b5.", "author": "ryanvm@gmail.com", "id": 13273149, "time": "2018-05-13T19:07:51Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-beta/rev/47f7391d2bb0", "author": "ryanvm@gmail.com", "id": 13273169, "time": "2018-05-13T19:21:43Z"}], "id": 1458720, "priority": "P1", "cc": ["ehsan@mozilla.com", "jjones@mozilla.com", "ryanvm@gmail.com", "sledru@mozilla.com"], "cf_crash_signature": "", "version": "unspecified", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_thunderbird_esr60": "---", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1452915, 1215723], "qa_contact": "", "creation_time": "2018-05-02T22:56:42Z", "cf_status_firefox_esr52": "wontfix", "component": "Security: PSM", "assigned_to_detail": {"email": "dkeeler@mozilla.com", "id": 349244, "name": "dkeeler@mozilla.com", "real_name": "[:keeler] (use needinfo)"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "fixed", "cf_status_firefox61": "fixed", "cf_status_firefox60": "wontfix", "target_milestone": "mozilla62", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "dkeeler@mozilla.com", "id": 349244, "name": "dkeeler@mozilla.com", "real_name": "[:keeler] (use needinfo)"}, "whiteboard": "[psm-assigned]", "mentors": [], "summary": "fix RunOnAllContentParents (DataStorage) to be runnable from any thread", "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "last_change_time": "2018-05-13T19:21:43Z", "assigned_to": "dkeeler@mozilla.com", "is_open": false, "history": [{"changes": [{"removed": "--", "field_name": "priority", "added": "P1"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "dkeeler@mozilla.com"}, {"removed": "", "field_name": "whiteboard", "added": "[psm-assigned]"}], "who": "dkeeler@mozilla.com", "when": "2018-05-02T22:56:52Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1215723"}, {"removed": "---", "field_name": "cf_status_firefox_esr52", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox_esr60", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox59", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox60", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox61", "added": "affected"}], "who": "dkeeler@mozilla.com", "when": "2018-05-02T23:37:56Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8972737, "added": "review?(ehsan@mozilla.com), review?(jjones@mozilla.com)"}, {"removed": "", "field_name": "cc", "added": "ehsan@mozilla.com, jjones@mozilla.com"}], "who": "dkeeler@mozilla.com", "when": "2018-05-02T23:44:55Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(jjones@mozilla.com)", "attachment_id": 8972737, "added": "review+"}], "who": "jjones@mozilla.com", "when": "2018-05-03T00:02:29Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1452915"}], "who": "dkeeler@mozilla.com", "when": "2018-05-03T19:21:46Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(ehsan@mozilla.com)", "attachment_id": 8972737, "added": "review+"}], "who": "ehsan@mozilla.com", "when": "2018-05-04T20:41:34Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla62"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-05-08 12:58:32"}, {"removed": "---", "field_name": "cf_status_firefox62", "added": "fixed"}], "who": "aiakab@mozilla.com", "when": "2018-05-08T12:58:32Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "sledru@mozilla.com"}, {"removed": "affected", "field_name": "cf_status_firefox_esr52", "added": "wontfix"}, {"removed": "affected", "field_name": "cf_status_firefox_esr60", "added": "wontfix"}, {"removed": "affected", "field_name": "cf_status_firefox59", "added": "wontfix"}, {"removed": "affected", "field_name": "cf_status_firefox60", "added": "wontfix"}], "who": "sledru@mozilla.com", "when": "2018-05-10T12:12:21Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "ryanvm@gmail.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(dkeeler@mozilla.com)"}], "who": "ryanvm@gmail.com", "when": "2018-05-10T14:10:20Z"}, {"changes": [{"removed": "needinfo?(dkeeler@mozilla.com)", "field_name": "flagtypes.name", "added": ""}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8972737, "added": "approval-mozilla-beta?"}], "who": "dkeeler@mozilla.com", "when": "2018-05-10T19:48:20Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "approval-mozilla-beta?", "attachment_id": 8972737, "added": "approval-mozilla-beta+"}], "who": "ryanvm@gmail.com", "when": "2018-05-13T19:07:51Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox61", "added": "fixed"}], "who": "ryanvm@gmail.com", "when": "2018-05-13T19:21:43Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}