{"status": "RESOLVED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "blair@theunfocused.net", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2014-12-04T02:11:09Z", "type_id": 748, "creation_date": "2014-12-01T09:08:46Z", "id": 1045653, "setter": "MattN+bmo@mozilla.com"}, {"status": "+", "name": "feedback", "modification_date": "2014-12-01T22:44:26Z", "type_id": 607, "creation_date": "2014-12-01T09:08:46Z", "id": 1045654, "setter": "agibson@mozilla.com"}, {"status": "+", "name": "approval-mozilla-aurora", "modification_date": "2014-12-19T22:07:44Z", "type_id": 720, "creation_date": "2014-12-19T22:07:44Z", "id": 1059072, "setter": "dolske@mozilla.com"}, {"status": "+", "name": "approval-mozilla-beta", "modification_date": "2014-12-19T22:07:44Z", "type_id": 721, "creation_date": "2014-12-19T22:07:44Z", "id": 1059073, "setter": "dolske@mozilla.com"}], "content_type": "text/plain", "id": 8530807}], "classification": "Client Software", "creator": "dolske@mozilla.com", "cc": ["agibson@mozilla.com", "blair@theunfocused.net", "cbkprice@gmail.com", "dao+bmo@mozilla.com", "MattN+bmo@mozilla.com", "mmucci@mozilla.com", "rjesup@jesup.org"], "depends_on": [1109812], "creation_time": "2014-11-19T21:54:14Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "All", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "Create UITour event framework", "cf_last_resolved": "2014-12-05T12:07:15Z", "assigned_to_detail": {"email": "blair@theunfocused.net", "id": 292667, "name": "blair@theunfocused.net", "real_name": "Blair McBride [:Unfocused] (UNAVAILABLE)"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "assigned_to": "blair@theunfocused.net", "comment_count": 17, "comments": [{"text": "A number of the dependents of bug 1080942 need a new event framework in UITour, to allow parts of Firefox to tell a tour webpage that something happened. Let's use this bug to figure out what that should look like, so it's not spread among those other existing bugs.\n\nThere are basically 3 parts to this:\n\n* Define a content API for tour pages to register and receive events\n* Define a chrome API for Firefox code to easily trigger such events\n* Implement the UITour.jsm / uitour.js code to glue #1 and #2 together\n\nI think it would make sense to base this on something similar to DOM event listeners, especially on the content-exposed side. [But minimally so, no bubbling/capturing/cancelable etc. The intent isn't to exactly clone addEventListener] So, something like:\n\n* addTourListener(eventType, callback)\n\n  e.g. UITour.addTourListener(\"party\", function onParty(event) { ... });\n  where |event| is a JS object with event.type == \"party\" and event.data an\n  arbitrary object supplied from chrome.\n\n* removeTourListener(eventType, callback)\n\n (If we even need it; I'd suspect we don't)\n\n* dispatchTourEvent(eventType, data) [from chrome code]\n  e.g. dispatchTourEvent(\"party\", { likeItIs: 1999 })\n\nThe UITour module would be responsible for routing dispatchTourEvent() calls to any open tour page.\n\nConsider this as starting point for discussion, I'm not beholden to any specifics.", "author": "dolske@mozilla.com", "id": 9613173, "time": "2014-11-19T21:54:14Z"}, {"text": "(In reply to Justin Dolske [:Dolske] from comment #0)\n> I think it would make sense to base this on something similar to DOM event\n> listeners, especially on the content-exposed side. [But minimally so, no\n> bubbling/capturing/cancelable etc. The intent isn't to exactly clone\n> addEventListener] So, something like:\n> \n> * addTourListener(eventType, callback)\n> \n>   e.g. UITour.addTourListener(\"party\", function onParty(event) { ... });\n>   where |event| is a JS object with event.type == \"party\" and event.data an\n>   arbitrary object supplied from chrome.\n> \n> * removeTourListener(eventType, callback)\n> \n>  (If we even need it; I'd suspect we don't)\n\nSomething along these lines sounds good to me, +1", "author": "agibson@mozilla.com", "id": 9616351, "time": "2014-11-20T14:23:54Z"}, {"text": "Created attachment 8530807\nPatch v1\n\nSimplified this quite a bit, to avoid having to track individual listeners.\n\nIn chrome, you can use one of the following to send a notification to Tour pages:\n\n  UITour.notify(\"some-event-happened\");\n  UITour.notify(\"some-event-happened\", \"and this is more info\");\n  UITour.notify(\"some-event-happened\", {data: \"oh my\", moreData: \"beards\"});\n\nThis will send a notification to *all* pages that are using the UITour API. With the usual disclaimer about automatic teardown, and having to use the page visibility API. Such pages will always get a DOM event dispatched to them if UITour.jsm knows about them, and will get events for all notifications - it's up to the JS library to listen to them or not.\n\nIn content, use the JS library like so:\n\n  Mozilla.UITour.observe(function(event, params) {\n    ...\n  });\n\nOr to remove that notification callback:\n\n  Mozilla.UITour.observe(null);\n\nI've also added a \"ping\" action - I needed something like this for testing, and figured it would generally be useful. All it does is make UITour.jsm aware that the page is a Tour page, and fires an event back to the page. Used like:\n\n  Mozilla.UITour.ping(function() { ... });\n\nThis JS library does *not* provide a way to filter notifications, or listen only for specific notifications - it's currently up to the listener to handle that.", "author": "blair@theunfocused.net", "id": 9652532, "time": "2014-12-01T09:08:46Z"}, {"text": "Comment on attachment 8530807\nPatch v1\n\nOverall this looks fine to me - I'm happy to write a generic handleEvent type listener, which can then delegate out to different functions per event. This should do the job nicely.", "author": "agibson@mozilla.com", "id": 9653827, "time": "2014-12-01T22:44:26Z"}, {"text": "Comment on attachment 8530807\nPatch v1\n\nReview of attachment 8530807:\n-----------------------------------------------------------------\n\n::: browser/base/content/content-UITour.js\n@@ +84,4 @@\n>        bubbles: true,\n>        detail: Cu.cloneInto(detail, doc.defaultView)\n>      });\n> +    debugger;\n\nLeftover :P\n\n::: browser/modules/UITour.jsm\n@@ +580,5 @@\n>          }).then(null, Cu.reportError);\n>          break;\n>        }\n> +\n> +      case \"ping\": {\n\nCan you explain more about what ping is for? I think we currently use getConfiguration for something similar.", "author": "MattN+bmo@mozilla.com", "id": 9658390, "time": "2014-12-03T21:45:18Z"}, {"text": "Comment on attachment 8530807\nPatch v1\n\nReview of attachment 8530807:\n-----------------------------------------------------------------\n\n::: browser/modules/test/uitour.js\n@@ +75,5 @@\n> +    var data = {};\n> +    if (callback) {\n> +      data.callbackID = _waitForCallback(callback);\n> +    }\n> +    _sendEvent('ping', data);\n\nNit: double quotes", "author": "MattN+bmo@mozilla.com", "id": 9659156, "time": "2014-12-04T02:11:09Z"}, {"text": "(In reply to Matthew N. [:MattN] from comment #5)\n> Nit: double quotes\n\nHeh, actually, it's the double quotes in that file that are wrong. That file follows the webdev style guide:\nhttp://mozweb.readthedocs.org/en/latest/reference/js-style.html#quotes", "author": "blair@theunfocused.net", "id": 9659237, "time": "2014-12-04T02:54:41Z"}, {"text": "(In reply to Matthew N. [:MattN] from comment #4)\n> Can you explain more about what ping is for? I think we currently use\n> getConfiguration for something similar.\n\nDiscussed this over Vidyo: Basically, yes, that. But specifically for that case, and without doing any work.\n\nThough, I forgot to mention that I think it will become more important with bug 941428.", "author": "blair@theunfocused.net", "id": 9659252, "time": "2014-12-04T03:00:41Z"}, {"text": "(In reply to Blair McBride [:Unfocused] from comment #6)\n> (In reply to Matthew N. [:MattN] from comment #5)\n> > Nit: double quotes\n> \n> Heh, actually, it's the double quotes in that file that are wrong. That file\n> follows the webdev style guide:\n> http://mozweb.readthedocs.org/en/latest/reference/js-style.html#quotes\n\nThat style guide also commands 4-space indents, for instance, which is different from both our common style and what's being done in this very file. Now, I'm actually asking you to use 4-space indents. I'd rather question the usefulness of trying to follow a style guide that was written down from external people who are working on a different code base.", "author": "dao+bmo@mozilla.com", "id": 9660505, "time": "2014-12-04T17:32:24Z"}, {"text": "Comment on attachment 8530807\nPatch v1\n\nReview of attachment 8530807:\n-----------------------------------------------------------------\n\n::: browser/modules/UITour.jsm\n@@ +1554,5 @@\n> +    while (winEnum.hasMoreElements()) {\n> +      let window = winEnum.getNext();\n> +      if (window.closed)\n> +        continue;\n> +debugger;\n\nLeftover `debugger` here too", "author": "MattN+bmo@mozilla.com", "id": 9660971, "time": "2014-12-04T19:16:53Z"}, {"text": "https://hg.mozilla.org/integration/fx-team/rev/6c84bbab2848", "author": "blair@theunfocused.net", "id": 9662446, "time": "2014-12-05T01:53:29Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/6c84bbab2848", "author": "cbook@mozilla.com", "id": 9663343, "time": "2014-12-05T12:07:15Z"}, {"text": "One thing I'm not 100% clear on is how the Chrome will know *when* to send an event. For example, a web page might need to know the status of the FTE tour when the page loads, but also when tab visibility changes etc (we need to hide info panels and other things when the tab is not visible).\n\nI can't test this just yet as the first notifications have not yet landed in Nightly, but I wondered if things like this can be handled already (or if they are even in scope).", "author": "agibson@mozilla.com", "id": 9668699, "time": "2014-12-08T16:13:55Z"}, {"text": "The notifications to the page only get sent when they happen. Querying status for anything is outside the scope of this bug - this is just for the framework to send arbitrary notifications.\n\nFor the ability to query the status of anything, we'd need a new bug to hook it up - it'd be using the getConfiguration API we already have.\n\nAs far as the current context of Loop-related things goes, we could add a way to query whether a room is currently open. But I don't think it makes sense for any of the other current Loop UITour event bugs, as they're all stateless events.", "author": "blair@theunfocused.net", "id": 9670321, "time": "2014-12-08T21:50:48Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-aurora/rev/b102e8229c7d", "author": "rjesup@jesup.org", "id": 9717255, "time": "2014-12-19T21:46:27Z"}, {"text": "Comment on attachment 8530807\nPatch v1\n\n[Triage Comment]\n\nNeeded for Fx35 Hello tour, all code is tour-specific.", "author": "dolske@mozilla.com", "id": 9717350, "time": "2014-12-19T22:07:44Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-beta/rev/166360180776", "author": "MattN+bmo@mozilla.com", "id": 9723052, "time": "2014-12-22T17:04:21Z"}], "id": 1101825, "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "unspecified", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2014-12-22T17:04:21Z", "cf_platform_rel": "---", "product": "Firefox", "cf_status_firefox_esr52": "---", "blocks": [1080942], "qa_contact": "", "see_also": [], "cf_fx_iteration": "37.1", "component": "General", "votes": 0, "groups": [], "cf_status_firefox60": "---", "target_milestone": "Firefox 37", "is_cc_accessible": true, "url": "", "creator_detail": {"email": "dolske@mozilla.com", "id": 27780, "name": "dolske@mozilla.com", "real_name": "Justin Dolske [:Dolske]"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "agibson@mozilla.com", "id": 468279, "name": "agibson@mozilla.com", "real_name": "Alex Gibson [:agibson]"}, {"email": "blair@theunfocused.net", "id": 292667, "name": "blair@theunfocused.net", "real_name": "Blair McBride [:Unfocused] (UNAVAILABLE)"}, {"email": "cbkprice@gmail.com", "id": 516261, "name": "cbkprice@gmail.com", "real_name": "Cory Price [:ckprice] (bugmail disabled, NI me!)"}, {"email": "dao+bmo@mozilla.com", "id": 219124, "name": "dao+bmo@mozilla.com", "real_name": "D\u00e3o Gottwald [::dao]"}, {"email": "MattN+bmo@mozilla.com", "id": 305228, "name": "MattN+bmo@mozilla.com", "real_name": "Matthew N. [:MattN] (PM if requests are blocking you)"}, {"email": "mmucci@mozilla.com", "id": 458208, "name": "mmucci@mozilla.com", "real_name": "Marco Mucci [:MarcoM]"}, {"email": "rjesup@jesup.org", "id": 11539, "name": "rjesup@jesup.org", "real_name": "Randell Jesup [:jesup]"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [{"status": "+", "name": "firefox-backlog", "modification_date": "2014-11-25T10:22:34Z", "type_id": 846, "creation_date": "2014-11-25T10:22:34Z", "id": 1042119, "setter": "blair@theunfocused.net"}, {"status": "-", "name": "qe-verify", "modification_date": "2014-11-25T10:22:34Z", "type_id": 864, "creation_date": "2014-11-25T10:22:34Z", "id": 1042120, "setter": "blair@theunfocused.net"}], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "resolution": "FIXED", "op_sys": "All", "cf_fx_points": "5", "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "agibson@mozilla.com"}], "who": "dolske@mozilla.com", "when": "2014-11-19T22:31:40Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "dao@mozilla.com"}], "who": "dao+bmo@mozilla.com", "when": "2014-11-20T18:28:51Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "ASSIGNED"}, {"removed": "---", "field_name": "cf_fx_points", "added": "5"}, {"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "bmcbride@mozilla.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "firefox-backlog+, qe-verify-"}], "who": "blair@theunfocused.net", "when": "2014-11-25T10:22:34Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "mmucci@mozilla.com"}], "who": "mmucci@mozilla.com", "when": "2014-11-25T11:42:52Z"}, {"changes": [{"removed": "---", "field_name": "cf_fx_iteration", "added": "37.1"}], "who": "mmucci@mozilla.com", "when": "2014-11-25T11:57:41Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "cprice@mozilla.com"}], "who": "cbkprice@gmail.com", "when": "2014-11-28T17:11:09Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8530807, "added": "review?(MattN+bmo@mozilla.com), feedback?(agibson@mozilla.com)"}], "who": "blair@theunfocused.net", "when": "2014-12-01T09:08:46Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "feedback?(agibson@mozilla.com)", "attachment_id": 8530807, "added": "feedback+"}], "who": "agibson@mozilla.com", "when": "2014-12-01T22:44:26Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(MattN+bmo@mozilla.com)", "attachment_id": 8530807, "added": "review+"}], "who": "MattN+bmo@mozilla.com", "when": "2014-12-04T02:11:09Z"}, {"changes": [{"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "Firefox 37"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2014-12-05 04:07:15"}], "who": "cbook@mozilla.com", "when": "2014-12-05T12:07:15Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1109812"}], "who": "jaws@mozilla.com", "when": "2014-12-10T19:36:15Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "rjesup@jesup.org"}, {"removed": "---", "field_name": "cf_status_firefox35", "added": "affected"}, {"removed": "---", "field_name": "cf_status_firefox36", "added": "fixed"}, {"removed": "---", "field_name": "cf_status_firefox37", "added": "fixed"}], "who": "rjesup@jesup.org", "when": "2014-12-19T22:05:18Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8530807, "added": "approval-mozilla-aurora+, approval-mozilla-beta+"}], "who": "dolske@mozilla.com", "when": "2014-12-19T22:07:44Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox35", "added": "fixed"}], "who": "MattN+bmo@mozilla.com", "when": "2014-12-22T17:04:21Z"}]}