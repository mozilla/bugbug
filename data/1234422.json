{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "masayuki@d-toybox.com", "mentors_detail": [], "depends_on": [1237582, 1255627], "cf_has_str": "---", "cf_user_story": "", "cf_status_firefox_esr45": "fixed", "cf_tracking_firefox_relnote": "---", "platform": "x86", "keywords": ["inputmethod", "regression"], "component": "Widget: Win32", "summary": "[TSF] Google Japanese Input sometimes fails to update its candidate window at converting the composition string", "cf_last_resolved": "2015-12-30T11:07:53Z", "attachments": [{"creator": "masayuki@d-toybox.com", "is_obsolete": 1, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2015-12-29T03:12:57Z", "type_id": 4, "creation_date": "2015-12-24T09:41:34Z", "id": 1313401, "setter": "m_kato@ga2.so-net.ne.jp"}], "content_type": "text/plain", "id": 8701785}, {"creator": "masayuki@d-toybox.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2015-12-29T16:06:52Z", "type_id": 4, "creation_date": "2015-12-29T16:06:52Z", "id": 1314530, "setter": "masayuki@d-toybox.com"}, {"status": "+", "name": "approval-mozilla-aurora", "modification_date": "2016-01-06T23:32:03Z", "type_id": 720, "creation_date": "2016-01-06T06:21:23Z", "id": 1317615, "setter": "rkothari@mozilla.com"}, {"status": "+", "name": "approval-mozilla-beta", "modification_date": "2016-01-06T23:32:03Z", "type_id": 721, "creation_date": "2016-01-06T06:21:23Z", "id": 1317616, "setter": "rkothari@mozilla.com"}], "content_type": "text/plain", "id": 8702602}, {"creator": "masayuki@d-toybox.com", "is_obsolete": 0, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8704908}], "votes": 0, "cf_status_firefox42": "unaffected", "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_status_firefox45": "fixed", "cf_has_regression_range": "---", "comment_count": 24, "comments": [{"text": "As far as I tested, this is a regression of bug 1204519. In bug 1204519, we removed TS_E_NOLAYOUT hack for Google Japanese Input. Then, we met this \"hidden\" bug, perhaps in TSFTextStore.\n\nSTR:\n1. Type \"\u3070\u30fc\u3058\u3087\u3093\" in the search bar\n2. Press spacebar * n\n\nER:\nThe composition string in the searchbar should be modified and proper item in the candidate window of Google Japanese Input should be highlighted.\n\nAR:\nThe composition string in the searchbar is modified but sometimes not modified in the candidate window.\n\n\n[Tracking Requested - why for this release]:\n\nI see some tweets which claim that this is very inconvenient and they want to change their default browser. I'm still investigating the cause of this bug, but even if the fix becomes risky, we should back out the patches of bug 1204519 from the branches.", "author": "masayuki@d-toybox.com", "id": 11023725, "time": "2015-12-22T02:10:40Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=2af5bc8ac120", "author": "masayuki@d-toybox.com", "id": 11024293, "time": "2015-12-22T09:21:02Z"}, {"text": "Created attachment 8701785\nTSFTextStore should retry to notify TSF/TIP of layout change if synchronous calls of OnLayoutChange() don't cause retrieving layout information\n\nI'm still investigating and testing this issue, though.\n\nGoogle Japanese Input does or can not retrieve new layout information after returning TS_E_NOLAYOUT error from GetTextExt() even though we call ITextStoreACPSink::OnLayoutChange() and ITfContextOwnerServices::OnLayoutChange(). If we retry to call them after ITextStoreACP::RequestLock() completely, we can avoid this issue. So, let's use PostMessage() for flushing the pending layout change notification only when it's not handled correctly by TIP at synchronous calls.\n\nBefore landing this patch, I'll investigate and test this patch more tomorrow.", "author": "masayuki@d-toybox.com", "id": 11029904, "time": "2015-12-24T09:41:34Z"}, {"text": "When I tested with the patch, the call stacks of TSFTextStore::RequestLock() at synchronous calls of OnLayoutChange() are:\n\nITextStoreACPSink::OnLayoutChange():\n\n> #01: mozilla::widget::TSFTextStore::NotifyTSFOfLayoutChange (a:\\mozilla\\mc-b\\src\\widget\\windows\\tsftextstore.cpp:4823)\n> #02: mozilla::widget::TSFTextStore::MaybeFlushPendingNotifications (a:\\mozilla\\mc-b\\src\\widget\\windows\\tsftextstore.cpp:1912)\n> #03: mozilla::widget::TSFTextStore::RequestLock (a:\\mozilla\\mc-b\\src\\widget\\windows\\tsftextstore.cpp:1632)\n> #04: CtfImeProcessCicHotkey[MSCTF +0x2e2ef]\n> #05: CtfImeProcessCicHotkey[MSCTF +0x2663a]\n> #06: CtfImeProcessCicHotkey[MSCTF +0x274f1]\n> #07: DllRegisterServer[GoogleIMEJaTIP64 +0x12475]\n> #08: DllRegisterServer[GoogleIMEJaTIP64 +0xd77a]\n> #09: DllRegisterServer[GoogleIMEJaTIP64 +0x4263]\n> #10: TF_GetInitSystemFlags[MSCTF +0x6ccff]\n> #11: TF_GetInitSystemFlags[MSCTF +0x6d0f9]\n> #12: CtfImeInquire[MSCTF +0x53d84]\n> #13: TF_GetInitSystemFlags[MSCTF +0x6cbed]\n> #14: mozilla::widget::TSFTextStore::ProcessRawKeyMessage (a:\\mozilla\\mc-b\\src\\widget\\windows\\tsftextstore.cpp:5495)\n> #15: nsAppShell::ProcessNextNativeEvent (a:\\mozilla\\mc-b\\src\\widget\\windows\\nsappshell.cpp:367)\n> #16: nsBaseAppShell::DoProcessNextNativeEvent (a:\\mozilla\\mc-b\\src\\widget\\nsbaseappshell.cpp:139)\n> #17: nsBaseAppShell::OnProcessNextEvent (a:\\mozilla\\mc-b\\src\\widget\\nsbaseappshell.cpp:289)\n> #18: nsThread::ProcessNextEvent (a:\\mozilla\\mc-b\\src\\xpcom\\threads\\nsthread.cpp:961)\n> #19: NS_ProcessNextEvent (a:\\mozilla\\mc-b\\src\\xpcom\\glue\\nsthreadutils.cpp:297)\n> #20: mozilla::ipc::MessagePump::Run (a:\\mozilla\\mc-b\\src\\ipc\\glue\\messagepump.cpp:128)\n> #21: MessageLoop::RunHandler (a:\\mozilla\\mc-b\\src\\ipc\\chromium\\src\\base\\message_loop.cc:228)\n> #22: MessageLoop::Run (a:\\mozilla\\mc-b\\src\\ipc\\chromium\\src\\base\\message_loop.cc:202)\n> #23: nsBaseAppShell::Run (a:\\mozilla\\mc-b\\src\\widget\\nsbaseappshell.cpp:158)\n> #24: nsAppShell::Run (a:\\mozilla\\mc-b\\src\\widget\\windows\\nsappshell.cpp:259)\n> #25: nsAppStartup::Run (a:\\mozilla\\mc-b\\src\\toolkit\\components\\startup\\nsappstartup.cpp:282)\n> #26: XREMain::XRE_mainRun (a:\\mozilla\\mc-b\\src\\toolkit\\xre\\nsapprunner.cpp:4285)\n> #27: XREMain::XRE_main (a:\\mozilla\\mc-b\\src\\toolkit\\xre\\nsapprunner.cpp:4382)\n> #28: XRE_main (a:\\mozilla\\mc-b\\src\\toolkit\\xre\\nsapprunner.cpp:4484)\n> #29: do_main (a:\\mozilla\\mc-b\\src\\browser\\app\\nsbrowserapp.cpp:212)\n> #30: NS_internal_main (a:\\mozilla\\mc-b\\src\\browser\\app\\nsbrowserapp.cpp:352)\n> #31: wmain (a:\\mozilla\\mc-b\\src\\toolkit\\xre\\nswindowswmain.cpp:138)\n> #32: __tmainCRTStartup (f:\\dd\\vctools\\crt\\crtw32\\startup\\crt0.c:255)\n> #33: BaseThreadInitThunk[KERNEL32 +0x18102]\n> #34: RtlUserThreadStart[ntdll +0x5c2e4]\n\nITfContextOwnerServices::OnLayoutChange():\n\n> #01: CtfImeProcessCicHotkey[MSCTF +0x27a54]\n> #02: mozilla::widget::TSFTextStore::NotifyTSFOfLayoutChange (a:\\mozilla\\mc-b\\src\\widget\\windows\\tsftextstore.cpp:4839)\n> #03: mozilla::widget::TSFTextStore::MaybeFlushPendingNotifications (a:\\mozilla\\mc-b\\src\\widget\\windows\\tsftextstore.cpp:1912)\n> #04: mozilla::widget::TSFTextStore::RequestLock (a:\\mozilla\\mc-b\\src\\widget\\windows\\tsftextstore.cpp:1632)\n> #05: CtfImeProcessCicHotkey[MSCTF +0x2e2ef]\n> #06: CtfImeProcessCicHotkey[MSCTF +0x2663a]\n> #07: CtfImeProcessCicHotkey[MSCTF +0x274f1]\n> #08: DllRegisterServer[GoogleIMEJaTIP64 +0x12475]\n> #09: DllRegisterServer[GoogleIMEJaTIP64 +0xd77a]\n> #10: DllRegisterServer[GoogleIMEJaTIP64 +0x4263]\n> #11: TF_GetInitSystemFlags[MSCTF +0x6ccff]\n> #12: TF_GetInitSystemFlags[MSCTF +0x6d0f9]\n> #13: CtfImeInquire[MSCTF +0x53d84]\n> #14: TF_GetInitSystemFlags[MSCTF +0x6cbed]\n> #15: mozilla::widget::TSFTextStore::ProcessRawKeyMessage (a:\\mozilla\\mc-b\\src\\widget\\windows\\tsftextstore.cpp:5495)\n> #16: nsAppShell::ProcessNextNativeEvent (a:\\mozilla\\mc-b\\src\\widget\\windows\\nsappshell.cpp:367)\n> #17: nsBaseAppShell::DoProcessNextNativeEvent (a:\\mozilla\\mc-b\\src\\widget\\nsbaseappshell.cpp:139)\n> #18: nsBaseAppShell::OnProcessNextEvent (a:\\mozilla\\mc-b\\src\\widget\\nsbaseappshell.cpp:289)\n> #19: nsThread::ProcessNextEvent (a:\\mozilla\\mc-b\\src\\xpcom\\threads\\nsthread.cpp:961)\n> #20: NS_ProcessNextEvent (a:\\mozilla\\mc-b\\src\\xpcom\\glue\\nsthreadutils.cpp:297)\n> #21: mozilla::ipc::MessagePump::Run (a:\\mozilla\\mc-b\\src\\ipc\\glue\\messagepump.cpp:128)\n> #22: MessageLoop::RunHandler (a:\\mozilla\\mc-b\\src\\ipc\\chromium\\src\\base\\message_loop.cc:228)\n> #23: MessageLoop::Run (a:\\mozilla\\mc-b\\src\\ipc\\chromium\\src\\base\\message_loop.cc:202)\n> #24: nsBaseAppShell::Run (a:\\mozilla\\mc-b\\src\\widget\\nsbaseappshell.cpp:158)\n> #25: nsAppShell::Run (a:\\mozilla\\mc-b\\src\\widget\\windows\\nsappshell.cpp:259)\n> #26: nsAppStartup::Run (a:\\mozilla\\mc-b\\src\\toolkit\\components\\startup\\nsappstartup.cpp:282)\n> #27: XREMain::XRE_mainRun (a:\\mozilla\\mc-b\\src\\toolkit\\xre\\nsapprunner.cpp:4285)\n> #28: XREMain::XRE_main (a:\\mozilla\\mc-b\\src\\toolkit\\xre\\nsapprunner.cpp:4382)\n> #29: XRE_main (a:\\mozilla\\mc-b\\src\\toolkit\\xre\\nsapprunner.cpp:4484)\n> #30: do_main (a:\\mozilla\\mc-b\\src\\browser\\app\\nsbrowserapp.cpp:212)\n> #31: NS_internal_main (a:\\mozilla\\mc-b\\src\\browser\\app\\nsbrowserapp.cpp:352)\n> #32: wmain (a:\\mozilla\\mc-b\\src\\toolkit\\xre\\nswindowswmain.cpp:138)\n> #33: __tmainCRTStartup (f:\\dd\\vctools\\crt\\crtw32\\startup\\crt0.c:255)\n> #34: BaseThreadInitThunk[KERNEL32 +0x18102]\n> #35: RtlUserThreadStart[ntdll +0x5c2e4]\n\nDuring both cases, no methods of TSFTextStore are not called.\n\nLog:\n\n> 0[19269c0e800]: IMECO: 0x1920012f0d0 IMEContentObserver::IMENotificationSender::SendPositionChange(), sending NOTIFY_IME_OF_POSITION_CHANGE...\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::OnLayoutChangeInternal(), calling NotifyTSFOfLayoutChange()...\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::NotifyTSFOfLayoutChange(), calling ITextStoreACPSink::OnLayoutChange()...\n> 0[19269c0e800]: TSF: 0x19200264300 TSFTextStore::RequestLock(dwLockFlags=TS_LF_READ, phrSession=0x10425fdab0), mLock=TS_LF_READWRITE, mDestroyed=false\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::RequestLock() didn't allow to lock, *phrSession=TS_E_SYNCHRONOUS\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::NotifyTSFOfLayoutChange(), called ITextStoreACPSink::OnLayoutChange()\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::NotifyTSFOfLayoutChange(), calling ITfContextOwnerServices::OnLayoutChange()...\n> 0[19269c0e800]: TSF: 0x19200264300 TSFTextStore::RequestLock(dwLockFlags=TS_LF_READ, phrSession=0x10425fda80), mLock=TS_LF_READWRITE, mDestroyed=false\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::RequestLock() didn't allow to lock, *phrSession=TS_E_SYNCHRONOUS\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::NotifyTSFOfLayoutChange(), called ITfContextOwnerServices::OnLayoutChange()\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::OnLayoutChangeInternal(), calling MaybeFlushPendingNotifications()...\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::MaybeFlushPendingNotifications(), putting off flushing pending notifications due to being the document locked...\n> 0[19269c0e800]: IMECO: 0x1920012f0d0 IMEContentObserver::IMENotificationSender::SendPositionChange(), sent NOTIFY_IME_OF_POSITION_CHANGE\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::MaybeFlushPendingNotifications(), mLockedContent is cleared\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::MaybeFlushPendingNotifications(), calling TSFTextStore::NotifyTSFOfLayoutChange()...\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::NotifyTSFOfLayoutChange(), calling ITextStoreACPSink::OnLayoutChange()...\n> 0[19269c0e800]: TSF: 0x19200264300 TSFTextStore::RequestLock(dwLockFlags=TS_LF_READ, phrSession=0x10425fe930), mLock=not-specified, mDestroyed=false\n> 0[19269c0e800]: TSF: 0x19200264300   Locking (TS_LF_READ) >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\n> 0[19269c0e800]: TSF: 0x19200264300   Unlocked (TS_LF_READ) <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::RequestLock() succeeded: *phrSession=S_OK\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::NotifyTSFOfLayoutChange(), called ITextStoreACPSink::OnLayoutChange()\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::NotifyTSFOfLayoutChange(), calling ITfContextOwnerServices::OnLayoutChange()...\n> 0[19269c0e800]: TSF: 0x19200264300 TSFTextStore::RequestLock(dwLockFlags=TS_LF_READ, phrSession=0x10425fe900), mLock=not-specified, mDestroyed=false\n> 0[19269c0e800]: TSF: 0x19200264300   Locking (TS_LF_READ) >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\n> 0[19269c0e800]: TSF: 0x19200264300   Unlocked (TS_LF_READ) <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::RequestLock() succeeded: *phrSession=S_OK\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::NotifyTSFOfLayoutChange(), called ITfContextOwnerServices::OnLayoutChange()\n> 0[19269c0e800]: TSF: 0x19200264300   TSFTextStore::RequestLock() succeeded: *phrSession=S_OK", "author": "masayuki@d-toybox.com", "id": 11029935, "time": "2015-12-24T09:59:28Z"}, {"text": "Oh, I realized that MS-IME and ATOK 2015 on Windows 10, we won't return TS_E_NOLAYOUT with same STR... So, I'm not sure how they work immediately after OnLayoutChange()s after TS_E_NOLAYOUT. I'll check this tomorrow with other environments.", "author": "masayuki@d-toybox.com", "id": 11029959, "time": "2015-12-24T10:13:33Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=e965ee1692a3", "author": "masayuki@d-toybox.com", "id": 11030754, "time": "2015-12-25T05:28:43Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=16b9dbb38c3b", "author": "masayuki@d-toybox.com", "id": 11030932, "time": "2015-12-25T10:08:41Z"}, {"text": "As far as I've tested, looks like this is a bug of TSF.\n\nCurrently, in non-e10s mode, we call OnLayoutChange() before unlocking the document lock which caused composition string change. With this behavior, TSF tries to read-lock, but of course it's failed due to still locking the document.\n\nIf we call OnLayoucChange() after unlocking the document but from RequestLock(), TSF tries to read-lock the document but does nothing or just retrieve selection range. According to the log and stack-trace at these calls of RequestLock(), the layout change notification is also not reached to TIP.\n\nFinally, like the patch, we call OnLayoutChange() completely after (from outside) RequestLock(), TIP can take some actions.\n\nIn conclusion, I believe that this is a mistake of the design of TSF or just a bug of TSF. From TIP's view point, OnLayoutChange() isn't available if the layout change is caused by a change of composition string. OnLayoutChange() is available only when the layout change occurs without a call of RequestLock().\n\n\nKato-san, could you review the patch? The patch renames mPendingOnLayoutChange to mHasReturned_TS_E_NOLAYOUT. The new name represents its meaning clearer. When mHasReturned_TS_E_NOLAYOUT is true, calls of OnLayoutChange() should cause calling GetTextExt() or GetACPFromPoint() because TSF/TIP should retrieve the newest layout information. I.e., in this time, we expect some calls of them. Therefore, the patch checks if they are called with mWaitingQueryLayout. If mWaitingQueryLayout is false at the end of OnLayoutChangeInternal(), we should post our internal message for trying to notify TIP of layout change later.", "author": "masayuki@d-toybox.com", "id": 11031298, "time": "2015-12-26T02:31:23Z"}, {"text": "FYI: The reason why this bug won't be reproduced with other TIPs is, other TIPs try to retrieve the latest layout information after a call of RequestLock(), i.e., they try it by themselves, don't depend on calls of OnLayoutChange().", "author": "masayuki@d-toybox.com", "id": 11031300, "time": "2015-12-26T02:34:54Z"}, {"text": "Comment on attachment 8701785\nTSFTextStore should retry to notify TSF/TIP of layout change if synchronous calls of OnLayoutChange() don't cause retrieving layout information\n\nReview of attachment 8701785:\n-----------------------------------------------------------------\n\nsorry for delay\n\n::: widget/windows/TSFTextStore.h\n@@ +830,5 @@\n>    bool                         mPendingOnSelectionChange;\n>    // If GetTextExt() or GetACPFromPoint() is called and the layout hasn't been\n> +  // calculated yet, these methods return TS_E_NOLAYOUT.  At that time,\n> +  // mHasReturned_TS_E_NOLAYOUT is set to true.\n> +  bool                         mHasReturned_TS_E_NOLAYOUT;\n\nI think that CamelCase such as mHasReturnedNoLayout is better than mHasReturned_TS_EN_NOLAYOUT.", "author": "m_kato@ga2.so-net.ne.jp", "id": 11034242, "time": "2015-12-29T03:12:57Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/9104abe421a8311a199fdb3be7a60b3ab73a83b5\nBug 1234422 TSFTextStore should retry to notify TSF/TIP of layout change if synchronous calls of OnLayoutChange() don't cause retrieving layout information r=m_kato", "author": "masayuki@d-toybox.com", "id": 11035215, "time": "2015-12-29T16:05:57Z"}, {"text": "Created attachment 8702602\nTSFTextStore should retry to notify TSF/TIP of layout change if synchronous calls of OnLayoutChange() don't cause retrieving layout information (r=m_kato)", "author": "masayuki@d-toybox.com", "id": 11035218, "time": "2015-12-29T16:06:52Z"}, {"text": "I wonder, it might be better to call PeekMessage() immediately after a call of sKeystrokeMgr->KeyDown(). Then, we could make Google Japanese Input update its UI (pseudo) synchronously. I'll try to check this.\n# With current patch, Google Japanese Input sometimes doesn't show candidate window if the process is busy.", "author": "masayuki@d-toybox.com", "id": 11035245, "time": "2015-12-29T16:23:31Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/9104abe421a8", "author": "cbook@mozilla.com", "id": 11036808, "time": "2015-12-30T11:07:53Z"}, {"text": "Tracked for 44 bcuz of negative impact to Japanese users. I hope we can either backout fixes or land a proper fix soon as we are already halfway through Beta44 cycle.", "author": "rkothari@mozilla.com", "id": 11039705, "time": "2015-12-31T21:07:28Z"}, {"text": "Just like Ritu said!", "author": "sledru@mozilla.com", "id": 11042710, "time": "2016-01-04T12:59:08Z"}, {"text": "Comment on attachment 8702602\nTSFTextStore should retry to notify TSF/TIP of layout change if synchronous calls of OnLayoutChange() don't cause retrieving layout information (r=m_kato)\n\nApproval Request Comment\n[Feature/regressing bug #]: bug 1204519\n[User impact if declined]: Looks like some keyboard events to convert composition string isn't handled quickly due to not updating UI of Google Japanese Input. (and mismatches composition string on Gecko and selected word in the UI of Google Japanese Input)\n[Describe test coverage new/current, TreeHerder]: Landed on m-c a week ago.\n[Risks and why]: Very low because the hack works only when IME doesn't try to retrieve layout information as expected. And even if the hack works unexpectedly, IME just retries to refresh its UI.\n[String/UUID change made/needed]: Nothing.", "author": "masayuki@d-toybox.com", "id": 11049966, "time": "2016-01-06T06:21:23Z"}, {"text": "(In reply to Masayuki Nakano [:masayuki] (Mozilla Japan) (offline until 1/6) from comment #12)\n> I wonder, it might be better to call PeekMessage() immediately after a call\n> of sKeystrokeMgr->KeyDown(). Then, we could make Google Japanese Input\n> update its UI (pseudo) synchronously. I'll try to check this.\n> # With current patch, Google Japanese Input sometimes doesn't show candidate\n> window if the process is busy.\n\nI've tried to test with latest Nightly builds. However, I don't meet such situation. I guess in most cases, we don't need additional hack. If we need it, we should do it in another bug.", "author": "masayuki@d-toybox.com", "id": 11049969, "time": "2016-01-06T06:23:08Z"}, {"text": "Comment on attachment 8702602\nTSFTextStore should retry to notify TSF/TIP of layout change if synchronous calls of OnLayoutChange() don't cause retrieving layout information (r=m_kato)\n\nTaking this because of the significant negative impact this has on Japanese IME users. beta44+, aurora45+", "author": "rkothari@mozilla.com", "id": 11052712, "time": "2016-01-06T23:32:03Z"}, {"text": "Created attachment 8704908\nThe patch for beta\n\nOops, I forgot to attach the patch for Beta. Please use this to fix this bug on Beta. (Other change in TSFTextStore::GetACPFromPoint() causes failing to apply the patch for m-c/Aurora)\n\nApproval Request Comment\nSee above.", "author": "masayuki@d-toybox.com", "id": 11052957, "time": "2016-01-07T00:57:37Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-beta/rev/36699ba4cc35", "author": "kwierso@gmail.com", "id": 11052995, "time": "2016-01-07T01:05:26Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-aurora/rev/78e4e8d10469", "author": "kwierso@gmail.com", "id": 11052999, "time": "2016-01-07T01:05:56Z"}, {"text": "Comment on attachment 8704908\nThe patch for beta\n\nThank you for landing, this is now not necessary.", "author": "masayuki@d-toybox.com", "id": 11053057, "time": "2016-01-07T01:34:41Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-b2g44_v2_5/rev/36699ba4cc35", "author": "cbook@mozilla.com", "id": 11053981, "time": "2016-01-07T11:09:14Z"}], "id": 1234422, "priority": "--", "cc": ["m_kato@ga2.so-net.ne.jp", "rkothari@mozilla.com", "sledru@mozilla.com", "VYV03354@nifty.ne.jp", "yukawa@google.com"], "cf_crash_signature": "", "version": "Trunk", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_firefox46": "+", "cf_tracking_firefox44": "+", "cf_tracking_firefox45": "+", "cf_rank": null, "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1204519], "qa_contact": "", "creation_time": "2015-12-22T02:10:40Z", "cf_status_firefox46": "fixed", "cf_status_firefox_esr52": "---", "cf_tracking_firefox_esr45": "-", "assigned_to_detail": {"email": "masayuki@d-toybox.com", "id": 34283, "name": "masayuki@d-toybox.com", "real_name": "Masayuki Nakano [:masayuki] (JST, +0900)"}, "cf_tracking_firefox_esr60": "---", "alias": null, "cf_status_firefox62": "---", "cf_status_firefox_esr60": "---", "cf_status_firefox60": "---", "cf_status_firefox43": "wontfix", "cf_status_firefox_esr38": "unaffected", "target_milestone": "mozilla46", "cf_status_firefox44": "fixed", "is_cc_accessible": true, "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "masayuki@d-toybox.com", "id": 34283, "name": "masayuki@d-toybox.com", "real_name": "Masayuki Nakano [:masayuki] (JST, +0900)"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "m_kato@ga2.so-net.ne.jp", "id": 8636, "name": "m_kato@ga2.so-net.ne.jp", "real_name": "Makoto Kato [:m_kato]"}, {"email": "rkothari@mozilla.com", "id": 538805, "name": "rkothari@mozilla.com", "real_name": "Ritu Kothari (:ritu)"}, {"email": "sledru@mozilla.com", "id": 495955, "name": "sledru@mozilla.com", "real_name": "Sylvestre Ledru [:sylvestre]"}, {"email": "VYV03354@nifty.ne.jp", "id": 5842, "name": "VYV03354@nifty.ne.jp", "real_name": "Masatoshi Kimura [:emk]"}, {"email": "yukawa@google.com", "id": 442715, "name": "yukawa@google.com", "real_name": "Yohei Yukawa"}], "cf_status_firefox61": "---", "cf_status_b2g_2_5": "fixed", "dupe_of": null, "flags": [], "last_change_time": "2016-04-18T13:28:56Z", "assigned_to": "masayuki@d-toybox.com", "is_open": false, "cf_tracking_thunderbird_esr60": "---", "history": [{"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8701785, "added": "review?(m_kato@ga2.so-net.ne.jp)"}], "who": "masayuki@d-toybox.com", "when": "2015-12-24T09:41:34Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(m_kato@ga2.so-net.ne.jp)", "attachment_id": 8701785, "added": "review+"}], "who": "m_kato@ga2.so-net.ne.jp", "when": "2015-12-29T03:12:57Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8701785, "added": "1"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8702602, "added": "review+"}], "who": "masayuki@d-toybox.com", "when": "2015-12-29T16:06:52Z"}, {"changes": [{"removed": "ASSIGNED", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla46"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2015-12-30 03:07:53"}, {"removed": "affected", "field_name": "cf_status_firefox46", "added": "fixed"}], "who": "cbook@mozilla.com", "when": "2015-12-30T11:07:53Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "rkothari@mozilla.com"}, {"removed": "?", "field_name": "cf_tracking_firefox44", "added": "+"}], "who": "rkothari@mozilla.com", "when": "2015-12-31T21:07:28Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "sledru@mozilla.com"}, {"removed": "?", "field_name": "cf_tracking_firefox45", "added": "+"}, {"removed": "?", "field_name": "cf_tracking_firefox46", "added": "+"}], "who": "sledru@mozilla.com", "when": "2016-01-04T12:59:08Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8702602, "added": "approval-mozilla-aurora?, approval-mozilla-beta?"}], "who": "masayuki@d-toybox.com", "when": "2016-01-06T06:21:23Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "approval-mozilla-aurora?, approval-mozilla-beta?", "attachment_id": 8702602, "added": "approval-mozilla-aurora+, approval-mozilla-beta+"}], "who": "rkothari@mozilla.com", "when": "2016-01-06T23:32:03Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8704908, "added": "approval-mozilla-beta?"}], "who": "masayuki@d-toybox.com", "when": "2016-01-07T00:57:37Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox44", "added": "fixed"}], "who": "kwierso@gmail.com", "when": "2016-01-07T01:05:26Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox45", "added": "fixed"}], "who": "kwierso@gmail.com", "when": "2016-01-07T01:05:56Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "approval-mozilla-beta?", "attachment_id": 8704908, "added": ""}], "who": "masayuki@d-toybox.com", "when": "2016-01-07T01:34:41Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox_esr45", "added": "fixed"}], "who": "masayuki@d-toybox.com", "when": "2016-01-07T01:35:23Z"}, {"changes": [{"removed": "---", "field_name": "cf_status_b2g_2_5", "added": "fixed"}], "who": "cbook@mozilla.com", "when": "2016-01-07T11:09:14Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1237582"}], "who": "Fanolian+bugzilla@gmail.com", "when": "2016-01-07T12:21:24Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1255627"}], "who": "madperson@gmx.at", "when": "2016-03-10T23:19:32Z"}, {"changes": [{"removed": "?", "field_name": "cf_tracking_firefox_esr45", "added": "-"}], "who": "sledru@mozilla.com", "when": "2016-04-18T13:28:56Z"}], "resolution": "FIXED", "op_sys": "Windows 8", "cf_fx_points": "---", "cf_blocking_fennec": "---"}