{"cf_status_firefox38": "fixed", "cf_tracking_thunderbird_esr52": "---", "cf_tracking_firefox60": "---", "attachments": [{"creator": "bbouvier@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "feedback", "modification_date": "2015-02-17T10:22:23Z", "type_id": 607, "creation_date": "2015-02-16T20:08:48Z", "id": 1101146, "setter": "jdemooij@mozilla.com"}], "content_type": "text/plain", "id": 8565131}, {"creator": "bbouvier@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2015-02-17T16:15:49Z", "type_id": 4, "creation_date": "2015-02-17T15:34:46Z", "id": 1101553, "setter": "jcoppeard@mozilla.com"}, {"status": "+", "name": "review", "modification_date": "2015-02-18T16:47:01Z", "type_id": 4, "creation_date": "2015-02-17T15:34:46Z", "id": 1101554, "setter": "jdemooij@mozilla.com"}], "content_type": "text/plain", "id": 8565445}], "classification": "Components", "creator": "bbouvier@mozilla.com", "cc": ["bbouvier@mozilla.com", "jcoppeard@mozilla.com", "jdemooij@mozilla.com", "nicolas.b.pierron@mozilla.com"], "depends_on": [], "creation_time": "2015-02-16T20:00:52Z", "cf_status_firefox37": "---", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "x86_64", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "SIMD: Factor template objects within a compartment", "id": 1133565, "assigned_to_detail": {"email": "bbouvier@mozilla.com", "id": 468907, "name": "bbouvier@mozilla.com", "real_name": "Benjamin Bouvier [:bbouvier]"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "assigned_to": "bbouvier@mozilla.com", "comment_count": 9, "comments": [{"text": "Each time Baseline sees a SIMD call site, it will create a template object of the right kind.  This is inefficient, as each SIMD operation has its own call site.  We can spare some memory by factoring the template objects.", "author": "bbouvier@mozilla.com", "id": 9924309, "time": "2015-02-16T20:00:52Z"}, {"text": "Created attachment 8565131\nsimd-templates.patch\n\nHow does this look? Sorry if I am misusing any function here, I'm fairly new to all this compartment world...\n\nI've looked on the SIMD mandelbrot demo, it prevents creation from ~10 template objects.  All these objects are inlined, so not sure it's a big win, we might want to look at real world SIMD kernels compiled from Emscripten.", "author": "bbouvier@mozilla.com", "id": 9924323, "time": "2015-02-16T20:08:48Z"}, {"text": "Comment on attachment 8565131\nsimd-templates.patch\n\nReview of attachment 8565131:\n-----------------------------------------------------------------\n\nNice!\n\n::: js/src/builtin/TypedObject.h\n@@ +333,5 @@\n>      enum Type {\n>          TYPE_INT32 = JS_SIMDTYPEREPR_INT32,\n>          TYPE_FLOAT32 = JS_SIMDTYPEREPR_FLOAT32,\n> +        TYPE_FLOAT64 = JS_SIMDTYPEREPR_FLOAT64,\n> +        LAST_TYPE\n\nThis name is a bit confusing; I think it'd be clearer as LAST_TYPE = TYPE_FLOAT64 and then use +1 when you use it. Or call it NUM_TYPES.\n\n::: js/src/jit/JitCompartment.h\n@@ +433,5 @@\n>      JitCode *stringConcatStub_;\n>      JitCode *regExpExecStub_;\n>      JitCode *regExpTestStub_;\n>  \n> +    JSObject *simdTemplateObjects_[SimdTypeDescr::LAST_TYPE];\n\nUse mozilla::Array so that we get bounds checks automatically.\n\n@@ +442,5 @@\n>  \n>    public:\n> +    JSObject *getSimdTemplateObjectFor(JSContext *cx, Handle<SimdTypeDescr*> descr) {\n> +        MOZ_ASSERT(descr->type() < SimdTypeDescr::LAST_TYPE);\n> +        JSObject **tpl = &simdTemplateObjects_[descr->type()];\n\nI think the array should use ReadBarrieredObject instead of JSObject*, this is necessary for incremental GC. I thought we had to access these pointers during Ion compilation, but we don't so it should be fine.", "author": "jdemooij@mozilla.com", "id": 9925713, "time": "2015-02-17T10:22:23Z"}, {"text": "Created attachment 8565445\nFactor SIMD templates within a compartment", "author": "bbouvier@mozilla.com", "id": 9926453, "time": "2015-02-17T15:34:46Z"}, {"text": "Comment on attachment 8565445\nFactor SIMD templates within a compartment\n\nReview of attachment 8565445:\n-----------------------------------------------------------------\n\nLooks good!", "author": "jcoppeard@mozilla.com", "id": 9926611, "time": "2015-02-17T16:15:49Z"}, {"text": "Comment on attachment 8565445\nFactor SIMD templates within a compartment\n\nReview of attachment 8565445:\n-----------------------------------------------------------------\n\nnit: Remove the comment from MSimdBox::congruentTo.", "author": "nicolas.b.pierron@mozilla.com", "id": 9926653, "time": "2015-02-17T16:22:52Z"}, {"text": "Comment on attachment 8565445\nFactor SIMD templates within a compartment\n\nReview of attachment 8565445:\n-----------------------------------------------------------------\n\nBeautiful.", "author": "jdemooij@mozilla.com", "id": 9931480, "time": "2015-02-18T16:47:01Z"}, {"text": "Thanks! and with the comment removed:\n\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/04a909655b92", "author": "bbouvier@mozilla.com", "id": 9935173, "time": "2015-02-19T12:17:29Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/04a909655b92", "author": "ryanvm@gmail.com", "id": 9938405, "time": "2015-02-20T00:01:46Z"}], "cf_last_resolved": "2015-02-20T00:01:46Z", "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "Trunk", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2015-02-20T00:01:46Z", "cf_platform_rel": "---", "product": "Core", "cf_status_firefox_esr52": "---", "blocks": [1064540], "qa_contact": "", "see_also": [], "cf_fx_iteration": "---", "component": "JavaScript Engine: JIT", "votes": 0, "groups": [], "cf_status_firefox60": "---", "target_milestone": "mozilla38", "is_cc_accessible": true, "status": "RESOLVED", "cf_status_thunderbird_esr52": "---", "url": "", "creator_detail": {"email": "bbouvier@mozilla.com", "id": 468907, "name": "bbouvier@mozilla.com", "real_name": "Benjamin Bouvier [:bbouvier]"}, "whiteboard": "", "mentors": [], "cc_detail": [{"email": "bbouvier@mozilla.com", "id": 468907, "name": "bbouvier@mozilla.com", "real_name": "Benjamin Bouvier [:bbouvier]"}, {"email": "jcoppeard@mozilla.com", "id": 443194, "name": "jcoppeard@mozilla.com", "real_name": "Jon Coppeard (:jonco) (PTO until 13th March)"}, {"email": "jdemooij@mozilla.com", "id": 375297, "name": "jdemooij@mozilla.com", "real_name": "Jan de Mooij [:jandem] (PTO Mar 8)"}, {"email": "nicolas.b.pierron@mozilla.com", "id": 422187, "name": "nicolas.b.pierron@mozilla.com", "real_name": "Nicolas B. Pierron [:nbp] {backlog: ~36}"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "jdemooij@mozilla.com"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8565131, "added": "feedback?(jdemooij@mozilla.com)"}], "who": "bbouvier@mozilla.com", "when": "2015-02-16T20:08:48Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "feedback?(jdemooij@mozilla.com)", "attachment_id": 8565131, "added": "feedback+"}], "who": "jdemooij@mozilla.com", "when": "2015-02-17T10:22:23Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8565445, "added": "review?(jcoppeard@mozilla.com), review?(jdemooij@mozilla.com)"}, {"removed": "", "field_name": "cc", "added": "jcoppeard@mozilla.com"}], "who": "bbouvier@mozilla.com", "when": "2015-02-17T15:34:46Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(jcoppeard@mozilla.com)", "attachment_id": 8565445, "added": "review+"}], "who": "jcoppeard@mozilla.com", "when": "2015-02-17T16:15:49Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(jdemooij@mozilla.com)", "attachment_id": 8565445, "added": "review+"}], "who": "jdemooij@mozilla.com", "when": "2015-02-18T16:47:01Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla38"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2015-02-19 16:01:46"}, {"removed": "---", "field_name": "cf_status_firefox38", "added": "fixed"}], "who": "ryanvm@gmail.com", "when": "2015-02-20T00:01:46Z"}], "resolution": "FIXED", "op_sys": "Linux", "cf_fx_points": "---", "cf_blocking_fennec": "---"}