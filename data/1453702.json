{"cf_tracking_thunderbird_esr52": "---", "status": "RESOLVED", "cf_tracking_firefox60": "---", "cf_tracking_firefox61": "---", "cf_tracking_firefox62": "---", "creator": "jkratzer@mozilla.com", "mentors_detail": [], "depends_on": [1469076, 1454471], "cf_status_firefox_esr60": "---", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "Unspecified", "cf_status_firefox59": "unaffected", "keywords": ["assertion", "testcase"], "cc_detail": [{"email": "emilio@crisal.io", "id": 546716, "name": "emilio@crisal.io", "real_name": "Emilio Cobos \u00c1lvarez [:emilio]"}, {"email": "fuzzing@mozilla.com", "id": 469204, "name": "fuzzing@mozilla.com", "real_name": "Fuzzing Team"}, {"email": "mats@mozilla.com", "id": 5168, "name": "mats@mozilla.com", "real_name": "Mats Palmgren (:mats)"}, {"email": "xidorn+moz@upsuper.org", "id": 373403, "name": "xidorn+moz@upsuper.org", "real_name": "Xidorn Quan [:xidorn] UTC+10"}], "cf_last_resolved": "2018-04-16T22:01:36Z", "attachments": [{"creator": "jkratzer@mozilla.com", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/html", "id": 8967408}, {"creator": "emilio@crisal.io", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/html", "id": 8967969}, {"creator": "emilio@crisal.io", "is_obsolete": 1, "is_patch": 0, "flags": [{"status": "+", "name": "review", "modification_date": "2018-04-16T00:31:53Z", "type_id": 4, "creation_date": "2018-04-14T20:08:10Z", "id": 1744095, "setter": "mats@mozilla.com"}, {"status": "+", "name": "review", "modification_date": "2018-04-16T00:16:21Z", "type_id": 4, "creation_date": "2018-04-15T22:54:50Z", "id": 1744213, "setter": "xidorn+moz@upsuper.org"}], "content_type": "text/x-review-board-request", "id": 8967987}, {"creator": "emilio@crisal.io", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/x-review-board-request", "id": 8968087}], "votes": 0, "classification": "Components", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "comment_count": 29, "comments": [{"text": "Created attachment 8967408\ntrigger.html\n\nTestcase found while fuzzing mozilla-central rev f6c3a0a19d82.\n\nrax = 0x0000000000000000   rdx = 0x0000000000000000\nrcx = 0x00007fe47271d2dd   rbx = 0x0000000000000000\nrsi = 0x00007fe4729ec770   rdi = 0x00007fe4729eb540\nrbp = 0x00007fff1744e690   rsp = 0x00007fff1744e670\nr8 = 0x00007fe4729ec770    r9 = 0x00007fe473ab6740\nr10 = 0x0000000000000039   r11 = 0x0000000000000000\nr12 = 0x0000000000000001   r13 = 0x0000000000000000\nr14 = 0x00007fe4518ae200   r15 = 0x00007fe4518c54c0\nrip = 0x00007fe462a305b1\nOS|Linux|0.0.0 Linux 4.4.0-119-generic #143-Ubuntu SMP Mon Apr 2 16:08:24 UTC 2018 x86_64\nCPU|amd64|family 6 model 78 stepping 3|1\nGPU|||\nCrash|SIGSEGV|0x0|0\n0|0|libxul.so|nsCSSFrameConstructor::CheckBitsForLazyFrameConstruction|hg:hg.mozilla.org/mozilla-central:layout/base/nsCSSFrameConstructor.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|6839|0x18\n0|1|libxul.so|nsCSSFrameConstructor::MaybeConstructLazily|hg:hg.mozilla.org/mozilla-central:layout/base/nsCSSFrameConstructor.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|6912|0xb\n0|2|libxul.so|nsCSSFrameConstructor::ContentAppended|hg:hg.mozilla.org/mozilla-central:layout/base/nsCSSFrameConstructor.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|7117|0x11\n0|3|libxul.so|mozilla::PresShell::ContentAppended|hg:hg.mozilla.org/mozilla-central:layout/base/PresShell.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|4480|0x11\n0|4|libxul.so|nsNodeUtils::ContentAppended|hg:hg.mozilla.org/mozilla-central:dom/base/nsNodeUtils.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|192|0xc\n0|5|libxul.so|nsINode::doInsertChildAt|hg:hg.mozilla.org/mozilla-central:dom/base/nsINode.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|1367|0x8\n0|6|libxul.so|nsINode::ReplaceOrInsertBefore|hg:hg.mozilla.org/mozilla-central:dom/base/nsINode.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|2257|0x1b\n0|7|libxul.so|mozilla::dom::NodeBinding::appendChild|hg:hg.mozilla.org/mozilla-central:dom/base/nsINode.h:f6c3a0a19d82db25750d8badccd5cf37e79d028e|1821|0x12\n0|8|libxul.so|mozilla::dom::binding_detail::GenericMethod<mozilla::dom::binding_detail::NormalThisPolicy, mozilla::dom::binding_detail::ThrowExceptions>|hg:hg.mozilla.org/mozilla-central:dom/bindings/BindingUtils.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|3191|0x9\n0|9|libxul.so|js::CallJSNative|hg:hg.mozilla.org/mozilla-central:js/src/vm/JSContext-inl.h:f6c3a0a19d82db25750d8badccd5cf37e79d028e|290|0x6\n0|10|libxul.so|js::InternalCallOrConstruct|hg:hg.mozilla.org/mozilla-central:js/src/vm/Interpreter.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|467|0xf\n0|11|libxul.so|InternalCall|hg:hg.mozilla.org/mozilla-central:js/src/vm/Interpreter.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|516|0xd\n0|12|libxul.so|Interpret|hg:hg.mozilla.org/mozilla-central:js/src/vm/Interpreter.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|522|0xf\n0|13|libxul.so|js::RunScript|hg:hg.mozilla.org/mozilla-central:js/src/vm/Interpreter.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|417|0xb\n0|14|libxul.so|js::InternalCallOrConstruct|hg:hg.mozilla.org/mozilla-central:js/src/vm/Interpreter.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|489|0xf\n0|15|libxul.so|InternalCall|hg:hg.mozilla.org/mozilla-central:js/src/vm/Interpreter.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|516|0xd\n0|16|libxul.so|js::Call|hg:hg.mozilla.org/mozilla-central:js/src/vm/Interpreter.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|535|0x5\n0|17|libxul.so|JS::Call|hg:hg.mozilla.org/mozilla-central:js/src/jsapi.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|3003|0x20\n0|18|libxul.so|mozilla::dom::EventListener::HandleEvent|s3:gecko-generated-sources:ccbadb8791154c00d5d9f3f34300a418cdfa4b3b0b60424e60394883162a95118b3edbfce81cbc7a5b48193d5a2618fc449143e250bd5c61dd1340709a3af189/dom/bindings/EventListenerBinding.cpp:|51|0x5\n0|19|libxul.so|mozilla::dom::EventListener::HandleEvent<mozilla::dom::EventTarget*>|s3:gecko-generated-sources:0502cca494d7ae0441ada14535523caade9340fdd09934cf6d31cc421267c319ae3d6f5b43b2730d0b36ae1c87480f3b426c5fa4fec57d51047d83a51acde602/dist/include/mozilla/dom/EventListenerBinding.h:|66|0x1c\n0|20|libxul.so|mozilla::EventListenerManager::HandleEventSubType|hg:hg.mozilla.org/mozilla-central:dom/events/EventListenerManager.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|1120|0x36\n0|21|libxul.so|mozilla::EventListenerManager::HandleEventInternal|hg:hg.mozilla.org/mozilla-central:dom/events/EventListenerManager.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|1292|0x19\n0|22|libxul.so|mozilla::EventTargetChainItem::HandleEvent|hg:hg.mozilla.org/mozilla-central:dom/events/EventListenerManager.h:f6c3a0a19d82db25750d8badccd5cf37e79d028e|378|0xa\n0|23|libxul.so|mozilla::EventTargetChainItem::HandleEventTargetChain|hg:hg.mozilla.org/mozilla-central:dom/events/EventDispatcher.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|527|0xf\n0|24|libxul.so|mozilla::EventDispatcher::Dispatch|hg:hg.mozilla.org/mozilla-central:dom/events/EventDispatcher.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|934|0xb\n0|25|libxul.so|mozilla::EventDispatcher::DispatchDOMEvent|hg:hg.mozilla.org/mozilla-central:dom/events/EventDispatcher.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|1016|0x19\n0|26|libxul.so|nsINode::DispatchEvent|hg:hg.mozilla.org/mozilla-central:dom/base/nsINode.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|1084|0x5\n0|27|libxul.so|nsContentUtils::DispatchEvent|hg:hg.mozilla.org/mozilla-central:dom/base/nsContentUtils.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|4480|0x28\n0|28|libxul.so|nsContentUtils::DispatchTrustedEvent|hg:hg.mozilla.org/mozilla-central:dom/base/nsContentUtils.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|4449|0xf\n0|29|libxul.so|nsIDocument::DispatchContentLoadedEvents|hg:hg.mozilla.org/mozilla-central:dom/base/nsDocument.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|5221|0x5\n0|30|libxul.so|mozilla::detail::RunnableMethodImpl<nsIDocument*, void (nsIDocument::*)(), true, (mozilla::RunnableKind)0u>::Run|hg:hg.mozilla.org/mozilla-central:xpcom/threads/nsThreadUtils.h:f6c3a0a19d82db25750d8badccd5cf37e79d028e|1164|0x13\n0|31|libxul.so|mozilla::SchedulerGroup::Runnable::Run|hg:hg.mozilla.org/mozilla-central:xpcom/threads/SchedulerGroup.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|337|0x15\n0|32|libxul.so|nsThread::ProcessNextEvent|hg:hg.mozilla.org/mozilla-central:xpcom/threads/nsThread.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|1096|0x15\n0|33|libxul.so|NS_ProcessNextEvent|hg:hg.mozilla.org/mozilla-central:xpcom/threads/nsThreadUtils.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|519|0x11\n0|34|libxul.so|mozilla::ipc::MessagePump::Run|hg:hg.mozilla.org/mozilla-central:ipc/glue/MessagePump.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|97|0xa\n0|35|libxul.so|MessageLoop::RunInternal|hg:hg.mozilla.org/mozilla-central:ipc/chromium/src/base/message_loop.cc:f6c3a0a19d82db25750d8badccd5cf37e79d028e|326|0x17\n0|36|libxul.so|MessageLoop::Run|hg:hg.mozilla.org/mozilla-central:ipc/chromium/src/base/message_loop.cc:f6c3a0a19d82db25750d8badccd5cf37e79d028e|319|0x8\n0|37|libxul.so|nsBaseAppShell::Run|hg:hg.mozilla.org/mozilla-central:widget/nsBaseAppShell.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|157|0xd\n0|38|libxul.so|XRE_RunAppShell|hg:hg.mozilla.org/mozilla-central:toolkit/xre/nsEmbedFunctions.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|893|0x11\n0|39|libxul.so|mozilla::ipc::MessagePumpForChildProcess::Run|hg:hg.mozilla.org/mozilla-central:ipc/glue/MessagePump.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|269|0x5\n0|40|libxul.so|MessageLoop::RunInternal|hg:hg.mozilla.org/mozilla-central:ipc/chromium/src/base/message_loop.cc:f6c3a0a19d82db25750d8badccd5cf37e79d028e|326|0x17\n0|41|libxul.so|MessageLoop::Run|hg:hg.mozilla.org/mozilla-central:ipc/chromium/src/base/message_loop.cc:f6c3a0a19d82db25750d8badccd5cf37e79d028e|319|0x8\n0|42|libxul.so|XRE_InitChildProcess|hg:hg.mozilla.org/mozilla-central:toolkit/xre/nsEmbedFunctions.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|719|0x8\n0|43|firefox|content_process_main|hg:hg.mozilla.org/mozilla-central:ipc/contentproc/plugin-container.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|50|0x14\n0|44|firefox|main|hg:hg.mozilla.org/mozilla-central:browser/app/nsBrowserApp.cpp:f6c3a0a19d82db25750d8badccd5cf37e79d028e|280|0x11\n0|45|libc-2.23.so||||0x20830", "author": "jkratzer@mozilla.com", "id": 13201204, "time": "2018-04-12T15:44:52Z"}, {"text": "Created attachment 8967969\nTestcase that shows wrong behavior.\n\n\"Foo\" shouldn't be seen per spec.\n\nThis happens because <textarea> is one of those elements which behaves at display: none when they have display: contents.\n\nWe get confused because we think it's display: contents when computing an insertion point, and show it instead.\n\nI propose changing this to compute as display none instead, which is what other browser engines do, and simplifies a lot of other stuff.", "author": "emilio@crisal.io", "id": 13205902, "time": "2018-04-14T15:53:51Z"}, {"text": "This is a regression from bug 1303605.", "author": "emilio@crisal.io", "id": 13205906, "time": "2018-04-14T15:56:27Z"}, {"text": "Created attachment 8967987\nBug 1453702: [css-display] Move unboxing to style, and handle display: contents before other suppressions.\n\nThis also adopts the resolution of [1] while at it, and switches XUL to not\nsupport display: contents until a use case appears.\n\nThis makes our behavior consistent both with the spec and also in terms of\nhandling dynamic changes to stuff that would otherwise get suppressed.\n\nAlso makes us consistent with both Blink and WebKit in terms of computed style.\nWe were the only ones respecting \"behaves as display: none\" without actually\ncomputing to display: none. Will file a spec issue to get that changed.\n\nIt also makes us match Blink and WebKit in terms of respecting display: contents\nbefore other suppressions, see the reftest which I didn't write as a WPT\n(because there's no spec supporting neither that or the opposite of what we do),\nwhere a <g> element respects display contents even though if it had any other\nkind of display value we'd suppress the frame for it and all the descendants\nsince it's an SVG element in a non-SVG subtree.\n\nAlso, this removes the page-break bit from the display: contents loop, which I\nthink is harmless.\n\nAs long as the tests under style are based in namespace id / node name /\ntraversal parent, this should not make style sharing go wrong in any way, since\nthat's the first style sharing check we do at [2].\n\nThe general idea under this change is making all nodes with computed style of\ndisplay: contents actually honor it. Otherwise there's no way of making the\nsetup sound except re-introducing something similar to all the state tracking\nremoved in bug 1303605.\n\n[1]: https://github.com/w3c/csswg-drafts/issues/2167\n[2]: https://searchfox.org/mozilla-central/rev/fca4426325624fecbd493c31389721513fc49fef/servo/components/style/sharing/mod.rs#700\n\nReview commit: https://reviewboard.mozilla.org/r/236674/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/236674/", "author": "emilio@crisal.io", "id": 13206032, "time": "2018-04-14T20:08:10Z"}, {"text": "https://treeherder.mozilla.org/#/jobs?repo=try&revision=ce313b09d83188fcbd6fc7a323c2c305bc23936f\n\n(Ignore the reftest failure, since I forgot to include the test file in that try push. I promise it passes :P)", "author": "emilio@crisal.io", "id": 13206033, "time": "2018-04-14T20:09:32Z"}, {"text": "Comment on attachment 8967987\nBug 1453702: [css-display] Move unboxing to style, and handle display: contents before other suppressions.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/236674/diff/1-2/", "author": "emilio@crisal.io", "id": 13206041, "time": "2018-04-14T20:24:27Z"}, {"text": "Comment on attachment 8967987\nBug 1453702: [css-display] Move unboxing to style, and handle display: contents before other suppressions.\n\nhttps://reviewboard.mozilla.org/r/236674/#review242470\n\nr- because this patch breaks the following testcase:\n\n<details>\n  <div style=\"display:contents; color:blue\">\n    <summary>summary</summary>\n    details\n  </div>\n</details>\n\n::: commit-message-7aad6:1\n(Diff revision 2)\n> +Bug 1453702: [css-display] Move unboxing to style, and handle display: contents before other suppresions. r?mats\n> +\n\ntypo: s/suppresions/suppressions/\n\n::: commit-message-7aad6:9\n(Diff revision 2)\n> +support display: contents until a use case appears.\n> +\n> +This makes our behavior consistent both with the spec and also in terms of\n> +handling dynamic changes to stuff that would otherwise get suppressed.\n> +\n> +Also makes us consistent with both Blink and WebKit in terms of computed style.\n\nnit: as far as I know, Blink and WebKit share the same style system and layout code for the most part.  I think \"Blink and WebKit\" implies that they should be thought of as separate independent UAs.  I disagree; I think they should be viewed as one CSS implementation (and count as one UA in that respect), so I think \"Blink/WebKit\" is a better term here.\n\n::: commit-message-7aad6:16\n(Diff revision 2)\n> +computing to display: none. Will file a spec issue to get that changed.\n> +\n> +It also makes us match Blink and WebKit in terms of respecting display: contents\n> +before other suppressions, see the reftest which I didn't write as a WPT\n> +(because there's no spec supporting neither that or the opposite of what we do),\n> +where a <g> element respects display contents even though if it had any other\n\nnit: s/display contents/display: contents/", "author": "mats@mozilla.com", "id": 13206829, "time": "2018-04-15T17:01:34Z"}, {"text": "You should get someone else to also review the Rust bits.", "author": "mats@mozilla.com", "id": 13206832, "time": "2018-04-15T17:06:46Z"}, {"text": "(In reply to Mats Palmgren (:mats) from comment #6)\n> Comment on attachment 8967987\n> Bug 1453702: [css-display] Move unboxing to style, and handle display:\n> contents before other suppresions.\n> \n> https://reviewboard.mozilla.org/r/236674/#review242470\n> \n> r- because this patch breaks the following testcase:\n> \n> <details>\n>   <div style=\"display:contents; color:blue\">\n>     <summary>summary</summary>\n>     details\n>   </div>\n> </details>\n\nGreat catch, will amend it :)\n\n> ::: commit-message-7aad6:9\n> (Diff revision 2)\n> > +support display: contents until a use case appears.\n> > +\n> > +This makes our behavior consistent both with the spec and also in terms of\n> > +handling dynamic changes to stuff that would otherwise get suppressed.\n> > +\n> > +Also makes us consistent with both Blink and WebKit in terms of computed style.\n> \n> nit: as far as I know, Blink and WebKit share the same style system and\n> layout code for the most part.  I think \"Blink and WebKit\" implies that they\n> should be thought of as separate independent UAs.  I disagree; I think they\n> should be viewed as one CSS implementation (and count as one UA in that\n> respect), so I think \"Blink/WebKit\" is a better term here.\n\nWell, the display: contents code and style code at least has changed a bit for sure. But sure, can reword that if you want.", "author": "emilio@crisal.io", "id": 13206906, "time": "2018-04-15T21:15:46Z"}, {"text": "Created attachment 8968087\nBug 1453702: Get rid of SetAsUndisplayedContent.\n\nReview commit: https://reviewboard.mozilla.org/r/236760/diff/#index_header\nSee other reviews: https://reviewboard.mozilla.org/r/236760/", "author": "emilio@crisal.io", "id": 13206953, "time": "2018-04-15T22:54:50Z"}, {"text": "Comment on attachment 8967987\nBug 1453702: [css-display] Move unboxing to style, and handle display: contents before other suppressions.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/236674/diff/2-3/", "author": "emilio@crisal.io", "id": 13206954, "time": "2018-04-15T22:54:50Z"}, {"text": "Xidorn, could you review the Rust bits? Thanks!", "author": "emilio@crisal.io", "id": 13206956, "time": "2018-04-15T22:58:38Z"}, {"text": "Comment on attachment 8967987\nBug 1453702: [css-display] Move unboxing to style, and handle display: contents before other suppressions.\n\nhttps://reviewboard.mozilla.org/r/236674/#review242486\n\nI only had a look at the Rust bits and the new wpts, and they look good to me with the following nits addressed:\n\n::: servo/components/style/dom.rs:440\n(Diff revision 3)\n>      fn is_html_element(&self) -> bool;\n>  \n> +    /// Return whether this element is an element in the MathML namespace.\n> +    fn is_mathml_element(&self) -> bool;\n> +\n> +    /// Return whether this element is an element in the MathML namespace.\n\n\"in the **SVG** namespace\".\n\n::: servo/components/style/dom.rs:443\n(Diff revision 3)\n> +    fn is_mathml_element(&self) -> bool;\n> +\n> +    /// Return whether this element is an element in the MathML namespace.\n> +    fn is_svg_element(&self) -> bool;\n> +\n> +    /// Return whether this element is an element in the MathML namespace.\n\n\"in the **XUL** namespace\".\n\n::: servo/components/style/style_adjuster.rs:456\n(Diff revision 3)\n> +            // https://drafts.csswg.org/css-display/#unbox-svg\n> +            lazy_static! {\n> +                static ref SPECIAL_SVG_ELEMENTS: [Atom; 6] = [\n> +                    atom!(\"svg\"), atom!(\"a\"), atom!(\"g\"), atom!(\"use\"),\n> +                    atom!(\"tspan\"), atom!(\"textPath\"),\n> +                ];\n> +            }\n> +\n> +            let local_name = element.local_name();\n> +            if !SPECIAL_SVG_ELEMENTS.iter().any(|name| &**name == local_name) {\n> +                self.style.mutate_box().set_display(Display::None);\n> +            }\n> +            return;\n\nThis doesn't seem to exactly match what the spec says. The spec mentions that \"unknown elements\" should be handled like these special SVG elements.\n\nMaybe add a comment here mentioning that is enough for now.", "author": "xidorn+moz@upsuper.org", "id": 13206982, "time": "2018-04-16T00:16:21Z"}, {"text": "Comment on attachment 8967987\nBug 1453702: [css-display] Move unboxing to style, and handle display: contents before other suppressions.\n\nhttps://reviewboard.mozilla.org/r/236674/#review242484\n\nr=mats with those issues addressed\n\n::: commit-message-7aad6:9\n(Diff revision 3)\n> +support display: contents until a use case appears.\n> +\n> +This makes our behavior consistent both with the spec and also in terms of\n> +handling dynamic changes to stuff that would otherwise get suppressed.\n> +\n> +Also makes us consistent with both Blink and WebKit in terms of computed style.\n\nYes, please :-) I'd prefer \"Blink/WebKit\" instead of \"Blink and WebKit\" (two places)\n\n::: layout/base/nsCSSFrameConstructor.cpp:5555\n(Diff revision 3)\n> +// Whether we should suppress frames for a children under a <select> frame.\n> +//\n\ntypo: s/a children/a child/\n\n::: layout/base/nsCSSFrameConstructor.cpp:5561\n(Diff revision 3)\n> +ShouldSuppressFrameInSelect(const nsIContent& aParent,\n> +                            const nsIContent& aChild)\n\nI'd prefer we use \"const nsIContent*\" for now, for code style consistency.\n(Also, it's not clear to me if T& or NotNull<T*> is the preferred style\nwe should adopt if we decide to move away from nsIContent*)\n\n::: layout/base/nsCSSFrameConstructor.cpp:5582\n(Diff revision 3)\n> +  if (aChild.IsHTMLElement(nsGkAtoms::optgroup) &&\n> +      aChild.IsHTMLElement(nsGkAtoms::select)) {\n\nLooks like a copy-paste error.\nThe original code was:\n        (\\!aContent->IsHTMLElement(nsGkAtoms::optgroup) ||\n         \\!parent->IsHTMLElement(nsGkAtoms::select)) &&\nso I think you want to replace the 2nd aChild with aParent.\nPlease add a testcase that would have caught this.", "author": "mats@mozilla.com", "id": 13206990, "time": "2018-04-16T00:31:53Z"}, {"text": "Comment on attachment 8968087\nBug 1453702: Get rid of SetAsUndisplayedContent.\n\nhttps://reviewboard.mozilla.org/r/236760/#review242488\n\n::: commit-message-47216:1\n(Diff revision 1)\n> +Bug 1453702: Cleanup SetAsUndisplayedContent. r?mats\n> +\n\nPlease amend the commit message with something that explains the change rather than just \"cleanup\" (which make it sound as if the patch is idempotent, which it isn't for DEBUG builds).  I'm guessing the aComputedStyle->GetPseudo() check is redundant since all generated content is presumed to have a pseudo?\n\n::: layout/base/nsCSSFrameConstructor.cpp\n(Diff revision 1)\n> -    if (aIsGeneratedContent) {\n> +  if (aIsGeneratedContent) {\n> -      aContent->UnbindFromTree();\n> +    aContent->UnbindFromTree();\n> -    }\n> +  }\n> -    return;\n> -  }\n> -  MOZ_ASSERT(!aIsGeneratedContent, \"Should have had pseudo type\");\n\nHmm, don't we want to keep this assertion somewhere?  I'm pretty sure it was added because we have/had code (other than just this place) that depended on this invariant.  Is that not true anymore?", "author": "mats@mozilla.com", "id": 13206991, "time": "2018-04-16T00:34:29Z"}, {"text": "(In reply to Mats Palmgren (:mats) from comment #13)\n> Comment on attachment 8967987\n> Bug 1453702: [css-display] Move unboxing to style, and handle display:\n> contents before other suppressions.\n> \n> https://reviewboard.mozilla.org/r/236674/#review242484\n> \n> r=mats with those issues addressed\n> \n> ::: commit-message-7aad6:9\n> (Diff revision 3)\n> > +support display: contents until a use case appears.\n> > +\n> > +This makes our behavior consistent both with the spec and also in terms of\n> > +handling dynamic changes to stuff that would otherwise get suppressed.\n> > +\n> > +Also makes us consistent with both Blink and WebKit in terms of computed style.\n> \n> Yes, please :-) I'd prefer \"Blink/WebKit\" instead of \"Blink and WebKit\" (two\n> places)\n> \n> ::: layout/base/nsCSSFrameConstructor.cpp:5555\n> (Diff revision 3)\n> > +// Whether we should suppress frames for a children under a <select> frame.\n> > +//\n> \n> typo: s/a children/a child/\n> \n> ::: layout/base/nsCSSFrameConstructor.cpp:5561\n> (Diff revision 3)\n> > +ShouldSuppressFrameInSelect(const nsIContent& aParent,\n> > +                            const nsIContent& aChild)\n> \n> I'd prefer we use \"const nsIContent*\" for now, for code style consistency.\n> (Also, it's not clear to me if T& or NotNull<T*> is the preferred style\n> we should adopt if we decide to move away from nsIContent*)\n\nMost new DOM and editor code uses Element& / nsIContent& / etc, so I think it's not a big issue to adopt that too.\n\n> ::: layout/base/nsCSSFrameConstructor.cpp:5582\n> (Diff revision 3)\n> > +  if (aChild.IsHTMLElement(nsGkAtoms::optgroup) &&\n> > +      aChild.IsHTMLElement(nsGkAtoms::select)) {\n> \n> Looks like a copy-paste error.\n> The original code was:\n>         (\\!aContent->IsHTMLElement(nsGkAtoms::optgroup) ||\n>          \\!parent->IsHTMLElement(nsGkAtoms::select)) &&\n> so I think you want to replace the 2nd aChild with aParent.\n> Please add a testcase that would have caught this.\n\nThis was caught by the innertext getter test.", "author": "emilio@crisal.io", "id": 13208727, "time": "2018-04-16T10:26:30Z"}, {"text": "Comment on attachment 8967987\nBug 1453702: [css-display] Move unboxing to style, and handle display: contents before other suppressions.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/236674/diff/3-4/", "author": "emilio@crisal.io", "id": 13208730, "time": "2018-04-16T10:31:03Z"}, {"text": "Comment on attachment 8968087\nBug 1453702: Get rid of SetAsUndisplayedContent.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/236760/diff/1-2/", "author": "emilio@crisal.io", "id": 13208731, "time": "2018-04-16T10:31:03Z"}, {"text": "Pushed by ecoal95@gmail.com:\nhttps://hg.mozilla.org/integration/mozilla-inbound/rev/43862b2ee72e\n[css-display] Move unboxing to style, and handle display: contents before other suppressions. r=mats,xidorn", "author": "pulsebot@bots.tld", "id": 13209058, "time": "2018-04-16T10:57:48Z"}, {"text": "leave-open for the second patch.", "author": "emilio@crisal.io", "id": 13209060, "time": "2018-04-16T10:58:28Z"}, {"text": "Actually let's just move that to another bug, given I have another idea to remove SetAsUndisplayedContent altogether.", "author": "emilio@crisal.io", "id": 13209120, "time": "2018-04-16T11:00:31Z"}, {"text": "Created web-platform-tests PR https://github.com/w3c/web-platform-tests/pull/10489 for changes under testing/web-platform/tests", "author": "wptsync@mozilla.bugs", "id": 13209283, "time": "2018-04-16T11:47:18Z"}, {"text": "Comment on attachment 8968087\nBug 1453702: Get rid of SetAsUndisplayedContent.\n\nReview request updated; see interdiff: https://reviewboard.mozilla.org/r/236760/diff/2-3/", "author": "emilio@crisal.io", "id": 13209300, "time": "2018-04-16T11:56:53Z"}, {"text": "Comment on attachment 8968087\nBug 1453702: Get rid of SetAsUndisplayedContent.\n\nBlerg, wrong bug.", "author": "emilio@crisal.io", "id": 13209305, "time": "2018-04-16T11:59:33Z"}, {"text": "Upstream web-platform-tests status checks passed, PR will merge once commit reaches central.", "author": "wptsync@mozilla.bugs", "id": 13210347, "time": "2018-04-16T17:49:36Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/43862b2ee72e", "author": "shindli@mozilla.com", "id": 13211042, "time": "2018-04-16T22:01:36Z"}, {"text": "Upstream PR merged", "author": "wptsync@mozilla.bugs", "id": 13212821, "time": "2018-04-17T15:53:17Z"}, {"text": "Pushed by ecoal95@gmail.com:\nhttps://hg.mozilla.org/integration/autoland/rev/86badb90129d\nfollowup: Fix Servo build. r=me", "author": "pulsebot@bots.tld", "id": 13213287, "time": "2018-04-17T18:36:37Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/86badb90129d", "author": "ccoroiu@mozilla.com", "id": 13214997, "time": "2018-04-18T10:52:41Z"}], "id": 1453702, "priority": "--", "cc": ["emilio@crisal.io", "fuzzing@mozilla.com", "mats@mozilla.com", "xidorn+moz@upsuper.org"], "cf_crash_signature": "", "version": "59 Branch", "is_cc_accessible": true, "cf_tracking_firefox_esr52": "---", "see_also": [], "cf_tracking_thunderbird_esr60": "---", "cf_platform_rel": "---", "product": "Core", "cf_fx_iteration": "---", "blocks": [1340565, 1303605, 1453342], "qa_contact": "", "creation_time": "2018-04-12T15:44:52Z", "cf_status_firefox_esr52": "unaffected", "component": "Layout", "assigned_to_detail": {"email": "emilio@crisal.io", "id": 546716, "name": "emilio@crisal.io", "real_name": "Emilio Cobos \u00c1lvarez [:emilio]"}, "cf_tracking_firefox_esr60": "---", "cf_status_firefox62": "---", "cf_status_firefox61": "fixed", "cf_status_firefox60": "unaffected", "target_milestone": "mozilla61", "cf_rank": null, "cf_qa_whiteboard": "", "severity": "normal", "groups": [], "cf_status_thunderbird_esr52": "---", "url": "", "cf_status_thunderbird_esr60": "---", "creator_detail": {"email": "jkratzer@mozilla.com", "id": 586683, "name": "jkratzer@mozilla.com", "real_name": "Jason Kratzer [:jkratzer]"}, "whiteboard": "", "mentors": [], "summary": "Assertion failure: !needsFrameBitSet (Ancestors of nodes with frames to be constructed lazily should not have NEEDS_FRAME bit set), at /builds/worker/workspace/build/src/layout/base/nsCSSFrameConstructor.cpp:6840", "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [{"status": "+", "name": "in-testsuite", "modification_date": "2018-04-17T01:58:55Z", "type_id": 37, "creation_date": "2018-04-12T15:44:52Z", "id": 1743147, "setter": "ryanvm@gmail.com"}], "last_change_time": "2018-06-16T08:29:17Z", "assigned_to": "emilio@crisal.io", "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "in-testsuite?"}], "who": "jkratzer@mozilla.com", "when": "2018-04-12T15:44:52Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "emilio@crisal.io"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(emilio@crisal.io)"}], "who": "emilio@crisal.io", "when": "2018-04-12T15:46:23Z"}, {"changes": [{"removed": "needinfo?(emilio@crisal.io)", "field_name": "flagtypes.name", "added": ""}, {"field_name": "attachments.mimetype", "removed": "text/plain", "attachment_id": 8967969, "added": "text/html"}], "who": "emilio@crisal.io", "when": "2018-04-14T15:54:04Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(emilio@crisal.io)"}], "who": "emilio@crisal.io", "when": "2018-04-14T15:56:27Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1453342"}], "who": "emilio@crisal.io", "when": "2018-04-14T18:49:59Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "1303605"}, {"removed": "needinfo?(emilio@crisal.io)", "field_name": "flagtypes.name", "added": ""}], "who": "emilio@crisal.io", "when": "2018-04-14T18:53:21Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "emilio@crisal.io"}], "who": "emilio@crisal.io", "when": "2018-04-14T18:53:34Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8967987, "added": "review?(mats@mozilla.com)"}, {"removed": "", "field_name": "cc", "added": "mats@mozilla.com"}], "who": "emilio@crisal.io", "when": "2018-04-14T20:08:10Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(mats@mozilla.com)", "attachment_id": 8967987, "added": "review-"}], "who": "mats@mozilla.com", "when": "2018-04-15T17:01:34Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8968087, "added": "review?(mats@mozilla.com)"}, {"field_name": "attachments.description", "removed": "Bug 1453702: [css-display] Move unboxing to style, and handle display: contents before other suppresions.", "attachment_id": 8967987, "added": "Bug 1453702: [css-display] Move unboxing to style, and handle display: contents before other suppressions."}, {"field_name": "flagtypes.name", "removed": "review-", "attachment_id": 8967987, "added": "review?(mats@mozilla.com), review?(xidorn+moz@upsuper.org)"}, {"removed": "", "field_name": "cc", "added": "xidorn+moz@upsuper.org"}], "who": "emilio@crisal.io", "when": "2018-04-15T22:54:50Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(xidorn+moz@upsuper.org)", "attachment_id": 8967987, "added": "review+"}], "who": "xidorn+moz@upsuper.org", "when": "2018-04-16T00:16:21Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(mats@mozilla.com)", "attachment_id": 8967987, "added": "review+"}], "who": "mats@mozilla.com", "when": "2018-04-16T00:31:53Z"}, {"changes": [{"removed": "", "field_name": "keywords", "added": "leave-open"}], "who": "emilio@crisal.io", "when": "2018-04-16T10:58:28Z"}, {"changes": [{"removed": "leave-open", "field_name": "keywords", "added": ""}], "who": "emilio@crisal.io", "when": "2018-04-16T11:00:31Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(mats@mozilla.com)", "attachment_id": 8968087, "added": ""}], "who": "emilio@crisal.io", "when": "2018-04-16T11:00:43Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8968087, "added": "1"}], "who": "emilio@crisal.io", "when": "2018-04-16T11:00:54Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "1", "attachment_id": 8968087, "added": "0"}, {"field_name": "attachments.description", "removed": "Bug 1453702: Cleanup SetAsUndisplayedContent.", "attachment_id": 8968087, "added": "Bug 1453702: Get rid of SetAsUndisplayedContent."}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8968087, "added": "review?(mats@mozilla.com)"}], "who": "emilio@crisal.io", "when": "2018-04-16T11:56:53Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8967987, "added": "1"}], "who": "emilio@crisal.io", "when": "2018-04-16T11:56:55Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(mats@mozilla.com)", "attachment_id": 8968087, "added": ""}], "who": "emilio@crisal.io", "when": "2018-04-16T11:59:33Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1454471"}], "who": "gbrown@mozilla.com", "when": "2018-04-16T20:59:16Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla61"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2018-04-16 22:01:36"}, {"removed": "---", "field_name": "cf_status_firefox61", "added": "fixed"}], "who": "shindli@mozilla.com", "when": "2018-04-16T22:01:36Z"}, {"changes": [{"removed": "in-testsuite?", "field_name": "flagtypes.name", "added": "in-testsuite+"}, {"removed": "---", "field_name": "cf_status_firefox_esr52", "added": "unaffected"}, {"removed": "---", "field_name": "cf_status_firefox59", "added": "unaffected"}, {"removed": "---", "field_name": "cf_status_firefox60", "added": "unaffected"}], "who": "ryanvm@gmail.com", "when": "2018-04-17T01:58:55Z"}, {"changes": [{"removed": "", "field_name": "depends_on", "added": "1469076"}], "who": "emilio@crisal.io", "when": "2018-06-16T08:29:17Z"}], "resolution": "FIXED", "op_sys": "Unspecified", "cf_fx_points": "---", "cf_blocking_fennec": "---"}