{"cf_tracking_thunderbird_esr52": "---", "status": "VERIFIED", "cf_tracking_firefox60": "---", "attachments": [{"creator": "roc@ocallahan.org", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/html", "id": 8684208}, {"creator": "roc@ocallahan.org", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/x-review-board-request", "id": 8684514}, {"creator": "roc@ocallahan.org", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/x-review-board-request", "id": 8684515}, {"creator": "roc@ocallahan.org", "is_obsolete": 0, "is_patch": 0, "flags": [], "content_type": "text/html", "id": 8684613}, {"creator": "mats@mozilla.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8685389}, {"creator": "mats@mozilla.com", "is_obsolete": 1, "is_patch": 1, "flags": [], "content_type": "text/plain", "id": 8685526}, {"creator": "mats@mozilla.com", "is_obsolete": 0, "is_patch": 1, "flags": [{"status": "+", "name": "review", "modification_date": "2015-11-11T00:01:01Z", "type_id": 4, "creation_date": "2015-11-10T23:58:39Z", "id": 1290185, "setter": "roc@ocallahan.org"}, {"status": "+", "name": "approval-mozilla-aurora", "modification_date": "2015-11-12T15:55:05Z", "type_id": 720, "creation_date": "2015-11-12T10:36:46Z", "id": 1291232, "setter": "lhenry@mozilla.com"}, {"status": "+", "name": "approval-mozilla-beta", "modification_date": "2015-11-12T15:55:05Z", "type_id": 721, "creation_date": "2015-11-12T10:36:46Z", "id": 1291233, "setter": "lhenry@mozilla.com"}], "content_type": "text/plain", "id": 8685697}], "classification": "Components", "creator": "masayuki@d-toybox.com", "cc": ["alice0775@yahoo.co.jp", "andrei.vaida@softvision.ro", "arni2033@yandex.ru", "bogdan.maris@softvision.ro", "masayuki@d-toybox.com", "mats@mozilla.com", "msh140.3@hotmail.com", "roc@ocallahan.org", "syoichi@outlook.com", "twalker@mozilla.com", "vaidya.anand@gmail.com", "VYV03354@nifty.ne.jp"], "depends_on": [], "creation_time": "2014-11-01T23:15:40Z", "cf_user_story": "", "cf_tracking_firefox_relnote": "---", "platform": "x86_64", "cf_status_firefox58": "---", "cf_status_firefox59": "---", "keywords": [], "summary": "[non-e10s] twitter web UI (twitter.com) scrolls up unexpectedly at doing RT or showing image", "id": 1092626, "assigned_to_detail": {"email": "roc@ocallahan.org", "id": 5038, "name": "roc@ocallahan.org", "real_name": "Robert O'Callahan (:roc) (email my personal email if necessary)"}, "severity": "normal", "is_confirmed": true, "is_creator_accessible": true, "cf_has_regression_range": "---", "assigned_to": "roc@ocallahan.org", "comment_count": 52, "comments": [{"text": "STR #1:\n\n1. Scroll down your timeline a lot.\n2. Click a tweet which has one or more images.\n3. Click an image in the tweet for zoom.\n4. Close the image.\n\nSTR #2:\n\n1. Scroll down your timeline a lot.\n2. Click RT.\n3. Click RT button on the confirmation dialog.\n\nActual result:\n\nAfter 1-4 or 2-3, i.e., closing twitter's dialog, timeline scrolls up.\n\nExpected result:\n\nEven after closing twitter's dialog, timeline should keep the scroll position.\n\n\nI'm not sure if this is a bug of us or twitter's bug. I cannot reproduce this bug with Google Chrome.\n\nI've reproduce this bug at least for several months with Nightly.", "author": "masayuki@d-toybox.com", "id": 9533538, "time": "2014-11-01T23:15:40Z"}, {"text": "This bug is a real annoyance - I'm on Ubuntu Linux 14.10 x86_64 & Firefox 33.0.\n\nI have to switch to Chrome while using twitter. Chrome does not have this bug.", "author": "vaidya.anand@gmail.com", "id": 9628423, "time": "2014-11-24T11:37:29Z"}, {"text": "When user opens image, twitter.com sets overflow-y of <body> to hidden. And when user close the image dialog, twitter.com restores the overflow-y to scroll. However, I cannot reproduce this bug with simplest testcase which just hides and restores scrollbar of <body>. So, I guess that something doing for the dialog breaks the scroll position of <body>.\n\n\ntwitter_more_1.bundle.css:\n\n> .modal-enabled,.grid-enabled,.overlay-enabled,.gallery-enabled{\n> \tposition:relative;\n> \toverflow:hidden\n> }\n\n\n>   this.open = function (a, b) {\n>     this.calculateScrollbarWidth(),\n>     this.fromGrid = b && !!b.fromGrid,\n>     this.title = b && b.title ? b.title : this.attr.defaultGalleryTitle,\n>     this.select('galleryTitleSelector').text(this.title),\n>     b && b.inOverlay ? this.$node.addClass(this.attr.inOverlayGalleryClass)  : this.$node.removeClass(this.attr.inOverlayGalleryClass),\n>     b && b.showGrid && b.profileUser ? (this.select('gallerySelector').removeClass('no-grid'), this.select('gridSelector').attr('href', '/' + b.profileUser.screen_name + '/media'), this.select('gridSelector').find('.visuallyhidden').text(b.profileUser.name), this.select('gridSelector').addClass('js-nav'))  : (this.select('gallerySelector').addClass('no-grid'), this.select('gridSelector').removeClass('js-nav'));\n>     var c = $(a.target).closest(this.attr.mediaSelector);\n>     if (this.isOpen() || c.length == 0) return;\n>     b && b.timelineSelector ? this.$timeline = c.closest(b.timelineSelector)  : this.$timeline = c.parent(),\n>     imageResizer.resetMinSize(this.select('gallerySelector')),\n>     this.render(c),\n>     $('body').addClass('gallery-enabled'),\n>     this.select('gallerySelector').addClass('show-controls'),\n>     this.on('mousemove', function () {\n>       this.select('gallerySelector').removeClass('show-controls')\n>     }.bind(this)),\n>     this.trigger('uiGalleryOpened')\n>   },\n>   this.closeGallery = function () {\n>     $('body').hasClass('gallery-enabled') && ($('body').removeClass('gallery-enabled'), this.select('galleryMediaSelector').empty(), this.hideNav(), this.enableNav(!1, !1), this.off(window, 'resize', this.debouncedResize), this.off('mousemove'), delete this.$timeline, delete this.$current, this.trigger('uiGalleryClosed'), this.trigger('uiDialogClosed'))\n>   },\n\nAdding gallery-enabled class overwrites the overflow property.", "author": "masayuki@d-toybox.com", "id": 9634543, "time": "2014-11-25T11:59:05Z"}, {"text": "I can reproduce the problem(STR #1) on Nightly36.0a1, Firefox 31esr, 24esr, 17esr, 10esr as well as Firefox4, but not Firefox3.6.\n\n\nRegression window(m-c)\nGood:\nhttp://hg.mozilla.org/mozilla-central/rev/b94cf8147ccd\nMozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.3a1pre) Gecko/20100111 Minefield/3.7a1pre ID:20100111140136\nBad:\nhttp://hg.mozilla.org/mozilla-central/rev/47cd92d616d7\nMozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.3a1pre) Gecko/20100111 Minefield/3.7a1pre ID:20100111150802\nPushlog:\nhttps://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=b94cf8147ccd&tochange=47cd92d616d7\n\nTriggered by Bug 526394\n\n\nIn local build\nLast Good: fada8c5cef07\nFirst Bad: 2f7d76044ee8", "author": "alice0775@yahoo.co.jp", "id": 9634849, "time": "2014-11-25T13:41:50Z"}, {"text": "Similar to Bug 691095", "author": "alice0775@yahoo.co.jp", "id": 9634853, "time": "2014-11-25T13:42:04Z"}, {"text": "(In reply to Alice0775 White from comment #4)\n> Similar to Bug 691095\n\nYeah, but Asa said that it's scrolled without user action. I guess that the bug has already been fixed by twitter.com side or our side.", "author": "masayuki@d-toybox.com", "id": 9634923, "time": "2014-11-25T13:56:35Z"}, {"text": "roc:\n\nThe regression point is your bug. Do you have any ideas? Or, do you know somebody who can research this? This is really annoying bug for twitter uses who use Web UI...", "author": "masayuki@d-toybox.com", "id": 9853342, "time": "2015-01-28T16:24:16Z"}, {"text": "I don't see this bug on trunk currently. Masayuki, do you still see it?", "author": "roc@ocallahan.org", "id": 10008531, "time": "2015-03-10T11:55:05Z"}, {"text": "(In reply to Robert O'Callahan (:roc) (Mozilla Corporation) from comment #7)\n> I don't see this bug on trunk currently. Masayuki, do you still see it?\n\nYeah, I can reproduce this on today's Nightly build too.\n\nIf you want some stack trace or something, I could provide it.", "author": "masayuki@d-toybox.com", "id": 10009185, "time": "2015-03-10T14:35:40Z"}, {"text": "When this occurs, ScrollFrameHelper::ScrollToImpl() is called by ScrollFrameHelper::ReflowFinished().\n\nhttp://mxr.mozilla.org/mozilla-central/source/layout/generic/nsGfxScrollFrame.cpp?rev=0b743302cbfb#4532\n> 4532   // Clamp current scroll position to new bounds. Normally this won't\n> 4533   // do anything.\n> 4534   nsPoint currentScrollPos = GetScrollPosition();\n> 4535   ScrollToImpl(currentScrollPos, nsRect(currentScrollPos, nsSize(0, 0)));\n\nCould be the position is already clamped or still overflow is hidden yet?", "author": "masayuki@d-toybox.com", "id": 10134786, "time": "2015-04-09T05:07:58Z"}, {"text": "When it's scrolled up, each value is:\n\nScrollFrameHelper::ScrollToImpl():\n\naPt={ x=0, y=3703029 }\n\n> 2355   nsPoint curPos = GetScrollPosition();\n\ncurPos={ x=0, y=3703029 }\n\n> 2356   nsPoint alignWithPos = mScrollPosForLayerPixelAlignment == nsPoint(-1,-1)\n> 2357       ? curPos : mScrollPosForLayerPixelAlignment;\n\nalignWithPos={ x=0, y=3703029 }\n\n> 2358   // Try to align aPt with curPos so they have an integer number of layer\n> 2359   // pixels between them. This gives us the best chance of scrolling without\n> 2360   // having to invalidate due to changes in subpixel rendering.\n> 2361   // Note that when we actually draw into a PaintedLayer, the coordinates\n> 2362   // that get mapped onto the layer buffer pixels are from the display list,\n> 2363   // which are relative to the display root frame's top-left increasing down,\n> 2364   // whereas here our coordinates are scroll positions which increase upward\n> 2365   // and are relative to the scrollport top-left. This difference doesn't actually\n> 2366   // matter since all we are about is that there be an integer number of\n> 2367   // layer pixels between pt and curPos.\n> 2368   nsPoint pt =\n> 2369     ClampAndAlignWithLayerPixels(aPt,\n> 2370                                  GetScrollRangeForClamping(),\n> 2371                                  aRange,\n> 2372                                  alignWithPos,\n> 2373                                  appUnitsPerDevPixel,\n> 2374                                  scale);\n\npt={ x=0, y=30660 }\n\n> 2381   nsPoint dist(std::abs(pt.x - mLastUpdateImagesPos.x),\n> 2382                std::abs(pt.y - mLastUpdateImagesPos.y));\n\nmLastUpdateImagesPos={ x=-1, y=-1 }\ndist={ x=1, y=30661 }\n\n> 2383   nsSize scrollPortSize = GetScrollPositionClampingScrollPortSize();\n\nscrollPortSize={ width=69240, height=50520 }\n\n> 2384   nscoord horzAllowance = std::max(scrollPortSize.width / std::max(sHorzScrollFraction, 1),\n> 2385                                    nsPresContext::AppUnitsPerCSSPixel());\n> 2386   nscoord vertAllowance = std::max(scrollPortSize.height / std::max(sVertScrollFraction, 1),\n> 2387                                    nsPresContext::AppUnitsPerCSSPixel());\n\nhorzAllowance=34620, vertAllowance=25260\n\n> 2388   if (dist.x >= horzAllowance || dist.y >= vertAllowance) {\n> 2389     needImageVisibilityUpdate = true;\n> 2390   }\n> 2391 \n> 2392   if (needImageVisibilityUpdate) {\n> 2393     presContext->PresShell()->ScheduleImageVisibilityUpdate();\n> 2394   }\n> 2395 \n> 2396   // notify the listeners.\n> 2397   for (uint32_t i = 0; i < mListeners.Length(); i++) {\n> 2398     mListeners[i]->ScrollPositionWillChange(pt.x, pt.y);\n> 2399   }\n> 2400 \n> 2401   nsPoint oldScrollFramePos = mScrolledFrame->GetPosition();\n\noldScrollFramePos={ x=0, y=-3703029 }\n\n> 2402   // Update frame position for scrolling\n> 2403   mScrolledFrame->SetPosition(mScrollPort.TopLeft() - pt);\n\nmScrolledFrame->GetPosition()={ x=0, y=-30660 }\n\n\nI still don't understand why the pt is strange point value.", "author": "masayuki@d-toybox.com", "id": 10134889, "time": "2015-04-09T06:14:32Z"}, {"text": "aPt={ x=0, y=2894350 },\naRange={ x=0, y=2894350, XMost()=0, YMost()=2894350 },\n\nappUnitsPerDevPixel=60,\nscale={ width=1.000000, height=1.000000 },\n\ncurPos={ x=0, y=2894350 },\n\nGetScrollRangeForClamping()={ x=0, y=0, XMost()=0, YMost()=43620 }(ShouldClampScrollPosition()=true),\n\nalignWithPos={ x=0, y=2894350 },\n\npt={ x=0, y=43620 },\nmLastUpdateImagesPos={ x=-1, y=-1 },\n\ndist={ x=1, y=43621 },\nscrollPortSize={ width=69240, height=50520 },\n\nhorzAllowance=34620, vertAllowance=25260,\n\noldScrollFramePos={ x=0, y=-2894350 },\n\nmScrolledFrame->GetPosition()={ x=0, y=-43620 }\n\n\n\nLooks like that GetScrollRangeForClamping() result causes computing wrong scroll destination.\n\nRoc, any idea?\n\nFYI: When it's not scrolled, looks like |if (pt == curPos)| is true and quit.", "author": "masayuki@d-toybox.com", "id": 10134963, "time": "2015-04-09T06:56:12Z"}, {"text": "I still can't reproduce this.\n\nIt certainly looks like GetScrollRangeForClamping is at fault. Can you drill down further? What is aScrolledFrameOverflowArea in ScrollFrameHelper::GetScrolledRectInternal? I'm guessing its height is too small.\n\nI wonder if this is due to interruptible reflow. Can you try disabling that by setting layout.interruptible-reflow.enabled to false?", "author": "roc@ocallahan.org", "id": 10225913, "time": "2015-05-04T04:21:27Z"}, {"text": "Wow! Setting layout.interruptible-reflow.enabled to false\n\nIt seems to fix the problem for me.\n\nMozilla/5.0 (Windows NT 6.1; WOW64; rv:40.0) Gecko/20100101 Firefox/40.0 ID:20150503030209", "author": "alice0775@yahoo.co.jp", "id": 10225929, "time": "2015-05-04T04:47:14Z"}, {"text": "Hmm... Odd. I cannot reproduce this bug with the latest Nightly with default setting around layout. I'll check deeper more.", "author": "masayuki@d-toybox.com", "id": 10226146, "time": "2015-05-04T07:14:55Z"}, {"text": "It is easy to reproduce the problem when e10s disabled. \nex. page https://twitter.com/IE_Japan\n\nI do not know whether the problem occurs when e10s enabled.", "author": "alice0775@yahoo.co.jp", "id": 10226225, "time": "2015-05-04T07:52:17Z"}, {"text": "Excellent!! This bug can be reproduced only without e10s. And I confirmed not to reproduce this bug with layout.interruptible-reflow.enabled=false.\n\nRoc, don't you enable e10s when you test this?", "author": "masayuki@d-toybox.com", "id": 10231226, "time": "2015-05-05T08:50:16Z"}, {"text": "I had tested with e10s enabled. With e10s disabled, I can reproduce this.\n\nSo I guess an interruptible reflow occurs and we stop restoring the scroll position prematurely.", "author": "roc@ocallahan.org", "id": 10231431, "time": "2015-05-05T10:13:04Z"}, {"text": "Created attachment 8684208\nsimple testcase\n\nLoad the page, and when it's finished loading click in the page and quickly move the mouse. The scroll position should shift from the end of the page to somewhere further up.", "author": "roc@ocallahan.org", "id": 10910313, "time": "2015-11-06T13:11:36Z"}, {"text": "Created attachment 8684514\nMozReview Request: Bug 1092626. Add aInterrupted parameter to ReflowFinished. r=mats\n\nBug 1092626. Add aInterrupted parameter to ReflowFinished. r=mats", "author": "roc@ocallahan.org", "id": 10912612, "time": "2015-11-07T03:02:12Z"}, {"text": "Created attachment 8684515\nMozReview Request: Bug 1092626. When a reflow is interrupted and a scroll position is clamped, try to restore to the old scroll position when the reflow completes. r=mats\n\nBug 1092626. When a reflow is interrupted and a scroll position is clamped, try to restore to the old scroll position when the reflow completes. r=mats", "author": "roc@ocallahan.org", "id": 10912613, "time": "2015-11-07T03:02:14Z"}, {"text": "I don't have any good ideas for testing this...", "author": "roc@ocallahan.org", "id": 10912614, "time": "2015-11-07T03:02:50Z"}, {"text": "I'm not sure I understand what the problem is.  After attachment 8684208 is\nfully loaded, is the expected result that there should be no scroll movement\nwhen I click on the text?\nThe actual result I see in Linux builds is that the text moves due to a vertical\nscroll (and that by just clicking - no mouse movement needed after the click).\n\nI see that result also with the patches applied, and also with\nlayout.interruptible-reflow.enabled=false", "author": "mats@mozilla.com", "id": 10913180, "time": "2015-11-07T21:15:50Z"}, {"text": "Created attachment 8684613\nupdated testcase\n\nSorry, in an opt build the previous testcase completes too quickly to trigger a layout interrupt.\n\nTry this testcase instead. Same steps as last time: wait for the page to finish loading and scroll to the bottom, then click in the body and move the mouse quickly. You should find that it scrolls to somewhere near the top.", "author": "roc@ocallahan.org", "id": 10913282, "time": "2015-11-08T01:14:21Z"}, {"text": "Comment on attachment 8684515\nMozReview Request: Bug 1092626. When a reflow is interrupted and a scroll position is clamped, try to restore to the old scroll position when the reflow completes. r=mats\n\nhttps://reviewboard.mozilla.org/r/24597/#review22141\n\nr- since it doesn't fix the bug for me.\n\n::: layout/generic/nsGfxScrollFrame.cpp:4758\n(Diff revision 1)\n> +    mRestorePos = currentScrollPos;\n\nThanks for the additional testcase.  I can now reproduce the reported problem.  Unfortunately though, applying both patches here doesn't fix the problem for me (Linux x86-64 m-i debug build).  I see that we hit this line but it just doesn't seem to help for some reason.\n\nAlso, why not simply use \"mOuter->PresContext()->HasPendingInterrupt()\" instead of propagating the aInterrupted flag? and possibly also NS_SUBTREE_DIRTY(mOuter) to avoid interrupts that didn't affect this subtree.\n\nFWIW, I still see the issue when just clicking as described in comment 22. In this case it scrolls just 10px or so.  It might be related though.", "author": "mats@mozilla.com", "id": 10913817, "time": "2015-11-08T21:16:34Z"}, {"text": "Comment on attachment 8684514\nMozReview Request: Bug 1092626. Add aInterrupted parameter to ReflowFinished. r=mats\n\nhttps://reviewboard.mozilla.org/r/24595/#review22143\n\nMaybe we can just use \"mOuter->PresContext()->HasPendingInterrupt()\" instead?\nand/or NS_SUBTREE_DIRTY(mOuter).", "author": "mats@mozilla.com", "id": 10913818, "time": "2015-11-08T21:19:10Z"}, {"text": "(In reply to Mats Palmgren (:mats) from comment #24)\n> Thanks for the additional testcase.  I can now reproduce the reported\n> problem.  Unfortunately though, applying both patches here doesn't fix the\n> problem for me (Linux x86-64 m-i debug build).  I see that we hit this line\n> but it just doesn't seem to help for some reason.\n\nIt definitely works for me. Can you look into why it isn't working for you?\n\n> Also, why not simply use \"mOuter->PresContext()->HasPendingInterrupt()\"\n> instead of propagating the aInterrupted flag? and possibly also\n> NS_SUBTREE_DIRTY(mOuter) to avoid interrupts that didn't affect this subtree.\n\nI don't want to create a dependency on exactly when the interrupt state is cleared. Only applying this change when NS_SUBTREE_DIRTY is true would be a good improvement though.", "author": "roc@ocallahan.org", "id": 10913843, "time": "2015-11-08T21:52:25Z"}, {"text": "Sure, on the next call (after the interrupted reflow) to ReflowFinished,\nScrollToRestoredPosition() is called but it takes the early return\nbecause mLastPos=-1,-1.  So if I add \"mLastPos = GetScrollPosition()\"\nafter the mRestorePos assignment in you patch, then it works as\nexpected.  I'm not happy with the result though, the scrollbar thumb\njumps very clearly from the end to the top and then back to the end.\nIn my debug build this takes about one second and is clearly visible.\nI guess it's less of a problem in an optimized build but I think we\ncan do better.\n\nIf I *instead of* your part 2 patch add this as the first statement\nin ReflowFinished():\n\n  if (mRestorePos.x == -1 && aInterrupted && NS_SUBTREE_DIRTY(mOuter)) {\n    return false;\n  }\n\nthis also fixes the bug, and it looks much better - the scrollbar\nthumb doesn't jump and the \"paint flash\" feels less disturbing.\n\nDoes that also work for you?", "author": "mats@mozilla.com", "id": 10915162, "time": "2015-11-09T11:28:30Z"}, {"text": "This also works:\n\n  if (aInterrupted && NS_SUBTREE_DIRTY(mOuter)) {\n    return false;\n  }\n\nI don't think we really care what mRestorePos is at the top of this\nmethod.  A comment to go along with the code above would be:\n// We will get another call after the next reflow and doing the\n// scroll later is less janky.", "author": "mats@mozilla.com", "id": 10915183, "time": "2015-11-09T11:39:07Z"}, {"text": "BTW, just checking \"NS_SUBTREE_DIRTY(mOuter)\" also works for me.\nI don't really see why we need to check aInterrupted at all.\nAll we need to know is that we will get another call after the\nnext reflow, right?", "author": "mats@mozilla.com", "id": 10915222, "time": "2015-11-09T12:06:09Z"}, {"text": "(In reply to Mats Palmgren (:mats) from comment #29)\n> BTW, just checking \"NS_SUBTREE_DIRTY(mOuter)\" also works for me.\n> I don't really see why we need to check aInterrupted at all.\n> All we need to know is that we will get another call after the\n> next reflow, right?\n\nYes, that sounds right.\n\nI worry about the consequences of allowing the scroll position to be outside the scroll range, though. That breaks an invariant that could be important. Seems to me the scrollbar could be rendered completely incorrectly in this case and the user might even be able to interact with it and get surprising results. The fix that I posted here is conservative and doesn't break any invariants.\n\nI guess we can go with your approach and see what happens. Do you want to post it, or should I?", "author": "roc@ocallahan.org", "id": 10917078, "time": "2015-11-09T21:19:03Z"}, {"text": "OK, let's try that and see if it works.  It's almost bedtime here so it's faster\nif you post it and make a Try run.  I can review it tomorrow.", "author": "mats@mozilla.com", "id": 10917138, "time": "2015-11-09T21:34:19Z"}, {"text": "Created attachment 8685389\nAlternative fix\n\nI pushed this to Try, let's see what falls out:\nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=a5d63d5c0103", "author": "mats@mozilla.com", "id": 10918928, "time": "2015-11-10T11:07:42Z"}, {"text": "Created attachment 8685526\nAlternative fix, v2\n\nWhoa, plenty of failures in the above Try push.\n\nI think the problem is that we need to always reset mPostedReflowCallback\nbefore returning, so I moved that to the top.  New Try push:\n\nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=8ea34282db2e", "author": "mats@mozilla.com", "id": 10920251, "time": "2015-11-10T18:33:41Z"}, {"text": "Created attachment 8685697\nAlternative fix, v3\n\n... and here's a Try run with Opt builds:\nhttps://treeherder.mozilla.org/#/jobs?repo=try&revision=449a9bdf29ab\nIt looks OK to me; I think the failures are unrelated.\n\nI also removed the NS_SUBTREE_DIRTY(mOuter) check later in the method\nsince it can't be true there.\n\nI've tested that this patch fixes the problem locally in a Linux debug build.\nCan you verify one of the Try builds fix it on Windows?", "author": "mats@mozilla.com", "id": 10921461, "time": "2015-11-10T23:58:39Z"}, {"text": "(In reply to Mats Palmgren (:mats) from comment #34)\n> I've tested that this patch fixes the problem locally in a Linux debug build.\n> Can you verify one of the Try builds fix it on Windows?\n\nNot easily, no, my Windows laptop is sick.", "author": "roc@ocallahan.org", "id": 10921467, "time": "2015-11-11T00:01:32Z"}, {"text": "(In reply to Robert O'Callahan (:roc) (Mozilla Corporation) from comment #35)\n> (In reply to Mats Palmgren (:mats) from comment #34)\n> > I've tested that this patch fixes the problem locally in a Linux debug build.\n> > Can you verify one of the Try builds fix it on Windows?\n> \n> Not easily, no, my Windows laptop is sick.\n\nI can check it after meeting.", "author": "masayuki@d-toybox.com", "id": 10921599, "time": "2015-11-11T00:57:44Z"}, {"text": "I tested briefly the trysever build in comment 34 on Windows (non-e10s, layout.interruptible-reflow.enabled is true), I don't see the reported problem on twitter.com.\n\nThank you very much!!!", "author": "masayuki@d-toybox.com", "id": 10921831, "time": "2015-11-11T02:21:55Z"}, {"text": "Thanks for testing it Masayuki-san.", "author": "mats@mozilla.com", "id": 10922645, "time": "2015-11-11T10:33:25Z"}, {"text": "https://hg.mozilla.org/integration/mozilla-inbound/rev/f748eade3e29", "author": "pulsebot@bots.tld", "id": 10922650, "time": "2015-11-11T10:34:41Z"}, {"text": "Masayuki-san, is the reported use case common when using Twitter?\nDo you think it's worth uplifting?", "author": "mats@mozilla.com", "id": 10924141, "time": "2015-11-11T18:32:20Z"}, {"text": "(In reply to Mats Palmgren (:mats) from comment #40)\n> Masayuki-san, is the reported use case common when using Twitter?\n\nYes. I don't see similar symptom in other websites.\n\n> Do you think it's worth uplifting?\n\nIf the patch is not so risky, I'd like you to do that. I still see some tweets to complain about this bug. When they try to use Chrome, this bug could be a reason of switching their default browser.", "author": "masayuki@d-toybox.com", "id": 10925367, "time": "2015-11-12T00:25:41Z"}, {"text": "https://hg.mozilla.org/mozilla-central/rev/f748eade3e29", "author": "kwierso@gmail.com", "id": 10925439, "time": "2015-11-12T00:44:36Z"}, {"text": "Comment on attachment 8685697\nAlternative fix, v3\n\nApproval Request Comment\n[Feature/regressing bug #]:\n[User impact if declined]: scroll jank on Twitter timeline page\n[Describe test coverage new/current, TreeHerder]: manual testing (testcase attached to this bug)\n[Risks and why]: medium risk\n[String/UUID change made/needed]: none\n\nThe reasons I think this might be worth an uplift:\n * Twitter is a popular site so the issue might affect many users\n * we're still early in the cycle(?)", "author": "mats@mozilla.com", "id": 10926444, "time": "2015-11-12T10:36:46Z"}, {"text": "Comment on attachment 8685697\nAlternative fix, v3\n\nLet's uplift this, as mats says it's high impact on users and we're still early in beta. This should make it into beta 3.", "author": "lhenry@mozilla.com", "id": 10927137, "time": "2015-11-12T15:55:05Z"}, {"text": "Tracking since we're uplifting, so I make sure this lands and sticks.", "author": "lhenry@mozilla.com", "id": 10927148, "time": "2015-11-12T15:58:11Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-aurora/rev/72fa02109714", "author": "kwierso@gmail.com", "id": 10927768, "time": "2015-11-12T18:45:59Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-beta/rev/c580b1ad0f23", "author": "kwierso@gmail.com", "id": 10927806, "time": "2015-11-12T18:55:44Z"}, {"text": "https://hg.mozilla.org/releases/mozilla-b2g44_v2_5/rev/72fa02109714", "author": "cbook@mozilla.com", "id": 10929616, "time": "2015-11-13T07:20:23Z"}, {"text": "Reproduced the initial issue using an old nightly from 2015-10-01, verified that the issue is fixed using Firefox 43 beta 3 build 2 across platforms (Windows 7 64-bit, Mac OS X 10.11.1 and Ubuntu 14.04 32-bit).", "author": "bogdan.maris@softvision.ro", "id": 10930439, "time": "2015-11-13T14:08:04Z"}, {"text": "Also verified using latest Developer Edition 44.0a2 and latest Nightly 45.0a1.", "author": "bogdan.maris@softvision.ro", "id": 10930487, "time": "2015-11-13T14:30:30Z"}, {"text": "Forgot to drop qeverify as well...sorry for the noise.", "author": "bogdan.maris@softvision.ro", "id": 10930489, "time": "2015-11-13T14:31:14Z"}], "cf_last_resolved": "2015-11-13T14:30:30Z", "priority": "--", "mentors_detail": [], "cf_crash_signature": "", "version": "Trunk", "cf_qa_whiteboard": "", "cf_tracking_firefox_esr52": "---", "cf_tracking_firefox59": "---", "last_change_time": "2015-12-03T10:26:52Z", "cf_platform_rel": "---", "product": "Core", "cf_status_firefox_esr52": "---", "blocks": [526394], "qa_contact": "", "see_also": [], "cf_fx_iteration": "---", "component": "Layout", "votes": 0, "groups": [], "cf_status_firefox60": "---", "target_milestone": "mozilla45", "is_cc_accessible": true, "cf_status_thunderbird_esr52": "---", "url": "https://twitter.com/", "creator_detail": {"email": "masayuki@d-toybox.com", "id": 34283, "name": "masayuki@d-toybox.com", "real_name": "Masayuki Nakano [:masayuki] (JST, +0900)"}, "whiteboard": "Test with layout.interruptible-reflow.enabled=true and disabling e10s", "mentors": [], "cc_detail": [{"email": "alice0775@yahoo.co.jp", "id": 293623, "name": "alice0775@yahoo.co.jp", "real_name": "Alice0775 White"}, {"email": "andrei.vaida@softvision.ro", "id": 488993, "name": "andrei.vaida@softvision.ro", "real_name": "Andrei Vaida [:avaida] \u2013 please ni? me"}, {"email": "arni2033@yandex.ru", "id": 540189, "name": "arni2033@yandex.ru", "real_name": "arni2033"}, {"email": "bogdan.maris@softvision.ro", "id": 458188, "name": "bogdan.maris@softvision.ro", "real_name": "Bogdan Maris, QA [:bogdan_maris]"}, {"email": "masayuki@d-toybox.com", "id": 34283, "name": "masayuki@d-toybox.com", "real_name": "Masayuki Nakano [:masayuki] (JST, +0900)"}, {"email": "mats@mozilla.com", "id": 5168, "name": "mats@mozilla.com", "real_name": "Mats Palmgren (:mats)"}, {"email": "msh140.3@hotmail.com", "id": 534530, "name": "msh140.3@hotmail.com", "real_name": ""}, {"email": "roc@ocallahan.org", "id": 5038, "name": "roc@ocallahan.org", "real_name": "Robert O'Callahan (:roc) (email my personal email if necessary)"}, {"email": "syoichi@outlook.com", "id": 448618, "name": "syoichi@outlook.com", "real_name": "Syoichi Tsuyuhara"}, {"email": "twalker@mozilla.com", "id": 18566, "name": "twalker@mozilla.com", "real_name": "Tracy Walker [:tracy]"}, {"email": "vaidya.anand@gmail.com", "id": 524544, "name": "vaidya.anand@gmail.com", "real_name": "AnandVaidya"}, {"email": "VYV03354@nifty.ne.jp", "id": 5842, "name": "VYV03354@nifty.ne.jp", "real_name": "Masatoshi Kimura [:emk]"}], "cf_has_str": "---", "alias": null, "dupe_of": null, "flags": [], "cf_tracking_firefox58": "---", "cf_rank": null, "is_open": false, "history": [{"changes": [{"removed": "", "field_name": "cc", "added": "vaidya.anand@gmail.com"}], "who": "vaidya.anand@gmail.com", "when": "2014-11-24T11:37:29Z"}, {"changes": [{"removed": "Windows 8.1", "field_name": "op_sys", "added": "All"}], "who": "masayuki@d-toybox.com", "when": "2014-11-25T06:28:29Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "syoichi@outlook.com"}], "who": "syoichi@outlook.com", "when": "2014-11-25T07:03:02Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "roc@ocallahan.org"}, {"removed": "Untriaged", "field_name": "component", "added": "Layout"}], "who": "masayuki@d-toybox.com", "when": "2014-11-25T11:59:05Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "VYV03354@nifty.ne.jp"}], "who": "VYV03354@nifty.ne.jp", "when": "2014-11-25T13:34:33Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "alice0775@yahoo.co.jp"}], "who": "alice0775@yahoo.co.jp", "when": "2014-11-25T13:41:50Z"}, {"changes": [{"removed": "", "field_name": "blocks", "added": "526394"}], "who": "masayuki@d-toybox.com", "when": "2014-11-25T14:01:50Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(roc@ocallahan.org)"}], "who": "masayuki@d-toybox.com", "when": "2015-01-28T16:24:16Z"}, {"changes": [{"removed": "needinfo?(roc@ocallahan.org)", "field_name": "flagtypes.name", "added": ""}], "who": "roc@ocallahan.org", "when": "2015-03-10T11:55:05Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "msh140.3@hotmail.com"}], "who": "msh140.3@hotmail.com", "when": "2015-03-19T22:06:01Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(roc@ocallahan.org)"}], "who": "masayuki@d-toybox.com", "when": "2015-04-09T06:56:12Z"}, {"changes": [{"removed": "needinfo?(roc@ocallahan.org)", "field_name": "flagtypes.name", "added": ""}], "who": "roc@ocallahan.org", "when": "2015-05-04T04:21:27Z"}, {"changes": [{"removed": "twitter web UI (twitter.com) scrolls up unexpectedly at doing RT or showing image", "field_name": "summary", "added": "[non-e10s] twitter web UI (twitter.com) scrolls up unexpectedly at doing RT or showing image"}, {"removed": "", "field_name": "whiteboard", "added": "Test with layout.interruptible-reflow.enabled=true and disabling e10s"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(roc@ocallahan.org)"}], "who": "masayuki@d-toybox.com", "when": "2015-05-05T08:50:16Z"}, {"changes": [{"removed": "needinfo?(roc@ocallahan.org)", "field_name": "flagtypes.name", "added": ""}], "who": "roc@ocallahan.org", "when": "2015-05-05T10:13:04Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "twalker@mozilla.com"}, {"removed": "---", "field_name": "cf_tracking_e10s", "added": "-"}], "who": "twalker@mozilla.com", "when": "2015-05-05T14:21:57Z"}, {"changes": [{"removed": "nobody@mozilla.org", "field_name": "assigned_to", "added": "roc@ocallahan.org"}], "who": "roc@ocallahan.org", "when": "2015-11-06T13:11:36Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8684514, "added": "review?(mats@mozilla.com)"}, {"removed": "", "field_name": "cc", "added": "mats@mozilla.com"}], "who": "roc@ocallahan.org", "when": "2015-11-07T03:02:12Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8684515, "added": "review?(mats@mozilla.com)"}], "who": "roc@ocallahan.org", "when": "2015-11-07T03:02:14Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(roc@ocallahan.org)"}], "who": "mats@mozilla.com", "when": "2015-11-07T21:15:50Z"}, {"changes": [{"removed": "needinfo?(roc@ocallahan.org)", "field_name": "flagtypes.name", "added": ""}], "who": "roc@ocallahan.org", "when": "2015-11-08T01:14:21Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(mats@mozilla.com)", "attachment_id": 8684515, "added": ""}], "who": "mats@mozilla.com", "when": "2015-11-08T21:16:33Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(mats@mozilla.com)", "attachment_id": 8684514, "added": ""}], "who": "mats@mozilla.com", "when": "2015-11-08T21:19:10Z"}, {"changes": [{"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(mats@mozilla.com)"}], "who": "roc@ocallahan.org", "when": "2015-11-08T21:52:39Z"}, {"changes": [{"removed": "needinfo?(mats@mozilla.com)", "field_name": "flagtypes.name", "added": "needinfo?(roc@ocallahan.org)"}], "who": "mats@mozilla.com", "when": "2015-11-09T11:28:30Z"}, {"changes": [{"removed": "needinfo?(roc@ocallahan.org)", "field_name": "flagtypes.name", "added": ""}], "who": "roc@ocallahan.org", "when": "2015-11-09T21:19:03Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8685389, "added": "1"}], "who": "mats@mozilla.com", "when": "2015-11-10T18:33:41Z"}, {"changes": [{"field_name": "attachments.isobsolete", "removed": "0", "attachment_id": 8685526, "added": "1"}, {"field_name": "flagtypes.name", "removed": "", "attachment_id": 8685697, "added": "review?(roc@ocallahan.org)"}], "who": "mats@mozilla.com", "when": "2015-11-10T23:58:39Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "review?(roc@ocallahan.org)", "attachment_id": 8685697, "added": "review+"}], "who": "roc@ocallahan.org", "when": "2015-11-11T00:01:01Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "masayuki@d-toybox.com"}, {"removed": "", "field_name": "flagtypes.name", "added": "needinfo?(masayuki@d-toybox.com)"}], "who": "mats@mozilla.com", "when": "2015-11-11T18:32:20Z"}, {"changes": [{"removed": "needinfo?(masayuki@d-toybox.com)", "field_name": "flagtypes.name", "added": ""}], "who": "masayuki@d-toybox.com", "when": "2015-11-12T00:25:41Z"}, {"changes": [{"removed": "NEW", "field_name": "status", "added": "RESOLVED"}, {"removed": "", "field_name": "resolution", "added": "FIXED"}, {"removed": "---", "field_name": "target_milestone", "added": "mozilla45"}, {"removed": "", "field_name": "cf_last_resolved", "added": "2015-11-11 16:44:36"}, {"removed": "---", "field_name": "cf_status_firefox45", "added": "fixed"}], "who": "kwierso@gmail.com", "when": "2015-11-12T00:44:36Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "", "attachment_id": 8685697, "added": "approval-mozilla-aurora?, approval-mozilla-beta?"}], "who": "mats@mozilla.com", "when": "2015-11-12T10:36:46Z"}, {"changes": [{"field_name": "flagtypes.name", "removed": "approval-mozilla-aurora?, approval-mozilla-beta?", "attachment_id": 8685697, "added": "approval-mozilla-aurora+, approval-mozilla-beta+"}], "who": "lhenry@mozilla.com", "when": "2015-11-12T15:55:05Z"}, {"changes": [{"removed": "---", "field_name": "cf_tracking_firefox43", "added": "+"}, {"removed": "---", "field_name": "cf_status_firefox43", "added": "affected"}, {"removed": "---", "field_name": "cf_tracking_firefox44", "added": "+"}, {"removed": "---", "field_name": "cf_status_firefox44", "added": "affected"}, {"removed": "---", "field_name": "cf_tracking_firefox45", "added": "+"}], "who": "lhenry@mozilla.com", "when": "2015-11-12T15:58:38Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox44", "added": "fixed"}], "who": "kwierso@gmail.com", "when": "2015-11-12T18:45:59Z"}, {"changes": [{"removed": "affected", "field_name": "cf_status_firefox43", "added": "fixed"}], "who": "kwierso@gmail.com", "when": "2015-11-12T18:55:44Z"}, {"changes": [{"removed": "---", "field_name": "cf_status_b2g_2_5", "added": "fixed"}], "who": "cbook@mozilla.com", "when": "2015-11-13T07:20:23Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "andrei.vaida@softvision.ro"}, {"removed": "", "field_name": "flagtypes.name", "added": "qe-verify+"}], "who": "andrei.vaida@softvision.ro", "when": "2015-11-13T07:34:43Z"}, {"changes": [{"removed": "RESOLVED", "field_name": "status", "added": "VERIFIED"}, {"removed": "", "field_name": "cc", "added": "bogdan.maris@softvision.ro"}, {"removed": "fixed", "field_name": "cf_status_firefox43", "added": "verified"}], "who": "bogdan.maris@softvision.ro", "when": "2015-11-13T14:08:04Z"}, {"changes": [{"removed": "VERIFIED", "field_name": "status", "added": "RESOLVED"}, {"removed": "2015-11-11 16:44:36", "field_name": "cf_last_resolved", "added": "2015-11-13 06:30:30"}], "who": "bogdan.maris@softvision.ro", "when": "2015-11-13T14:30:30Z"}, {"changes": [{"removed": "RESOLVED", "field_name": "status", "added": "VERIFIED"}], "who": "bogdan.maris@softvision.ro", "when": "2015-11-13T14:30:41Z"}, {"changes": [{"removed": "qe-verify+", "field_name": "flagtypes.name", "added": ""}], "who": "bogdan.maris@softvision.ro", "when": "2015-11-13T14:31:14Z"}, {"changes": [{"removed": "", "field_name": "cc", "added": "arni2033@yandex.ru"}], "who": "arni2033@yandex.ru", "when": "2015-12-03T10:26:52Z"}], "resolution": "FIXED", "op_sys": "All", "cf_fx_points": "---", "cf_blocking_fennec": "---"}